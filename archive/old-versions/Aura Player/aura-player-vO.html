<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Aura">
  <meta name="theme-color" content="#030712">
  <title>Aura Player vI</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --sat: env(safe-area-inset-top);
      --sar: env(safe-area-inset-right);
      --sab: env(safe-area-inset-bottom);
      --sal: env(safe-area-inset-left);
    }
    html, body, #root {
      overflow: hidden;
      overscroll-behavior: none;
      -webkit-overflow-scrolling: touch;
      height: 100%;
      width: 100%;
      margin: 0;
      padding: 0;
      background: #030712;
    }
    * {
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
      box-sizing: border-box;
    }
    @media (prefers-color-scheme: dark) {
      :root { color-scheme: dark; }
    }
    .question-text {
      font-size: clamp(20px, 6vw, 28px);
      line-height: 1.35;
      text-wrap: balance;
    }
    .safe-top { padding-top: env(safe-area-inset-top); }
    .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
    @keyframes fill { from { width: 100%; } to { width: 0%; } }
    @keyframes shrink { from { width: 100%; } to { width: 0%; } }
    @keyframes barGrow { from { transform: scaleX(0); } to { transform: scaleX(1); } }
    @keyframes fadeSlideIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    @keyframes sweepFill { from { width: 0%; } to { width: 100%; } }
    @keyframes shimmer-pulse {
      0%, 100% { opacity: 0.4; }
      50% { opacity: 0.8; }
    }
    .shine-card { position: relative; }
    .shine-card::before {
      content: '';
      position: absolute;
      inset: -1px;
      border-radius: inherit;
      background: linear-gradient(180deg, var(--accent-bright, rgba(255,255,255,0.5)) 0%, var(--accent-color, rgba(255,255,255,0.2)) 5%, transparent 15%, transparent 100%);
      -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      padding: 2px;
      pointer-events: none;
      z-index: 20;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    .shine-card::after {
      content: '';
      position: absolute;
      inset: -1px;
      border-radius: inherit;
      background: linear-gradient(0deg, var(--accent-bright, rgba(255,255,255,0.5)) 0%, var(--accent-color, rgba(255,255,255,0.2)) 5%, transparent 15%, transparent 100%);
      -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      padding: 2px;
      pointer-events: none;
      z-index: 20;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    .shine-card:hover::before, .shine-card:hover::after { opacity: 1; animation: shimmer-pulse 3s ease-in-out infinite; }
    .shine-card:hover::after { animation-delay: 1.5s; }
    .shine-card:active::before, .shine-card:active::after { opacity: 1; animation: none; }
    .shine-card:active::before { background: linear-gradient(180deg, var(--accent-bright, rgba(255,255,255,0.8)) 0%, var(--accent-color, rgba(255,255,255,0.4)) 8%, transparent 20%, transparent 100%); }
    .shine-card:active::after { background: linear-gradient(0deg, var(--accent-bright, rgba(255,255,255,0.8)) 0%, var(--accent-color, rgba(255,255,255,0.4)) 8%, transparent 20%, transparent 100%); }
    .shine-blue { --accent-color: rgba(59, 130, 246, 0.3); --accent-bright: rgba(147, 197, 253, 0.6); }
    .shine-amber { --accent-color: rgba(251, 191, 36, 0.2); --accent-bright: rgba(253, 224, 71, 0.45); }
    .shine-violet { --accent-color: rgba(139, 92, 246, 0.25); --accent-bright: rgba(196, 181, 253, 0.55); }
    .shine-teal { --accent-color: rgba(45, 212, 191, 0.2); --accent-bright: rgba(153, 246, 228, 0.5); }
    .shine-gray { --accent-color: rgba(156, 163, 175, 0.2); --accent-bright: rgba(209, 213, 219, 0.45); }
    .shine-emerald { --accent-color: rgba(16, 185, 129, 0.25); --accent-bright: rgba(110, 231, 183, 0.55); }
    .shine-rose { --accent-color: rgba(244, 63, 94, 0.25); --accent-bright: rgba(251, 113, 133, 0.55); }
    .glow-amber { box-shadow: 0 0 20px rgba(251, 191, 36, 0.15), 0 4px 12px rgba(251, 191, 36, 0.1); }
    .glow-violet { box-shadow: 0 0 25px rgba(139, 92, 246, 0.25), 0 4px 15px rgba(139, 92, 246, 0.15); }
    .glow-teal { box-shadow: 0 0 25px rgba(45, 212, 191, 0.2), 0 4px 15px rgba(45, 212, 191, 0.1); }
    .glow-blue { box-shadow: 0 0 30px rgba(59, 130, 246, 0.25), 0 4px 20px rgba(59, 130, 246, 0.15); }
    .glow-gray { box-shadow: 0 0 25px rgba(156, 163, 175, 0.15), 0 4px 15px rgba(156, 163, 175, 0.1); }
    .glow-emerald { box-shadow: 0 0 25px rgba(16, 185, 129, 0.2), 0 4px 15px rgba(16, 185, 129, 0.1); }
    .glow-rose { box-shadow: 0 0 25px rgba(244, 63, 94, 0.2), 0 4px 15px rgba(244, 63, 94, 0.1); }
    .starry-bg {
      background: linear-gradient(135deg, rgba(30, 20, 10, 0.9) 0%, rgba(50, 30, 15, 0.8) 100%);
      position: relative;
    }
    .starry-bg::before {
      content: '';
      position: absolute;
      inset: 0;
      background-image: radial-gradient(1px 1px at 20px 30px, white, transparent),
        radial-gradient(1px 1px at 40px 70px, rgba(255,255,255,0.8), transparent),
        radial-gradient(1px 1px at 50px 45px, rgba(255,255,255,0.6), transparent),
        radial-gradient(1px 1px at 90px 40px, rgba(255,255,255,0.7), transparent),
        radial-gradient(1px 1px at 130px 55px, white, transparent),
        radial-gradient(1px 1px at 160px 35px, rgba(255,255,255,0.5), transparent),
        radial-gradient(1.5px 1.5px at 200px 50px, rgba(255,255,255,0.9), transparent),
        radial-gradient(1px 1px at 250px 60px, rgba(255,255,255,0.6), transparent),
        radial-gradient(1px 1px at 280px 30px, rgba(255,255,255,0.7), transparent),
        radial-gradient(1px 1px at 300px 70px, white, transparent),
        radial-gradient(1px 1px at 70px 55px, rgba(255,255,255,0.8), transparent),
        radial-gradient(1.5px 1.5px at 110px 25px, white, transparent),
        radial-gradient(1px 1px at 175px 65px, rgba(255,255,255,0.7), transparent),
        radial-gradient(1px 1px at 220px 35px, rgba(255,255,255,0.6), transparent),
        radial-gradient(1px 1px at 260px 50px, white, transparent),
        radial-gradient(1.5px 1.5px at 320px 40px, rgba(255,255,255,0.9), transparent),
        radial-gradient(1px 1px at 35px 60px, rgba(255,255,255,0.5), transparent),
        radial-gradient(1px 1px at 145px 70px, rgba(255,255,255,0.8), transparent);
      opacity: 0.7;
      border-radius: inherit;
    }
    .global-stars {
      position: fixed;
      inset: 0;
      background-image:
        radial-gradient(1px 1px at 50px 100px, rgba(255,255,255,0.3), transparent),
        radial-gradient(1px 1px at 150px 200px, rgba(255,255,255,0.2), transparent),
        radial-gradient(1px 1px at 250px 150px, rgba(255,255,255,0.25), transparent),
        radial-gradient(1px 1px at 100px 350px, rgba(255,255,255,0.2), transparent),
        radial-gradient(1px 1px at 300px 400px, rgba(255,255,255,0.3), transparent),
        radial-gradient(1px 1px at 80px 500px, rgba(255,255,255,0.2), transparent),
        radial-gradient(1px 1px at 200px 550px, rgba(255,255,255,0.25), transparent),
        radial-gradient(1px 1px at 350px 300px, rgba(255,255,255,0.2), transparent),
        radial-gradient(1px 1px at 20px 650px, rgba(255,255,255,0.3), transparent),
        radial-gradient(1px 1px at 280px 700px, rgba(255,255,255,0.2), transparent),
        radial-gradient(1px 1px at 120px 750px, rgba(255,255,255,0.25), transparent),
        radial-gradient(1px 1px at 380px 600px, rgba(255,255,255,0.2), transparent),
        radial-gradient(1.5px 1.5px at 180px 450px, rgba(255,255,255,0.35), transparent),
        radial-gradient(1px 1px at 320px 250px, rgba(255,255,255,0.2), transparent);
      pointer-events: none;
      z-index: 0;
    }
    /* Question type indicator circles */
    .q-circle {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      padding: 3px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }
    .q-circle-inner {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 13px;
    }
    .q-circle-binary {
      background: conic-gradient(#ef4444 0deg 180deg, #10b981 180deg 360deg);
    }
    .q-circle-mc {
      background: conic-gradient(
        #3b82f6 0deg 72deg,
        #8b5cf6 72deg 144deg,
        #22c55e 144deg 216deg,
        #14b8a6 216deg 288deg,
        #ec4899 288deg 360deg
      );
    }
    .q-circle-mixed {
      background: linear-gradient(135deg, #e2e8f0 0%, #94a3b8 50%, #e2e8f0 100%);
    }
    .q-circle-current {
      width: 48px;
      height: 48px;
    }
    .q-circle-current.q-circle-binary {
      box-shadow: -10px 0 16px rgba(16, 185, 129, 0.35), 10px 0 16px rgba(239, 68, 68, 0.3);
    }
    .q-circle-current.q-circle-mc {
      box-shadow:
        8px -6px 12px rgba(59, 130, 246, 0.3),
        0px -10px 12px rgba(139, 92, 246, 0.3),
        -10px 0 12px rgba(34, 197, 94, 0.27),
        -6px 8px 12px rgba(20, 184, 166, 0.27),
        6px 8px 12px rgba(236, 72, 153, 0.3);
    }
    .q-circle-current.q-circle-mixed {
      box-shadow: 0 0 16px rgba(226, 232, 240, 0.35), 0 0 24px rgba(148, 163, 184, 0.24);
    }
    .q-circle-adjacent {
      opacity: 0.6;
    }
  </style>
</head>
<body>
  <div id="root"></div>
  <script>
// ==================== QUESTIONS DATABASE (INLINE) ====================
const BATCHES = { 1: { name: 'Original', date: '2025-01', count: 440 } };
const CAT_MAP = {
  p: { id: 'prediction', name: 'Predictions', icon: 'ðŸ”®', color: 'amber' },
  r: { id: 'reasoning', name: 'Reasoning', icon: 'ðŸ§ ', color: 'violet' },
  j: { id: 'judgment', name: 'Judgment', icon: 'âš–ï¸', color: 'emerald' },
};
const T = { b: 'binary', m: 'multiple' };
const C = Object.fromEntries(Object.entries(CAT_MAP).map(([k,v]) => [k, v.id]));
const ev = (t, l, v) => ({ type: t === 's' ? 'stat' : 'note', ...(l && {label: l}), ...(t === 's' ? {value: v} : {text: v}) });

const Q_RAW = [
  { id:1, v:1, t:'b', c:'p', q:"Will Bitcoin exceed $150,000 before July 2026?", e:[ev('s','Current Price','$97,234'), ev('s','ATH','$108,786')] },
  { id:2, v:1, t:'m', c:'r', q:"Is a hot dog a sandwich?", o:["Yes, it's bread with filling","No, it's its own category","It's a taco (single folded bread)","Depends on regional definition"], e:[ev('n',null,'Merriam-Webster: sandwich = "two or more slices of bread with filling"')] },
  { id:3, v:1, t:'b', c:'p', q:"Will GPT-5 be released before September 2026?", e:[ev('s','GPT-4 Release','March 2023')] },
  { id:4, v:1, t:'m', c:'j', q:"Which animal would win in a fight?", o:["100 duck-sized horses","1 horse-sized duck","It depends on the terrain","They'd become friends"] },
  { id:5, v:1, t:'b', c:'j', q:"Is this research methodology sound? (Deepfake detection, n=50)", e:[ev('s','Sample Size','n=50'), ev('s','Claimed Accuracy','95%')] },
  { id:6, v:1, t:'m', c:'p', q:"What will be the dominant AI interface by 2030?", o:["Text chat","Voice assistants","AR/VR agents","Brain-computer interfaces","Autonomous agents"] },
  { id:7, v:1, t:'b', c:'r', q:"Is water wet?", e:[ev('n',null,'Wet = covered in water. Can water cover itself?')] },
  { id:8, v:1, t:'m', c:'j', q:"Best programming language for beginners in 2026?", o:["Python","JavaScript","Scratch/visual coding","Natural language (AI-assisted)","Rust"] },
  { id:9, v:1, t:'b', c:'p', q:"Will humans land on Mars before 2035?", e:[ev('s','SpaceX target','2029'), ev('s','NASA target','2040')] },
  { id:10, v:1, t:'m', c:'r', q:"Is a Pop-Tart a ravioli?", o:["Yes - filling enclosed in carb wrapper","No - ravioli must be savory","No - ravioli must be pasta","It's actually a dumpling"] },
  { id:11, v:1, t:'b', c:'j', q:"Could an average person beat a goose in a fight?", e:[ev('s','Avg goose weight','8-14 lbs')] },
  { id:12, v:1, t:'m', c:'p', q:"Most likely cause of human extinction?", o:["AI/technology","Climate change","Pandemic/bioweapon","Nuclear war","Asteroid impact"] },
  { id:13, v:1, t:'b', c:'p', q:"Will Taylor Swift announce retirement before 2030?" },
  { id:14, v:1, t:'m', c:'j', q:"What should happen to daylight saving time?", o:["Keep switching twice a year","Permanent daylight time","Permanent standard time","Let each state decide"] },
  { id:15, v:1, t:'b', c:'p', q:"Will lab-grown meat achieve price parity by 2028?", e:[ev('s','2013 cost','$330,000/burger'), ev('s','2025 cost','$6/burger')] },
  { id:16, v:1, t:'b', c:'j', q:"Could Batman beat Superman (no prep, no kryptonite)?" },
  { id:17, v:1, t:'m', c:'r', q:"Ship of Theseus: replace every part, same ship?", o:["Yes - continuity of identity","No - it's a new ship","The original uses old parts","Identity is an illusion"] },
  { id:18, v:1, t:'b', c:'p', q:"Will any AI pass an 8-hour Turing test by 2027?" },
  { id:19, v:1, t:'b', c:'r', q:"Is the simulation hypothesis likely?", e:[ev('n',null,"Bostrom's trilemma argument")] },
  { id:20, v:1, t:'m', c:'j', q:"Most important skill for the next decade?", o:["AI/ML literacy","Critical thinking","Emotional intelligence","Adaptability","Domain expertise"] },
  { id:21, v:1, t:'b', c:'r', q:"Is 847 + 256 greater than 1100?" },
  { id:22, v:1, t:'m', c:'r', q:"What color results from mixing red + blue?", o:["Green","Purple","Orange","Brown"] },
  { id:23, v:1, t:'b', c:'r', q:"Does 'rhythm' contain a vowel (a,e,i,o,u)?" },
  { id:24, v:1, t:'m', c:'r', q:"What comes next: 2, 4, 8, 16, __?", o:["24","32","20","18"] },
  { id:25, v:1, t:'b', c:'r', q:"Is Australia larger than Europe (by land area)?" },
  { id:26, v:1, t:'b', c:'p', q:"Will electric vehicles exceed 50% of US new car sales by 2030?", e:[ev('s','2024 US EV share','~9%')] },
  { id:27, v:1, t:'m', c:'p', q:"Which company will dominate AI by 2030?", o:["OpenAI","Google/DeepMind","Anthropic","Meta","A company that doesn't exist yet"] },
  { id:28, v:1, t:'b', c:'r', q:"Is free will an illusion?" },
  { id:29, v:1, t:'m', c:'j', q:"What's the most ethical diet?", o:["Vegan","Vegetarian","Pescatarian","Local/sustainable omnivore","Lab-grown meat when available"] },
  { id:30, v:1, t:'b', c:'p', q:"Will remote work remain dominant in tech by 2030?" },
  { id:31, v:1, t:'b', c:'j', q:"Should social media require age verification?" },
  { id:32, v:1, t:'m', c:'j', q:"Most overrated tech of the 2020s?", o:["NFTs","Metaverse/VR","Crypto/blockchain","AI assistants","Self-driving cars"] },
  { id:33, v:1, t:'b', c:'p', q:"Will quantum computers break current encryption by 2035?" },
  { id:34, v:1, t:'b', c:'r', q:"Is cereal a soup?" },
  { id:35, v:1, t:'m', c:'j', q:"Best way to make friends as an adult?", o:["Hobbies/clubs","Through work","Apps (Bumble BFF, etc.)","Neighbors/community","Accept loneliness"] },
  { id:36, v:1, t:'b', c:'r', q:"Is 17 a prime number?" },
  { id:37, v:1, t:'m', c:'r', q:"What is âˆš144?", o:["10","11","12","14"] },
  { id:38, v:1, t:'b', c:'r', q:"Is the Pacific Ocean the largest ocean?" },
  { id:39, v:1, t:'b', c:'p', q:"Will a woman be elected US President by 2032?" },
  { id:40, v:1, t:'m', c:'j', q:"What age should you be allowed to vote?", o:["16","18","21","25","Any age"] },
  { id:41, v:1, t:'b', c:'p', q:"Will China's GDP surpass the US by 2035?", e:[ev('s','US GDP (2024)','$28.8T'), ev('s','China GDP (2024)','$18.5T')] },
  { id:42, v:1, t:'b', c:'p', q:"Will commercial fusion power be operational by 2040?" },
  { id:43, v:1, t:'m', c:'p', q:"Which country will lead in AI development by 2035?", o:["United States","China","European Union","India","Distributed/No single leader"] },
  { id:44, v:1, t:'b', c:'p', q:"Will Neuralink have 1,000+ human users by 2030?", e:[ev('s','First implant','January 2024')] },
  { id:45, v:1, t:'b', c:'p', q:"Will global population decline before 2100?", e:[ev('s','UN projection','Peak ~10.4B in 2086')] },
  { id:46, v:1, t:'m', c:'p', q:"What will cause the next major financial crisis?", o:["AI displacement","Climate disasters","Sovereign debt","Crypto collapse","Geopolitical conflict"] },
  { id:47, v:1, t:'b', c:'p', q:"Will autonomous vehicles be legal in all US states by 2030?" },
  { id:48, v:1, t:'b', c:'p', q:"Will the US return to the Moon before China?", e:[ev('s','Artemis III target','2026'), ev('s','China target','2030')] },
  { id:49, v:1, t:'m', c:'p', q:"What will be the #1 cause of death globally in 2050?", o:["Heart disease","Cancer","Antimicrobial resistance","Climate-related","Mental health/suicide"] },
  { id:50, v:1, t:'b', c:'p', q:"Will any cryptocurrency become legal tender in a G7 nation by 2030?" },
  { id:51, v:1, t:'b', c:'p', q:"Will average US home prices exceed $500k by 2030?", e:[ev('s','2024 median','$420,000')] },
  { id:52, v:1, t:'m', c:'p', q:"Which social platform will have the most users in 2030?", o:["TikTok/ByteDance","Instagram/Meta","YouTube","WeChat","Something new"] },
  { id:53, v:1, t:'b', c:'p', q:"Will deepfakes influence a major election outcome by 2028?" },
  { id:54, v:1, t:'b', c:'p', q:"Will antibiotics still be effective against most infections in 2040?" },
  { id:55, v:1, t:'m', c:'p', q:"What will happen to Twitter/X by 2030?", o:["Still dominant","Acquired by another company","Bankrupt/shut down","Transformed into something else","Niche platform"] },
  { id:56, v:1, t:'b', c:'p', q:"Will a major city become uninhabitable due to climate by 2050?" },
  { id:57, v:1, t:'b', c:'p', q:"Will commercial space tourism have 10,000+ customers by 2035?" },
  { id:58, v:1, t:'m', c:'p', q:"Which industry will AI disrupt most by 2030?", o:["Healthcare","Legal","Education","Finance","Creative/Media"] },
  { id:59, v:1, t:'b', c:'p', q:"Will there be a manned mission to an asteroid by 2040?" },
  { id:60, v:1, t:'b', c:'p', q:"Will the EU still exist in its current form in 2040?" },
  { id:61, v:1, t:'m', c:'p', q:"What will be the dominant energy source globally by 2050?", o:["Solar","Nuclear (fission)","Nuclear (fusion)","Natural gas","Mix with no dominant"] },
  { id:62, v:1, t:'b', c:'p', q:"Will life expectancy in developed nations exceed 90 by 2060?" },
  { id:63, v:1, t:'b', c:'p', q:"Will AI-generated content be majority of internet content by 2035?" },
  { id:64, v:1, t:'m', c:'p', q:"How will most people commute in major cities in 2040?", o:["Personal EVs","Public transit","Autonomous ride-share","E-bikes/scooters","Remote work (no commute)"] },
  { id:65, v:1, t:'b', c:'p', q:"Will any tech company reach $10 trillion market cap by 2035?", e:[ev('s','Apple (2024)','~$3.5T')] },
  { id:66, v:1, t:'b', c:'p', q:"Will lab-grown organs be standard medical practice by 2040?" },
  { id:67, v:1, t:'m', c:'p', q:"Which renewable will grow fastest 2025-2035?", o:["Solar","Wind","Geothermal","Hydrogen","Nuclear"] },
  { id:68, v:1, t:'b', c:'p', q:"Will physical cash be eliminated in any major economy by 2035?" },
  { id:69, v:1, t:'b', c:'p', q:"Will we discover definitive evidence of extraterrestrial life by 2050?" },
  { id:70, v:1, t:'m', c:'p', q:"What will college education look like in 2040?", o:["Similar to now","Mostly online","AI-tutored/personalized","Shorter/bootcamp style","Obsolete/replaced by credentials"] },
  { id:71, v:1, t:'b', c:'p', q:"Will global meat consumption decline by 2035?" },
  { id:72, v:1, t:'b', c:'p', q:"Will any country implement a 4-day work week nationally by 2030?" },
  { id:73, v:1, t:'m', c:'p', q:"What will be the next pandemic pathogen type?", o:["Influenza variant","Coronavirus","Bacterial","Fungal","Engineered/bioweapon"] },
  { id:74, v:1, t:'b', c:'p', q:"Will AGI (Artificial General Intelligence) exist by 2035?" },
  { id:75, v:1, t:'b', c:'p', q:"Will the Arctic be ice-free in summer before 2040?", e:[ev('n',null,'Ice extent declining ~13% per decade')] },
  { id:76, v:1, t:'m', c:'p', q:"What will replace smartphones as primary device?", o:["AR glasses","Neural interfaces","Smart watches","Nothing/phones evolve","AI agents (deviceless)"] },
  { id:77, v:1, t:'b', c:'p', q:"Will India become a top 3 global economy by 2030?", e:[ev('s','Current rank','#5')] },
  { id:78, v:1, t:'b', c:'p', q:"Will most new music be AI-generated by 2035?" },
  { id:79, v:1, t:'m', c:'p', q:"What will happen to housing costs in major cities by 2035?", o:["Continue rising","Plateau","Decline significantly","Bifurcate (luxury vs affordable)","Government intervention stabilizes"] },
  { id:80, v:1, t:'b', c:'p', q:"Will autonomous ships handle majority of global shipping by 2040?" },
  { id:81, v:1, t:'b', c:'r', q:"Can a teleporter that destroys and recreates you preserve your identity?" },
  { id:82, v:1, t:'m', c:'r', q:"What makes an action morally right?", o:["Consequences (utilitarianism)","Intent (deontology)","Character (virtue ethics)","Social contract","Nothing objective"] },
  { id:83, v:1, t:'b', c:'r', q:"Is it ethical to create sentient AI?" },
  { id:84, v:1, t:'b', c:'r', q:"Does the trolley problem have a correct answer?", e:[ev('n',null,'Pull lever to save 5, killing 1?')] },
  { id:85, v:1, t:'m', c:'r', q:"What is the nature of consciousness?", o:["Physical brain processes","Emergent property","Fundamental like mass/charge","Illusion","Unknowable"] },
  { id:86, v:1, t:'b', c:'r', q:"Is mathematics discovered (not invented)?" },
  { id:87, v:1, t:'b', c:'r', q:"Can machines ever truly understand (not just simulate)?" },
  { id:88, v:1, t:'m', c:'r', q:"What gives life meaning?", o:["Relationships","Achievement","Pleasure","Purpose/contribution","Nothing inherent"] },
  { id:89, v:1, t:'b', c:'r', q:"Is it wrong to eat animals if alternatives exist?" },
  { id:90, v:1, t:'b', c:'r', q:"Would you take a pill that makes you perpetually happy but delusional?" },
  { id:91, v:1, t:'m', c:'r', q:"If you could live forever, would you want to?", o:["Yes, unconditionally","Yes, with exit option","Only if others could too","No, death gives meaning","Depends on quality of life"] },
  { id:92, v:1, t:'b', c:'r', q:"Is privacy a fundamental right?" },
  { id:93, v:1, t:'b', c:'r', q:"Are humans fundamentally good?" },
  { id:94, v:1, t:'m', c:'r', q:"What is the self?", o:["Continuous soul/essence","Pattern of memories","Illusion","Body/brain","Social construction"] },
  { id:95, v:1, t:'b', c:'r', q:"Is it ethical to gene-edit embryos to prevent disease?" },
  { id:96, v:1, t:'b', c:'r', q:"Can something be art if created by accident?" },
  { id:97, v:1, t:'m', c:'r', q:"What matters more: intention or outcome?", o:["Intention always","Outcome always","Depends on context","Both equally","Neither/virtue matters"] },
  { id:98, v:1, t:'b', c:'r', q:"Is a perfect simulation of a person the same as that person?" },
  { id:99, v:1, t:'b', c:'r', q:"Do animals have rights?" },
  { id:100, v:1, t:'m', c:'r', q:"Why is there something rather than nothing?", o:["God/creator","Physical necessity","Anthropic principle","Brute fact","Question is meaningless"] },
  { id:101, v:1, t:'b', c:'r', q:"Is time travel logically possible?" },
  { id:102, v:1, t:'b', c:'r', q:"Can we ever truly know another person's mind?" },
  { id:103, v:1, t:'m', c:'r', q:"What makes someone the 'same person' over time?", o:["Physical continuity","Memory continuity","Personality","Soul","Legal/social recognition"] },
  { id:104, v:1, t:'b', c:'r', q:"Is it ethical to bring children into a world with suffering?" },
  { id:105, v:1, t:'b', c:'r', q:"Can art be objectively evaluated?" },
  { id:106, v:1, t:'m', c:'r', q:"What is truth?", o:["Correspondence to reality","Coherence with beliefs","What works (pragmatism)","Social consensus","Unknowable"] },
  { id:107, v:1, t:'b', c:'r', q:"Is laziness a vice?" },
  { id:108, v:1, t:'b', c:'r', q:"Would you want to know the exact date of your death?" },
  { id:109, v:1, t:'m', c:'r', q:"Is a calorie-restricted long life better than a shorter indulgent one?", o:["Long life always better","Short indulgent better","Depends on the person","Quality > quantity","False dichotomy"] },
  { id:110, v:1, t:'b', c:'r', q:"Is cultural appropriation always wrong?" },
  { id:111, v:1, t:'b', c:'r', q:"Can evil actions ever be justified by good outcomes?" },
  { id:112, v:1, t:'m', c:'r', q:"What is the purpose of punishment?", o:["Deterrence","Rehabilitation","Retribution","Public safety","No valid purpose"] },
  { id:113, v:1, t:'b', c:'r', q:"Is ignorance ever bliss?" },
  { id:114, v:1, t:'b', c:'r', q:"Do we have moral obligations to future generations?" },
  { id:115, v:1, t:'m', c:'r', q:"Is a lie ever morally required?", o:["Never","To prevent harm","To protect feelings","In war/self-defense","Lies are neutral tools"] },
  { id:116, v:1, t:'b', c:'j', q:"Should billionaires exist?" },
  { id:117, v:1, t:'m', c:'j', q:"What's the best economic system?", o:["Capitalism","Socialism","Mixed economy","Something new","Depends on context"] },
  { id:118, v:1, t:'b', c:'j', q:"Should college be free?" },
  { id:119, v:1, t:'b', c:'j', q:"Is cancel culture a net positive?" },
  { id:120, v:1, t:'m', c:'j', q:"How should AI be regulated?", o:["Strict government control","Industry self-regulation","International treaty","Minimal regulation","Case-by-case basis"] },
  { id:121, v:1, t:'b', c:'j', q:"Should voting be mandatory?", e:[ev('s','Australia turnout','~95%')] },
  { id:122, v:1, t:'b', c:'j', q:"Is the death penalty ever justified?" },
  { id:123, v:1, t:'m', c:'j', q:"What should be done about illegal immigration?", o:["Open borders","Path to citizenship","Stricter enforcement","Guest worker programs","Address root causes"] },
  { id:124, v:1, t:'b', c:'j', q:"Should drugs be decriminalized?" },
  { id:125, v:1, t:'b', c:'j', q:"Is universal basic income a good idea?" },
  { id:126, v:1, t:'m', c:'j', q:"Who should control the internet?", o:["Governments","Private companies","International body","Decentralized/no one","Users collectively"] },
  { id:127, v:1, t:'b', c:'j', q:"Should hate speech be illegal?" },
  { id:128, v:1, t:'b', c:'j', q:"Is affirmative action justified?" },
  { id:129, v:1, t:'m', c:'j', q:"What's the right approach to climate policy?", o:["Carbon tax","Regulations/mandates","Subsidies for green tech","Nuclear expansion","Adaptation focus"] },
  { id:130, v:1, t:'b', c:'j', q:"Should assisted suicide be legal?" },
  { id:131, v:1, t:'b', c:'j', q:"Are private schools harmful to public education?" },
  { id:132, v:1, t:'m', c:'j', q:"How should we handle wealth inequality?", o:["Progressive taxation","Wealth caps","Universal services","Education/opportunity","It's not a problem"] },
  { id:133, v:1, t:'b', c:'j', q:"Should AI art be copyrightable?" },
  { id:134, v:1, t:'b', c:'j', q:"Is nationalism inherently dangerous?" },
  { id:135, v:1, t:'m', c:'j', q:"What should replace prisons?", o:["Nothing - reform prisons","Rehabilitation centers","Restorative justice","Electronic monitoring","Community service"] },
  { id:136, v:1, t:'b', c:'j', q:"Should parents be able to select embryos for traits?" },
  { id:137, v:1, t:'b', c:'j', q:"Is a global government desirable?" },
  { id:138, v:1, t:'m', c:'j', q:"How should gig workers be classified?", o:["Employees","Contractors","New category","Worker's choice","Depends on the job"] },
  { id:139, v:1, t:'b', c:'j', q:"Should tech companies be broken up?" },
  { id:140, v:1, t:'b', c:'j', q:"Is zoning reform the solution to housing costs?" },
  { id:141, v:1, t:'m', c:'j', q:"What's the best voting system?", o:["First-past-the-post","Ranked choice","Proportional representation","Approval voting","Sortition (random selection)"] },
  { id:142, v:1, t:'b', c:'j', q:"Should there be limits on free speech online?" },
  { id:143, v:1, t:'b', c:'j', q:"Is meritocracy a myth?" },
  { id:144, v:1, t:'m', c:'j', q:"How should social media moderate content?", o:["Government oversight","Platform discretion","User-controlled filters","No moderation","Community-based moderation"] },
  { id:145, v:1, t:'b', c:'j', q:"Should voting age be lowered to 16?" },
  { id:146, v:1, t:'b', c:'j', q:"Are unions still necessary?" },
  { id:147, v:1, t:'m', c:'j', q:"What's the solution to political polarization?", o:["Media reform","Education","Electoral reform","Economic equality","No solution exists"] },
  { id:148, v:1, t:'b', c:'j', q:"Should wealthy nations pay climate reparations?" },
  { id:149, v:1, t:'b', c:'j', q:"Is remote work better for society overall?" },
  { id:150, v:1, t:'m', c:'j', q:"How should we handle misinformation?", o:["Government regulation","Platform labels/removal","Media literacy education","Let marketplace decide","Impossible to solve"] },
  { id:151, v:1, t:'m', c:'j', q:"What's the best decade for music?", o:["1960s","1970s","1980s","1990s","2000s+"] },
  { id:152, v:1, t:'b', c:'j', q:"Is working from home better than office work?" },
  { id:153, v:1, t:'m', c:'j', q:"What's the ideal vacation length?", o:["Long weekend (3-4 days)","One week","Two weeks","One month+","Frequent short trips"] },
  { id:154, v:1, t:'b', c:'j', q:"Are audiobooks as good as reading?" },
  { id:155, v:1, t:'m', c:'j', q:"What's the best coffee preparation?", o:["Espresso","Pour over","French press","Drip","Cold brew"] },
  { id:156, v:1, t:'b', c:'j', q:"Is buying a home better than renting?" },
  { id:157, v:1, t:'m', c:'j', q:"What's the ideal number of children?", o:["Zero","One","Two","Three","Four+"] },
  { id:158, v:1, t:'b', c:'j', q:"Are open offices a bad idea?" },
  { id:159, v:1, t:'m', c:'j', q:"What's the best way to exercise?", o:["Gym/weights","Running/cardio","Sports/games","Yoga/flexibility","Walking"] },
  { id:160, v:1, t:'b', c:'j', q:"Is social media net negative for society?" },
  { id:161, v:1, t:'m', c:'j', q:"What's the ideal work schedule?", o:["9-5, five days","4-day week","Flexible hours","Results-only","Varies by person"] },
  { id:162, v:1, t:'b', c:'j', q:"Are video games a waste of time?" },
  { id:163, v:1, t:'m', c:'j', q:"What's the best pet for a busy person?", o:["Cat","Dog","Fish","No pet","Low-maintenance reptile"] },
  { id:164, v:1, t:'b', c:'j', q:"Should you always follow your passion for a career?" },
  { id:165, v:1, t:'m', c:'j', q:"What's the ideal retirement age?", o:["55","60","65","70","Never fully retire"] },
  { id:166, v:1, t:'b', c:'j', q:"Is a college degree still worth it?" },
  { id:167, v:1, t:'m', c:'j', q:"What's the best news source format?", o:["Print newspaper","TV news","Podcasts","Social media","News apps/aggregators"] },
  { id:168, v:1, t:'b', c:'j', q:"Are smartphones making us less intelligent?" },
  { id:169, v:1, t:'m', c:'j', q:"What's the ideal city size to live in?", o:["Small town (<50k)","Medium city (50-500k)","Large city (500k-2M)","Major metro (2M+)","Rural/countryside"] },
  { id:170, v:1, t:'b', c:'j', q:"Is it okay to ghost someone after a few dates?" },
  { id:171, v:1, t:'m', c:'j', q:"What's more important in a job?", o:["Salary","Work-life balance","Interesting work","Good colleagues","Career growth"] },
  { id:172, v:1, t:'b', c:'j', q:"Should you tell a friend their partner is cheating?" },
  { id:173, v:1, t:'m', c:'j', q:"What's the best breakfast?", o:["Continental (pastry/coffee)","Full cooked breakfast","Healthy (smoothie/oatmeal)","Skip breakfast","Whatever's available"] },
  { id:174, v:1, t:'b', c:'j', q:"Is it rude to recline your seat on a plane?" },
  { id:175, v:1, t:'m', c:'j', q:"What's the ideal age to get married?", o:["Early 20s","Late 20s","Early 30s","35+","Never/optional"] },
  { id:176, v:1, t:'b', c:'j', q:"Are reality TV shows harmful?" },
  { id:177, v:1, t:'m', c:'j', q:"What's the best streaming service?", o:["Netflix","Disney+","HBO Max","Amazon Prime","YouTube"] },
  { id:178, v:1, t:'b', c:'j', q:"Is tipping culture a good thing?" },
  { id:179, v:1, t:'m', c:'j', q:"What's more important: IQ or EQ?", o:["IQ","EQ","Both equally","Neither/other factors","Depends on context"] },
  { id:180, v:1, t:'b', c:'j', q:"Should you lend money to friends?" },
  { id:181, v:1, t:'m', c:'j', q:"What's the best way to learn a language?", o:["Apps (Duolingo)","Classes","Immersion","Tutoring","Media consumption"] },
  { id:182, v:1, t:'b', c:'j', q:"Is minimalism a superior lifestyle?" },
  { id:183, v:1, t:'m', c:'j', q:"What makes a house a home?", o:["Family/people","Personal belongings","Time spent there","Ownership","Feeling of safety"] },
  { id:184, v:1, t:'b', c:'j', q:"Should couples combine finances?" },
  { id:185, v:1, t:'m', c:'j', q:"What's the ideal amount of sleep?", o:["5-6 hours","7 hours","8 hours","9+ hours","Varies by person"] },
  { id:186, v:1, t:'b', c:'j', q:"Is cold weather better than hot weather?" },
  { id:187, v:1, t:'m', c:'j', q:"What's the best time of day to work out?", o:["Early morning","Late morning","Lunchtime","After work","Evening"] },
  { id:188, v:1, t:'b', c:'j', q:"Are New Year's resolutions pointless?" },
  { id:189, v:1, t:'m', c:'j', q:"What's the ideal commute time?", o:["Under 10 min","10-20 min","20-30 min","30-45 min","No commute (remote)"] },
  { id:190, v:1, t:'b', c:'j', q:"Is being an early bird better than night owl?" },
  { id:191, v:1, t:'b', c:'j', q:"Is this headline misleading? 'Study finds coffee drinkers live longer'", e:[ev('n',null,'Correlation study, n=10,000, no controls for lifestyle')] },
  { id:192, v:1, t:'m', c:'j', q:"Rate this business pitch: 'Uber for dog walking'", o:["Strong - clear market","Medium - competitive space","Weak - already exists","Need more info"] },
  { id:193, v:1, t:'b', c:'j', q:"Is this statistic meaningful? '90% of startups fail'", e:[ev('n',null,'Definition of "fail" and timeframe vary widely')] },
  { id:194, v:1, t:'b', c:'j', q:"Is this a valid argument? 'Most CEOs are tall, so being tall helps you succeed'" },
  { id:195, v:1, t:'m', c:'j', q:"Rate this excuse for being late: 'Traffic was bad'", o:["Completely valid","Usually acceptable","Weak excuse","Unacceptable","Depends on frequency"] },
  { id:196, v:1, t:'b', c:'j', q:"Is this claim verifiable? 'Our AI reduces costs by 40%'" },
  { id:197, v:1, t:'m', c:'j', q:"Rate this study design: Survey of 100 Twitter users about public opinion", o:["Strong methodology","Acceptable with caveats","Weak but usable","Fundamentally flawed"] },
  { id:198, v:1, t:'b', c:'j', q:"Is this a conflict of interest? Nutrition study funded by food company" },
  { id:199, v:1, t:'b', c:'j', q:"Is this photo likely AI-generated? (Perfect symmetry, 6 fingers)" },
  { id:200, v:1, t:'m', c:'j', q:"Rate this investment thesis: 'AI will replace all jobs, so invest in robots'", o:["Sound reasoning","Partially valid","Oversimplified","Fundamentally wrong"] },
  { id:201, v:1, t:'b', c:'j', q:"Is this apology genuine? 'I'm sorry you feel that way'" },
  { id:202, v:1, t:'b', c:'j', q:"Is this product review trustworthy? 5 stars, 3 words, verified purchase" },
  { id:203, v:1, t:'m', c:'j', q:"Rate this job posting: 'Fast-paced environment, wear many hats, competitive salary'", o:["Attractive opportunity","Yellow flags","Red flags","Need more info"] },
  { id:204, v:1, t:'b', c:'j', q:"Is this a logical fallacy? 'Everyone's doing it, so it must be okay'" },
  { id:205, v:1, t:'b', c:'j', q:"Is this sample size adequate? Medical trial with 50 participants", e:[ev('n',null,'Testing rare disease treatment')] },
  { id:206, v:1, t:'m', c:'j', q:"Rate this dating profile: 'No drama, know what I want, fluent in sarcasm'", o:["Appealing","Neutral","Off-putting","Depends on audience"] },
  { id:207, v:1, t:'b', c:'j', q:"Is this reasoning sound? 'Stock went up after I bought it, so I'm a good investor'" },
  { id:208, v:1, t:'b', c:'j', q:"Is this email a scam? 'Urgent: Verify your account or lose access'" },
  { id:209, v:1, t:'m', c:'j', q:"Rate this restaurant review: '1 star - food was great but parking was hard'", o:["Fair rating","Unfair rating","Useful information","Should be ignored"] },
  { id:210, v:1, t:'b', c:'j', q:"Is this correlation meaningful? 'Ice cream sales and drowning deaths both rise in summer'" },
  { id:211, v:1, t:'b', c:'j', q:"Is this expertise relevant? Physicist commenting on economics" },
  { id:212, v:1, t:'m', c:'j', q:"Rate this prediction track record: 60% accuracy on binary outcomes", o:["Excellent","Good","Mediocre","Poor","Need more context"] },
  { id:213, v:1, t:'b', c:'j', q:"Is this source reliable? Wikipedia article with 50 citations" },
  { id:214, v:1, t:'b', c:'j', q:"Is this a valid comparison? 'Company X is the Airbnb of Y industry'" },
  { id:215, v:1, t:'m', c:'j', q:"Rate this feedback: 'Good job, but could be better'", o:["Helpful","Somewhat helpful","Useless","Harmful"] },
  { id:216, v:1, t:'b', c:'r', q:"Is 2^10 greater than 1000?", e:[ev('n',null,'2^10 = 1024')] },
  { id:217, v:1, t:'m', c:'r', q:"What comes next: 1, 1, 2, 3, 5, 8, __?", o:["11","12","13","15"] },
  { id:218, v:1, t:'b', c:'r', q:"Can a year have two Friday the 13ths?" },
  { id:219, v:1, t:'b', c:'r', q:"Is the sum of angles in a triangle always 180Â°?" },
  { id:220, v:1, t:'m', c:'r', q:"How many states does the US have?", o:["48","50","51","52"] },
  { id:221, v:1, t:'b', c:'r', q:"Is the speed of light faster than the speed of sound?" },
  { id:222, v:1, t:'m', c:'r', q:"What is 15% of 80?", o:["10","12","15","18"] },
  { id:223, v:1, t:'b', c:'r', q:"Can you fold a piece of paper more than 7 times?" },
  { id:224, v:1, t:'b', c:'r', q:"Is a tomato a fruit?" },
  { id:225, v:1, t:'m', c:'r', q:"How many planets in our solar system?", o:["7","8","9","10"] },
  { id:226, v:1, t:'b', c:'r', q:"Is 0.999... (repeating) equal to 1?" },
  { id:227, v:1, t:'m', c:'r', q:"What day follows Saturday?", o:["Friday","Sunday","Monday","Sabbath"] },
  { id:228, v:1, t:'b', c:'r', q:"Can a triangle have two right angles?" },
  { id:229, v:1, t:'b', c:'r', q:"Is Venus hotter than Mercury?", e:[ev('n',null,'Mercury is closer to the Sun')] },
  { id:230, v:1, t:'m', c:'r', q:"What is the square root of 169?", o:["11","12","13","14"] },
  { id:231, v:1, t:'b', c:'r', q:"Do all mammals give live birth?" },
  { id:232, v:1, t:'b', c:'r', q:"Is Ï€ (pi) a rational number?" },
  { id:233, v:1, t:'m', c:'r', q:"How many sides does a hexagon have?", o:["5","6","7","8"] },
  { id:234, v:1, t:'b', c:'r', q:"Is Mount Everest the tallest mountain from base to peak?", e:[ev('n',null,'Consider Mauna Kea from ocean floor')] },
  { id:235, v:1, t:'b', c:'r', q:"Can sound travel through a vacuum?" },
  { id:236, v:1, t:'m', c:'r', q:"What is 7 Ã— 8?", o:["54","56","58","64"] },
  { id:237, v:1, t:'b', c:'r', q:"Is blue light higher energy than red light?" },
  { id:238, v:1, t:'b', c:'r', q:"Does water expand when it freezes?" },
  { id:239, v:1, t:'m', c:'r', q:"How many degrees in a circle?", o:["180","270","360","400"] },
  { id:240, v:1, t:'b', c:'r', q:"Is a whale a fish?" },
  { id:241, v:1, t:'b', c:'p', q:"Will SpaceX successfully land humans on Mars by 2030?" },
  { id:242, v:1, t:'m', c:'p', q:"What will be the biggest tech IPO of 2027?", o:["OpenAI","Stripe","SpaceX","Databricks","Something unexpected"] },
  { id:243, v:1, t:'b', c:'p', q:"Will the US dollar lose reserve currency status by 2040?" },
  { id:244, v:1, t:'b', c:'p', q:"Will longevity treatments extend average lifespan by 10+ years by 2050?" },
  { id:245, v:1, t:'m', c:'p', q:"Which emerging technology will have the biggest impact by 2035?", o:["Quantum computing","Brain-computer interfaces","Gene editing","Nuclear fusion","Robotics"] },
  { id:246, v:1, t:'b', c:'p', q:"Will there be a major cyber attack on US infrastructure by 2028?" },
  { id:247, v:1, t:'b', c:'p', q:"Will Netflix still be the top streaming service in 2030?" },
  { id:248, v:1, t:'m', c:'p', q:"What will cause the next major tech layoff wave?", o:["AI automation","Economic recession","Regulatory crackdown","Market saturation","Geopolitical conflict"] },
  { id:249, v:1, t:'b', c:'p', q:"Will synthetic biology create new organisms for commercial use by 2030?" },
  { id:250, v:1, t:'b', c:'p', q:"Will augmented reality glasses be mainstream by 2028?" },
  { id:251, v:1, t:'m', c:'p', q:"Which country will have the best healthcare system in 2040?", o:["United States","Singapore","Japan","Nordic countries","AI-driven system (location irrelevant)"] },
  { id:252, v:1, t:'b', c:'p', q:"Will vertical farming produce 10% of vegetables in developed nations by 2035?" },
  { id:253, v:1, t:'b', c:'p', q:"Will any AI model be granted legal rights by 2040?" },
  { id:254, v:1, t:'m', c:'p', q:"What will happen to journalism by 2035?", o:["AI-written dominates","Subscription model wins","Citizen journalism rises","Government-funded expands","Complete transformation"] },
  { id:255, v:1, t:'b', c:'p', q:"Will carbon capture technology be commercially viable by 2035?" },
  { id:256, v:1, t:'b', c:'p', q:"Will there be a global treaty on AI development by 2030?" },
  { id:257, v:1, t:'m', c:'p', q:"How will most people pay for things in 2035?", o:["Credit/debit cards","Mobile wallets","Cryptocurrency","Biometric payments","Central bank digital currency"] },
  { id:258, v:1, t:'b', c:'p', q:"Will personalized medicine based on genetics be standard by 2035?" },
  { id:259, v:1, t:'b', c:'p', q:"Will any major sport allow performance-enhancing AI implants by 2040?" },
  { id:260, v:1, t:'m', c:'p', q:"What will be the dominant form of entertainment in 2040?", o:["Streaming video","Interactive/VR experiences","AI-generated content","Live events resurgence","Social media content"] },
  { id:261, v:1, t:'b', c:'p', q:"Will desalination solve water scarcity for 1 billion people by 2040?" },
  { id:262, v:1, t:'b', c:'p', q:"Will traditional TV broadcasting still exist in 2035?" },
  { id:263, v:1, t:'m', c:'p', q:"What will happen to movie theaters by 2035?", o:["Thriving luxury experience","Mostly closed","Converted to other uses","VR replaces them","Premium-only events"] },
  { id:264, v:1, t:'b', c:'p', q:"Will robots perform 50% of surgery by 2040?" },
  { id:265, v:1, t:'b', c:'p', q:"Will quantum internet be available commercially by 2040?" },
  { id:266, v:1, t:'m', c:'p', q:"Which job will be most AI-resistant in 2035?", o:["Healthcare worker","Tradesperson","Teacher","Creative artist","Social worker"] },
  { id:267, v:1, t:'b', c:'p', q:"Will flying cars/air taxis be common in major cities by 2040?" },
  { id:268, v:1, t:'b', c:'p', q:"Will Apple still be the most valuable company in 2030?" },
  { id:269, v:1, t:'m', c:'p', q:"What will replace Google Search as the primary information source?", o:["AI assistants","Nothing (Google adapts)","Decentralized search","Social media","Specialized vertical search"] },
  { id:270, v:1, t:'b', c:'p', q:"Will 3D-printed houses be 10% of new construction by 2035?" },
  { id:271, v:1, t:'b', c:'p', q:"Will human-level AI assistants be in every home by 2035?" },
  { id:272, v:1, t:'m', c:'p', q:"What will be the biggest geopolitical conflict of the 2030s?", o:["US-China","Climate refugees","Water wars","AI arms race","Economic blocks"] },
  { id:273, v:1, t:'b', c:'p', q:"Will cryptocurrency be banned in any G20 nation by 2030?" },
  { id:274, v:1, t:'b', c:'p', q:"Will genetic screening of embryos be routine in developed nations by 2035?" },
  { id:275, v:1, t:'m', c:'p', q:"What will be the primary mode of long-distance travel in 2050?", o:["Traditional aircraft","Supersonic jets","Hyperloop","Electric aircraft","Virtual presence replaces travel"] },
  { id:276, v:1, t:'b', c:'p', q:"Will Amazon still dominate e-commerce in 2035?" },
  { id:277, v:1, t:'b', c:'p', q:"Will lab-grown diamonds exceed natural diamond sales by 2030?" },
  { id:278, v:1, t:'m', c:'p', q:"How will dating work in 2035?", o:["Apps still dominant","AI matchmaking","VR dating","Return to traditional","Hybrid approaches"] },
  { id:279, v:1, t:'b', c:'p', q:"Will any country achieve net-zero emissions before 2040?" },
  { id:280, v:1, t:'b', c:'p', q:"Will holographic displays replace screens in homes by 2040?" },
  { id:281, v:1, t:'b', c:'r', q:"Is knowledge without wisdom dangerous?" },
  { id:282, v:1, t:'m', c:'r', q:"What is the greatest human virtue?", o:["Courage","Compassion","Wisdom","Justice","Honesty"] },
  { id:283, v:1, t:'b', c:'r', q:"Can we be held responsible for actions we were destined to take?" },
  { id:284, v:1, t:'b', c:'r', q:"Is suffering necessary for happiness?" },
  { id:285, v:1, t:'m', c:'r', q:"What is the source of moral authority?", o:["Religion/God","Reason","Social consensus","Evolution","Individual conscience"] },
  { id:286, v:1, t:'b', c:'r', q:"Is it ethical to modify human memory?" },
  { id:287, v:1, t:'b', c:'r', q:"Can a copy of a mind be the same person?" },
  { id:288, v:1, t:'m', c:'r', q:"What makes humans unique from other animals?", o:["Language","Reason","Self-awareness","Culture","Nothing fundamental"] },
  { id:289, v:1, t:'b', c:'r', q:"Is it possible to be truly selfless?" },
  { id:290, v:1, t:'b', c:'r', q:"Does beauty exist objectively?" },
  { id:291, v:1, t:'m', c:'r', q:"What is the best life philosophy?", o:["Stoicism","Buddhism","Existentialism","Utilitarianism","Religious faith"] },
  { id:292, v:1, t:'b', c:'r', q:"Is it wrong to create life knowing it will suffer?" },
  { id:293, v:1, t:'b', c:'r', q:"Can a thought experiment prove anything about reality?" },
  { id:294, v:1, t:'m', c:'r', q:"What is the relationship between mind and body?", o:["Mind is brain (materialism)","Mind is separate (dualism)","Mind emerges from complexity","Mind is fundamental","Unknown/unknowable"] },
  { id:295, v:1, t:'b', c:'r', q:"Is nostalgia a trap?" },
  { id:296, v:1, t:'b', c:'r', q:"Should we prioritize helping the worst off over the average?" },
  { id:297, v:1, t:'m', c:'r', q:"When is violence justified?", o:["Never","Only self-defense","Defense of others","Against tyranny","Context-dependent"] },
  { id:298, v:1, t:'b', c:'r', q:"Is boredom primarily a modern problem?" },
  { id:299, v:1, t:'b', c:'r', q:"Can you change who you fundamentally are?" },
  { id:300, v:1, t:'m', c:'r', q:"What is the purpose of government?", o:["Protect rights","Promote welfare","Maintain order","Enable freedom","No legitimate purpose"] },
  { id:301, v:1, t:'b', c:'r', q:"Is moral progress real?" },
  { id:302, v:1, t:'b', c:'r', q:"Does the existence of evil disprove a benevolent God?" },
  { id:303, v:1, t:'m', c:'r', q:"What makes a good life?", o:["Pleasure","Achievement","Virtue","Meaning","Balance of all"] },
  { id:304, v:1, t:'b', c:'r', q:"Is it better for a leader to be feared than loved?" },
  { id:305, v:1, t:'b', c:'r', q:"Can future people have rights?" },
  { id:306, v:1, t:'m', c:'r', q:"Why do we dream?", o:["Brain maintenance","Emotional processing","Problem solving","Random neural firing","Connection to something deeper"] },
  { id:307, v:1, t:'b', c:'r', q:"Is authenticity overrated?" },
  { id:308, v:1, t:'b', c:'r', q:"Can a society be too equal?" },
  { id:309, v:1, t:'m', c:'r', q:"What is the greatest threat to human flourishing?", o:["Technology","Human nature","Scarcity","Tribalism","Loss of meaning"] },
  { id:310, v:1, t:'b', c:'r', q:"Is optimism rational?" },
  { id:311, v:1, t:'b', c:'r', q:"Should we enhance human intelligence artificially?" },
  { id:312, v:1, t:'m', c:'r', q:"What is justice?", o:["Fairness","Desert (getting what you deserve)","Need-based distribution","Process-based","Social harmony"] },
  { id:313, v:1, t:'b', c:'r', q:"Is it wrong to not have children?" },
  { id:314, v:1, t:'b', c:'r', q:"Can nationalism be positive?" },
  { id:315, v:1, t:'m', c:'r', q:"What is wisdom?", o:["Knowledge applied well","Understanding limits","Emotional intelligence","Life experience","Knowing what matters"] },
  { id:316, v:1, t:'b', c:'r', q:"Is ambition generally a virtue?" },
  { id:317, v:1, t:'b', c:'r', q:"Should we try to eliminate all suffering?" },
  { id:318, v:1, t:'m', c:'r', q:"What determines personal identity over time?", o:["Physical continuity","Psychological continuity","Social recognition","Narrative self","No fixed identity"] },
  { id:319, v:1, t:'b', c:'r', q:"Is revenge ever justified?" },
  { id:320, v:1, t:'b', c:'r', q:"Can an AI have genuine emotions?" },
  { id:321, v:1, t:'b', c:'j', q:"Should AI-generated art be allowed in art competitions?" },
  { id:322, v:1, t:'m', c:'j', q:"How should we handle aging populations?", o:["Increase immigration","Raise retirement age","Automation","Pro-natalist policies","Accept decline"] },
  { id:323, v:1, t:'b', c:'j', q:"Should there be a maximum wage?" },
  { id:324, v:1, t:'b', c:'j', q:"Is nuclear power the answer to climate change?" },
  { id:325, v:1, t:'m', c:'j', q:"What should be done about homelessness?", o:["Housing first","Mental health focus","Job programs","Stricter enforcement","Universal basic income"] },
  { id:326, v:1, t:'b', c:'j', q:"Should parents be licensed?" },
  { id:327, v:1, t:'b', c:'j', q:"Is anonymous speech online a right?" },
  { id:328, v:1, t:'m', c:'j', q:"How should we fund healthcare?", o:["Single payer","Private insurance","Hybrid system","Health savings accounts","Employer-based"] },
  { id:329, v:1, t:'b', c:'j', q:"Should voting require passing a civics test?" },
  { id:330, v:1, t:'b', c:'j', q:"Are standardized tests a good measure of ability?" },
  { id:331, v:1, t:'m', c:'j', q:"What's the best way to reduce crime?", o:["More police","Social programs","Decriminalization","Community policing","Economic opportunity"] },
  { id:332, v:1, t:'b', c:'j', q:"Should there be term limits for Supreme Court justices?" },
  { id:333, v:1, t:'b', c:'j', q:"Is cultural relativism valid?" },
  { id:334, v:1, t:'m', c:'j', q:"How should we handle student debt?", o:["Full forgiveness","Partial forgiveness","Income-based repayment","No forgiveness","Reform future lending"] },
  { id:335, v:1, t:'b', c:'j', q:"Should companies be required to disclose AI use in products?" },
  { id:336, v:1, t:'b', c:'j', q:"Is intellectual property law too restrictive?" },
  { id:337, v:1, t:'m', c:'j', q:"What's the best approach to drug addiction?", o:["Criminalization","Harm reduction","Forced treatment","Decriminalization","Full legalization"] },
  { id:338, v:1, t:'b', c:'j', q:"Should there be a right to be forgotten online?" },
  { id:339, v:1, t:'b', c:'j', q:"Is space exploration worth the cost?" },
  { id:340, v:1, t:'m', c:'j', q:"How should we address income inequality?", o:["Higher taxes on wealthy","Universal basic services","Stronger unions","Education reform","Market solutions"] },
  { id:341, v:1, t:'b', c:'j', q:"Should athletes be allowed to use any enhancements?" },
  { id:342, v:1, t:'b', c:'j', q:"Is jury duty an unfair burden?" },
  { id:343, v:1, t:'m', c:'j', q:"What's the solution to fake news?", o:["Platform regulation","Media literacy education","Fact-checking labels","Legal consequences","Let market decide"] },
  { id:344, v:1, t:'b', c:'j', q:"Should there be reparations for historical injustices?" },
  { id:345, v:1, t:'b', c:'j', q:"Is it ethical to use ad blockers?" },
  { id:346, v:1, t:'m', c:'j', q:"How should we handle genetic discrimination?", o:["Ban all genetic testing for insurance","Allow with consent","Government oversight","Personal responsibility","Universal healthcare solves it"] },
  { id:347, v:1, t:'b', c:'j', q:"Should schools teach financial literacy as a required course?" },
  { id:348, v:1, t:'b', c:'j', q:"Is meritocracy compatible with equality?" },
  { id:349, v:1, t:'m', c:'j', q:"What should be done about factory farming?", o:["Ban it","Stricter regulations","Consumer choice","Lab-grown alternatives","Gradual phase-out"] },
  { id:350, v:1, t:'b', c:'j', q:"Should AI systems be required to identify themselves?" },
  { id:351, v:1, t:'b', c:'j', q:"Is gerrymandering ever acceptable?" },
  { id:352, v:1, t:'m', c:'j', q:"How should we address the urban-rural divide?", o:["Investment in rural areas","Encourage urbanization","Remote work incentives","Infrastructure spending","Accept divergence"] },
  { id:353, v:1, t:'b', c:'j', q:"Should organ sales be legal?" },
  { id:354, v:1, t:'b', c:'j', q:"Is it ethical to eat octopus given their intelligence?" },
  { id:355, v:1, t:'m', c:'j', q:"What's the best way to handle climate migration?", o:["Open borders","Managed resettlement","Adapt in place","International fund","Prevention focus"] },
  { id:356, v:1, t:'b', c:'j', q:"Should there be limits on AI in military applications?" },
  { id:357, v:1, t:'b', c:'j', q:"Is it fair to judge historical figures by modern standards?" },
  { id:358, v:1, t:'m', c:'j', q:"How should we reform policing?", o:["More funding/training","Defund and redirect","Community-based alternatives","Federal oversight","Local control"] },
  { id:359, v:1, t:'b', c:'j', q:"Should social media companies be treated as publishers?" },
  { id:360, v:1, t:'b', c:'j', q:"Is it ethical to clone pets?" },
  { id:361, v:1, t:'m', c:'j', q:"What's the best type of vacation?", o:["Beach relaxation","Adventure/active","Cultural exploration","Staycation","Road trip"] },
  { id:362, v:1, t:'b', c:'j', q:"Is buying a car better than leasing?" },
  { id:363, v:1, t:'m', c:'j', q:"What's the ideal family dinner frequency?", o:["Every night","Most nights","Few times a week","Weekends only","Special occasions"] },
  { id:364, v:1, t:'b', c:'j', q:"Should you tell your salary to coworkers?" },
  { id:365, v:1, t:'m', c:'j', q:"What's the best age to have children?", o:["Early 20s","Late 20s","Early 30s","Late 30s","Never/optional"] },
  { id:366, v:1, t:'b', c:'j', q:"Is it okay to read your partner's messages?" },
  { id:367, v:1, t:'m', c:'j', q:"What makes a good boss?", o:["Clear direction","Empathy","Technical expertise","Advocacy","Hands-off approach"] },
  { id:368, v:1, t:'b', c:'j', q:"Should you always RSVP to invitations?" },
  { id:369, v:1, t:'m', c:'j', q:"What's the best way to spend a windfall?", o:["Pay off debt","Invest","Experience/travel","Save for emergency","Treat yourself"] },
  { id:370, v:1, t:'b', c:'j', q:"Is it rude to wear headphones in public constantly?" },
  { id:371, v:1, t:'m', c:'j', q:"What's the ideal home temperature?", o:["65-67Â°F","68-70Â°F","71-73Â°F","74-76Â°F","Varies by room/season"] },
  { id:372, v:1, t:'b', c:'j', q:"Should you split the bill on a first date?" },
  { id:373, v:1, t:'m', c:'j', q:"What's the best time to exercise?", o:["Early morning","Mid-morning","Lunchtime","After work","Evening"] },
  { id:374, v:1, t:'b', c:'j', q:"Is being early better than being exactly on time?" },
  { id:375, v:1, t:'m', c:'j', q:"What's the ideal number of close friends?", o:["1-2","3-5","6-10","10+","Quality over quantity"] },
  { id:376, v:1, t:'b', c:'j', q:"Should you fake it till you make it?" },
  { id:377, v:1, t:'m', c:'j', q:"What's the best pizza topping?", o:["Pepperoni","Margherita (plain)","Supreme/everything","Hawaiian","Meat lovers"] },
  { id:378, v:1, t:'b', c:'j', q:"Is it okay to take work calls on vacation?" },
  { id:379, v:1, t:'m', c:'j', q:"What's more important in a home?", o:["Location","Size","Price","Condition","Outdoor space"] },
  { id:380, v:1, t:'b', c:'j', q:"Should you confront a friend about bad behavior?" },
  { id:381, v:1, t:'m', c:'j', q:"What's the best way to unwind after work?", o:["Exercise","TV/streaming","Reading","Socializing","Hobbies"] },
  { id:382, v:1, t:'b', c:'j', q:"Is it worth paying for premium subscriptions?" },
  { id:383, v:1, t:'m', c:'j', q:"What's the ideal wedding size?", o:["Elopement (2-10)","Intimate (10-50)","Medium (50-150)","Large (150-300)","Huge (300+)"] },
  { id:384, v:1, t:'b', c:'j', q:"Should you live together before marriage?" },
  { id:385, v:1, t:'m', c:'j', q:"What's the best approach to gift-giving?", o:["Thoughtful personal gifts","Gift cards","Experience gifts","Charitable donations","Skip gifts altogether"] },
  { id:386, v:1, t:'b', c:'j', q:"Is being a specialist better than a generalist?" },
  { id:387, v:1, t:'m', c:'j', q:"What's the ideal screen time per day?", o:["Under 2 hours","2-4 hours","4-6 hours","6-8 hours","No limit if productive"] },
  { id:388, v:1, t:'b', c:'j', q:"Should parents track their teenager's location?" },
  { id:389, v:1, t:'m', c:'j', q:"What's the best way to handle disagreements?", o:["Discuss immediately","Cool off first","Write it out","Get a mediator","Let it go"] },
  { id:390, v:1, t:'b', c:'j', q:"Is having a side hustle necessary today?" },
  { id:391, v:1, t:'m', c:'j', q:"What's the ideal morning routine length?", o:["15-30 min","30-60 min","1-2 hours","2+ hours","No routine"] },
  { id:392, v:1, t:'b', c:'j', q:"Should you negotiate every job offer?" },
  { id:393, v:1, t:'m', c:'j', q:"What's the best way to save money?", o:["Automatic transfers","Budgeting apps","Cash envelope system","Investment focus","Frugal lifestyle"] },
  { id:394, v:1, t:'b', c:'j', q:"Is it okay to cancel plans last minute?" },
  { id:395, v:1, t:'m', c:'j', q:"What's more important in a car?", o:["Reliability","Fuel efficiency","Safety","Comfort","Performance"] },
  { id:396, v:1, t:'b', c:'j', q:"Should you keep in touch with exes?" },
  { id:397, v:1, t:'m', c:'j', q:"What's the best approach to networking?", o:["Events/conferences","LinkedIn","Through friends","Cold outreach","Just do good work"] },
  { id:398, v:1, t:'b', c:'j', q:"Is meal prepping worth the effort?" },
  { id:399, v:1, t:'m', c:'j', q:"What's the ideal vacation frequency?", o:["Monthly getaways","Quarterly trips","1-2 big trips/year","One annual vacation","Mini-retirements"] },
  { id:400, v:1, t:'b', c:'j', q:"Should you always follow your gut?" },
  { id:401, v:1, t:'b', c:'j', q:"Is this claim credible? 'This supplement cured my chronic disease'" },
  { id:402, v:1, t:'m', c:'j', q:"Rate this excuse: 'I didn't see your message'", o:["Usually valid","Sometimes valid","Rarely valid","Never valid"] },
  { id:403, v:1, t:'b', c:'j', q:"Is this a red flag? Company asks for unpaid 'test project' before hiring" },
  { id:404, v:1, t:'b', c:'j', q:"Is this statistic meaningful? 'Our users save an average of 2 hours/week'" },
  { id:405, v:1, t:'m', c:'j', q:"Rate this apology: 'I'm sorry, but you misunderstood me'", o:["Genuine apology","Partial apology","Non-apology","Gaslighting"] },
  { id:406, v:1, t:'b', c:'j', q:"Is this review trustworthy? Detailed negative review with specific examples" },
  { id:407, v:1, t:'b', c:'j', q:"Is this argument valid? 'We've always done it this way, so it must work'" },
  { id:408, v:1, t:'m', c:'j', q:"Rate this job red flag level: 'We're like a family here'", o:["Green flag","Yellow flag","Red flag","Depends on context"] },
  { id:409, v:1, t:'b', c:'j', q:"Is this source credible? Preprint study not yet peer-reviewed" },
  { id:410, v:1, t:'b', c:'j', q:"Is this financial advice sound? 'Always max out your 401k before other investments'" },
  { id:411, v:1, t:'m', c:'j', q:"Rate this forecast methodology: Survey of 10 industry experts", o:["Strong","Moderate","Weak","Insufficient info"] },
  { id:412, v:1, t:'b', c:'j', q:"Is this product claim verifiable? 'Clinically proven to reduce wrinkles'" },
  { id:413, v:1, t:'b', c:'j', q:"Is this a valid criticism? 'Your data is correct but your interpretation is wrong'" },
  { id:414, v:1, t:'m', c:'j', q:"Rate this landlord response time: 48 hours for non-emergency repair", o:["Excellent","Acceptable","Poor","Unacceptable"] },
  { id:415, v:1, t:'b', c:'j', q:"Is this news headline clickbait? 'Scientists discover shocking truth about coffee'" },
  { id:416, v:1, t:'b', c:'j', q:"Is this comparison fair? Comparing startup revenue to established company" },
  { id:417, v:1, t:'m', c:'j', q:"Rate this password: 'Summer2024!'", o:["Strong","Moderate","Weak","Very weak"] },
  { id:418, v:1, t:'b', c:'j', q:"Is this testimonial credible? Celebrity endorsement of weight loss product" },
  { id:419, v:1, t:'b', c:'j', q:"Is this logic sound? 'The experts were wrong before, so they're wrong now'" },
  { id:420, v:1, t:'m', c:'j', q:"Rate this salary negotiation tactic: Revealing your current salary", o:["Smart move","Neutral","Mistake","Depends heavily on context"] },
  { id:421, v:1, t:'b', c:'j', q:"Is this study design adequate? Self-reported data from online survey" },
  { id:422, v:1, t:'b', c:'j', q:"Is this price reasonable? $15 for a cocktail in a major city" },
  { id:423, v:1, t:'m', c:'j', q:"Rate this excuse for missing a deadline: 'I had too many other priorities'", o:["Valid","Partially valid","Weak","Unacceptable"] },
  { id:424, v:1, t:'b', c:'j', q:"Is this warranty worth it? Extended warranty on a $500 appliance for $80" },
  { id:425, v:1, t:'b', c:'j', q:"Is this influencer recommendation trustworthy? #Ad disclosed, detailed review" },
  { id:426, v:1, t:'b', c:'r', q:"Is the capital of Canada Ottawa?" },
  { id:427, v:1, t:'m', c:'r', q:"What is 25% of 200?", o:["25","40","50","75"] },
  { id:428, v:1, t:'b', c:'r', q:"Does February ever have 30 days?" },
  { id:429, v:1, t:'b', c:'r', q:"Is gold heavier than silver (by density)?" },
  { id:430, v:1, t:'m', c:'r', q:"What is the next prime after 23?", o:["25","27","29","31"] },
  { id:431, v:1, t:'b', c:'r', q:"Can two even numbers sum to an odd number?" },
  { id:432, v:1, t:'b', c:'r', q:"Is Antarctica a continent?" },
  { id:433, v:1, t:'m', c:'r', q:"How many continents are there?", o:["5","6","7","8"] },
  { id:434, v:1, t:'b', c:'r', q:"Is the Great Wall of China visible from space with the naked eye?" },
  { id:435, v:1, t:'b', c:'r', q:"Do penguins live in the Arctic?" },
  { id:436, v:1, t:'m', c:'r', q:"What is 3Â³?", o:["9","18","27","81"] },
  { id:437, v:1, t:'b', c:'r', q:"Is the human body made mostly of water?" },
  { id:438, v:1, t:'b', c:'r', q:"Does light travel in a straight line in a vacuum?" },
  { id:439, v:1, t:'m', c:'r', q:"What fraction is equivalent to 0.25?", o:["1/3","1/4","1/5","2/5"] },
  { id:440, v:1, t:'b', c:'r', q:"Is the Sahara the largest desert on Earth?", e:[ev('n',null,'Consider Antarctica')] },
];

// Expand to full format
const QUESTIONS = Q_RAW.filter(q => !q.x).map(q => ({
  id: q.id, type: T[q.t], text: q.q, category: C[q.c],
  ...(q.o && { options: q.o }), ...(q.e && { preEvidence: q.e }), _v: q.v,
}));
const getCategoryList = () => Object.values(CAT_MAP);
  </script>
  <script type="text/babel">
const { useState, useEffect, useRef, useCallback } = React;

// ==================== DATA ====================
const CATEGORIES = getCategoryList();

const MC_COLORS = [
  { hex: '#3b82f6', name: 'blue', shades: ['#93c5fd', '#60a5fa', '#3b82f6', '#1e40af'], rgb: '59, 130, 246' },
  { hex: '#14b8a6', name: 'teal', shades: ['#5eead4', '#2dd4bf', '#14b8a6', '#0f766e'], rgb: '20, 184, 166' },
  { hex: '#22c55e', name: 'green', shades: ['#86efac', '#4ade80', '#22c55e', '#15803d'], rgb: '34, 197, 94' },
  { hex: '#ec4899', name: 'pink', shades: ['#f9a8d4', '#f472b6', '#ec4899', '#be185d'], rgb: '236, 72, 153' },
  { hex: '#8b5cf6', name: 'violet', shades: ['#c4b5fd', '#a78bfa', '#8b5cf6', '#6d28d9'], rgb: '139, 92, 246' },
];

const CONFIDENCE_LABELS = { 1: "Hunch", 2: "Leaning", 3: "Firm", 4: "Certain" };

// Question of the Day pool
const QOTD_POOL = [
  { type: 'binary', text: 'Should AI systems be required to identify themselves when interacting with humans?', sponsor: { name: 'AI Safety Institute', avatar: 'ðŸ›ï¸' }, distribution: { yes: [142, 287, 412, 389], no: [98, 156, 201, 162] } },
  { type: 'binary', text: 'Is universal basic income inevitable as automation increases?', sponsor: { name: 'Future of Work Foundation', avatar: 'ðŸ¤–' }, distribution: { yes: [198, 312, 287, 245], no: [156, 234, 189, 167] } },
  { type: 'binary', text: 'Should social media platforms be held liable for user-generated content?', sponsor: { name: 'Digital Rights Coalition', avatar: 'ðŸ“±' }, distribution: { yes: [167, 234, 312, 278], no: [189, 267, 234, 198] } },
  { type: 'binary', text: 'Will humans establish a permanent Mars colony by 2050?', sponsor: { name: 'Space Exploration Society', avatar: 'ðŸš€' }, distribution: { yes: [123, 198, 234, 167], no: [234, 312, 289, 256] } },
  { type: 'multiple', text: 'What will be the dominant AI interface by 2030?', options: ['Text chat', 'Voice assistants', 'AR/VR agents', 'Brain-computer interfaces'], sponsor: { name: 'Future Tech Institute', avatar: 'ðŸ”®' }, distribution: [[89, 145, 178, 134], [112, 189, 234, 198], [67, 98, 123, 89], [34, 56, 67, 45]] },
  { type: 'binary', text: 'Should voting be mandatory in democratic countries?', sponsor: { name: 'Civic Engagement Alliance', avatar: 'ðŸ—³ï¸' }, distribution: { yes: [156, 223, 267, 198], no: [198, 289, 312, 234] } },
  { type: 'binary', text: 'Is privacy more important than national security?', sponsor: { name: 'Civil Liberties Union', avatar: 'ðŸ”’' }, distribution: { yes: [189, 267, 312, 256], no: [145, 212, 234, 189] } },
  { type: 'multiple', text: 'What gives life the most meaning?', options: ['Relationships', 'Achievement', 'Pleasure', 'Purpose/contribution'], sponsor: { name: 'Philosophy Foundation', avatar: 'ðŸ¤”' }, distribution: [[178, 267, 334, 289], [89, 134, 167, 145], [56, 78, 89, 67], [123, 189, 234, 198]] },
  { type: 'binary', text: 'Should gene editing for disease prevention be allowed in humans?', sponsor: { name: 'Bioethics Council', avatar: 'ðŸ§¬' }, distribution: { yes: [212, 334, 378, 312], no: [98, 156, 178, 145] } },
  { type: 'multiple', text: 'Most important skill for the next decade?', options: ['AI/ML literacy', 'Critical thinking', 'Emotional intelligence', 'Adaptability'], sponsor: { name: 'Future Skills Lab', avatar: 'ðŸŽ¯' }, distribution: [[145, 212, 267, 223], [167, 245, 312, 267], [98, 145, 178, 145], [112, 178, 223, 189]] },
  { type: 'binary', text: 'Will AGI (Artificial General Intelligence) be achieved by 2035?', sponsor: { name: 'AI Research Consortium', avatar: 'ðŸ§ ' }, distribution: { yes: [145, 212, 234, 189], no: [178, 267, 289, 245] } },
];

const getRandomQOTD = () => {
  const q = QOTD_POOL[Math.floor(Math.random() * QOTD_POOL.length)];
  let totalResponses;
  if (q.type === 'binary') {
    totalResponses = q.distribution.yes.reduce((a, b) => a + b, 0) + q.distribution.no.reduce((a, b) => a + b, 0);
  } else {
    totalResponses = q.distribution.reduce((sum, opt) => sum + opt.reduce((a, b) => a + b, 0), 0);
  }
  return {
    id: `qotd-${Date.now()}`,
    day: 147 + Math.floor(Math.random() * 50),
    text: q.text,
    type: q.type || 'binary',
    options: q.options || null,
    sponsor: q.sponsor,
    reward: 25,
    endsAt: new Date().setHours(23, 59, 59, 999),
    totalResponses,
    distribution: q.distribution,
  };
};

const getQotdTimeRemaining = () => {
  const now = new Date();
  const end = new Date();
  end.setHours(23, 59, 59, 999);
  const diff = end - now;
  const hours = Math.floor(diff / (1000 * 60 * 60));
  const mins = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
  return `${hours}h ${mins}m`;
};

const shuffleArray = (array) => {
  const shuffled = [...array];
  for (let i = shuffled.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
  }
  return shuffled;
};

const generateFakeResults = (question) => {
  const seed = question.id;
  const random = (n) => ((seed * 9301 + 49297) % 233280) / 233280 * n;
  const count = 550 + Math.floor(random(200));

  if (question.type === 'binary') {
    const evaluators = [];
    const yesBase = 30 + random(40);
    for (let i = 0; i < count; i++) {
      const isYes = Math.random() * 100 < yesBase;
      evaluators.push({
        id: `e${i}`,
        answer: isYes ? 0 : 1,
        confidence: 1 + Math.floor(Math.random() * 4),
        score: 40 + Math.floor(Math.random() * 40)
      });
    }
    return { evaluators };
  } else {
    const options = question.options || [];
    const evaluators = [];
    for (let i = 0; i < count; i++) {
      evaluators.push({
        id: `e${i}`,
        answer: Math.floor(Math.random() * options.length),
        confidence: 1 + Math.floor(Math.random() * 4),
        score: 40 + Math.floor(Math.random() * 40)
      });
    }
    return { evaluators };
  }
};

// Convert QOD distribution data to evaluators format (so QOD can use same components as regular Q&A)
const qotdDistributionToEvaluators = (qotdData) => {
  if (!qotdData) return { evaluators: [] };
  const evaluators = [];
  let id = 0;

  if (qotdData.type === 'binary') {
    // distribution.yes[0..3] = counts for conf 1-4, same for .no
    qotdData.distribution.yes.forEach((count, confIdx) => {
      for (let i = 0; i < count; i++) {
        evaluators.push({ id: `qe${id++}`, answer: 0, confidence: confIdx + 1, score: 50 + Math.floor(Math.random() * 30) });
      }
    });
    qotdData.distribution.no.forEach((count, confIdx) => {
      for (let i = 0; i < count; i++) {
        evaluators.push({ id: `qe${id++}`, answer: 1, confidence: confIdx + 1, score: 50 + Math.floor(Math.random() * 30) });
      }
    });
  } else {
    // distribution[optIdx][confIdx] = count
    qotdData.distribution.forEach((optDist, optIdx) => {
      optDist.forEach((count, confIdx) => {
        for (let i = 0; i < count; i++) {
          evaluators.push({ id: `qe${id++}`, answer: optIdx, confidence: confIdx + 1, score: 50 + Math.floor(Math.random() * 30) });
        }
      });
    });
  }
  return { evaluators };
};

// ==================== DEMO PRE-POPULATION ====================
// Generate 20 pre-answered questions for demo experience
const generateDemoAnswers = () => {
  const answers = {};
  const now = Date.now();
  // Pre-answer first 20 questions with varied timestamps over past 7 days
  for (let i = 1; i <= 20; i++) {
    const q = QUESTIONS.find(q => q.id === i);
    if (!q) continue;
    const daysAgo = Math.floor(Math.random() * 7);
    const hoursAgo = Math.floor(Math.random() * 24);
    const timestamp = now - (daysAgo * 86400000) - (hoursAgo * 3600000);
    if (q.type === 'binary') {
      answers[i] = { answer: Math.random() > 0.5 ? 0 : 1, confidence: 1 + Math.floor(Math.random() * 4), timestamp };
    } else {
      answers[i] = { answer: Math.floor(Math.random() * (q.options?.length || 4)), confidence: 1 + Math.floor(Math.random() * 4), timestamp };
    }
  }
  return answers;
};

const generateDemoCommunityResults = () => {
  const results = {};
  for (let i = 1; i <= 20; i++) {
    const q = QUESTIONS.find(q => q.id === i);
    if (q) results[i] = generateFakeResults(q);
  }
  return results;
};

// ==================== STORAGE ====================
const STORAGE_KEY = 'aura-demo-vI';
const getInitialState = () => {
  const demoAnswers = generateDemoAnswers();
  return {
    answers: demoAnswers, skipped: [], saved: [], viewed: [],
    settings: { darkMode: null, undoDelay: 1.5, showStreak: true, requireConfirmation: true, showTips: true },
    stats: { answered: Object.keys(demoAnswers).length, streak: 3, lastAnswerDate: new Date().toDateString() }
  };
};

const demoStorage = {
  get: () => {
    try {
      const data = localStorage.getItem(STORAGE_KEY);
      if (data) return { ...getInitialState(), ...JSON.parse(data) };
    } catch (e) {}
    return getInitialState();
  },
  set: (data) => { try { localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); } catch (e) {} },
  clear: () => { try { localStorage.removeItem(STORAGE_KEY); } catch (e) {} }
};
// Reset to fresh state with 20 answers
demoStorage.clear();

const getInitialDarkMode = () => {
  const settings = demoStorage.get().settings;
  if (settings.darkMode !== null) return settings.darkMode;
  return window.matchMedia('(prefers-color-scheme: dark)').matches;
};

// ==================== HOOKS ====================
const useDisplayMode = () => {
  const getMode = () => {
    try {
      if (window.matchMedia('(display-mode: standalone)').matches) return 'mobile';
      if (window.navigator.standalone === true) return 'mobile';
      if (window.innerWidth <= 768) return 'mobile';
      if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) return 'mobile';
    } catch (e) {}
    return 'desktop';
  };
  const [mode, setMode] = useState('desktop');
  useEffect(() => {
    setMode(getMode());
    const handleResize = () => setMode(getMode());
    window.addEventListener('resize', handleResize);
    return () => window.removeEventListener('resize', handleResize);
  }, []);
  return mode;
};

const useSwipe = ({ onSwipeLeft, onSwipeRight, enabled = true }) => {
  const touchStartX = useRef(0);
  const touchStartY = useRef(0);

  const handleTouchStart = useCallback((e) => {
    if (!enabled) return;
    touchStartX.current = e.touches[0].clientX;
    touchStartY.current = e.touches[0].clientY;
  }, [enabled]);

  const handleTouchEnd = useCallback((e) => {
    if (!enabled) return;
    const deltaX = e.changedTouches[0].clientX - touchStartX.current;
    const deltaY = e.changedTouches[0].clientY - touchStartY.current;
    if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > 50) {
      if (deltaX > 0 && onSwipeRight) onSwipeRight();
      else if (deltaX < 0 && onSwipeLeft) onSwipeLeft();
    }
  }, [enabled, onSwipeLeft, onSwipeRight]);

  return { handlers: { onTouchStart: handleTouchStart, onTouchEnd: handleTouchEnd } };
};

// ==================== COMPONENTS ====================

// PhoneFrame - Desktop wrapper
const PhoneFrame = ({ children, darkMode = true }) => (
  <div className="min-h-screen bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 flex items-center justify-center p-4">
    <div className="relative bg-[#1a1a1c] rounded-[55px] p-3 shadow-2xl" style={{ filter: 'drop-shadow(0 25px 50px rgba(0,0,0,0.4))' }}>
      <div className="absolute -left-[3px] top-[100px] w-[3px] h-[28px] bg-[#2a2a2c] rounded-l-sm" />
      <div className="absolute -left-[3px] top-[145px] w-[3px] h-[50px] bg-[#2a2a2c] rounded-l-sm" />
      <div className="absolute -left-[3px] top-[205px] w-[3px] h-[50px] bg-[#2a2a2c] rounded-l-sm" />
      <div className="absolute -right-[3px] top-[160px] w-[3px] h-[65px] bg-[#2a2a2c] rounded-r-sm" />
      <div className={`relative overflow-hidden flex flex-col ${darkMode ? 'bg-gray-950' : 'bg-gray-100'}`} style={{ width: 393, height: 852, borderRadius: 44 }}>
        <div className="absolute top-3 left-1/2 -translate-x-1/2 w-[126px] h-[37px] bg-black rounded-full z-30" />
        <div className={`flex-shrink-0 flex items-end justify-between px-8 pb-2 h-[54px] ${darkMode ? 'text-white' : 'text-gray-900'} text-sm font-semibold relative z-20`}>
          <span>9:41</span>
          <div className="flex gap-1.5 items-center">
            <svg className="w-[18px] h-[12px]" viewBox="0 0 18 12" fill="currentColor"><path d="M1 4a1 1 0 011-1h1a1 1 0 011 1v4a1 1 0 01-1 1H2a1 1 0 01-1-1V4zM6 3a1 1 0 011-1h1a1 1 0 011 1v5a1 1 0 01-1 1H7a1 1 0 01-1-1V3zM11 2a1 1 0 011-1h1a1 1 0 011 1v6a1 1 0 01-1 1h-1a1 1 0 01-1-1V2z"/></svg>
            <svg className="w-[17px] h-[11px]" viewBox="0 0 17 11" fill="currentColor"><path d="M8.5 2.5a6 6 0 014.24 1.76.75.75 0 001.06-1.06A7.5 7.5 0 008.5 1a7.5 7.5 0 00-5.3 2.2.75.75 0 001.06 1.06A6 6 0 018.5 2.5z"/><path d="M8.5 5.5a3 3 0 012.12.88.75.75 0 001.06-1.06 4.5 4.5 0 00-6.36 0 .75.75 0 001.06 1.06A3 3 0 018.5 5.5z"/><circle cx="8.5" cy="9" r="1.5"/></svg>
            <div className="flex items-center">
              <div className={`w-[25px] h-[12px] border-[1.5px] ${darkMode ? 'border-white' : 'border-gray-900'} rounded-[3px] flex items-center p-[2px]`}>
                <div className={`w-[17px] h-[7px] ${darkMode ? 'bg-white' : 'bg-gray-900'} rounded-[1px]`} />
              </div>
              <div className={`w-[1.5px] h-[5px] ${darkMode ? 'bg-white' : 'bg-gray-900'} ml-[1px] rounded-r-sm`} />
            </div>
          </div>
        </div>
        <div className="flex-1 flex flex-col overflow-hidden">{children}</div>
        <div className={`absolute bottom-2 left-1/2 -translate-x-1/2 w-[134px] h-[5px] ${darkMode ? 'bg-white' : 'bg-gray-900'} rounded-full opacity-60 z-20`} />
      </div>
    </div>
  </div>
);

// NavBar
const NavBar = ({ darkMode, stats, showStreak, onHome, onDoubleClickHome, onSettings, onProfile }) => (
  <div className={`flex items-center justify-between px-4 py-2 ${darkMode ? 'bg-gray-950/70 border-b border-white/5' : 'bg-white/70 border-b border-gray-200/50'} backdrop-blur-md`}>
    <button onClick={onHome} onDoubleClick={onDoubleClickHome} className="text-xl active:scale-90 transition-transform">ðŸŒ€</button>
    <button onClick={onProfile} className={`flex items-center gap-2 px-2 py-1 rounded-lg transition-colors ${darkMode ? 'hover:bg-gray-800/50' : 'hover:bg-gray-200'}`}>
      <span className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>{stats.answered} answered</span>
      {showStreak && stats.streak > 0 && <span className="text-sm text-orange-400">ðŸ”¥{stats.streak}</span>}
    </button>
    <button onClick={onSettings} className={`text-xl active:scale-90 transition-transform ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>â˜°</button>
  </div>
);

// LaunchScreen
const LaunchScreen = ({ onDemo, onLogin, darkMode }) => (
  <div className="flex-1 flex flex-col items-center justify-center p-8" style={{backgroundColor: darkMode ? '#030712' : '#f9fafb'}}>
    <div className="text-6xl mb-4">ðŸŒ€</div>
    <h1 className="text-3xl font-bold mb-2" style={{color: darkMode ? '#fff' : '#111'}}>Aura</h1>
    <p className="text-sm mb-12" style={{color: darkMode ? '#9ca3af' : '#6b7280'}}>Answer questions with confidence</p>
    <div className="w-full max-w-xs space-y-3">
      <button onClick={onLogin} className={`w-full py-3 px-6 rounded-xl font-medium transition-all ${darkMode ? 'shine-card shine-blue glow-blue' : ''}`} style={{backgroundColor: darkMode ? '#fff' : '#111', color: darkMode ? '#111' : '#fff'}}>Login / Sign Up</button>
      <button onClick={onDemo} className="w-full py-3 px-6 rounded-xl font-medium transition-all" style={{backgroundColor: darkMode ? '#1f2937' : '#f3f4f6', color: darkMode ? '#d1d5db' : '#374151'}}>Try Demo</button>
    </div>
    <p className="text-sm mt-6 text-center max-w-xs" style={{color: darkMode ? '#4b5563' : '#9ca3af'}}>Demo answers aren't saved to community.<br/>Login to contribute real data.</p>
  </div>
);

// ConfidenceSegments - fills up inside button
const ConfidenceSegments = ({ level, color = 'violet', active = false, darkMode = true }) => {
  const colors = {
    emerald: ['rgba(6,78,59,0.6)', 'rgba(4,120,87,0.7)', 'rgba(5,150,105,0.8)', 'rgba(16,185,129,0.9)'],
    rose: ['rgba(136,19,55,0.6)', 'rgba(190,18,60,0.7)', 'rgba(225,29,72,0.8)', 'rgba(244,63,94,0.9)'],
  };
  const shades = colors[color] || colors.emerald;
  if (!active || level === 0) return null;
  return (
    <div className="absolute bottom-0 left-0 right-0 h-2 flex">
      {[1, 2, 3, 4].map(i => (
        <div key={i} className={`flex-1 transition-all duration-150 ${i === 1 ? 'rounded-bl-xl' : ''} ${i === 4 ? 'rounded-br-xl' : ''}`}
          style={{
            backgroundColor: level >= i ? shades[i - 1] : 'rgba(0,0,0,0.2)',
            borderRight: i < 4 ? '1px solid rgba(0,0,0,0.3)' : 'none'
          }}
        />
      ))}
    </div>
  );
};

// BinaryChart - confidence breakdown
const BinaryChart = ({ evaluators, userResponse, darkMode = true }) => {
  if (!evaluators || evaluators.length === 0) return null;
  const allVotes = userResponse ? [...evaluators, { ...userResponse, id: 'user', score: 50 }] : evaluators;
  const userConf = userResponse ? Math.min(4, Math.max(1, userResponse.confidence || 1)) - 1 : -1;
  const data = [
    { label: 'Yes', answer: 0, confCounts: [0,0,0,0] },
    { label: 'No', answer: 1, confCounts: [0,0,0,0] },
  ];
  allVotes.forEach(v => {
    if (v.answer === 0) data[0].confCounts[v.confidence - 1]++;
    else if (v.answer === 1) data[1].confCounts[v.confidence - 1]++;
  });
  data.forEach(d => d.count = d.confCounts.reduce((a, b) => a + b, 0));
  const total = data[0].count + data[1].count;
  const sorted = [...data].sort((a, b) => b.count - a.count);
  const maxCount = Math.max(data[0].count, data[1].count, 1);
  // Colors: index 0=conf1(light), 3=conf4(dark) - display order is conf4â†’conf1 (darkâ†’light)
  const yesColors = ['#a7f3d0', '#6ee7b7', '#34d399', '#10b981']; // lightâ†’dark
  const noColors = ['#fecaca', '#fda4af', '#fb7185', '#f43f5e'];   // lightâ†’dark

  return (
    <div className="space-y-2">
      {sorted.map((opt) => {
        const isUserRow = userResponse?.answer === opt.answer;
        const pct = total > 0 ? Math.round((opt.count / total) * 100) : 0;
        const barWidth = maxCount > 0 ? (opt.count / maxCount) * 100 : 0;
        const emptyWidth = 100 - barWidth;
        const colors = opt.answer === 0 ? yesColors : noColors;
        return (
          <div key={opt.answer} className="flex items-center gap-2">
            <span className={`text-sm ${opt.answer === 0 ? (darkMode ? 'text-emerald-400' : 'text-emerald-600') : (darkMode ? 'text-rose-400' : 'text-rose-600')} ${isUserRow ? 'font-bold px-1.5 py-0.5 rounded-full border border-current' : 'w-12'}`}>
              {opt.label}
            </span>
            <span className={`text-sm w-10 ${opt.answer === 0 ? (darkMode ? 'text-emerald-400' : 'text-emerald-600') : (darkMode ? 'text-rose-400' : 'text-rose-600')}`}>{pct}%</span>
            <div className="flex-1 h-4 rounded-full overflow-hidden bg-black">
              <div className="h-full flex">
                {[3, 2, 1, 0].map(confIdx => {
                  const count = opt.confCounts[confIdx];
                  const segWidth = opt.count > 0 ? (count / maxCount) * 100 : 0;
                  const isUserSeg = isUserRow && confIdx === userConf;
                  return segWidth > 0 ? (
                    <div key={confIdx} className="h-full" style={{ width: `${segWidth}%`, background: colors[confIdx], ...(isUserSeg ? { border: '3px solid white', borderRadius: '12px', zIndex: 10, position: 'relative' } : {}) }} />
                  ) : null;
                })}
                {emptyWidth > 0 && (
                  <div className="h-full rounded-r-full" style={{ width: `${emptyWidth}%`, border: `1px solid ${colors[0]}`, borderLeft: 'none' }} />
                )}
              </div>
            </div>
          </div>
        );
      })}
    </div>
  );
};

// MultipleChoiceChart
const MultipleChoiceChart = ({ evaluators, userResponse, options, darkMode = true }) => {
  if (!evaluators || evaluators.length === 0) return null;
  const allVotes = userResponse ? [...evaluators, { ...userResponse, id: 'user', score: 50 }] : evaluators;
  const userConf = userResponse ? Math.min(4, Math.max(1, userResponse.confidence || 1)) - 1 : -1;
  const data = options.map((label, i) => {
    const votes = allVotes.filter(v => v.answer === i);
    const confCounts = [0, 0, 0, 0];
    votes.forEach(v => confCounts[v.confidence - 1]++);
    return { label, index: i, count: votes.length, confCounts };
  });
  const total = allVotes.length;
  const sorted = [...data].sort((a, b) => b.count - a.count);
  const maxCount = Math.max(...data.map(d => d.count), 1);

  return (
    <div className="space-y-1">
      {sorted.filter(opt => opt.count > 0).slice(0, 5).map((opt, rank) => {
        const isUserRow = userResponse?.answer === opt.index;
        const pct = total > 0 ? Math.round((opt.count / total) * 100) : 0;
        const barWidth = maxCount > 0 ? (opt.count / maxCount) * 100 : 0;
        const emptyWidth = 100 - barWidth;
        const optColor = MC_COLORS[opt.index % MC_COLORS.length];
        return (
          <div key={opt.index} className="flex items-center gap-2">
            <span className={`text-sm w-24 truncate ${isUserRow ? 'font-bold px-1.5 py-0.5 rounded-full border border-current' : ''}`} style={{ color: optColor.hex }}>{opt.label}</span>
            <span className="text-sm w-10" style={{ color: optColor.hex }}>{pct}%</span>
            <div className="flex-1 h-4 rounded-full overflow-hidden" style={{ border: `1px solid ${optColor.shades[0]}` }}>
              <div className="h-full flex">
                {[3, 2, 1, 0].map(confIdx => {
                  const count = opt.confCounts[confIdx];
                  const segWidth = opt.count > 0 ? (count / maxCount) * 100 : 0;
                  const isUserSeg = isUserRow && confIdx === userConf;
                  return segWidth > 0 ? (
                    <div key={confIdx} className="h-full" style={{ width: `${segWidth}%`, background: optColor.shades[confIdx], ...(isUserSeg ? { border: '3px solid white', borderRadius: '12px', zIndex: 10, position: 'relative' } : {}) }} />
                  ) : null;
                })}
              </div>
            </div>
          </div>
        );
      })}
    </div>
  );
};

// Mini Community Results - shows comparison with user's answer
const MiniCommunityResults = ({ question, results, userResponse, darkMode, onClick }) => {
  if (!results || !results.evaluators || !userResponse) return null;
  const total = results.evaluators.length;
  const isBinary = question.type === 'binary';
  const userConf = Math.min(4, Math.max(1, userResponse.confidence || 1)) - 1; // 0-3 index

  // Confidence color shades: index 0=conf4(dark), 1=conf3, 2=conf2, 3=conf1(light)
  const yesColors = ['#10b981', '#34d399', '#6ee7b7', '#a7f3d0']; // emerald darkâ†’light
  const noColors = ['#ef4444', '#f87171', '#fca5a5', '#fecaca'];   // rose darkâ†’light

  // Build segments: conf4, conf3, conf2, conf1 (left to right, dark to light)
  // Returns segments with conf index to check for user highlight
  const buildSegments = (byConf, colors, maxWidth) => {
    const segments = [];
    for (let i = 3; i >= 0; i--) { // conf4(i=3) first, then conf3, conf2, conf1
      if (byConf[i] > 0) {
        segments.push({
          width: (byConf[i] / maxWidth) * 100,
          color: colors[3 - i], // conf4â†’colors[0](dark), conf1â†’colors[3](light)
          conf: i // original confidence index (0-3 where 3=conf4)
        });
      }
    }
    return segments;
  };

  if (isBinary) {
    const yesByConf = [0, 0, 0, 0];
    const noByConf = [0, 0, 0, 0];
    results.evaluators.forEach(e => {
      const conf = Math.min(4, Math.max(1, e.confidence || 1)) - 1;
      if (e.answer === 0) yesByConf[conf]++;
      else noByConf[conf]++;
    });
    const yesTotal = yesByConf.reduce((a, b) => a + b, 0);
    const noTotal = noByConf.reduce((a, b) => a + b, 0);
    const yesPct = Math.round((yesTotal / total) * 100);
    const noPct = 100 - yesPct;
    const userIsYes = userResponse.answer === 0;
    const maxCount = Math.max(yesTotal, noTotal);

    // Winner on top
    const yesWins = yesPct >= noPct;
    const rows = yesWins
      ? [{ label: 'Yes', pct: yesPct, byConf: yesByConf, colors: yesColors, isYes: true },
         { label: 'No', pct: noPct, byConf: noByConf, colors: noColors, isYes: false }]
      : [{ label: 'No', pct: noPct, byConf: noByConf, colors: noColors, isYes: false },
         { label: 'Yes', pct: yesPct, byConf: yesByConf, colors: yesColors, isYes: true }];
    const winnerGlow = yesWins ? 'glow-emerald' : 'glow-rose';

    return (
      <button onClick={onClick} className={`w-full px-3 py-2 rounded-lg text-left transition-all active:scale-[0.99] ${darkMode ? `bg-gray-900/80 hover:bg-gray-800 shine-card ${winnerGlow}` : 'bg-gray-100 hover:bg-gray-200'}`}>
        <div className={`text-sm font-medium mb-1.5 truncate ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
          {question.text}
        </div>
        <div className="space-y-1">
          {rows.map(row => {
            const isUserRow = row.isYes === userIsYes;
            const segments = buildSegments(row.byConf, row.colors, maxCount);
            const totalWidth = segments.reduce((a, s) => a + s.width, 0);
            const emptyWidth = 100 - totalWidth;
            return (
              <div key={row.label} className="flex items-center gap-2">
                <span className={`text-sm ${isUserRow ? 'font-bold px-1.5 py-0.5 rounded-full border border-current' : 'w-8'}`} style={{ color: row.colors[0] }}>
                  {row.label}
                </span>
                <span className={`text-sm w-6`} style={{ color: row.colors[0] }}>{row.pct}</span>
                <div className="flex-1 h-2 rounded-full overflow-hidden bg-black">
                  <div className="h-full flex">
                    {segments.map((s, i) => {
                      // Highlight only the segment matching user's answer AND confidence
                      const isUserSegment = isUserRow && s.conf === userConf;
                      return (
                        <div key={i} className="h-full" style={{
                          width: `${s.width}%`,
                          backgroundColor: s.color,
                          ...(isUserSegment ? { border: '3px solid white', borderRadius: '12px', zIndex: 10, position: 'relative' } : {})
                        }} />
                      );
                    })}
                    {/* Empty portion: hollow pill outline (lightest color border, black center) */}
                    {emptyWidth > 0 && (
                      <div className="h-full rounded-r-full" style={{
                        width: `${emptyWidth}%`,
                        border: `1px solid ${row.colors[3]}`,
                        borderLeft: 'none'
                      }} />
                    )}
                  </div>
                </div>
              </div>
            );
          })}
        </div>
        <div className={`text-sm text-right mt-1 ${darkMode ? 'text-gray-600' : 'text-gray-400'}`}>{total} responses â†’</div>
      </button>
    );
  }

  // MC - separate bars per option, sorted by popularity
  const optionData = {};
  results.evaluators.forEach(e => {
    if (!optionData[e.answer]) optionData[e.answer] = { total: 0, byConf: [0, 0, 0, 0] };
    optionData[e.answer].total++;
    const conf = Math.min(4, Math.max(1, e.confidence || 1)) - 1;
    optionData[e.answer].byConf[conf]++;
  });
  const sorted = Object.entries(optionData).sort((a, b) => b[1].total - a[1].total).slice(0, 5);
  const maxCount = sorted[0]?.[1]?.total || 1;
  const winnerIdx = sorted[0] ? parseInt(sorted[0][0]) : 0;
  const mcGlowMap = ['glow-blue', 'glow-teal', 'glow-emerald', 'glow-rose', 'glow-violet'];
  const winnerGlow = mcGlowMap[winnerIdx % mcGlowMap.length];

  return (
    <button onClick={onClick} className={`w-full px-3 py-2 rounded-lg text-left transition-all active:scale-[0.99] ${darkMode ? `bg-gray-900/80 hover:bg-gray-800 shine-card ${winnerGlow}` : 'bg-gray-100 hover:bg-gray-200'}`}>
      <div className={`text-sm font-medium mb-1.5 truncate ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
        {question.text}
      </div>
      <div className="space-y-1">
        {sorted.map(([idx, data]) => {
          const i = parseInt(idx);
          const isUserRow = i === userResponse.answer;
          const pct = Math.round((data.total / total) * 100);
          const color = MC_COLORS[i % MC_COLORS.length];
          const label = question.options?.[i] || `Option ${i + 1}`;
          // Build segments: conf4â†’conf1, darkâ†’light (shades[3]=dark, shades[0]=light)
          const segments = [];
          for (let c = 3; c >= 0; c--) {
            if (data.byConf[c] > 0) {
              segments.push({
                width: (data.byConf[c] / maxCount) * 100,
                color: color.shades[c], // shades[3]=dark, shades[0]=light
                conf: c
              });
            }
          }
          const totalWidth = segments.reduce((a, s) => a + s.width, 0);
          const emptyWidth = 100 - totalWidth;
          return (
            <div key={i} className="flex items-center gap-2">
              <span className={`text-sm w-20 truncate ${isUserRow ? 'font-bold px-1.5 py-0.5 rounded-full border border-current' : ''}`} style={{ color: color.hex }}>
                {label}
              </span>
              <span className={`text-sm w-6`} style={{ color: color.hex }}>{pct}</span>
              <div className="flex-1 h-1.5 rounded-full overflow-hidden bg-black">
                <div className="h-full flex">
                  {segments.map((s, si) => {
                    // Highlight only the segment matching user's answer AND confidence
                    const isUserSegment = isUserRow && s.conf === userConf;
                    return (
                      <div key={si} className="h-full" style={{
                        width: `${s.width}%`,
                        backgroundColor: s.color,
                        ...(isUserSegment ? { border: '3px solid white', borderRadius: '12px', zIndex: 10, position: 'relative' } : {})
                      }} />
                    );
                  })}
                  {/* Empty portion: hollow pill outline (lightest color border, black center) */}
                  {emptyWidth > 0 && (
                    <div className="h-full rounded-r-full" style={{
                      width: `${emptyWidth}%`,
                      border: `1px solid ${color.shades[0]}`,
                      borderLeft: 'none'
                    }} />
                  )}
                </div>
              </div>
            </div>
          );
        })}
      </div>
      <div className={`text-sm text-right mt-1 ${darkMode ? 'text-gray-600' : 'text-gray-400'}`}>{total} responses â†’</div>
    </button>
  );
};

// Full Results Panel (modal)
const FullResultsPanel = ({ question, results, userResponse, darkMode, onClose, onSwipeLeft, onSwipeRight }) => {
  const isBinary = question.type === 'binary';
  const touchStartX = React.useRef(0);
  const total = results?.evaluators?.length || 1;
  const userAnswer = userResponse?.answer;
  const userConf = userResponse ? Math.min(4, Math.max(1, userResponse.confidence || 1)) - 1 : -1;

  const handleTouchStart = (e) => { touchStartX.current = e.touches[0].clientX; };
  const handleTouchEnd = (e) => {
    const diff = e.changedTouches[0].clientX - touchStartX.current;
    if (Math.abs(diff) > 50) {
      if (diff > 0 && onSwipeRight) onSwipeRight();
      else if (diff < 0 && onSwipeLeft) onSwipeLeft();
    }
  };

  // Build rows data - same logic as expanded view
  const allRows = [];
  if (isBinary) {
    const yesColors = ['#6ee7b7', '#34d399', '#10b981', '#059669'];
    const noColors = ['#fca5a5', '#f87171', '#ef4444', '#dc2626'];
    const yesByConf = [0, 0, 0, 0], noByConf = [0, 0, 0, 0];
    (results?.evaluators || []).forEach(e => {
      const conf = Math.min(4, Math.max(1, e.confidence || 1)) - 1;
      if (e.answer === 0) yesByConf[conf]++; else noByConf[conf]++;
    });
    const yesTotal = yesByConf.reduce((a, b) => a + b, 0);
    const noTotal = noByConf.reduce((a, b) => a + b, 0);
    const maxCount = Math.max(yesTotal, noTotal);
    allRows.push({ label: 'Yes', pct: Math.round((yesTotal / total) * 100), byConf: yesByConf, colors: yesColors, isUser: userAnswer === 0, maxCount });
    allRows.push({ label: 'No', pct: Math.round((noTotal / total) * 100), byConf: noByConf, colors: noColors, isUser: userAnswer === 1, maxCount });
  } else {
    const optionData = {};
    (results?.evaluators || []).forEach(e => {
      if (!optionData[e.answer]) optionData[e.answer] = { total: 0, byConf: [0, 0, 0, 0] };
      optionData[e.answer].total++;
      const conf = Math.min(4, Math.max(1, e.confidence || 1)) - 1;
      optionData[e.answer].byConf[conf]++;
    });
    const maxCount = Math.max(...Object.values(optionData).map(d => d.total), 1);
    question.options?.forEach((opt, idx) => {
      const data = optionData[idx] || { total: 0, byConf: [0, 0, 0, 0] };
      const pct = Math.round((data.total / total) * 100);
      const colors = MC_COLORS[idx % MC_COLORS.length].shades;
      allRows.push({ label: opt, pct, byConf: data.byConf, colors, isUser: userAnswer === idx, maxCount });
    });
  }
  allRows.sort((a, b) => b.pct - a.pct);

  // Render confidence bar - same as expanded view
  const renderBar = (byConf, colors, maxCount, isUser) => {
    const totalCount = byConf.reduce((a, b) => a + b, 0);
    if (totalCount === 0) return <div className="flex-1 h-5 rounded-full" style={{ border: `1px solid ${colors[0]}40` }} />;
    const segments = [];
    for (let i = 0; i <= 3; i++) {
      if (byConf[i] > 0) segments.push({ width: (byConf[i] / maxCount) * 100, color: colors[i], conf: i });
    }
    segments.reverse();
    const totalWidth = segments.reduce((a, s) => a + s.width, 0);
    const showEmpty = (100 - totalWidth) > 2;
    return (
      <div className="flex-1 h-5 rounded-full overflow-hidden flex" style={{ border: showEmpty ? `1px solid ${colors[0]}40` : 'none' }}>
        {segments.map((s, i) => {
          const isUserSeg = isUser && s.conf === userConf;
          const isLast = i === segments.length - 1;
          const isFirst = i === 0;
          return (
            <div key={i} className={`h-full ${isLast ? 'rounded-r-full' : ''} ${isFirst ? 'rounded-l-full' : ''}`} style={{
              width: showEmpty ? `${s.width}%` : (isLast ? undefined : `${s.width}%`),
              flex: !showEmpty && isLast ? 1 : undefined,
              backgroundColor: s.color,
              ...(isUserSeg ? { border: '3px solid white', borderRadius: isFirst && isLast ? '999px' : isFirst ? '999px 0 0 999px' : isLast ? '0 999px 999px 0' : '0', zIndex: 10, position: 'relative' } : {})
            }} />
          );
        })}
      </div>
    );
  };

  return (
    <div className="fixed inset-0 z-50 flex items-end justify-center bg-black/60" onClick={onClose}>
      <div
        className={`w-full max-w-md rounded-t-2xl ${darkMode ? 'bg-gray-900' : 'bg-white'}`}
        style={{ animation: 'slideUp 0.2s ease-out' }}
        onTouchStart={handleTouchStart}
        onTouchEnd={handleTouchEnd}
        onClick={onClose}
      >
        {/* Header - matches expanded style */}
        <div className="flex items-center gap-2 px-4 pt-3 pb-1">
          <span className={`text-sm font-black uppercase tracking-wide ${darkMode ? 'text-sky-300' : 'text-sky-500'}`}>LAST:</span>
          <span className={`text-base truncate flex-1 font-medium ${darkMode ? 'text-gray-100' : 'text-gray-900'}`}>{question.text}</span>
          <span className={`text-sm ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>{total}</span>
        </div>

        {/* All rows - same format as expanded */}
        <div className="px-4 pb-4 pt-2 space-y-1">
          {allRows.map((row, i) => (
            <div key={i} className="flex items-center gap-1">
              <div className={isBinary ? 'w-14 sm:w-12' : 'w-[40%]'} style={{ flexShrink: 0 }}>
                <span className="text-base sm:text-sm font-semibold inline-block truncate max-w-full px-1.5 py-0.5 rounded-full border"
                  style={{ color: row.colors[1], borderColor: row.isUser ? row.colors[1] : 'transparent' }}>
                  {row.label}
                </span>
              </div>
              <span className="text-base sm:text-sm w-8 sm:w-7 font-bold text-right" style={{ color: row.colors[1] }}>{row.pct}</span>
              {renderBar(row.byConf, row.colors, row.maxCount, row.isUser)}
            </div>
          ))}
        </div>

        {/* Tap hint */}
        <div className={`text-sm text-center pb-4 ${darkMode ? 'text-gray-600' : 'text-gray-400'}`}>
          tap anywhere to close
        </div>
      </div>
    </div>
  );
};

// Shared BottomSheet Component
const BottomSheet = ({ onClose, darkMode, children }) => (
  <div className="fixed inset-0 bg-black/70 flex items-end justify-center z-50 pb-8" onClick={onClose}>
    <div
      className={`rounded-xl p-4 w-[calc(100%-2rem)] max-w-xs ${
        darkMode ? 'bg-gray-900' : 'bg-white shadow-xl border border-gray-200'
      }`}
      onClick={e => e.stopPropagation()}
    >
      {children}
    </div>
  </div>
);

// Shared OptionChip Component
const OptionChip = ({ label, selected, onClick, darkMode, accentColor = 'violet' }) => {
  const baseClass = darkMode ? 'bg-gray-800 text-gray-400 hover:bg-gray-700' : 'bg-gray-200 text-gray-600 hover:bg-gray-300';
  const selectedClass = {
    violet: 'bg-violet-600 text-white',
    rose: 'bg-rose-500 text-white',
    amber: 'bg-amber-500 text-white',
  }[accentColor] || 'bg-violet-600 text-white';

  return (
    <button
      onClick={onClick}
      className={`px-2.5 py-1 rounded-lg text-xs transition-colors ${selected ? selectedClass : baseClass}`}
    >
      {label}
    </button>
  );
};

// Question Flag Modal
const QUESTION_FLAG_REASONS = ['Unclear', 'Biased', 'Duplicate', 'Wrong'];
const QuestionFlagModal = ({ questionId, onClose, onFlag, onClear, existingFlag, darkMode = true }) => {
  const [selected, setSelected] = React.useState(
    existingFlag ? existingFlag.split(', ').filter(r => QUESTION_FLAG_REASONS.includes(r)) : []
  );
  const [other, setOther] = React.useState(
    existingFlag ? existingFlag.split(', ').filter(r => !QUESTION_FLAG_REASONS.includes(r)).join(', ') : ''
  );
  const toggle = (r) => setSelected(prev => prev.includes(r) ? prev.filter(x => x !== r) : [...prev, r]);
  const canSubmit = selected.length > 0 || other.trim();
  const handleSubmit = () => { onFlag(questionId, [...selected, other.trim()].filter(Boolean).join(', ')); onClose(); };

  return (
    <BottomSheet onClose={onClose} darkMode={darkMode}>
      <div className="flex items-center gap-2 mb-3">
        <span className="text-rose-400">âš‘</span>
        <span className={`text-sm font-medium ${darkMode ? 'text-white' : 'text-gray-900'}`}>Flag question</span>
      </div>
      <div className="flex gap-1.5 mb-3 flex-wrap">
        {QUESTION_FLAG_REASONS.map(r => (
          <OptionChip key={r} label={r} selected={selected.includes(r)} onClick={() => toggle(r)} darkMode={darkMode} accentColor="rose" />
        ))}
      </div>
      <input type="text" value={other} onChange={(e) => setOther(e.target.value)} placeholder="Other..."
        className={`w-full px-3 py-2 rounded-lg text-sm mb-3 ${darkMode ? 'bg-gray-800 text-white placeholder-gray-500' : 'bg-gray-100 text-gray-900 placeholder-gray-400'} border ${darkMode ? 'border-gray-700' : 'border-gray-300'} focus:outline-none focus:border-rose-500`}
      />
      <div className="flex gap-2">
        <button onClick={onClose} className={`py-2 px-4 rounded-lg text-sm ${darkMode ? 'bg-gray-800/50 text-gray-400 hover:bg-gray-700/50' : 'bg-gray-200 text-gray-600 hover:bg-gray-300'}`}>Cancel</button>
        {existingFlag && <button onClick={() => { onClear(questionId); onClose(); }} className={`py-2 px-4 rounded-lg text-sm ${darkMode ? 'bg-gray-800 text-gray-300 hover:bg-gray-700' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}>Clear</button>}
        <button onClick={handleSubmit} disabled={!canSubmit} className={`flex-1 py-2 rounded-lg text-sm font-medium transition-colors ${canSubmit ? 'bg-rose-500 hover:bg-rose-400 text-white' : darkMode ? 'bg-gray-800 text-gray-600 cursor-not-allowed' : 'bg-gray-200 text-gray-400 cursor-not-allowed'}`}>
          {existingFlag ? 'Update' : 'Flag'}
        </button>
      </div>
    </BottomSheet>
  );
};

// Explanation Modal - multi-select with optional custom input
const EXPLANATION_REASONS = ['Gut feel', 'Research', 'Experience', 'Logic'];
const ExplanationModal = ({ questionId, onClose, onSave, onClear, existingExplanation, darkMode = true }) => {
  const [selected, setSelected] = React.useState(
    existingExplanation ? existingExplanation.split(', ').filter(r => EXPLANATION_REASONS.includes(r)) : []
  );
  const [other, setOther] = React.useState(
    existingExplanation ? existingExplanation.split(', ').filter(r => !EXPLANATION_REASONS.includes(r)).join(', ') : ''
  );
  const toggle = (r) => setSelected(prev => prev.includes(r) ? prev.filter(x => x !== r) : [...prev, r]);
  const canSubmit = selected.length > 0 || other.trim();
  const handleSubmit = () => { onSave(questionId, [...selected, other.trim()].filter(Boolean).join(', ')); onClose(); };

  return (
    <BottomSheet onClose={onClose} darkMode={darkMode}>
      <div className={`text-sm font-medium mb-3 ${darkMode ? 'text-white' : 'text-gray-900'}`}>Why this answer?</div>
      <div className="space-y-2 mb-3">
        {EXPLANATION_REASONS.map(r => (
          <button key={r} onClick={() => toggle(r)}
            className={`w-full text-left px-3 py-2 rounded-lg text-sm transition-colors ${
              selected.includes(r)
                ? 'bg-amber-500 text-white'
                : darkMode ? 'bg-gray-800 text-gray-300 hover:bg-gray-700' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
            }`}
          >{r}</button>
        ))}
      </div>
      <input type="text" value={other} onChange={(e) => setOther(e.target.value)} placeholder="Other reason..."
        className={`w-full px-3 py-2 rounded-lg text-sm mb-3 ${darkMode ? 'bg-gray-800 text-white placeholder-gray-500' : 'bg-gray-100 text-gray-900 placeholder-gray-400'} border ${darkMode ? 'border-gray-700' : 'border-gray-300'} focus:outline-none focus:border-amber-500`}
      />
      <div className="flex gap-2">
        <button onClick={onClose} className={`flex-1 py-2 rounded-lg text-sm ${darkMode ? 'bg-gray-800 text-gray-400' : 'bg-gray-200 text-gray-600'}`}>Cancel</button>
        {existingExplanation && <button onClick={() => { onClear(questionId); onClose(); }} className={`flex-1 py-2 rounded-lg text-sm ${darkMode ? 'bg-gray-800 text-gray-300 hover:bg-gray-700' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}>Clear</button>}
        <button onClick={handleSubmit} disabled={!canSubmit} className={`flex-1 py-2 rounded-lg text-sm font-medium transition-colors ${canSubmit ? 'bg-amber-500 text-white' : darkMode ? 'bg-gray-800 text-gray-600' : 'bg-gray-200 text-gray-400'}`}>
          {existingExplanation ? 'Update' : 'Save'}
        </button>
      </div>
    </BottomSheet>
  );
};

// Can't Answer Modal - multi-select with optional custom input
const CANT_ANSWER_REASONS = ['Need more context', 'Question unclear', 'Conflict of interest', 'Not my area'];
const CantAnswerModal = ({ questionId, onClose, onSkip, darkMode = true }) => {
  const [selected, setSelected] = React.useState([]);
  const [other, setOther] = React.useState('');
  const toggle = (r) => setSelected(prev => prev.includes(r) ? prev.filter(x => x !== r) : [...prev, r]);
  const canSubmit = selected.length > 0 || other.trim();
  const handleSubmit = () => { onSkip(questionId, [...selected, other.trim()].filter(Boolean).join(', ')); onClose(); };

  return (
    <BottomSheet onClose={onClose} darkMode={darkMode}>
      <div className={`text-sm font-medium mb-3 ${darkMode ? 'text-white' : 'text-gray-900'}`}>Can't answer this question</div>
      <div className="space-y-2 mb-3">
        {CANT_ANSWER_REASONS.map(r => (
          <button key={r} onClick={() => toggle(r)}
            className={`w-full text-left px-3 py-2 rounded-lg text-sm transition-colors ${
              selected.includes(r)
                ? 'bg-violet-600 text-white'
                : darkMode ? 'bg-gray-800 text-gray-300 hover:bg-gray-700' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
            }`}
          >{r}</button>
        ))}
      </div>
      <input type="text" value={other} onChange={(e) => setOther(e.target.value)} placeholder="Other reason..."
        className={`w-full px-3 py-2 rounded-lg text-sm mb-3 ${darkMode ? 'bg-gray-800 text-white placeholder-gray-500' : 'bg-gray-100 text-gray-900 placeholder-gray-400'} border ${darkMode ? 'border-gray-700' : 'border-gray-300'} focus:outline-none focus:border-violet-500`}
      />
      <div className="flex gap-2">
        <button onClick={onClose} className={`flex-1 py-2 rounded-lg text-sm ${darkMode ? 'bg-gray-800 text-gray-400' : 'bg-gray-200 text-gray-600'}`}>Cancel</button>
        <button onClick={handleSubmit} disabled={!canSubmit} className={`flex-1 py-2 rounded-lg text-sm font-medium ${canSubmit ? 'bg-violet-600 text-white' : darkMode ? 'bg-gray-800 text-gray-600' : 'bg-gray-200 text-gray-400'}`}>Skip Question</button>
      </div>
    </BottomSheet>
  );
};

// None Option Modal - for MC questions
const NoneOptionModal = ({ questionId, onClose, onSubmit, darkMode = true }) => {
  const [customAnswer, setCustomAnswer] = React.useState('');
  const canSubmit = customAnswer.trim();
  const handleSubmit = () => { onSubmit(questionId, customAnswer.trim()); onClose(); };

  return (
    <div className="fixed inset-0 bg-black/70 flex items-end justify-center z-50 pb-8" onClick={onClose}>
      <div className={`rounded-xl p-4 w-[calc(100%-2rem)] max-w-xs ${darkMode ? 'bg-gray-900' : 'bg-white border border-gray-200'}`} onClick={e => e.stopPropagation()}>
        <div className={`text-sm font-medium mb-2 ${darkMode ? 'text-white' : 'text-gray-900'}`}>None of these options fit</div>
        <div className={`text-sm mb-3 ${darkMode ? 'text-gray-500' : 'text-gray-600'}`}>What would you answer instead?</div>
        <textarea value={customAnswer} onChange={(e) => setCustomAnswer(e.target.value)} placeholder="Your answer..."
          className={`w-full px-3 py-2 rounded-lg text-sm mb-3 h-20 resize-none ${darkMode ? 'bg-gray-800 text-white border-gray-700' : 'bg-gray-100 text-gray-900'} border focus:outline-none focus:border-violet-500`}
        />
        <div className="flex gap-2">
          <button onClick={onClose} className={`flex-1 py-2 rounded-lg text-sm ${darkMode ? 'bg-gray-800 text-gray-400' : 'bg-gray-200 text-gray-600'}`}>Cancel</button>
          <button onClick={handleSubmit} disabled={!canSubmit} className={`flex-1 py-2 rounded-lg text-sm font-medium ${canSubmit ? 'bg-violet-600 text-white' : darkMode ? 'bg-gray-800 text-gray-600' : 'bg-gray-200 text-gray-400'}`}>Submit</button>
        </div>
      </div>
    </div>
  );
};

// Answered Question View - shows expanded results (no change answer - locked after undo)
const AnsweredQuestionView = ({ question, response, results, darkMode, questionFlag, explanation, onFlagClick, onExplainClick }) => {
  const isBinary = question.type === 'binary';
  const category = CATEGORIES.find(c => c.id === question.category);
  const categoryColors = {
    prediction: darkMode ? 'bg-amber-900/30 text-amber-400' : 'bg-amber-100 text-amber-700',
    reasoning: darkMode ? 'bg-violet-900/30 text-violet-400' : 'bg-violet-100 text-violet-700',
    judgment: darkMode ? 'bg-teal-900/30 text-teal-400' : 'bg-teal-100 text-teal-700',
  };

  return (
    <div className="flex-1 flex flex-col overflow-y-auto px-4 py-3">
      {/* Category badge */}
      {category && (
        <div className="flex justify-center mb-2">
          <span className={`px-2 py-0.5 rounded-full text-sm font-medium ${categoryColors[question.category]}`}>
            {category.icon} {category.name}
          </span>
        </div>
      )}

      {/* Question with flag button */}
      <div className="flex items-start gap-2 mb-4">
        <h2 className={`question-text text-center font-medium flex-1 ${darkMode ? 'text-white' : 'text-gray-900'}`}>
          {question.text}
        </h2>
        <button
          onClick={onFlagClick}
          className={`text-sm flex-shrink-0 ${questionFlag ? 'text-rose-400' : (darkMode ? 'text-gray-600 hover:text-gray-400' : 'text-gray-400 hover:text-gray-600')}`}
        >
          âš‘
        </button>
      </div>

      {/* Your answer summary with explain button */}
      <div className={`p-3 rounded-lg mb-4 ${darkMode ? 'bg-gray-900/50' : 'bg-gray-100'}`}>
        <div className="flex items-center justify-center gap-2">
          <div className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
            Your answer: <span className={`font-bold ${
              isBinary
                ? (response.answer === 0 ? (darkMode ? 'text-emerald-400' : 'text-emerald-600') : (darkMode ? 'text-rose-400' : 'text-rose-600'))
                : ''
            }`} style={!isBinary ? { color: MC_COLORS[response.answer % MC_COLORS.length].hex } : undefined}>
              {isBinary ? (response.answer === 0 ? 'Yes' : 'No') : question.options?.[response.answer]}
            </span> Â· {CONFIDENCE_LABELS[response.confidence]}
          </div>
          <button
            onClick={onExplainClick}
            className={`text-sm ${explanation ? 'text-amber-400' : (darkMode ? 'text-gray-600 hover:text-amber-400' : 'text-gray-400 hover:text-amber-500')}`}
            title={explanation ? 'Edit note' : 'Add note'}
          >
            âœŽ
          </button>
        </div>
        {explanation && (
          <div className={`text-sm text-center mt-1 ${darkMode ? 'text-amber-400/70' : 'text-amber-600'}`}>
            {explanation}
          </div>
        )}
      </div>

      {/* Community Results - expanded - same style as FullResultsPanel */}
      {(() => {
        const total = results?.evaluators?.length || 1;
        const userAnswer = response?.answer;
        const userConf = response ? Math.min(4, Math.max(1, response.confidence || 1)) - 1 : -1;

        // Build rows data - same logic as FullResultsPanel
        const allRows = [];
        if (isBinary) {
          const yesColors = ['#6ee7b7', '#34d399', '#10b981', '#059669'];
          const noColors = ['#fca5a5', '#f87171', '#ef4444', '#dc2626'];
          const yesByConf = [0, 0, 0, 0], noByConf = [0, 0, 0, 0];
          (results?.evaluators || []).forEach(e => {
            const conf = Math.min(4, Math.max(1, e.confidence || 1)) - 1;
            if (e.answer === 0) yesByConf[conf]++; else noByConf[conf]++;
          });
          const yesTotal = yesByConf.reduce((a, b) => a + b, 0);
          const noTotal = noByConf.reduce((a, b) => a + b, 0);
          const maxCount = Math.max(yesTotal, noTotal);
          allRows.push({ label: 'Yes', pct: Math.round((yesTotal / total) * 100), byConf: yesByConf, colors: yesColors, isUser: userAnswer === 0, maxCount });
          allRows.push({ label: 'No', pct: Math.round((noTotal / total) * 100), byConf: noByConf, colors: noColors, isUser: userAnswer === 1, maxCount });
        } else {
          const optionData = {};
          (results?.evaluators || []).forEach(e => {
            if (!optionData[e.answer]) optionData[e.answer] = { total: 0, byConf: [0, 0, 0, 0] };
            optionData[e.answer].total++;
            const conf = Math.min(4, Math.max(1, e.confidence || 1)) - 1;
            optionData[e.answer].byConf[conf]++;
          });
          const maxCount = Math.max(...Object.values(optionData).map(d => d.total), 1);
          question.options?.forEach((opt, idx) => {
            const data = optionData[idx] || { total: 0, byConf: [0, 0, 0, 0] };
            const pct = Math.round((data.total / total) * 100);
            const colors = MC_COLORS[idx % MC_COLORS.length].shades;
            allRows.push({ label: opt, pct, byConf: data.byConf, colors, isUser: userAnswer === idx, maxCount });
          });
        }
        allRows.sort((a, b) => b.pct - a.pct);

        // Render confidence bar - same as FullResultsPanel
        const renderBar = (byConf, colors, maxCount, isUser) => {
          const totalCount = byConf.reduce((a, b) => a + b, 0);
          if (totalCount === 0) return <div className="flex-1 h-5 rounded-full" style={{ border: `1px solid ${colors[0]}40` }} />;
          const segments = [];
          for (let i = 0; i <= 3; i++) {
            if (byConf[i] > 0) segments.push({ width: (byConf[i] / maxCount) * 100, color: colors[i], conf: i });
          }
          segments.reverse();
          const totalWidth = segments.reduce((a, s) => a + s.width, 0);
          const showEmpty = (100 - totalWidth) > 2;
          return (
            <div className="flex-1 h-5 rounded-full overflow-hidden flex" style={{ border: showEmpty ? `1px solid ${colors[0]}40` : 'none' }}>
              {segments.map((s, i) => {
                const isUserSeg = isUser && s.conf === userConf;
                const isLast = i === segments.length - 1;
                const isFirst = i === 0;
                return (
                  <div key={i} className={`h-full ${isLast ? 'rounded-r-full' : ''} ${isFirst ? 'rounded-l-full' : ''}`} style={{
                    width: showEmpty ? `${s.width}%` : (isLast ? undefined : `${s.width}%`),
                    flex: !showEmpty && isLast ? 1 : undefined,
                    backgroundColor: s.color,
                    ...(isUserSeg ? { border: '3px solid white', borderRadius: isFirst && isLast ? '999px' : isFirst ? '999px 0 0 999px' : isLast ? '0 999px 999px 0' : '0', zIndex: 10, position: 'relative' } : {})
                  }} />
                );
              })}
            </div>
          );
        };

        return (
          <div className={`rounded-lg p-3 ${darkMode ? 'bg-gray-900 shine-card shine-gray' : 'bg-white border border-gray-200'}`}>
            {/* Header - matches FullResultsPanel style */}
            <div className="flex items-center gap-2 mb-2">
              <span className={`text-sm font-black uppercase tracking-wide ${darkMode ? 'text-sky-300' : 'text-sky-500'}`}>LAST:</span>
              <span className={`text-sm truncate flex-1 font-medium ${darkMode ? 'text-gray-100' : 'text-gray-900'}`}>{question.text}</span>
              <span className={`text-xs ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>{total}</span>
            </div>

            {/* All rows - same format as FullResultsPanel */}
            <div className="space-y-1">
              {allRows.map((row, i) => (
                <div key={i} className="flex items-center gap-1">
                  <div className={isBinary ? 'w-14 sm:w-12' : 'w-[40%]'} style={{ flexShrink: 0 }}>
                    <span className="text-base sm:text-sm font-semibold inline-block truncate max-w-full px-1.5 py-0.5 rounded-full border"
                      style={{ color: row.colors[1], borderColor: row.isUser ? row.colors[1] : 'transparent' }}>
                      {row.label}
                    </span>
                  </div>
                  <span className="text-base sm:text-sm w-8 sm:w-7 font-bold text-right" style={{ color: row.colors[1] }}>{row.pct}</span>
                  {renderBar(row.byConf, row.colors, row.maxCount, row.isUser)}
                </div>
              ))}
            </div>

            <div className={`text-sm text-center mt-2 ${darkMode ? 'text-gray-600' : 'text-gray-400'}`}>
              {results?.evaluators?.length || 0} responses Â· Demo data
            </div>
          </div>
        );
      })()}

      {/* Swipe hint */}
      <div className={`text-center mt-4 text-sm ${darkMode ? 'text-gray-600' : 'text-gray-400'}`}>
        Swipe for next â†’
      </div>
    </div>
  );
};

// Category Selection Screen - a5 mockup design
const CategoryScreen = ({ darkMode, categories, questions, responses, onSelectCategory, onSettings, stats, qotdData, qotdResponse, onQotdClick, onResetQotd }) => {
  const getProgress = (categoryId) => {
    const catQuestions = categoryId === 'random' ? questions : questions.filter(q => q.category === categoryId);
    const binaryQ = catQuestions.filter(q => q.type === 'binary');
    const mcQ = catQuestions.filter(q => q.type === 'multiple');
    const binaryUnanswered = binaryQ.filter(q => !responses[q.id]).length;
    const mcUnanswered = mcQ.filter(q => !responses[q.id]).length;
    return { binaryUnanswered, mcUnanswered, total: catQuestions.length };
  };

  const handleCategoryClick = (categoryId) => {
    const progress = getProgress(categoryId);
    const track = progress.binaryUnanswered > 0 ? 'binary' : 'multiple';
    onSelectCategory(categoryId, track);
  };

  const totalAnswered = Object.keys(responses).length;
  const hasAnsweredQotd = qotdResponse !== null;

  // Category display config matching a5 mockup
  const categoryConfig = {
    prediction: { icon: 'â˜€ï¸', name: 'Predict', tagline: 'What will happen?', featured: true },
    reasoning: { icon: 'ðŸ§ ', name: 'Think', tagline: 'Logic puzzles & analysis', featured: false },
    judgment: { icon: 'âš–ï¸', name: 'Judge', tagline: 'Ethics & opinions', featured: false },
  };

  return (
    <div className={`flex-1 flex flex-col ${darkMode ? 'bg-gray-950' : 'bg-gray-50'}`}>
      {/* Header - a5 style */}
      <div className="flex items-center justify-between px-5 pt-4 pb-2">
        <span className="text-3xl cursor-pointer select-none" onDoubleClick={onResetQotd}>ðŸŒ€</span>
        <div className="flex items-center gap-3">
          <span className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
            {totalAnswered} answered {stats.streak > 0 && <span className="text-orange-400">ðŸ”¥{stats.streak}</span>}
          </span>
          <button onClick={onSettings} className={darkMode ? 'text-gray-500' : 'text-gray-400'}>
            <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="1.5" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="1.5" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
          </button>
        </div>
      </div>

      {/* Scrollable content */}
      <div className="flex-1 overflow-y-auto px-5 pt-2 pb-4 space-y-5">
        {/* QOD Card - a5 style with shine */}
        {qotdData && (
          <button
            onClick={onQotdClick}
            className={`w-full p-4 rounded-2xl text-center transition-colors shine-card shine-blue glow-blue ${
              darkMode
                ? 'bg-gradient-to-br from-blue-900/60 to-blue-950/80 border border-blue-500/40 hover:border-blue-400/80 active:border-blue-300'
                : 'bg-gradient-to-br from-blue-100 to-blue-50 border border-blue-200 hover:border-blue-300'
            }`}
          >
            <div className={`font-medium text-sm mb-2 ${darkMode ? 'text-blue-400' : 'text-blue-600'}`}>
              ðŸŒ€ Question of the Day
            </div>
            <p className={`text-lg font-semibold leading-snug ${darkMode ? 'text-white' : 'text-gray-900'}`}>
              {qotdData.text}
            </p>
            {!hasAnsweredQotd && (
              <div className={`text-sm mt-2 ${darkMode ? 'text-blue-400/70' : 'text-blue-500'}`}>
                Tap to answer â†’
              </div>
            )}
          </button>
        )}

        {/* Welcome heading */}
        <h1 className={`text-3xl font-bold text-center ${darkMode ? 'text-white' : 'text-gray-900'}`}>
          What's on your mind?
        </h1>

        {/* Category Cards - a5 style */}
        <div className="space-y-4">
          {categories.map(cat => {
            const config = categoryConfig[cat.id];
            if (!config) return null;
            const progress = getProgress(cat.id);
            const available = progress.binaryUnanswered + progress.mcUnanswered;
            const isFeatured = config.featured;
            const shineClass = cat.color === 'amber' ? 'shine-amber' : cat.color === 'violet' ? 'shine-violet' : 'shine-teal';
            const glowClass = cat.color === 'amber' ? 'glow-amber' : cat.color === 'violet' ? 'glow-violet' : 'glow-teal';
            const borderColor = cat.color === 'amber'
              ? 'border-amber-500/40 hover:border-amber-400/90 active:border-amber-300'
              : cat.color === 'violet'
                ? 'border-violet-500/40 hover:border-violet-400/80 active:border-violet-300'
                : 'border-teal-500/40 hover:border-teal-400/80 active:border-teal-300';
            const bgGradient = cat.color === 'violet'
              ? 'bg-gradient-to-r from-violet-900/30 to-violet-950/50'
              : '';
            const bgStyle = cat.color === 'teal' && !isFeatured
              ? { background: 'linear-gradient(to right, rgba(6, 78, 59, 0.7), rgba(2, 44, 34, 0.85))' }
              : {};
            const textColor = cat.color === 'amber' ? 'text-amber-400/80' : cat.color === 'violet' ? 'text-violet-400/80' : 'text-teal-400/80';

            return (
              <button
                key={cat.id}
                onClick={() => handleCategoryClick(cat.id)}
                disabled={available === 0}
                className={`w-full ${isFeatured ? 'py-5 px-5' : 'py-4 px-5'} rounded-2xl text-left transition-colors shine-card ${shineClass} ${glowClass} border ${borderColor} ${isFeatured ? 'starry-bg overflow-hidden' : bgGradient} ${available === 0 ? 'opacity-40' : ''}`}
                style={bgStyle}
              >
                <div className={`flex items-center gap-4 ${isFeatured ? 'relative z-10' : ''}`}>
                  <span className={isFeatured ? 'text-3xl' : 'text-2xl'}>{config.icon}</span>
                  <div>
                    <div className={`${isFeatured ? 'text-xl' : 'text-lg'} font-semibold ${darkMode ? 'text-white' : 'text-gray-900'}`}>{config.name}</div>
                    <div className={`text-sm ${darkMode ? textColor : 'text-gray-500'}`}>{config.tagline}</div>
                  </div>
                </div>
              </button>
            );
          })}

          {/* Surprise me - a5 style */}
          {(() => {
            const progress = getProgress('random');
            const available = progress.binaryUnanswered + progress.mcUnanswered;
            return (
              <button
                onClick={() => handleCategoryClick('random')}
                disabled={available === 0}
                className={`w-full py-4 px-5 rounded-2xl text-left transition-colors shine-card shine-gray border-2 border-slate-400/60 hover:border-slate-300/80 active:border-slate-200 bg-gradient-to-r from-slate-700/50 to-slate-800/60 ${available === 0 ? 'opacity-40' : ''}`}
                style={{ boxShadow: '0 0 25px rgba(148, 163, 184, 0.25), 0 0 10px rgba(203, 213, 225, 0.2), inset 0 1px 0 rgba(255,255,255,0.15)' }}
              >
                <div className="flex items-center gap-4">
                  <span className="text-2xl">âœ¨</span>
                  <div>
                    <div className={`text-lg font-semibold ${darkMode ? 'text-white' : 'text-gray-900'}`}>Surprise me</div>
                    <div className={`text-sm ${darkMode ? 'text-slate-400' : 'text-gray-500'}`}>Explore something unexpected</div>
                  </div>
                </div>
              </button>
            );
          })()}
        </div>
      </div>
    </div>
  );
};

// UndoBar - selected answer bubble sweeps across its row, styled like actual buttons
const UndoBar = ({ darkMode, undoDelay, onUndo, answer, confidence, isBinary, options, fullHeight, requireConfirmation = true }) => {
  const answerText = isBinary
    ? (answer === 0 ? 'YES' : 'NO')
    : `${String.fromCharCode(65 + answer)}. ${options?.[answer] || ''}`;

  // Get the exact button gradient colors based on confidence
  const conf = Math.min(confidence, 4);
  let bgGradient;
  if (isBinary) {
    const yesShades = darkMode
      ? [['#065f46', '#059669'], ['#047857', '#10b981'], ['#059669', '#34d399'], ['#10b981', '#6ee7b7']]
      : [['#a7f3d0', '#6ee7b7'], ['#6ee7b7', '#34d399'], ['#34d399', '#10b981'], ['#10b981', '#059669']];
    const noShades = darkMode
      ? [['#9f1239', '#e11d48'], ['#be123c', '#f43f5e'], ['#e11d48', '#fb7185'], ['#f43f5e', '#fda4af']]
      : [['#fecdd3', '#fda4af'], ['#fda4af', '#fb7185'], ['#fb7185', '#f43f5e'], ['#f43f5e', '#e11d48']];
    const shades = answer === 0 ? yesShades : noShades;
    const s = shades[conf - 1];
    bgGradient = `linear-gradient(135deg, ${s[0]} 0%, ${s[1]} 100%)`;
  } else {
    const color = MC_COLORS[answer % MC_COLORS.length];
    bgGradient = `linear-gradient(135deg, ${color.shades[conf - 1]} 0%, ${color.shades[Math.min(conf, 3)]} 100%)`;
  }

  // Button dimensions accounting for checkmark slots
  // MC: px-4 (16px), with confirmation: gap-1.5 (6px) + checkmark w-9 (36px) = 42px extra on right
  // Y/N: px-4 (16px), outer gap-1.5 (6px) splits halves, each half has button + gap-1.5 + checkmark
  // Y/N with confirmation: button ends 45px before center (3px half-gap + 6px inner gap + 36px checkmark)

  return (
    <div
      onClick={onUndo}
      className={`relative cursor-pointer active:opacity-80 overflow-hidden ${fullHeight ? 'h-full' : 'rounded-xl'}`}
    >
      {/* Light backdrop */}
      <div className={`h-full ${darkMode ? 'bg-gray-900/40' : 'bg-white/40'}`}>
        {/* Selected answer bubble positioned exactly over its button */}
        <div
          className={`absolute overflow-hidden ${isBinary ? 'rounded-xl' : 'rounded-lg'}`}
          style={isBinary ? (requireConfirmation ? {
            // Y/N with confirmation: YES | gap-2 (8px) | submit(44px) | gap-2 (8px) | NO
            top: '12px',
            height: '57px',
            left: answer === 0 ? '16px' : 'calc(50% + 30px)',
            right: answer === 0 ? 'calc(50% + 30px)' : '16px',
          } : {
            // Y/N without confirmation: grid-cols-2 gap-2
            top: '12px',
            height: '57px',
            left: answer === 0 ? '16px' : 'calc(50% + 4px)',
            right: answer === 0 ? 'calc(50% + 4px)' : '16px',
          }) : {
            // MC buttons: wrapper extends 16px past each side (-left-4 -right-4)
            // Need to add 16px to both left and right to compensate
            // Base: 16px (px-4 padding) + 16px (wrapper offset) = 32px
            // Right with checkmark: 32px + 42px (6px gap + 36px checkmark) = 74px
            left: '32px',
            right: requireConfirmation ? '74px' : '32px',
            top: `${12 + answer * 44}px`,
            height: '40px',
          }}
        >
          {/* Button styled exactly like the real answer buttons */}
          <div
            className={`relative h-full flex items-center overflow-hidden ${isBinary ? 'justify-center' : 'px-3 text-base text-white'}`}
            style={{ background: bgGradient }}
          >
            {/* Sweep overlay */}
            <div
              className="absolute inset-0 bg-black/30"
              style={{ animation: `sweepFill ${undoDelay}s linear forwards` }}
            />
            {/* Answer text - match actual button styling */}
            {isBinary ? (
              <div className="relative z-10 flex items-center justify-center gap-1.5">
                <span className="text-2xl font-bold text-white">{answer === 0 ? 'YES' : 'NO'}</span>
                <span className="text-sm font-medium text-white/70">â—†{confidence}</span>
              </div>
            ) : (
              <>
                <span className="relative z-10 font-medium mr-1 opacity-60">{String.fromCharCode(65 + answer)}.</span>
                <span className="relative z-10 truncate">{options?.[answer] || ''}</span>
                <span className="absolute top-1/2 right-2 -translate-y-1/2 z-10 text-sm font-bold bg-white/30 w-5 h-5 rounded-full flex items-center justify-center">
                  {confidence}
                </span>
              </>
            )}
          </div>
        </div>
      </div>
    </div>
  );
};

// Tip Banner
const TipBanner = ({ darkMode, onDismiss }) => (
  <div
    onClick={onDismiss}
    className={`rounded-md px-3 py-1 flex items-center justify-between cursor-pointer mb-2 ${
      darkMode ? 'bg-violet-900/30 border border-violet-500/30' : 'bg-violet-100 border border-violet-300'
    }`}
  >
    <span className={`text-sm ${darkMode ? 'text-violet-300' : 'text-violet-700'}`}>
      <span className="font-medium">Tip:</span> Confident? Tap up to four times
    </span>
    <span className={`text-sm ml-2 ${darkMode ? 'text-violet-500' : 'text-violet-400'}`}>âœ•</span>
  </div>
);

// QuestionCard (compact)
const QuestionCard = ({ question, darkMode, evidenceExpanded, onToggleEvidence }) => {
  const category = CATEGORIES.find(c => c.id === question.category);
  const hasEvidence = question.preEvidence && question.preEvidence.length > 0;
  const categoryColors = {
    prediction: darkMode ? 'bg-amber-900/30 text-amber-400' : 'bg-amber-100 text-amber-700',
    reasoning: darkMode ? 'bg-violet-900/30 text-violet-400' : 'bg-violet-100 text-violet-700',
    judgment: darkMode ? 'bg-teal-900/30 text-teal-400' : 'bg-teal-100 text-teal-700',
  };
  const glowMap = { prediction: 'glow-amber', reasoning: 'glow-violet', judgment: 'glow-teal' };
  const cardGlow = darkMode && question.category ? glowMap[question.category] || '' : '';
  return (
    <div className={`space-y-2 ${cardGlow ? `p-4 rounded-2xl ${cardGlow}` : ''}`}>
      {category && (
        <div className="flex justify-center">
          <span className={`px-2 py-0.5 rounded-full text-sm font-medium ${categoryColors[question.category]}`}>{category.icon} {category.name}</span>
        </div>
      )}
      <h2 className={`question-text text-center font-medium ${darkMode ? 'text-white' : 'text-gray-900'}`}>{question.text}</h2>
      {hasEvidence && (
        <div className={`rounded-xl overflow-hidden ${darkMode ? 'bg-gradient-to-b from-gray-800/80 to-gray-900/80' : 'bg-white border border-gray-200 shadow-sm'}`}>
          <button
            onClick={onToggleEvidence}
            className={`w-full px-4 py-3 flex items-center justify-between transition-colors ${
              darkMode
                ? 'hover:bg-gray-700/30'
                : 'hover:bg-gray-50'
            }`}
          >
            <span className="flex items-center gap-2">
              <span className={`w-8 h-8 rounded-lg flex items-center justify-center text-base ${
                darkMode ? 'bg-violet-500/20 text-violet-400' : 'bg-violet-100 text-violet-600'
              }`}>ðŸ“Š</span>
              <span className={`text-sm font-medium ${darkMode ? 'text-gray-200' : 'text-gray-800'}`}>
                Evidence <span className={`ml-1 ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>({question.preEvidence.length})</span>
              </span>
            </span>
            <span className={`w-6 h-6 rounded-full flex items-center justify-center text-xs transition-transform duration-200 ${
              darkMode ? 'bg-gray-700 text-gray-400' : 'bg-gray-200 text-gray-500'
            } ${evidenceExpanded ? 'rotate-180' : ''}`}>â–¼</span>
          </button>
          {evidenceExpanded && (
            <div className={`px-4 pb-4 space-y-3`}>
              {question.preEvidence.map((item, i) => (
                <div key={i} className={`rounded-lg p-3 ${darkMode ? 'bg-gray-800/60' : 'bg-gray-50'}`}>
                  {item.type === 'stat' ? (
                    <div className="flex items-center justify-between">
                      <span className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>{item.label}</span>
                      <span className={`text-sm font-semibold px-2 py-0.5 rounded ${
                        darkMode ? 'bg-emerald-500/20 text-emerald-400' : 'bg-emerald-100 text-emerald-700'
                      }`}>{item.value}</span>
                    </div>
                  ) : (
                    <div className={`flex gap-2`}>
                      <span className={`text-lg leading-none ${darkMode ? 'text-gray-600' : 'text-gray-300'}`}>"</span>
                      <span className={`text-sm italic ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>{item.text}</span>
                    </div>
                  )}
                </div>
              ))}
            </div>
          )}
        </div>
      )}
    </div>
  );
};

// Binary Answer Buttons - FIXED POSITION, no transforms
const BinaryButtons = ({ darkMode, tappedAnswer, tapCount, isAnswered, currentResponse, onTap, onRightClick, pendingSubmit, requireConfirmation, onSubmit }) => {
  // Color shades for gradient (light to dark by confidence)
  const yesShades = {
    1: darkMode ? ['#065f46', '#059669'] : ['#a7f3d0', '#6ee7b7'],
    2: darkMode ? ['#047857', '#10b981'] : ['#6ee7b7', '#34d399'],
    3: darkMode ? ['#059669', '#34d399'] : ['#34d399', '#10b981'],
    4: darkMode ? ['#10b981', '#6ee7b7'] : ['#10b981', '#059669'],
  };
  const noShades = {
    1: darkMode ? ['#9f1239', '#e11d48'] : ['#fecdd3', '#fda4af'],
    2: darkMode ? ['#be123c', '#f43f5e'] : ['#fda4af', '#fb7185'],
    3: darkMode ? ['#e11d48', '#fb7185'] : ['#fb7185', '#f43f5e'],
    4: darkMode ? ['#f43f5e', '#fda4af'] : ['#f43f5e', '#e11d48'],
  };

  const getButtonStyle = (answer) => {
    const isSelected = tappedAnswer === answer;
    const isPending = pendingSubmit?.answer === answer;
    const wasAnswered = currentResponse?.answer === answer;
    const shades = answer === 0 ? yesShades : noShades;
    const conf = isSelected ? tapCount : (currentResponse?.confidence || pendingSubmit?.confidence || 2);

    // NO TRANSFORMS - buttons stay fixed
    if (wasAnswered || isPending) {
      const s = shades[Math.min(conf, 4)];
      return { background: `linear-gradient(135deg, ${s[0]} 0%, ${s[1]} 100%)`, boxShadow: 'none', color: 'white' };
    }
    if (isSelected) {
      const s = shades[Math.min(tapCount, 4)];
      return { background: `linear-gradient(135deg, ${s[0]} 0%, ${s[1]} 100%)`, boxShadow: `0 0 ${tapCount * 8}px rgba(${answer === 0 ? '16,185,129' : '244,63,94'}, ${0.2 + tapCount * 0.15})`, color: 'white' };
    }
    if (isAnswered) {
      return { background: darkMode ? 'rgb(31,41,55)' : 'rgb(243,244,246)', boxShadow: 'none', color: darkMode ? 'rgb(107,114,128)' : 'rgb(156,163,175)' };
    }
    return {
      background: darkMode ? 'rgb(31,41,55)' : 'rgb(255,255,255)',
      boxShadow: 'none',
      color: darkMode ? 'rgb(209,213,219)' : (answer === 0 ? 'rgb(5,150,105)' : 'rgb(225,29,72)'),
      border: darkMode ? 'none' : `2px solid ${answer === 0 ? 'rgb(167,243,208)' : 'rgb(254,205,211)'}`,
    };
  };

  const showSubmit = tappedAnswer !== null && requireConfirmation && !isAnswered && !pendingSubmit;

  // Full width buttons when auto-submit (no checkmark slots needed)
  if (!requireConfirmation) {
    return (
      <div className="grid grid-cols-2 gap-2">
        {[0, 1].map(answer => (
          <button
            key={answer}
            onClick={() => !isAnswered && !pendingSubmit && onTap(answer)}
            onContextMenu={(e) => onRightClick && onRightClick(e, answer)}
            disabled={isAnswered || pendingSubmit}
            className={`relative h-[57px] rounded-xl font-bold overflow-hidden select-none ${tappedAnswer === answer ? (answer === 0 ? 'ring-2 ring-emerald-400 shine-card shine-emerald' : 'ring-2 ring-rose-400 shine-card shine-rose') : ''}`}
            style={getButtonStyle(answer)}
          >
            <ConfidenceSegments level={tapCount} color={answer === 0 ? 'emerald' : 'rose'} active={tappedAnswer === answer} darkMode={darkMode} />
            <div className="relative z-10 flex items-center justify-center h-full gap-1.5">
              <span className="text-2xl font-bold">{answer === 0 ? 'YES' : 'NO'}</span>
              {tappedAnswer === answer && <span className="text-sm font-medium opacity-70">â—†{tapCount}</span>}
            </div>
          </button>
        ))}
      </div>
    );
  }

  // With centered checkmark between buttons when confirmation required
  return (
    <div className="flex items-center gap-2">
      {/* YES button */}
      <button
        onClick={() => !isAnswered && !pendingSubmit && onTap(0)}
        onContextMenu={(e) => onRightClick && onRightClick(e, 0)}
        disabled={isAnswered || pendingSubmit}
        className={`flex-1 relative h-[57px] rounded-xl font-bold overflow-hidden select-none ${tappedAnswer === 0 ? 'ring-2 ring-emerald-400 shine-card shine-emerald' : ''}`}
        style={getButtonStyle(0)}
      >
        <ConfidenceSegments level={tapCount} color="emerald" active={tappedAnswer === 0} darkMode={darkMode} />
        <div className="relative z-10 flex items-center justify-center h-full gap-1.5">
          <span className="text-2xl font-bold">YES</span>
          {tappedAnswer === 0 && <span className="text-sm font-medium opacity-70">â—†{tapCount}</span>}
        </div>
      </button>
      {/* Centered submit button */}
      <div className="w-11 flex-shrink-0 flex items-center justify-center">
        {showSubmit && (
          <button
            onClick={() => onSubmit && onSubmit(tappedAnswer, tapCount)}
            className={`w-11 h-11 rounded-full text-white shadow-lg active:scale-95 flex items-center justify-center text-xl ${tappedAnswer === 0 ? 'bg-emerald-500' : 'bg-rose-500'}`}
          >
            âœ“
          </button>
        )}
      </div>
      {/* NO button */}
      <button
        onClick={() => !isAnswered && !pendingSubmit && onTap(1)}
        onContextMenu={(e) => onRightClick && onRightClick(e, 1)}
        disabled={isAnswered || pendingSubmit}
        className={`flex-1 relative h-[57px] rounded-xl font-bold overflow-hidden select-none ${tappedAnswer === 1 ? 'ring-2 ring-rose-400 shine-card shine-rose' : ''}`}
        style={getButtonStyle(1)}
      >
        <ConfidenceSegments level={tapCount} color="rose" active={tappedAnswer === 1} darkMode={darkMode} />
        <div className="relative z-10 flex items-center justify-center h-full gap-1.5">
          <span className="text-2xl font-bold">NO</span>
          {tappedAnswer === 1 && <span className="text-sm font-medium opacity-70">â—†{tapCount}</span>}
        </div>
      </button>
    </div>
  );
};

// Multiple Choice Buttons - vG style
const MCButtons = ({ options, darkMode, tappedAnswer, tapCount, isAnswered, currentResponse, onTap, onRightClick, pendingSubmit, requireConfirmation, onSubmit }) => {
  const getOptionStyle = (option, index) => {
    const color = MC_COLORS[index % MC_COLORS.length];
    const isSelected = tappedAnswer === index;
    const isPending = pendingSubmit?.answer === index;
    const wasAnswered = currentResponse?.answer === index;
    const conf = isSelected ? tapCount : (currentResponse?.confidence || pendingSubmit?.confidence || 2);

    // NO TRANSFORMS - buttons stay fixed
    if (wasAnswered || isPending) {
      return {
        background: `linear-gradient(135deg, ${color.shades[conf - 1]} 0%, ${color.shades[Math.min(conf, 3)]} 100%)`,
        boxShadow: 'none',
        color: 'white',
        border: '2px solid transparent',
      };
    }
    if (isSelected) {
      return {
        background: `linear-gradient(135deg, ${color.shades[tapCount - 1]} 0%, ${color.shades[Math.min(tapCount, 3)]} 100%)`,
        boxShadow: `0 0 ${tapCount * 6}px rgba(${color.rgb}, ${0.2 + tapCount * 0.12})`,
        color: 'white',
        border: `2px solid ${color.hex}`,
      };
    }
    if (isAnswered) {
      return {
        background: darkMode ? 'rgb(31,41,55)' : 'rgb(243,244,246)',
        boxShadow: 'none',
        color: darkMode ? 'rgb(107,114,128)' : 'rgb(156,163,175)',
        border: '2px solid transparent',
      };
    }
    return {
      background: darkMode ? 'rgb(31,41,55)' : 'rgb(255,255,255)',
      boxShadow: 'none',
      color: darkMode ? 'rgb(209,213,219)' : 'rgb(55,65,81)',
      border: darkMode ? '2px solid transparent' : '2px solid rgb(229,231,235)',
    };
  };

  const selectedColor = tappedAnswer !== null ? MC_COLORS[tappedAnswer % MC_COLORS.length] : null;
  const showSubmit = tappedAnswer !== null && requireConfirmation && !isAnswered && !pendingSubmit;
  const getShineClass = (index) => {
    const shineMap = ['shine-blue', 'shine-teal', 'shine-emerald', 'shine-rose', 'shine-violet'];
    return shineMap[index % shineMap.length];
  };

  return (
    <div className="space-y-1">
      {options.map((option, index) => {
        const isSelected = tappedAnswer === index;
        const style = getOptionStyle(option, index);
        return (
          <div key={option} className="flex items-center gap-1.5">
            <button
              onClick={() => !isAnswered && !pendingSubmit && onTap(index)}
              onContextMenu={(e) => onRightClick && onRightClick(e, index)}
              disabled={isAnswered || pendingSubmit}
              className={`${requireConfirmation ? 'flex-1' : 'w-full'} h-[40px] px-3 rounded-lg text-left text-base overflow-hidden relative ${isSelected ? `shine-card ${getShineClass(index)}` : ''}`}
              style={style}
            >
              <span className="font-medium mr-1 opacity-60">{String.fromCharCode(65 + index)}.</span>
              <span className="truncate">{option}</span>
              {isSelected && (
                <span className="absolute top-1/2 right-2 -translate-y-1/2 text-sm font-bold bg-white/30 w-5 h-5 rounded-full flex items-center justify-center">
                  {tapCount}
                </span>
              )}
            </button>
            {/* Checkmark slot - only when requireConfirmation is on */}
            {requireConfirmation && (
              <div className="w-9 flex-shrink-0">
                {isSelected && showSubmit && (
                  <button
                    onClick={() => onSubmit && onSubmit(tappedAnswer, tapCount)}
                    className="w-9 h-9 rounded-full text-white shadow-lg active:scale-95 flex items-center justify-center text-lg"
                    style={{ backgroundColor: selectedColor?.hex || '#8b5cf6' }}
                  >
                    âœ“
                  </button>
                )}
              </div>
            )}
          </div>
        );
      })}
    </div>
  );
};

// SettingsScreen
const SettingsScreen = ({ darkMode, setDarkMode, undoDelay, setUndoDelay, requireConfirmation, setRequireConfirmation, showTips, setShowTips, showStreak, setShowStreak, onBack, onReset, onHistory }) => (
  <div className={`flex-1 flex flex-col overflow-hidden ${darkMode ? 'bg-gray-950' : 'bg-gray-50'}`}>
    <div className={`flex items-center justify-between px-4 py-3 border-b ${darkMode ? 'border-gray-800' : 'border-gray-200'}`}>
      <button onClick={onBack} className={`text-sm ${darkMode ? 'text-violet-400' : 'text-violet-600'}`}>â† Back</button>
      <h1 className={`font-semibold ${darkMode ? 'text-white' : 'text-gray-900'}`}>Settings</h1>
      <div className="w-12" />
    </div>
    <div className="flex-1 overflow-y-auto p-4 space-y-3">
      {/* History link - Coming Soon */}
      <div className={`w-full rounded-lg p-3 ${darkMode ? 'bg-gray-900/50' : 'bg-gray-100'}`}>
        <div className="flex items-center justify-between">
          <div className={`text-sm font-medium ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>ðŸ“‹ Answer History</div>
          <span className={`text-xs px-2 py-0.5 rounded-full ${darkMode ? 'bg-gray-800 text-gray-500' : 'bg-gray-200 text-gray-500'}`}>Coming Soon</span>
        </div>
      </div>
      <div className={`rounded-lg p-3 ${darkMode ? 'bg-gray-900 shine-card shine-gray' : 'bg-white border border-gray-200'}`}>
        <div className="flex items-center justify-between">
          <div><div className={`text-sm font-medium ${darkMode ? 'text-white' : 'text-gray-900'}`}>Theme</div></div>
          <button onClick={() => setDarkMode(!darkMode)} className={`relative w-12 h-6 rounded-full transition-colors ${darkMode ? 'bg-violet-600' : 'bg-gray-200'}`}>
            <div className={`absolute top-0.5 w-5 h-5 bg-white rounded-full shadow transition-transform flex items-center justify-center text-sm ${darkMode ? 'translate-x-6' : 'translate-x-0.5'}`}>{darkMode ? 'ðŸŒ™' : 'â˜€ï¸'}</div>
          </button>
        </div>
      </div>
      <div className={`rounded-lg p-3 ${darkMode ? 'bg-gray-900 shine-card shine-gray' : 'bg-white border border-gray-200'}`}>
        <div className="flex items-center justify-between mb-2">
          <div className={`text-sm font-medium ${darkMode ? 'text-white' : 'text-gray-900'}`}>Undo Delay</div>
          <span className={`text-sm font-bold ${darkMode ? 'text-violet-400' : 'text-violet-600'}`}>{undoDelay === 0 ? 'Off' : `${undoDelay}s`}</span>
        </div>
        <input type="range" min="0" max="3" step="0.5" value={undoDelay} onChange={(e) => setUndoDelay(parseFloat(e.target.value))} className={`w-full h-1.5 rounded-lg appearance-none cursor-pointer accent-violet-500 ${darkMode ? 'bg-gray-700' : 'bg-gray-200'}`} />
      </div>
      <div className={`rounded-lg p-3 ${darkMode ? 'bg-gray-900 shine-card shine-gray' : 'bg-white border border-gray-200'}`}>
        <div className="flex items-center justify-between">
          <div><div className={`text-sm font-medium ${darkMode ? 'text-white' : 'text-gray-900'}`}>Require Submit Button</div><div className={`text-sm ${darkMode ? 'text-gray-500' : 'text-gray-500'}`}>Off = auto-submit on tap</div></div>
          <button onClick={() => setRequireConfirmation(!requireConfirmation)} className={`relative w-12 h-6 rounded-full transition-colors ${requireConfirmation ? 'bg-violet-600' : darkMode ? 'bg-gray-600' : 'bg-gray-200'}`}>
            <div className={`absolute top-0.5 w-5 h-5 bg-white rounded-full shadow transition-transform ${requireConfirmation ? 'translate-x-6' : 'translate-x-0.5'}`} />
          </button>
        </div>
      </div>
      <div className={`rounded-lg p-3 ${darkMode ? 'bg-gray-900 shine-card shine-gray' : 'bg-white border border-gray-200'}`}>
        <div className="flex items-center justify-between">
          <div><div className={`text-sm font-medium ${darkMode ? 'text-white' : 'text-gray-900'}`}>Show Tips</div><div className={`text-sm ${darkMode ? 'text-gray-500' : 'text-gray-500'}`}>Gesture hints for new users</div></div>
          <button onClick={() => setShowTips(!showTips)} className={`relative w-12 h-6 rounded-full transition-colors ${showTips ? 'bg-violet-600' : darkMode ? 'bg-gray-600' : 'bg-gray-200'}`}>
            <div className={`absolute top-0.5 w-5 h-5 bg-white rounded-full shadow transition-transform ${showTips ? 'translate-x-6' : 'translate-x-0.5'}`} />
          </button>
        </div>
      </div>
      <div className={`rounded-lg p-3 ${darkMode ? 'bg-gray-900 shine-card shine-gray' : 'bg-white border border-gray-200'}`}>
        <div className="flex items-center justify-between">
          <div><div className={`text-sm font-medium ${darkMode ? 'text-white' : 'text-gray-900'}`}>Streak Counter</div><div className={`text-sm ${darkMode ? 'text-gray-500' : 'text-gray-500'}`}>Show ðŸ”¥ during play</div></div>
          <button onClick={() => setShowStreak(!showStreak)} className={`relative w-12 h-6 rounded-full transition-colors ${showStreak ? 'bg-violet-600' : darkMode ? 'bg-gray-600' : 'bg-gray-200'}`}>
            <div className={`absolute top-0.5 w-5 h-5 bg-white rounded-full shadow transition-transform ${showStreak ? 'translate-x-6' : 'translate-x-0.5'}`} />
          </button>
        </div>
      </div>
      {/* Keyboard shortcuts */}
      <div className={`rounded-lg p-3 ${darkMode ? 'bg-gray-900/50 border border-gray-800' : 'bg-white border border-gray-200'}`}>
        <div className={`text-sm font-medium mb-2 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>Keyboard Shortcuts</div>
        <div className={`text-sm space-y-1 ${darkMode ? 'text-gray-500' : 'text-gray-600'}`}>
          <div className="flex justify-between"><span>Yes / Option A</span><span className="font-mono">Y or 1</span></div>
          <div className="flex justify-between"><span>No / Option B-E</span><span className="font-mono">N or 2-5</span></div>
          <div className="flex justify-between"><span>Next question</span><span className="font-mono">â†’ or Space</span></div>
          <div className="flex justify-between"><span>Previous question</span><span className="font-mono">â†</span></div>
          <div className="flex justify-between"><span>Undo</span><span className="font-mono">Esc</span></div>
        </div>
      </div>
      <button onClick={onReset} className={`w-full py-2.5 rounded-lg text-sm font-medium ${darkMode ? 'bg-rose-900/30 text-rose-400' : 'bg-rose-100 text-rose-600'}`}>Reset Demo Data</button>
      <div className={`text-sm text-center ${darkMode ? 'text-gray-600' : 'text-gray-400'}`}>Aura Player vO</div>
    </div>
  </div>
);

// ==================== MAIN APP ====================
function App() {
  const displayMode = useDisplayMode();
  const [questions] = useState(() => shuffleArray(QUESTIONS));
  const [screen, setScreen] = useState('launch');
  const [previousScreen, setPreviousScreen] = useState('categories');
  const [currentIndex, setCurrentIndex] = useState(0);
  const [darkMode, setDarkMode] = useState(getInitialDarkMode);
  const [responses, setResponses] = useState(() => demoStorage.get().answers);
  const [communityResults, setCommunityResults] = useState(() => generateDemoCommunityResults());
  const [undoDelay, setUndoDelay] = useState(() => demoStorage.get().settings.undoDelay);
  const [requireConfirmation, setRequireConfirmation] = useState(() => demoStorage.get().settings.requireConfirmation);
  const [showTips, setShowTips] = useState(() => demoStorage.get().settings.showTips !== false);
  const [showGestureHint, setShowGestureHint] = useState(true);
  const [stats, setStats] = useState(() => demoStorage.get().stats);
  const [pendingSubmit, setPendingSubmit] = useState(null);
  const [inGracePeriod, setInGracePeriod] = useState(false); // Grace period for multi-tap confidence
  const [justUndone, setJustUndone] = useState(false); // Shows "Undone" modal after canceling submit
  const [tappedAnswer, setTappedAnswer] = useState(null);
  const [tapCount, setTapCount] = useState(0);
  const [evidenceExpanded, setEvidenceExpanded] = useState(false);
  const [showFullResults, setShowFullResults] = useState(null);
  const [lastAnsweredQuestion, setLastAnsweredQuestion] = useState(null); // Track the question we just answered
  const [communityBrowseIndex, setCommunityBrowseIndex] = useState(0); // For browsing through answered questions
  const [communityDisplayMode, setCommunityDisplayMode] = useState('compact'); // 'compact', 'hidden'
  const [communityExpanded, setCommunityExpanded] = useState(false); // Slide-up expanded view
  const [selectedCategory, setSelectedCategory] = useState(null); // For category filtering
  const [selectedTrack, setSelectedTrack] = useState(null); // 'binary' or 'multiple'
  const [questionFlags, setQuestionFlags] = useState({}); // { [questionId]: "flag text" }
  const [answerExplanations, setAnswerExplanations] = useState({}); // { [questionId]: "explanation" }
  const [showQuestionFlagModal, setShowQuestionFlagModal] = useState(null); // questionId or null
  const [showExplanationModal, setShowExplanationModal] = useState(null); // questionId or null
  const [savedQuestions, setSavedQuestions] = useState(new Set()); // Questions saved for later
  const [skippedQuestions, setSkippedQuestions] = useState(new Set()); // Questions skipped

  // Question of the Day state
  const [qotdData, setQotdData] = useState(() => getRandomQOTD());
  const [qotdResponse, setQotdResponse] = useState(null); // { answer, confidence }

  // Reset QOD to a new random question
  const resetQotd = () => {
    setQotdData(getRandomQOTD());
    setQotdResponse(null);
    setQotdTappedAnswer(null);
    setQotdTapCount(0);
  };
  const [qotdTappedAnswer, setQotdTappedAnswer] = useState(null);
  const [qotdTapCount, setQotdTapCount] = useState(0);

  // Profile/History state
  const [showStreak, setShowStreak] = useState(true);
  const [historyFilter, setHistoryFilter] = useState('all');

  // Modal state for Can't Answer / None Option
  const [showCantAnswerModal, setShowCantAnswerModal] = useState(null);
  const [showNoneOptionModal, setShowNoneOptionModal] = useState(false);
  const [sessionAnsweredCategories, setSessionAnsweredCategories] = useState(new Set()); // Categories user has answered in this session
  const [sessionAnsweredIds, setSessionAnsweredIds] = useState(new Set()); // Question IDs answered THIS session (show results only for these)

  const submitTimeoutRef = useRef(null);
  const tapTimeoutRef = useRef(null);
  const graceTimeoutRef = useRef(null);
  const pendingSubmitStartRef = useRef(null);
  const CONFIDENCE_GRACE_PERIOD = 600; // ms to allow additional taps to increase confidence

  const currentQuestion = questions[currentIndex];
  const currentResponse = currentQuestion ? responses[currentQuestion.id] : null;
  const isAnswered = !!currentResponse;
  const currentResults = currentQuestion ? communityResults[currentQuestion.id] : null;
  const isBinary = currentQuestion?.type === 'binary';

  // Last answered question for bottom community results (not just prev index)
  const lastAnsweredResponse = lastAnsweredQuestion ? responses[lastAnsweredQuestion.id] : null;
  const lastAnsweredResults = lastAnsweredQuestion ? communityResults[lastAnsweredQuestion.id] : null;

  // Calculate progress
  const totalQuestions = questions.length;
  const answeredCount = Object.keys(responses).length;

  useEffect(() => {
    const data = demoStorage.get();
    data.settings = { ...data.settings, darkMode, undoDelay, requireConfirmation, showTips };
    demoStorage.set(data);
  }, [darkMode, undoDelay, requireConfirmation, showTips]);

  // Find next unanswered question
  const findNextUnanswered = useCallback((fromIndex) => {
    for (let i = fromIndex + 1; i < questions.length; i++) {
      if (!responses[questions[i].id]) return i;
    }
    for (let i = 0; i < fromIndex; i++) {
      if (!responses[questions[i].id]) return i;
    }
    return null;
  }, [questions, responses]);

  // Check if question matches current category and track filters
  const matchesFilters = useCallback((q) => {
    if (selectedCategory && selectedCategory !== 'random' && q.category !== selectedCategory) return false;
    if (selectedTrack === 'binary' && q.type !== 'binary') return false;
    if (selectedTrack === 'multiple' && q.type !== 'multiple') return false;
    return true;
  }, [selectedCategory, selectedTrack]);

  const goToNext = useCallback(() => {
    let nextIdx = null;
    // Find next unanswered matching filters
    for (let i = currentIndex + 1; i < questions.length; i++) {
      if (matchesFilters(questions[i]) && !responses[questions[i].id]) {
        nextIdx = i;
        break;
      }
    }
    if (nextIdx === null) {
      // Wrap around
      for (let i = 0; i < currentIndex; i++) {
        if (matchesFilters(questions[i]) && !responses[questions[i].id]) {
          nextIdx = i;
          break;
        }
      }
    }
    if (nextIdx !== null) {
      setCurrentIndex(nextIdx);
      setTappedAnswer(null);
      setTapCount(0);
      setEvidenceExpanded(false);
      setCommunityBrowseIndex(0);
      setJustUndone(false); // Clear undo popup when leaving
    } else {
      setScreen('categories');
    }
  }, [currentIndex, matchesFilters, questions, responses]);

  const goToPrev = useCallback(() => {
    for (let i = currentIndex - 1; i >= 0; i--) {
      if (matchesFilters(questions[i])) {
        setCurrentIndex(i);
        setTappedAnswer(null);
        setTapCount(0);
        setEvidenceExpanded(false);
        setCommunityBrowseIndex(0);
        setJustUndone(false); // Clear undo popup when leaving
        return;
      }
    }
  }, [currentIndex, matchesFilters, questions]);

  // Skip question - move to next without answering
  const skipQuestion = useCallback(() => {
    if (currentQuestion) {
      setSkippedQuestions(prev => new Set([...prev, currentQuestion.id]));
    }
    setTappedAnswer(null);
    setTapCount(0);
    goToNext();
  }, [currentQuestion, goToNext]);

  // Save question for later
  const saveForLater = useCallback(() => {
    if (currentQuestion) {
      setSavedQuestions(prev => new Set([...prev, currentQuestion.id]));
    }
    setTappedAnswer(null);
    setTapCount(0);
    goToNext();
  }, [currentQuestion, goToNext]);

  const { handlers: swipeHandlers } = useSwipe({
    onSwipeLeft: goToNext,
    onSwipeRight: goToPrev,
    enabled: screen === 'question' && !pendingSubmit
  });

  const handleAnswerTap = (answer) => {
    if (isAnswered) return;

    // During grace period, allow confidence increases on pending answer
    if (pendingSubmit && inGracePeriod) {
      if (answer === pendingSubmit.answer && pendingSubmit.confidence < 4) {
        // Increase confidence during grace period
        const newConfidence = Math.min(pendingSubmit.confidence + 1, 4);
        setPendingSubmit({ ...pendingSubmit, confidence: newConfidence });
        pendingSubmitStartRef.current = Date.now(); // Reset grace period timer
        // Reset grace period
        if (graceTimeoutRef.current) clearTimeout(graceTimeoutRef.current);
        graceTimeoutRef.current = setTimeout(() => setInGracePeriod(false), CONFIDENCE_GRACE_PERIOD);
        // Restart the submit timeout with new confidence
        if (submitTimeoutRef.current) clearTimeout(submitTimeoutRef.current);
        if (undoDelay > 0) {
          submitTimeoutRef.current = setTimeout(() => {
            finalizeSubmit(answer, newConfidence, pendingSubmit.community);
          }, undoDelay * 1000);
        }
      }
      return;
    }

    // If pending but not in grace period, ignore tap (handled by overlay)
    if (pendingSubmit) return;

    if (tapTimeoutRef.current) clearTimeout(tapTimeoutRef.current);

    let newTapCount;
    if (tappedAnswer === answer) {
      newTapCount = Math.min(tapCount + 1, 4);
      setTapCount(newTapCount);
    } else {
      newTapCount = 1;
      setTappedAnswer(answer);
      setTapCount(1);
    }

    // Auto-submit if not requiring confirmation
    if (!requireConfirmation) {
      tapTimeoutRef.current = setTimeout(() => {
        submitAnswer(answer, newTapCount);
      }, 400);
    }
  };

  // Right-click to decrease confidence
  const handleAnswerRightClick = (e, answer) => {
    e.preventDefault();
    if (isAnswered || pendingSubmit) return;
    if (tappedAnswer !== answer) return; // Can only decrease if this answer is selected

    if (tapCount > 1) {
      setTapCount(tapCount - 1);
    }
  };

  const submitAnswer = (answer, confidence) => {
    if (submitTimeoutRef.current) clearTimeout(submitTimeoutRef.current);
    if (tapTimeoutRef.current) clearTimeout(tapTimeoutRef.current);
    if (justUndone) setJustUndone(false); // Clear undo state

    const community = generateFakeResults(currentQuestion);

    setPendingSubmit({ answer, confidence, community });
    pendingSubmitStartRef.current = Date.now(); // Track when pending started for grace period
    setTappedAnswer(null);
    setTapCount(0);

    // Start grace period for multi-tap confidence
    setInGracePeriod(true);
    if (graceTimeoutRef.current) clearTimeout(graceTimeoutRef.current);
    graceTimeoutRef.current = setTimeout(() => setInGracePeriod(false), CONFIDENCE_GRACE_PERIOD);

    // Hide gesture hint after first answer
    if (showGestureHint) setShowGestureHint(false);

    if (undoDelay === 0) {
      finalizeSubmit(answer, confidence, community);
    } else {
      submitTimeoutRef.current = setTimeout(() => {
        finalizeSubmit(answer, confidence, community);
      }, undoDelay * 1000);
    }
  };

  const finalizeSubmit = (answer, confidence, community) => {
    if (graceTimeoutRef.current) clearTimeout(graceTimeoutRef.current);
    setInGracePeriod(false);
    const data = demoStorage.get();
    data.answers[currentQuestion.id] = { answer, confidence, timestamp: Date.now() };
    data.stats.answered = Object.keys(data.answers).length;
    const today = new Date().toDateString();
    if (data.stats.lastAnswerDate !== today) {
      const yesterday = new Date(Date.now() - 86400000).toDateString();
      data.stats.streak = data.stats.lastAnswerDate === yesterday ? data.stats.streak + 1 : 1;
      data.stats.lastAnswerDate = today;
    }
    demoStorage.set(data);

    // Track this as last answered question BEFORE advancing
    setLastAnsweredQuestion(currentQuestion);
    setCommunityBrowseIndex(0); // Reset to show most recent

    // Track that user has answered in this category this session
    if (currentQuestion.category) {
      setSessionAnsweredCategories(prev => new Set([...prev, currentQuestion.category]));
    }
    // Track this question as answered THIS session (for showing results)
    setSessionAnsweredIds(prev => new Set([...prev, currentQuestion.id]));

    setResponses(data.answers);
    setCommunityResults(prev => ({ ...prev, [currentQuestion.id]: community }));
    setStats(data.stats);
    setPendingSubmit(null);

    // Go straight to next question (no flash of results screen)
    goToNext();
  };

  const handleUndo = () => {
    if (submitTimeoutRef.current) clearTimeout(submitTimeoutRef.current);
    if (graceTimeoutRef.current) clearTimeout(graceTimeoutRef.current);
    setInGracePeriod(false);
    // Restore selection state like vG
    if (pendingSubmit) {
      setTappedAnswer(pendingSubmit.answer);
      setTapCount(pendingSubmit.confidence);
      setJustUndone(true);
    }
    setPendingSubmit(null);
  };

  const clearUndoneState = () => {
    setTappedAnswer(null);
    setTapCount(0);
    setJustUndone(false);
  };

  // Go to settings, remembering where we came from
  const goToSettings = () => {
    setPreviousScreen(screen);
    setScreen('settings');
  };

  // Question flag handlers
  const handleQuestionFlag = (questionId, flagText) => {
    setQuestionFlags(prev => ({ ...prev, [questionId]: flagText }));
  };

  const handleClearQuestionFlag = (questionId) => {
    setQuestionFlags(prev => {
      const next = { ...prev };
      delete next[questionId];
      return next;
    });
  };

  // Explanation handlers
  const handleSaveExplanation = (questionId, text) => {
    setAnswerExplanations(prev => ({ ...prev, [questionId]: text }));
  };

  const handleClearExplanation = (questionId) => {
    setAnswerExplanations(prev => {
      const next = { ...prev };
      delete next[questionId];
      return next;
    });
  };

  // Category selection with track support
  const handleSelectCategory = (categoryId, track = null) => {
    setSelectedCategory(categoryId);
    setSelectedTrack(track);
    // Find first unanswered in this category+track
    let filtered = categoryId === 'random'
      ? questions
      : questions.filter(q => q.category === categoryId);
    if (track === 'binary') filtered = filtered.filter(q => q.type === 'binary');
    if (track === 'multiple') filtered = filtered.filter(q => q.type === 'multiple');
    const firstUnanswered = filtered.findIndex(q => !responses[q.id]);
    if (firstUnanswered !== -1) {
      const actualIndex = questions.findIndex(q => q.id === filtered[firstUnanswered].id);
      setCurrentIndex(actualIndex);
    }
    setScreen('question');
  };

  const startDemo = () => {
    // Go to category selection screen
    setSelectedCategory(null);
    setTappedAnswer(null);
    setTapCount(0);
    setScreen('categories');
  };

  const resetDemo = () => {
    demoStorage.clear();
    const freshState = getInitialState();
    setResponses(freshState.answers);
    setCommunityResults(generateDemoCommunityResults());
    setStats(freshState.stats);
    setCurrentIndex(0);
    setShowGestureHint(true);
    setQotdResponse(null);
    setQotdTappedAnswer(null);
    setQotdTapCount(0);
    setScreen('launch');
  };

  const renderContent = () => {
    if (screen === 'launch') return <LaunchScreen onDemo={startDemo} onLogin={() => {}} darkMode={darkMode} />;
    if (screen === 'settings') return (
      <SettingsScreen
        darkMode={darkMode}
        setDarkMode={setDarkMode}
        undoDelay={undoDelay}
        setUndoDelay={setUndoDelay}
        requireConfirmation={requireConfirmation}
        setRequireConfirmation={setRequireConfirmation}
        showTips={showTips}
        setShowTips={setShowTips}
        showStreak={showStreak}
        setShowStreak={setShowStreak}
        onBack={() => setScreen(previousScreen)}
        onReset={resetDemo}
        onHistory={() => setScreen('history')}
      />
    );

    // Profile screen
    if (screen === 'profile') {
      const answeredList = Object.entries(responses).map(([id, r]) => ({ id: parseInt(id), ...r }));
      const answered = answeredList.length;
      const avgConf = answered > 0 ? (answeredList.reduce((s, r) => s + r.confidence, 0) / answered).toFixed(1) : 'â€”';
      const confDist = [0, 0, 0, 0];
      answeredList.forEach(r => confDist[r.confidence - 1]++);
      const categoryBreakdown = {};
      answeredList.forEach(r => {
        const q = questions.find(q => q.id === r.id);
        if (q) {
          if (!categoryBreakdown[q.category]) categoryBreakdown[q.category] = { count: 0, confDist: [0, 0, 0, 0] };
          categoryBreakdown[q.category].count++;
          categoryBreakdown[q.category].confDist[r.confidence - 1]++;
        }
      });
      return (
        <div className={`flex-1 flex flex-col overflow-hidden ${darkMode ? 'text-white bg-gray-950' : 'text-gray-900 bg-gray-50'}`}>
          <div className={`h-[44px] flex-shrink-0 flex items-center gap-2 px-3 border-b ${darkMode ? 'border-gray-800' : 'border-gray-200'}`}>
            <button onClick={() => setScreen('categories')} className={darkMode ? 'text-gray-400' : 'text-gray-500'}>â†</button>
            <span className="font-medium flex-1">Profile</span>
          </div>
          <div className="flex-1 p-4 overflow-y-auto space-y-4">
            <div className="flex items-center gap-3">
              <div className="w-12 h-12 bg-gradient-to-br from-violet-500 to-fuchsia-500 rounded-full flex items-center justify-center font-bold text-lg text-white">D</div>
              <div><h2 className="font-medium">DemoUser</h2></div>
            </div>
            <div className="grid grid-cols-2 gap-2">
              <div className={`rounded-lg p-3 text-center ${darkMode ? 'bg-gray-900' : 'bg-white border border-gray-200'}`}>
                <div className="text-2xl font-bold">{answered}</div>
                <div className="text-sm text-gray-500">Answered</div>
              </div>
              <div className={`rounded-lg p-3 text-center ${darkMode ? 'bg-gray-900' : 'bg-white border border-gray-200'}`}>
                <div className="text-2xl font-bold text-orange-400">ðŸ”¥ {stats.streak}</div>
                <div className="text-sm text-gray-500">Day Streak</div>
              </div>
              <div className={`rounded-lg p-3 text-center ${darkMode ? 'bg-gray-900' : 'bg-white border border-gray-200'}`}>
                <div className="text-2xl font-bold">{avgConf}</div>
                <div className="text-sm text-gray-500">Avg Confidence</div>
              </div>
              <div className={`rounded-lg p-3 text-center ${darkMode ? 'bg-gray-900' : 'bg-white border border-gray-200'}`}>
                <div className={`text-2xl font-bold ${darkMode ? 'text-emerald-400' : 'text-emerald-500'}`}>0</div>
                <div className="text-sm text-gray-500">Task Points</div>
              </div>
            </div>
            {answered > 0 && (
              <div className={`rounded-lg p-3 ${darkMode ? 'bg-gray-900 shine-card shine-gray' : 'bg-white border border-gray-200'}`}>
                <div className={`text-sm mb-2 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>Confidence Distribution</div>
                <div className="flex items-center gap-4">
                  <div className="relative w-24 h-24 flex-shrink-0">
                    <svg viewBox="0 0 36 36" className="w-full h-full -rotate-90">
                      {(() => {
                        const total = confDist.reduce((a, b) => a + b, 0);
                        const colors = ['#c4b5fd', '#a78bfa', '#8b5cf6', '#6d28d9'];
                        let cumulative = 0;
                        return confDist.map((count, i) => {
                          const pct = total > 0 ? (count / total) * 100 : 0;
                          const offset = cumulative;
                          cumulative += pct;
                          if (pct === 0) return null;
                          return <circle key={i} cx="18" cy="18" r="14" fill="transparent" stroke={colors[i]} strokeWidth="6" strokeDasharray={`${pct} ${100 - pct}`} strokeDashoffset={-offset} />;
                        });
                      })()}
                    </svg>
                    <div className="absolute inset-0 flex flex-col items-center justify-center">
                      <span className="text-lg font-bold">{answered}</span>
                      <span className="text-sm text-gray-500">total</span>
                    </div>
                  </div>
                  <div className="flex-1 space-y-1">
                    {confDist.map((count, i) => {
                      const pct = answered > 0 ? Math.round((count / answered) * 100) : 0;
                      const colors = ['bg-violet-300', 'bg-violet-400', 'bg-violet-500', 'bg-violet-700'];
                      return (
                        <div key={i} className="flex items-center gap-2 text-sm">
                          <div className={`w-3 h-3 rounded-sm ${colors[i]}`} />
                          <span className={`flex-1 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>{CONFIDENCE_LABELS[i + 1]}</span>
                          <span className={darkMode ? 'text-gray-500' : 'text-gray-600'}>{count}</span>
                          <span className={`w-8 text-right ${darkMode ? 'text-gray-600' : 'text-gray-400'}`}>{pct}%</span>
                        </div>
                      );
                    })}
                  </div>
                </div>
              </div>
            )}
            {Object.keys(categoryBreakdown).length > 0 && (
              <div className={`rounded-lg p-3 ${darkMode ? 'bg-gray-900 shine-card shine-gray' : 'bg-white border border-gray-200'}`}>
                <div className={`text-sm mb-2 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>By Category</div>
                <div className="space-y-2">
                  {CATEGORIES.filter(c => categoryBreakdown[c.id]).map(cat => {
                    const { count, confDist: catConf } = categoryBreakdown[cat.id];
                    const total = questions.filter(q => q.category === cat.id).length;
                    const pct = Math.round((count / total) * 100);
                    const colors = ['#c4b5fd', '#a78bfa', '#8b5cf6', '#6d28d9'];
                    return (
                      <div key={cat.id} className="flex items-center gap-2">
                        <span className="text-sm w-5">{cat.icon}</span>
                        <div className={`flex-1 h-3 rounded-full overflow-hidden flex ${darkMode ? 'bg-gray-800' : 'bg-gray-100'}`}>
                          {catConf.map((c, i) => {
                            const segPct = count > 0 ? (c / count) * pct : 0;
                            if (segPct === 0) return null;
                            return <div key={i} className="h-full" style={{ width: `${segPct}%`, background: colors[i] }} />;
                          })}
                        </div>
                        <span className="text-sm text-gray-500 w-8 text-right">{count}</span>
                      </div>
                    );
                  })}
                </div>
              </div>
            )}
            <div className={`rounded-lg p-3 ${darkMode ? 'bg-gray-900/50 border border-gray-800' : 'bg-white border border-gray-300'}`}>
              <div className={`text-sm mb-2 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>Coming Soon</div>
              <div className="space-y-1.5 text-sm text-gray-500">
                <div className="flex items-center gap-2"><span className="text-amber-400">â—†</span><span>Accuracy tracking & calibration</span></div>
                <div className="flex items-center gap-2"><span className="text-amber-400">â—†</span><span>Leaderboard position</span></div>
                <div className="flex items-center gap-2"><span className="text-amber-400">â—†</span><span>Prediction resolution history</span></div>
              </div>
            </div>
          </div>
        </div>
      );
    }

    // History screen
    if (screen === 'history') {
      const answeredQuestions = questions
        .filter(q => responses[q.id])
        .map(q => ({ ...q, response: responses[q.id], community: communityResults[q.id] }))
        .sort((a, b) => (b.response.timestamp || 0) - (a.response.timestamp || 0));
      const filteredQuestions = answeredQuestions.filter(q => {
        if (historyFilter === 'all') return true;
        if (historyFilter === 'binary') return q.type === 'binary';
        if (historyFilter === 'multiple') return q.type === 'multiple';
        if (historyFilter === 'flagged') return questionFlags[q.id] || answerExplanations[q.id];
        return q.category === historyFilter;
      });
      const getAnswerLabel = (q) => {
        if (q.type === 'binary') return q.response.answer === 0 ? 'YES' : 'NO';
        return q.options?.[q.response.answer] || '?';
      };
      return (
        <div className={`flex-1 flex flex-col ${darkMode ? 'text-white bg-gray-950' : 'text-gray-900 bg-gray-50'}`}>
          <div className={`h-[44px] flex-shrink-0 flex items-center gap-2 px-3 border-b ${darkMode ? 'border-gray-800' : 'border-gray-200'}`}>
            <button onClick={() => setScreen('settings')} className={darkMode ? 'text-gray-400' : 'text-gray-500'}>â†</button>
            <span className="font-medium flex-1">History</span>
            <span className={`text-sm ${darkMode ? 'text-gray-500' : 'text-gray-500'}`}>{answeredQuestions.length} answered</span>
          </div>
          <div className="flex gap-1 p-2 overflow-x-auto">
            {[{ id: 'all', label: 'All' }, { id: 'binary', label: 'Y/N' }, { id: 'multiple', label: 'MC' }, { id: 'flagged', label: 'âš‘' }, ...CATEGORIES.map(c => ({ id: c.id, label: c.icon }))].map(f => (
              <button key={f.id} onClick={() => setHistoryFilter(f.id)}
                className={`px-2.5 py-1 rounded-lg text-sm whitespace-nowrap transition-colors ${historyFilter === f.id ? 'bg-violet-600 text-white' : darkMode ? 'bg-gray-800 text-gray-400' : 'bg-white text-gray-600 border border-gray-200'}`}>
                {f.label}
              </button>
            ))}
          </div>
          <div className="flex-1 overflow-y-auto p-2 space-y-1">
            {filteredQuestions.length === 0 ? (
              <div className="flex-1 flex flex-col items-center justify-center text-center py-8">
                <div className="text-3xl mb-2">ðŸ“‹</div>
                <p className="text-gray-500 text-sm">No questions match this filter</p>
              </div>
            ) : filteredQuestions.map(q => {
              const catInfo = CATEGORIES.find(c => c.id === q.category);
              const isExpanded = evidenceExpanded === `history-${q.id}`;
              return (
                <div key={q.id} className={`rounded-lg p-3 ${darkMode ? 'bg-gray-900' : 'bg-white border border-gray-200'}`}>
                  <div className="flex items-start gap-2">
                    <span className="text-sm">{catInfo?.icon || 'â—†'}</span>
                    <div className="flex-1 min-w-0">
                      <p className={`text-sm leading-snug line-clamp-2 ${darkMode ? 'text-gray-200' : 'text-gray-800'}`}>{q.text}</p>
                      <div className="flex items-center gap-2 mt-1.5">
                        <span className={`text-sm font-medium ${q.type === 'binary' ? (q.response.answer === 0 ? (darkMode ? 'text-emerald-400' : 'text-emerald-600') : (darkMode ? 'text-rose-400' : 'text-rose-600')) : (darkMode ? 'text-violet-400' : 'text-violet-600')}`}>
                          {getAnswerLabel(q)}
                        </span>
                        <ConfidenceDots level={q.response.confidence} />
                        <span className="text-sm text-gray-500">{CONFIDENCE_LABELS[q.response.confidence]}</span>
                        {questionFlags[q.id] && <span className="text-sm text-rose-400">âš‘</span>}
                        {answerExplanations[q.id] && <span className="text-sm text-amber-400">âœŽ</span>}
                      </div>
                    </div>
                  </div>
                  {q.community && (
                    <button onClick={() => setEvidenceExpanded(isExpanded ? null : `history-${q.id}`)} className="w-full mt-2 text-left">
                      <div className={`flex items-center justify-between text-sm ${darkMode ? 'text-gray-600' : 'text-gray-500'}`}>
                        <span>{q.community.evaluators?.length || 0} responses</span>
                        <span>{isExpanded ? 'â–²' : 'â–¼'}</span>
                      </div>
                      {isExpanded && (
                        <div className="mt-2">
                          {q.type === 'binary' ? <BinaryChart evaluators={q.community.evaluators} userResponse={q.response} darkMode={darkMode} /> : <MultipleChoiceChart evaluators={q.community.evaluators} userResponse={q.response} options={q.options} darkMode={darkMode} />}
                        </div>
                      )}
                    </button>
                  )}
                </div>
              );
            })}
          </div>
        </div>
      );
    }

    // Question of the Day screen - uses SAME components as regular Q&A, just with blue glow
    if (screen === 'qotd') {
      // Convert QOD data to question-like format for reusing components
      const qotdQuestion = {
        id: qotdData.id,
        text: qotdData.text,
        type: qotdData.type,
        category: 'qotd',
        options: qotdData.options || []
      };
      const qotdCommunityResults = qotdDistributionToEvaluators(qotdData);
      const isBinary = qotdData.type === 'binary';
      const hasAnswered = qotdResponse !== null;

      // Blue glow style - pronounced
      const blueGlowStyle = {
        background: darkMode
          ? 'radial-gradient(ellipse at center top, rgba(59, 130, 246, 0.25) 0%, rgba(59, 130, 246, 0.12) 35%, rgba(59, 130, 246, 0.04) 60%, transparent 80%), #030712'
          : 'radial-gradient(ellipse at center top, rgba(59, 130, 246, 0.2) 0%, rgba(59, 130, 246, 0.08) 35%, rgba(59, 130, 246, 0.02) 60%, transparent 80%), #f9fafb'
      };

      // Go to first unanswered question in regular Q&A
      const goToQuestions = () => {
        const firstUnanswered = questions.findIndex(q => !responses[q.id]);
        if (firstUnanswered >= 0) {
          setCurrentIndex(firstUnanswered);
          setScreen('questions');
        } else {
          setScreen('categories');
        }
      };

      return (
        <div className="flex-1 flex flex-col overflow-hidden relative" style={blueGlowStyle}>
          {/* Navigation Bar */}
          <div className={`h-[36px] flex-shrink-0 flex items-center gap-2 px-3 ${darkMode ? 'bg-gray-900/50' : 'bg-white/80 border-b border-gray-200'}`}>
            <button onClick={() => setScreen('categories')} className={`text-xl font-bold w-8 h-8 flex items-center justify-center ${darkMode ? 'text-gray-300 active:text-white' : 'text-gray-600 active:text-gray-900'}`}>â—€</button>
            <div className={`flex-1 h-2 rounded-full overflow-hidden ${darkMode ? 'bg-gray-800' : 'bg-gray-300'}`}>
              <div className="h-full bg-blue-500 transition-all duration-300" style={{ width: hasAnswered ? '100%' : '0%' }} />
            </div>
            <button onClick={goToQuestions} className={`text-xl font-bold w-8 h-8 flex items-center justify-center ${darkMode ? 'text-gray-300 active:text-white' : 'text-gray-600 active:text-gray-900'}`}>â–¶</button>
          </div>

          {/* QOD badge row */}
          <div className={`h-[28px] flex-shrink-0 flex items-center justify-center gap-2 ${darkMode ? 'bg-blue-900/20' : 'bg-blue-50'}`}>
            <span className="text-sm">â˜€ï¸</span>
            <span className={`text-sm font-medium ${darkMode ? 'text-blue-400' : 'text-blue-600'}`}>Question of the Day</span>
            <span className={`text-sm ${darkMode ? 'text-gray-500' : 'text-gray-500'}`}>Day {qotdData.day} Â· {getQotdTimeRemaining()}</span>
            {!hasAnswered && <span className="text-amber-500 text-sm font-medium">+{qotdData.reward}</span>}
          </div>

          {/* ANSWERED VIEW - tap anywhere to return to menu */}
          {hasAnswered ? (
            <div className="flex-1 flex flex-col overflow-y-auto px-4 py-3 cursor-pointer" onClick={() => setScreen('categories')}>
              {/* Question */}
              <h2 className={`question-text text-center font-medium mb-4 ${darkMode ? 'text-white' : 'text-gray-900'}`}>{qotdData.text}</h2>

              {/* Your answer summary */}
              <div className={`p-3 rounded-lg mb-4 ${darkMode ? 'bg-gray-900/50' : 'bg-gray-100'}`}>
                <div className={`text-sm text-center ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                  Your answer: <span className={`font-bold ${isBinary ? (qotdResponse.answer === 0 ? 'text-emerald-400' : 'text-rose-400') : ''}`} style={!isBinary ? { color: MC_COLORS[qotdResponse.answer % MC_COLORS.length].hex } : undefined}>
                    {isBinary ? (qotdResponse.answer === 0 ? 'Yes' : 'No') : qotdData.options?.[qotdResponse.answer]}
                  </span> Â· {CONFIDENCE_LABELS[qotdResponse.confidence]}
                </div>
              </div>

              {/* Community Results - same charts as regular Q&A */}
              <div className={`rounded-lg p-3 ${darkMode ? 'bg-gray-900 shine-card shine-gray' : 'bg-white border border-gray-200'}`}>
                <div className={`text-sm font-medium mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Community Results</div>
                {isBinary ? (
                  <BinaryChart evaluators={qotdCommunityResults.evaluators} userResponse={qotdResponse} darkMode={darkMode} />
                ) : (
                  <MultipleChoiceChart evaluators={qotdCommunityResults.evaluators} userResponse={qotdResponse} options={qotdData.options || []} darkMode={darkMode} />
                )}
                <div className={`text-sm text-center mt-2 ${darkMode ? 'text-gray-600' : 'text-gray-400'}`}>
                  {qotdCommunityResults.evaluators.length.toLocaleString()} responses
                </div>
              </div>

              {/* Sponsor */}
              <div className={`flex items-center justify-center gap-2 mt-4 p-2 rounded-lg ${darkMode ? 'bg-gray-900/30' : 'bg-gray-50'}`}>
                <span className="text-sm">{qotdData.sponsor.avatar}</span>
                <span className={`text-sm ${darkMode ? 'text-gray-600' : 'text-gray-500'}`}>Sponsored by {qotdData.sponsor.name}</span>
              </div>
            </div>
          ) : (
            <>
              {/* UNANSWERED VIEW - same layout as regular Q&A */}
              <div className="flex-1 flex flex-col justify-center px-4 pb-3 overflow-y-auto">
                <QuestionCard question={qotdQuestion} darkMode={darkMode} evidenceExpanded={false} onToggleEvidence={() => {}} />
                {/* Sponsor under question */}
                <div className={`flex items-center justify-center gap-2 mt-3 ${darkMode ? 'text-gray-600' : 'text-gray-500'}`}>
                  <span className="text-sm">{qotdData.sponsor.avatar}</span>
                  <span className="text-sm">Sponsored by {qotdData.sponsor.name}</span>
                </div>
              </div>

              {/* Fixed Bottom - SAME answer buttons as regular Q&A */}
              <div className={`flex-shrink-0 border-t ${darkMode ? 'border-gray-800 bg-gray-950/80' : 'border-gray-200 bg-white/80'}`}>
                <div className={`px-4 pt-3 ${isBinary ? 'h-[93px]' : ''}`}>
                  {isBinary ? (
                    <BinaryButtons
                      darkMode={darkMode}
                      tappedAnswer={qotdTappedAnswer}
                      tapCount={qotdTapCount}
                      isAnswered={false}
                      currentResponse={null}
                      onTap={(ans) => {
                        if (qotdTappedAnswer === ans) {
                          setQotdTapCount(Math.min(4, qotdTapCount + 1));
                        } else {
                          setQotdTappedAnswer(ans);
                          setQotdTapCount(1);
                        }
                      }}
                      onRightClick={() => {}}
                      pendingSubmit={null}
                      requireConfirmation={true}
                      onSubmit={() => {
                        setQotdResponse({ answer: qotdTappedAnswer, confidence: qotdTapCount });
                        setQotdTappedAnswer(null);
                        setQotdTapCount(0);
                      }}
                    />
                  ) : (
                    <MCButtons
                      options={qotdData.options || []}
                      darkMode={darkMode}
                      tappedAnswer={qotdTappedAnswer}
                      tapCount={qotdTapCount}
                      isAnswered={false}
                      currentResponse={null}
                      onTap={(ans) => {
                        if (qotdTappedAnswer === ans) {
                          setQotdTapCount(Math.min(4, qotdTapCount + 1));
                        } else {
                          setQotdTappedAnswer(ans);
                          setQotdTapCount(1);
                        }
                      }}
                      onRightClick={() => {}}
                      pendingSubmit={null}
                      requireConfirmation={true}
                      onSubmit={() => {
                        setQotdResponse({ answer: qotdTappedAnswer, confidence: qotdTapCount });
                        setQotdTappedAnswer(null);
                        setQotdTapCount(0);
                      }}
                    />
                  )}
                </div>

                {/* Bottom spacer */}
                <div className="h-[40px]" />
              </div>
            </>
          )}
        </div>
      );
    }

    if (screen === 'categories') return (
      <CategoryScreen
        darkMode={darkMode}
        categories={CATEGORIES}
        questions={questions}
        responses={responses}
        onSelectCategory={handleSelectCategory}
        onSettings={goToSettings}
        stats={stats}
        qotdData={qotdData}
        qotdResponse={qotdResponse}
        onQotdClick={() => setScreen('qotd')}
        onResetQotd={resetQotd}
      />
    );

    if (!currentQuestion) return (
      <div className={`flex-1 flex items-center justify-center ${darkMode ? 'text-white' : 'text-gray-900'}`}>
        <div className="text-center p-8"><div className="text-4xl mb-4">ðŸŽ‰</div><div className="text-xl font-medium mb-2">All done!</div></div>
      </div>
    );

    const progress = totalQuestions > 0 ? answeredCount / totalQuestions : 0;
    const hasNext = findNextUnanswered(currentIndex) !== null || currentIndex < questions.length - 1;

    // Generate results for current question if answered but no results yet
    const currentQuestionResults = currentResults || (isAnswered ? generateFakeResults(currentQuestion) : null);
    if (isAnswered && !currentResults) {
      setCommunityResults(prev => ({ ...prev, [currentQuestion.id]: currentQuestionResults }));
    }

    return (
      <div
        className="flex-1 flex flex-col overflow-hidden relative"
        {...swipeHandlers}
      >
        {/* Full-screen undo overlay - uses portal to escape stacking context (mobile only, desktop has its own) */}
        {pendingSubmit && displayMode !== 'desktop' && ReactDOM.createPortal(
          <div
            className="fixed inset-0 z-[9999]"
            onClick={handleUndo}
            onTouchEnd={(e) => { e.preventDefault(); handleUndo(); }}
            style={{ cursor: 'pointer' }}
          />,
          document.body
        )}
        {/* Circle Track Selector - remaining counts by type */}
        <div className={`h-[68px] flex-shrink-0 flex items-center gap-3 px-3 ${darkMode ? 'bg-gray-900/50' : 'bg-white border-b border-gray-200'}`}>
          <button
            onClick={goToPrev}
            disabled={currentIndex === 0}
            className={`text-xl font-bold w-8 h-8 flex items-center justify-center ${
              currentIndex === 0
                ? (darkMode ? 'text-gray-700' : 'text-gray-300')
                : (darkMode ? 'text-gray-300 active:text-white' : 'text-gray-600 active:text-gray-900')
            }`}
          >
            â—€
          </button>
          {(() => {
            const ynCount = questions.filter(q => q.type === 'binary' && !responses[q.id]).length;
            const mcCount = questions.filter(q => q.type === 'multiple' && !responses[q.id]).length;
            const allCount = ynCount + mcCount;

            const switchTrack = (newTrack) => {
              const toggledTrack = selectedTrack === newTrack ? null : newTrack;
              setSelectedTrack(toggledTrack);
              if (toggledTrack && currentQuestion?.type !== toggledTrack) {
                const matchIdx = questions.findIndex(q => q.type === toggledTrack && !responses[q.id]);
                if (matchIdx >= 0) setCurrentIndex(matchIdx);
              }
            };

            return (
              <div className="flex-1 flex items-center justify-center gap-3">
                {/* Binary (Y/N) circle - green/red */}
                <div
                  className={`q-circle q-circle-binary ${selectedTrack === 'binary' ? 'q-circle-current' : ''} ${selectedTrack && selectedTrack !== 'binary' ? 'q-circle-adjacent' : ''}`}
                  onClick={() => switchTrack('binary')}
                  style={{ cursor: 'pointer' }}
                >
                  <div className={`q-circle-inner ${darkMode ? 'bg-gray-900 text-white' : 'bg-white text-gray-900'}`}>
                    {ynCount > 0 ? ynCount : 'âœ“'}
                  </div>
                </div>
                {/* MC circle - 5 colors */}
                <div
                  className={`q-circle q-circle-mc ${selectedTrack === 'multiple' ? 'q-circle-current' : ''} ${selectedTrack && selectedTrack !== 'multiple' ? 'q-circle-adjacent' : ''}`}
                  onClick={() => switchTrack('multiple')}
                  style={{ cursor: 'pointer' }}
                >
                  <div className={`q-circle-inner ${darkMode ? 'bg-gray-900 text-white' : 'bg-white text-gray-900'}`}>
                    {mcCount > 0 ? mcCount : 'âœ“'}
                  </div>
                </div>
                {/* All/Combined circle - white/silver */}
                <div
                  className={`q-circle q-circle-mixed ${!selectedTrack ? 'q-circle-current' : 'q-circle-adjacent'}`}
                  onClick={() => switchTrack(null)}
                  style={{ cursor: 'pointer' }}
                >
                  <div className={`q-circle-inner ${darkMode ? 'bg-gray-900 text-white' : 'bg-white text-gray-900'}`}>
                    {allCount > 0 ? allCount : 'âœ“'}
                  </div>
                </div>
              </div>
            );
          })()}
          <button
            onClick={goToNext}
            disabled={!hasNext}
            className={`text-xl font-bold w-8 h-8 flex items-center justify-center ${
              !hasNext
                ? (darkMode ? 'text-gray-700' : 'text-gray-300')
                : (darkMode ? 'text-gray-300 active:text-white' : 'text-gray-600 active:text-gray-900')
            }`}
          >
            â–¶
          </button>
        </div>

        {/* ANSWERED QUESTION VIEW - shows full results (only for questions answered THIS session) */}
        {isAnswered && !pendingSubmit && sessionAnsweredIds.has(currentQuestion.id) ? (
          <AnsweredQuestionView
            question={currentQuestion}
            response={currentResponse}
            results={currentQuestionResults}
            darkMode={darkMode}
            questionFlag={questionFlags[currentQuestion.id]}
            explanation={answerExplanations[currentQuestion.id]}
            onFlagClick={() => setShowQuestionFlagModal(currentQuestion.id)}
            onExplainClick={() => setShowExplanationModal(currentQuestion.id)}
          />
        ) : isAnswered && !pendingSubmit ? (
          /* Previously answered question - show empty space to maintain layout */
          <div className="flex-1 flex flex-col">
            <div className="flex-1" /> {/* Empty space */}
            <div className={`flex-shrink-0 border-t px-4 py-6 ${darkMode ? 'border-gray-800 bg-gray-950' : 'border-gray-200 bg-white'}`}>
              <div className={`text-center text-sm ${darkMode ? 'text-gray-600' : 'text-gray-400'}`}>
                Already answered Â· Use arrows to navigate
              </div>
            </div>
          </div>
        ) : (
          <>
            {/* QUESTION AREA - centered in available space */}
            <div className="flex-1 flex flex-col justify-center px-4 pb-3 overflow-y-auto">
              <QuestionCard
                question={currentQuestion}
                darkMode={darkMode}
                evidenceExpanded={evidenceExpanded}
                onToggleEvidence={() => setEvidenceExpanded(!evidenceExpanded)}
              />
            </div>

            {/* FIXED BOTTOM AREA - answer zones */}
            <div className={`flex-shrink-0 border-t ${darkMode ? 'border-gray-800 bg-gray-950' : 'border-gray-200 bg-white'}`}>

              {/* Undone banner - above buttons, not overlaying */}
              {justUndone && (
                <div className="px-4 pt-3 pb-2">
                  <div className={`rounded-xl px-4 py-3 flex items-center justify-between ${darkMode ? 'bg-amber-500/15 border border-amber-500/50' : 'bg-amber-100 border border-amber-300'}`}>
                    <span className={`text-sm font-bold ${darkMode ? 'text-amber-400' : 'text-amber-700'}`}>
                      Undone â€” tap to change or resubmit
                    </span>
                    <button
                      onClick={clearUndoneState}
                      className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-colors ${
                        darkMode ? 'bg-gray-800 text-gray-300 hover:bg-gray-700' : 'bg-white text-gray-700 hover:bg-gray-50 border border-gray-200'
                      }`}
                    >
                      Clear
                    </button>
                  </div>
                </div>
              )}

              {/* Tip Banner - shows once for new users */}
              {showTips && showGestureHint && !isAnswered && !pendingSubmit && !justUndone && (
                <div className="px-4 pt-2">
                  <TipBanner darkMode={darkMode} onDismiss={() => setShowGestureHint(false)} />
                </div>
              )}

              {/* Answer zone wrapper - UndoBar overlays this area */}
              <div className="relative">
                {/* Y/N UndoBar - positioned at wrapper level, covers answer buttons + action row */}
                {pendingSubmit && isBinary && (
                  <div className="absolute inset-0 z-20">
                    <UndoBar
                      darkMode={darkMode}
                      undoDelay={undoDelay}
                      onUndo={handleUndo}
                      answer={pendingSubmit.answer}
                      confidence={pendingSubmit.confidence}
                      isBinary={true}
                      options={null}
                      fullHeight={true}
                      requireConfirmation={requireConfirmation}
                    />
                  </div>
                )}

                {/* ZONE 1: Answer Buttons */}
                <div className={`relative px-4 ${justUndone ? 'pt-0' : (showTips && showGestureHint && !isAnswered && !pendingSubmit ? 'pt-0' : 'pt-3')}`}>
                  {/* MC UndoBar - covers just the MC buttons area */}
                  {pendingSubmit && !isBinary && (
                    <div className="absolute -left-4 -right-4 top-0 bottom-0 z-20">
                      <UndoBar
                        darkMode={darkMode}
                        undoDelay={undoDelay}
                        onUndo={handleUndo}
                        answer={pendingSubmit.answer}
                        confidence={pendingSubmit.confidence}
                        isBinary={false}
                        options={currentQuestion.options}
                        fullHeight={true}
                        requireConfirmation={requireConfirmation}
                      />
                    </div>
                  )}
                  <div className={pendingSubmit ? 'opacity-60 pointer-events-none' : ''}>
                    {isBinary ? (
                      <BinaryButtons
                        darkMode={darkMode}
                        tappedAnswer={tappedAnswer}
                        tapCount={tapCount}
                        isAnswered={isAnswered}
                        currentResponse={currentResponse}
                        onTap={handleAnswerTap}
                        onRightClick={handleAnswerRightClick}
                        pendingSubmit={pendingSubmit}
                        requireConfirmation={requireConfirmation}
                        onSubmit={submitAnswer}
                      />
                    ) : (
                      <MCButtons
                        options={currentQuestion.options}
                        darkMode={darkMode}
                        tappedAnswer={tappedAnswer}
                        tapCount={tapCount}
                        isAnswered={isAnswered}
                        currentResponse={currentResponse}
                        onTap={handleAnswerTap}
                        onRightClick={handleAnswerRightClick}
                        pendingSubmit={pendingSubmit}
                        requireConfirmation={requireConfirmation}
                        onSubmit={submitAnswer}
                      />
                    )}
                  </div>
                </div>

                {/* Action buttons row */}
                <div className={`relative h-[36px] px-4 mt-2 flex items-center justify-center`}>
                  {pendingSubmit ? (
                    /* Undo hint text - colored to match answer */
                    <div
                      onClick={handleUndo}
                      className="cursor-pointer text-sm font-medium"
                      style={{
                        color: isBinary
                          ? (pendingSubmit.answer === 0 ? '#10b981' : '#ef4444')
                          : MC_COLORS[pendingSubmit.answer % MC_COLORS.length]?.hex || '#8b5cf6'
                      }}
                    >
                      Tap anywhere to Undo
                    </div>
                  ) : !isAnswered ? (
                    <div className="flex gap-1.5">
                      <button
                        onClick={() => isBinary ? setShowCantAnswerModal(currentQuestion?.id) : setShowNoneOptionModal(true)}
                        className={`px-4 py-1.5 rounded-lg text-sm transition-colors ${darkMode ? 'bg-gray-800/60 text-gray-500 hover:bg-gray-700/60' : 'bg-gray-200 text-gray-500'}`}
                      >
                        {isBinary ? "Can't" : "None"}
                      </button>
                      <button
                        onClick={() => setShowExplanationModal(currentQuestion?.id)}
                        className={`px-4 py-1.5 rounded-lg text-sm transition-colors ${
                          answerExplanations[currentQuestion?.id]
                            ? 'bg-amber-900/30 text-amber-400'
                            : darkMode ? 'bg-gray-800/60 text-gray-500 hover:bg-gray-700/60' : 'bg-gray-200 text-gray-500'
                        }`}
                      >
                        Explain
                      </button>
                      <button
                        onClick={skipQuestion}
                        className={`px-4 py-1.5 rounded-lg text-sm transition-colors ${darkMode ? 'bg-gray-800/60 text-gray-500 hover:bg-gray-700/60' : 'bg-gray-200 text-gray-500'}`}
                      >
                        Skip
                      </button>
                      <button
                        onClick={saveForLater}
                        className={`px-4 py-1.5 rounded-lg text-sm transition-colors ${
                          savedQuestions.has(currentQuestion?.id)
                            ? 'bg-violet-900/30 text-violet-400'
                            : darkMode ? 'bg-gray-800/60 text-gray-500 hover:bg-gray-700/60' : 'bg-gray-200 text-gray-500'
                        }`}
                      >
                        {savedQuestions.has(currentQuestion?.id) ? 'âœ“ Saved' : 'Save'}
                      </button>
                    </div>
                  ) : null}
                </div>
              </div>

              {/* ZONE 3: Community Browse */}
              <div className="px-4 pb-3 pt-1">
                {(() => {
                  // Only show community results after user has answered at least one question this session
                  const hasAnsweredThisSession = sessionAnsweredCategories.size > 0;

                  // Get list of answered questions with results, sorted by answer time (most recent first)
                  const answeredList = questions
                    .filter(q => responses[q.id] && communityResults[q.id])
                    .sort((a, b) => (responses[b.id]?.timestamp || 0) - (responses[a.id]?.timestamp || 0));
                  if (answeredList.length === 0 || !hasAnsweredThisSession) {
                    return (
                      <div className={`h-full flex items-center justify-center text-sm ${darkMode ? 'text-gray-600' : 'text-gray-400'}`}>
                        Swipe for next â†’
                      </div>
                    );
                  }
                  const safeIdx = Math.min(communityBrowseIndex, answeredList.length - 1);
                  const browseQ = answeredList[safeIdx];
                  const browseResponse = responses[browseQ.id];
                  const browseResults = communityResults[browseQ.id];

                  // Get user's answer display
                  const isBinaryQ = browseQ.type === 'binary';
                  const userAnswer = browseResponse?.answer;
                  const userAnswerText = isBinaryQ
                    ? (userAnswer === 0 ? 'YES' : 'NO')
                    : (browseQ.options?.[userAnswer] || '?');
                  const userAnswerColor = isBinaryQ
                    ? (userAnswer === 0 ? 'text-emerald-400' : 'text-rose-400')
                    : 'text-violet-400';

                  // Hidden mode - just a thin expandable line with + button
                  if (communityDisplayMode === 'hidden') {
                    return (
                      <div className="flex items-center justify-center gap-2" onClick={() => { if (pendingSubmit) handleUndo(); }}>
                        <div className={`flex-1 h-px ${darkMode ? 'bg-gray-800' : 'bg-gray-200'}`} />
                        <button
                          onClick={() => { if (pendingSubmit) { handleUndo(); return; } setCommunityDisplayMode('compact'); }}
                          className={`w-8 h-8 rounded-full flex items-center justify-center text-lg font-light ${
                            darkMode ? 'bg-gray-800 text-gray-400 hover:bg-gray-700' : 'bg-gray-200 text-gray-500 hover:bg-gray-300'
                          } transition-colors`}
                        >+</button>
                        <div className={`flex-1 h-px ${darkMode ? 'bg-gray-800' : 'bg-gray-200'}`} />
                      </div>
                    );
                  }

                  // Compact mode with confidence-segmented bars (conf 4 in center, lower outward)
                  const userConf = Math.min(4, Math.max(1, browseResponse?.confidence || 1)) - 1;
                  const total = browseResults?.evaluators?.length || 1;

                  // Build centered confidence bar: conf4 in center, conf3, conf2, conf1 outward
                  const renderCenteredBar = (byConf, colors, maxCount, isUser) => {
                    // Colors: [dark/conf4, mid-dark/conf3, mid-light/conf2, light/conf1]
                    const totalCount = byConf.reduce((a, b) => a + b, 0);
                    if (totalCount === 0) return null;

                    // Calculate widths for each confidence level relative to max
                    const segments = [];
                    for (let i = 0; i <= 3; i++) { // conf1(i=0) to conf4(i=3)
                      if (byConf[i] > 0) {
                        segments.push({
                          width: (byConf[i] / maxCount) * 100,
                          color: colors[i],
                          conf: i
                        });
                      }
                    }
                    // Reverse so conf4 (dark) is first/left, conf1 (light) is last/right
                    segments.reverse();

                    const totalWidth = segments.reduce((a, s) => a + s.width, 0);
                    const emptyWidth = 100 - totalWidth;

                    const showEmpty = emptyWidth > 2; // Only show empty if significant
                    return (
                      <div className="flex-1 h-5 rounded-full overflow-hidden flex" style={{ backgroundColor: showEmpty ? 'transparent' : 'transparent', border: showEmpty ? `1px solid ${colors[0]}40` : 'none' }}>
                        {segments.map((s, i) => {
                          const isUserSeg = isUser && s.conf === userConf;
                          const isLast = i === segments.length - 1;
                          const isFirst = i === 0;
                          // Border radius: rounded on edges, flat in middle
                          const userRadius = isFirst && isLast ? '999px' : isFirst ? '999px 0 0 999px' : isLast ? '0 999px 999px 0' : '0';
                          return (
                            <div key={i} className={`h-full ${isLast ? 'rounded-r-full' : ''} ${isFirst ? 'rounded-l-full' : ''}`} style={{
                              width: showEmpty ? `${s.width}%` : (isLast ? undefined : `${s.width}%`),
                              flex: !showEmpty && isLast ? 1 : undefined,
                              backgroundColor: s.color,
                              ...(isUserSeg ? { border: '3px solid white', borderRadius: userRadius, zIndex: 10, position: 'relative' } : {})
                            }} />
                          );
                        })}
                      </div>
                    );
                  };

                  return (
                    <div
                      className="relative"
                      onTouchStart={(e) => { e.stopPropagation(); e.currentTarget.dataset.touchX = e.touches[0].clientX; }}
                      onTouchEnd={(e) => {
                        e.stopPropagation();
                        // During pending submit (non-grace), any touch should undo
                        if (pendingSubmit) {
                          handleUndo();
                          return;
                        }
                        const startX = parseFloat(e.currentTarget.dataset.touchX);
                        const endX = e.changedTouches[0].clientX;
                        const diff = endX - startX;
                        if (Math.abs(diff) > 50) {
                          if (diff > 0 && safeIdx > 0) setCommunityBrowseIndex(safeIdx - 1);
                          else if (diff < 0 && safeIdx < answeredList.length - 1) setCommunityBrowseIndex(safeIdx + 1);
                        }
                      }}
                      onClick={() => {
                        // During pending submit (non-grace), any click should undo
                        if (pendingSubmit) {
                          handleUndo();
                        }
                      }}
                    >
                      {/* Header with LAST and hide button - clickable to expand */}
                      <div
                        className="flex items-center gap-1 mb-1 cursor-pointer"
                        onClick={() => {
                          if (pendingSubmit) { handleUndo(); return; }
                          setCommunityExpanded(true);
                        }}
                      >
                        <span className={`text-sm font-black uppercase tracking-wide ${darkMode ? 'text-sky-300' : 'text-sky-500'}`}>LAST:</span>
                        <span className={`text-base truncate flex-1 font-medium ${darkMode ? 'text-gray-100' : 'text-gray-900'}`}>{browseQ.text}</span>
                        <button
                          onClick={(e) => { e.stopPropagation(); if (pendingSubmit) { handleUndo(); return; } setCommunityDisplayMode('hidden'); }}
                          className={`w-5 h-5 rounded flex items-center justify-center text-sm shrink-0 ${
                            darkMode ? 'text-gray-500 hover:text-gray-300' : 'text-gray-400 hover:text-gray-600'
                          }`}
                        >âˆ’</button>
                      </div>

                      {/* Content - clickable to expand */}
                      <div
                        className="cursor-pointer"
                        onClick={() => {
                          if (pendingSubmit) { handleUndo(); return; }
                          setCommunityExpanded(true);
                        }}
                      >
                        {isBinaryQ ? (() => {
                          const yesColors = ['#6ee7b7', '#34d399', '#10b981', '#059669'];
                          const noColors = ['#fca5a5', '#f87171', '#ef4444', '#dc2626'];

                          const yesByConf = [0, 0, 0, 0];
                          const noByConf = [0, 0, 0, 0];
                          (browseResults?.evaluators || []).forEach(e => {
                            const conf = Math.min(4, Math.max(1, e.confidence || 1)) - 1;
                            if (e.answer === 0) yesByConf[conf]++;
                            else noByConf[conf]++;
                          });

                          const yesTotal = yesByConf.reduce((a, b) => a + b, 0);
                          const noTotal = noByConf.reduce((a, b) => a + b, 0);
                          const yesPct = Math.round((yesTotal / total) * 100);
                          const noPct = 100 - yesPct;
                          const maxCount = Math.max(yesTotal, noTotal);

                          const rows = yesPct >= noPct
                            ? [{ label: 'Yes', pct: yesPct, byConf: yesByConf, colors: yesColors, isYes: true },
                               { label: 'No', pct: noPct, byConf: noByConf, colors: noColors, isYes: false }]
                            : [{ label: 'No', pct: noPct, byConf: noByConf, colors: noColors, isYes: false },
                               { label: 'Yes', pct: yesPct, byConf: yesByConf, colors: yesColors, isYes: true }];

                          return (
                            <div className="space-y-1">
                              {rows.map(row => {
                                const isUser = row.isYes ? userAnswer === 0 : userAnswer === 1;
                                return (
                                  <div key={row.label} className="flex items-center gap-1">
                                    <div className="w-14 sm:w-12 flex-shrink-0">
                                      <span className="text-base sm:text-sm font-semibold px-1.5 py-0.5 rounded-full border" style={{ color: row.colors[1], borderColor: isUser ? row.colors[1] : 'transparent' }}>{row.label}</span>
                                    </div>
                                    <span className="text-base sm:text-sm w-8 sm:w-7 font-bold text-right" style={{ color: row.colors[1] }}>{row.pct}</span>
                                    {renderCenteredBar(row.byConf, row.colors, maxCount, isUser)}
                                  </div>
                                );
                              })}
                              <div className={`text-sm text-center pt-1 ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>Tap to Expand</div>
                            </div>
                          );
                        })() : (() => {
                          /* MC: show user's pick + top pick, tap to expand all */
                          const optionData = {};
                          (browseResults?.evaluators || []).forEach(e => {
                            if (!optionData[e.answer]) optionData[e.answer] = { total: 0, byConf: [0, 0, 0, 0] };
                            optionData[e.answer].total++;
                            const conf = Math.min(4, Math.max(1, e.confidence || 1)) - 1;
                            optionData[e.answer].byConf[conf]++;
                          });

                          const sorted = Object.entries(optionData).sort((a, b) => b[1].total - a[1].total);
                          const topIdx = parseInt(sorted[0]?.[0] || 0);
                          const secondIdx = parseInt(sorted[1]?.[0] || 0);
                          const showSecond = userAnswer === topIdx ? secondIdx : topIdx;
                          const maxCount = sorted[0]?.[1]?.total || 1;

                          const userPct = Math.round(((optionData[userAnswer]?.total || 0) / total) * 100);
                          const otherPct = Math.round(((optionData[showSecond]?.total || 0) / total) * 100);

                          // Use actual MC_COLORS for each answer
                          const userColors = MC_COLORS[userAnswer % MC_COLORS.length].shades;
                          const otherColors = MC_COLORS[showSecond % MC_COLORS.length].shades;

                          const renderRow = (idx, colors, pct, isUser) => {
                            const data = optionData[idx] || { total: 0, byConf: [0, 0, 0, 0] };
                            const label = browseQ.options?.[idx] || '?';
                            return (
                              <div key={idx} className="flex items-center gap-1">
                                <div style={{ width: '40%' }} className="flex-shrink-0">
                                  <span className="text-base sm:text-sm font-semibold inline-block truncate max-w-full px-1.5 py-0.5 rounded-full border" style={{ color: colors[1], borderColor: isUser ? colors[1] : 'transparent' }}>{label}</span>
                                </div>
                                <span className="text-base sm:text-sm w-8 sm:w-7 font-bold text-right" style={{ color: colors[1] }}>{pct}</span>
                                {renderCenteredBar(data.byConf, colors, maxCount, isUser)}
                              </div>
                            );
                          };

                          const rowsOrdered = userPct >= otherPct
                            ? [{ idx: userAnswer, colors: userColors, pct: userPct, isUser: true },
                               { idx: showSecond, colors: otherColors, pct: otherPct, isUser: false }]
                            : [{ idx: showSecond, colors: otherColors, pct: otherPct, isUser: false },
                               { idx: userAnswer, colors: userColors, pct: userPct, isUser: true }];

                          return (
                            <div className="space-y-1">
                              {rowsOrdered.map(r => renderRow(r.idx, r.colors, r.pct, r.isUser))}
                              <div className={`text-sm text-center pt-1 ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>Tap to Expand</div>
                            </div>
                          );
                        })()}
                      </div>
                      <div
                        className={`h-px mt-2 cursor-pointer ${darkMode ? 'bg-gray-700' : 'bg-gray-300'}`}
                        onClick={() => {
                          if (pendingSubmit) { handleUndo(); return; }
                          setCommunityExpanded(true);
                        }}
                      />

                      {/* Expanded slide-up panel */}
                      {communityExpanded && (() => {
                        const allRows = [];

                        if (isBinaryQ) {
                          const yesColors = ['#6ee7b7', '#34d399', '#10b981', '#059669'];
                          const noColors = ['#fca5a5', '#f87171', '#ef4444', '#dc2626'];
                          const yesByConf = [0, 0, 0, 0];
                          const noByConf = [0, 0, 0, 0];
                          (browseResults?.evaluators || []).forEach(e => {
                            const conf = Math.min(4, Math.max(1, e.confidence || 1)) - 1;
                            if (e.answer === 0) yesByConf[conf]++;
                            else noByConf[conf]++;
                          });
                          const yesTotal = yesByConf.reduce((a, b) => a + b, 0);
                          const noTotal = noByConf.reduce((a, b) => a + b, 0);
                          const yesPct = Math.round((yesTotal / total) * 100);
                          const noPct = 100 - yesPct;
                          const maxCount = Math.max(yesTotal, noTotal);

                          allRows.push({ label: 'Yes', pct: yesPct, byConf: yesByConf, colors: yesColors, isUser: userAnswer === 0, maxCount });
                          allRows.push({ label: 'No', pct: noPct, byConf: noByConf, colors: noColors, isUser: userAnswer === 1, maxCount });
                          allRows.sort((a, b) => b.pct - a.pct);
                        } else {
                          // MC: show ALL options
                          const optionData = {};
                          (browseResults?.evaluators || []).forEach(e => {
                            if (!optionData[e.answer]) optionData[e.answer] = { total: 0, byConf: [0, 0, 0, 0] };
                            optionData[e.answer].total++;
                            const conf = Math.min(4, Math.max(1, e.confidence || 1)) - 1;
                            optionData[e.answer].byConf[conf]++;
                          });
                          const maxCount = Math.max(...Object.values(optionData).map(d => d.total), 1);

                          // Add all options, sorted by votes
                          browseQ.options?.forEach((opt, idx) => {
                            const data = optionData[idx] || { total: 0, byConf: [0, 0, 0, 0] };
                            const pct = Math.round((data.total / total) * 100);
                            const colors = MC_COLORS[idx % MC_COLORS.length].shades;
                            allRows.push({ label: opt, pct, byConf: data.byConf, colors, isUser: userAnswer === idx, maxCount, idx });
                          });
                          allRows.sort((a, b) => b.pct - a.pct);
                        }

                        return (
                          <div
                            className="fixed inset-0 z-50"
                            onClick={() => setCommunityExpanded(false)}
                          >
                            {/* Slide-up panel - click anywhere closes */}
                            <div
                              className={`absolute bottom-0 left-0 right-0 rounded-t-2xl ${darkMode ? 'bg-gray-900' : 'bg-white'} shadow-2xl`}
                              style={{ animation: 'slideUp 0.2s ease-out' }}
                            >
                              {/* Header - matches compact style */}
                              <div className="flex items-center gap-2 px-4 pt-3 pb-1">
                                <span className={`text-sm font-black uppercase tracking-wide ${darkMode ? 'text-sky-300' : 'text-sky-500'}`}>LAST:</span>
                                <span className={`text-base truncate flex-1 font-medium ${darkMode ? 'text-gray-100' : 'text-gray-900'}`}>{browseQ.text}</span>
                                <span className={`text-sm ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>{total}</span>
                              </div>

                              {/* All rows - same format as compact */}
                              <div className="px-4 pb-4 pt-2 space-y-1">
                                {allRows.map((row, i) => (
                                  <div key={i} className="flex items-center gap-1">
                                    <div className={isBinaryQ ? 'w-14 sm:w-12' : 'w-[40%]'} style={{ flexShrink: 0 }}>
                                      <span className="text-base sm:text-sm font-semibold inline-block truncate max-w-full px-1.5 py-0.5 rounded-full border"
                                        style={{ color: row.colors[1], borderColor: row.isUser ? row.colors[1] : 'transparent' }}>
                                        {row.label}
                                      </span>
                                    </div>
                                    <span className="text-base sm:text-sm w-8 sm:w-7 font-bold text-right" style={{ color: row.colors[1] }}>{row.pct}</span>
                                    {renderCenteredBar(row.byConf, row.colors, row.maxCount, row.isUser)}
                                  </div>
                                ))}
                              </div>

                              {/* Tap hint */}
                              <div className={`text-sm text-center pb-4 ${darkMode ? 'text-gray-600' : 'text-gray-400'}`}>
                                tap anywhere to close
                              </div>
                            </div>
                          </div>
                        );
                      })()}
                    </div>
                  );
                })()}
              </div>
            </div>
          </>
        )}

        {/* Full Results Modal */}
        {showFullResults && (() => {
          const answeredList = questions
            .filter(q => responses[q.id] && communityResults[q.id])
            .sort((a, b) => (responses[b.id]?.timestamp || 0) - (responses[a.id]?.timestamp || 0));
          const currentIdx = answeredList.findIndex(q => q.id === showFullResults.question.id);
          const goTo = (idx) => {
            if (idx >= 0 && idx < answeredList.length) {
              const q = answeredList[idx];
              setShowFullResults({ question: q, results: communityResults[q.id], response: responses[q.id] });
            }
          };
          return (
            <FullResultsPanel
              question={showFullResults.question}
              results={showFullResults.results}
              userResponse={showFullResults.response}
              darkMode={darkMode}
              onClose={() => setShowFullResults(null)}
              onSwipeLeft={() => goTo(currentIdx + 1)}
              onSwipeRight={() => goTo(currentIdx - 1)}
            />
          );
        })()}

        {/* Question Flag Modal */}
        {showQuestionFlagModal && (
          <QuestionFlagModal
            darkMode={darkMode}
            questionId={showQuestionFlagModal}
            onClose={() => setShowQuestionFlagModal(null)}
            onFlag={handleQuestionFlag}
            onClear={handleClearQuestionFlag}
            existingFlag={questionFlags[showQuestionFlagModal]}
          />
        )}

        {/* Explanation Modal */}
        {showExplanationModal && (
          <ExplanationModal
            darkMode={darkMode}
            questionId={showExplanationModal}
            onClose={() => setShowExplanationModal(null)}
            onSave={handleSaveExplanation}
            onClear={handleClearExplanation}
            existingExplanation={answerExplanations[showExplanationModal]}
          />
        )}

        {/* Can't Answer Modal (binary) */}
        {showCantAnswerModal && (
          <CantAnswerModal
            darkMode={darkMode}
            questionId={showCantAnswerModal}
            onClose={() => setShowCantAnswerModal(null)}
            onSkip={(qId, reason) => {
              setQuestionFlags(prev => ({ ...prev, [qId]: `Can't: ${reason}` }));
              setSkippedQuestions(prev => new Set([...prev, qId]));
              goToNext();
            }}
          />
        )}

        {/* None Option Modal (MC) */}
        {showNoneOptionModal && (
          <NoneOptionModal
            darkMode={darkMode}
            questionId={currentQuestion?.id}
            onClose={() => setShowNoneOptionModal(false)}
            onSubmit={(qId, answer) => {
              setQuestionFlags(prev => ({ ...prev, [qId]: `None fit: ${answer}` }));
              setSkippedQuestions(prev => new Set([...prev, qId]));
              goToNext();
            }}
          />
        )}
      </div>
    );
  };

  if (displayMode === 'desktop') {
    return (
      <>
        {/* Undo overlay - covers entire viewport during ANY pending state */}
        {pendingSubmit && (
          <div
            className="fixed inset-0 z-[9999] bg-transparent"
            onClick={handleUndo}
            onMouseDown={handleUndo}
            style={{ cursor: 'pointer', background: 'transparent' }}
          />
        )}
        <PhoneFrame darkMode={darkMode}>
          {/* Global stars background for dark mode */}
          {darkMode && <div className="global-stars" />}
          <div className="flex-1 flex flex-col overflow-hidden">
            {screen !== 'launch' && screen !== 'settings' && screen !== 'categories' && (
              <NavBar darkMode={darkMode} stats={stats} showStreak={showStreak} onHome={() => setScreen('categories')} onDoubleClickHome={resetDemo} onSettings={goToSettings} onProfile={() => setScreen('profile')} />
            )}
            {renderContent()}
          </div>
        </PhoneFrame>
      </>
    );
  }

  return (
    <div
      className={`h-full flex flex-col ${darkMode ? 'bg-gray-950' : 'bg-gray-50'}`}
      onClickCapture={(e) => {
        if (pendingSubmit) {
          e.stopPropagation();
          handleUndo();
        }
      }}
    >
      {/* Global stars background for dark mode */}
      {darkMode && <div className="global-stars" />}
      {screen !== 'launch' && screen !== 'settings' && screen !== 'categories' && (
        <div className="safe-top">
          <NavBar darkMode={darkMode} stats={stats} showStreak={showStreak} onHome={() => setScreen('categories')} onDoubleClickHome={resetDemo} onSettings={goToSettings} onProfile={() => setScreen('profile')} />
        </div>
      )}
      <div className="flex-1 flex flex-col overflow-hidden">{renderContent()}</div>
      <div className="safe-bottom" />
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
