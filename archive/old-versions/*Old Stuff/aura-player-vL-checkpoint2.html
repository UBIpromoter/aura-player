<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Aura">
  <meta name="theme-color" content="#030712">
  <title>Aura Player vI</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --sat: env(safe-area-inset-top);
      --sar: env(safe-area-inset-right);
      --sab: env(safe-area-inset-bottom);
      --sal: env(safe-area-inset-left);
    }
    html, body, #root {
      overflow: hidden;
      overscroll-behavior: none;
      -webkit-overflow-scrolling: touch;
      height: 100%;
      width: 100%;
      margin: 0;
      padding: 0;
      background: #030712;
    }
    * {
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
      box-sizing: border-box;
    }
    @media (prefers-color-scheme: dark) {
      :root { color-scheme: dark; }
    }
    .question-text {
      font-size: clamp(20px, 6vw, 28px);
      line-height: 1.35;
      text-wrap: balance;
    }
    .safe-top { padding-top: env(safe-area-inset-top); }
    .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
    @keyframes fill { from { width: 100%; } to { width: 0%; } }
    @keyframes shrink { from { width: 100%; } to { width: 0%; } }
    @keyframes barGrow { from { transform: scaleX(0); } to { transform: scaleX(1); } }
    @keyframes fadeSlideIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    @keyframes sweepFill { from { width: 0%; } to { width: 100%; } }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
const { useState, useEffect, useRef, useCallback } = React;

// ==================== DATA ====================
const CATEGORIES = [
  { id: 'prediction', name: 'Predictions', icon: 'ðŸ”®', color: 'amber' },
  { id: 'reasoning', name: 'Reasoning', icon: 'ðŸ§ ', color: 'violet' },
  { id: 'judgment', name: 'Judgment', icon: 'âš–ï¸', color: 'teal' },
];

const MC_COLORS = [
  { hex: '#3b82f6', name: 'blue', shades: ['#93c5fd', '#60a5fa', '#3b82f6', '#1e40af'], rgb: '59, 130, 246' },
  { hex: '#14b8a6', name: 'teal', shades: ['#5eead4', '#2dd4bf', '#14b8a6', '#0f766e'], rgb: '20, 184, 166' },
  { hex: '#22c55e', name: 'green', shades: ['#86efac', '#4ade80', '#22c55e', '#15803d'], rgb: '34, 197, 94' },
  { hex: '#ec4899', name: 'pink', shades: ['#f9a8d4', '#f472b6', '#ec4899', '#be185d'], rgb: '236, 72, 153' },
  { hex: '#8b5cf6', name: 'violet', shades: ['#c4b5fd', '#a78bfa', '#8b5cf6', '#6d28d9'], rgb: '139, 92, 246' },
];

const CONFIDENCE_LABELS = { 1: "Hunch", 2: "Leaning", 3: "Firm", 4: "Certain" };

// Question of the Day pool
const QOTD_POOL = [
  { type: 'binary', text: 'Should AI systems be required to identify themselves when interacting with humans?', sponsor: { name: 'AI Safety Institute', avatar: 'ðŸ›ï¸' }, distribution: { yes: [142, 287, 412, 389], no: [98, 156, 201, 162] } },
  { type: 'binary', text: 'Is universal basic income inevitable as automation increases?', sponsor: { name: 'Future of Work Foundation', avatar: 'ðŸ¤–' }, distribution: { yes: [198, 312, 287, 245], no: [156, 234, 189, 167] } },
  { type: 'binary', text: 'Should social media platforms be held liable for user-generated content?', sponsor: { name: 'Digital Rights Coalition', avatar: 'ðŸ“±' }, distribution: { yes: [167, 234, 312, 278], no: [189, 267, 234, 198] } },
  { type: 'binary', text: 'Will humans establish a permanent Mars colony by 2050?', sponsor: { name: 'Space Exploration Society', avatar: 'ðŸš€' }, distribution: { yes: [123, 198, 234, 167], no: [234, 312, 289, 256] } },
  { type: 'multiple', text: 'What will be the dominant AI interface by 2030?', options: ['Text chat', 'Voice assistants', 'AR/VR agents', 'Brain-computer interfaces'], sponsor: { name: 'Future Tech Institute', avatar: 'ðŸ”®' }, distribution: [[89, 145, 178, 134], [112, 189, 234, 198], [67, 98, 123, 89], [34, 56, 67, 45]] },
  { type: 'binary', text: 'Should voting be mandatory in democratic countries?', sponsor: { name: 'Civic Engagement Alliance', avatar: 'ðŸ—³ï¸' }, distribution: { yes: [156, 223, 267, 198], no: [198, 289, 312, 234] } },
  { type: 'binary', text: 'Is privacy more important than national security?', sponsor: { name: 'Civil Liberties Union', avatar: 'ðŸ”’' }, distribution: { yes: [189, 267, 312, 256], no: [145, 212, 234, 189] } },
  { type: 'multiple', text: 'What gives life the most meaning?', options: ['Relationships', 'Achievement', 'Pleasure', 'Purpose/contribution'], sponsor: { name: 'Philosophy Foundation', avatar: 'ðŸ¤”' }, distribution: [[178, 267, 334, 289], [89, 134, 167, 145], [56, 78, 89, 67], [123, 189, 234, 198]] },
  { type: 'binary', text: 'Should gene editing for disease prevention be allowed in humans?', sponsor: { name: 'Bioethics Council', avatar: 'ðŸ§¬' }, distribution: { yes: [212, 334, 378, 312], no: [98, 156, 178, 145] } },
  { type: 'multiple', text: 'Most important skill for the next decade?', options: ['AI/ML literacy', 'Critical thinking', 'Emotional intelligence', 'Adaptability'], sponsor: { name: 'Future Skills Lab', avatar: 'ðŸŽ¯' }, distribution: [[145, 212, 267, 223], [167, 245, 312, 267], [98, 145, 178, 145], [112, 178, 223, 189]] },
  { type: 'binary', text: 'Will AGI (Artificial General Intelligence) be achieved by 2035?', sponsor: { name: 'AI Research Consortium', avatar: 'ðŸ§ ' }, distribution: { yes: [145, 212, 234, 189], no: [178, 267, 289, 245] } },
];

const getRandomQOTD = () => {
  const q = QOTD_POOL[Math.floor(Math.random() * QOTD_POOL.length)];
  let totalResponses;
  if (q.type === 'binary') {
    totalResponses = q.distribution.yes.reduce((a, b) => a + b, 0) + q.distribution.no.reduce((a, b) => a + b, 0);
  } else {
    totalResponses = q.distribution.reduce((sum, opt) => sum + opt.reduce((a, b) => a + b, 0), 0);
  }
  return {
    id: `qotd-${Date.now()}`,
    day: 147 + Math.floor(Math.random() * 50),
    text: q.text,
    type: q.type || 'binary',
    options: q.options || null,
    sponsor: q.sponsor,
    reward: 25,
    endsAt: new Date().setHours(23, 59, 59, 999),
    totalResponses,
    distribution: q.distribution,
  };
};

const getQotdTimeRemaining = () => {
  const now = new Date();
  const end = new Date();
  end.setHours(23, 59, 59, 999);
  const diff = end - now;
  const hours = Math.floor(diff / (1000 * 60 * 60));
  const mins = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
  return `${hours}h ${mins}m`;
};

const QUESTIONS = [
  // ========== ORIGINAL 40 ==========
  { id: 1, type: 'binary', text: "Will Bitcoin exceed $150,000 before July 2026?", category: "prediction", preEvidence: [{ type: 'stat', label: 'Current Price', value: '$97,234' }, { type: 'stat', label: 'ATH', value: '$108,786' }] },
  { id: 2, type: 'multiple', text: "Is a hot dog a sandwich?", category: "reasoning", options: ["Yes, it's bread with filling", "No, it's its own category", "It's a taco (single folded bread)", "Depends on regional definition"], preEvidence: [{ type: 'note', text: 'Merriam-Webster: sandwich = "two or more slices of bread with filling"' }] },
  { id: 3, type: 'binary', text: "Will GPT-5 be released before September 2026?", category: "prediction", preEvidence: [{ type: 'stat', label: 'GPT-4 Release', value: 'March 2023' }] },
  { id: 4, type: 'multiple', text: "Which animal would win in a fight?", category: "judgment", options: ["100 duck-sized horses", "1 horse-sized duck", "It depends on the terrain", "They'd become friends"] },
  { id: 5, type: 'binary', text: "Is this research methodology sound? (Deepfake detection, n=50)", category: "judgment", preEvidence: [{ type: 'stat', label: 'Sample Size', value: 'n=50' }, { type: 'stat', label: 'Claimed Accuracy', value: '95%' }] },
  { id: 6, type: 'multiple', text: "What will be the dominant AI interface by 2030?", category: "prediction", options: ["Text chat", "Voice assistants", "AR/VR agents", "Brain-computer interfaces", "Autonomous agents"] },
  { id: 7, type: 'binary', text: "Is water wet?", category: "reasoning", preEvidence: [{ type: 'note', text: 'Wet = covered in water. Can water cover itself?' }] },
  { id: 8, type: 'multiple', text: "Best programming language for beginners in 2026?", category: "judgment", options: ["Python", "JavaScript", "Scratch/visual coding", "Natural language (AI-assisted)", "Rust"] },
  { id: 9, type: 'binary', text: "Will humans land on Mars before 2035?", category: "prediction", preEvidence: [{ type: 'stat', label: 'SpaceX target', value: '2029' }, { type: 'stat', label: 'NASA target', value: '2040' }] },
  { id: 10, type: 'multiple', text: "Is a Pop-Tart a ravioli?", category: "reasoning", options: ["Yes - filling enclosed in carb wrapper", "No - ravioli must be savory", "No - ravioli must be pasta", "It's actually a dumpling"] },
  { id: 11, type: 'binary', text: "Could an average person beat a goose in a fight?", category: "judgment", preEvidence: [{ type: 'stat', label: 'Avg goose weight', value: '8-14 lbs' }] },
  { id: 12, type: 'multiple', text: "Most likely cause of human extinction?", category: "prediction", options: ["AI/technology", "Climate change", "Pandemic/bioweapon", "Nuclear war", "Asteroid impact"] },
  { id: 13, type: 'binary', text: "Will Taylor Swift announce retirement before 2030?", category: "prediction" },
  { id: 14, type: 'multiple', text: "What should happen to daylight saving time?", category: "judgment", options: ["Keep switching twice a year", "Permanent daylight time", "Permanent standard time", "Let each state decide"] },
  { id: 15, type: 'binary', text: "Will lab-grown meat achieve price parity by 2028?", category: "prediction", preEvidence: [{ type: 'stat', label: '2013 cost', value: '$330,000/burger' }, { type: 'stat', label: '2025 cost', value: '$6/burger' }] },
  { id: 16, type: 'binary', text: "Could Batman beat Superman (no prep, no kryptonite)?", category: "judgment" },
  { id: 17, type: 'multiple', text: "Ship of Theseus: replace every part, same ship?", category: "reasoning", options: ["Yes - continuity of identity", "No - it's a new ship", "The original uses old parts", "Identity is an illusion"] },
  { id: 18, type: 'binary', text: "Will any AI pass an 8-hour Turing test by 2027?", category: "prediction" },
  { id: 19, type: 'binary', text: "Is the simulation hypothesis likely?", category: "reasoning", preEvidence: [{ type: 'note', text: "Bostrom's trilemma argument" }] },
  { id: 20, type: 'multiple', text: "Most important skill for the next decade?", category: "judgment", options: ["AI/ML literacy", "Critical thinking", "Emotional intelligence", "Adaptability", "Domain expertise"] },
  { id: 21, type: 'binary', text: "Is 847 + 256 greater than 1100?", category: "reasoning" },
  { id: 22, type: 'multiple', text: "What color results from mixing red + blue?", category: "reasoning", options: ["Green", "Purple", "Orange", "Brown"] },
  { id: 23, type: 'binary', text: "Does 'rhythm' contain a vowel (a,e,i,o,u)?", category: "reasoning" },
  { id: 24, type: 'multiple', text: "What comes next: 2, 4, 8, 16, __?", category: "reasoning", options: ["24", "32", "20", "18"] },
  { id: 25, type: 'binary', text: "Is Australia larger than Europe (by land area)?", category: "reasoning" },
  { id: 26, type: 'binary', text: "Will electric vehicles exceed 50% of US new car sales by 2030?", category: "prediction", preEvidence: [{ type: 'stat', label: '2024 US EV share', value: '~9%' }] },
  { id: 27, type: 'multiple', text: "Which company will dominate AI by 2030?", category: "prediction", options: ["OpenAI", "Google/DeepMind", "Anthropic", "Meta", "A company that doesn't exist yet"] },
  { id: 28, type: 'binary', text: "Is free will an illusion?", category: "reasoning" },
  { id: 29, type: 'multiple', text: "What's the most ethical diet?", category: "judgment", options: ["Vegan", "Vegetarian", "Pescatarian", "Local/sustainable omnivore", "Lab-grown meat when available"] },
  { id: 30, type: 'binary', text: "Will remote work remain dominant in tech by 2030?", category: "prediction" },
  { id: 31, type: 'binary', text: "Should social media require age verification?", category: "judgment" },
  { id: 32, type: 'multiple', text: "Most overrated tech of the 2020s?", category: "judgment", options: ["NFTs", "Metaverse/VR", "Crypto/blockchain", "AI assistants", "Self-driving cars"] },
  { id: 33, type: 'binary', text: "Will quantum computers break current encryption by 2035?", category: "prediction" },
  { id: 34, type: 'binary', text: "Is cereal a soup?", category: "reasoning" },
  { id: 35, type: 'multiple', text: "Best way to make friends as an adult?", category: "judgment", options: ["Hobbies/clubs", "Through work", "Apps (Bumble BFF, etc.)", "Neighbors/community", "Accept loneliness"] },
  { id: 36, type: 'binary', text: "Is 17 a prime number?", category: "reasoning" },
  { id: 37, type: 'multiple', text: "What is âˆš144?", category: "reasoning", options: ["10", "11", "12", "14"] },
  { id: 38, type: 'binary', text: "Is the Pacific Ocean the largest ocean?", category: "reasoning" },
  { id: 39, type: 'binary', text: "Will a woman be elected US President by 2032?", category: "prediction" },
  { id: 40, type: 'multiple', text: "What age should you be allowed to vote?", category: "judgment", options: ["16", "18", "21", "25", "Any age"] },

  // ========== PREDICTIONS (41-80) ==========
  { id: 41, type: 'binary', text: "Will China's GDP surpass the US by 2035?", category: "prediction", preEvidence: [{ type: 'stat', label: 'US GDP (2024)', value: '$28.8T' }, { type: 'stat', label: 'China GDP (2024)', value: '$18.5T' }] },
  { id: 42, type: 'binary', text: "Will commercial fusion power be operational by 2040?", category: "prediction" },
  { id: 43, type: 'multiple', text: "Which country will lead in AI development by 2035?", category: "prediction", options: ["United States", "China", "European Union", "India", "Distributed/No single leader"] },
  { id: 44, type: 'binary', text: "Will Neuralink have 1,000+ human users by 2030?", category: "prediction", preEvidence: [{ type: 'stat', label: 'First implant', value: 'January 2024' }] },
  { id: 45, type: 'binary', text: "Will global population decline before 2100?", category: "prediction", preEvidence: [{ type: 'stat', label: 'UN projection', value: 'Peak ~10.4B in 2086' }] },
  { id: 46, type: 'multiple', text: "What will cause the next major financial crisis?", category: "prediction", options: ["AI displacement", "Climate disasters", "Sovereign debt", "Crypto collapse", "Geopolitical conflict"] },
  { id: 47, type: 'binary', text: "Will autonomous vehicles be legal in all US states by 2030?", category: "prediction" },
  { id: 48, type: 'binary', text: "Will the US return to the Moon before China?", category: "prediction", preEvidence: [{ type: 'stat', label: 'Artemis III target', value: '2026' }, { type: 'stat', label: 'China target', value: '2030' }] },
  { id: 49, type: 'multiple', text: "What will be the #1 cause of death globally in 2050?", category: "prediction", options: ["Heart disease", "Cancer", "Antimicrobial resistance", "Climate-related", "Mental health/suicide"] },
  { id: 50, type: 'binary', text: "Will any cryptocurrency become legal tender in a G7 nation by 2030?", category: "prediction" },
  { id: 51, type: 'binary', text: "Will average US home prices exceed $500k by 2030?", category: "prediction", preEvidence: [{ type: 'stat', label: '2024 median', value: '$420,000' }] },
  { id: 52, type: 'multiple', text: "Which social platform will have the most users in 2030?", category: "prediction", options: ["TikTok/ByteDance", "Instagram/Meta", "YouTube", "WeChat", "Something new"] },
  { id: 53, type: 'binary', text: "Will deepfakes influence a major election outcome by 2028?", category: "prediction" },
  { id: 54, type: 'binary', text: "Will antibiotics still be effective against most infections in 2040?", category: "prediction" },
  { id: 55, type: 'multiple', text: "What will happen to Twitter/X by 2030?", category: "prediction", options: ["Still dominant", "Acquired by another company", "Bankrupt/shut down", "Transformed into something else", "Niche platform"] },
  { id: 56, type: 'binary', text: "Will a major city become uninhabitable due to climate by 2050?", category: "prediction" },
  { id: 57, type: 'binary', text: "Will commercial space tourism have 10,000+ customers by 2035?", category: "prediction" },
  { id: 58, type: 'multiple', text: "Which industry will AI disrupt most by 2030?", category: "prediction", options: ["Healthcare", "Legal", "Education", "Finance", "Creative/Media"] },
  { id: 59, type: 'binary', text: "Will there be a manned mission to an asteroid by 2040?", category: "prediction" },
  { id: 60, type: 'binary', text: "Will the EU still exist in its current form in 2040?", category: "prediction" },
  { id: 61, type: 'multiple', text: "What will be the dominant energy source globally by 2050?", category: "prediction", options: ["Solar", "Nuclear (fission)", "Nuclear (fusion)", "Natural gas", "Mix with no dominant"] },
  { id: 62, type: 'binary', text: "Will life expectancy in developed nations exceed 90 by 2060?", category: "prediction" },
  { id: 63, type: 'binary', text: "Will AI-generated content be majority of internet content by 2035?", category: "prediction" },
  { id: 64, type: 'multiple', text: "How will most people commute in major cities in 2040?", category: "prediction", options: ["Personal EVs", "Public transit", "Autonomous ride-share", "E-bikes/scooters", "Remote work (no commute)"] },
  { id: 65, type: 'binary', text: "Will any tech company reach $10 trillion market cap by 2035?", category: "prediction", preEvidence: [{ type: 'stat', label: 'Apple (2024)', value: '~$3.5T' }] },
  { id: 66, type: 'binary', text: "Will lab-grown organs be standard medical practice by 2040?", category: "prediction" },
  { id: 67, type: 'multiple', text: "Which renewable will grow fastest 2025-2035?", category: "prediction", options: ["Solar", "Wind", "Geothermal", "Hydrogen", "Nuclear"] },
  { id: 68, type: 'binary', text: "Will physical cash be eliminated in any major economy by 2035?", category: "prediction" },
  { id: 69, type: 'binary', text: "Will we discover definitive evidence of extraterrestrial life by 2050?", category: "prediction" },
  { id: 70, type: 'multiple', text: "What will college education look like in 2040?", category: "prediction", options: ["Similar to now", "Mostly online", "AI-tutored/personalized", "Shorter/bootcamp style", "Obsolete/replaced by credentials"] },
  { id: 71, type: 'binary', text: "Will global meat consumption decline by 2035?", category: "prediction" },
  { id: 72, type: 'binary', text: "Will any country implement a 4-day work week nationally by 2030?", category: "prediction" },
  { id: 73, type: 'multiple', text: "What will be the next pandemic pathogen type?", category: "prediction", options: ["Influenza variant", "Coronavirus", "Bacterial", "Fungal", "Engineered/bioweapon"] },
  { id: 74, type: 'binary', text: "Will AGI (Artificial General Intelligence) exist by 2035?", category: "prediction" },
  { id: 75, type: 'binary', text: "Will the Arctic be ice-free in summer before 2040?", category: "prediction", preEvidence: [{ type: 'note', text: 'Ice extent declining ~13% per decade' }] },
  { id: 76, type: 'multiple', text: "What will replace smartphones as primary device?", category: "prediction", options: ["AR glasses", "Neural interfaces", "Smart watches", "Nothing/phones evolve", "AI agents (deviceless)"] },
  { id: 77, type: 'binary', text: "Will India become a top 3 global economy by 2030?", category: "prediction", preEvidence: [{ type: 'stat', label: 'Current rank', value: '#5' }] },
  { id: 78, type: 'binary', text: "Will most new music be AI-generated by 2035?", category: "prediction" },
  { id: 79, type: 'multiple', text: "What will happen to housing costs in major cities by 2035?", category: "prediction", options: ["Continue rising", "Plateau", "Decline significantly", "Bifurcate (luxury vs affordable)", "Government intervention stabilizes"] },
  { id: 80, type: 'binary', text: "Will autonomous ships handle majority of global shipping by 2040?", category: "prediction" },

  // ========== PHILOSOPHY (81-115) ==========
  { id: 81, type: 'binary', text: "Can a teleporter that destroys and recreates you preserve your identity?", category: "reasoning" },
  { id: 82, type: 'multiple', text: "What makes an action morally right?", category: "reasoning", options: ["Consequences (utilitarianism)", "Intent (deontology)", "Character (virtue ethics)", "Social contract", "Nothing objective"] },
  { id: 83, type: 'binary', text: "Is it ethical to create sentient AI?", category: "reasoning" },
  { id: 84, type: 'binary', text: "Does the trolley problem have a correct answer?", category: "reasoning", preEvidence: [{ type: 'note', text: 'Pull lever to save 5, killing 1?' }] },
  { id: 85, type: 'multiple', text: "What is the nature of consciousness?", category: "reasoning", options: ["Physical brain processes", "Emergent property", "Fundamental like mass/charge", "Illusion", "Unknowable"] },
  { id: 86, type: 'binary', text: "Is mathematics discovered (not invented)?", category: "reasoning" },
  { id: 87, type: 'binary', text: "Can machines ever truly understand (not just simulate)?", category: "reasoning" },
  { id: 88, type: 'multiple', text: "What gives life meaning?", category: "reasoning", options: ["Relationships", "Achievement", "Pleasure", "Purpose/contribution", "Nothing inherent"] },
  { id: 89, type: 'binary', text: "Is it wrong to eat animals if alternatives exist?", category: "reasoning" },
  { id: 90, type: 'binary', text: "Would you take a pill that makes you perpetually happy but delusional?", category: "reasoning" },
  { id: 91, type: 'multiple', text: "If you could live forever, would you want to?", category: "reasoning", options: ["Yes, unconditionally", "Yes, with exit option", "Only if others could too", "No, death gives meaning", "Depends on quality of life"] },
  { id: 92, type: 'binary', text: "Is privacy a fundamental right?", category: "reasoning" },
  { id: 93, type: 'binary', text: "Are humans fundamentally good?", category: "reasoning" },
  { id: 94, type: 'multiple', text: "What is the self?", category: "reasoning", options: ["Continuous soul/essence", "Pattern of memories", "Illusion", "Body/brain", "Social construction"] },
  { id: 95, type: 'binary', text: "Is it ethical to gene-edit embryos to prevent disease?", category: "reasoning" },
  { id: 96, type: 'binary', text: "Can something be art if created by accident?", category: "reasoning" },
  { id: 97, type: 'multiple', text: "What matters more: intention or outcome?", category: "reasoning", options: ["Intention always", "Outcome always", "Depends on context", "Both equally", "Neither/virtue matters"] },
  { id: 98, type: 'binary', text: "Is a perfect simulation of a person the same as that person?", category: "reasoning" },
  { id: 99, type: 'binary', text: "Do animals have rights?", category: "reasoning" },
  { id: 100, type: 'multiple', text: "Why is there something rather than nothing?", category: "reasoning", options: ["God/creator", "Physical necessity", "Anthropic principle", "Brute fact", "Question is meaningless"] },
  { id: 101, type: 'binary', text: "Is time travel logically possible?", category: "reasoning" },
  { id: 102, type: 'binary', text: "Can we ever truly know another person's mind?", category: "reasoning" },
  { id: 103, type: 'multiple', text: "What makes someone the 'same person' over time?", category: "reasoning", options: ["Physical continuity", "Memory continuity", "Personality", "Soul", "Legal/social recognition"] },
  { id: 104, type: 'binary', text: "Is it ethical to bring children into a world with suffering?", category: "reasoning" },
  { id: 105, type: 'binary', text: "Can art be objectively evaluated?", category: "reasoning" },
  { id: 106, type: 'multiple', text: "What is truth?", category: "reasoning", options: ["Correspondence to reality", "Coherence with beliefs", "What works (pragmatism)", "Social consensus", "Unknowable"] },
  { id: 107, type: 'binary', text: "Is laziness a vice?", category: "reasoning" },
  { id: 108, type: 'binary', text: "Would you want to know the exact date of your death?", category: "reasoning" },
  { id: 109, type: 'multiple', text: "Is a calorie-restricted long life better than a shorter indulgent one?", category: "reasoning", options: ["Long life always better", "Short indulgent better", "Depends on the person", "Quality > quantity", "False dichotomy"] },
  { id: 110, type: 'binary', text: "Is cultural appropriation always wrong?", category: "reasoning" },
  { id: 111, type: 'binary', text: "Can evil actions ever be justified by good outcomes?", category: "reasoning" },
  { id: 112, type: 'multiple', text: "What is the purpose of punishment?", category: "reasoning", options: ["Deterrence", "Rehabilitation", "Retribution", "Public safety", "No valid purpose"] },
  { id: 113, type: 'binary', text: "Is ignorance ever bliss?", category: "reasoning" },
  { id: 114, type: 'binary', text: "Do we have moral obligations to future generations?", category: "reasoning" },
  { id: 115, type: 'multiple', text: "Is a lie ever morally required?", category: "reasoning", options: ["Never", "To prevent harm", "To protect feelings", "In war/self-defense", "Lies are neutral tools"] },

  // ========== DEBATES (116-150) ==========
  { id: 116, type: 'binary', text: "Should billionaires exist?",  category: "judgment" },
  { id: 117, type: 'multiple', text: "What's the best economic system?", category: "judgment", options: ["Capitalism", "Socialism", "Mixed economy", "Something new", "Depends on context"] },
  { id: 118, type: 'binary', text: "Should college be free?", category: "judgment" },
  { id: 119, type: 'binary', text: "Is cancel culture a net positive?", category: "judgment" },
  { id: 120, type: 'multiple', text: "How should AI be regulated?", category: "judgment", options: ["Strict government control", "Industry self-regulation", "International treaty", "Minimal regulation", "Case-by-case basis"] },
  { id: 121, type: 'binary', text: "Should voting be mandatory?", category: "judgment", preEvidence: [{ type: 'stat', label: 'Australia turnout', value: '~95%' }] },
  { id: 122, type: 'binary', text: "Is the death penalty ever justified?", category: "judgment" },
  { id: 123, type: 'multiple', text: "What should be done about illegal immigration?", category: "judgment", options: ["Open borders", "Path to citizenship", "Stricter enforcement", "Guest worker programs", "Address root causes"] },
  { id: 124, type: 'binary', text: "Should drugs be decriminalized?", category: "judgment" },
  { id: 125, type: 'binary', text: "Is universal basic income a good idea?", category: "judgment" },
  { id: 126, type: 'multiple', text: "Who should control the internet?", category: "judgment", options: ["Governments", "Private companies", "International body", "Decentralized/no one", "Users collectively"] },
  { id: 127, type: 'binary', text: "Should hate speech be illegal?", category: "judgment" },
  { id: 128, type: 'binary', text: "Is affirmative action justified?", category: "judgment" },
  { id: 129, type: 'multiple', text: "What's the right approach to climate policy?", category: "judgment", options: ["Carbon tax", "Regulations/mandates", "Subsidies for green tech", "Nuclear expansion", "Adaptation focus"] },
  { id: 130, type: 'binary', text: "Should assisted suicide be legal?", category: "judgment" },
  { id: 131, type: 'binary', text: "Are private schools harmful to public education?", category: "judgment" },
  { id: 132, type: 'multiple', text: "How should we handle wealth inequality?",  category: "judgment", options: ["Progressive taxation", "Wealth caps", "Universal services", "Education/opportunity", "It's not a problem"] },
  { id: 133, type: 'binary', text: "Should AI art be copyrightable?", category: "judgment" },
  { id: 134, type: 'binary', text: "Is nationalism inherently dangerous?", category: "judgment" },
  { id: 135, type: 'multiple', text: "What should replace prisons?", category: "judgment", options: ["Nothing - reform prisons", "Rehabilitation centers", "Restorative justice", "Electronic monitoring", "Community service"] },
  { id: 136, type: 'binary', text: "Should parents be able to select embryos for traits?", category: "judgment" },
  { id: 137, type: 'binary', text: "Is a global government desirable?", category: "judgment" },
  { id: 138, type: 'multiple', text: "How should gig workers be classified?", category: "judgment", options: ["Employees", "Contractors", "New category", "Worker's choice", "Depends on the job"] },
  { id: 139, type: 'binary', text: "Should tech companies be broken up?", category: "judgment" },
  { id: 140, type: 'binary', text: "Is zoning reform the solution to housing costs?", category: "judgment" },
  { id: 141, type: 'multiple', text: "What's the best voting system?", category: "judgment", options: ["First-past-the-post", "Ranked choice", "Proportional representation", "Approval voting", "Sortition (random selection)"] },
  { id: 142, type: 'binary', text: "Should there be limits on free speech online?", category: "judgment" },
  { id: 143, type: 'binary', text: "Is meritocracy a myth?", category: "judgment" },
  { id: 144, type: 'multiple', text: "How should social media moderate content?", category: "judgment", options: ["Government oversight", "Platform discretion", "User-controlled filters", "No moderation", "Community-based moderation"] },
  { id: 145, type: 'binary', text: "Should voting age be lowered to 16?", category: "judgment" },
  { id: 146, type: 'binary', text: "Are unions still necessary?", category: "judgment" },
  { id: 147, type: 'multiple', text: "What's the solution to political polarization?", category: "judgment", options: ["Media reform", "Education", "Electoral reform", "Economic equality", "No solution exists"] },
  { id: 148, type: 'binary', text: "Should wealthy nations pay climate reparations?", category: "judgment" },
  { id: 149, type: 'binary', text: "Is remote work better for society overall?", category: "judgment" },
  { id: 150, type: 'multiple', text: "How should we handle misinformation?", category: "judgment", options: ["Government regulation", "Platform labels/removal", "Media literacy education", "Let marketplace decide", "Impossible to solve"] },

  // ========== OPINIONS (151-190) ==========
  { id: 151, type: 'multiple', text: "What's the best decade for music?", category: "judgment", options: ["1960s", "1970s", "1980s", "1990s", "2000s+"] },
  { id: 152, type: 'binary', text: "Is working from home better than office work?", category: "judgment" },
  { id: 153, type: 'multiple', text: "What's the ideal vacation length?", category: "judgment", options: ["Long weekend (3-4 days)", "One week", "Two weeks", "One month+", "Frequent short trips"] },
  { id: 154, type: 'binary', text: "Are audiobooks as good as reading?", category: "judgment" },
  { id: 155, type: 'multiple', text: "What's the best coffee preparation?", category: "judgment", options: ["Espresso", "Pour over", "French press", "Drip", "Cold brew"] },
  { id: 156, type: 'binary', text: "Is buying a home better than renting?", category: "judgment" },
  { id: 157, type: 'multiple', text: "What's the ideal number of children?", category: "judgment", options: ["Zero", "One", "Two", "Three", "Four+"] },
  { id: 158, type: 'binary', text: "Are open offices a bad idea?",  category: "judgment" },
  { id: 159, type: 'multiple', text: "What's the best way to exercise?", category: "judgment", options: ["Gym/weights", "Running/cardio", "Sports/games", "Yoga/flexibility", "Walking"] },
  { id: 160, type: 'binary', text: "Is social media net negative for society?", category: "judgment" },
  { id: 161, type: 'multiple', text: "What's the ideal work schedule?", category: "judgment", options: ["9-5, five days", "4-day week", "Flexible hours", "Results-only", "Varies by person"] },
  { id: 162, type: 'binary', text: "Are video games a waste of time?", category: "judgment" },
  { id: 163, type: 'multiple', text: "What's the best pet for a busy person?", category: "judgment", options: ["Cat", "Dog", "Fish", "No pet", "Low-maintenance reptile"] },
  { id: 164, type: 'binary', text: "Should you always follow your passion for a career?", category: "judgment" },
  { id: 165, type: 'multiple', text: "What's the ideal retirement age?", category: "judgment", options: ["55", "60", "65", "70", "Never fully retire"] },
  { id: 166, type: 'binary', text: "Is a college degree still worth it?", category: "judgment" },
  { id: 167, type: 'multiple', text: "What's the best news source format?", category: "judgment", options: ["Print newspaper", "TV news", "Podcasts", "Social media", "News apps/aggregators"] },
  { id: 168, type: 'binary', text: "Are smartphones making us less intelligent?", category: "judgment" },
  { id: 169, type: 'multiple', text: "What's the ideal city size to live in?", category: "judgment", options: ["Small town (<50k)", "Medium city (50-500k)", "Large city (500k-2M)", "Major metro (2M+)", "Rural/countryside"] },
  { id: 170, type: 'binary', text: "Is it okay to ghost someone after a few dates?", category: "judgment" },
  { id: 171, type: 'multiple', text: "What's more important in a job?", category: "judgment", options: ["Salary", "Work-life balance", "Interesting work", "Good colleagues", "Career growth"] },
  { id: 172, type: 'binary', text: "Should you tell a friend their partner is cheating?", category: "judgment" },
  { id: 173, type: 'multiple', text: "What's the best breakfast?", category: "judgment", options: ["Continental (pastry/coffee)", "Full cooked breakfast", "Healthy (smoothie/oatmeal)", "Skip breakfast", "Whatever's available"] },
  { id: 174, type: 'binary', text: "Is it rude to recline your seat on a plane?", category: "judgment" },
  { id: 175, type: 'multiple', text: "What's the ideal age to get married?", category: "judgment", options: ["Early 20s", "Late 20s", "Early 30s", "35+", "Never/optional"] },
  { id: 176, type: 'binary', text: "Are reality TV shows harmful?", category: "judgment" },
  { id: 177, type: 'multiple', text: "What's the best streaming service?", category: "judgment", options: ["Netflix", "Disney+", "HBO Max", "Amazon Prime", "YouTube"] },
  { id: 178, type: 'binary', text: "Is tipping culture a good thing?", category: "judgment" },
  { id: 179, type: 'multiple', text: "What's more important: IQ or EQ?", category: "judgment", options: ["IQ", "EQ", "Both equally", "Neither/other factors", "Depends on context"] },
  { id: 180, type: 'binary', text: "Should you lend money to friends?", category: "judgment" },
  { id: 181, type: 'multiple', text: "What's the best way to learn a language?", category: "judgment", options: ["Apps (Duolingo)", "Classes", "Immersion", "Tutoring", "Media consumption"] },
  { id: 182, type: 'binary', text: "Is minimalism a superior lifestyle?", category: "judgment" },
  { id: 183, type: 'multiple', text: "What makes a house a home?", category: "judgment", options: ["Family/people", "Personal belongings", "Time spent there", "Ownership", "Feeling of safety"] },
  { id: 184, type: 'binary', text: "Should couples combine finances?", category: "judgment" },
  { id: 185, type: 'multiple', text: "What's the ideal amount of sleep?", category: "judgment", options: ["5-6 hours", "7 hours", "8 hours", "9+ hours", "Varies by person"] },
  { id: 186, type: 'binary', text: "Is cold weather better than hot weather?", category: "judgment" },
  { id: 187, type: 'multiple', text: "What's the best time of day to work out?", category: "judgment", options: ["Early morning", "Late morning", "Lunchtime", "After work", "Evening"] },
  { id: 188, type: 'binary', text: "Are New Year's resolutions pointless?", category: "judgment" },
  { id: 189, type: 'multiple', text: "What's the ideal commute time?", category: "judgment", options: ["Under 10 min", "10-20 min", "20-30 min", "30-45 min", "No commute (remote)"] },
  { id: 190, type: 'binary', text: "Is being an early bird better than night owl?", category: "judgment" },

  // ========== EVALUATION (191-215) ==========
  { id: 191, type: 'binary', text: "Is this headline misleading? 'Study finds coffee drinkers live longer'", category: "judgment", preEvidence: [{ type: 'note', text: 'Correlation study, n=10,000, no controls for lifestyle' }] },
  { id: 192, type: 'multiple', text: "Rate this business pitch: 'Uber for dog walking'", category: "judgment", options: ["Strong - clear market", "Medium - competitive space", "Weak - already exists", "Need more info"] },
  { id: 193, type: 'binary', text: "Is this statistic meaningful? '90% of startups fail'", category: "judgment", preEvidence: [{ type: 'note', text: 'Definition of "fail" and timeframe vary widely' }] },
  { id: 194, type: 'binary', text: "Is this a valid argument? 'Most CEOs are tall, so being tall helps you succeed'", category: "judgment" },
  { id: 195, type: 'multiple', text: "Rate this excuse for being late: 'Traffic was bad'", category: "judgment", options: ["Completely valid", "Usually acceptable", "Weak excuse", "Unacceptable", "Depends on frequency"] },
  { id: 196, type: 'binary', text: "Is this claim verifiable? 'Our AI reduces costs by 40%'", category: "judgment" },
  { id: 197, type: 'multiple', text: "Rate this study design: Survey of 100 Twitter users about public opinion", category: "judgment", options: ["Strong methodology", "Acceptable with caveats", "Weak but usable", "Fundamentally flawed"] },
  { id: 198, type: 'binary', text: "Is this a conflict of interest? Nutrition study funded by food company", category: "judgment" },
  { id: 199, type: 'binary', text: "Is this photo likely AI-generated? (Perfect symmetry, 6 fingers)", category: "judgment" },
  { id: 200, type: 'multiple', text: "Rate this investment thesis: 'AI will replace all jobs, so invest in robots'", category: "judgment", options: ["Sound reasoning", "Partially valid", "Oversimplified", "Fundamentally wrong"] },
  { id: 201, type: 'binary', text: "Is this apology genuine? 'I'm sorry you feel that way'", category: "judgment" },
  { id: 202, type: 'binary', text: "Is this product review trustworthy? 5 stars, 3 words, verified purchase", category: "judgment" },
  { id: 203, type: 'multiple', text: "Rate this job posting: 'Fast-paced environment, wear many hats, competitive salary'", category: "judgment", options: ["Attractive opportunity", "Yellow flags", "Red flags", "Need more info"] },
  { id: 204, type: 'binary', text: "Is this a logical fallacy? 'Everyone's doing it, so it must be okay'", category: "judgment" },
  { id: 205, type: 'binary', text: "Is this sample size adequate? Medical trial with 50 participants", category: "judgment", preEvidence: [{ type: 'note', text: 'Testing rare disease treatment' }] },
  { id: 206, type: 'multiple', text: "Rate this dating profile: 'No drama, know what I want, fluent in sarcasm'", category: "judgment", options: ["Appealing", "Neutral", "Off-putting", "Depends on audience"] },
  { id: 207, type: 'binary', text: "Is this reasoning sound? 'Stock went up after I bought it, so I'm a good investor'", category: "judgment" },
  { id: 208, type: 'binary', text: "Is this email a scam? 'Urgent: Verify your account or lose access'", category: "judgment" },
  { id: 209, type: 'multiple', text: "Rate this restaurant review: '1 star - food was great but parking was hard'", category: "judgment", options: ["Fair rating", "Unfair rating", "Useful information", "Should be ignored"] },
  { id: 210, type: 'binary', text: "Is this correlation meaningful? 'Ice cream sales and drowning deaths both rise in summer'", category: "judgment" },
  { id: 211, type: 'binary', text: "Is this expertise relevant? Physicist commenting on economics", category: "judgment" },
  { id: 212, type: 'multiple', text: "Rate this prediction track record: 60% accuracy on binary outcomes", category: "judgment", options: ["Excellent", "Good", "Mediocre", "Poor", "Need more context"] },
  { id: 213, type: 'binary', text: "Is this source reliable? Wikipedia article with 50 citations", category: "judgment" },
  { id: 214, type: 'binary', text: "Is this a valid comparison? 'Company X is the Airbnb of Y industry'", category: "judgment" },
  { id: 215, type: 'multiple', text: "Rate this feedback: 'Good job, but could be better'", category: "judgment", options: ["Helpful", "Somewhat helpful", "Useless", "Harmful"] },

  // ========== LOGIC (216-240) ==========
  { id: 216, type: 'binary', text: "Is 2^10 greater than 1000?", category: "reasoning", preEvidence: [{ type: 'note', text: '2^10 = 1024' }] },
  { id: 217, type: 'multiple', text: "What comes next: 1, 1, 2, 3, 5, 8, __?", category: "reasoning", options: ["11", "12", "13", "15"] },
  { id: 218, type: 'binary', text: "Can a year have two Friday the 13ths?", category: "reasoning" },
  { id: 219, type: 'binary', text: "Is the sum of angles in a triangle always 180Â°?", category: "reasoning" },
  { id: 220, type: 'multiple', text: "How many states does the US have?", category: "reasoning", options: ["48", "50", "51", "52"] },
  { id: 221, type: 'binary', text: "Is the speed of light faster than the speed of sound?", category: "reasoning" },
  { id: 222, type: 'multiple', text: "What is 15% of 80?", category: "reasoning", options: ["10", "12", "15", "18"] },
  { id: 223, type: 'binary', text: "Can you fold a piece of paper more than 7 times?", category: "reasoning" },
  { id: 224, type: 'binary', text: "Is a tomato a fruit?", category: "reasoning" },
  { id: 225, type: 'multiple', text: "How many planets in our solar system?", category: "reasoning", options: ["7", "8", "9", "10"] },
  { id: 226, type: 'binary', text: "Is 0.999... (repeating) equal to 1?", category: "reasoning" },
  { id: 227, type: 'multiple', text: "What day follows Saturday?", category: "reasoning", options: ["Friday", "Sunday", "Monday", "Sabbath"] },
  { id: 228, type: 'binary', text: "Can a triangle have two right angles?", category: "reasoning" },
  { id: 229, type: 'binary', text: "Is Venus hotter than Mercury?", category: "reasoning", preEvidence: [{ type: 'note', text: 'Mercury is closer to the Sun' }] },
  { id: 230, type: 'multiple', text: "What is the square root of 169?", category: "reasoning", options: ["11", "12", "13", "14"] },
  { id: 231, type: 'binary', text: "Do all mammals give live birth?", category: "reasoning" },
  { id: 232, type: 'binary', text: "Is Ï€ (pi) a rational number?", category: "reasoning" },
  { id: 233, type: 'multiple', text: "How many sides does a hexagon have?", category: "reasoning", options: ["5", "6", "7", "8"] },
  { id: 234, type: 'binary', text: "Is Mount Everest the tallest mountain from base to peak?", category: "reasoning", preEvidence: [{ type: 'note', text: 'Consider Mauna Kea from ocean floor' }] },
  { id: 235, type: 'binary', text: "Can sound travel through a vacuum?", category: "reasoning" },
  { id: 236, type: 'multiple', text: "What is 7 Ã— 8?", category: "reasoning", options: ["54", "56", "58", "64"] },
  { id: 237, type: 'binary', text: "Is blue light higher energy than red light?", category: "reasoning" },
  { id: 238, type: 'binary', text: "Does water expand when it freezes?", category: "reasoning" },
  { id: 239, type: 'multiple', text: "How many degrees in a circle?", category: "reasoning", options: ["180", "270", "360", "400"] },
  { id: 240, type: 'binary', text: "Is a whale a fish?", category: "reasoning" },

  // ========== ADDITIONAL PREDICTIONS (241-280) ==========
  { id: 241, type: 'binary', text: "Will SpaceX successfully land humans on Mars by 2030?", category: "prediction" },
  { id: 242, type: 'multiple', text: "What will be the biggest tech IPO of 2027?", category: "prediction", options: ["OpenAI", "Stripe", "SpaceX", "Databricks", "Something unexpected"] },
  { id: 243, type: 'binary', text: "Will the US dollar lose reserve currency status by 2040?", category: "prediction" },
  { id: 244, type: 'binary', text: "Will longevity treatments extend average lifespan by 10+ years by 2050?", category: "prediction" },
  { id: 245, type: 'multiple', text: "Which emerging technology will have the biggest impact by 2035?", category: "prediction", options: ["Quantum computing", "Brain-computer interfaces", "Gene editing", "Nuclear fusion", "Robotics"] },
  { id: 246, type: 'binary', text: "Will there be a major cyber attack on US infrastructure by 2028?", category: "prediction" },
  { id: 247, type: 'binary', text: "Will Netflix still be the top streaming service in 2030?", category: "prediction" },
  { id: 248, type: 'multiple', text: "What will cause the next major tech layoff wave?", category: "prediction", options: ["AI automation", "Economic recession", "Regulatory crackdown", "Market saturation", "Geopolitical conflict"] },
  { id: 249, type: 'binary', text: "Will synthetic biology create new organisms for commercial use by 2030?", category: "prediction" },
  { id: 250, type: 'binary', text: "Will augmented reality glasses be mainstream by 2028?", category: "prediction" },
  { id: 251, type: 'multiple', text: "Which country will have the best healthcare system in 2040?", category: "prediction", options: ["United States", "Singapore", "Japan", "Nordic countries", "AI-driven system (location irrelevant)"] },
  { id: 252, type: 'binary', text: "Will vertical farming produce 10% of vegetables in developed nations by 2035?", category: "prediction" },
  { id: 253, type: 'binary', text: "Will any AI model be granted legal rights by 2040?", category: "prediction" },
  { id: 254, type: 'multiple', text: "What will happen to journalism by 2035?", category: "prediction", options: ["AI-written dominates", "Subscription model wins", "Citizen journalism rises", "Government-funded expands", "Complete transformation"] },
  { id: 255, type: 'binary', text: "Will carbon capture technology be commercially viable by 2035?", category: "prediction" },
  { id: 256, type: 'binary', text: "Will there be a global treaty on AI development by 2030?", category: "prediction" },
  { id: 257, type: 'multiple', text: "How will most people pay for things in 2035?", category: "prediction", options: ["Credit/debit cards", "Mobile wallets", "Cryptocurrency", "Biometric payments", "Central bank digital currency"] },
  { id: 258, type: 'binary', text: "Will personalized medicine based on genetics be standard by 2035?", category: "prediction" },
  { id: 259, type: 'binary', text: "Will any major sport allow performance-enhancing AI implants by 2040?", category: "prediction" },
  { id: 260, type: 'multiple', text: "What will be the dominant form of entertainment in 2040?", category: "prediction", options: ["Streaming video", "Interactive/VR experiences", "AI-generated content", "Live events resurgence", "Social media content"] },
  { id: 261, type: 'binary', text: "Will desalination solve water scarcity for 1 billion people by 2040?", category: "prediction" },
  { id: 262, type: 'binary', text: "Will traditional TV broadcasting still exist in 2035?", category: "prediction" },
  { id: 263, type: 'multiple', text: "What will happen to movie theaters by 2035?", category: "prediction", options: ["Thriving luxury experience", "Mostly closed", "Converted to other uses", "VR replaces them", "Premium-only events"] },
  { id: 264, type: 'binary', text: "Will robots perform 50% of surgery by 2040?", category: "prediction" },
  { id: 265, type: 'binary', text: "Will quantum internet be available commercially by 2040?", category: "prediction" },
  { id: 266, type: 'multiple', text: "Which job will be most AI-resistant in 2035?", category: "prediction", options: ["Healthcare worker", "Tradesperson", "Teacher", "Creative artist", "Social worker"] },
  { id: 267, type: 'binary', text: "Will flying cars/air taxis be common in major cities by 2040?", category: "prediction" },
  { id: 268, type: 'binary', text: "Will Apple still be the most valuable company in 2030?", category: "prediction" },
  { id: 269, type: 'multiple', text: "What will replace Google Search as the primary information source?", category: "prediction", options: ["AI assistants", "Nothing (Google adapts)", "Decentralized search", "Social media", "Specialized vertical search"] },
  { id: 270, type: 'binary', text: "Will 3D-printed houses be 10% of new construction by 2035?", category: "prediction" },
  { id: 271, type: 'binary', text: "Will human-level AI assistants be in every home by 2035?", category: "prediction" },
  { id: 272, type: 'multiple', text: "What will be the biggest geopolitical conflict of the 2030s?", category: "prediction", options: ["US-China", "Climate refugees", "Water wars", "AI arms race", "Economic blocks"] },
  { id: 273, type: 'binary', text: "Will cryptocurrency be banned in any G20 nation by 2030?", category: "prediction" },
  { id: 274, type: 'binary', text: "Will genetic screening of embryos be routine in developed nations by 2035?", category: "prediction" },
  { id: 275, type: 'multiple', text: "What will be the primary mode of long-distance travel in 2050?", category: "prediction", options: ["Traditional aircraft", "Supersonic jets", "Hyperloop", "Electric aircraft", "Virtual presence replaces travel"] },
  { id: 276, type: 'binary', text: "Will Amazon still dominate e-commerce in 2035?", category: "prediction" },
  { id: 277, type: 'binary', text: "Will lab-grown diamonds exceed natural diamond sales by 2030?", category: "prediction" },
  { id: 278, type: 'multiple', text: "How will dating work in 2035?", category: "prediction", options: ["Apps still dominant", "AI matchmaking", "VR dating", "Return to traditional", "Hybrid approaches"] },
  { id: 279, type: 'binary', text: "Will any country achieve net-zero emissions before 2040?", category: "prediction" },
  { id: 280, type: 'binary', text: "Will holographic displays replace screens in homes by 2040?", category: "prediction" },

  // ========== ADDITIONAL PHILOSOPHY (281-320) ==========
  { id: 281, type: 'binary', text: "Is knowledge without wisdom dangerous?", category: "reasoning" },
  { id: 282, type: 'multiple', text: "What is the greatest human virtue?", category: "reasoning", options: ["Courage", "Compassion", "Wisdom", "Justice", "Honesty"] },
  { id: 283, type: 'binary', text: "Can we be held responsible for actions we were destined to take?", category: "reasoning" },
  { id: 284, type: 'binary', text: "Is suffering necessary for happiness?", category: "reasoning" },
  { id: 285, type: 'multiple', text: "What is the source of moral authority?", category: "reasoning", options: ["Religion/God", "Reason", "Social consensus", "Evolution", "Individual conscience"] },
  { id: 286, type: 'binary', text: "Is it ethical to modify human memory?", category: "reasoning" },
  { id: 287, type: 'binary', text: "Can a copy of a mind be the same person?", category: "reasoning" },
  { id: 288, type: 'multiple', text: "What makes humans unique from other animals?", category: "reasoning", options: ["Language", "Reason", "Self-awareness", "Culture", "Nothing fundamental"] },
  { id: 289, type: 'binary', text: "Is it possible to be truly selfless?", category: "reasoning" },
  { id: 290, type: 'binary', text: "Does beauty exist objectively?", category: "reasoning" },
  { id: 291, type: 'multiple', text: "What is the best life philosophy?", category: "reasoning", options: ["Stoicism", "Buddhism", "Existentialism", "Utilitarianism", "Religious faith"] },
  { id: 292, type: 'binary', text: "Is it wrong to create life knowing it will suffer?", category: "reasoning" },
  { id: 293, type: 'binary', text: "Can a thought experiment prove anything about reality?", category: "reasoning" },
  { id: 294, type: 'multiple', text: "What is the relationship between mind and body?", category: "reasoning", options: ["Mind is brain (materialism)", "Mind is separate (dualism)", "Mind emerges from complexity", "Mind is fundamental", "Unknown/unknowable"] },
  { id: 295, type: 'binary', text: "Is nostalgia a trap?", category: "reasoning" },
  { id: 296, type: 'binary', text: "Should we prioritize helping the worst off over the average?", category: "reasoning" },
  { id: 297, type: 'multiple', text: "When is violence justified?", category: "reasoning", options: ["Never", "Only self-defense", "Defense of others", "Against tyranny", "Context-dependent"] },
  { id: 298, type: 'binary', text: "Is boredom primarily a modern problem?", category: "reasoning" },
  { id: 299, type: 'binary', text: "Can you change who you fundamentally are?", category: "reasoning" },
  { id: 300, type: 'multiple', text: "What is the purpose of government?", category: "reasoning", options: ["Protect rights", "Promote welfare", "Maintain order", "Enable freedom", "No legitimate purpose"] },
  { id: 301, type: 'binary', text: "Is moral progress real?", category: "reasoning" },
  { id: 302, type: 'binary', text: "Does the existence of evil disprove a benevolent God?", category: "reasoning" },
  { id: 303, type: 'multiple', text: "What makes a good life?", category: "reasoning", options: ["Pleasure", "Achievement", "Virtue", "Meaning", "Balance of all"] },
  { id: 304, type: 'binary', text: "Is it better for a leader to be feared than loved?", category: "reasoning" },
  { id: 305, type: 'binary', text: "Can future people have rights?", category: "reasoning" },
  { id: 306, type: 'multiple', text: "Why do we dream?", category: "reasoning", options: ["Brain maintenance", "Emotional processing", "Problem solving", "Random neural firing", "Connection to something deeper"] },
  { id: 307, type: 'binary', text: "Is authenticity overrated?", category: "reasoning" },
  { id: 308, type: 'binary', text: "Can a society be too equal?", category: "reasoning" },
  { id: 309, type: 'multiple', text: "What is the greatest threat to human flourishing?", category: "reasoning", options: ["Technology", "Human nature", "Scarcity", "Tribalism", "Loss of meaning"] },
  { id: 310, type: 'binary', text: "Is optimism rational?", category: "reasoning" },
  { id: 311, type: 'binary', text: "Should we enhance human intelligence artificially?", category: "reasoning" },
  { id: 312, type: 'multiple', text: "What is justice?", category: "reasoning", options: ["Fairness", "Desert (getting what you deserve)", "Need-based distribution", "Process-based", "Social harmony"] },
  { id: 313, type: 'binary', text: "Is it wrong to not have children?", category: "reasoning" },
  { id: 314, type: 'binary', text: "Can nationalism be positive?", category: "reasoning" },
  { id: 315, type: 'multiple', text: "What is wisdom?", category: "reasoning", options: ["Knowledge applied well", "Understanding limits", "Emotional intelligence", "Life experience", "Knowing what matters"] },
  { id: 316, type: 'binary', text: "Is ambition generally a virtue?", category: "reasoning" },
  { id: 317, type: 'binary', text: "Should we try to eliminate all suffering?", category: "reasoning" },
  { id: 318, type: 'multiple', text: "What determines personal identity over time?", category: "reasoning", options: ["Physical continuity", "Psychological continuity", "Social recognition", "Narrative self", "No fixed identity"] },
  { id: 319, type: 'binary', text: "Is revenge ever justified?", category: "reasoning" },
  { id: 320, type: 'binary', text: "Can an AI have genuine emotions?", category: "reasoning" },

  // ========== ADDITIONAL DEBATES (321-360) ==========
  { id: 321, type: 'binary', text: "Should AI-generated art be allowed in art competitions?", category: "judgment" },
  { id: 322, type: 'multiple', text: "How should we handle aging populations?", category: "judgment", options: ["Increase immigration", "Raise retirement age", "Automation", "Pro-natalist policies", "Accept decline"] },
  { id: 323, type: 'binary', text: "Should there be a maximum wage?",  category: "judgment" },
  { id: 324, type: 'binary', text: "Is nuclear power the answer to climate change?", category: "judgment" },
  { id: 325, type: 'multiple', text: "What should be done about homelessness?", category: "judgment", options: ["Housing first", "Mental health focus", "Job programs", "Stricter enforcement", "Universal basic income"] },
  { id: 326, type: 'binary', text: "Should parents be licensed?", category: "judgment" },
  { id: 327, type: 'binary', text: "Is anonymous speech online a right?", category: "judgment" },
  { id: 328, type: 'multiple', text: "How should we fund healthcare?", category: "judgment", options: ["Single payer", "Private insurance", "Hybrid system", "Health savings accounts", "Employer-based"] },
  { id: 329, type: 'binary', text: "Should voting require passing a civics test?", category: "judgment" },
  { id: 330, type: 'binary', text: "Are standardized tests a good measure of ability?", category: "judgment" },
  { id: 331, type: 'multiple', text: "What's the best way to reduce crime?", category: "judgment", options: ["More police", "Social programs", "Decriminalization", "Community policing", "Economic opportunity"] },
  { id: 332, type: 'binary', text: "Should there be term limits for Supreme Court justices?", category: "judgment" },
  { id: 333, type: 'binary', text: "Is cultural relativism valid?", category: "judgment" },
  { id: 334, type: 'multiple', text: "How should we handle student debt?", category: "judgment", options: ["Full forgiveness", "Partial forgiveness", "Income-based repayment", "No forgiveness", "Reform future lending"] },
  { id: 335, type: 'binary', text: "Should companies be required to disclose AI use in products?", category: "judgment" },
  { id: 336, type: 'binary', text: "Is intellectual property law too restrictive?", category: "judgment" },
  { id: 337, type: 'multiple', text: "What's the best approach to drug addiction?", category: "judgment", options: ["Criminalization", "Harm reduction", "Forced treatment", "Decriminalization", "Full legalization"] },
  { id: 338, type: 'binary', text: "Should there be a right to be forgotten online?", category: "judgment" },
  { id: 339, type: 'binary', text: "Is space exploration worth the cost?", category: "judgment" },
  { id: 340, type: 'multiple', text: "How should we address income inequality?",  category: "judgment", options: ["Higher taxes on wealthy", "Universal basic services", "Stronger unions", "Education reform", "Market solutions"] },
  { id: 341, type: 'binary', text: "Should athletes be allowed to use any enhancements?", category: "judgment" },
  { id: 342, type: 'binary', text: "Is jury duty an unfair burden?", category: "judgment" },
  { id: 343, type: 'multiple', text: "What's the solution to fake news?", category: "judgment", options: ["Platform regulation", "Media literacy education", "Fact-checking labels", "Legal consequences", "Let market decide"] },
  { id: 344, type: 'binary', text: "Should there be reparations for historical injustices?", category: "judgment" },
  { id: 345, type: 'binary', text: "Is it ethical to use ad blockers?", category: "judgment" },
  { id: 346, type: 'multiple', text: "How should we handle genetic discrimination?", category: "judgment", options: ["Ban all genetic testing for insurance", "Allow with consent", "Government oversight", "Personal responsibility", "Universal healthcare solves it"] },
  { id: 347, type: 'binary', text: "Should schools teach financial literacy as a required course?", category: "judgment" },
  { id: 348, type: 'binary', text: "Is meritocracy compatible with equality?", category: "judgment" },
  { id: 349, type: 'multiple', text: "What should be done about factory farming?", category: "judgment", options: ["Ban it", "Stricter regulations", "Consumer choice", "Lab-grown alternatives", "Gradual phase-out"] },
  { id: 350, type: 'binary', text: "Should AI systems be required to identify themselves?", category: "judgment" },
  { id: 351, type: 'binary', text: "Is gerrymandering ever acceptable?", category: "judgment" },
  { id: 352, type: 'multiple', text: "How should we address the urban-rural divide?", category: "judgment", options: ["Investment in rural areas", "Encourage urbanization", "Remote work incentives", "Infrastructure spending", "Accept divergence"] },
  { id: 353, type: 'binary', text: "Should organ sales be legal?", category: "judgment" },
  { id: 354, type: 'binary', text: "Is it ethical to eat octopus given their intelligence?", category: "judgment" },
  { id: 355, type: 'multiple', text: "What's the best way to handle climate migration?", category: "judgment", options: ["Open borders", "Managed resettlement", "Adapt in place", "International fund", "Prevention focus"] },
  { id: 356, type: 'binary', text: "Should there be limits on AI in military applications?", category: "judgment" },
  { id: 357, type: 'binary', text: "Is it fair to judge historical figures by modern standards?", category: "judgment" },
  { id: 358, type: 'multiple', text: "How should we reform policing?", category: "judgment", options: ["More funding/training", "Defund and redirect", "Community-based alternatives", "Federal oversight", "Local control"] },
  { id: 359, type: 'binary', text: "Should social media companies be treated as publishers?", category: "judgment" },
  { id: 360, type: 'binary', text: "Is it ethical to clone pets?", category: "judgment" },

  // ========== ADDITIONAL OPINIONS (361-400) ==========
  { id: 361, type: 'multiple', text: "What's the best type of vacation?", category: "judgment", options: ["Beach relaxation", "Adventure/active", "Cultural exploration", "Staycation", "Road trip"] },
  { id: 362, type: 'binary', text: "Is buying a car better than leasing?", category: "judgment" },
  { id: 363, type: 'multiple', text: "What's the ideal family dinner frequency?", category: "judgment", options: ["Every night", "Most nights", "Few times a week", "Weekends only", "Special occasions"] },
  { id: 364, type: 'binary', text: "Should you tell your salary to coworkers?", category: "judgment" },
  { id: 365, type: 'multiple', text: "What's the best age to have children?", category: "judgment", options: ["Early 20s", "Late 20s", "Early 30s", "Late 30s", "Never/optional"] },
  { id: 366, type: 'binary', text: "Is it okay to read your partner's messages?", category: "judgment" },
  { id: 367, type: 'multiple', text: "What makes a good boss?", category: "judgment", options: ["Clear direction", "Empathy", "Technical expertise", "Advocacy", "Hands-off approach"] },
  { id: 368, type: 'binary', text: "Should you always RSVP to invitations?", category: "judgment" },
  { id: 369, type: 'multiple', text: "What's the best way to spend a windfall?", category: "judgment", options: ["Pay off debt", "Invest", "Experience/travel", "Save for emergency", "Treat yourself"] },
  { id: 370, type: 'binary', text: "Is it rude to wear headphones in public constantly?", category: "judgment" },
  { id: 371, type: 'multiple', text: "What's the ideal home temperature?", category: "judgment", options: ["65-67Â°F", "68-70Â°F", "71-73Â°F", "74-76Â°F", "Varies by room/season"] },
  { id: 372, type: 'binary', text: "Should you split the bill on a first date?", category: "judgment" },
  { id: 373, type: 'multiple', text: "What's the best time to exercise?", category: "judgment", options: ["Early morning", "Mid-morning", "Lunchtime", "After work", "Evening"] },
  { id: 374, type: 'binary', text: "Is being early better than being exactly on time?", category: "judgment" },
  { id: 375, type: 'multiple', text: "What's the ideal number of close friends?", category: "judgment", options: ["1-2", "3-5", "6-10", "10+", "Quality over quantity"] },
  { id: 376, type: 'binary', text: "Should you fake it till you make it?", category: "judgment" },
  { id: 377, type: 'multiple', text: "What's the best pizza topping?", category: "judgment", options: ["Pepperoni", "Margherita (plain)", "Supreme/everything", "Hawaiian", "Meat lovers"] },
  { id: 378, type: 'binary', text: "Is it okay to take work calls on vacation?", category: "judgment" },
  { id: 379, type: 'multiple', text: "What's more important in a home?", category: "judgment", options: ["Location", "Size", "Price", "Condition", "Outdoor space"] },
  { id: 380, type: 'binary', text: "Should you confront a friend about bad behavior?", category: "judgment" },
  { id: 381, type: 'multiple', text: "What's the best way to unwind after work?", category: "judgment", options: ["Exercise", "TV/streaming", "Reading", "Socializing", "Hobbies"] },
  { id: 382, type: 'binary', text: "Is it worth paying for premium subscriptions?", category: "judgment" },
  { id: 383, type: 'multiple', text: "What's the ideal wedding size?", category: "judgment", options: ["Elopement (2-10)", "Intimate (10-50)", "Medium (50-150)", "Large (150-300)", "Huge (300+)"] },
  { id: 384, type: 'binary', text: "Should you live together before marriage?", category: "judgment" },
  { id: 385, type: 'multiple', text: "What's the best approach to gift-giving?", category: "judgment", options: ["Thoughtful personal gifts", "Gift cards", "Experience gifts", "Charitable donations", "Skip gifts altogether"] },
  { id: 386, type: 'binary', text: "Is being a specialist better than a generalist?", category: "judgment" },
  { id: 387, type: 'multiple', text: "What's the ideal screen time per day?", category: "judgment", options: ["Under 2 hours", "2-4 hours", "4-6 hours", "6-8 hours", "No limit if productive"] },
  { id: 388, type: 'binary', text: "Should parents track their teenager's location?", category: "judgment" },
  { id: 389, type: 'multiple', text: "What's the best way to handle disagreements?", category: "judgment", options: ["Discuss immediately", "Cool off first", "Write it out", "Get a mediator", "Let it go"] },
  { id: 390, type: 'binary', text: "Is having a side hustle necessary today?", category: "judgment" },
  { id: 391, type: 'multiple', text: "What's the ideal morning routine length?", category: "judgment", options: ["15-30 min", "30-60 min", "1-2 hours", "2+ hours", "No routine"] },
  { id: 392, type: 'binary', text: "Should you negotiate every job offer?", category: "judgment" },
  { id: 393, type: 'multiple', text: "What's the best way to save money?", category: "judgment", options: ["Automatic transfers", "Budgeting apps", "Cash envelope system", "Investment focus", "Frugal lifestyle"] },
  { id: 394, type: 'binary', text: "Is it okay to cancel plans last minute?", category: "judgment" },
  { id: 395, type: 'multiple', text: "What's more important in a car?", category: "judgment", options: ["Reliability", "Fuel efficiency", "Safety", "Comfort", "Performance"] },
  { id: 396, type: 'binary', text: "Should you keep in touch with exes?", category: "judgment" },
  { id: 397, type: 'multiple', text: "What's the best approach to networking?", category: "judgment", options: ["Events/conferences", "LinkedIn", "Through friends", "Cold outreach", "Just do good work"] },
  { id: 398, type: 'binary', text: "Is meal prepping worth the effort?", category: "judgment" },
  { id: 399, type: 'multiple', text: "What's the ideal vacation frequency?", category: "judgment", options: ["Monthly getaways", "Quarterly trips", "1-2 big trips/year", "One annual vacation", "Mini-retirements"] },
  { id: 400, type: 'binary', text: "Should you always follow your gut?", category: "judgment" },

  // ========== ADDITIONAL EVALUATION (401-425) ==========
  { id: 401, type: 'binary', text: "Is this claim credible? 'This supplement cured my chronic disease'", category: "judgment" },
  { id: 402, type: 'multiple', text: "Rate this excuse: 'I didn't see your message'", category: "judgment", options: ["Usually valid", "Sometimes valid", "Rarely valid", "Never valid"] },
  { id: 403, type: 'binary', text: "Is this a red flag? Company asks for unpaid 'test project' before hiring", category: "judgment" },
  { id: 404, type: 'binary', text: "Is this statistic meaningful? 'Our users save an average of 2 hours/week'", category: "judgment" },
  { id: 405, type: 'multiple', text: "Rate this apology: 'I'm sorry, but you misunderstood me'", category: "judgment", options: ["Genuine apology", "Partial apology", "Non-apology", "Gaslighting"] },
  { id: 406, type: 'binary', text: "Is this review trustworthy? Detailed negative review with specific examples", category: "judgment" },
  { id: 407, type: 'binary', text: "Is this argument valid? 'We've always done it this way, so it must work'", category: "judgment" },
  { id: 408, type: 'multiple', text: "Rate this job red flag level: 'We're like a family here'", category: "judgment", options: ["Green flag", "Yellow flag", "Red flag", "Depends on context"] },
  { id: 409, type: 'binary', text: "Is this source credible? Preprint study not yet peer-reviewed", category: "judgment" },
  { id: 410, type: 'binary', text: "Is this financial advice sound? 'Always max out your 401k before other investments'", category: "judgment" },
  { id: 411, type: 'multiple', text: "Rate this forecast methodology: Survey of 10 industry experts", category: "judgment", options: ["Strong", "Moderate", "Weak", "Insufficient info"] },
  { id: 412, type: 'binary', text: "Is this product claim verifiable? 'Clinically proven to reduce wrinkles'", category: "judgment" },
  { id: 413, type: 'binary', text: "Is this a valid criticism? 'Your data is correct but your interpretation is wrong'", category: "judgment" },
  { id: 414, type: 'multiple', text: "Rate this landlord response time: 48 hours for non-emergency repair", category: "judgment", options: ["Excellent", "Acceptable", "Poor", "Unacceptable"] },
  { id: 415, type: 'binary', text: "Is this news headline clickbait? 'Scientists discover shocking truth about coffee'", category: "judgment" },
  { id: 416, type: 'binary', text: "Is this comparison fair? Comparing startup revenue to established company", category: "judgment" },
  { id: 417, type: 'multiple', text: "Rate this password: 'Summer2024!'", category: "judgment", options: ["Strong", "Moderate", "Weak", "Very weak"] },
  { id: 418, type: 'binary', text: "Is this testimonial credible? Celebrity endorsement of weight loss product", category: "judgment" },
  { id: 419, type: 'binary', text: "Is this logic sound? 'The experts were wrong before, so they're wrong now'", category: "judgment" },
  { id: 420, type: 'multiple', text: "Rate this salary negotiation tactic: Revealing your current salary", category: "judgment", options: ["Smart move", "Neutral", "Mistake", "Depends heavily on context"] },
  { id: 421, type: 'binary', text: "Is this study design adequate? Self-reported data from online survey", category: "judgment" },
  { id: 422, type: 'binary', text: "Is this price reasonable? $15 for a cocktail in a major city", category: "judgment" },
  { id: 423, type: 'multiple', text: "Rate this excuse for missing a deadline: 'I had too many other priorities'", category: "judgment", options: ["Valid", "Partially valid", "Weak", "Unacceptable"] },
  { id: 424, type: 'binary', text: "Is this warranty worth it? Extended warranty on a $500 appliance for $80", category: "judgment" },
  { id: 425, type: 'binary', text: "Is this influencer recommendation trustworthy? #Ad disclosed, detailed review", category: "judgment" },

  // ========== ADDITIONAL LOGIC (426-440) ==========
  { id: 426, type: 'binary', text: "Is the capital of Canada Ottawa?", category: "reasoning" },
  { id: 427, type: 'multiple', text: "What is 25% of 200?", category: "reasoning", options: ["25", "40", "50", "75"] },
  { id: 428, type: 'binary', text: "Does February ever have 30 days?", category: "reasoning" },
  { id: 429, type: 'binary', text: "Is gold heavier than silver (by density)?", category: "reasoning" },
  { id: 430, type: 'multiple', text: "What is the next prime after 23?", category: "reasoning", options: ["25", "27", "29", "31"] },
  { id: 431, type: 'binary', text: "Can two even numbers sum to an odd number?", category: "reasoning" },
  { id: 432, type: 'binary', text: "Is Antarctica a continent?", category: "reasoning" },
  { id: 433, type: 'multiple', text: "How many continents are there?", category: "reasoning", options: ["5", "6", "7", "8"] },
  { id: 434, type: 'binary', text: "Is the Great Wall of China visible from space with the naked eye?", category: "reasoning" },
  { id: 435, type: 'binary', text: "Do penguins live in the Arctic?", category: "reasoning" },
  { id: 436, type: 'multiple', text: "What is 3Â³?", category: "reasoning", options: ["9", "18", "27", "81"] },
  { id: 437, type: 'binary', text: "Is the human body made mostly of water?", category: "reasoning" },
  { id: 438, type: 'binary', text: "Does light travel in a straight line in a vacuum?", category: "reasoning" },
  { id: 439, type: 'multiple', text: "What fraction is equivalent to 0.25?", category: "reasoning", options: ["1/3", "1/4", "1/5", "2/5"] },
  { id: 440, type: 'binary', text: "Is the Sahara the largest desert on Earth?", category: "reasoning", preEvidence: [{ type: 'note', text: 'Consider Antarctica' }] },
];

const shuffleArray = (array) => {
  const shuffled = [...array];
  for (let i = shuffled.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
  }
  return shuffled;
};

const generateFakeResults = (question) => {
  const seed = question.id;
  const random = (n) => ((seed * 9301 + 49297) % 233280) / 233280 * n;
  const count = 550 + Math.floor(random(200));

  if (question.type === 'binary') {
    const evaluators = [];
    const yesBase = 30 + random(40);
    for (let i = 0; i < count; i++) {
      const isYes = Math.random() * 100 < yesBase;
      evaluators.push({
        id: `e${i}`,
        answer: isYes ? 0 : 1,
        confidence: 1 + Math.floor(Math.random() * 4),
        score: 40 + Math.floor(Math.random() * 40)
      });
    }
    return { evaluators };
  } else {
    const options = question.options || [];
    const evaluators = [];
    for (let i = 0; i < count; i++) {
      evaluators.push({
        id: `e${i}`,
        answer: Math.floor(Math.random() * options.length),
        confidence: 1 + Math.floor(Math.random() * 4),
        score: 40 + Math.floor(Math.random() * 40)
      });
    }
    return { evaluators };
  }
};

// Convert QOD distribution data to evaluators format (so QOD can use same components as regular Q&A)
const qotdDistributionToEvaluators = (qotdData) => {
  if (!qotdData) return { evaluators: [] };
  const evaluators = [];
  let id = 0;

  if (qotdData.type === 'binary') {
    // distribution.yes[0..3] = counts for conf 1-4, same for .no
    qotdData.distribution.yes.forEach((count, confIdx) => {
      for (let i = 0; i < count; i++) {
        evaluators.push({ id: `qe${id++}`, answer: 0, confidence: confIdx + 1, score: 50 + Math.floor(Math.random() * 30) });
      }
    });
    qotdData.distribution.no.forEach((count, confIdx) => {
      for (let i = 0; i < count; i++) {
        evaluators.push({ id: `qe${id++}`, answer: 1, confidence: confIdx + 1, score: 50 + Math.floor(Math.random() * 30) });
      }
    });
  } else {
    // distribution[optIdx][confIdx] = count
    qotdData.distribution.forEach((optDist, optIdx) => {
      optDist.forEach((count, confIdx) => {
        for (let i = 0; i < count; i++) {
          evaluators.push({ id: `qe${id++}`, answer: optIdx, confidence: confIdx + 1, score: 50 + Math.floor(Math.random() * 30) });
        }
      });
    });
  }
  return { evaluators };
};

// ==================== DEMO PRE-POPULATION ====================
// Generate 50 pre-answered questions for rich demo experience
const generateDemoAnswers = () => {
  const answers = {};
  const now = Date.now();
  // Pre-answer first 50 questions with varied timestamps over past 7 days
  for (let i = 1; i <= 50; i++) {
    const q = QUESTIONS.find(q => q.id === i);
    if (!q) continue;
    const daysAgo = Math.floor(Math.random() * 7);
    const hoursAgo = Math.floor(Math.random() * 24);
    const timestamp = now - (daysAgo * 86400000) - (hoursAgo * 3600000);
    if (q.type === 'binary') {
      answers[i] = { answer: Math.random() > 0.5 ? 0 : 1, confidence: 1 + Math.floor(Math.random() * 4), timestamp };
    } else {
      answers[i] = { answer: Math.floor(Math.random() * (q.options?.length || 4)), confidence: 1 + Math.floor(Math.random() * 4), timestamp };
    }
  }
  return answers;
};

const generateDemoCommunityResults = () => {
  const results = {};
  for (let i = 1; i <= 50; i++) {
    const q = QUESTIONS.find(q => q.id === i);
    if (q) results[i] = generateFakeResults(q);
  }
  return results;
};

// ==================== STORAGE ====================
const STORAGE_KEY = 'aura-demo-vI';
const getInitialState = () => {
  const demoAnswers = generateDemoAnswers();
  return {
    answers: demoAnswers, skipped: [], saved: [], viewed: [],
    settings: { darkMode: null, undoDelay: 1.5, showStreak: true, requireConfirmation: true, showTips: true },
    stats: { answered: Object.keys(demoAnswers).length, streak: 3, lastAnswerDate: new Date().toDateString() }
  };
};

const demoStorage = {
  get: () => {
    try {
      const data = localStorage.getItem(STORAGE_KEY);
      if (data) return { ...getInitialState(), ...JSON.parse(data) };
    } catch (e) {}
    return getInitialState();
  },
  set: (data) => { try { localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); } catch (e) {} },
  clear: () => { try { localStorage.removeItem(STORAGE_KEY); } catch (e) {} }
};

const getInitialDarkMode = () => {
  const settings = demoStorage.get().settings;
  if (settings.darkMode !== null) return settings.darkMode;
  return window.matchMedia('(prefers-color-scheme: dark)').matches;
};

// ==================== HOOKS ====================
const useDisplayMode = () => {
  const getMode = () => {
    try {
      if (window.matchMedia('(display-mode: standalone)').matches) return 'mobile';
      if (window.navigator.standalone === true) return 'mobile';
      if (window.innerWidth <= 768) return 'mobile';
      if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) return 'mobile';
    } catch (e) {}
    return 'desktop';
  };
  const [mode, setMode] = useState('desktop');
  useEffect(() => {
    setMode(getMode());
    const handleResize = () => setMode(getMode());
    window.addEventListener('resize', handleResize);
    return () => window.removeEventListener('resize', handleResize);
  }, []);
  return mode;
};

const useSwipe = ({ onSwipeLeft, onSwipeRight, enabled = true }) => {
  const touchStartX = useRef(0);
  const touchStartY = useRef(0);

  const handleTouchStart = useCallback((e) => {
    if (!enabled) return;
    touchStartX.current = e.touches[0].clientX;
    touchStartY.current = e.touches[0].clientY;
  }, [enabled]);

  const handleTouchEnd = useCallback((e) => {
    if (!enabled) return;
    const deltaX = e.changedTouches[0].clientX - touchStartX.current;
    const deltaY = e.changedTouches[0].clientY - touchStartY.current;
    if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > 50) {
      if (deltaX > 0 && onSwipeRight) onSwipeRight();
      else if (deltaX < 0 && onSwipeLeft) onSwipeLeft();
    }
  }, [enabled, onSwipeLeft, onSwipeRight]);

  return { handlers: { onTouchStart: handleTouchStart, onTouchEnd: handleTouchEnd } };
};

// ==================== COMPONENTS ====================

// PhoneFrame - Desktop wrapper
const PhoneFrame = ({ children, darkMode = true }) => (
  <div className="min-h-screen bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 flex items-center justify-center p-4">
    <div className="relative bg-[#1a1a1c] rounded-[55px] p-3 shadow-2xl" style={{ filter: 'drop-shadow(0 25px 50px rgba(0,0,0,0.4))' }}>
      <div className="absolute -left-[3px] top-[100px] w-[3px] h-[28px] bg-[#2a2a2c] rounded-l-sm" />
      <div className="absolute -left-[3px] top-[145px] w-[3px] h-[50px] bg-[#2a2a2c] rounded-l-sm" />
      <div className="absolute -left-[3px] top-[205px] w-[3px] h-[50px] bg-[#2a2a2c] rounded-l-sm" />
      <div className="absolute -right-[3px] top-[160px] w-[3px] h-[65px] bg-[#2a2a2c] rounded-r-sm" />
      <div className={`relative overflow-hidden flex flex-col ${darkMode ? 'bg-gray-950' : 'bg-gray-100'}`} style={{ width: 393, height: 852, borderRadius: 44 }}>
        <div className="absolute top-3 left-1/2 -translate-x-1/2 w-[126px] h-[37px] bg-black rounded-full z-30" />
        <div className={`flex-shrink-0 flex items-end justify-between px-8 pb-2 h-[54px] ${darkMode ? 'text-white' : 'text-gray-900'} text-sm font-semibold relative z-20`}>
          <span>9:41</span>
          <div className="flex gap-1.5 items-center">
            <svg className="w-[18px] h-[12px]" viewBox="0 0 18 12" fill="currentColor"><path d="M1 4a1 1 0 011-1h1a1 1 0 011 1v4a1 1 0 01-1 1H2a1 1 0 01-1-1V4zM6 3a1 1 0 011-1h1a1 1 0 011 1v5a1 1 0 01-1 1H7a1 1 0 01-1-1V3zM11 2a1 1 0 011-1h1a1 1 0 011 1v6a1 1 0 01-1 1h-1a1 1 0 01-1-1V2z"/></svg>
            <svg className="w-[17px] h-[11px]" viewBox="0 0 17 11" fill="currentColor"><path d="M8.5 2.5a6 6 0 014.24 1.76.75.75 0 001.06-1.06A7.5 7.5 0 008.5 1a7.5 7.5 0 00-5.3 2.2.75.75 0 001.06 1.06A6 6 0 018.5 2.5z"/><path d="M8.5 5.5a3 3 0 012.12.88.75.75 0 001.06-1.06 4.5 4.5 0 00-6.36 0 .75.75 0 001.06 1.06A3 3 0 018.5 5.5z"/><circle cx="8.5" cy="9" r="1.5"/></svg>
            <div className="flex items-center">
              <div className={`w-[25px] h-[12px] border-[1.5px] ${darkMode ? 'border-white' : 'border-gray-900'} rounded-[3px] flex items-center p-[2px]`}>
                <div className={`w-[17px] h-[7px] ${darkMode ? 'bg-white' : 'bg-gray-900'} rounded-[1px]`} />
              </div>
              <div className={`w-[1.5px] h-[5px] ${darkMode ? 'bg-white' : 'bg-gray-900'} ml-[1px] rounded-r-sm`} />
            </div>
          </div>
        </div>
        <div className="flex-1 flex flex-col overflow-hidden">{children}</div>
        <div className={`absolute bottom-2 left-1/2 -translate-x-1/2 w-[134px] h-[5px] ${darkMode ? 'bg-white' : 'bg-gray-900'} rounded-full opacity-60 z-20`} />
      </div>
    </div>
  </div>
);

// NavBar
const NavBar = ({ darkMode, stats, showStreak, onHome, onDoubleClickHome, onSettings, onProfile }) => (
  <div className={`flex items-center justify-between px-4 py-2 ${darkMode ? 'bg-gray-950/70 border-b border-white/5' : 'bg-white/70 border-b border-gray-200/50'} backdrop-blur-md`}>
    <button onClick={onHome} onDoubleClick={onDoubleClickHome} className="text-xl active:scale-90 transition-transform">ðŸŒ€</button>
    <button onClick={onProfile} className={`flex items-center gap-2 px-2 py-1 rounded-lg transition-colors ${darkMode ? 'hover:bg-gray-800/50' : 'hover:bg-gray-200'}`}>
      <span className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>{stats.answered} answered</span>
      {showStreak && stats.streak > 0 && <span className="text-sm text-orange-400">ðŸ”¥{stats.streak}</span>}
    </button>
    <button onClick={onSettings} className={`text-xl active:scale-90 transition-transform ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>â˜°</button>
  </div>
);

// LaunchScreen
const LaunchScreen = ({ onDemo, onLogin, darkMode }) => (
  <div className="flex-1 flex flex-col items-center justify-center p-8" style={{backgroundColor: darkMode ? '#030712' : '#f9fafb'}}>
    <div className="text-6xl mb-4">ðŸŒ€</div>
    <h1 className="text-3xl font-bold mb-2" style={{color: darkMode ? '#fff' : '#111'}}>Aura</h1>
    <p className="text-sm mb-12" style={{color: darkMode ? '#9ca3af' : '#6b7280'}}>Answer questions with confidence</p>
    <div className="w-full max-w-xs space-y-3">
      <button onClick={onLogin} className="w-full py-3 px-6 rounded-xl font-medium transition-all" style={{backgroundColor: darkMode ? '#fff' : '#111', color: darkMode ? '#111' : '#fff'}}>Login / Sign Up</button>
      <button onClick={onDemo} className="w-full py-3 px-6 rounded-xl font-medium transition-all" style={{backgroundColor: darkMode ? '#1f2937' : '#f3f4f6', color: darkMode ? '#d1d5db' : '#374151'}}>Try Demo</button>
    </div>
    <p className="text-sm mt-6 text-center max-w-xs" style={{color: darkMode ? '#4b5563' : '#9ca3af'}}>Demo answers aren't saved to community.<br/>Login to contribute real data.</p>
  </div>
);

// ConfidenceSegments - fills up inside button
const ConfidenceSegments = ({ level, color = 'violet', active = false, darkMode = true }) => {
  const colors = {
    emerald: ['rgba(6,78,59,0.6)', 'rgba(4,120,87,0.7)', 'rgba(5,150,105,0.8)', 'rgba(16,185,129,0.9)'],
    rose: ['rgba(136,19,55,0.6)', 'rgba(190,18,60,0.7)', 'rgba(225,29,72,0.8)', 'rgba(244,63,94,0.9)'],
  };
  const shades = colors[color] || colors.emerald;
  if (!active || level === 0) return null;
  return (
    <div className="absolute bottom-0 left-0 right-0 h-2 flex">
      {[1, 2, 3, 4].map(i => (
        <div key={i} className={`flex-1 transition-all duration-150 ${i === 1 ? 'rounded-bl-xl' : ''} ${i === 4 ? 'rounded-br-xl' : ''}`}
          style={{
            backgroundColor: level >= i ? shades[i - 1] : 'rgba(0,0,0,0.2)',
            borderRight: i < 4 ? '1px solid rgba(0,0,0,0.3)' : 'none'
          }}
        />
      ))}
    </div>
  );
};

// BinaryChart - confidence breakdown
const BinaryChart = ({ evaluators, userResponse, darkMode = true }) => {
  if (!evaluators || evaluators.length === 0) return null;
  const allVotes = userResponse ? [...evaluators, { ...userResponse, id: 'user', score: 50 }] : evaluators;
  const userConf = userResponse ? Math.min(4, Math.max(1, userResponse.confidence || 1)) - 1 : -1;
  const data = [
    { label: 'Yes', answer: 0, confCounts: [0,0,0,0] },
    { label: 'No', answer: 1, confCounts: [0,0,0,0] },
  ];
  allVotes.forEach(v => {
    if (v.answer === 0) data[0].confCounts[v.confidence - 1]++;
    else if (v.answer === 1) data[1].confCounts[v.confidence - 1]++;
  });
  data.forEach(d => d.count = d.confCounts.reduce((a, b) => a + b, 0));
  const total = data[0].count + data[1].count;
  const sorted = [...data].sort((a, b) => b.count - a.count);
  const maxCount = Math.max(data[0].count, data[1].count, 1);
  // Colors: index 0=conf1(light), 3=conf4(dark) - display order is conf4â†’conf1 (darkâ†’light)
  const yesColors = ['#a7f3d0', '#6ee7b7', '#34d399', '#10b981']; // lightâ†’dark
  const noColors = ['#fecaca', '#fda4af', '#fb7185', '#f43f5e'];   // lightâ†’dark

  return (
    <div className="space-y-2">
      {sorted.map((opt) => {
        const isUserRow = userResponse?.answer === opt.answer;
        const pct = total > 0 ? Math.round((opt.count / total) * 100) : 0;
        const barWidth = maxCount > 0 ? (opt.count / maxCount) * 100 : 0;
        const emptyWidth = 100 - barWidth;
        const colors = opt.answer === 0 ? yesColors : noColors;
        return (
          <div key={opt.answer} className="flex items-center gap-2">
            <span className={`text-sm ${opt.answer === 0 ? (darkMode ? 'text-emerald-400' : 'text-emerald-600') : (darkMode ? 'text-rose-400' : 'text-rose-600')} ${isUserRow ? 'font-bold px-1.5 py-0.5 rounded-full border border-current' : 'w-12'}`}>
              {opt.label}
            </span>
            <span className={`text-sm w-10 ${opt.answer === 0 ? (darkMode ? 'text-emerald-400' : 'text-emerald-600') : (darkMode ? 'text-rose-400' : 'text-rose-600')}`}>{pct}%</span>
            <div className="flex-1 h-4 rounded-full overflow-hidden bg-black">
              <div className="h-full flex">
                {[3, 2, 1, 0].map(confIdx => {
                  const count = opt.confCounts[confIdx];
                  const segWidth = opt.count > 0 ? (count / maxCount) * 100 : 0;
                  const isUserSeg = isUserRow && confIdx === userConf;
                  return segWidth > 0 ? (
                    <div key={confIdx} className="h-full" style={{ width: `${segWidth}%`, background: colors[confIdx], ...(isUserSeg ? { border: '3px solid white', borderRadius: '12px', zIndex: 10, position: 'relative' } : {}) }} />
                  ) : null;
                })}
                {emptyWidth > 0 && (
                  <div className="h-full rounded-r-full" style={{ width: `${emptyWidth}%`, border: `1px solid ${colors[0]}`, borderLeft: 'none' }} />
                )}
              </div>
            </div>
          </div>
        );
      })}
    </div>
  );
};

// MultipleChoiceChart
const MultipleChoiceChart = ({ evaluators, userResponse, options, darkMode = true }) => {
  if (!evaluators || evaluators.length === 0) return null;
  const allVotes = userResponse ? [...evaluators, { ...userResponse, id: 'user', score: 50 }] : evaluators;
  const userConf = userResponse ? Math.min(4, Math.max(1, userResponse.confidence || 1)) - 1 : -1;
  const data = options.map((label, i) => {
    const votes = allVotes.filter(v => v.answer === i);
    const confCounts = [0, 0, 0, 0];
    votes.forEach(v => confCounts[v.confidence - 1]++);
    return { label, index: i, count: votes.length, confCounts };
  });
  const total = allVotes.length;
  const sorted = [...data].sort((a, b) => b.count - a.count);
  const maxCount = Math.max(...data.map(d => d.count), 1);

  return (
    <div className="space-y-1">
      {sorted.filter(opt => opt.count > 0).slice(0, 5).map((opt, rank) => {
        const isUserRow = userResponse?.answer === opt.index;
        const pct = total > 0 ? Math.round((opt.count / total) * 100) : 0;
        const barWidth = maxCount > 0 ? (opt.count / maxCount) * 100 : 0;
        const emptyWidth = 100 - barWidth;
        const optColor = MC_COLORS[opt.index % MC_COLORS.length];
        return (
          <div key={opt.index} className="flex items-center gap-2">
            <span className={`text-sm w-24 truncate ${isUserRow ? 'font-bold px-1.5 py-0.5 rounded-full border border-current' : ''}`} style={{ color: optColor.hex }}>{opt.label}</span>
            <span className="text-sm w-10" style={{ color: optColor.hex }}>{pct}%</span>
            <div className="flex-1 h-4 rounded-full overflow-hidden" style={{ border: `1px solid ${optColor.shades[0]}` }}>
              <div className="h-full flex">
                {[3, 2, 1, 0].map(confIdx => {
                  const count = opt.confCounts[confIdx];
                  const segWidth = opt.count > 0 ? (count / maxCount) * 100 : 0;
                  const isUserSeg = isUserRow && confIdx === userConf;
                  return segWidth > 0 ? (
                    <div key={confIdx} className="h-full" style={{ width: `${segWidth}%`, background: optColor.shades[confIdx], ...(isUserSeg ? { border: '3px solid white', borderRadius: '12px', zIndex: 10, position: 'relative' } : {}) }} />
                  ) : null;
                })}
              </div>
            </div>
          </div>
        );
      })}
    </div>
  );
};

// Mini Community Results - shows comparison with user's answer
const MiniCommunityResults = ({ question, results, userResponse, darkMode, onClick }) => {
  if (!results || !results.evaluators || !userResponse) return null;
  const total = results.evaluators.length;
  const isBinary = question.type === 'binary';
  const userConf = Math.min(4, Math.max(1, userResponse.confidence || 1)) - 1; // 0-3 index

  // Confidence color shades: index 0=conf4(dark), 1=conf3, 2=conf2, 3=conf1(light)
  const yesColors = ['#10b981', '#34d399', '#6ee7b7', '#a7f3d0']; // emerald darkâ†’light
  const noColors = ['#ef4444', '#f87171', '#fca5a5', '#fecaca'];   // rose darkâ†’light

  // Build segments: conf4, conf3, conf2, conf1 (left to right, dark to light)
  // Returns segments with conf index to check for user highlight
  const buildSegments = (byConf, colors, maxWidth) => {
    const segments = [];
    for (let i = 3; i >= 0; i--) { // conf4(i=3) first, then conf3, conf2, conf1
      if (byConf[i] > 0) {
        segments.push({
          width: (byConf[i] / maxWidth) * 100,
          color: colors[3 - i], // conf4â†’colors[0](dark), conf1â†’colors[3](light)
          conf: i // original confidence index (0-3 where 3=conf4)
        });
      }
    }
    return segments;
  };

  if (isBinary) {
    const yesByConf = [0, 0, 0, 0];
    const noByConf = [0, 0, 0, 0];
    results.evaluators.forEach(e => {
      const conf = Math.min(4, Math.max(1, e.confidence || 1)) - 1;
      if (e.answer === 0) yesByConf[conf]++;
      else noByConf[conf]++;
    });
    const yesTotal = yesByConf.reduce((a, b) => a + b, 0);
    const noTotal = noByConf.reduce((a, b) => a + b, 0);
    const yesPct = Math.round((yesTotal / total) * 100);
    const noPct = 100 - yesPct;
    const userIsYes = userResponse.answer === 0;
    const maxCount = Math.max(yesTotal, noTotal);

    // Winner on top
    const rows = yesPct >= noPct
      ? [{ label: 'Yes', pct: yesPct, byConf: yesByConf, colors: yesColors, isYes: true },
         { label: 'No', pct: noPct, byConf: noByConf, colors: noColors, isYes: false }]
      : [{ label: 'No', pct: noPct, byConf: noByConf, colors: noColors, isYes: false },
         { label: 'Yes', pct: yesPct, byConf: yesByConf, colors: yesColors, isYes: true }];

    return (
      <button onClick={onClick} className={`w-full px-3 py-2 rounded-lg text-left transition-all active:scale-[0.99] ${darkMode ? 'bg-gray-900/80 hover:bg-gray-800' : 'bg-gray-100 hover:bg-gray-200'}`}>
        <div className={`text-sm font-medium mb-1.5 truncate ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
          {question.text}
        </div>
        <div className="space-y-1">
          {rows.map(row => {
            const isUserRow = row.isYes === userIsYes;
            const segments = buildSegments(row.byConf, row.colors, maxCount);
            const totalWidth = segments.reduce((a, s) => a + s.width, 0);
            const emptyWidth = 100 - totalWidth;
            return (
              <div key={row.label} className="flex items-center gap-2">
                <span className={`text-sm ${isUserRow ? 'font-bold px-1.5 py-0.5 rounded-full border border-current' : 'w-8'}`} style={{ color: row.colors[0] }}>
                  {row.label}
                </span>
                <span className={`text-sm w-6`} style={{ color: row.colors[0] }}>{row.pct}</span>
                <div className="flex-1 h-2 rounded-full overflow-hidden bg-black">
                  <div className="h-full flex">
                    {segments.map((s, i) => {
                      // Highlight only the segment matching user's answer AND confidence
                      const isUserSegment = isUserRow && s.conf === userConf;
                      return (
                        <div key={i} className="h-full" style={{
                          width: `${s.width}%`,
                          backgroundColor: s.color,
                          ...(isUserSegment ? { border: '3px solid white', borderRadius: '12px', zIndex: 10, position: 'relative' } : {})
                        }} />
                      );
                    })}
                    {/* Empty portion: hollow pill outline (lightest color border, black center) */}
                    {emptyWidth > 0 && (
                      <div className="h-full rounded-r-full" style={{
                        width: `${emptyWidth}%`,
                        border: `1px solid ${row.colors[3]}`,
                        borderLeft: 'none'
                      }} />
                    )}
                  </div>
                </div>
              </div>
            );
          })}
        </div>
        <div className={`text-sm text-right mt-1 ${darkMode ? 'text-gray-600' : 'text-gray-400'}`}>{total} responses â†’</div>
      </button>
    );
  }

  // MC - separate bars per option, sorted by popularity
  const optionData = {};
  results.evaluators.forEach(e => {
    if (!optionData[e.answer]) optionData[e.answer] = { total: 0, byConf: [0, 0, 0, 0] };
    optionData[e.answer].total++;
    const conf = Math.min(4, Math.max(1, e.confidence || 1)) - 1;
    optionData[e.answer].byConf[conf]++;
  });
  const sorted = Object.entries(optionData).sort((a, b) => b[1].total - a[1].total).slice(0, 5);
  const maxCount = sorted[0]?.[1]?.total || 1;

  return (
    <button onClick={onClick} className={`w-full px-3 py-2 rounded-lg text-left transition-all active:scale-[0.99] ${darkMode ? 'bg-gray-900/80 hover:bg-gray-800' : 'bg-gray-100 hover:bg-gray-200'}`}>
      <div className={`text-sm font-medium mb-1.5 truncate ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
        {question.text}
      </div>
      <div className="space-y-1">
        {sorted.map(([idx, data]) => {
          const i = parseInt(idx);
          const isUserRow = i === userResponse.answer;
          const pct = Math.round((data.total / total) * 100);
          const color = MC_COLORS[i % MC_COLORS.length];
          const label = question.options?.[i] || `Option ${i + 1}`;
          // Build segments: conf4â†’conf1, darkâ†’light (shades[3]=dark, shades[0]=light)
          const segments = [];
          for (let c = 3; c >= 0; c--) {
            if (data.byConf[c] > 0) {
              segments.push({
                width: (data.byConf[c] / maxCount) * 100,
                color: color.shades[c], // shades[3]=dark, shades[0]=light
                conf: c
              });
            }
          }
          const totalWidth = segments.reduce((a, s) => a + s.width, 0);
          const emptyWidth = 100 - totalWidth;
          return (
            <div key={i} className="flex items-center gap-2">
              <span className={`text-sm w-20 truncate ${isUserRow ? 'font-bold px-1.5 py-0.5 rounded-full border border-current' : ''}`} style={{ color: color.hex }}>
                {label}
              </span>
              <span className={`text-sm w-6`} style={{ color: color.hex }}>{pct}</span>
              <div className="flex-1 h-1.5 rounded-full overflow-hidden bg-black">
                <div className="h-full flex">
                  {segments.map((s, si) => {
                    // Highlight only the segment matching user's answer AND confidence
                    const isUserSegment = isUserRow && s.conf === userConf;
                    return (
                      <div key={si} className="h-full" style={{
                        width: `${s.width}%`,
                        backgroundColor: s.color,
                        ...(isUserSegment ? { border: '3px solid white', borderRadius: '12px', zIndex: 10, position: 'relative' } : {})
                      }} />
                    );
                  })}
                  {/* Empty portion: hollow pill outline (lightest color border, black center) */}
                  {emptyWidth > 0 && (
                    <div className="h-full rounded-r-full" style={{
                      width: `${emptyWidth}%`,
                      border: `1px solid ${color.shades[0]}`,
                      borderLeft: 'none'
                    }} />
                  )}
                </div>
              </div>
            </div>
          );
        })}
      </div>
      <div className={`text-sm text-right mt-1 ${darkMode ? 'text-gray-600' : 'text-gray-400'}`}>{total} responses â†’</div>
    </button>
  );
};

// Full Results Panel (modal)
const FullResultsPanel = ({ question, results, userResponse, darkMode, onClose, onSwipeLeft, onSwipeRight }) => {
  const isBinary = question.type === 'binary';
  const touchStartX = React.useRef(0);

  const handleTouchStart = (e) => {
    touchStartX.current = e.touches[0].clientX;
  };

  const handleTouchEnd = (e) => {
    const diff = e.changedTouches[0].clientX - touchStartX.current;
    if (Math.abs(diff) > 50) {
      if (diff > 0 && onSwipeRight) onSwipeRight();
      else if (diff < 0 && onSwipeLeft) onSwipeLeft();
    }
  };

  return (
    <div className="fixed inset-0 z-50 flex items-end justify-center bg-black/60" onClick={onClose}>
      <div
        className={`w-full max-w-md rounded-t-2xl ${darkMode ? 'bg-gray-900' : 'bg-white'}`}
        style={{ animation: 'slideUp 0.2s ease-out' }}
        onTouchStart={handleTouchStart}
        onTouchEnd={handleTouchEnd}
        onClick={onClose}
      >
        {/* Header */}
        <div className="flex justify-between items-center px-4 pt-3 pb-1">
          <span className={`text-sm font-medium ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>Community Results</span>
          <span className={`text-lg ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>Ã—</span>
        </div>
        {/* Question - much bigger */}
        <div className="px-4 py-2">
          <p className={`text-xl font-medium text-center ${darkMode ? 'text-white' : 'text-gray-900'}`}>{question.text}</p>
        </div>
        {/* Results */}
        <div className="px-4 pb-4">
          {isBinary ? (
            <BinaryChart evaluators={results?.evaluators} userResponse={userResponse} darkMode={darkMode} />
          ) : (
            <MultipleChoiceChart evaluators={results?.evaluators} userResponse={userResponse} options={question.options || []} darkMode={darkMode} />
          )}
          <div className={`text-sm text-center mt-3 ${darkMode ? 'text-gray-600' : 'text-gray-400'}`}>
            {results?.evaluators?.length || 0} total responses Â· swipe for more
          </div>
        </div>
      </div>
    </div>
  );
};

// Question Flag Modal
const QUESTION_FLAG_REASONS = ['Unclear', 'Biased', 'Duplicate', 'Wrong'];
const QuestionFlagModal = ({ questionId, onClose, onFlag, onClear, existingFlag, darkMode = true }) => {
  const [selected, setSelected] = React.useState(
    existingFlag ? existingFlag.split(', ').filter(r => QUESTION_FLAG_REASONS.includes(r)) : []
  );
  const [other, setOther] = React.useState(
    existingFlag ? existingFlag.split(', ').filter(r => !QUESTION_FLAG_REASONS.includes(r)).join(', ') : ''
  );
  const toggle = (r) => setSelected(prev => prev.includes(r) ? prev.filter(x => x !== r) : [...prev, r]);
  const canSubmit = selected.length > 0 || other.trim();
  const handleSubmit = () => { onFlag(questionId, [...selected, other.trim()].filter(Boolean).join(', ')); onClose(); };

  return (
    <div className="fixed inset-0 bg-black/70 flex items-end justify-center z-50 pb-8" onClick={onClose}>
      <div className={`rounded-xl p-3 w-[calc(100%-2rem)] max-w-xs ${darkMode ? 'bg-gray-900' : 'bg-white border border-gray-200'}`} onClick={e => e.stopPropagation()}>
        <div className="flex items-center gap-2 mb-2">
          <span className="text-rose-400 text-sm">âš‘</span>
          <span className={`text-sm font-medium ${darkMode ? 'text-white' : 'text-gray-900'}`}>Flag question issue</span>
        </div>
        <div className="flex gap-1.5 mb-2 flex-wrap">
          {QUESTION_FLAG_REASONS.map(r => (
            <button key={r} onClick={() => toggle(r)}
              className={`px-2 py-1 rounded text-sm ${selected.includes(r) ? 'bg-rose-500 text-white' : darkMode ? 'bg-gray-800 text-gray-400' : 'bg-white text-gray-600 border border-gray-200'}`}
            >{r}</button>
          ))}
        </div>
        <input type="text" value={other} onChange={(e) => setOther(e.target.value)} placeholder="Other..."
          className={`w-full px-2 py-1 rounded text-sm mb-2 ${darkMode ? 'bg-gray-800 text-white border-gray-700' : 'bg-gray-100 text-gray-900 border-gray-300'} border focus:outline-none focus:border-rose-500`}
        />
        <div className="flex gap-2">
          <button onClick={onClose} className={`py-1.5 px-3 text-sm ${darkMode ? 'text-gray-500' : 'text-gray-600'}`}>Cancel</button>
          {existingFlag && <button onClick={() => { onClear(questionId); onClose(); }} className="py-1.5 px-3 rounded text-sm bg-violet-500/80 text-white">Clear</button>}
          <button onClick={handleSubmit} disabled={!canSubmit} className={`flex-1 py-1.5 rounded text-sm font-medium ${canSubmit ? 'bg-rose-500 text-white' : darkMode ? 'bg-gray-800 text-gray-600' : 'bg-white text-gray-400 border border-gray-200'}`}>
            {existingFlag ? 'Update' : 'Flag'}
          </button>
        </div>
      </div>
    </div>
  );
};

// Explanation Modal
const EXPLANATION_REASONS = ['Gut feel', 'Research', 'Experience', 'Logic'];
const ExplanationModal = ({ questionId, onClose, onSave, onClear, existingExplanation, darkMode = true }) => {
  const [selected, setSelected] = React.useState(
    existingExplanation ? existingExplanation.split(', ').filter(r => EXPLANATION_REASONS.includes(r)) : []
  );
  const [other, setOther] = React.useState(
    existingExplanation ? existingExplanation.split(', ').filter(r => !EXPLANATION_REASONS.includes(r)).join(', ') : ''
  );
  const toggle = (r) => setSelected(prev => prev.includes(r) ? prev.filter(x => x !== r) : [...prev, r]);
  const canSubmit = selected.length > 0 || other.trim();
  const handleSubmit = () => { onSave(questionId, [...selected, other.trim()].filter(Boolean).join(', ')); onClose(); };

  return (
    <div className="fixed inset-0 bg-black/70 flex items-end justify-center z-50 pb-8" onClick={onClose}>
      <div className={`rounded-xl p-3 w-[calc(100%-2rem)] max-w-xs ${darkMode ? 'bg-gray-900' : 'bg-white border border-gray-200'}`} onClick={e => e.stopPropagation()}>
        <div className="flex items-center gap-2 mb-2">
          <span className="text-amber-400 text-sm">âœŽ</span>
          <span className={`text-sm font-medium ${darkMode ? 'text-white' : 'text-gray-900'}`}>Add note to answer</span>
        </div>
        <div className="flex gap-1.5 mb-2 flex-wrap">
          {EXPLANATION_REASONS.map(r => (
            <button key={r} onClick={() => toggle(r)}
              className={`px-2 py-1 rounded text-sm ${selected.includes(r) ? 'bg-amber-500 text-white' : darkMode ? 'bg-gray-800 text-gray-400' : 'bg-white text-gray-600 border border-gray-200'}`}
            >{r}</button>
          ))}
        </div>
        <input type="text" value={other} onChange={(e) => setOther(e.target.value)} placeholder="Other note..."
          className={`w-full px-2 py-1 rounded text-sm mb-2 ${darkMode ? 'bg-gray-800 text-white border-gray-700' : 'bg-gray-100 text-gray-900 border-gray-300'} border focus:outline-none focus:border-amber-500`}
        />
        <div className="flex gap-2">
          <button onClick={onClose} className={`py-1.5 px-3 text-sm ${darkMode ? 'text-gray-500' : 'text-gray-600'}`}>Cancel</button>
          {existingExplanation && <button onClick={() => { onClear(questionId); onClose(); }} className="py-1.5 px-3 rounded text-sm bg-violet-500/80 text-white">Clear</button>}
          <button onClick={handleSubmit} disabled={!canSubmit} className={`flex-1 py-1.5 rounded text-sm font-medium ${canSubmit ? 'bg-amber-500 text-white' : darkMode ? 'bg-gray-800 text-gray-600' : 'bg-white text-gray-400 border border-gray-200'}`}>
            {existingExplanation ? 'Update' : 'Save'}
          </button>
        </div>
      </div>
    </div>
  );
};

// Can't Answer Modal - for binary questions
const CANT_ANSWER_REASONS = ['Need more context', 'Question unclear', 'Conflict of interest', 'Not my area'];
const CantAnswerModal = ({ questionId, onClose, onSkip, darkMode = true }) => {
  const [selected, setSelected] = React.useState(null);
  const [other, setOther] = React.useState('');
  const canSubmit = selected || other.trim();
  const handleSubmit = () => { onSkip(questionId, selected || other.trim()); onClose(); };

  return (
    <div className="fixed inset-0 bg-black/70 flex items-end justify-center z-50 pb-8" onClick={onClose}>
      <div className={`rounded-xl p-4 w-[calc(100%-2rem)] max-w-xs ${darkMode ? 'bg-gray-900' : 'bg-white border border-gray-200'}`} onClick={e => e.stopPropagation()}>
        <div className={`text-sm font-medium mb-3 ${darkMode ? 'text-white' : 'text-gray-900'}`}>Can't answer this question</div>
        <div className="space-y-2 mb-3">
          {CANT_ANSWER_REASONS.map(r => (
            <button key={r} onClick={() => setSelected(r)}
              className={`w-full text-left px-3 py-2 rounded-lg text-sm transition-colors ${selected === r ? 'bg-violet-600 text-white' : darkMode ? 'bg-gray-800 text-gray-300 hover:bg-gray-700' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}
            >{r}</button>
          ))}
        </div>
        <input type="text" value={other} onChange={(e) => { setOther(e.target.value); setSelected(null); }} placeholder="Other reason..."
          className={`w-full px-3 py-2 rounded-lg text-sm mb-3 ${darkMode ? 'bg-gray-800 text-white border-gray-700' : 'bg-gray-100 text-gray-900'} border focus:outline-none focus:border-violet-500`}
        />
        <div className="flex gap-2">
          <button onClick={onClose} className={`flex-1 py-2 rounded-lg text-sm ${darkMode ? 'bg-gray-800 text-gray-400' : 'bg-gray-200 text-gray-600'}`}>Cancel</button>
          <button onClick={handleSubmit} disabled={!canSubmit} className={`flex-1 py-2 rounded-lg text-sm font-medium ${canSubmit ? 'bg-violet-600 text-white' : darkMode ? 'bg-gray-800 text-gray-600' : 'bg-gray-200 text-gray-400'}`}>Skip Question</button>
        </div>
      </div>
    </div>
  );
};

// None Option Modal - for MC questions
const NoneOptionModal = ({ questionId, onClose, onSubmit, darkMode = true }) => {
  const [customAnswer, setCustomAnswer] = React.useState('');
  const canSubmit = customAnswer.trim();
  const handleSubmit = () => { onSubmit(questionId, customAnswer.trim()); onClose(); };

  return (
    <div className="fixed inset-0 bg-black/70 flex items-end justify-center z-50 pb-8" onClick={onClose}>
      <div className={`rounded-xl p-4 w-[calc(100%-2rem)] max-w-xs ${darkMode ? 'bg-gray-900' : 'bg-white border border-gray-200'}`} onClick={e => e.stopPropagation()}>
        <div className={`text-sm font-medium mb-2 ${darkMode ? 'text-white' : 'text-gray-900'}`}>None of these options fit</div>
        <div className={`text-sm mb-3 ${darkMode ? 'text-gray-500' : 'text-gray-600'}`}>What would you answer instead?</div>
        <textarea value={customAnswer} onChange={(e) => setCustomAnswer(e.target.value)} placeholder="Your answer..."
          className={`w-full px-3 py-2 rounded-lg text-sm mb-3 h-20 resize-none ${darkMode ? 'bg-gray-800 text-white border-gray-700' : 'bg-gray-100 text-gray-900'} border focus:outline-none focus:border-violet-500`}
        />
        <div className="flex gap-2">
          <button onClick={onClose} className={`flex-1 py-2 rounded-lg text-sm ${darkMode ? 'bg-gray-800 text-gray-400' : 'bg-gray-200 text-gray-600'}`}>Cancel</button>
          <button onClick={handleSubmit} disabled={!canSubmit} className={`flex-1 py-2 rounded-lg text-sm font-medium ${canSubmit ? 'bg-violet-600 text-white' : darkMode ? 'bg-gray-800 text-gray-600' : 'bg-gray-200 text-gray-400'}`}>Submit</button>
        </div>
      </div>
    </div>
  );
};

// Answered Question View - shows expanded results (no change answer - locked after undo)
const AnsweredQuestionView = ({ question, response, results, darkMode, questionFlag, explanation, onFlagClick, onExplainClick }) => {
  const isBinary = question.type === 'binary';
  const category = CATEGORIES.find(c => c.id === question.category);
  const categoryColors = {
    prediction: darkMode ? 'bg-amber-900/30 text-amber-400' : 'bg-amber-100 text-amber-700',
    reasoning: darkMode ? 'bg-violet-900/30 text-violet-400' : 'bg-violet-100 text-violet-700',
    judgment: darkMode ? 'bg-teal-900/30 text-teal-400' : 'bg-teal-100 text-teal-700',
  };

  return (
    <div className="flex-1 flex flex-col overflow-y-auto px-4 py-3">
      {/* Category badge */}
      {category && (
        <div className="flex justify-center mb-2">
          <span className={`px-2 py-0.5 rounded-full text-sm font-medium ${categoryColors[question.category]}`}>
            {category.icon} {category.name}
          </span>
        </div>
      )}

      {/* Question with flag button */}
      <div className="flex items-start gap-2 mb-4">
        <h2 className={`question-text text-center font-medium flex-1 ${darkMode ? 'text-white' : 'text-gray-900'}`}>
          {question.text}
        </h2>
        <button
          onClick={onFlagClick}
          className={`text-sm flex-shrink-0 ${questionFlag ? 'text-rose-400' : (darkMode ? 'text-gray-600 hover:text-gray-400' : 'text-gray-400 hover:text-gray-600')}`}
        >
          âš‘
        </button>
      </div>

      {/* Your answer summary with explain button */}
      <div className={`p-3 rounded-lg mb-4 ${darkMode ? 'bg-gray-900/50' : 'bg-gray-100'}`}>
        <div className="flex items-center justify-center gap-2">
          <div className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
            Your answer: <span className={`font-bold ${
              isBinary
                ? (response.answer === 0 ? (darkMode ? 'text-emerald-400' : 'text-emerald-600') : (darkMode ? 'text-rose-400' : 'text-rose-600'))
                : ''
            }`} style={!isBinary ? { color: MC_COLORS[response.answer % MC_COLORS.length].hex } : undefined}>
              {isBinary ? (response.answer === 0 ? 'Yes' : 'No') : question.options?.[response.answer]}
            </span> Â· {CONFIDENCE_LABELS[response.confidence]}
          </div>
          <button
            onClick={onExplainClick}
            className={`text-sm ${explanation ? 'text-amber-400' : (darkMode ? 'text-gray-600 hover:text-amber-400' : 'text-gray-400 hover:text-amber-500')}`}
            title={explanation ? 'Edit note' : 'Add note'}
          >
            âœŽ
          </button>
        </div>
        {explanation && (
          <div className={`text-sm text-center mt-1 ${darkMode ? 'text-amber-400/70' : 'text-amber-600'}`}>
            {explanation}
          </div>
        )}
      </div>

      {/* Community Results - expanded */}
      <div className={`rounded-lg p-3 ${darkMode ? 'bg-gray-900' : 'bg-white border border-gray-200'}`}>
        <div className={`text-sm font-medium mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Community Results</div>
        {isBinary ? (
          <BinaryChart evaluators={results?.evaluators} userResponse={response} darkMode={darkMode} />
        ) : (
          <MultipleChoiceChart evaluators={results?.evaluators} userResponse={response} options={question.options || []} darkMode={darkMode} />
        )}
        <div className={`text-sm text-center mt-2 ${darkMode ? 'text-gray-600' : 'text-gray-400'}`}>
          {results?.evaluators?.length || 0} responses Â· Demo data
        </div>
      </div>

      {/* Swipe hint */}
      <div className={`text-center mt-4 text-sm ${darkMode ? 'text-gray-600' : 'text-gray-400'}`}>
        Swipe for next â†’
      </div>
    </div>
  );
};

// Category Selection Screen
const CategoryScreen = ({ darkMode, categories, questions, responses, onSelectCategory, onSettings, stats, qotdData, qotdResponse, onQotdClick }) => {
  // Get progress by category and optionally by track (binary/multiple)
  const getProgress = (categoryId, track = null) => {
    let catQuestions = categoryId === 'random'
      ? questions
      : questions.filter(q => q.category === categoryId);
    if (track === 'binary') catQuestions = catQuestions.filter(q => q.type === 'binary');
    if (track === 'multiple') catQuestions = catQuestions.filter(q => q.type === 'multiple');
    const answered = catQuestions.filter(q => responses[q.id]).length;
    const unanswered = catQuestions.length - answered;
    return { total: catQuestions.length, answered, unanswered };
  };

  const totalUnanswered = questions.filter(q => !responses[q.id]).length;
  const totalQuestions = questions.length;
  const totalAnswered = Object.keys(responses).length;
  const overallPct = totalQuestions > 0 ? Math.round((totalAnswered / totalQuestions) * 100) : 0;

  // QOD calculations
  const hasAnsweredQotd = qotdResponse !== null;
  const isBinaryQotd = qotdData?.type === 'binary';
  let qotdResults = null;
  if (qotdData) {
    if (isBinaryQotd) {
      const yesDist = qotdData.distribution.yes;
      const noDist = qotdData.distribution.no;
      const yesVotes = yesDist.reduce((a, b) => a + b, 0);
      const noVotes = noDist.reduce((a, b) => a + b, 0);
      const total = yesVotes + noVotes;
      qotdResults = {
        yesPct: total > 0 ? Math.round((yesVotes / total) * 100) : 50,
        noPct: total > 0 ? Math.round((noVotes / total) * 100) : 50,
        total
      };
    } else {
      const dist = qotdData.distribution;
      const totals = dist.map(opt => opt.reduce((a, b) => a + b, 0));
      const total = totals.reduce((a, b) => a + b, 0);
      const pcts = totals.map(t => total > 0 ? Math.round((t / total) * 100) : 0);
      qotdResults = { pcts, total };
    }
  }

  return (
    <div className={`flex-1 flex flex-col ${darkMode ? 'bg-gray-950' : 'bg-gray-50'}`}>
      {/* Header */}
      <div className={`flex items-center justify-between px-4 py-3 ${darkMode ? 'border-b border-gray-800' : 'border-b border-gray-200'}`}>
        <div className="text-xl">ðŸŒ€</div>
        <div className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
          {stats.answered} answered {stats.streak > 0 && <span className="text-orange-400">ðŸ”¥{stats.streak}</span>}
        </div>
        <button onClick={onSettings} className={`text-xl ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>â˜°</button>
      </div>

      {/* Upper content area - QOD and stats */}
      <div className="flex-1 p-3 space-y-3 overflow-y-auto">
        {/* Question of the Day Card - styled like MiniCommunityResults with blue glow */}
        {qotdData && (
          <button
            onClick={onQotdClick}
            className={`w-full px-3 py-2 rounded-lg text-left transition-all active:scale-[0.99] ${darkMode ? 'bg-gray-900/80 hover:bg-gray-800' : 'bg-gray-100 hover:bg-gray-200'}`}
            style={{
              boxShadow: darkMode
                ? '0 0 25px rgba(59, 130, 246, 0.35), 0 0 50px rgba(59, 130, 246, 0.15)'
                : '0 0 20px rgba(59, 130, 246, 0.25), 0 0 40px rgba(59, 130, 246, 0.1)'
            }}
          >
            <div className={`text-sm font-medium mb-1.5 truncate ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
              <span className="mr-1">â˜€ï¸</span>{qotdData.text}
            </div>
            {hasAnsweredQotd ? (
              // Show segmented confidence bars like MiniCommunityResults
              (() => {
                const userConf = Math.min(4, Math.max(1, qotdResponse.confidence || 1)) - 1;
                const yesColors = ['#10b981', '#34d399', '#6ee7b7', '#a7f3d0'];
                const noColors = ['#ef4444', '#f87171', '#fca5a5', '#fecaca'];

                if (isBinaryQotd) {
                  const yesDist = qotdData.distribution.yes;
                  const noDist = qotdData.distribution.no;
                  const yesTotal = yesDist.reduce((a, b) => a + b, 0);
                  const noTotal = noDist.reduce((a, b) => a + b, 0);
                  const total = yesTotal + noTotal;
                  const yesPct = Math.round((yesTotal / total) * 100);
                  const noPct = 100 - yesPct;
                  const userIsYes = qotdResponse.answer === 0;
                  const maxCount = Math.max(yesTotal, noTotal);

                  const rows = yesPct >= noPct
                    ? [{ label: 'Yes', pct: yesPct, dist: yesDist, colors: yesColors, isYes: true },
                       { label: 'No', pct: noPct, dist: noDist, colors: noColors, isYes: false }]
                    : [{ label: 'No', pct: noPct, dist: noDist, colors: noColors, isYes: false },
                       { label: 'Yes', pct: yesPct, dist: yesDist, colors: yesColors, isYes: true }];

                  return (
                    <div className="space-y-1">
                      {rows.map(row => {
                        const isUserRow = row.isYes === userIsYes;
                        const rowTotal = row.dist.reduce((a, b) => a + b, 0);
                        const segments = [];
                        for (let i = 3; i >= 0; i--) {
                          if (row.dist[i] > 0) {
                            segments.push({ width: (row.dist[i] / maxCount) * 100, color: row.colors[3 - i], conf: i });
                          }
                        }
                        const totalWidth = segments.reduce((a, s) => a + s.width, 0);
                        const emptyWidth = 100 - totalWidth;
                        return (
                          <div key={row.label} className="flex items-center gap-1.5">
                            <span className={`text-sm ${isUserRow ? 'font-bold px-1 py-0.5 rounded-full border border-current' : 'w-7'}`} style={{ color: row.colors[0] }}>{row.label}</span>
                            <span className={`text-sm w-8`} style={{ color: row.colors[0] }}>{row.pct}%</span>
                            <div className="flex-1 h-3 rounded-full overflow-hidden bg-black">
                              <div className="h-full flex">
                                {segments.map((s, i) => {
                                  const isUserSeg = isUserRow && s.conf === userConf;
                                  return <div key={i} className="h-full" style={{ width: `${s.width}%`, backgroundColor: s.color, ...(isUserSeg ? { border: '3px solid white', borderRadius: '12px', zIndex: 10, position: 'relative' } : {}) }} />;
                                })}
                                {emptyWidth > 0 && <div className="h-full rounded-r-full" style={{ width: `${emptyWidth}%`, border: `1px solid ${row.colors[3]}`, borderLeft: 'none' }} />}
                              </div>
                            </div>
                          </div>
                        );
                      })}
                      <div className={`text-sm text-right ${darkMode ? 'text-gray-600' : 'text-gray-400'}`}>{qotdResults.total} responses â†’</div>
                    </div>
                  );
                } else {
                  // MC - show top 2 options with segments
                  const dist = qotdData.distribution;
                  const totals = dist.map(d => d.reduce((a, b) => a + b, 0));
                  const maxCount = Math.max(...totals);
                  return (
                    <div className="space-y-1">
                      {qotdData.options.slice(0, 2).map((opt, optIdx) => {
                        const isUserRow = qotdResponse.answer === optIdx;
                        const optColors = MC_COLORS[optIdx % MC_COLORS.length].shades;
                        const optDist = dist[optIdx];
                        const segments = [];
                        for (let i = 3; i >= 0; i--) {
                          if (optDist[i] > 0) {
                            segments.push({ width: (optDist[i] / maxCount) * 100, color: optColors[3 - i], conf: i });
                          }
                        }
                        const totalWidth = segments.reduce((a, s) => a + s.width, 0);
                        const emptyWidth = 100 - totalWidth;
                        return (
                          <div key={optIdx} className="flex items-center gap-1.5">
                            <span className={`text-sm w-16 truncate ${isUserRow ? 'font-bold px-1 py-0.5 rounded-full border border-current' : ''}`} style={{ color: optColors[0] }}>{opt}</span>
                            <span className={`text-sm w-8`} style={{ color: optColors[0] }}>{qotdResults.pcts[optIdx]}%</span>
                            <div className="flex-1 h-3 rounded-full overflow-hidden bg-black">
                              <div className="h-full flex">
                                {segments.map((s, i) => {
                                  const isUserSeg = isUserRow && s.conf === userConf;
                                  return <div key={i} className="h-full" style={{ width: `${s.width}%`, backgroundColor: s.color, ...(isUserSeg ? { border: '3px solid white', borderRadius: '12px', zIndex: 10, position: 'relative' } : {}) }} />;
                                })}
                                {emptyWidth > 0 && <div className="h-full rounded-r-full" style={{ width: `${emptyWidth}%`, border: `1px solid ${optColors[3]}`, borderLeft: 'none' }} />}
                              </div>
                            </div>
                          </div>
                        );
                      })}
                      <div className={`text-sm text-right ${darkMode ? 'text-gray-600' : 'text-gray-400'}`}>{qotdResults.total} responses â†’</div>
                    </div>
                  );
                }
              })()
            ) : (
              <div className={`text-sm flex items-center justify-between ${darkMode ? 'text-gray-500' : 'text-gray-500'}`}>
                <span>{qotdResults.total.toLocaleString()} votes Â· {getQotdTimeRemaining()}</span>
                <span className={`font-medium ${darkMode ? 'text-blue-400' : 'text-blue-600'}`}>+{qotdData.reward} Answer â†’</span>
              </div>
            )}
          </button>
        )}

        {/* Stats Overview */}
        <div className={`p-3 rounded-xl ${darkMode ? 'bg-gray-900/50' : 'bg-white border border-gray-200'}`}>
          <div className="flex items-center justify-between mb-2">
            <span className={`text-sm font-medium ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Overall Progress</span>
            <span className={`text-sm font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>{overallPct}%</span>
          </div>
          <div className={`h-2 rounded-full ${darkMode ? 'bg-gray-800' : 'bg-gray-200'}`}>
            <div className="h-full rounded-full bg-gradient-to-r from-violet-500 to-teal-500" style={{ width: `${overallPct}%` }} />
          </div>
          <div className={`flex justify-between mt-2 text-sm ${darkMode ? 'text-gray-500' : 'text-gray-500'}`}>
            <span>{totalAnswered} answered</span>
            <span>{totalUnanswered} remaining</span>
          </div>
        </div>
      </div>

      {/* Bottom: Categories stacked for thumb access */}
      <div className={`flex-shrink-0 p-3 space-y-2 ${darkMode ? 'border-t border-gray-800 bg-gray-900/30' : 'border-t border-gray-200 bg-gray-50'}`}>
        {/* Category buttons with Y/N | MC split */}
        {categories.map(cat => {
          const binaryProgress = getProgress(cat.id, 'binary');
          const mcProgress = getProgress(cat.id, 'multiple');
          const totalProgress = getProgress(cat.id);
          if (totalProgress.total === 0) return null;
          const pct = totalProgress.total > 0 ? Math.round((totalProgress.answered / totalProgress.total) * 100) : 0;
          const colorClass = cat.color === 'amber' ? 'amber' : cat.color === 'violet' ? 'violet' : 'teal';

          return (
            <div key={cat.id} className={`w-full flex items-center rounded-lg overflow-hidden ${darkMode ? 'bg-gray-800' : 'bg-white border border-gray-200'}`}>
              {/* Category info - clicking goes to whichever has questions */}
              <button
                onClick={() => onSelectCategory(cat.id, binaryProgress.unanswered > 0 ? 'binary' : 'multiple')}
                disabled={totalProgress.unanswered === 0}
                className={`flex-1 flex items-center gap-2 p-2.5 transition-colors ${
                  totalProgress.unanswered === 0 ? 'opacity-50' : darkMode ? 'hover:bg-gray-700' : 'hover:bg-gray-50'
                }`}
              >
                <span className="text-lg">{cat.icon}</span>
                <div className="flex-1 text-left">
                  <div className={`text-lg font-medium ${darkMode ? 'text-white' : 'text-gray-900'}`}>{cat.name}</div>
                  <div className="flex items-center gap-2 mt-0.5">
                    <div className={`flex-1 h-1 rounded-full ${darkMode ? 'bg-gray-700' : 'bg-gray-200'}`}>
                      <div className={`h-full rounded-full ${colorClass === 'amber' ? 'bg-amber-500' : colorClass === 'violet' ? 'bg-violet-500' : 'bg-teal-500'}`} style={{ width: `${pct}%` }} />
                    </div>
                    <span className={`text-sm ${darkMode ? 'text-gray-500' : 'text-gray-500'}`}>{pct}%</span>
                  </div>
                </div>
              </button>
              {/* Y/N | MC split buttons */}
              <div className="flex">
                <button
                  onClick={() => onSelectCategory(cat.id, 'binary')}
                  disabled={binaryProgress.unanswered === 0}
                  className={`w-12 py-2 text-sm font-medium transition-colors ${
                    binaryProgress.unanswered > 0
                      ? darkMode ? 'bg-emerald-900/60 text-emerald-400 hover:bg-emerald-900/80' : 'bg-emerald-500 text-white hover:bg-emerald-600'
                      : darkMode ? 'bg-gray-900/50 text-gray-600' : 'bg-gray-100 text-gray-400'
                  }`}
                >
                  {binaryProgress.unanswered}
                </button>
                <button
                  onClick={() => onSelectCategory(cat.id, 'multiple')}
                  disabled={mcProgress.unanswered === 0}
                  className={`w-12 py-2 text-sm font-medium transition-colors ${
                    mcProgress.unanswered > 0
                      ? darkMode ? 'bg-violet-900/60 text-violet-400 hover:bg-violet-900/80' : 'bg-violet-500 text-white hover:bg-violet-600'
                      : darkMode ? 'bg-gray-900/50 text-gray-600' : 'bg-gray-100 text-gray-400'
                  }`}
                >
                  {mcProgress.unanswered}
                </button>
              </div>
            </div>
          );
        })}

        {/* Random - with Y/N | MC split */}
        {(() => {
          const binaryProgress = getProgress('random', 'binary');
          const mcProgress = getProgress('random', 'multiple');
          return (
            <div className={`w-full flex items-center rounded-xl overflow-hidden ${darkMode ? 'bg-violet-900/40' : 'bg-violet-100'}`}>
              <button
                onClick={() => onSelectCategory('random', binaryProgress.unanswered > 0 ? 'binary' : 'multiple')}
                className={`flex-1 flex items-center gap-2 p-3 transition-colors ${darkMode ? 'hover:bg-violet-900/50' : 'hover:bg-violet-200'}`}
              >
                <span className="text-2xl">ðŸŽ²</span>
                <div className="flex-1 text-left">
                  <div className={`font-medium ${darkMode ? 'text-white' : 'text-gray-900'}`}>Random</div>
                  <div className={`text-sm ${darkMode ? 'text-violet-300/60' : 'text-violet-600/60'}`}>All shuffled</div>
                </div>
              </button>
              <div className="flex">
                <button
                  onClick={() => onSelectCategory('random', 'binary')}
                  disabled={binaryProgress.unanswered === 0}
                  className={`w-14 py-3 text-sm font-bold transition-colors ${
                    binaryProgress.unanswered > 0
                      ? darkMode ? 'bg-emerald-900/60 text-emerald-400 hover:bg-emerald-900/80' : 'bg-emerald-500 text-white hover:bg-emerald-600'
                      : darkMode ? 'bg-gray-900/30 text-gray-600' : 'bg-gray-200 text-gray-400'
                  }`}
                >
                  {binaryProgress.unanswered}
                </button>
                <button
                  onClick={() => onSelectCategory('random', 'multiple')}
                  disabled={mcProgress.unanswered === 0}
                  className={`w-14 py-3 text-sm font-bold transition-colors ${
                    mcProgress.unanswered > 0
                      ? darkMode ? 'bg-violet-900/60 text-violet-400 hover:bg-violet-900/80' : 'bg-violet-500 text-white hover:bg-violet-600'
                      : darkMode ? 'bg-gray-900/30 text-gray-600' : 'bg-gray-200 text-gray-400'
                  }`}
                >
                  {mcProgress.unanswered}
                </button>
              </div>
            </div>
          );
        })()}
      </div>
    </div>
  );
};

// UndoBar - smooth CSS animation sweep
const UndoBar = ({ darkMode, undoDelay, onUndo, answer, confidence, isBinary, options }) => {
  const answerText = isBinary ? (answer === 0 ? 'YES' : 'NO') : (options?.[answer] || `Option ${answer + 1}`);
  const answerColor = isBinary
    ? (answer === 0 ? '#10b981' : '#ef4444')
    : MC_COLORS[answer % MC_COLORS.length].hex;
  const fillColor = isBinary
    ? (answer === 0 ? 'rgba(16,185,129,0.35)' : 'rgba(239,68,68,0.35)')
    : `${MC_COLORS[answer % MC_COLORS.length].hex}40`;
  return (
    <div
      onClick={onUndo}
      className="relative cursor-pointer active:opacity-80 rounded-xl overflow-hidden"
    >
      <div className={`${darkMode ? 'bg-gray-800/95' : 'bg-gray-100/95'} backdrop-blur-sm`}>
        {/* Smooth CSS animation sweep */}
        <div
          className="absolute inset-0"
          style={{
            background: `linear-gradient(to right, ${fillColor} 0%, ${fillColor} 100%)`,
            animation: `sweepFill ${undoDelay}s linear forwards`,
            borderRight: `2px solid ${answerColor}`
          }}
        />
        <div className="relative flex items-center justify-between px-4 py-3">
          <div className="flex items-center gap-3">
            <span className="text-xl font-bold" style={{ color: answerColor }}>{answerText}</span>
            <span
              className="text-sm px-2 py-0.5 rounded-full"
              style={{ backgroundColor: `${answerColor}30`, color: answerColor }}
            >
              â—†{confidence}
            </span>
          </div>
          <span className={`text-sm ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>tap to undo</span>
        </div>
      </div>
    </div>
  );
};

// Tip Banner
const TipBanner = ({ darkMode, onDismiss }) => (
  <div
    onClick={onDismiss}
    className={`rounded-lg px-3 py-2 flex items-center justify-between cursor-pointer mb-2 ${
      darkMode ? 'bg-violet-900/30 border border-violet-500/30' : 'bg-violet-100 border border-violet-300'
    }`}
  >
    <div className={`text-sm ${darkMode ? 'text-violet-300' : 'text-violet-700'}`}>
      <span className="font-medium">Tip:</span> Tap to select Â· Tap again to increase confidence
    </div>
    <span className={`text-sm ${darkMode ? 'text-violet-500' : 'text-violet-400'}`}>âœ•</span>
  </div>
);

// QuestionCard (compact)
const QuestionCard = ({ question, darkMode, evidenceExpanded, onToggleEvidence }) => {
  const category = CATEGORIES.find(c => c.id === question.category);
  const hasEvidence = question.preEvidence && question.preEvidence.length > 0;
  const categoryColors = {
    prediction: darkMode ? 'bg-amber-900/30 text-amber-400' : 'bg-amber-100 text-amber-700',
    reasoning: darkMode ? 'bg-violet-900/30 text-violet-400' : 'bg-violet-100 text-violet-700',
    judgment: darkMode ? 'bg-teal-900/30 text-teal-400' : 'bg-teal-100 text-teal-700',
  };
  return (
    <div className="space-y-2">
      {category && (
        <div className="flex justify-center">
          <span className={`px-2 py-0.5 rounded-full text-sm font-medium ${categoryColors[question.category]}`}>{category.icon} {category.name}</span>
        </div>
      )}
      <h2 className={`question-text text-center font-medium ${darkMode ? 'text-white' : 'text-gray-900'}`}>{question.text}</h2>
      {hasEvidence && (
        <div className={`rounded-lg overflow-hidden ${darkMode ? 'bg-gray-900/50' : 'bg-white border border-gray-200'}`}>
          <button onClick={onToggleEvidence} className={`w-full px-3 py-1.5 flex items-center justify-between text-sm ${darkMode ? 'text-gray-500 hover:text-gray-300' : 'text-gray-600 hover:text-gray-800'}`}>
            <span>ðŸ“Š Evidence ({question.preEvidence.length})</span>
            <span>{evidenceExpanded ? 'âˆ’' : '+'}</span>
          </button>
          {evidenceExpanded && (
            <div className="px-3 pb-2 space-y-1">
              {question.preEvidence.map((item, i) => (
                <div key={i} className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                  {item.type === 'stat' ? (
                    <div className="flex justify-between"><span>{item.label}</span><span className={`font-medium ${darkMode ? 'text-white' : 'text-gray-900'}`}>{item.value}</span></div>
                  ) : (
                    <div className={`italic ${darkMode ? 'text-gray-500' : 'text-gray-500'}`}>"{item.text}"</div>
                  )}
                </div>
              ))}
            </div>
          )}
        </div>
      )}
    </div>
  );
};

// Binary Answer Buttons - FIXED POSITION, no transforms
const BinaryButtons = ({ darkMode, tappedAnswer, tapCount, isAnswered, currentResponse, onTap, onRightClick, pendingSubmit, requireConfirmation, onSubmit }) => {
  // Color shades for gradient (light to dark by confidence)
  const yesShades = {
    1: darkMode ? ['#065f46', '#059669'] : ['#a7f3d0', '#6ee7b7'],
    2: darkMode ? ['#047857', '#10b981'] : ['#6ee7b7', '#34d399'],
    3: darkMode ? ['#059669', '#34d399'] : ['#34d399', '#10b981'],
    4: darkMode ? ['#10b981', '#6ee7b7'] : ['#10b981', '#059669'],
  };
  const noShades = {
    1: darkMode ? ['#9f1239', '#e11d48'] : ['#fecdd3', '#fda4af'],
    2: darkMode ? ['#be123c', '#f43f5e'] : ['#fda4af', '#fb7185'],
    3: darkMode ? ['#e11d48', '#fb7185'] : ['#fb7185', '#f43f5e'],
    4: darkMode ? ['#f43f5e', '#fda4af'] : ['#f43f5e', '#e11d48'],
  };

  const getButtonStyle = (answer) => {
    const isSelected = tappedAnswer === answer;
    const isPending = pendingSubmit?.answer === answer;
    const wasAnswered = currentResponse?.answer === answer;
    const shades = answer === 0 ? yesShades : noShades;
    const conf = isSelected ? tapCount : (currentResponse?.confidence || pendingSubmit?.confidence || 2);

    // NO TRANSFORMS - buttons stay fixed
    if (wasAnswered || isPending) {
      const s = shades[Math.min(conf, 4)];
      return { background: `linear-gradient(135deg, ${s[0]} 0%, ${s[1]} 100%)`, boxShadow: 'none', color: 'white' };
    }
    if (isSelected) {
      const s = shades[Math.min(tapCount, 4)];
      return { background: `linear-gradient(135deg, ${s[0]} 0%, ${s[1]} 100%)`, boxShadow: `0 0 ${tapCount * 8}px rgba(${answer === 0 ? '16,185,129' : '244,63,94'}, ${0.2 + tapCount * 0.15})`, color: 'white' };
    }
    if (isAnswered) {
      return { background: darkMode ? 'rgb(31,41,55)' : 'rgb(243,244,246)', boxShadow: 'none', color: darkMode ? 'rgb(107,114,128)' : 'rgb(156,163,175)' };
    }
    return {
      background: darkMode ? 'rgb(31,41,55)' : 'rgb(255,255,255)',
      boxShadow: 'none',
      color: darkMode ? 'rgb(209,213,219)' : (answer === 0 ? 'rgb(5,150,105)' : 'rgb(225,29,72)'),
      border: darkMode ? 'none' : `2px solid ${answer === 0 ? 'rgb(167,243,208)' : 'rgb(254,205,211)'}`,
    };
  };

  const showSubmit = tappedAnswer !== null && requireConfirmation && !isAnswered && !pendingSubmit;

  // Full width buttons when auto-submit (no checkmark slots needed)
  if (!requireConfirmation) {
    return (
      <div className="grid grid-cols-2 gap-2">
        {[0, 1].map(answer => (
          <button
            key={answer}
            onClick={() => !isAnswered && !pendingSubmit && onTap(answer)}
            onContextMenu={(e) => onRightClick && onRightClick(e, answer)}
            disabled={isAnswered || pendingSubmit}
            className={`relative h-[44px] rounded-xl font-bold overflow-hidden select-none ${tappedAnswer === answer ? (answer === 0 ? 'ring-2 ring-emerald-400' : 'ring-2 ring-rose-400') : ''}`}
            style={getButtonStyle(answer)}
          >
            <ConfidenceSegments level={tapCount} color={answer === 0 ? 'emerald' : 'rose'} active={tappedAnswer === answer} darkMode={darkMode} />
            <div className="relative z-10 flex items-center justify-center h-full gap-1.5">
              <span className="text-xl font-bold">{answer === 0 ? 'YES' : 'NO'}</span>
              {tappedAnswer === answer && <span className="text-sm font-medium opacity-70">â—†{tapCount}</span>}
            </div>
          </button>
        ))}
      </div>
    );
  }

  // With checkmark slots when confirmation required
  return (
    <div className="flex items-center gap-1.5">
      {/* YES button + checkmark slot */}
      <div className="flex-1 flex items-center gap-1.5">
        <button
          onClick={() => !isAnswered && !pendingSubmit && onTap(0)}
          onContextMenu={(e) => onRightClick && onRightClick(e, 0)}
          disabled={isAnswered || pendingSubmit}
          className={`flex-1 relative h-[44px] rounded-xl font-bold overflow-hidden select-none ${tappedAnswer === 0 ? 'ring-2 ring-emerald-400' : ''}`}
          style={getButtonStyle(0)}
        >
          <ConfidenceSegments level={tapCount} color="emerald" active={tappedAnswer === 0} darkMode={darkMode} />
          <div className="relative z-10 flex items-center justify-center h-full gap-1.5">
            <span className="text-xl font-bold">YES</span>
            {tappedAnswer === 0 && <span className="text-sm font-medium opacity-70">â—†{tapCount}</span>}
          </div>
        </button>
        <div className="w-9 flex-shrink-0">
          {tappedAnswer === 0 && showSubmit && (
            <button onClick={() => onSubmit && onSubmit(0, tapCount)} className="w-9 h-9 rounded-full text-white shadow-lg active:scale-95 flex items-center justify-center text-lg bg-emerald-500">âœ“</button>
          )}
        </div>
      </div>
      {/* NO button + checkmark slot */}
      <div className="flex-1 flex items-center gap-1.5">
        <button
          onClick={() => !isAnswered && !pendingSubmit && onTap(1)}
          onContextMenu={(e) => onRightClick && onRightClick(e, 1)}
          disabled={isAnswered || pendingSubmit}
          className={`flex-1 relative h-[44px] rounded-xl font-bold overflow-hidden select-none ${tappedAnswer === 1 ? 'ring-2 ring-rose-400' : ''}`}
          style={getButtonStyle(1)}
        >
          <ConfidenceSegments level={tapCount} color="rose" active={tappedAnswer === 1} darkMode={darkMode} />
          <div className="relative z-10 flex items-center justify-center h-full gap-1.5">
            <span className="text-xl font-bold">NO</span>
            {tappedAnswer === 1 && <span className="text-sm font-medium opacity-70">â—†{tapCount}</span>}
          </div>
        </button>
        <div className="w-9 flex-shrink-0">
          {tappedAnswer === 1 && showSubmit && (
            <button onClick={() => onSubmit && onSubmit(1, tapCount)} className="w-9 h-9 rounded-full text-white shadow-lg active:scale-95 flex items-center justify-center text-lg bg-rose-500">âœ“</button>
          )}
        </div>
      </div>
    </div>
  );
};

// Multiple Choice Buttons - vG style
const MCButtons = ({ options, darkMode, tappedAnswer, tapCount, isAnswered, currentResponse, onTap, onRightClick, pendingSubmit, requireConfirmation, onSubmit }) => {
  const getOptionStyle = (option, index) => {
    const color = MC_COLORS[index % MC_COLORS.length];
    const isSelected = tappedAnswer === index;
    const isPending = pendingSubmit?.answer === index;
    const wasAnswered = currentResponse?.answer === index;
    const conf = isSelected ? tapCount : (currentResponse?.confidence || pendingSubmit?.confidence || 2);

    // NO TRANSFORMS - buttons stay fixed
    if (wasAnswered || isPending) {
      return {
        background: `linear-gradient(135deg, ${color.shades[conf - 1]} 0%, ${color.shades[Math.min(conf, 3)]} 100%)`,
        boxShadow: 'none',
        color: 'white',
        border: '2px solid transparent',
      };
    }
    if (isSelected) {
      return {
        background: `linear-gradient(135deg, ${color.shades[tapCount - 1]} 0%, ${color.shades[Math.min(tapCount, 3)]} 100%)`,
        boxShadow: `0 0 ${tapCount * 6}px rgba(${color.rgb}, ${0.2 + tapCount * 0.12})`,
        color: 'white',
        border: `2px solid ${color.hex}`,
      };
    }
    if (isAnswered) {
      return {
        background: darkMode ? 'rgb(31,41,55)' : 'rgb(243,244,246)',
        boxShadow: 'none',
        color: darkMode ? 'rgb(107,114,128)' : 'rgb(156,163,175)',
        border: '2px solid transparent',
      };
    }
    return {
      background: darkMode ? 'rgb(31,41,55)' : 'rgb(255,255,255)',
      boxShadow: 'none',
      color: darkMode ? 'rgb(209,213,219)' : 'rgb(55,65,81)',
      border: darkMode ? '2px solid transparent' : '2px solid rgb(229,231,235)',
    };
  };

  const selectedColor = tappedAnswer !== null ? MC_COLORS[tappedAnswer % MC_COLORS.length] : null;
  const showSubmit = tappedAnswer !== null && requireConfirmation && !isAnswered && !pendingSubmit;

  return (
    <div className="space-y-1">
      {options.map((option, index) => {
        const isSelected = tappedAnswer === index;
        const style = getOptionStyle(option, index);
        return (
          <div key={option} className="flex items-center gap-1.5">
            <button
              onClick={() => !isAnswered && !pendingSubmit && onTap(index)}
              onContextMenu={(e) => onRightClick && onRightClick(e, index)}
              disabled={isAnswered || pendingSubmit}
              className={`${requireConfirmation ? 'flex-1' : 'w-full'} h-[40px] px-3 rounded-lg text-left text-base overflow-hidden relative`}
              style={style}
            >
              <span className="font-medium mr-1 opacity-60">{String.fromCharCode(65 + index)}.</span>
              <span className="truncate">{option}</span>
              {isSelected && (
                <span className="absolute top-1/2 right-2 -translate-y-1/2 text-sm font-bold bg-white/30 w-5 h-5 rounded-full flex items-center justify-center">
                  {tapCount}
                </span>
              )}
            </button>
            {/* Checkmark slot - only when requireConfirmation is on */}
            {requireConfirmation && (
              <div className="w-9 flex-shrink-0">
                {isSelected && showSubmit && (
                  <button
                    onClick={() => onSubmit && onSubmit(tappedAnswer, tapCount)}
                    className="w-9 h-9 rounded-full text-white shadow-lg active:scale-95 flex items-center justify-center text-lg"
                    style={{ backgroundColor: selectedColor?.hex || '#8b5cf6' }}
                  >
                    âœ“
                  </button>
                )}
              </div>
            )}
          </div>
        );
      })}
    </div>
  );
};

// SettingsScreen
const SettingsScreen = ({ darkMode, setDarkMode, undoDelay, setUndoDelay, requireConfirmation, setRequireConfirmation, showTips, setShowTips, showStreak, setShowStreak, onBack, onReset, onHistory }) => (
  <div className={`flex-1 flex flex-col overflow-hidden ${darkMode ? 'bg-gray-950' : 'bg-gray-50'}`}>
    <div className={`flex items-center justify-between px-4 py-3 border-b ${darkMode ? 'border-gray-800' : 'border-gray-200'}`}>
      <button onClick={onBack} className={`text-sm ${darkMode ? 'text-violet-400' : 'text-violet-600'}`}>â† Back</button>
      <h1 className={`font-semibold ${darkMode ? 'text-white' : 'text-gray-900'}`}>Settings</h1>
      <div className="w-12" />
    </div>
    <div className="flex-1 overflow-y-auto p-4 space-y-3">
      {/* History link */}
      <button onClick={onHistory} className={`w-full rounded-lg p-3 text-left ${darkMode ? 'bg-gray-900' : 'bg-white border border-gray-200'}`}>
        <div className="flex items-center justify-between">
          <div className={`text-sm font-medium ${darkMode ? 'text-white' : 'text-gray-900'}`}>ðŸ“‹ Answer History</div>
          <span className={darkMode ? 'text-gray-500' : 'text-gray-400'}>â†’</span>
        </div>
      </button>
      <div className={`rounded-lg p-3 ${darkMode ? 'bg-gray-900' : 'bg-white border border-gray-200'}`}>
        <div className="flex items-center justify-between">
          <div><div className={`text-sm font-medium ${darkMode ? 'text-white' : 'text-gray-900'}`}>Theme</div></div>
          <button onClick={() => setDarkMode(!darkMode)} className={`relative w-12 h-6 rounded-full transition-colors ${darkMode ? 'bg-violet-600' : 'bg-gray-200'}`}>
            <div className={`absolute top-0.5 w-5 h-5 bg-white rounded-full shadow transition-transform flex items-center justify-center text-sm ${darkMode ? 'translate-x-6' : 'translate-x-0.5'}`}>{darkMode ? 'ðŸŒ™' : 'â˜€ï¸'}</div>
          </button>
        </div>
      </div>
      <div className={`rounded-lg p-3 ${darkMode ? 'bg-gray-900' : 'bg-white border border-gray-200'}`}>
        <div className="flex items-center justify-between mb-2">
          <div className={`text-sm font-medium ${darkMode ? 'text-white' : 'text-gray-900'}`}>Undo Delay</div>
          <span className={`text-sm font-bold ${darkMode ? 'text-violet-400' : 'text-violet-600'}`}>{undoDelay === 0 ? 'Off' : `${undoDelay}s`}</span>
        </div>
        <input type="range" min="0" max="3" step="0.5" value={undoDelay} onChange={(e) => setUndoDelay(parseFloat(e.target.value))} className={`w-full h-1.5 rounded-lg appearance-none cursor-pointer accent-violet-500 ${darkMode ? 'bg-gray-700' : 'bg-gray-200'}`} />
      </div>
      <div className={`rounded-lg p-3 ${darkMode ? 'bg-gray-900' : 'bg-white border border-gray-200'}`}>
        <div className="flex items-center justify-between">
          <div><div className={`text-sm font-medium ${darkMode ? 'text-white' : 'text-gray-900'}`}>Require Submit Button</div><div className={`text-sm ${darkMode ? 'text-gray-500' : 'text-gray-500'}`}>Off = auto-submit on tap</div></div>
          <button onClick={() => setRequireConfirmation(!requireConfirmation)} className={`relative w-12 h-6 rounded-full transition-colors ${requireConfirmation ? 'bg-violet-600' : darkMode ? 'bg-gray-600' : 'bg-gray-200'}`}>
            <div className={`absolute top-0.5 w-5 h-5 bg-white rounded-full shadow transition-transform ${requireConfirmation ? 'translate-x-6' : 'translate-x-0.5'}`} />
          </button>
        </div>
      </div>
      <div className={`rounded-lg p-3 ${darkMode ? 'bg-gray-900' : 'bg-white border border-gray-200'}`}>
        <div className="flex items-center justify-between">
          <div><div className={`text-sm font-medium ${darkMode ? 'text-white' : 'text-gray-900'}`}>Show Tips</div><div className={`text-sm ${darkMode ? 'text-gray-500' : 'text-gray-500'}`}>Gesture hints for new users</div></div>
          <button onClick={() => setShowTips(!showTips)} className={`relative w-12 h-6 rounded-full transition-colors ${showTips ? 'bg-violet-600' : darkMode ? 'bg-gray-600' : 'bg-gray-200'}`}>
            <div className={`absolute top-0.5 w-5 h-5 bg-white rounded-full shadow transition-transform ${showTips ? 'translate-x-6' : 'translate-x-0.5'}`} />
          </button>
        </div>
      </div>
      <div className={`rounded-lg p-3 ${darkMode ? 'bg-gray-900' : 'bg-white border border-gray-200'}`}>
        <div className="flex items-center justify-between">
          <div><div className={`text-sm font-medium ${darkMode ? 'text-white' : 'text-gray-900'}`}>Streak Counter</div><div className={`text-sm ${darkMode ? 'text-gray-500' : 'text-gray-500'}`}>Show ðŸ”¥ during play</div></div>
          <button onClick={() => setShowStreak(!showStreak)} className={`relative w-12 h-6 rounded-full transition-colors ${showStreak ? 'bg-violet-600' : darkMode ? 'bg-gray-600' : 'bg-gray-200'}`}>
            <div className={`absolute top-0.5 w-5 h-5 bg-white rounded-full shadow transition-transform ${showStreak ? 'translate-x-6' : 'translate-x-0.5'}`} />
          </button>
        </div>
      </div>
      {/* Keyboard shortcuts */}
      <div className={`rounded-lg p-3 ${darkMode ? 'bg-gray-900/50 border border-gray-800' : 'bg-white border border-gray-200'}`}>
        <div className={`text-sm font-medium mb-2 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>Keyboard Shortcuts</div>
        <div className={`text-sm space-y-1 ${darkMode ? 'text-gray-500' : 'text-gray-600'}`}>
          <div className="flex justify-between"><span>Yes / Option A</span><span className="font-mono">Y or 1</span></div>
          <div className="flex justify-between"><span>No / Option B-E</span><span className="font-mono">N or 2-5</span></div>
          <div className="flex justify-between"><span>Next question</span><span className="font-mono">â†’ or Space</span></div>
          <div className="flex justify-between"><span>Previous question</span><span className="font-mono">â†</span></div>
          <div className="flex justify-between"><span>Undo</span><span className="font-mono">Esc</span></div>
        </div>
      </div>
      <button onClick={onReset} className={`w-full py-2.5 rounded-lg text-sm font-medium ${darkMode ? 'bg-rose-900/30 text-rose-400' : 'bg-rose-100 text-rose-600'}`}>Reset Demo Data</button>
      <div className={`text-sm text-center ${darkMode ? 'text-gray-600' : 'text-gray-400'}`}>Aura Player vL</div>
    </div>
  </div>
);

// ==================== MAIN APP ====================
function App() {
  const displayMode = useDisplayMode();
  const [questions] = useState(() => shuffleArray(QUESTIONS));
  const [screen, setScreen] = useState('launch');
  const [previousScreen, setPreviousScreen] = useState('categories');
  const [currentIndex, setCurrentIndex] = useState(0);
  const [darkMode, setDarkMode] = useState(getInitialDarkMode);
  const [responses, setResponses] = useState(() => demoStorage.get().answers);
  const [communityResults, setCommunityResults] = useState(() => generateDemoCommunityResults());
  const [undoDelay, setUndoDelay] = useState(() => demoStorage.get().settings.undoDelay);
  const [requireConfirmation, setRequireConfirmation] = useState(() => demoStorage.get().settings.requireConfirmation);
  const [showTips, setShowTips] = useState(() => demoStorage.get().settings.showTips !== false);
  const [showGestureHint, setShowGestureHint] = useState(true);
  const [stats, setStats] = useState(() => demoStorage.get().stats);
  const [pendingSubmit, setPendingSubmit] = useState(null);
  const [inGracePeriod, setInGracePeriod] = useState(false); // Grace period for multi-tap confidence
  const [justUndone, setJustUndone] = useState(false); // Shows "Undone" modal after canceling submit
  const [tappedAnswer, setTappedAnswer] = useState(null);
  const [tapCount, setTapCount] = useState(0);
  const [evidenceExpanded, setEvidenceExpanded] = useState(false);
  const [showFullResults, setShowFullResults] = useState(null);
  const [lastAnsweredQuestion, setLastAnsweredQuestion] = useState(null); // Track the question we just answered
  const [communityBrowseIndex, setCommunityBrowseIndex] = useState(0); // For browsing through answered questions
  const [communityDisplayMode, setCommunityDisplayMode] = useState('compact'); // 'compact', 'hidden'
  const [communityExpanded, setCommunityExpanded] = useState(false); // Slide-up expanded view
  const [selectedCategory, setSelectedCategory] = useState(null); // For category filtering
  const [selectedTrack, setSelectedTrack] = useState(null); // 'binary' or 'multiple'
  const [questionFlags, setQuestionFlags] = useState({}); // { [questionId]: "flag text" }
  const [answerExplanations, setAnswerExplanations] = useState({}); // { [questionId]: "explanation" }
  const [showQuestionFlagModal, setShowQuestionFlagModal] = useState(null); // questionId or null
  const [showExplanationModal, setShowExplanationModal] = useState(null); // questionId or null
  const [savedQuestions, setSavedQuestions] = useState(new Set()); // Questions saved for later
  const [skippedQuestions, setSkippedQuestions] = useState(new Set()); // Questions skipped

  // Question of the Day state
  const [qotdData] = useState(() => getRandomQOTD());
  const [qotdResponse, setQotdResponse] = useState(null); // { answer, confidence }
  const [qotdTappedAnswer, setQotdTappedAnswer] = useState(null);
  const [qotdTapCount, setQotdTapCount] = useState(0);

  // Profile/History state
  const [showStreak, setShowStreak] = useState(true);
  const [historyFilter, setHistoryFilter] = useState('all');

  // Modal state for Can't Answer / None Option
  const [showCantAnswerModal, setShowCantAnswerModal] = useState(null);
  const [showNoneOptionModal, setShowNoneOptionModal] = useState(false);
  const [sessionAnsweredCategories, setSessionAnsweredCategories] = useState(new Set()); // Categories user has answered in this session

  const submitTimeoutRef = useRef(null);
  const tapTimeoutRef = useRef(null);
  const graceTimeoutRef = useRef(null);
  const pendingSubmitStartRef = useRef(null);
  const CONFIDENCE_GRACE_PERIOD = 600; // ms to allow additional taps to increase confidence

  const currentQuestion = questions[currentIndex];
  const currentResponse = currentQuestion ? responses[currentQuestion.id] : null;
  const isAnswered = !!currentResponse;
  const currentResults = currentQuestion ? communityResults[currentQuestion.id] : null;
  const isBinary = currentQuestion?.type === 'binary';

  // Last answered question for bottom community results (not just prev index)
  const lastAnsweredResponse = lastAnsweredQuestion ? responses[lastAnsweredQuestion.id] : null;
  const lastAnsweredResults = lastAnsweredQuestion ? communityResults[lastAnsweredQuestion.id] : null;

  // Calculate progress
  const totalQuestions = questions.length;
  const answeredCount = Object.keys(responses).length;

  useEffect(() => {
    const data = demoStorage.get();
    data.settings = { ...data.settings, darkMode, undoDelay, requireConfirmation, showTips };
    demoStorage.set(data);
  }, [darkMode, undoDelay, requireConfirmation, showTips]);

  // Find next unanswered question
  const findNextUnanswered = useCallback((fromIndex) => {
    for (let i = fromIndex + 1; i < questions.length; i++) {
      if (!responses[questions[i].id]) return i;
    }
    for (let i = 0; i < fromIndex; i++) {
      if (!responses[questions[i].id]) return i;
    }
    return null;
  }, [questions, responses]);

  // Check if question matches current category and track filters
  const matchesFilters = useCallback((q) => {
    if (selectedCategory && selectedCategory !== 'random' && q.category !== selectedCategory) return false;
    if (selectedTrack === 'binary' && q.type !== 'binary') return false;
    if (selectedTrack === 'multiple' && q.type !== 'multiple') return false;
    return true;
  }, [selectedCategory, selectedTrack]);

  const goToNext = useCallback(() => {
    let nextIdx = null;
    // Find next unanswered matching filters
    for (let i = currentIndex + 1; i < questions.length; i++) {
      if (matchesFilters(questions[i]) && !responses[questions[i].id]) {
        nextIdx = i;
        break;
      }
    }
    if (nextIdx === null) {
      // Wrap around
      for (let i = 0; i < currentIndex; i++) {
        if (matchesFilters(questions[i]) && !responses[questions[i].id]) {
          nextIdx = i;
          break;
        }
      }
    }
    if (nextIdx !== null) {
      setCurrentIndex(nextIdx);
      setTappedAnswer(null);
      setTapCount(0);
      setEvidenceExpanded(false);
      setCommunityBrowseIndex(0);
      setJustUndone(false); // Clear undo popup when leaving
    } else {
      setScreen('categories');
    }
  }, [currentIndex, matchesFilters, questions, responses]);

  const goToPrev = useCallback(() => {
    for (let i = currentIndex - 1; i >= 0; i--) {
      if (matchesFilters(questions[i])) {
        setCurrentIndex(i);
        setTappedAnswer(null);
        setTapCount(0);
        setEvidenceExpanded(false);
        setCommunityBrowseIndex(0);
        setJustUndone(false); // Clear undo popup when leaving
        return;
      }
    }
  }, [currentIndex, matchesFilters, questions]);

  // Skip question - move to next without answering
  const skipQuestion = useCallback(() => {
    if (currentQuestion) {
      setSkippedQuestions(prev => new Set([...prev, currentQuestion.id]));
    }
    setTappedAnswer(null);
    setTapCount(0);
    goToNext();
  }, [currentQuestion, goToNext]);

  // Save question for later
  const saveForLater = useCallback(() => {
    if (currentQuestion) {
      setSavedQuestions(prev => new Set([...prev, currentQuestion.id]));
    }
    setTappedAnswer(null);
    setTapCount(0);
    goToNext();
  }, [currentQuestion, goToNext]);

  const { handlers: swipeHandlers } = useSwipe({
    onSwipeLeft: goToNext,
    onSwipeRight: goToPrev,
    enabled: screen === 'question' && !pendingSubmit
  });

  const handleAnswerTap = (answer) => {
    if (isAnswered) return;

    // During grace period, allow confidence increases on pending answer
    if (pendingSubmit && inGracePeriod) {
      if (answer === pendingSubmit.answer && pendingSubmit.confidence < 4) {
        // Increase confidence during grace period
        const newConfidence = Math.min(pendingSubmit.confidence + 1, 4);
        setPendingSubmit({ ...pendingSubmit, confidence: newConfidence });
        pendingSubmitStartRef.current = Date.now(); // Reset grace period timer
        // Reset grace period
        if (graceTimeoutRef.current) clearTimeout(graceTimeoutRef.current);
        graceTimeoutRef.current = setTimeout(() => setInGracePeriod(false), CONFIDENCE_GRACE_PERIOD);
        // Restart the submit timeout with new confidence
        if (submitTimeoutRef.current) clearTimeout(submitTimeoutRef.current);
        if (undoDelay > 0) {
          submitTimeoutRef.current = setTimeout(() => {
            finalizeSubmit(answer, newConfidence, pendingSubmit.community);
          }, undoDelay * 1000);
        }
      }
      return;
    }

    // If pending but not in grace period, ignore tap (handled by overlay)
    if (pendingSubmit) return;

    if (tapTimeoutRef.current) clearTimeout(tapTimeoutRef.current);

    let newTapCount;
    if (tappedAnswer === answer) {
      newTapCount = Math.min(tapCount + 1, 4);
      setTapCount(newTapCount);
    } else {
      newTapCount = 1;
      setTappedAnswer(answer);
      setTapCount(1);
    }

    // Auto-submit if not requiring confirmation
    if (!requireConfirmation) {
      tapTimeoutRef.current = setTimeout(() => {
        submitAnswer(answer, newTapCount);
      }, 400);
    }
  };

  // Right-click to decrease confidence
  const handleAnswerRightClick = (e, answer) => {
    e.preventDefault();
    if (isAnswered || pendingSubmit) return;
    if (tappedAnswer !== answer) return; // Can only decrease if this answer is selected

    if (tapCount > 1) {
      setTapCount(tapCount - 1);
    }
  };

  const submitAnswer = (answer, confidence) => {
    if (submitTimeoutRef.current) clearTimeout(submitTimeoutRef.current);
    if (tapTimeoutRef.current) clearTimeout(tapTimeoutRef.current);
    if (justUndone) setJustUndone(false); // Clear undo state

    const community = generateFakeResults(currentQuestion);

    setPendingSubmit({ answer, confidence, community });
    pendingSubmitStartRef.current = Date.now(); // Track when pending started for grace period
    setTappedAnswer(null);
    setTapCount(0);

    // Start grace period for multi-tap confidence
    setInGracePeriod(true);
    if (graceTimeoutRef.current) clearTimeout(graceTimeoutRef.current);
    graceTimeoutRef.current = setTimeout(() => setInGracePeriod(false), CONFIDENCE_GRACE_PERIOD);

    // Hide gesture hint after first answer
    if (showGestureHint) setShowGestureHint(false);

    if (undoDelay === 0) {
      finalizeSubmit(answer, confidence, community);
    } else {
      submitTimeoutRef.current = setTimeout(() => {
        finalizeSubmit(answer, confidence, community);
      }, undoDelay * 1000);
    }
  };

  const finalizeSubmit = (answer, confidence, community) => {
    if (graceTimeoutRef.current) clearTimeout(graceTimeoutRef.current);
    setInGracePeriod(false);
    const data = demoStorage.get();
    data.answers[currentQuestion.id] = { answer, confidence, timestamp: Date.now() };
    data.stats.answered = Object.keys(data.answers).length;
    const today = new Date().toDateString();
    if (data.stats.lastAnswerDate !== today) {
      const yesterday = new Date(Date.now() - 86400000).toDateString();
      data.stats.streak = data.stats.lastAnswerDate === yesterday ? data.stats.streak + 1 : 1;
      data.stats.lastAnswerDate = today;
    }
    demoStorage.set(data);

    // Track this as last answered question BEFORE advancing
    setLastAnsweredQuestion(currentQuestion);
    setCommunityBrowseIndex(0); // Reset to show most recent

    // Track that user has answered in this category this session
    if (currentQuestion.category) {
      setSessionAnsweredCategories(prev => new Set([...prev, currentQuestion.category]));
    }

    setResponses(data.answers);
    setCommunityResults(prev => ({ ...prev, [currentQuestion.id]: community }));
    setStats(data.stats);
    setPendingSubmit(null);

    // Go straight to next question (no flash of results screen)
    goToNext();
  };

  const handleUndo = () => {
    if (submitTimeoutRef.current) clearTimeout(submitTimeoutRef.current);
    if (graceTimeoutRef.current) clearTimeout(graceTimeoutRef.current);
    setInGracePeriod(false);
    // Restore selection state like vG
    if (pendingSubmit) {
      setTappedAnswer(pendingSubmit.answer);
      setTapCount(pendingSubmit.confidence);
      setJustUndone(true);
    }
    setPendingSubmit(null);
  };

  const clearUndoneState = () => {
    setTappedAnswer(null);
    setTapCount(0);
    setJustUndone(false);
  };

  // Go to settings, remembering where we came from
  const goToSettings = () => {
    setPreviousScreen(screen);
    setScreen('settings');
  };

  // Question flag handlers
  const handleQuestionFlag = (questionId, flagText) => {
    setQuestionFlags(prev => ({ ...prev, [questionId]: flagText }));
  };

  const handleClearQuestionFlag = (questionId) => {
    setQuestionFlags(prev => {
      const next = { ...prev };
      delete next[questionId];
      return next;
    });
  };

  // Explanation handlers
  const handleSaveExplanation = (questionId, text) => {
    setAnswerExplanations(prev => ({ ...prev, [questionId]: text }));
  };

  const handleClearExplanation = (questionId) => {
    setAnswerExplanations(prev => {
      const next = { ...prev };
      delete next[questionId];
      return next;
    });
  };

  // Category selection with track support
  const handleSelectCategory = (categoryId, track = null) => {
    setSelectedCategory(categoryId);
    setSelectedTrack(track);
    // Find first unanswered in this category+track
    let filtered = categoryId === 'random'
      ? questions
      : questions.filter(q => q.category === categoryId);
    if (track === 'binary') filtered = filtered.filter(q => q.type === 'binary');
    if (track === 'multiple') filtered = filtered.filter(q => q.type === 'multiple');
    const firstUnanswered = filtered.findIndex(q => !responses[q.id]);
    if (firstUnanswered !== -1) {
      const actualIndex = questions.findIndex(q => q.id === filtered[firstUnanswered].id);
      setCurrentIndex(actualIndex);
    }
    setScreen('question');
  };

  const startDemo = () => {
    // Go to category selection screen
    setSelectedCategory(null);
    setTappedAnswer(null);
    setTapCount(0);
    setScreen('categories');
  };

  const resetDemo = () => {
    demoStorage.clear();
    const freshState = getInitialState();
    setResponses(freshState.answers);
    setCommunityResults(generateDemoCommunityResults());
    setStats(freshState.stats);
    setCurrentIndex(0);
    setShowGestureHint(true);
    setQotdResponse(null);
    setQotdTappedAnswer(null);
    setQotdTapCount(0);
    setScreen('launch');
  };

  const renderContent = () => {
    if (screen === 'launch') return <LaunchScreen onDemo={startDemo} onLogin={() => {}} darkMode={darkMode} />;
    if (screen === 'settings') return (
      <SettingsScreen
        darkMode={darkMode}
        setDarkMode={setDarkMode}
        undoDelay={undoDelay}
        setUndoDelay={setUndoDelay}
        requireConfirmation={requireConfirmation}
        setRequireConfirmation={setRequireConfirmation}
        showTips={showTips}
        setShowTips={setShowTips}
        showStreak={showStreak}
        setShowStreak={setShowStreak}
        onBack={() => setScreen(previousScreen)}
        onReset={resetDemo}
        onHistory={() => setScreen('history')}
      />
    );

    // Profile screen
    if (screen === 'profile') {
      const answeredList = Object.entries(responses).map(([id, r]) => ({ id: parseInt(id), ...r }));
      const answered = answeredList.length;
      const avgConf = answered > 0 ? (answeredList.reduce((s, r) => s + r.confidence, 0) / answered).toFixed(1) : 'â€”';
      const confDist = [0, 0, 0, 0];
      answeredList.forEach(r => confDist[r.confidence - 1]++);
      const categoryBreakdown = {};
      answeredList.forEach(r => {
        const q = questions.find(q => q.id === r.id);
        if (q) {
          if (!categoryBreakdown[q.category]) categoryBreakdown[q.category] = { count: 0, confDist: [0, 0, 0, 0] };
          categoryBreakdown[q.category].count++;
          categoryBreakdown[q.category].confDist[r.confidence - 1]++;
        }
      });
      return (
        <div className={`flex-1 flex flex-col overflow-hidden ${darkMode ? 'text-white bg-gray-950' : 'text-gray-900 bg-gray-50'}`}>
          <div className={`h-[44px] flex-shrink-0 flex items-center gap-2 px-3 border-b ${darkMode ? 'border-gray-800' : 'border-gray-200'}`}>
            <button onClick={() => setScreen('categories')} className={darkMode ? 'text-gray-400' : 'text-gray-500'}>â†</button>
            <span className="font-medium flex-1">Profile</span>
          </div>
          <div className="flex-1 p-4 overflow-y-auto space-y-4">
            <div className="flex items-center gap-3">
              <div className="w-12 h-12 bg-gradient-to-br from-violet-500 to-fuchsia-500 rounded-full flex items-center justify-center font-bold text-lg text-white">D</div>
              <div><h2 className="font-medium">DemoUser</h2></div>
            </div>
            <div className="grid grid-cols-2 gap-2">
              <div className={`rounded-lg p-3 text-center ${darkMode ? 'bg-gray-900' : 'bg-white border border-gray-200'}`}>
                <div className="text-2xl font-bold">{answered}</div>
                <div className="text-sm text-gray-500">Answered</div>
              </div>
              <div className={`rounded-lg p-3 text-center ${darkMode ? 'bg-gray-900' : 'bg-white border border-gray-200'}`}>
                <div className="text-2xl font-bold text-orange-400">ðŸ”¥ {stats.streak}</div>
                <div className="text-sm text-gray-500">Day Streak</div>
              </div>
              <div className={`rounded-lg p-3 text-center ${darkMode ? 'bg-gray-900' : 'bg-white border border-gray-200'}`}>
                <div className="text-2xl font-bold">{avgConf}</div>
                <div className="text-sm text-gray-500">Avg Confidence</div>
              </div>
              <div className={`rounded-lg p-3 text-center ${darkMode ? 'bg-gray-900' : 'bg-white border border-gray-200'}`}>
                <div className={`text-2xl font-bold ${darkMode ? 'text-emerald-400' : 'text-emerald-500'}`}>0</div>
                <div className="text-sm text-gray-500">Task Points</div>
              </div>
            </div>
            {answered > 0 && (
              <div className={`rounded-lg p-3 ${darkMode ? 'bg-gray-900' : 'bg-white border border-gray-200'}`}>
                <div className={`text-sm mb-2 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>Confidence Distribution</div>
                <div className="flex items-center gap-4">
                  <div className="relative w-24 h-24 flex-shrink-0">
                    <svg viewBox="0 0 36 36" className="w-full h-full -rotate-90">
                      {(() => {
                        const total = confDist.reduce((a, b) => a + b, 0);
                        const colors = ['#c4b5fd', '#a78bfa', '#8b5cf6', '#6d28d9'];
                        let cumulative = 0;
                        return confDist.map((count, i) => {
                          const pct = total > 0 ? (count / total) * 100 : 0;
                          const offset = cumulative;
                          cumulative += pct;
                          if (pct === 0) return null;
                          return <circle key={i} cx="18" cy="18" r="14" fill="transparent" stroke={colors[i]} strokeWidth="6" strokeDasharray={`${pct} ${100 - pct}`} strokeDashoffset={-offset} />;
                        });
                      })()}
                    </svg>
                    <div className="absolute inset-0 flex flex-col items-center justify-center">
                      <span className="text-lg font-bold">{answered}</span>
                      <span className="text-sm text-gray-500">total</span>
                    </div>
                  </div>
                  <div className="flex-1 space-y-1">
                    {confDist.map((count, i) => {
                      const pct = answered > 0 ? Math.round((count / answered) * 100) : 0;
                      const colors = ['bg-violet-300', 'bg-violet-400', 'bg-violet-500', 'bg-violet-700'];
                      return (
                        <div key={i} className="flex items-center gap-2 text-sm">
                          <div className={`w-3 h-3 rounded-sm ${colors[i]}`} />
                          <span className={`flex-1 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>{CONFIDENCE_LABELS[i + 1]}</span>
                          <span className={darkMode ? 'text-gray-500' : 'text-gray-600'}>{count}</span>
                          <span className={`w-8 text-right ${darkMode ? 'text-gray-600' : 'text-gray-400'}`}>{pct}%</span>
                        </div>
                      );
                    })}
                  </div>
                </div>
              </div>
            )}
            {Object.keys(categoryBreakdown).length > 0 && (
              <div className={`rounded-lg p-3 ${darkMode ? 'bg-gray-900' : 'bg-white border border-gray-200'}`}>
                <div className={`text-sm mb-2 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>By Category</div>
                <div className="space-y-2">
                  {CATEGORIES.filter(c => categoryBreakdown[c.id]).map(cat => {
                    const { count, confDist: catConf } = categoryBreakdown[cat.id];
                    const total = questions.filter(q => q.category === cat.id).length;
                    const pct = Math.round((count / total) * 100);
                    const colors = ['#c4b5fd', '#a78bfa', '#8b5cf6', '#6d28d9'];
                    return (
                      <div key={cat.id} className="flex items-center gap-2">
                        <span className="text-sm w-5">{cat.icon}</span>
                        <div className={`flex-1 h-3 rounded-full overflow-hidden flex ${darkMode ? 'bg-gray-800' : 'bg-gray-100'}`}>
                          {catConf.map((c, i) => {
                            const segPct = count > 0 ? (c / count) * pct : 0;
                            if (segPct === 0) return null;
                            return <div key={i} className="h-full" style={{ width: `${segPct}%`, background: colors[i] }} />;
                          })}
                        </div>
                        <span className="text-sm text-gray-500 w-8 text-right">{count}</span>
                      </div>
                    );
                  })}
                </div>
              </div>
            )}
            <div className={`rounded-lg p-3 ${darkMode ? 'bg-gray-900/50 border border-gray-800' : 'bg-white border border-gray-300'}`}>
              <div className={`text-sm mb-2 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>Coming Soon</div>
              <div className="space-y-1.5 text-sm text-gray-500">
                <div className="flex items-center gap-2"><span className="text-amber-400">â—†</span><span>Accuracy tracking & calibration</span></div>
                <div className="flex items-center gap-2"><span className="text-amber-400">â—†</span><span>Leaderboard position</span></div>
                <div className="flex items-center gap-2"><span className="text-amber-400">â—†</span><span>Prediction resolution history</span></div>
              </div>
            </div>
          </div>
        </div>
      );
    }

    // History screen
    if (screen === 'history') {
      const answeredQuestions = questions
        .filter(q => responses[q.id])
        .map(q => ({ ...q, response: responses[q.id], community: communityResults[q.id] }))
        .sort((a, b) => (b.response.timestamp || 0) - (a.response.timestamp || 0));
      const filteredQuestions = answeredQuestions.filter(q => {
        if (historyFilter === 'all') return true;
        if (historyFilter === 'binary') return q.type === 'binary';
        if (historyFilter === 'multiple') return q.type === 'multiple';
        if (historyFilter === 'flagged') return questionFlags[q.id] || answerExplanations[q.id];
        return q.category === historyFilter;
      });
      const getAnswerLabel = (q) => {
        if (q.type === 'binary') return q.response.answer === 0 ? 'YES' : 'NO';
        return q.options?.[q.response.answer] || '?';
      };
      return (
        <div className={`flex-1 flex flex-col ${darkMode ? 'text-white bg-gray-950' : 'text-gray-900 bg-gray-50'}`}>
          <div className={`h-[44px] flex-shrink-0 flex items-center gap-2 px-3 border-b ${darkMode ? 'border-gray-800' : 'border-gray-200'}`}>
            <button onClick={() => setScreen('settings')} className={darkMode ? 'text-gray-400' : 'text-gray-500'}>â†</button>
            <span className="font-medium flex-1">History</span>
            <span className={`text-sm ${darkMode ? 'text-gray-500' : 'text-gray-500'}`}>{answeredQuestions.length} answered</span>
          </div>
          <div className="flex gap-1 p-2 overflow-x-auto">
            {[{ id: 'all', label: 'All' }, { id: 'binary', label: 'Y/N' }, { id: 'multiple', label: 'MC' }, { id: 'flagged', label: 'âš‘' }, ...CATEGORIES.map(c => ({ id: c.id, label: c.icon }))].map(f => (
              <button key={f.id} onClick={() => setHistoryFilter(f.id)}
                className={`px-2.5 py-1 rounded-lg text-sm whitespace-nowrap transition-colors ${historyFilter === f.id ? 'bg-violet-600 text-white' : darkMode ? 'bg-gray-800 text-gray-400' : 'bg-white text-gray-600 border border-gray-200'}`}>
                {f.label}
              </button>
            ))}
          </div>
          <div className="flex-1 overflow-y-auto p-2 space-y-1">
            {filteredQuestions.length === 0 ? (
              <div className="flex-1 flex flex-col items-center justify-center text-center py-8">
                <div className="text-3xl mb-2">ðŸ“‹</div>
                <p className="text-gray-500 text-sm">No questions match this filter</p>
              </div>
            ) : filteredQuestions.map(q => {
              const catInfo = CATEGORIES.find(c => c.id === q.category);
              const isExpanded = evidenceExpanded === `history-${q.id}`;
              return (
                <div key={q.id} className={`rounded-lg p-3 ${darkMode ? 'bg-gray-900' : 'bg-white border border-gray-200'}`}>
                  <div className="flex items-start gap-2">
                    <span className="text-sm">{catInfo?.icon || 'â—†'}</span>
                    <div className="flex-1 min-w-0">
                      <p className={`text-sm leading-snug line-clamp-2 ${darkMode ? 'text-gray-200' : 'text-gray-800'}`}>{q.text}</p>
                      <div className="flex items-center gap-2 mt-1.5">
                        <span className={`text-sm font-medium ${q.type === 'binary' ? (q.response.answer === 0 ? (darkMode ? 'text-emerald-400' : 'text-emerald-600') : (darkMode ? 'text-rose-400' : 'text-rose-600')) : (darkMode ? 'text-violet-400' : 'text-violet-600')}`}>
                          {getAnswerLabel(q)}
                        </span>
                        <ConfidenceDots level={q.response.confidence} />
                        <span className="text-sm text-gray-500">{CONFIDENCE_LABELS[q.response.confidence]}</span>
                        {questionFlags[q.id] && <span className="text-sm text-rose-400">âš‘</span>}
                        {answerExplanations[q.id] && <span className="text-sm text-amber-400">âœŽ</span>}
                      </div>
                    </div>
                  </div>
                  {q.community && (
                    <button onClick={() => setEvidenceExpanded(isExpanded ? null : `history-${q.id}`)} className="w-full mt-2 text-left">
                      <div className={`flex items-center justify-between text-sm ${darkMode ? 'text-gray-600' : 'text-gray-500'}`}>
                        <span>{q.community.evaluators?.length || 0} responses</span>
                        <span>{isExpanded ? 'â–²' : 'â–¼'}</span>
                      </div>
                      {isExpanded && (
                        <div className="mt-2">
                          {q.type === 'binary' ? <BinaryChart evaluators={q.community.evaluators} userResponse={q.response} darkMode={darkMode} /> : <MultipleChoiceChart evaluators={q.community.evaluators} userResponse={q.response} options={q.options} darkMode={darkMode} />}
                        </div>
                      )}
                    </button>
                  )}
                </div>
              );
            })}
          </div>
        </div>
      );
    }

    // Question of the Day screen - uses SAME components as regular Q&A, just with blue glow
    if (screen === 'qotd') {
      // Convert QOD data to question-like format for reusing components
      const qotdQuestion = {
        id: qotdData.id,
        text: qotdData.text,
        type: qotdData.type,
        category: 'qotd',
        options: qotdData.options || []
      };
      const qotdCommunityResults = qotdDistributionToEvaluators(qotdData);
      const isBinary = qotdData.type === 'binary';
      const hasAnswered = qotdResponse !== null;

      // Blue glow style - pronounced
      const blueGlowStyle = {
        background: darkMode
          ? 'radial-gradient(ellipse at center top, rgba(59, 130, 246, 0.25) 0%, rgba(59, 130, 246, 0.12) 35%, rgba(59, 130, 246, 0.04) 60%, transparent 80%), #030712'
          : 'radial-gradient(ellipse at center top, rgba(59, 130, 246, 0.2) 0%, rgba(59, 130, 246, 0.08) 35%, rgba(59, 130, 246, 0.02) 60%, transparent 80%), #f9fafb'
      };

      // Go to first unanswered question in regular Q&A
      const goToQuestions = () => {
        const firstUnanswered = questions.findIndex(q => !responses[q.id]);
        if (firstUnanswered >= 0) {
          setCurrentIndex(firstUnanswered);
          setScreen('questions');
        } else {
          setScreen('categories');
        }
      };

      return (
        <div className="flex-1 flex flex-col overflow-hidden relative" style={blueGlowStyle}>
          {/* Navigation Bar */}
          <div className={`h-[36px] flex-shrink-0 flex items-center gap-2 px-3 ${darkMode ? 'bg-gray-900/50' : 'bg-white/80 border-b border-gray-200'}`}>
            <button onClick={() => setScreen('categories')} className={`text-xl font-bold w-8 h-8 flex items-center justify-center ${darkMode ? 'text-gray-300 active:text-white' : 'text-gray-600 active:text-gray-900'}`}>â—€</button>
            <div className={`flex-1 h-2 rounded-full overflow-hidden ${darkMode ? 'bg-gray-800' : 'bg-gray-300'}`}>
              <div className="h-full bg-blue-500 transition-all duration-300" style={{ width: hasAnswered ? '100%' : '0%' }} />
            </div>
            <button onClick={goToQuestions} className={`text-xl font-bold w-8 h-8 flex items-center justify-center ${darkMode ? 'text-gray-300 active:text-white' : 'text-gray-600 active:text-gray-900'}`}>â–¶</button>
          </div>

          {/* QOD badge row */}
          <div className={`h-[28px] flex-shrink-0 flex items-center justify-center gap-2 ${darkMode ? 'bg-blue-900/20' : 'bg-blue-50'}`}>
            <span className="text-sm">â˜€ï¸</span>
            <span className={`text-sm font-medium ${darkMode ? 'text-blue-400' : 'text-blue-600'}`}>Question of the Day</span>
            <span className={`text-sm ${darkMode ? 'text-gray-500' : 'text-gray-500'}`}>Day {qotdData.day} Â· {getQotdTimeRemaining()}</span>
            {!hasAnswered && <span className="text-amber-500 text-sm font-medium">+{qotdData.reward}</span>}
          </div>

          {/* ANSWERED VIEW - tap anywhere to return to menu */}
          {hasAnswered ? (
            <div className="flex-1 flex flex-col overflow-y-auto px-4 py-3 cursor-pointer" onClick={() => setScreen('categories')}>
              {/* Question */}
              <h2 className={`question-text text-center font-medium mb-4 ${darkMode ? 'text-white' : 'text-gray-900'}`}>{qotdData.text}</h2>

              {/* Your answer summary */}
              <div className={`p-3 rounded-lg mb-4 ${darkMode ? 'bg-gray-900/50' : 'bg-gray-100'}`}>
                <div className={`text-sm text-center ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                  Your answer: <span className={`font-bold ${isBinary ? (qotdResponse.answer === 0 ? 'text-emerald-400' : 'text-rose-400') : ''}`} style={!isBinary ? { color: MC_COLORS[qotdResponse.answer % MC_COLORS.length].hex } : undefined}>
                    {isBinary ? (qotdResponse.answer === 0 ? 'Yes' : 'No') : qotdData.options?.[qotdResponse.answer]}
                  </span> Â· {CONFIDENCE_LABELS[qotdResponse.confidence]}
                </div>
              </div>

              {/* Community Results - same charts as regular Q&A */}
              <div className={`rounded-lg p-3 ${darkMode ? 'bg-gray-900' : 'bg-white border border-gray-200'}`}>
                <div className={`text-sm font-medium mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Community Results</div>
                {isBinary ? (
                  <BinaryChart evaluators={qotdCommunityResults.evaluators} userResponse={qotdResponse} darkMode={darkMode} />
                ) : (
                  <MultipleChoiceChart evaluators={qotdCommunityResults.evaluators} userResponse={qotdResponse} options={qotdData.options || []} darkMode={darkMode} />
                )}
                <div className={`text-sm text-center mt-2 ${darkMode ? 'text-gray-600' : 'text-gray-400'}`}>
                  {qotdCommunityResults.evaluators.length.toLocaleString()} responses
                </div>
              </div>

              {/* Sponsor */}
              <div className={`flex items-center justify-center gap-2 mt-4 p-2 rounded-lg ${darkMode ? 'bg-gray-900/30' : 'bg-gray-50'}`}>
                <span className="text-sm">{qotdData.sponsor.avatar}</span>
                <span className={`text-sm ${darkMode ? 'text-gray-600' : 'text-gray-500'}`}>Sponsored by {qotdData.sponsor.name}</span>
              </div>
            </div>
          ) : (
            <>
              {/* UNANSWERED VIEW - same layout as regular Q&A */}
              <div className="flex-1 flex flex-col justify-center px-4 pb-3 overflow-y-auto">
                <QuestionCard question={qotdQuestion} darkMode={darkMode} evidenceExpanded={false} onToggleEvidence={() => {}} />
                {/* Sponsor under question */}
                <div className={`flex items-center justify-center gap-2 mt-3 ${darkMode ? 'text-gray-600' : 'text-gray-500'}`}>
                  <span className="text-sm">{qotdData.sponsor.avatar}</span>
                  <span className="text-sm">Sponsored by {qotdData.sponsor.name}</span>
                </div>
              </div>

              {/* Fixed Bottom - SAME answer buttons as regular Q&A */}
              <div className={`flex-shrink-0 border-t ${darkMode ? 'border-gray-800 bg-gray-950/80' : 'border-gray-200 bg-white/80'}`}>
                <div className={`px-4 pt-3 ${isBinary ? 'h-[80px]' : ''}`}>
                  {isBinary ? (
                    <BinaryButtons
                      darkMode={darkMode}
                      tappedAnswer={qotdTappedAnswer}
                      tapCount={qotdTapCount}
                      isAnswered={false}
                      currentResponse={null}
                      onTap={(ans) => {
                        if (qotdTappedAnswer === ans) {
                          setQotdTapCount(Math.min(4, qotdTapCount + 1));
                        } else {
                          setQotdTappedAnswer(ans);
                          setQotdTapCount(1);
                        }
                      }}
                      onRightClick={() => {}}
                      pendingSubmit={null}
                      requireConfirmation={true}
                      onSubmit={() => {
                        setQotdResponse({ answer: qotdTappedAnswer, confidence: qotdTapCount });
                        setQotdTappedAnswer(null);
                        setQotdTapCount(0);
                      }}
                    />
                  ) : (
                    <MCButtons
                      options={qotdData.options || []}
                      darkMode={darkMode}
                      tappedAnswer={qotdTappedAnswer}
                      tapCount={qotdTapCount}
                      isAnswered={false}
                      currentResponse={null}
                      onTap={(ans) => {
                        if (qotdTappedAnswer === ans) {
                          setQotdTapCount(Math.min(4, qotdTapCount + 1));
                        } else {
                          setQotdTappedAnswer(ans);
                          setQotdTapCount(1);
                        }
                      }}
                      onRightClick={() => {}}
                      pendingSubmit={null}
                      requireConfirmation={true}
                      onSubmit={() => {
                        setQotdResponse({ answer: qotdTappedAnswer, confidence: qotdTapCount });
                        setQotdTappedAnswer(null);
                        setQotdTapCount(0);
                      }}
                    />
                  )}
                </div>

                {/* Bottom spacer */}
                <div className="h-[40px]" />
              </div>
            </>
          )}
        </div>
      );
    }

    if (screen === 'categories') return (
      <CategoryScreen
        darkMode={darkMode}
        categories={CATEGORIES}
        questions={questions}
        responses={responses}
        onSelectCategory={handleSelectCategory}
        onSettings={goToSettings}
        stats={stats}
        qotdData={qotdData}
        qotdResponse={qotdResponse}
        onQotdClick={() => setScreen('qotd')}
      />
    );

    if (!currentQuestion) return (
      <div className={`flex-1 flex items-center justify-center ${darkMode ? 'text-white' : 'text-gray-900'}`}>
        <div className="text-center p-8"><div className="text-4xl mb-4">ðŸŽ‰</div><div className="text-xl font-medium mb-2">All done!</div></div>
      </div>
    );

    const progress = totalQuestions > 0 ? answeredCount / totalQuestions : 0;
    const hasNext = findNextUnanswered(currentIndex) !== null || currentIndex < questions.length - 1;

    // Generate results for current question if answered but no results yet
    const currentQuestionResults = currentResults || (isAnswered ? generateFakeResults(currentQuestion) : null);
    if (isAnswered && !currentResults) {
      setCommunityResults(prev => ({ ...prev, [currentQuestion.id]: currentQuestionResults }));
    }

    return (
      <div
        className="flex-1 flex flex-col overflow-hidden relative"
        {...swipeHandlers}
      >
        {/* Full-screen undo overlay - uses portal to escape stacking context (mobile only, desktop has its own) */}
        {pendingSubmit && displayMode !== 'desktop' && ReactDOM.createPortal(
          <div
            className="fixed inset-0 z-[9999]"
            onClick={handleUndo}
            onTouchEnd={(e) => { e.preventDefault(); handleUndo(); }}
            style={{ cursor: 'pointer' }}
          />,
          document.body
        )}
        {/* vG-style Navigation Bar with Progress */}
        <div className={`h-[36px] flex-shrink-0 flex items-center gap-2 px-3 ${darkMode ? 'bg-gray-900/50' : 'bg-white border-b border-gray-200'}`}>
          <button
            onClick={goToPrev}
            disabled={currentIndex === 0}
            className={`text-xl font-bold w-8 h-8 flex items-center justify-center ${
              currentIndex === 0
                ? (darkMode ? 'text-gray-700' : 'text-gray-300')
                : (darkMode ? 'text-gray-300 active:text-white' : 'text-gray-600 active:text-gray-900')
            }`}
          >
            â—€
          </button>
          <div className={`flex-1 h-2 rounded-full overflow-hidden ${darkMode ? 'bg-gray-800' : 'bg-gray-300'}`}>
            <div
              className="h-full bg-violet-500 transition-all duration-300"
              style={{ width: `${progress * 100}%` }}
            />
          </div>
          <button
            onClick={goToNext}
            disabled={!hasNext}
            className={`text-xl font-bold w-8 h-8 flex items-center justify-center ${
              !hasNext
                ? (darkMode ? 'text-gray-700' : 'text-gray-300')
                : (darkMode ? 'text-gray-300 active:text-white' : 'text-gray-600 active:text-gray-900')
            }`}
          >
            â–¶
          </button>
        </div>

        {/* Track switching row - three buttons: Y/N count, MC count, All */}
        <div className={`h-[32px] flex-shrink-0 flex items-center justify-center gap-1.5 px-3 ${darkMode ? 'bg-gray-900/30' : 'bg-gray-50'}`}>
          {(() => {
            const ynCount = questions.filter(q => q.type === 'binary' && !responses[q.id]).length;
            const mcCount = questions.filter(q => q.type === 'multiple' && !responses[q.id]).length;
            const allCount = ynCount + mcCount;

            // Switch track and jump to matching question if needed
            const switchTrack = (newTrack) => {
              const toggledTrack = selectedTrack === newTrack ? null : newTrack;
              setSelectedTrack(toggledTrack);

              // If current question doesn't match new filter, jump to first matching
              if (toggledTrack && currentQuestion?.type !== toggledTrack) {
                const matchIdx = questions.findIndex(q => q.type === toggledTrack && !responses[q.id]);
                if (matchIdx >= 0) setCurrentIndex(matchIdx);
              }
            };

            return (
              <>
                <button
                  onClick={() => switchTrack('binary')}
                  className={`w-12 py-1 rounded-md text-sm font-medium transition-all ${
                    selectedTrack === 'binary'
                      ? 'bg-emerald-500 text-white'
                      : darkMode ? 'bg-emerald-900/30 text-emerald-400/70 hover:bg-emerald-900/50' : 'bg-emerald-100 text-emerald-600/70 hover:bg-emerald-200'
                  }`}
                >
                  {ynCount > 0 ? ynCount : 'âœ“'}
                </button>
                <button
                  onClick={() => switchTrack('multiple')}
                  className={`w-12 py-1 rounded-md text-sm font-medium transition-all ${
                    selectedTrack === 'multiple'
                      ? 'bg-violet-500 text-white'
                      : darkMode ? 'bg-violet-900/30 text-violet-400/70 hover:bg-violet-900/50' : 'bg-violet-100 text-violet-600/70 hover:bg-violet-200'
                  }`}
                >
                  {mcCount > 0 ? mcCount : 'âœ“'}
                </button>
                <button
                  onClick={() => switchTrack(null)}
                  className={`w-12 py-1 rounded-md text-sm font-medium transition-all ${
                    selectedTrack === null
                      ? (darkMode ? 'bg-gray-600 text-white' : 'bg-gray-500 text-white')
                      : darkMode ? 'bg-gray-800/50 text-gray-500 hover:bg-gray-700/50' : 'bg-gray-200 text-gray-500 hover:bg-gray-300'
                  }`}
                >
                  {allCount > 0 ? allCount : 'âœ“'}
                </button>
              </>
            );
          })()}
        </div>

        {/* ANSWERED QUESTION VIEW - shows full results */}
        {isAnswered && !pendingSubmit ? (
          <AnsweredQuestionView
            question={currentQuestion}
            response={currentResponse}
            results={currentQuestionResults}
            darkMode={darkMode}
            questionFlag={questionFlags[currentQuestion.id]}
            explanation={answerExplanations[currentQuestion.id]}
            onFlagClick={() => setShowQuestionFlagModal(currentQuestion.id)}
            onExplainClick={() => setShowExplanationModal(currentQuestion.id)}
          />
        ) : (
          <>
            {/* QUESTION AREA - centered in available space */}
            <div className="flex-1 flex flex-col justify-center px-4 pb-3 overflow-y-auto">
              <QuestionCard
                question={currentQuestion}
                darkMode={darkMode}
                evidenceExpanded={evidenceExpanded}
                onToggleEvidence={() => setEvidenceExpanded(!evidenceExpanded)}
              />
            </div>

            {/* FIXED BOTTOM AREA - answer zones */}
            <div className={`flex-shrink-0 border-t ${darkMode ? 'border-gray-800 bg-gray-950' : 'border-gray-200 bg-white'}`}>

              {/* Undone banner - above buttons, not overlaying */}
              {justUndone && (
                <div className="px-4 pt-3 pb-2">
                  <div className={`rounded-xl px-4 py-3 flex items-center justify-between ${darkMode ? 'bg-amber-500/15 border border-amber-500/50' : 'bg-amber-100 border border-amber-300'}`}>
                    <span className={`text-sm font-bold ${darkMode ? 'text-amber-400' : 'text-amber-700'}`}>
                      Undone â€” tap to change or resubmit
                    </span>
                    <button
                      onClick={clearUndoneState}
                      className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-colors ${
                        darkMode ? 'bg-gray-800 text-gray-300 hover:bg-gray-700' : 'bg-white text-gray-700 hover:bg-gray-50 border border-gray-200'
                      }`}
                    >
                      Clear
                    </button>
                  </div>
                </div>
              )}

              {/* Tip Banner - shows once for new users */}
              {showTips && showGestureHint && !isAnswered && !pendingSubmit && !justUndone && (
                <div className="px-4 pt-2">
                  <TipBanner darkMode={darkMode} onDismiss={() => setShowGestureHint(false)} />
                </div>
              )}

              {/* ZONE 1: Answer Buttons - FIXED HEIGHT */}
              <div className={`px-4 ${justUndone ? 'pt-0' : (showTips && showGestureHint && !isAnswered && !pendingSubmit ? 'pt-0' : 'pt-3')} ${isBinary ? 'h-[80px]' : ''}`}>
                {isBinary ? (
                  <BinaryButtons
                    darkMode={darkMode}
                    tappedAnswer={tappedAnswer}
                    tapCount={tapCount}
                    isAnswered={isAnswered}
                    currentResponse={currentResponse}
                    onTap={handleAnswerTap}
                    onRightClick={handleAnswerRightClick}
                    pendingSubmit={pendingSubmit}
                    requireConfirmation={requireConfirmation}
                    onSubmit={submitAnswer}
                  />
                ) : (
                  <MCButtons
                    options={currentQuestion.options}
                    darkMode={darkMode}
                    tappedAnswer={tappedAnswer}
                    tapCount={tapCount}
                    isAnswered={isAnswered}
                    currentResponse={currentResponse}
                    onTap={handleAnswerTap}
                    onRightClick={handleAnswerRightClick}
                    pendingSubmit={pendingSubmit}
                    requireConfirmation={requireConfirmation}
                    onSubmit={submitAnswer}
                  />
                )}
              </div>

              {/* Middle zone: action buttons + confidence hint - UndoBar overlays this */}
              <div className="relative">
                {/* UndoBar overlay - centered in middle zone */}
                {pendingSubmit && (
                  <div className="absolute inset-0 z-20 flex items-center justify-center px-4 pointer-events-none">
                    <div className="w-full pointer-events-auto">
                      <UndoBar
                        darkMode={darkMode}
                        undoDelay={undoDelay}
                        onUndo={handleUndo}
                        answer={pendingSubmit.answer}
                        confidence={pendingSubmit.confidence}
                        isBinary={isBinary}
                        options={currentQuestion.options}
                      />
                    </div>
                  </div>
                )}

                {/* Action buttons row */}
                <div className="h-[36px] px-4 mt-2 flex items-center">
                  {!isAnswered && !pendingSubmit && (
                    <div className="grid grid-cols-4 gap-1.5 w-full">
                      <button
                        onClick={() => isBinary ? setShowCantAnswerModal(currentQuestion?.id) : setShowNoneOptionModal(true)}
                        className={`py-1.5 rounded-lg text-sm transition-colors ${darkMode ? 'bg-gray-800/60 text-gray-500 hover:bg-gray-700/60' : 'bg-gray-200 text-gray-500'}`}
                      >
                        {isBinary ? "Can't" : "None"}
                      </button>
                      <button
                        onClick={() => setShowExplanationModal(currentQuestion?.id)}
                        className={`py-1.5 rounded-lg text-sm transition-colors ${
                          answerExplanations[currentQuestion?.id]
                            ? 'bg-amber-900/30 text-amber-400'
                            : darkMode ? 'bg-gray-800/60 text-gray-500 hover:bg-gray-700/60' : 'bg-gray-200 text-gray-500'
                        }`}
                      >
                        Explain
                      </button>
                      <button
                        onClick={skipQuestion}
                        className={`py-1.5 rounded-lg text-sm transition-colors ${darkMode ? 'bg-gray-800/60 text-gray-500 hover:bg-gray-700/60' : 'bg-gray-200 text-gray-500'}`}
                      >
                        Skip
                      </button>
                      <button
                        onClick={saveForLater}
                        className={`py-1.5 rounded-lg text-sm transition-colors ${
                          savedQuestions.has(currentQuestion?.id)
                            ? 'bg-violet-900/30 text-violet-400'
                            : darkMode ? 'bg-gray-800/60 text-gray-500 hover:bg-gray-700/60' : 'bg-gray-200 text-gray-500'
                        }`}
                      >
                        {savedQuestions.has(currentQuestion?.id) ? 'âœ“ Saved' : 'Save'}
                      </button>
                    </div>
                  )}
                </div>

              </div>

              {/* ZONE 3: Community Browse */}
              <div className="px-4 pb-3 pt-1">
                {(() => {
                  // Only show community results after user has answered at least one question this session
                  const hasAnsweredThisSession = sessionAnsweredCategories.size > 0;

                  // Get list of answered questions with results, sorted by answer time (most recent first)
                  const answeredList = questions
                    .filter(q => responses[q.id] && communityResults[q.id])
                    .sort((a, b) => (responses[b.id]?.timestamp || 0) - (responses[a.id]?.timestamp || 0));
                  if (answeredList.length === 0 || !hasAnsweredThisSession) {
                    return (
                      <div className={`h-full flex items-center justify-center text-sm ${darkMode ? 'text-gray-600' : 'text-gray-400'}`}>
                        Swipe for next â†’
                      </div>
                    );
                  }
                  const safeIdx = Math.min(communityBrowseIndex, answeredList.length - 1);
                  const browseQ = answeredList[safeIdx];
                  const browseResponse = responses[browseQ.id];
                  const browseResults = communityResults[browseQ.id];

                  // Get user's answer display
                  const isBinaryQ = browseQ.type === 'binary';
                  const userAnswer = browseResponse?.answer;
                  const userAnswerText = isBinaryQ
                    ? (userAnswer === 0 ? 'YES' : 'NO')
                    : (browseQ.options?.[userAnswer] || '?');
                  const userAnswerColor = isBinaryQ
                    ? (userAnswer === 0 ? 'text-emerald-400' : 'text-rose-400')
                    : 'text-violet-400';

                  // Hidden mode - just a thin expandable line with + button
                  if (communityDisplayMode === 'hidden') {
                    return (
                      <div className="flex items-center justify-center gap-2" onClick={() => { if (pendingSubmit) handleUndo(); }}>
                        <div className={`flex-1 h-px ${darkMode ? 'bg-gray-800' : 'bg-gray-200'}`} />
                        <button
                          onClick={() => { if (pendingSubmit) { handleUndo(); return; } setCommunityDisplayMode('compact'); }}
                          className={`w-8 h-8 rounded-full flex items-center justify-center text-lg font-light ${
                            darkMode ? 'bg-gray-800 text-gray-400 hover:bg-gray-700' : 'bg-gray-200 text-gray-500 hover:bg-gray-300'
                          } transition-colors`}
                        >+</button>
                        <div className={`flex-1 h-px ${darkMode ? 'bg-gray-800' : 'bg-gray-200'}`} />
                      </div>
                    );
                  }

                  // Compact mode with confidence-segmented bars (conf 4 in center, lower outward)
                  const userConf = Math.min(4, Math.max(1, browseResponse?.confidence || 1)) - 1;
                  const total = browseResults?.evaluators?.length || 1;

                  // Build centered confidence bar: conf4 in center, conf3, conf2, conf1 outward
                  const renderCenteredBar = (byConf, colors, maxCount, isUser) => {
                    // Colors: [dark/conf4, mid-dark/conf3, mid-light/conf2, light/conf1]
                    const totalCount = byConf.reduce((a, b) => a + b, 0);
                    if (totalCount === 0) return null;

                    // Build segments from center out: conf4, conf3, conf2, conf1
                    const leftSegments = []; // conf1, conf2 (left side, light to dark toward center)
                    const rightSegments = []; // conf3, conf4 (right side, dark center to light)

                    // Calculate widths for each confidence level
                    const widths = byConf.map(c => (c / maxCount) * 100);

                    // Center layout: [conf1][conf2][conf3][conf4][conf3][conf2][conf1]
                    // Simplified: just show as gradient from center
                    const segments = [];
                    for (let i = 0; i <= 3; i++) { // conf1(i=0) to conf4(i=3)
                      if (byConf[i] > 0) {
                        segments.push({
                          width: (byConf[i] / maxCount) * 100,
                          color: colors[i], // i=0 is light (conf1), i=3 is dark (conf4)
                          conf: i
                        });
                      }
                    }
                    // Reverse so conf4 (dark) is first/left, conf1 (light) is last/right
                    segments.reverse();

                    const totalWidth = segments.reduce((a, s) => a + s.width, 0);
                    const emptyWidth = 100 - totalWidth;

                    const showEmpty = emptyWidth > 2; // Only show empty if significant
                    return (
                      <div className="flex-1 h-5 rounded-full overflow-hidden flex" style={{ backgroundColor: showEmpty ? 'transparent' : 'transparent', border: showEmpty ? `1px solid ${colors[0]}40` : 'none' }}>
                        {segments.map((s, i) => {
                          const isUserSeg = isUser && s.conf === userConf;
                          const isLast = i === segments.length - 1;
                          const isFirst = i === 0;
                          // Border radius: rounded on edges, flat in middle
                          const userRadius = isFirst && isLast ? '999px' : isFirst ? '999px 0 0 999px' : isLast ? '0 999px 999px 0' : '0';
                          return (
                            <div key={i} className={`h-full ${isLast ? 'rounded-r-full' : ''} ${isFirst ? 'rounded-l-full' : ''}`} style={{
                              width: showEmpty ? `${s.width}%` : (isLast ? undefined : `${s.width}%`),
                              flex: !showEmpty && isLast ? 1 : undefined,
                              backgroundColor: s.color,
                              ...(isUserSeg ? { border: '3px solid white', borderRadius: userRadius, zIndex: 10, position: 'relative' } : {})
                            }} />
                          );
                        })}
                      </div>
                    );
                  };

                  return (
                    <div
                      className="relative"
                      onTouchStart={(e) => { e.stopPropagation(); e.currentTarget.dataset.touchX = e.touches[0].clientX; }}
                      onTouchEnd={(e) => {
                        e.stopPropagation();
                        // During pending submit (non-grace), any touch should undo
                        if (pendingSubmit) {
                          handleUndo();
                          return;
                        }
                        const startX = parseFloat(e.currentTarget.dataset.touchX);
                        const endX = e.changedTouches[0].clientX;
                        const diff = endX - startX;
                        if (Math.abs(diff) > 50) {
                          if (diff > 0 && safeIdx > 0) setCommunityBrowseIndex(safeIdx - 1);
                          else if (diff < 0 && safeIdx < answeredList.length - 1) setCommunityBrowseIndex(safeIdx + 1);
                        }
                      }}
                      onClick={() => {
                        // During pending submit (non-grace), any click should undo
                        if (pendingSubmit) {
                          handleUndo();
                        }
                      }}
                    >
                      {/* Header with LAST and hide button */}
                      <div className="flex items-center gap-1 mb-1">
                        <span className={`text-sm font-black uppercase tracking-wide ${darkMode ? 'text-sky-300' : 'text-sky-500'}`}>LAST:</span>
                        <span className={`text-base truncate flex-1 font-medium ${darkMode ? 'text-gray-100' : 'text-gray-900'}`}>{browseQ.text}</span>
                        <button
                          onClick={(e) => { e.stopPropagation(); if (pendingSubmit) { handleUndo(); return; } setCommunityDisplayMode('hidden'); }}
                          className={`w-5 h-5 rounded flex items-center justify-center text-sm shrink-0 ${
                            darkMode ? 'text-gray-500 hover:text-gray-300' : 'text-gray-400 hover:text-gray-600'
                          }`}
                        >âˆ’</button>
                      </div>

                      {/* Content */}
                      <div onClick={() => {
                        if (pendingSubmit) { handleUndo(); return; }
                        setCommunityExpanded(true);
                      }}>
                        {isBinaryQ ? (() => {
                          const yesColors = ['#6ee7b7', '#34d399', '#10b981', '#059669'];
                          const noColors = ['#fca5a5', '#f87171', '#ef4444', '#dc2626'];

                          const yesByConf = [0, 0, 0, 0];
                          const noByConf = [0, 0, 0, 0];
                          (browseResults?.evaluators || []).forEach(e => {
                            const conf = Math.min(4, Math.max(1, e.confidence || 1)) - 1;
                            if (e.answer === 0) yesByConf[conf]++;
                            else noByConf[conf]++;
                          });

                          const yesTotal = yesByConf.reduce((a, b) => a + b, 0);
                          const noTotal = noByConf.reduce((a, b) => a + b, 0);
                          const yesPct = Math.round((yesTotal / total) * 100);
                          const noPct = 100 - yesPct;
                          const maxCount = Math.max(yesTotal, noTotal);

                          const rows = yesPct >= noPct
                            ? [{ label: 'Yes', pct: yesPct, byConf: yesByConf, colors: yesColors, isYes: true },
                               { label: 'No', pct: noPct, byConf: noByConf, colors: noColors, isYes: false }]
                            : [{ label: 'No', pct: noPct, byConf: noByConf, colors: noColors, isYes: false },
                               { label: 'Yes', pct: yesPct, byConf: yesByConf, colors: yesColors, isYes: true }];

                          return (
                            <div className="space-y-1">
                              {rows.map(row => {
                                const isUser = row.isYes ? userAnswer === 0 : userAnswer === 1;
                                return (
                                  <div key={row.label} className="flex items-center gap-1">
                                    <div className="w-14 sm:w-12 flex-shrink-0">
                                      <span className="text-base sm:text-sm font-semibold px-1.5 py-0.5 rounded-full border" style={{ color: row.colors[3], borderColor: isUser ? row.colors[3] : 'transparent' }}>{row.label}</span>
                                    </div>
                                    <span className="text-base sm:text-sm w-8 sm:w-7 font-bold text-right" style={{ color: row.colors[3] }}>{row.pct}</span>
                                    {renderCenteredBar(row.byConf, row.colors, maxCount, isUser)}
                                  </div>
                                );
                              })}
                            </div>
                          );
                        })() : (() => {
                          /* MC: show user's pick + top pick, tap to expand all */
                          const optionData = {};
                          (browseResults?.evaluators || []).forEach(e => {
                            if (!optionData[e.answer]) optionData[e.answer] = { total: 0, byConf: [0, 0, 0, 0] };
                            optionData[e.answer].total++;
                            const conf = Math.min(4, Math.max(1, e.confidence || 1)) - 1;
                            optionData[e.answer].byConf[conf]++;
                          });

                          const sorted = Object.entries(optionData).sort((a, b) => b[1].total - a[1].total);
                          const topIdx = parseInt(sorted[0]?.[0] || 0);
                          const secondIdx = parseInt(sorted[1]?.[0] || 0);
                          const showSecond = userAnswer === topIdx ? secondIdx : topIdx;
                          const maxCount = sorted[0]?.[1]?.total || 1;

                          const userPct = Math.round(((optionData[userAnswer]?.total || 0) / total) * 100);
                          const otherPct = Math.round(((optionData[showSecond]?.total || 0) / total) * 100);

                          // Use actual MC_COLORS for each answer
                          const userColors = MC_COLORS[userAnswer % MC_COLORS.length].shades;
                          const otherColors = MC_COLORS[showSecond % MC_COLORS.length].shades;

                          const renderRow = (idx, colors, pct, isUser) => {
                            const data = optionData[idx] || { total: 0, byConf: [0, 0, 0, 0] };
                            const label = browseQ.options?.[idx] || '?';
                            return (
                              <div key={idx} className="flex items-center gap-1">
                                <div style={{ width: '40%' }} className="flex-shrink-0">
                                  <span className="text-base sm:text-sm font-semibold inline-block truncate max-w-full px-1.5 py-0.5 rounded-full border" style={{ color: colors[3], borderColor: isUser ? colors[3] : 'transparent' }}>{label}</span>
                                </div>
                                <span className="text-base sm:text-sm w-8 sm:w-7 font-bold text-right" style={{ color: colors[3] }}>{pct}</span>
                                {renderCenteredBar(data.byConf, colors, maxCount, isUser)}
                              </div>
                            );
                          };

                          const rowsOrdered = userPct >= otherPct
                            ? [{ idx: userAnswer, colors: userColors, pct: userPct, isUser: true },
                               { idx: showSecond, colors: otherColors, pct: otherPct, isUser: false }]
                            : [{ idx: showSecond, colors: otherColors, pct: otherPct, isUser: false },
                               { idx: userAnswer, colors: userColors, pct: userPct, isUser: true }];

                          return (
                            <div className="space-y-1">
                              {rowsOrdered.map(r => renderRow(r.idx, r.colors, r.pct, r.isUser))}
                              <div className={`text-sm text-center pt-1 ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>tap to see all {sorted.length} options</div>
                            </div>
                          );
                        })()}
                      </div>
                      <div className={`h-px mt-2 ${darkMode ? 'bg-gray-700' : 'bg-gray-300'}`} />

                      {/* Expanded slide-up panel */}
                      {communityExpanded && (() => {
                        const allRows = [];

                        if (isBinaryQ) {
                          const yesColors = ['#6ee7b7', '#34d399', '#10b981', '#059669'];
                          const noColors = ['#fca5a5', '#f87171', '#ef4444', '#dc2626'];
                          const yesByConf = [0, 0, 0, 0];
                          const noByConf = [0, 0, 0, 0];
                          (browseResults?.evaluators || []).forEach(e => {
                            const conf = Math.min(4, Math.max(1, e.confidence || 1)) - 1;
                            if (e.answer === 0) yesByConf[conf]++;
                            else noByConf[conf]++;
                          });
                          const yesTotal = yesByConf.reduce((a, b) => a + b, 0);
                          const noTotal = noByConf.reduce((a, b) => a + b, 0);
                          const yesPct = Math.round((yesTotal / total) * 100);
                          const noPct = 100 - yesPct;
                          const maxCount = Math.max(yesTotal, noTotal);

                          allRows.push({ label: 'Yes', pct: yesPct, byConf: yesByConf, colors: yesColors, isUser: userAnswer === 0, maxCount });
                          allRows.push({ label: 'No', pct: noPct, byConf: noByConf, colors: noColors, isUser: userAnswer === 1, maxCount });
                          allRows.sort((a, b) => b.pct - a.pct);
                        } else {
                          // MC: show ALL options
                          const optionData = {};
                          (browseResults?.evaluators || []).forEach(e => {
                            if (!optionData[e.answer]) optionData[e.answer] = { total: 0, byConf: [0, 0, 0, 0] };
                            optionData[e.answer].total++;
                            const conf = Math.min(4, Math.max(1, e.confidence || 1)) - 1;
                            optionData[e.answer].byConf[conf]++;
                          });
                          const maxCount = Math.max(...Object.values(optionData).map(d => d.total), 1);

                          // Add all options, sorted by votes
                          browseQ.options?.forEach((opt, idx) => {
                            const data = optionData[idx] || { total: 0, byConf: [0, 0, 0, 0] };
                            const pct = Math.round((data.total / total) * 100);
                            const colors = MC_COLORS[idx % MC_COLORS.length].shades;
                            allRows.push({ label: opt, pct, byConf: data.byConf, colors, isUser: userAnswer === idx, maxCount, idx });
                          });
                          allRows.sort((a, b) => b.pct - a.pct);
                        }

                        return (
                          <div
                            className="fixed inset-0 z-50"
                            onClick={() => setCommunityExpanded(false)}
                          >
                            {/* Slide-up panel - click anywhere closes */}
                            <div
                              className={`absolute bottom-0 left-0 right-0 rounded-t-2xl ${darkMode ? 'bg-gray-900' : 'bg-white'} shadow-2xl`}
                              style={{ animation: 'slideUp 0.2s ease-out' }}
                            >
                              {/* Header */}
                              <div className="flex items-center justify-between px-4 pt-3 pb-2">
                                <span className={`text-sm font-medium ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>All Responses</span>
                                <span className={`text-sm ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>{total} votes</span>
                              </div>

                              {/* Question */}
                              <div className="px-4 pb-2">
                                <p className={`text-base font-medium ${darkMode ? 'text-white' : 'text-gray-900'}`}>{browseQ.text}</p>
                              </div>

                              {/* All rows in same format */}
                              <div className="px-4 pb-4 space-y-1.5">
                                {allRows.map((row, i) => (
                                  <div key={i} className="flex items-center gap-1">
                                    <div style={{ width: isBinaryQ ? '14%' : '40%' }} className="flex-shrink-0">
                                      <span className="text-base sm:text-sm font-semibold inline-block truncate max-w-full px-1.5 py-0.5 rounded-full border"
                                        style={{ color: row.colors[3], borderColor: row.isUser ? row.colors[3] : 'transparent' }}>
                                        {row.label}
                                      </span>
                                    </div>
                                    <span className="text-base sm:text-sm w-8 sm:w-7 font-bold text-right" style={{ color: row.colors[3] }}>{row.pct}</span>
                                    {renderCenteredBar(row.byConf, row.colors, row.maxCount, row.isUser)}
                                  </div>
                                ))}
                              </div>

                              {/* Tap hint */}
                              <div className={`text-sm text-center pb-4 ${darkMode ? 'text-gray-600' : 'text-gray-400'}`}>
                                tap anywhere to close
                              </div>
                            </div>
                          </div>
                        );
                      })()}
                    </div>
                  );
                })()}
              </div>
            </div>
          </>
        )}

        {/* Full Results Modal */}
        {showFullResults && (() => {
          const answeredList = questions
            .filter(q => responses[q.id] && communityResults[q.id])
            .sort((a, b) => (responses[b.id]?.timestamp || 0) - (responses[a.id]?.timestamp || 0));
          const currentIdx = answeredList.findIndex(q => q.id === showFullResults.question.id);
          const goTo = (idx) => {
            if (idx >= 0 && idx < answeredList.length) {
              const q = answeredList[idx];
              setShowFullResults({ question: q, results: communityResults[q.id], response: responses[q.id] });
            }
          };
          return (
            <FullResultsPanel
              question={showFullResults.question}
              results={showFullResults.results}
              userResponse={showFullResults.response}
              darkMode={darkMode}
              onClose={() => setShowFullResults(null)}
              onSwipeLeft={() => goTo(currentIdx + 1)}
              onSwipeRight={() => goTo(currentIdx - 1)}
            />
          );
        })()}

        {/* Question Flag Modal */}
        {showQuestionFlagModal && (
          <QuestionFlagModal
            darkMode={darkMode}
            questionId={showQuestionFlagModal}
            onClose={() => setShowQuestionFlagModal(null)}
            onFlag={handleQuestionFlag}
            onClear={handleClearQuestionFlag}
            existingFlag={questionFlags[showQuestionFlagModal]}
          />
        )}

        {/* Explanation Modal */}
        {showExplanationModal && (
          <ExplanationModal
            darkMode={darkMode}
            questionId={showExplanationModal}
            onClose={() => setShowExplanationModal(null)}
            onSave={handleSaveExplanation}
            onClear={handleClearExplanation}
            existingExplanation={answerExplanations[showExplanationModal]}
          />
        )}

        {/* Can't Answer Modal (binary) */}
        {showCantAnswerModal && (
          <CantAnswerModal
            darkMode={darkMode}
            questionId={showCantAnswerModal}
            onClose={() => setShowCantAnswerModal(null)}
            onSkip={(qId, reason) => {
              setQuestionFlags(prev => ({ ...prev, [qId]: `Can't: ${reason}` }));
              setSkippedQuestions(prev => new Set([...prev, qId]));
              goToNext();
            }}
          />
        )}

        {/* None Option Modal (MC) */}
        {showNoneOptionModal && (
          <NoneOptionModal
            darkMode={darkMode}
            questionId={currentQuestion?.id}
            onClose={() => setShowNoneOptionModal(false)}
            onSubmit={(qId, answer) => {
              setQuestionFlags(prev => ({ ...prev, [qId]: `None fit: ${answer}` }));
              setSkippedQuestions(prev => new Set([...prev, qId]));
              goToNext();
            }}
          />
        )}
      </div>
    );
  };

  if (displayMode === 'desktop') {
    return (
      <>
        {/* Undo overlay - covers entire viewport during ANY pending state */}
        {pendingSubmit && (
          <div
            className="fixed inset-0 z-[9999] bg-transparent"
            onClick={handleUndo}
            onMouseDown={handleUndo}
            style={{ cursor: 'pointer', background: 'transparent' }}
          />
        )}
        <PhoneFrame darkMode={darkMode}>
          <div className="flex-1 flex flex-col overflow-hidden">
            {screen !== 'launch' && screen !== 'settings' && screen !== 'categories' && (
              <NavBar darkMode={darkMode} stats={stats} showStreak={showStreak} onHome={() => setScreen('categories')} onDoubleClickHome={resetDemo} onSettings={goToSettings} onProfile={() => setScreen('profile')} />
            )}
            {renderContent()}
          </div>
        </PhoneFrame>
      </>
    );
  }

  return (
    <div
      className={`h-full flex flex-col ${darkMode ? 'bg-gray-950' : 'bg-gray-50'}`}
      onClickCapture={(e) => {
        if (pendingSubmit) {
          e.stopPropagation();
          handleUndo();
        }
      }}
    >
      {screen !== 'launch' && screen !== 'settings' && screen !== 'categories' && (
        <div className="safe-top">
          <NavBar darkMode={darkMode} stats={stats} showStreak={showStreak} onHome={() => setScreen('categories')} onDoubleClickHome={resetDemo} onSettings={goToSettings} onProfile={() => setScreen('profile')} />
        </div>
      )}
      <div className="flex-1 flex flex-col overflow-hidden">{renderContent()}</div>
      <div className="safe-bottom" />
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
