<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Aura">
  <meta name="theme-color" content="#030712">
  <title>Aura Player vQ</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
  <style>
    :root {
      --sat: env(safe-area-inset-top);
      --sar: env(safe-area-inset-right);
      --sab: env(safe-area-inset-bottom);
      --sal: env(safe-area-inset-left);
    }
    html, body, #root {
      overflow: hidden;
      overscroll-behavior: none;
      -webkit-overflow-scrolling: touch;
      height: 100%;
      width: 100%;
      margin: 0;
      padding: 0;
      background: #030712;
    }
    * {
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
      box-sizing: border-box;
    }
    @media (prefers-color-scheme: dark) {
      :root { color-scheme: dark; }
    }
    .question-text {
      font-size: clamp(20px, 6vw, 28px);
      line-height: 1.35;
      text-wrap: balance;
      text-align: center;
    }
    .text-balance { text-wrap: balance; }
    .safe-top { padding-top: env(safe-area-inset-top); }
    .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
    @keyframes fill { from { width: 100%; } to { width: 0%; } }
    @keyframes shrink { from { width: 100%; } to { width: 0%; } }
    @keyframes barGrow { from { transform: scaleX(0); } to { transform: scaleX(1); } }
    @keyframes fadeSlideIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes orbitRing { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .orbit-anim { animation: orbitRing 0.6s ease-out; }
    @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    @keyframes sweepFill { from { width: 0%; } to { width: 100%; } }
    @keyframes shimmer-pulse {
      0%, 100% { opacity: 0.4; }
      50% { opacity: 0.8; }
    }
    .shine-card { position: relative; }
    .shine-card::before {
      content: '';
      position: absolute;
      inset: -1px;
      border-radius: inherit;
      background: linear-gradient(180deg, var(--accent-bright, rgba(255,255,255,0.5)) 0%, var(--accent-color, rgba(255,255,255,0.2)) 5%, transparent 15%, transparent 100%);
      -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      padding: 2px;
      pointer-events: none;
      z-index: 20;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    .shine-card::after {
      content: '';
      position: absolute;
      inset: -1px;
      border-radius: inherit;
      background: linear-gradient(0deg, var(--accent-bright, rgba(255,255,255,0.5)) 0%, var(--accent-color, rgba(255,255,255,0.2)) 5%, transparent 15%, transparent 100%);
      -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      padding: 2px;
      pointer-events: none;
      z-index: 20;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    .shine-card:hover::before, .shine-card:hover::after { opacity: 1; animation: shimmer-pulse 3s ease-in-out infinite; }
    .shine-card:hover::after { animation-delay: 1.5s; }
    .shine-card:active::before, .shine-card:active::after { opacity: 1; animation: none; }
    .shine-card:active::before { background: linear-gradient(180deg, var(--accent-bright, rgba(255,255,255,0.8)) 0%, var(--accent-color, rgba(255,255,255,0.4)) 8%, transparent 20%, transparent 100%); }
    .shine-card:active::after { background: linear-gradient(0deg, var(--accent-bright, rgba(255,255,255,0.8)) 0%, var(--accent-color, rgba(255,255,255,0.4)) 8%, transparent 20%, transparent 100%); }
    .shine-blue { --accent-color: rgba(59, 130, 246, 0.3); --accent-bright: rgba(147, 197, 253, 0.6); }
    .shine-amber { --accent-color: rgba(251, 191, 36, 0.2); --accent-bright: rgba(253, 224, 71, 0.45); }
    .shine-violet { --accent-color: rgba(139, 92, 246, 0.25); --accent-bright: rgba(196, 181, 253, 0.55); }
    .shine-teal { --accent-color: rgba(45, 212, 191, 0.2); --accent-bright: rgba(153, 246, 228, 0.5); }
    .shine-cyan { --accent-color: rgba(6, 182, 212, 0.25); --accent-bright: rgba(103, 232, 249, 0.55); }
    .shine-gray { --accent-color: rgba(156, 163, 175, 0.2); --accent-bright: rgba(209, 213, 219, 0.45); }
    .shine-emerald { --accent-color: rgba(16, 185, 129, 0.25); --accent-bright: rgba(110, 231, 183, 0.55); }
    .shine-rose { --accent-color: rgba(244, 63, 94, 0.25); --accent-bright: rgba(251, 113, 133, 0.55); }
    .glow-amber { box-shadow: 0 0 20px rgba(251, 191, 36, 0.15), 0 4px 12px rgba(251, 191, 36, 0.1); }
    .glow-violet { box-shadow: 0 0 25px rgba(139, 92, 246, 0.25), 0 4px 15px rgba(139, 92, 246, 0.15); }
    .glow-teal { box-shadow: 0 0 25px rgba(45, 212, 191, 0.2), 0 4px 15px rgba(45, 212, 191, 0.1); }
    .glow-cyan { box-shadow: 0 0 25px rgba(6, 182, 212, 0.2), 0 4px 15px rgba(6, 182, 212, 0.1); }
    .glow-blue { box-shadow: 0 0 30px rgba(59, 130, 246, 0.25), 0 4px 20px rgba(59, 130, 246, 0.15); }
    .glow-gray { box-shadow: 0 0 25px rgba(156, 163, 175, 0.15), 0 4px 15px rgba(156, 163, 175, 0.1); }
    .glow-emerald { box-shadow: 0 0 25px rgba(16, 185, 129, 0.2), 0 4px 15px rgba(16, 185, 129, 0.1); }
    .glow-rose { box-shadow: 0 0 25px rgba(244, 63, 94, 0.2), 0 4px 15px rgba(244, 63, 94, 0.1); }
    .starry-bg {
      background: linear-gradient(135deg, rgba(30, 20, 10, 0.9) 0%, rgba(50, 30, 15, 0.8) 100%);
      position: relative;
    }
    .starry-bg::before {
      content: '';
      position: absolute;
      inset: 0;
      background-image: radial-gradient(1px 1px at 20px 30px, white, transparent),
        radial-gradient(1px 1px at 40px 70px, rgba(255,255,255,0.8), transparent),
        radial-gradient(1px 1px at 50px 45px, rgba(255,255,255,0.6), transparent),
        radial-gradient(1px 1px at 90px 40px, rgba(255,255,255,0.7), transparent),
        radial-gradient(1px 1px at 130px 55px, white, transparent),
        radial-gradient(1px 1px at 160px 35px, rgba(255,255,255,0.5), transparent),
        radial-gradient(1.5px 1.5px at 200px 50px, rgba(255,255,255,0.9), transparent),
        radial-gradient(1px 1px at 250px 60px, rgba(255,255,255,0.6), transparent),
        radial-gradient(1px 1px at 280px 30px, rgba(255,255,255,0.7), transparent),
        radial-gradient(1px 1px at 300px 70px, white, transparent),
        radial-gradient(1px 1px at 70px 55px, rgba(255,255,255,0.8), transparent),
        radial-gradient(1.5px 1.5px at 110px 25px, white, transparent),
        radial-gradient(1px 1px at 175px 65px, rgba(255,255,255,0.7), transparent),
        radial-gradient(1px 1px at 220px 35px, rgba(255,255,255,0.6), transparent),
        radial-gradient(1px 1px at 260px 50px, white, transparent),
        radial-gradient(1.5px 1.5px at 320px 40px, rgba(255,255,255,0.9), transparent),
        radial-gradient(1px 1px at 35px 60px, rgba(255,255,255,0.5), transparent),
        radial-gradient(1px 1px at 145px 70px, rgba(255,255,255,0.8), transparent);
      opacity: 0.7;
      border-radius: inherit;
    }
    .global-stars {
      position: fixed;
      inset: 0;
      background-image:
        radial-gradient(1px 1px at 50px 100px, rgba(255,255,255,0.3), transparent),
        radial-gradient(1px 1px at 150px 200px, rgba(255,255,255,0.2), transparent),
        radial-gradient(1px 1px at 250px 150px, rgba(255,255,255,0.25), transparent),
        radial-gradient(1px 1px at 100px 350px, rgba(255,255,255,0.2), transparent),
        radial-gradient(1px 1px at 300px 400px, rgba(255,255,255,0.3), transparent),
        radial-gradient(1px 1px at 80px 500px, rgba(255,255,255,0.2), transparent),
        radial-gradient(1px 1px at 200px 550px, rgba(255,255,255,0.25), transparent),
        radial-gradient(1px 1px at 350px 300px, rgba(255,255,255,0.2), transparent),
        radial-gradient(1px 1px at 20px 650px, rgba(255,255,255,0.3), transparent),
        radial-gradient(1px 1px at 280px 700px, rgba(255,255,255,0.2), transparent),
        radial-gradient(1px 1px at 120px 750px, rgba(255,255,255,0.25), transparent),
        radial-gradient(1px 1px at 380px 600px, rgba(255,255,255,0.2), transparent),
        radial-gradient(1.5px 1.5px at 180px 450px, rgba(255,255,255,0.35), transparent),
        radial-gradient(1px 1px at 320px 250px, rgba(255,255,255,0.2), transparent);
      pointer-events: none;
      z-index: 0;
    }
    /* Question type indicator circles */
    .q-circle {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      padding: 3px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }
    .q-circle-inner {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 13px;
    }
    .q-circle-binary {
      background: conic-gradient(#ef4444 0deg 180deg, #10b981 180deg 360deg);
    }
    .q-circle-mc {
      background: conic-gradient(
        #3b82f6 0deg 72deg,
        #8b5cf6 72deg 144deg,
        #14b8a6 144deg 216deg,
        #06b6d4 216deg 288deg,
        #ec4899 288deg 360deg
      );
    }
    .q-circle-mixed {
      background: linear-gradient(135deg, #e2e8f0 0%, #94a3b8 50%, #e2e8f0 100%);
    }
    .q-circle-current {
      width: 48px;
      height: 48px;
    }
    .q-circle-current.q-circle-binary {
      box-shadow: -10px 0 16px rgba(16, 185, 129, 0.35), 10px 0 16px rgba(239, 68, 68, 0.3);
    }
    .q-circle-current.q-circle-mc {
      box-shadow:
        8px -6px 12px rgba(59, 130, 246, 0.3),
        0px -10px 12px rgba(139, 92, 246, 0.3),
        -10px 0 12px rgba(20, 184, 166, 0.27),
        -6px 8px 12px rgba(6, 182, 212, 0.27),
        6px 8px 12px rgba(236, 72, 153, 0.3);
    }
    .q-circle-current.q-circle-mixed {
      box-shadow: 0 0 16px rgba(226, 232, 240, 0.35), 0 0 24px rgba(148, 163, 184, 0.24);
    }
    .q-circle-adjacent {
      opacity: 0.6;
    }
    /* Hide scrollbar utility */
    .hide-scrollbar::-webkit-scrollbar { display: none; }
    .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    /* Countdown animation - shrinks from right to left */
    @keyframes countdownShrink { from { transform: scaleX(1); } to { transform: scaleX(0); } }
    /* Assessment celebration animations */
    @keyframes celebrateGlow {
      0% { transform: scale(0.8); opacity: 0; }
      50% { transform: scale(1.2); opacity: 1; }
      100% { transform: scale(1); opacity: 1; }
    }
    @keyframes celebrateRing {
      0% { transform: scale(0.5); opacity: 0; stroke-dashoffset: 440; }
      50% { opacity: 1; }
      100% { transform: scale(1); opacity: 1; stroke-dashoffset: 0; }
    }
    @keyframes celebratePulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    .celebrate-glow { animation: celebrateGlow 0.6s ease-out forwards; }
    .celebrate-ring { animation: celebrateRing 0.8s ease-out forwards; }
    .celebrate-pulse { animation: celebratePulse 1s ease-in-out infinite; }
    /* Button hover/touch feedback - !important to override Tailwind */
    .btn-feedback {
      transition: transform 0.1s ease, filter 0.1s ease !important;
    }
    .btn-feedback:hover {
      filter: brightness(1.15) !important;
    }
    .btn-feedback:active {
      transform: scale(0.96) !important;
      filter: brightness(0.92) !important;
    }
    @media (hover: none) {
      .btn-feedback:hover {
        filter: none !important;
      }
    }
  </style>
</head>
<body>
  <div id="root"></div>
  <script>
// Suppress Tailwind CDN production warning
const _warn = console.warn;
console.warn = (...args) => {
  if (typeof args[0] === 'string' && args[0].includes('cdn.tailwindcss.com')) return;
  _warn.apply(console, args);
};
  </script>
  <script>
// ==================== QUESTIONS DATABASE (INLINE) ====================
const BATCHES = { 1: { name: 'Original', date: '2025-01', count: 440 } };
const CAT_MAP = {
  p: { id: 'prediction', name: 'Predictions', icon: 'ðŸ”®', color: 'amber' },
  r: { id: 'reasoning', name: 'Reasoning', icon: 'ðŸ§ ', color: 'violet' },
  j: { id: 'judgment', name: 'Judgment', icon: 'âš–ï¸', color: 'emerald' },
};
const T = { b: 'binary', m: 'multiple' };
const C = Object.fromEntries(Object.entries(CAT_MAP).map(([k,v]) => [k, v.id]));
const ev = (t, l, v) => ({ type: t === 's' ? 'stat' : 'note', ...(l && {label: l}), ...(t === 's' ? {value: v} : {text: v}) });

const Q_RAW = [
  { id:1, v:1, t:'b', c:'p', q:"Will Bitcoin exceed $150,000 before July 2026?", e:[ev('s','Current Price','$97,234'), ev('s','ATH','$108,786')] },
  { id:2, v:1, t:'m', c:'r', q:"Is a hot dog a sandwich?", o:["Yes, it's bread with filling","No, it's its own category","It's a taco (single folded bread)","Depends on regional definition"], e:[ev('n',null,'Merriam-Webster: sandwich = "two or more slices of bread with filling"')] },
  { id:3, v:1, t:'b', c:'p', q:"Will GPT-5 be released before September 2026?", e:[ev('s','GPT-4 Release','March 2023')] },
  { id:4, v:1, t:'m', c:'j', q:"Which animal would win in a fight?", o:["100 duck-sized horses","1 horse-sized duck","It depends on the terrain","They'd become friends"] },
  { id:5, v:1, t:'b', c:'j', q:"Is this research methodology sound? (Deepfake detection, n=50)", e:[ev('s','Sample Size','n=50'), ev('s','Claimed Accuracy','95%')] },
  { id:6, v:1, t:'m', c:'p', q:"What will be the dominant AI interface by 2030?", o:["Text chat","Voice assistants","AR/VR agents","Brain-computer interfaces","Autonomous agents"] },
  { id:7, v:1, t:'b', c:'r', q:"Is water wet?", e:[ev('n',null,'Wet = covered in water. Can water cover itself?')] },
  { id:8, v:1, t:'m', c:'j', q:"Best programming language for beginners in 2026?", o:["Python","JavaScript","Scratch/visual coding","Natural language (AI-assisted)","Rust"] },
  { id:9, v:1, t:'b', c:'p', q:"Will humans land on Mars before 2035?", e:[ev('s','SpaceX target','2029'), ev('s','NASA target','2040')] },
  { id:10, v:1, t:'m', c:'r', q:"Is a Pop-Tart a ravioli?", o:["Yes - filling enclosed in carb wrapper","No - ravioli must be savory","No - ravioli must be pasta","It's actually a dumpling"] },
  { id:11, v:1, t:'b', c:'j', q:"Could an average person beat a goose in a fight?", e:[ev('s','Avg goose weight','8-14 lbs')] },
  { id:12, v:1, t:'m', c:'p', q:"Most likely cause of human extinction?", o:["AI/technology","Climate change","Pandemic/bioweapon","Nuclear war","Asteroid impact"] },
  { id:13, v:1, t:'b', c:'p', q:"Will Taylor Swift announce retirement before 2030?" },
  { id:14, v:1, t:'m', c:'j', q:"What should happen to daylight saving time?", o:["Keep switching twice a year","Permanent daylight time","Permanent standard time","Let each state decide"] },
  { id:15, v:1, t:'b', c:'p', q:"Will lab-grown meat achieve price parity by 2028?", e:[ev('s','2013 cost','$330,000/burger'), ev('s','2025 cost','$6/burger')] },
  { id:16, v:1, t:'b', c:'j', q:"Could Batman beat Superman (no prep, no kryptonite)?" },
  { id:17, v:1, t:'m', c:'r', q:"Ship of Theseus: replace every part, same ship?", o:["Yes - continuity of identity","No - it's a new ship","The original uses old parts","Identity is an illusion"] },
  { id:18, v:1, t:'b', c:'p', q:"Will any AI pass an 8-hour Turing test by 2027?" },
  { id:19, v:1, t:'b', c:'r', q:"Is the simulation hypothesis likely?", e:[ev('n',null,"Bostrom's trilemma argument")] },
  { id:20, v:1, t:'m', c:'j', q:"Most important skill for the next decade?", o:["AI/ML literacy","Critical thinking","Emotional intelligence","Adaptability","Domain expertise"] },
  { id:21, v:1, t:'b', c:'r', q:"Is 847 + 256 greater than 1100?" },
  { id:22, v:1, t:'m', c:'r', q:"What color results from mixing red + blue?", o:["Green","Purple","Orange","Brown"] },
  { id:23, v:1, t:'b', c:'r', q:"Does 'rhythm' contain a vowel (a,e,i,o,u)?" },
  { id:24, v:1, t:'m', c:'r', q:"What comes next: 2, 4, 8, 16, __?", o:["24","32","20","18"] },
  { id:25, v:1, t:'b', c:'r', q:"Is Australia larger than Europe (by land area)?" },
  { id:26, v:1, t:'b', c:'p', q:"Will electric vehicles exceed 50% of US new car sales by 2030?", e:[ev('s','2024 US EV share','~9%')] },
  { id:27, v:1, t:'m', c:'p', q:"Which company will dominate AI by 2030?", o:["OpenAI","Google/DeepMind","Anthropic","Meta","A company that doesn't exist yet"] },
  { id:28, v:1, t:'b', c:'r', q:"Is free will an illusion?" },
  { id:29, v:1, t:'m', c:'j', q:"What's the most ethical diet?", o:["Vegan","Vegetarian","Pescatarian","Local/sustainable omnivore","Lab-grown meat when available"] },
  { id:30, v:1, t:'b', c:'p', q:"Will remote work remain dominant in tech by 2030?" },
  { id:31, v:1, t:'b', c:'j', q:"Should social media require age verification?" },
  { id:32, v:1, t:'m', c:'j', q:"Most overrated tech of the 2020s?", o:["NFTs","Metaverse/VR","Crypto/blockchain","AI assistants","Self-driving cars"] },
  { id:33, v:1, t:'b', c:'p', q:"Will quantum computers break current encryption by 2035?" },
  { id:34, v:1, t:'b', c:'r', q:"Is cereal a soup?" },
  { id:35, v:1, t:'m', c:'j', q:"Best way to make friends as an adult?", o:["Hobbies/clubs","Through work","Apps (Bumble BFF, etc.)","Neighbors/community","Accept loneliness"] },
  { id:36, v:1, t:'b', c:'r', q:"Is 17 a prime number?" },
  { id:37, v:1, t:'m', c:'r', q:"What is âˆš144?", o:["10","11","12","14"] },
  { id:38, v:1, t:'b', c:'r', q:"Is the Pacific Ocean the largest ocean?" },
  { id:39, v:1, t:'b', c:'p', q:"Will a woman be elected US President by 2032?" },
  { id:40, v:1, t:'m', c:'j', q:"What age should you be allowed to vote?", o:["16","18","21","25","Any age"] },
  { id:41, v:1, t:'b', c:'p', q:"Will China's GDP surpass the US by 2035?", e:[ev('s','US GDP (2024)','$28.8T'), ev('s','China GDP (2024)','$18.5T')] },
  { id:42, v:1, t:'b', c:'p', q:"Will commercial fusion power be operational by 2040?" },
  { id:43, v:1, t:'m', c:'p', q:"Which country will lead in AI development by 2035?", o:["United States","China","European Union","India","Distributed/No single leader"] },
  { id:44, v:1, t:'b', c:'p', q:"Will Neuralink have 1,000+ human users by 2030?", e:[ev('s','First implant','January 2024')] },
  { id:45, v:1, t:'b', c:'p', q:"Will global population decline before 2100?", e:[ev('s','UN projection','Peak ~10.4B in 2086')] },
  { id:46, v:1, t:'m', c:'p', q:"What will cause the next major financial crisis?", o:["AI displacement","Climate disasters","Sovereign debt","Crypto collapse","Geopolitical conflict"] },
  { id:47, v:1, t:'b', c:'p', q:"Will autonomous vehicles be legal in all US states by 2030?" },
  { id:48, v:1, t:'b', c:'p', q:"Will the US return to the Moon before China?", e:[ev('s','Artemis III target','2026'), ev('s','China target','2030')] },
  { id:49, v:1, t:'m', c:'p', q:"What will be the #1 cause of death globally in 2050?", o:["Heart disease","Cancer","Antimicrobial resistance","Climate-related","Mental health/suicide"] },
  { id:50, v:1, t:'b', c:'p', q:"Will any cryptocurrency become legal tender in a G7 nation by 2030?" },
  { id:51, v:1, t:'b', c:'p', q:"Will average US home prices exceed $500k by 2030?", e:[ev('s','2024 median','$420,000')] },
  { id:52, v:1, t:'m', c:'p', q:"Which social platform will have the most users in 2030?", o:["TikTok/ByteDance","Instagram/Meta","YouTube","WeChat","Something new"] },
  { id:53, v:1, t:'b', c:'p', q:"Will deepfakes influence a major election outcome by 2028?" },
  { id:54, v:1, t:'b', c:'p', q:"Will antibiotics still be effective against most infections in 2040?" },
  { id:55, v:1, t:'m', c:'p', q:"What will happen to Twitter/X by 2030?", o:["Still dominant","Acquired by another company","Bankrupt/shut down","Transformed into something else","Niche platform"] },
  { id:56, v:1, t:'b', c:'p', q:"Will a major city become uninhabitable due to climate by 2050?" },
  { id:57, v:1, t:'b', c:'p', q:"Will commercial space tourism have 10,000+ customers by 2035?" },
  { id:58, v:1, t:'m', c:'p', q:"Which industry will AI disrupt most by 2030?", o:["Healthcare","Legal","Education","Finance","Creative/Media"] },
  { id:59, v:1, t:'b', c:'p', q:"Will there be a manned mission to an asteroid by 2040?" },
  { id:60, v:1, t:'b', c:'p', q:"Will the EU still exist in its current form in 2040?" },
  { id:61, v:1, t:'m', c:'p', q:"What will be the dominant energy source globally by 2050?", o:["Solar","Nuclear (fission)","Nuclear (fusion)","Natural gas","Mix with no dominant"] },
  { id:62, v:1, t:'b', c:'p', q:"Will life expectancy in developed nations exceed 90 by 2060?" },
  { id:63, v:1, t:'b', c:'p', q:"Will AI-generated content be majority of internet content by 2035?" },
  { id:64, v:1, t:'m', c:'p', q:"How will most people commute in major cities in 2040?", o:["Personal EVs","Public transit","Autonomous ride-share","E-bikes/scooters","Remote work (no commute)"] },
  { id:65, v:1, t:'b', c:'p', q:"Will any tech company reach $10 trillion market cap by 2035?", e:[ev('s','Apple (2024)','~$3.5T')] },
  { id:66, v:1, t:'b', c:'p', q:"Will lab-grown organs be standard medical practice by 2040?" },
  { id:67, v:1, t:'m', c:'p', q:"Which renewable will grow fastest 2025-2035?", o:["Solar","Wind","Geothermal","Hydrogen","Nuclear"] },
  { id:68, v:1, t:'b', c:'p', q:"Will physical cash be eliminated in any major economy by 2035?" },
  { id:69, v:1, t:'b', c:'p', q:"Will we discover definitive evidence of extraterrestrial life by 2050?" },
  { id:70, v:1, t:'m', c:'p', q:"What will college education look like in 2040?", o:["Similar to now","Mostly online","AI-tutored/personalized","Shorter/bootcamp style","Obsolete/replaced by credentials"] },
  { id:71, v:1, t:'b', c:'p', q:"Will global meat consumption decline by 2035?" },
  { id:72, v:1, t:'b', c:'p', q:"Will any country implement a 4-day work week nationally by 2030?" },
  { id:73, v:1, t:'m', c:'p', q:"What will be the next pandemic pathogen type?", o:["Influenza variant","Coronavirus","Bacterial","Fungal","Engineered/bioweapon"] },
  { id:74, v:1, t:'b', c:'p', q:"Will AGI (Artificial General Intelligence) exist by 2035?" },
  { id:75, v:1, t:'b', c:'p', q:"Will the Arctic be ice-free in summer before 2040?", e:[ev('n',null,'Ice extent declining ~13% per decade')] },
  { id:76, v:1, t:'m', c:'p', q:"What will replace smartphones as primary device?", o:["AR glasses","Neural interfaces","Smart watches","Nothing/phones evolve","AI agents (deviceless)"] },
  { id:77, v:1, t:'b', c:'p', q:"Will India become a top 3 global economy by 2030?", e:[ev('s','Current rank','#5')] },
  { id:78, v:1, t:'b', c:'p', q:"Will most new music be AI-generated by 2035?" },
  { id:79, v:1, t:'m', c:'p', q:"What will happen to housing costs in major cities by 2035?", o:["Continue rising","Plateau","Decline significantly","Bifurcate (luxury vs affordable)","Government intervention stabilizes"] },
  { id:80, v:1, t:'b', c:'p', q:"Will autonomous ships handle majority of global shipping by 2040?" },
  { id:81, v:1, t:'b', c:'r', q:"Can a teleporter that destroys and recreates you preserve your identity?" },
  { id:82, v:1, t:'m', c:'r', q:"What makes an action morally right?", o:["Consequences (utilitarianism)","Intent (deontology)","Character (virtue ethics)","Social contract","Nothing objective"] },
  { id:83, v:1, t:'b', c:'r', q:"Is it ethical to create sentient AI?" },
  { id:84, v:1, t:'b', c:'r', q:"Does the trolley problem have a correct answer?", e:[ev('n',null,'Pull lever to save 5, killing 1?')] },
  { id:85, v:1, t:'m', c:'r', q:"What is the nature of consciousness?", o:["Physical brain processes","Emergent property","Fundamental like mass/charge","Illusion","Unknowable"] },
  { id:86, v:1, t:'b', c:'r', q:"Is mathematics discovered (not invented)?" },
  { id:87, v:1, t:'b', c:'r', q:"Can machines ever truly understand (not just simulate)?" },
  { id:88, v:1, t:'m', c:'r', q:"What gives life meaning?", o:["Relationships","Achievement","Pleasure","Purpose/contribution","Nothing inherent"] },
  { id:89, v:1, t:'b', c:'r', q:"Is it wrong to eat animals if alternatives exist?" },
  { id:90, v:1, t:'b', c:'r', q:"Would you take a pill that makes you perpetually happy but delusional?" },
  { id:91, v:1, t:'m', c:'r', q:"If you could live forever, would you want to?", o:["Yes, unconditionally","Yes, with exit option","Only if others could too","No, death gives meaning","Depends on quality of life"] },
  { id:92, v:1, t:'b', c:'r', q:"Is privacy a fundamental right?" },
  { id:93, v:1, t:'b', c:'r', q:"Are humans fundamentally good?" },
  { id:94, v:1, t:'m', c:'r', q:"What is the self?", o:["Continuous soul/essence","Pattern of memories","Illusion","Body/brain","Social construction"] },
  { id:95, v:1, t:'b', c:'r', q:"Is it ethical to gene-edit embryos to prevent disease?" },
  { id:96, v:1, t:'b', c:'r', q:"Can something be art if created by accident?" },
  { id:97, v:1, t:'m', c:'r', q:"What matters more: intention or outcome?", o:["Intention always","Outcome always","Depends on context","Both equally","Neither/virtue matters"] },
  { id:98, v:1, t:'b', c:'r', q:"Is a perfect simulation of a person the same as that person?" },
  { id:99, v:1, t:'b', c:'r', q:"Do animals have rights?" },
  { id:100, v:1, t:'m', c:'r', q:"Why is there something rather than nothing?", o:["God/creator","Physical necessity","Anthropic principle","Brute fact","Question is meaningless"] },
  { id:101, v:1, t:'b', c:'r', q:"Is time travel logically possible?" },
  { id:102, v:1, t:'b', c:'r', q:"Can we ever truly know another person's mind?" },
  { id:103, v:1, t:'m', c:'r', q:"What makes someone the 'same person' over time?", o:["Physical continuity","Memory continuity","Personality","Soul","Legal/social recognition"] },
  { id:104, v:1, t:'b', c:'r', q:"Is it ethical to bring children into a world with suffering?" },
  { id:105, v:1, t:'b', c:'r', q:"Can art be objectively evaluated?" },
  { id:106, v:1, t:'m', c:'r', q:"What is truth?", o:["Correspondence to reality","Coherence with beliefs","What works (pragmatism)","Social consensus","Unknowable"] },
  { id:107, v:1, t:'b', c:'r', q:"Is laziness a vice?" },
  { id:108, v:1, t:'b', c:'r', q:"Would you want to know the exact date of your death?" },
  { id:109, v:1, t:'m', c:'r', q:"Is a calorie-restricted long life better than a shorter indulgent one?", o:["Long life always better","Short indulgent better","Depends on the person","Quality > quantity","False dichotomy"] },
  { id:110, v:1, t:'b', c:'r', q:"Is cultural appropriation always wrong?" },
  { id:111, v:1, t:'b', c:'r', q:"Can evil actions ever be justified by good outcomes?" },
  { id:112, v:1, t:'m', c:'r', q:"What is the purpose of punishment?", o:["Deterrence","Rehabilitation","Retribution","Public safety","No valid purpose"] },
  { id:113, v:1, t:'b', c:'r', q:"Is ignorance ever bliss?" },
  { id:114, v:1, t:'b', c:'r', q:"Do we have moral obligations to future generations?" },
  { id:115, v:1, t:'m', c:'r', q:"Is a lie ever morally required?", o:["Never","To prevent harm","To protect feelings","In war/self-defense","Lies are neutral tools"] },
  { id:116, v:1, t:'b', c:'j', q:"Should billionaires exist?" },
  { id:117, v:1, t:'m', c:'j', q:"What's the best economic system?", o:["Capitalism","Socialism","Mixed economy","Something new","Depends on context"] },
  { id:118, v:1, t:'b', c:'j', q:"Should college be free?" },
  { id:119, v:1, t:'b', c:'j', q:"Is cancel culture a net positive?" },
  { id:120, v:1, t:'m', c:'j', q:"How should AI be regulated?", o:["Strict government control","Industry self-regulation","International treaty","Minimal regulation","Case-by-case basis"] },
  { id:121, v:1, t:'b', c:'j', q:"Should voting be mandatory?", e:[ev('s','Australia turnout','~95%')] },
  { id:122, v:1, t:'b', c:'j', q:"Is the death penalty ever justified?" },
  { id:123, v:1, t:'m', c:'j', q:"What should be done about illegal immigration?", o:["Open borders","Path to citizenship","Stricter enforcement","Guest worker programs","Address root causes"] },
  { id:124, v:1, t:'b', c:'j', q:"Should drugs be decriminalized?" },
  { id:125, v:1, t:'b', c:'j', q:"Is universal basic income a good idea?" },
  { id:126, v:1, t:'m', c:'j', q:"Who should control the internet?", o:["Governments","Private companies","International body","Decentralized/no one","Users collectively"] },
  { id:127, v:1, t:'b', c:'j', q:"Should hate speech be illegal?" },
  { id:128, v:1, t:'b', c:'j', q:"Is affirmative action justified?" },
  { id:129, v:1, t:'m', c:'j', q:"What's the right approach to climate policy?", o:["Carbon tax","Regulations/mandates","Subsidies for green tech","Nuclear expansion","Adaptation focus"] },
  { id:130, v:1, t:'b', c:'j', q:"Should assisted suicide be legal?" },
  { id:131, v:1, t:'b', c:'j', q:"Are private schools harmful to public education?" },
  { id:132, v:1, t:'m', c:'j', q:"How should we handle wealth inequality?", o:["Progressive taxation","Wealth caps","Universal services","Education/opportunity","It's not a problem"] },
  { id:133, v:1, t:'b', c:'j', q:"Should AI art be copyrightable?" },
  { id:134, v:1, t:'b', c:'j', q:"Is nationalism inherently dangerous?" },
  { id:135, v:1, t:'m', c:'j', q:"What should replace prisons?", o:["Nothing - reform prisons","Rehabilitation centers","Restorative justice","Electronic monitoring","Community service"] },
  { id:136, v:1, t:'b', c:'j', q:"Should parents be able to select embryos for traits?" },
  { id:137, v:1, t:'b', c:'j', q:"Is a global government desirable?" },
  { id:138, v:1, t:'m', c:'j', q:"How should gig workers be classified?", o:["Employees","Contractors","New category","Worker's choice","Depends on the job"] },
  { id:139, v:1, t:'b', c:'j', q:"Should tech companies be broken up?" },
  { id:140, v:1, t:'b', c:'j', q:"Is zoning reform the solution to housing costs?" },
  { id:141, v:1, t:'m', c:'j', q:"What's the best voting system?", o:["First-past-the-post","Ranked choice","Proportional representation","Approval voting","Sortition (random selection)"] },
  { id:142, v:1, t:'b', c:'j', q:"Should there be limits on free speech online?" },
  { id:143, v:1, t:'b', c:'j', q:"Is meritocracy a myth?" },
  { id:144, v:1, t:'m', c:'j', q:"How should social media moderate content?", o:["Government oversight","Platform discretion","User-controlled filters","No moderation","Community-based moderation"] },
  { id:145, v:1, t:'b', c:'j', q:"Should voting age be lowered to 16?" },
  { id:146, v:1, t:'b', c:'j', q:"Are unions still necessary?" },
  { id:147, v:1, t:'m', c:'j', q:"What's the solution to political polarization?", o:["Media reform","Education","Electoral reform","Economic equality","No solution exists"] },
  { id:148, v:1, t:'b', c:'j', q:"Should wealthy nations pay climate reparations?" },
  { id:149, v:1, t:'b', c:'j', q:"Is remote work better for society overall?" },
  { id:150, v:1, t:'m', c:'j', q:"How should we handle misinformation?", o:["Government regulation","Platform labels/removal","Media literacy education","Let marketplace decide","Impossible to solve"] },
  { id:151, v:1, t:'m', c:'j', q:"What's the best decade for music?", o:["1960s","1970s","1980s","1990s","2000s+"] },
  { id:152, v:1, t:'b', c:'j', q:"Is working from home better than office work?" },
  { id:153, v:1, t:'m', c:'j', q:"What's the ideal vacation length?", o:["Long weekend (3-4 days)","One week","Two weeks","One month+","Frequent short trips"] },
  { id:154, v:1, t:'b', c:'j', q:"Are audiobooks as good as reading?" },
  { id:155, v:1, t:'m', c:'j', q:"What's the best coffee preparation?", o:["Espresso","Pour over","French press","Drip","Cold brew"] },
  { id:156, v:1, t:'b', c:'j', q:"Is buying a home better than renting?" },
  { id:157, v:1, t:'m', c:'j', q:"What's the ideal number of children?", o:["Zero","One","Two","Three","Four+"] },
  { id:158, v:1, t:'b', c:'j', q:"Are open offices a bad idea?" },
  { id:159, v:1, t:'m', c:'j', q:"What's the best way to exercise?", o:["Gym/weights","Running/cardio","Sports/games","Yoga/flexibility","Walking"] },
  { id:160, v:1, t:'b', c:'j', q:"Is social media net negative for society?" },
  { id:161, v:1, t:'m', c:'j', q:"What's the ideal work schedule?", o:["9-5, five days","4-day week","Flexible hours","Results-only","Varies by person"] },
  { id:162, v:1, t:'b', c:'j', q:"Are video games a waste of time?" },
  { id:163, v:1, t:'m', c:'j', q:"What's the best pet for a busy person?", o:["Cat","Dog","Fish","No pet","Low-maintenance reptile"] },
  { id:164, v:1, t:'b', c:'j', q:"Should you always follow your passion for a career?" },
  { id:165, v:1, t:'m', c:'j', q:"What's the ideal retirement age?", o:["55","60","65","70","Never fully retire"] },
  { id:166, v:1, t:'b', c:'j', q:"Is a college degree still worth it?" },
  { id:167, v:1, t:'m', c:'j', q:"What's the best news source format?", o:["Print newspaper","TV news","Podcasts","Social media","News apps/aggregators"] },
  { id:168, v:1, t:'b', c:'j', q:"Are smartphones making us less intelligent?" },
  { id:169, v:1, t:'m', c:'j', q:"What's the ideal city size to live in?", o:["Small town (<50k)","Medium city (50-500k)","Large city (500k-2M)","Major metro (2M+)","Rural/countryside"] },
  { id:170, v:1, t:'b', c:'j', q:"Is it okay to ghost someone after a few dates?" },
  { id:171, v:1, t:'m', c:'j', q:"What's more important in a job?", o:["Salary","Work-life balance","Interesting work","Good colleagues","Career growth"] },
  { id:172, v:1, t:'b', c:'j', q:"Should you tell a friend their partner is cheating?" },
  { id:173, v:1, t:'m', c:'j', q:"What's the best breakfast?", o:["Continental (pastry/coffee)","Full cooked breakfast","Healthy (smoothie/oatmeal)","Skip breakfast","Whatever's available"] },
  { id:174, v:1, t:'b', c:'j', q:"Is it rude to recline your seat on a plane?" },
  { id:175, v:1, t:'m', c:'j', q:"What's the ideal age to get married?", o:["Early 20s","Late 20s","Early 30s","35+","Never/optional"] },
  { id:176, v:1, t:'b', c:'j', q:"Are reality TV shows harmful?" },
  { id:177, v:1, t:'m', c:'j', q:"What's the best streaming service?", o:["Netflix","Disney+","HBO Max","Amazon Prime","YouTube"] },
  { id:178, v:1, t:'b', c:'j', q:"Is tipping culture a good thing?" },
  { id:179, v:1, t:'m', c:'j', q:"What's more important: IQ or EQ?", o:["IQ","EQ","Both equally","Neither/other factors","Depends on context"] },
  { id:180, v:1, t:'b', c:'j', q:"Should you lend money to friends?" },
  { id:181, v:1, t:'m', c:'j', q:"What's the best way to learn a language?", o:["Apps (Duolingo)","Classes","Immersion","Tutoring","Media consumption"] },
  { id:182, v:1, t:'b', c:'j', q:"Is minimalism a superior lifestyle?" },
  { id:183, v:1, t:'m', c:'j', q:"What makes a house a home?", o:["Family/people","Personal belongings","Time spent there","Ownership","Feeling of safety"] },
  { id:184, v:1, t:'b', c:'j', q:"Should couples combine finances?" },
  { id:185, v:1, t:'m', c:'j', q:"What's the ideal amount of sleep?", o:["5-6 hours","7 hours","8 hours","9+ hours","Varies by person"] },
  { id:186, v:1, t:'b', c:'j', q:"Is cold weather better than hot weather?" },
  { id:187, v:1, t:'m', c:'j', q:"What's the best time of day to work out?", o:["Early morning","Late morning","Lunchtime","After work","Evening"] },
  { id:188, v:1, t:'b', c:'j', q:"Are New Year's resolutions pointless?" },
  { id:189, v:1, t:'m', c:'j', q:"What's the ideal commute time?", o:["Under 10 min","10-20 min","20-30 min","30-45 min","No commute (remote)"] },
  { id:190, v:1, t:'b', c:'j', q:"Is being an early bird better than night owl?" },
  { id:191, v:1, t:'b', c:'j', q:"Is this headline misleading? 'Study finds coffee drinkers live longer'", e:[ev('n',null,'Correlation study, n=10,000, no controls for lifestyle')] },
  { id:192, v:1, t:'m', c:'j', q:"Rate this business pitch: 'Uber for dog walking'", o:["Strong - clear market","Medium - competitive space","Weak - already exists","Need more info"] },
  { id:193, v:1, t:'b', c:'j', q:"Is this statistic meaningful? '90% of startups fail'", e:[ev('n',null,'Definition of "fail" and timeframe vary widely')] },
  { id:194, v:1, t:'b', c:'j', q:"Is this a valid argument? 'Most CEOs are tall, so being tall helps you succeed'" },
  { id:195, v:1, t:'m', c:'j', q:"Rate this excuse for being late: 'Traffic was bad'", o:["Completely valid","Usually acceptable","Weak excuse","Unacceptable","Depends on frequency"] },
  { id:196, v:1, t:'b', c:'j', q:"Is this claim verifiable? 'Our AI reduces costs by 40%'" },
  { id:197, v:1, t:'m', c:'j', q:"Rate this study design: Survey of 100 Twitter users about public opinion", o:["Strong methodology","Acceptable with caveats","Weak but usable","Fundamentally flawed"] },
  { id:198, v:1, t:'b', c:'j', q:"Is this a conflict of interest? Nutrition study funded by food company" },
  { id:199, v:1, t:'b', c:'j', q:"Is this photo likely AI-generated? (Perfect symmetry, 6 fingers)" },
  { id:200, v:1, t:'m', c:'j', q:"Rate this investment thesis: 'AI will replace all jobs, so invest in robots'", o:["Sound reasoning","Partially valid","Oversimplified","Fundamentally wrong"] },
  { id:201, v:1, t:'b', c:'j', q:"Is this apology genuine? 'I'm sorry you feel that way'" },
  { id:202, v:1, t:'b', c:'j', q:"Is this product review trustworthy? 5 stars, 3 words, verified purchase" },
  { id:203, v:1, t:'m', c:'j', q:"Rate this job posting: 'Fast-paced environment, wear many hats, competitive salary'", o:["Attractive opportunity","Yellow flags","Red flags","Need more info"] },
  { id:204, v:1, t:'b', c:'j', q:"Is this a logical fallacy? 'Everyone's doing it, so it must be okay'" },
  { id:205, v:1, t:'b', c:'j', q:"Is this sample size adequate? Medical trial with 50 participants", e:[ev('n',null,'Testing rare disease treatment')] },
  { id:206, v:1, t:'m', c:'j', q:"Rate this dating profile: 'No drama, know what I want, fluent in sarcasm'", o:["Appealing","Neutral","Off-putting","Depends on audience"] },
  { id:207, v:1, t:'b', c:'j', q:"Is this reasoning sound? 'Stock went up after I bought it, so I'm a good investor'" },
  { id:208, v:1, t:'b', c:'j', q:"Is this email a scam? 'Urgent: Verify your account or lose access'" },
  { id:209, v:1, t:'m', c:'j', q:"Rate this restaurant review: '1 star - food was great but parking was hard'", o:["Fair rating","Unfair rating","Useful information","Should be ignored"] },
  { id:210, v:1, t:'b', c:'j', q:"Is this correlation meaningful? 'Ice cream sales and drowning deaths both rise in summer'" },
  { id:211, v:1, t:'b', c:'j', q:"Is this expertise relevant? Physicist commenting on economics" },
  { id:212, v:1, t:'m', c:'j', q:"Rate this prediction track record: 60% accuracy on binary outcomes", o:["Excellent","Good","Mediocre","Poor","Need more context"] },
  { id:213, v:1, t:'b', c:'j', q:"Is this source reliable? Wikipedia article with 50 citations" },
  { id:214, v:1, t:'b', c:'j', q:"Is this a valid comparison? 'Company X is the Airbnb of Y industry'" },
  { id:215, v:1, t:'m', c:'j', q:"Rate this feedback: 'Good job, but could be better'", o:["Helpful","Somewhat helpful","Useless","Harmful"] },
  { id:216, v:1, t:'b', c:'r', q:"Is 2^10 greater than 1000?", e:[ev('n',null,'2^10 = 1024')] },
  { id:217, v:1, t:'m', c:'r', q:"What comes next: 1, 1, 2, 3, 5, 8, __?", o:["11","12","13","15"] },
  { id:218, v:1, t:'b', c:'r', q:"Can a year have two Friday the 13ths?" },
  { id:219, v:1, t:'b', c:'r', q:"Is the sum of angles in a triangle always 180Â°?" },
  { id:220, v:1, t:'m', c:'r', q:"How many states does the US have?", o:["48","50","51","52"] },
  { id:221, v:1, t:'b', c:'r', q:"Is the speed of light faster than the speed of sound?" },
  { id:222, v:1, t:'m', c:'r', q:"What is 15% of 80?", o:["10","12","15","18"] },
  { id:223, v:1, t:'b', c:'r', q:"Can you fold a piece of paper more than 7 times?" },
  { id:224, v:1, t:'b', c:'r', q:"Is a tomato a fruit?" },
  { id:225, v:1, t:'m', c:'r', q:"How many planets in our solar system?", o:["7","8","9","10"] },
  { id:226, v:1, t:'b', c:'r', q:"Is 0.999... (repeating) equal to 1?" },
  { id:227, v:1, t:'m', c:'r', q:"What day follows Saturday?", o:["Friday","Sunday","Monday","Sabbath"] },
  { id:228, v:1, t:'b', c:'r', q:"Can a triangle have two right angles?" },
  { id:229, v:1, t:'b', c:'r', q:"Is Venus hotter than Mercury?", e:[ev('n',null,'Mercury is closer to the Sun')] },
  { id:230, v:1, t:'m', c:'r', q:"What is the square root of 169?", o:["11","12","13","14"] },
  { id:231, v:1, t:'b', c:'r', q:"Do all mammals give live birth?" },
  { id:232, v:1, t:'b', c:'r', q:"Is Ï€ (pi) a rational number?" },
  { id:233, v:1, t:'m', c:'r', q:"How many sides does a hexagon have?", o:["5","6","7","8"] },
  { id:234, v:1, t:'b', c:'r', q:"Is Mount Everest the tallest mountain from base to peak?", e:[ev('n',null,'Consider Mauna Kea from ocean floor')] },
  { id:235, v:1, t:'b', c:'r', q:"Can sound travel through a vacuum?" },
  { id:236, v:1, t:'m', c:'r', q:"What is 7 Ã— 8?", o:["54","56","58","64"] },
  { id:237, v:1, t:'b', c:'r', q:"Is blue light higher energy than red light?" },
  { id:238, v:1, t:'b', c:'r', q:"Does water expand when it freezes?" },
  { id:239, v:1, t:'m', c:'r', q:"How many degrees in a circle?", o:["180","270","360","400"] },
  { id:240, v:1, t:'b', c:'r', q:"Is a whale a fish?" },
  { id:241, v:1, t:'b', c:'p', q:"Will SpaceX successfully land humans on Mars by 2030?" },
  { id:242, v:1, t:'m', c:'p', q:"What will be the biggest tech IPO of 2027?", o:["OpenAI","Stripe","SpaceX","Databricks","Something unexpected"] },
  { id:243, v:1, t:'b', c:'p', q:"Will the US dollar lose reserve currency status by 2040?" },
  { id:244, v:1, t:'b', c:'p', q:"Will longevity treatments extend average lifespan by 10+ years by 2050?" },
  { id:245, v:1, t:'m', c:'p', q:"Which emerging technology will have the biggest impact by 2035?", o:["Quantum computing","Brain-computer interfaces","Gene editing","Nuclear fusion","Robotics"] },
  { id:246, v:1, t:'b', c:'p', q:"Will there be a major cyber attack on US infrastructure by 2028?" },
  { id:247, v:1, t:'b', c:'p', q:"Will Netflix still be the top streaming service in 2030?" },
  { id:248, v:1, t:'m', c:'p', q:"What will cause the next major tech layoff wave?", o:["AI automation","Economic recession","Regulatory crackdown","Market saturation","Geopolitical conflict"] },
  { id:249, v:1, t:'b', c:'p', q:"Will synthetic biology create new organisms for commercial use by 2030?" },
  { id:250, v:1, t:'b', c:'p', q:"Will augmented reality glasses be mainstream by 2028?" },
  { id:251, v:1, t:'m', c:'p', q:"Which country will have the best healthcare system in 2040?", o:["United States","Singapore","Japan","Nordic countries","AI-driven system (location irrelevant)"] },
  { id:252, v:1, t:'b', c:'p', q:"Will vertical farming produce 10% of vegetables in developed nations by 2035?" },
  { id:253, v:1, t:'b', c:'p', q:"Will any AI model be granted legal rights by 2040?" },
  { id:254, v:1, t:'m', c:'p', q:"What will happen to journalism by 2035?", o:["AI-written dominates","Subscription model wins","Citizen journalism rises","Government-funded expands","Complete transformation"] },
  { id:255, v:1, t:'b', c:'p', q:"Will carbon capture technology be commercially viable by 2035?" },
  { id:256, v:1, t:'b', c:'p', q:"Will there be a global treaty on AI development by 2030?" },
  { id:257, v:1, t:'m', c:'p', q:"How will most people pay for things in 2035?", o:["Credit/debit cards","Mobile wallets","Cryptocurrency","Biometric payments","Central bank digital currency"] },
  { id:258, v:1, t:'b', c:'p', q:"Will personalized medicine based on genetics be standard by 2035?" },
  { id:259, v:1, t:'b', c:'p', q:"Will any major sport allow performance-enhancing AI implants by 2040?" },
  { id:260, v:1, t:'m', c:'p', q:"What will be the dominant form of entertainment in 2040?", o:["Streaming video","Interactive/VR experiences","AI-generated content","Live events resurgence","Social media content"] },
  { id:261, v:1, t:'b', c:'p', q:"Will desalination solve water scarcity for 1 billion people by 2040?" },
  { id:262, v:1, t:'b', c:'p', q:"Will traditional TV broadcasting still exist in 2035?" },
  { id:263, v:1, t:'m', c:'p', q:"What will happen to movie theaters by 2035?", o:["Thriving luxury experience","Mostly closed","Converted to other uses","VR replaces them","Premium-only events"] },
  { id:264, v:1, t:'b', c:'p', q:"Will robots perform 50% of surgery by 2040?" },
  { id:265, v:1, t:'b', c:'p', q:"Will quantum internet be available commercially by 2040?" },
  { id:266, v:1, t:'m', c:'p', q:"Which job will be most AI-resistant in 2035?", o:["Healthcare worker","Tradesperson","Teacher","Creative artist","Social worker"] },
  { id:267, v:1, t:'b', c:'p', q:"Will flying cars/air taxis be common in major cities by 2040?" },
  { id:268, v:1, t:'b', c:'p', q:"Will Apple still be the most valuable company in 2030?" },
  { id:269, v:1, t:'m', c:'p', q:"What will replace Google Search as the primary information source?", o:["AI assistants","Nothing (Google adapts)","Decentralized search","Social media","Specialized vertical search"] },
  { id:270, v:1, t:'b', c:'p', q:"Will 3D-printed houses be 10% of new construction by 2035?" },
  { id:271, v:1, t:'b', c:'p', q:"Will human-level AI assistants be in every home by 2035?" },
  { id:272, v:1, t:'m', c:'p', q:"What will be the biggest geopolitical conflict of the 2030s?", o:["US-China","Climate refugees","Water wars","AI arms race","Economic blocks"] },
  { id:273, v:1, t:'b', c:'p', q:"Will cryptocurrency be banned in any G20 nation by 2030?" },
  { id:274, v:1, t:'b', c:'p', q:"Will genetic screening of embryos be routine in developed nations by 2035?" },
  { id:275, v:1, t:'m', c:'p', q:"What will be the primary mode of long-distance travel in 2050?", o:["Traditional aircraft","Supersonic jets","Hyperloop","Electric aircraft","Virtual presence replaces travel"] },
  { id:276, v:1, t:'b', c:'p', q:"Will Amazon still dominate e-commerce in 2035?" },
  { id:277, v:1, t:'b', c:'p', q:"Will lab-grown diamonds exceed natural diamond sales by 2030?" },
  { id:278, v:1, t:'m', c:'p', q:"How will dating work in 2035?", o:["Apps still dominant","AI matchmaking","VR dating","Return to traditional","Hybrid approaches"] },
  { id:279, v:1, t:'b', c:'p', q:"Will any country achieve net-zero emissions before 2040?" },
  { id:280, v:1, t:'b', c:'p', q:"Will holographic displays replace screens in homes by 2040?" },
  { id:281, v:1, t:'b', c:'r', q:"Is knowledge without wisdom dangerous?" },
  { id:282, v:1, t:'m', c:'r', q:"What is the greatest human virtue?", o:["Courage","Compassion","Wisdom","Justice","Honesty"] },
  { id:283, v:1, t:'b', c:'r', q:"Can we be held responsible for actions we were destined to take?" },
  { id:284, v:1, t:'b', c:'r', q:"Is suffering necessary for happiness?" },
  { id:285, v:1, t:'m', c:'r', q:"What is the source of moral authority?", o:["Religion/God","Reason","Social consensus","Evolution","Individual conscience"] },
  { id:286, v:1, t:'b', c:'r', q:"Is it ethical to modify human memory?" },
  { id:287, v:1, t:'b', c:'r', q:"Can a copy of a mind be the same person?" },
  { id:288, v:1, t:'m', c:'r', q:"What makes humans unique from other animals?", o:["Language","Reason","Self-awareness","Culture","Nothing fundamental"] },
  { id:289, v:1, t:'b', c:'r', q:"Is it possible to be truly selfless?" },
  { id:290, v:1, t:'b', c:'r', q:"Does beauty exist objectively?" },
  { id:291, v:1, t:'m', c:'r', q:"What is the best life philosophy?", o:["Stoicism","Buddhism","Existentialism","Utilitarianism","Religious faith"] },
  { id:292, v:1, t:'b', c:'r', q:"Is it wrong to create life knowing it will suffer?" },
  { id:293, v:1, t:'b', c:'r', q:"Can a thought experiment prove anything about reality?" },
  { id:294, v:1, t:'m', c:'r', q:"What is the relationship between mind and body?", o:["Mind is brain (materialism)","Mind is separate (dualism)","Mind emerges from complexity","Mind is fundamental","Unknown/unknowable"] },
  { id:295, v:1, t:'b', c:'r', q:"Is nostalgia a trap?" },
  { id:296, v:1, t:'b', c:'r', q:"Should we prioritize helping the worst off over the average?" },
  { id:297, v:1, t:'m', c:'r', q:"When is violence justified?", o:["Never","Only self-defense","Defense of others","Against tyranny","Context-dependent"] },
  { id:298, v:1, t:'b', c:'r', q:"Is boredom primarily a modern problem?" },
  { id:299, v:1, t:'b', c:'r', q:"Can you change who you fundamentally are?" },
  { id:300, v:1, t:'m', c:'r', q:"What is the purpose of government?", o:["Protect rights","Promote welfare","Maintain order","Enable freedom","No legitimate purpose"] },
  { id:301, v:1, t:'b', c:'r', q:"Is moral progress real?" },
  { id:302, v:1, t:'b', c:'r', q:"Does the existence of evil disprove a benevolent God?" },
  { id:303, v:1, t:'m', c:'r', q:"What makes a good life?", o:["Pleasure","Achievement","Virtue","Meaning","Balance of all"] },
  { id:304, v:1, t:'b', c:'r', q:"Is it better for a leader to be feared than loved?" },
  { id:305, v:1, t:'b', c:'r', q:"Can future people have rights?" },
  { id:306, v:1, t:'m', c:'r', q:"Why do we dream?", o:["Brain maintenance","Emotional processing","Problem solving","Random neural firing","Connection to something deeper"] },
  { id:307, v:1, t:'b', c:'r', q:"Is authenticity overrated?" },
  { id:308, v:1, t:'b', c:'r', q:"Can a society be too equal?" },
  { id:309, v:1, t:'m', c:'r', q:"What is the greatest threat to human flourishing?", o:["Technology","Human nature","Scarcity","Tribalism","Loss of meaning"] },
  { id:310, v:1, t:'b', c:'r', q:"Is optimism rational?" },
  { id:311, v:1, t:'b', c:'r', q:"Should we enhance human intelligence artificially?" },
  { id:312, v:1, t:'m', c:'r', q:"What is justice?", o:["Fairness","Desert (getting what you deserve)","Need-based distribution","Process-based","Social harmony"] },
  { id:313, v:1, t:'b', c:'r', q:"Is it wrong to not have children?" },
  { id:314, v:1, t:'b', c:'r', q:"Can nationalism be positive?" },
  { id:315, v:1, t:'m', c:'r', q:"What is wisdom?", o:["Knowledge applied well","Understanding limits","Emotional intelligence","Life experience","Knowing what matters"] },
  { id:316, v:1, t:'b', c:'r', q:"Is ambition generally a virtue?" },
  { id:317, v:1, t:'b', c:'r', q:"Should we try to eliminate all suffering?" },
  { id:318, v:1, t:'m', c:'r', q:"What determines personal identity over time?", o:["Physical continuity","Psychological continuity","Social recognition","Narrative self","No fixed identity"] },
  { id:319, v:1, t:'b', c:'r', q:"Is revenge ever justified?" },
  { id:320, v:1, t:'b', c:'r', q:"Can an AI have genuine emotions?" },
  { id:321, v:1, t:'b', c:'j', q:"Should AI-generated art be allowed in art competitions?" },
  { id:322, v:1, t:'m', c:'j', q:"How should we handle aging populations?", o:["Increase immigration","Raise retirement age","Automation","Pro-natalist policies","Accept decline"] },
  { id:323, v:1, t:'b', c:'j', q:"Should there be a maximum wage?" },
  { id:324, v:1, t:'b', c:'j', q:"Is nuclear power the answer to climate change?" },
  { id:325, v:1, t:'m', c:'j', q:"What should be done about homelessness?", o:["Housing first","Mental health focus","Job programs","Stricter enforcement","Universal basic income"] },
  { id:326, v:1, t:'b', c:'j', q:"Should parents be licensed?" },
  { id:327, v:1, t:'b', c:'j', q:"Is anonymous speech online a right?" },
  { id:328, v:1, t:'m', c:'j', q:"How should we fund healthcare?", o:["Single payer","Private insurance","Hybrid system","Health savings accounts","Employer-based"] },
  { id:329, v:1, t:'b', c:'j', q:"Should voting require passing a civics test?" },
  { id:330, v:1, t:'b', c:'j', q:"Are standardized tests a good measure of ability?" },
  { id:331, v:1, t:'m', c:'j', q:"What's the best way to reduce crime?", o:["More police","Social programs","Decriminalization","Community policing","Economic opportunity"] },
  { id:332, v:1, t:'b', c:'j', q:"Should there be term limits for Supreme Court justices?" },
  { id:333, v:1, t:'b', c:'j', q:"Is cultural relativism valid?" },
  { id:334, v:1, t:'m', c:'j', q:"How should we handle student debt?", o:["Full forgiveness","Partial forgiveness","Income-based repayment","No forgiveness","Reform future lending"] },
  { id:335, v:1, t:'b', c:'j', q:"Should companies be required to disclose AI use in products?" },
  { id:336, v:1, t:'b', c:'j', q:"Is intellectual property law too restrictive?" },
  { id:337, v:1, t:'m', c:'j', q:"What's the best approach to drug addiction?", o:["Criminalization","Harm reduction","Forced treatment","Decriminalization","Full legalization"] },
  { id:338, v:1, t:'b', c:'j', q:"Should there be a right to be forgotten online?" },
  { id:339, v:1, t:'b', c:'j', q:"Is space exploration worth the cost?" },
  { id:340, v:1, t:'m', c:'j', q:"How should we address income inequality?", o:["Higher taxes on wealthy","Universal basic services","Stronger unions","Education reform","Market solutions"] },
  { id:341, v:1, t:'b', c:'j', q:"Should athletes be allowed to use any enhancements?" },
  { id:342, v:1, t:'b', c:'j', q:"Is jury duty an unfair burden?" },
  { id:343, v:1, t:'m', c:'j', q:"What's the solution to fake news?", o:["Platform regulation","Media literacy education","Fact-checking labels","Legal consequences","Let market decide"] },
  { id:344, v:1, t:'b', c:'j', q:"Should there be reparations for historical injustices?" },
  { id:345, v:1, t:'b', c:'j', q:"Is it ethical to use ad blockers?" },
  { id:346, v:1, t:'m', c:'j', q:"How should we handle genetic discrimination?", o:["Ban all genetic testing for insurance","Allow with consent","Government oversight","Personal responsibility","Universal healthcare solves it"] },
  { id:347, v:1, t:'b', c:'j', q:"Should schools teach financial literacy as a required course?" },
  { id:348, v:1, t:'b', c:'j', q:"Is meritocracy compatible with equality?" },
  { id:349, v:1, t:'m', c:'j', q:"What should be done about factory farming?", o:["Ban it","Stricter regulations","Consumer choice","Lab-grown alternatives","Gradual phase-out"] },
  { id:350, v:1, t:'b', c:'j', q:"Should AI systems be required to identify themselves?" },
  { id:351, v:1, t:'b', c:'j', q:"Is gerrymandering ever acceptable?" },
  { id:352, v:1, t:'m', c:'j', q:"How should we address the urban-rural divide?", o:["Investment in rural areas","Encourage urbanization","Remote work incentives","Infrastructure spending","Accept divergence"] },
  { id:353, v:1, t:'b', c:'j', q:"Should organ sales be legal?" },
  { id:354, v:1, t:'b', c:'j', q:"Is it ethical to eat octopus given their intelligence?" },
  { id:355, v:1, t:'m', c:'j', q:"What's the best way to handle climate migration?", o:["Open borders","Managed resettlement","Adapt in place","International fund","Prevention focus"] },
  { id:356, v:1, t:'b', c:'j', q:"Should there be limits on AI in military applications?" },
  { id:357, v:1, t:'b', c:'j', q:"Is it fair to judge historical figures by modern standards?" },
  { id:358, v:1, t:'m', c:'j', q:"How should we reform policing?", o:["More funding/training","Defund and redirect","Community-based alternatives","Federal oversight","Local control"] },
  { id:359, v:1, t:'b', c:'j', q:"Should social media companies be treated as publishers?" },
  { id:360, v:1, t:'b', c:'j', q:"Is it ethical to clone pets?" },
  { id:361, v:1, t:'m', c:'j', q:"What's the best type of vacation?", o:["Beach relaxation","Adventure/active","Cultural exploration","Staycation","Road trip"] },
  { id:362, v:1, t:'b', c:'j', q:"Is buying a car better than leasing?" },
  { id:363, v:1, t:'m', c:'j', q:"What's the ideal family dinner frequency?", o:["Every night","Most nights","Few times a week","Weekends only","Special occasions"] },
  { id:364, v:1, t:'b', c:'j', q:"Should you tell your salary to coworkers?" },
  { id:365, v:1, t:'m', c:'j', q:"What's the best age to have children?", o:["Early 20s","Late 20s","Early 30s","Late 30s","Never/optional"] },
  { id:366, v:1, t:'b', c:'j', q:"Is it okay to read your partner's messages?" },
  { id:367, v:1, t:'m', c:'j', q:"What makes a good boss?", o:["Clear direction","Empathy","Technical expertise","Advocacy","Hands-off approach"] },
  { id:368, v:1, t:'b', c:'j', q:"Should you always RSVP to invitations?" },
  { id:369, v:1, t:'m', c:'j', q:"What's the best way to spend a windfall?", o:["Pay off debt","Invest","Experience/travel","Save for emergency","Treat yourself"] },
  { id:370, v:1, t:'b', c:'j', q:"Is it rude to wear headphones in public constantly?" },
  { id:371, v:1, t:'m', c:'j', q:"What's the ideal home temperature?", o:["65-67Â°F","68-70Â°F","71-73Â°F","74-76Â°F","Varies by room/season"] },
  { id:372, v:1, t:'b', c:'j', q:"Should you split the bill on a first date?" },
  { id:373, v:1, t:'m', c:'j', q:"What's the best time to exercise?", o:["Early morning","Mid-morning","Lunchtime","After work","Evening"] },
  { id:374, v:1, t:'b', c:'j', q:"Is being early better than being exactly on time?" },
  { id:375, v:1, t:'m', c:'j', q:"What's the ideal number of close friends?", o:["1-2","3-5","6-10","10+","Quality over quantity"] },
  { id:376, v:1, t:'b', c:'j', q:"Should you fake it till you make it?" },
  { id:377, v:1, t:'m', c:'j', q:"What's the best pizza topping?", o:["Pepperoni","Margherita (plain)","Supreme/everything","Hawaiian","Meat lovers"] },
  { id:378, v:1, t:'b', c:'j', q:"Is it okay to take work calls on vacation?" },
  { id:379, v:1, t:'m', c:'j', q:"What's more important in a home?", o:["Location","Size","Price","Condition","Outdoor space"] },
  { id:380, v:1, t:'b', c:'j', q:"Should you confront a friend about bad behavior?" },
  { id:381, v:1, t:'m', c:'j', q:"What's the best way to unwind after work?", o:["Exercise","TV/streaming","Reading","Socializing","Hobbies"] },
  { id:382, v:1, t:'b', c:'j', q:"Is it worth paying for premium subscriptions?" },
  { id:383, v:1, t:'m', c:'j', q:"What's the ideal wedding size?", o:["Elopement (2-10)","Intimate (10-50)","Medium (50-150)","Large (150-300)","Huge (300+)"] },
  { id:384, v:1, t:'b', c:'j', q:"Should you live together before marriage?" },
  { id:385, v:1, t:'m', c:'j', q:"What's the best approach to gift-giving?", o:["Thoughtful personal gifts","Gift cards","Experience gifts","Charitable donations","Skip gifts altogether"] },
  { id:386, v:1, t:'b', c:'j', q:"Is being a specialist better than a generalist?" },
  { id:387, v:1, t:'m', c:'j', q:"What's the ideal screen time per day?", o:["Under 2 hours","2-4 hours","4-6 hours","6-8 hours","No limit if productive"] },
  { id:388, v:1, t:'b', c:'j', q:"Should parents track their teenager's location?" },
  { id:389, v:1, t:'m', c:'j', q:"What's the best way to handle disagreements?", o:["Discuss immediately","Cool off first","Write it out","Get a mediator","Let it go"] },
  { id:390, v:1, t:'b', c:'j', q:"Is having a side hustle necessary today?" },
  { id:391, v:1, t:'m', c:'j', q:"What's the ideal morning routine length?", o:["15-30 min","30-60 min","1-2 hours","2+ hours","No routine"] },
  { id:392, v:1, t:'b', c:'j', q:"Should you negotiate every job offer?" },
  { id:393, v:1, t:'m', c:'j', q:"What's the best way to save money?", o:["Automatic transfers","Budgeting apps","Cash envelope system","Investment focus","Frugal lifestyle"] },
  { id:394, v:1, t:'b', c:'j', q:"Is it okay to cancel plans last minute?" },
  { id:395, v:1, t:'m', c:'j', q:"What's more important in a car?", o:["Reliability","Fuel efficiency","Safety","Comfort","Performance"] },
  { id:396, v:1, t:'b', c:'j', q:"Should you keep in touch with exes?" },
  { id:397, v:1, t:'m', c:'j', q:"What's the best approach to networking?", o:["Events/conferences","LinkedIn","Through friends","Cold outreach","Just do good work"] },
  { id:398, v:1, t:'b', c:'j', q:"Is meal prepping worth the effort?" },
  { id:399, v:1, t:'m', c:'j', q:"What's the ideal vacation frequency?", o:["Monthly getaways","Quarterly trips","1-2 big trips/year","One annual vacation","Mini-retirements"] },
  { id:400, v:1, t:'b', c:'j', q:"Should you always follow your gut?" },
  { id:401, v:1, t:'b', c:'j', q:"Is this claim credible? 'This supplement cured my chronic disease'" },
  { id:402, v:1, t:'m', c:'j', q:"Rate this excuse: 'I didn't see your message'", o:["Usually valid","Sometimes valid","Rarely valid","Never valid"] },
  { id:403, v:1, t:'b', c:'j', q:"Is this a red flag? Company asks for unpaid 'test project' before hiring" },
  { id:404, v:1, t:'b', c:'j', q:"Is this statistic meaningful? 'Our users save an average of 2 hours/week'" },
  { id:405, v:1, t:'m', c:'j', q:"Rate this apology: 'I'm sorry, but you misunderstood me'", o:["Genuine apology","Partial apology","Non-apology","Gaslighting"] },
  { id:406, v:1, t:'b', c:'j', q:"Is this review trustworthy? Detailed negative review with specific examples" },
  { id:407, v:1, t:'b', c:'j', q:"Is this argument valid? 'We've always done it this way, so it must work'" },
  { id:408, v:1, t:'m', c:'j', q:"Rate this job red flag level: 'We're like a family here'", o:["Green flag","Yellow flag","Red flag","Depends on context"] },
  { id:409, v:1, t:'b', c:'j', q:"Is this source credible? Preprint study not yet peer-reviewed" },
  { id:410, v:1, t:'b', c:'j', q:"Is this financial advice sound? 'Always max out your 401k before other investments'" },
  { id:411, v:1, t:'m', c:'j', q:"Rate this forecast methodology: Survey of 10 industry experts", o:["Strong","Moderate","Weak","Insufficient info"] },
  { id:412, v:1, t:'b', c:'j', q:"Is this product claim verifiable? 'Clinically proven to reduce wrinkles'" },
  { id:413, v:1, t:'b', c:'j', q:"Is this a valid criticism? 'Your data is correct but your interpretation is wrong'" },
  { id:414, v:1, t:'m', c:'j', q:"Rate this landlord response time: 48 hours for non-emergency repair", o:["Excellent","Acceptable","Poor","Unacceptable"] },
  { id:415, v:1, t:'b', c:'j', q:"Is this news headline clickbait? 'Scientists discover shocking truth about coffee'" },
  { id:416, v:1, t:'b', c:'j', q:"Is this comparison fair? Comparing startup revenue to established company" },
  { id:417, v:1, t:'m', c:'j', q:"Rate this password: 'Summer2024!'", o:["Strong","Moderate","Weak","Very weak"] },
  { id:418, v:1, t:'b', c:'j', q:"Is this testimonial credible? Celebrity endorsement of weight loss product" },
  { id:419, v:1, t:'b', c:'j', q:"Is this logic sound? 'The experts were wrong before, so they're wrong now'" },
  { id:420, v:1, t:'m', c:'j', q:"Rate this salary negotiation tactic: Revealing your current salary", o:["Smart move","Neutral","Mistake","Depends heavily on context"] },
  { id:421, v:1, t:'b', c:'j', q:"Is this study design adequate? Self-reported data from online survey" },
  { id:422, v:1, t:'b', c:'j', q:"Is this price reasonable? $15 for a cocktail in a major city" },
  { id:423, v:1, t:'m', c:'j', q:"Rate this excuse for missing a deadline: 'I had too many other priorities'", o:["Valid","Partially valid","Weak","Unacceptable"] },
  { id:424, v:1, t:'b', c:'j', q:"Is this warranty worth it? Extended warranty on a $500 appliance for $80" },
  { id:425, v:1, t:'b', c:'j', q:"Is this influencer recommendation trustworthy? #Ad disclosed, detailed review" },
  { id:426, v:1, t:'b', c:'r', q:"Is the capital of Canada Ottawa?" },
  { id:427, v:1, t:'m', c:'r', q:"What is 25% of 200?", o:["25","40","50","75"] },
  { id:428, v:1, t:'b', c:'r', q:"Does February ever have 30 days?" },
  { id:429, v:1, t:'b', c:'r', q:"Is gold heavier than silver (by density)?" },
  { id:430, v:1, t:'m', c:'r', q:"What is the next prime after 23?", o:["25","27","29","31"] },
  { id:431, v:1, t:'b', c:'r', q:"Can two even numbers sum to an odd number?" },
  { id:432, v:1, t:'b', c:'r', q:"Is Antarctica a continent?" },
  { id:433, v:1, t:'m', c:'r', q:"How many continents are there?", o:["5","6","7","8"] },
  { id:434, v:1, t:'b', c:'r', q:"Is the Great Wall of China visible from space with the naked eye?" },
  { id:435, v:1, t:'b', c:'r', q:"Do penguins live in the Arctic?" },
  { id:436, v:1, t:'m', c:'r', q:"What is 3Â³?", o:["9","18","27","81"] },
  { id:437, v:1, t:'b', c:'r', q:"Is the human body made mostly of water?" },
  { id:438, v:1, t:'b', c:'r', q:"Does light travel in a straight line in a vacuum?" },
  { id:439, v:1, t:'m', c:'r', q:"What fraction is equivalent to 0.25?", o:["1/3","1/4","1/5","2/5"] },
  { id:440, v:1, t:'b', c:'r', q:"Is the Sahara the largest desert on Earth?", e:[ev('n',null,'Consider Antarctica')] },
];

// Expand to full format
const QUESTIONS = Q_RAW.filter(q => !q.x).map(q => ({
  id: q.id, type: T[q.t], text: q.q, category: C[q.c],
  ...(q.o && { options: q.o }), ...(q.e && { preEvidence: q.e }), _v: q.v,
}));
const getCategoryList = () => Object.values(CAT_MAP);
  </script>
  <script>
    // Firebase Configuration - Replace with your project config
    const FIREBASE_CONFIG = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      databaseURL: "https://YOUR_PROJECT-default-rtdb.firebaseio.com",
      projectId: "YOUR_PROJECT",
      storageBucket: "YOUR_PROJECT.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    // Initialize Firebase (only if config is set)
    let auraDB = null;
    if (FIREBASE_CONFIG.apiKey !== "YOUR_API_KEY") {
      firebase.initializeApp(FIREBASE_CONFIG);
      auraDB = firebase.database();
    }

    // Generate anonymous session ID
    const AURA_SESSION_ID = localStorage.getItem('aura_session_id') || (() => {
      const id = 'anon_' + Math.random().toString(36).substr(2, 9);
      localStorage.setItem('aura_session_id', id);
      return id;
    })();

    // Capture response to Firebase
    function captureResponse(questionId, answer, confidence) {
      if (!auraDB) {
        console.log('[Aura] Firebase not configured - response not captured:', { questionId, answer, confidence });
        return;
      }
      const response = {
        qid: questionId,
        ans: answer,
        conf: confidence,
        ts: Date.now(),
        sid: AURA_SESSION_ID
      };
      auraDB.ref('responses').push(response)
        .then(() => console.log('[Aura] Response captured'))
        .catch(err => console.error('[Aura] Capture failed:', err));
    }
  </script>
  <script type="text/babel">
const { useState, useEffect, useRef, useCallback } = React;

// ==================== THEME TOKENS ====================
// TH(token, darkMode) - returns the appropriate classes for the current theme
const TH = (token, dark) => ({
  // Text colors
  'text-primary': dark ? 'text-white' : 'text-gray-900',
  'text-secondary': dark ? 'text-gray-300' : 'text-gray-700',
  'text-muted': dark ? 'text-gray-400' : 'text-gray-600',
  'text-subtle': dark ? 'text-gray-500' : 'text-gray-400',
  'text-faint': dark ? 'text-gray-600' : 'text-gray-400',
  'text-inverted': dark ? 'text-gray-900' : 'text-white',
  // Background colors
  'bg-main': dark ? 'bg-gray-950' : 'bg-gray-50',
  'bg-card': dark ? 'bg-gray-900 border border-gray-800' : 'bg-white border border-gray-200',
  'bg-card-shine': dark ? 'bg-gray-900 shine-card shine-gray' : 'bg-white border border-gray-200',
  'bg-elevated': dark ? 'bg-gray-800' : 'bg-gray-200',
  'bg-input': dark ? 'bg-gray-800 text-white placeholder-gray-500' : 'bg-gray-100 text-gray-900 placeholder-gray-400',
  'bg-surface': dark ? 'bg-gray-900' : 'bg-white',
  'bg-overlay': dark ? 'bg-gray-900/50' : 'bg-gray-100',
  // Border colors
  'border-base': dark ? 'border-gray-800' : 'border-gray-200',
  'border-subtle': dark ? 'border-gray-700' : 'border-gray-300',
  // Interactive states
  'btn-secondary': dark ? 'bg-gray-800/60 text-gray-500 hover:bg-gray-700/60' : 'bg-gray-200 text-gray-500',
  'btn-ghost': dark ? 'text-gray-300 active:text-white' : 'text-gray-600 active:text-gray-900',
  // Status colors (stay vibrant in both modes)
  'text-emerald': dark ? 'text-emerald-400' : 'text-emerald-600',
  'text-rose': dark ? 'text-rose-400' : 'text-rose-600',
  'text-violet': dark ? 'text-violet-400' : 'text-violet-600',
  'text-sky': dark ? 'text-sky-300' : 'text-sky-500',
  'text-blue': dark ? 'text-blue-400' : 'text-blue-600',
  // Additional patterns
  'text-dim': dark ? 'text-gray-400' : 'text-gray-500',
  'text-bright': dark ? 'text-gray-100' : 'text-gray-900',
  'text-muted-flip': dark ? 'text-gray-300' : 'text-gray-600',
  'text-muted-dark': dark ? 'text-gray-700' : 'text-gray-300',
  'bg-card-simple': dark ? 'bg-gray-900' : 'bg-white border border-gray-200',
  'bg-inverted': dark ? 'bg-white' : 'bg-gray-900',
  'bg-card-full': dark ? 'bg-gray-900 text-white' : 'bg-white text-gray-900',
  'bg-disabled': dark ? 'bg-gray-800 text-gray-600' : 'bg-gray-200 text-gray-400',
  'bg-disabled-alt': dark ? 'bg-gray-800 text-gray-400' : 'bg-gray-200 text-gray-600',
  'bg-mid': dark ? 'bg-gray-600' : 'bg-gray-200',
  'text-bright-bg': dark ? 'text-white bg-gray-950' : 'text-gray-900 bg-gray-50',
  'border-bg-main': dark ? 'border-gray-800 bg-gray-950' : 'border-gray-200 bg-white',
  'chip-violet': dark ? 'bg-violet-900/30 text-violet-400' : 'bg-violet-100 text-violet-700',
  'chip-violet-alt': dark ? 'bg-violet-500/20 text-violet-400' : 'bg-violet-100 text-violet-600',
}[token] || '');

// ==================== DATA ====================
const CATEGORIES = getCategoryList();

const MC_COLORS = [
  { hex: '#3b82f6', name: 'blue', shades: ['#93c5fd', '#60a5fa', '#3b82f6', '#2563eb'], rgb: '59, 130, 246' },
  { hex: '#8b5cf6', name: 'violet', shades: ['#c4b5fd', '#a78bfa', '#8b5cf6', '#7c3aed'], rgb: '139, 92, 246' },
  { hex: '#14b8a6', name: 'teal', shades: ['#5eead4', '#2dd4bf', '#14b8a6', '#0d9488'], rgb: '20, 184, 166' },
  { hex: '#06b6d4', name: 'cyan', shades: ['#67e8f9', '#22d3ee', '#06b6d4', '#0891b2'], rgb: '6, 182, 212' },
  { hex: '#ec4899', name: 'pink', shades: ['#f9a8d4', '#f472b6', '#ec4899', '#db2777'], rgb: '236, 72, 153' },
];

const CONFIDENCE_LABELS = { 1: "Hunch", 2: "Leaning", 3: "Firm", 4: "Certain" };

// Question of the Day pool
const QOTD_POOL = [
  { type: 'binary', text: 'Should AI systems be required to identify themselves when interacting with humans?', sponsor: { name: 'AI Safety Institute', avatar: 'ðŸ›ï¸' }, distribution: { yes: [142, 287, 412, 389], no: [98, 156, 201, 162] } },
  { type: 'binary', text: 'Is universal basic income inevitable as automation increases?', sponsor: { name: 'Future of Work Foundation', avatar: 'ðŸ¤–' }, distribution: { yes: [198, 312, 287, 245], no: [156, 234, 189, 167] } },
  { type: 'binary', text: 'Should social media platforms be held liable for user-generated content?', sponsor: { name: 'Digital Rights Coalition', avatar: 'ðŸ“±' }, distribution: { yes: [167, 234, 312, 278], no: [189, 267, 234, 198] } },
  { type: 'binary', text: 'Will humans establish a permanent Mars colony by 2050?', sponsor: { name: 'Space Exploration Society', avatar: 'ðŸš€' }, distribution: { yes: [123, 198, 234, 167], no: [234, 312, 289, 256] } },
  { type: 'multiple', text: 'What will be the dominant AI interface by 2030?', options: ['Text chat', 'Voice assistants', 'AR/VR agents', 'Brain-computer interfaces'], sponsor: { name: 'Future Tech Institute', avatar: 'ðŸ”®' }, distribution: [[89, 145, 178, 134], [112, 189, 234, 198], [67, 98, 123, 89], [34, 56, 67, 45]] },
  { type: 'binary', text: 'Should voting be mandatory in democratic countries?', sponsor: { name: 'Civic Engagement Alliance', avatar: 'ðŸ—³ï¸' }, distribution: { yes: [156, 223, 267, 198], no: [198, 289, 312, 234] } },
  { type: 'binary', text: 'Is privacy more important than national security?', sponsor: { name: 'Civil Liberties Union', avatar: 'ðŸ”’' }, distribution: { yes: [189, 267, 312, 256], no: [145, 212, 234, 189] } },
  { type: 'multiple', text: 'What gives life the most meaning?', options: ['Relationships', 'Achievement', 'Pleasure', 'Purpose/contribution'], sponsor: { name: 'Philosophy Foundation', avatar: 'ðŸ¤”' }, distribution: [[178, 267, 334, 289], [89, 134, 167, 145], [56, 78, 89, 67], [123, 189, 234, 198]] },
  { type: 'binary', text: 'Should gene editing for disease prevention be allowed in humans?', sponsor: { name: 'Bioethics Council', avatar: 'ðŸ§¬' }, distribution: { yes: [212, 334, 378, 312], no: [98, 156, 178, 145] } },
  { type: 'multiple', text: 'Most important skill for the next decade?', options: ['AI/ML literacy', 'Critical thinking', 'Emotional intelligence', 'Adaptability'], sponsor: { name: 'Future Skills Lab', avatar: 'ðŸŽ¯' }, distribution: [[145, 212, 267, 223], [167, 245, 312, 267], [98, 145, 178, 145], [112, 178, 223, 189]] },
  { type: 'binary', text: 'Will AGI (Artificial General Intelligence) be achieved by 2035?', sponsor: { name: 'AI Research Consortium', avatar: 'ðŸ§ ' }, distribution: { yes: [145, 212, 234, 189], no: [178, 267, 289, 245] } },
];

const getRandomQOTD = () => {
  const q = QOTD_POOL[Math.floor(Math.random() * QOTD_POOL.length)];
  let totalResponses;
  if (q.type === 'binary') {
    totalResponses = q.distribution.yes.reduce((a, b) => a + b, 0) + q.distribution.no.reduce((a, b) => a + b, 0);
  } else {
    totalResponses = q.distribution.reduce((sum, opt) => sum + opt.reduce((a, b) => a + b, 0), 0);
  }
  return {
    id: `qotd-${Date.now()}`,
    day: 147 + Math.floor(Math.random() * 50),
    text: q.text,
    type: q.type || 'binary',
    options: q.options || null,
    sponsor: q.sponsor,
    reward: 25,
    endsAt: new Date().setHours(23, 59, 59, 999),
    totalResponses,
    distribution: q.distribution,
  };
};

const getQotdTimeRemaining = () => {
  const now = new Date();
  const end = new Date();
  end.setHours(23, 59, 59, 999);
  const diff = end - now;
  const hours = Math.floor(diff / (1000 * 60 * 60));
  const mins = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
  return `${hours}h ${mins}m`;
};

const shuffleArray = (array) => {
  const shuffled = [...array];
  for (let i = shuffled.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
  }
  return shuffled;
};

// Realistic distributions based on estimated 1,000 diverse human responses
// Format: Binary { y: [conf1-4], n: [conf1-4] }, MC { d: [[opt0 conf1-4], ...] }
const REALISTIC_DIST = {
  1:{y:[80,120,180,250],n:[140,150,140,40]},2:{d:[[200,180,120,80],[250,200,100,40],[120,140,100,50],[80,100,120,70]]},3:{y:[100,140,160,200],n:[180,160,120,40]},4:{d:[[150,180,140,100],[180,160,100,60],[220,200,120,80],[60,80,100,50]]},5:{y:[60,80,100,150],n:[250,200,120,40]},6:{d:[[250,220,150,80],[280,200,120,60],[120,140,120,80],[40,60,80,100],[80,100,140,120]]},7:{y:[20,40,100,600],n:[80,100,50,10]},8:{d:[[300,250,180,120],[200,180,120,60],[100,120,100,80],[80,100,140,120],[40,60,80,100]]},9:{y:[120,160,200,180],n:[180,140,100,20]},10:{d:[[140,160,120,80],[200,220,140,100],[120,100,80,60],[100,120,100,80]]},
  11:{y:[200,220,180,120],n:[140,120,100,40]},12:{d:[[200,240,200,120],[180,200,140,80],[140,160,120,60],[100,120,100,40],[80,100,80,40]]},13:{y:[60,80,120,100],n:[280,280,140,40]},14:{d:[[100,120,120,80],[200,220,160,120],[180,200,140,80],[140,160,100,60]]},15:{y:[140,180,200,150],n:[160,140,120,40]},16:{y:[200,220,180,100],n:[160,140,100,80]},17:{d:[[220,200,140,80],[200,220,140,60],[120,100,80,40],[80,100,100,60]]},18:{y:[120,160,220,200],n:[140,120,100,40]},19:{y:[160,200,220,180],n:[140,120,100,80]},20:{d:[[180,200,160,100],[220,200,120,80],[120,140,100,60],[160,180,140,80],[100,120,100,60]]},
  21:{y:[40,60,120,620],n:[100,80,40,10]},22:{d:[[40,60,80,100],[520,240,120,80],[60,80,100,120],[80,100,100,80]]},23:{y:[280,200,120,60],n:[160,120,100,60]},24:{d:[[100,120,140,160],[480,220,120,80],[80,100,120,140],[100,120,100,80]]},25:{y:[200,180,120,40],n:[300,240,140,80]},26:{y:[140,180,220,180],n:[150,140,120,40]},27:{d:[[240,220,160,100],[260,200,120,80],[120,140,120,80],[100,120,100,60],[120,140,160,120]]},28:{y:[180,220,200,140],n:[140,120,100,80]},29:{d:[[200,220,180,120],[140,160,140,80],[100,120,120,80],[180,200,140,100],[100,120,100,60]]},30:{y:[160,200,220,160],n:[140,120,100,60]},
  31:{y:[220,240,200,160],n:[100,120,100,60]},32:{d:[[220,240,200,140],[240,220,160,100],[200,200,160,100],[100,120,120,80],[120,140,120,60]]},33:{y:[160,200,220,180],n:[140,120,100,60]},34:{y:[200,220,200,140],n:[140,120,100,80]},35:{d:[[240,220,160,100],[200,200,140,80],[120,140,140,100],[160,180,120,80],[60,80,100,120]]},36:{y:[100,120,180,420],n:[100,80,40,20]},37:{d:[[100,120,140,160],[120,140,120,100],[440,220,120,80],[100,120,140,160]]},38:{y:[80,100,160,500],n:[100,80,60,20]},39:{y:[200,220,240,160],n:[120,100,80,60]},40:{d:[[80,120,120,100],[320,240,160,100],[120,140,120,80],[100,120,100,60],[100,120,120,100]]},
  41:{y:[180,220,220,160],n:[140,120,100,60]},42:{y:[140,180,220,200],n:[140,140,100,60]},43:{d:[[280,240,160,100],[260,220,140,80],[80,100,100,60],[60,80,100,80],[80,100,120,100]]},44:{y:[100,140,180,200],n:[200,180,120,60]},45:{y:[140,180,200,180],n:[160,140,120,80]},46:{d:[[220,240,180,120],[180,200,160,100],[160,180,140,80],[140,160,120,80],[120,140,140,100]]},47:{y:[120,160,200,180],n:[160,140,120,80]},48:{y:[140,180,220,160],n:[160,140,100,80]},49:{d:[[200,220,180,120],[180,200,160,100],[120,140,140,100],[160,180,140,80],[100,120,120,80]]},50:{y:[100,140,180,160],n:[220,200,120,80]},
  51:{y:[160,200,220,160],n:[140,120,100,60]},52:{d:[[200,200,160,100],[240,220,160,100],[180,200,140,80],[120,140,120,80],[140,160,160,120]]},53:{y:[180,220,240,160],n:[140,120,100,60]},54:{y:[80,120,160,400],n:[150,140,100,50]},55:{d:[[200,200,160,100],[160,180,140,100],[100,120,120,80],[180,200,140,80],[120,140,120,80]]},56:{y:[200,240,220,160],n:[140,120,100,60]},57:{y:[120,160,200,200],n:[160,140,120,60]},58:{d:[[240,220,160,100],[200,200,140,80],[180,200,160,100],[160,180,140,80],[140,160,140,100]]},59:{y:[140,180,200,180],n:[150,140,120,60]},60:{y:[140,180,200,180],n:[160,140,100,80]},
  61:{d:[[220,240,180,120],[160,180,140,80],[180,200,160,100],[100,120,100,60],[180,200,160,120]]},62:{y:[120,160,200,220],n:[140,120,100,40]},63:{y:[200,240,220,160],n:[140,120,100,60]},64:{d:[[200,200,160,100],[240,220,160,100],[200,220,160,100],[140,160,120,80],[120,140,120,80]]},65:{y:[120,160,200,200],n:[160,140,120,60]},66:{y:[160,200,220,180],n:[140,120,100,60]},67:{d:[[240,240,180,120],[200,200,140,80],[100,120,120,80],[120,140,140,100],[120,140,140,100]]},68:{y:[160,200,220,180],n:[140,120,100,60]},69:{y:[120,160,200,220],n:[150,140,120,60]},70:{d:[[160,180,140,80],[200,220,160,100],[180,200,160,100],[140,160,140,100],[100,120,120,80]]},
  71:{y:[140,180,200,200],n:[160,140,100,60]},72:{y:[120,160,200,200],n:[180,160,120,60]},73:{d:[[180,200,160,100],[160,180,140,80],[140,160,140,100],[120,140,140,100],[140,160,140,100]]},74:{y:[140,200,240,200],n:[140,120,100,60]},75:{y:[200,240,220,160],n:[140,120,100,60]},76:{d:[[200,220,180,120],[240,240,180,120],[160,180,140,100],[160,180,160,120],[120,140,140,100]]},77:{y:[160,200,220,180],n:[140,120,100,60]},78:{y:[140,180,200,200],n:[160,140,120,60]},79:{d:[[200,220,180,120],[120,140,140,100],[100,120,120,80],[200,220,160,100],[120,140,140,100]]},80:{y:[120,160,200,200],n:[160,140,120,60]},
  81:{y:[80,180,260,280],n:[120,200,180,120]},82:{d:[[120,200,220,160],[140,220,200,140],[110,180,240,170],[100,160,200,140],[130,140,100,70]]},83:{y:[140,200,180,180],n:[120,180,220,180]},84:{y:[100,160,220,220],n:[160,240,220,80]},85:{d:[[180,240,200,80],[160,220,240,80],[80,140,200,180],[70,140,180,210],[160,180,160,70]]},86:{y:[110,150,240,300],n:[100,180,140,80]},87:{y:[120,200,240,240],n:[100,180,200,120]},88:{d:[[180,240,200,80],[160,220,240,80],[120,200,220,160],[140,200,240,120],[100,120,100,80]]},89:{y:[100,160,260,380],n:[80,140,140,140]},90:{y:[160,200,180,160],n:[140,220,240,100]},
  91:{d:[[140,180,200,180],[160,240,240,60],[100,140,180,180],[80,160,220,240],[120,180,160,140]]},92:{y:[100,140,280,380],n:[60,100,120,120]},93:{y:[140,220,260,180],n:[140,200,180,100]},94:{d:[[100,140,180,180],[140,240,260,60],[100,160,200,140],[160,220,240,80],[80,120,140,100]]},95:{y:[120,160,240,380],n:[80,140,160,120]},96:{y:[180,240,220,160],n:[100,160,180,160]},97:{d:[[100,160,220,220],[100,160,240,300],[160,240,260,40],[80,120,140,160],[100,120,140,100]]},98:{y:[140,200,220,240],n:[120,180,200,100]},99:{y:[160,220,280,240],n:[80,120,140,80]},100:{d:[[200,240,180,80],[120,160,200,220],[140,200,220,140],[80,140,200,240],[100,100,100,100]]},
  101:{y:[100,180,240,280],n:[120,200,180,120]},102:{y:[100,160,240,280],n:[120,200,200,100]},103:{d:[[120,160,220,200],[160,240,260,40],[140,220,240,100],[80,100,120,100],[100,80,120,140]]},104:{y:[120,180,240,260],n:[140,220,240,100]},105:{y:[100,160,220,220],n:[180,240,220,80]},106:{d:[[180,240,220,60],[120,180,200,200],[100,140,180,180],[80,120,160,240],[140,160,140,80]]},107:{y:[140,220,260,180],n:[120,200,180,100]},108:{y:[100,140,200,160],n:[180,260,240,120]},109:{d:[[140,200,220,140],[120,160,200,220],[160,240,260,40],[160,220,240,80],[100,80,80,100]]},110:{y:[120,180,240,260],n:[140,220,220,120]},
  111:{y:[100,160,220,220],n:[180,240,240,80]},112:{d:[[140,200,240,120],[160,220,240,80],[100,160,220,220],[120,180,220,180],[80,80,80,100]]},113:{y:[160,240,240,160],n:[120,160,200,120]},114:{y:[140,200,280,280],n:[80,120,120,100]},115:{d:[[100,140,180,280],[140,220,240,100],[120,200,240,140],[100,180,220,160],[80,80,80,100]]},116:{y:[120,160,200,320],n:[140,240,240,80]},117:{d:[[140,200,240,120],[100,140,180,280],[160,240,260,40],[100,120,140,140],[80,100,80,80]]},118:{y:[160,220,260,220],n:[100,160,180,100]},119:{y:[100,140,180,280],n:[160,240,280,120]},120:{d:[[140,200,240,120],[100,140,200,260],[120,180,220,180],[100,120,160,280],[80,100,100,100]]},
  121:{y:[140,200,240,180],n:[120,220,220,80]},122:{y:[100,140,160,240],n:[160,240,280,80]},123:{d:[[80,120,140,260],[120,180,220,180],[100,160,220,220],[100,140,180,180],[120,180,200,140]]},124:{y:[160,220,240,180],n:[120,180,200,100]},125:{y:[120,180,220,260],n:[140,220,260,80]},126:{d:[[120,160,180,240],[100,140,160,280],[140,200,220,140],[160,220,240,80],[80,80,100,160]]},127:{y:[100,140,200,340],n:[140,240,240,100]},128:{y:[100,140,180,280],n:[160,240,260,100]},129:{d:[[120,180,220,180],[100,160,220,220],[140,200,240,120],[80,120,160,240],[100,100,100,100]]},130:{y:[140,200,240,220],n:[100,160,180,160]},
  131:{y:[120,180,240,260],n:[100,180,200,120]},132:{d:[[140,200,240,120],[80,120,140,260],[160,220,240,80],[140,220,240,100],[100,80,80,100]]},133:{y:[80,140,200,280],n:[160,240,280,120]},134:{y:[100,160,240,300],n:[120,200,180,100]},135:{d:[[100,140,160,200],[140,220,260,80],[120,180,220,180],[100,140,180,180],[100,100,100,100]]},136:{y:[100,140,180,280],n:[160,240,280,120]},137:{y:[80,120,160,240],n:[160,260,280,80]},138:{d:[[100,160,200,240],[80,140,180,280],[120,200,220,160],[100,140,180,180],[100,100,100,100]]},139:{y:[100,160,220,320],n:[120,200,200,80]},140:{y:[120,180,240,260],n:[100,180,200,120]},
  141:{d:[[100,140,160,200],[160,240,280,120],[140,220,240,100],[120,180,220,180],[80,80,100,100]]},142:{y:[100,140,200,260],n:[160,240,280,120]},143:{y:[120,200,280,260],n:[100,160,160,120]},144:{d:[[100,140,160,240],[120,180,220,180],[140,220,260,80],[80,120,140,260],[100,100,100,120]]},145:{y:[120,180,240,220],n:[120,200,200,120]},146:{y:[120,200,260,240],n:[100,160,160,120]},147:{d:[[120,180,220,180],[140,220,260,80],[100,160,200,240],[100,160,200,240],[80,80,100,100]]},148:{y:[100,140,200,260],n:[160,260,240,100]},149:{y:[140,220,260,180],n:[120,160,180,140]},150:{d:[[100,140,160,240],[140,220,260,80],[160,240,260,40],[80,120,140,260],[80,80,100,100]]},
  151:{d:[[160,240,260,40],[120,180,220,180],[100,160,220,220],[100,160,200,240],[120,160,180,160]]},152:{y:[160,220,240,180],n:[100,160,200,140]},153:{d:[[80,140,180,200],[120,220,260,200],[140,240,260,60],[100,120,180,200],[160,180,180,120]]},154:{y:[100,160,220,320],n:[120,200,220,80]},155:{d:[[100,160,220,220],[140,220,240,100],[120,180,220,180],[100,180,220,200],[120,140,180,160]]},156:{y:[140,200,240,220],n:[100,180,220,100]},157:{d:[[80,140,180,200],[100,160,220,220],[160,240,280,20],[120,180,220,180],[100,100,120,140]]},158:{y:[160,240,260,140],n:[80,120,160,240]},159:{d:[[120,180,220,180],[100,160,220,220],[140,220,240,100],[120,180,220,180],[100,140,180,200]]},160:{y:[140,220,280,220],n:[100,160,160,120]},
  161:{d:[[120,140,180,200],[150,160,140,120],[180,150,120,100],[140,130,110,90],[210,220,180,150]]},162:{y:[80,140,180,220],n:[150,200,210,220]},163:{d:[[200,180,150,120],[140,160,180,200],[180,150,120,100],[120,130,140,150],[80,90,100,110]]},164:{y:[120,150,180,200],n:[160,190,210,220]},165:{d:[[60,90,120,140],[150,180,200,210],[200,210,220,230],[100,120,140,160],[120,130,140,150]]},166:{y:[180,200,210,220],n:[140,160,180,200]},167:{d:[[80,100,120,140],[90,110,140,160],[160,180,200,220],[100,120,140,160],[150,170,190,210]]},168:{y:[150,180,200,220],n:[160,190,210,240]},169:{d:[[100,120,140,160],[180,190,200,210],[160,170,180,190],[140,150,160,170],[80,90,100,110]]},170:{y:[80,120,140,160],n:[200,220,240,260]},
  171:{d:[[140,160,180,200],[200,220,240,250],[180,190,200,210],[100,120,130,140],[120,130,140,150]]},172:{y:[240,260,280,300],n:[60,80,100,120]},173:{d:[[120,130,140,150],[140,150,160,170],[180,200,220,240],[60,80,100,120],[100,110,120,130]]},174:{y:[120,140,160,180],n:[180,200,220,240]},175:{d:[[80,100,120,140],[120,140,160,180],[180,200,220,240],[140,160,180,200],[160,170,180,190]]},176:{y:[140,160,180,200],n:[160,180,200,220]},177:{d:[[180,200,220,240],[160,180,200,220],[150,170,190,210],[140,160,180,200],[100,110,120,130]]},178:{y:[120,140,160,180],n:[160,190,220,250]},179:{d:[[100,120,140,160],[160,180,200,220],[180,200,220,240],[60,80,100,120],[140,160,180,200]]},180:{y:[100,130,150,170],n:[180,210,240,270]},
  181:{d:[[140,160,180,200],[120,140,160,180],[180,200,220,240],[100,120,140,160],[120,130,140,150]]},182:{y:[110,140,160,180],n:[170,200,220,240]},183:{d:[[200,220,240,260],[140,160,180,200],[120,140,150,160],[100,120,140,150],[140,150,160,170]]},184:{y:[140,160,180,200],n:[160,180,200,220]},185:{d:[[80,100,120,140],[180,200,220,240],[220,240,260,280],[140,160,180,200],[120,130,140,150]]},186:{y:[180,190,200,210],n:[200,210,220,230]},187:{d:[[180,200,220,240],[120,140,160,180],[100,110,120,130],[140,160,180,200],[120,130,140,150]]},188:{y:[140,160,180,200],n:[160,190,220,250]},189:{d:[[160,180,200,220],[140,160,180,200],[100,120,140,160],[80,100,120,140],[200,220,240,260]]},190:{y:[140,160,180,200],n:[180,200,220,240]},
  191:{y:[280,300,320,340],n:[40,50,60,70]},192:{d:[[80,90,100,110],[120,140,160,180],[200,220,240,260],[180,200,220,240]]},193:{y:[200,220,240,260],n:[120,140,160,180]},194:{y:[80,100,120,140],n:[280,300,320,340]},195:{d:[[100,110,120,130],[140,160,180,200],[120,140,160,180],[80,100,120,140],[160,180,200,220]]},196:{y:[160,180,200,220],n:[240,260,280,300]},197:{d:[[60,70,80,90],[100,110,120,130],[220,240,260,280],[300,320,340,360]]},198:{y:[320,340,360,380],n:[60,80,100,120]},199:{y:[220,240,260,280],n:[140,160,180,200]},200:{d:[[80,90,100,110],[140,160,180,200],[200,220,240,260],[240,260,280,300]]},
  201:{y:[80,100,120,140],n:[280,300,320,340]},202:{y:[100,120,140,160],n:[220,240,260,280]},203:{d:[[120,130,140,150],[200,220,240,260],[260,280,300,320],[160,180,200,220]]},204:{y:[280,300,320,340],n:[60,80,100,120]},205:{y:[100,120,140,160],n:[240,260,280,300]},206:{d:[[160,180,200,220],[140,160,180,200],[120,140,160,180],[160,180,200,220]]},207:{y:[60,80,100,120],n:[320,340,360,380]},208:{y:[380,400,420,440],n:[40,50,60,70]},209:{d:[[120,140,160,180],[200,220,240,260],[140,160,180,200],[160,180,200,220]]},210:{y:[100,120,140,160],n:[300,320,340,360]},
  211:{y:[120,140,160,180],n:[260,280,300,320]},212:{d:[[160,180,200,220],[200,220,240,260],[180,200,220,240],[120,140,160,180],[120,130,140,150]]},213:{y:[260,280,300,320],n:[100,120,140,160]},214:{y:[120,140,160,180],n:[240,260,280,300]},215:{d:[[200,220,240,260],[180,200,220,240],[120,130,140,150],[60,80,100,120]]},216:{y:[380,400,420,440],n:[40,50,60,70]},217:{d:[[80,90,100,110],[100,110,120,130],[380,400,420,440],[140,150,160,170]]},218:{y:[300,320,340,360],n:[120,140,160,180]},219:{y:[420,440,460,480],n:[20,30,40,50]},220:{d:[[80,90,100,110],[420,440,460,480],[100,110,120,130],[80,90,100,110]]},
  221:{y:[460,480,500,520],n:[10,20,30,40]},222:{d:[[140,150,160,170],[420,440,460,480],[120,130,140,150],[100,110,120,130]]},223:{y:[220,240,260,280],n:[200,220,240,260]},224:{y:[340,360,380,400],n:[180,200,220,240]},225:{d:[[100,110,120,130],[420,440,460,480],[200,210,220,230],[100,110,120,130]]},226:{y:[180,200,220,240],n:[220,240,260,280]},227:{d:[[80,90,100,110],[460,480,500,520],[80,90,100,110],[100,110,120,130]]},228:{y:[380,400,420,440],n:[120,140,160,180]},229:{y:[320,340,360,380],n:[200,220,240,260]},230:{d:[[140,150,160,170],[180,190,200,210],[420,440,460,480],[100,110,120,130]]},
  231:{y:[240,260,280,300],n:[260,280,300,320]},232:{y:[360,380,400,420],n:[140,160,180,200]},233:{d:[[120,130,140,150],[460,480,500,520],[100,110,120,130],[80,90,100,110]]},234:{y:[200,220,240,260],n:[300,320,340,360]},235:{y:[420,440,460,480],n:[60,80,100,120]},236:{d:[[180,190,200,210],[460,480,500,520],[140,150,160,170],[100,110,120,130]]},237:{y:[340,360,380,400],n:[180,200,220,240]},238:{y:[400,420,440,460],n:[100,120,140,160]},239:{d:[[100,110,120,130],[120,130,140,150],[480,500,520,540],[80,90,100,110]]},240:{y:[200,220,240,260],n:[300,320,340,360]},
  241:{y:[80,120,180,200],n:[150,170,80,40]},242:{d:[[120,80,100,40],[180,140,120,80],[90,80,110,60],[70,60,80,50],[340,220,80,0]]},243:{y:[90,110,130,80],n:[200,180,140,90]},244:{y:[100,130,160,140],n:[140,140,100,90]},245:{d:[[100,120,140,90],[110,130,120,100],[140,120,100,70],[80,100,110,80],[70,80,110,100]]},246:{y:[50,80,140,210],n:[80,100,140,200]},247:{y:[110,140,160,120],n:[130,150,120,70]},248:{d:[[140,160,120,100],[120,140,130,80],[90,100,110,70],[80,90,100,60],[70,80,90,50]]},249:{y:[70,110,150,140],n:[150,140,120,70]},250:{y:[60,100,160,180],n:[160,180,110,50]},
  251:{d:[[80,100,120,80],[150,140,120,80],[100,120,130,90],[140,120,110,80],[50,60,70,50]]},252:{y:[80,110,130,100],n:[190,180,140,70]},253:{y:[30,50,80,100],n:[250,280,200,130]},254:{d:[[100,110,120,70],[110,130,130,90],[130,120,100,60],[80,90,100,70],[80,90,110,60]]},255:{y:[80,120,170,150],n:[160,180,120,70]},256:{y:[70,100,140,130],n:[180,180,140,80]},257:{d:[[120,140,150,100],[140,160,130,90],[60,80,100,60],[80,100,120,80],[100,110,120,80]]},258:{y:[90,140,180,140],n:[130,150,120,70]},259:{y:[20,40,70,80],n:[280,300,220,110]},260:{d:[[80,120,150,100],[120,140,120,100],[100,110,120,80],[90,100,110,70],[110,130,100,60]]},
  261:{y:[70,100,140,120],n:[200,190,130,80]},262:{y:[100,130,150,130],n:[170,170,120,70]},263:{d:[[70,100,120,80],[120,140,130,100],[100,110,120,70],[80,100,110,70],[50,80,100,60]]},264:{y:[50,90,140,160],n:[180,200,130,50]},265:{y:[40,80,120,140],n:[220,240,140,80]},266:{d:[[180,140,110,80],[120,130,130,100],[100,110,120,80],[80,90,110,90],[70,80,100,80]]},267:{y:[50,90,150,180],n:[180,220,100,40]},268:{y:[140,150,140,100],n:[120,130,110,70]},269:{d:[[200,160,120,80],[180,150,120,80],[60,80,100,70],[90,110,100,60],[70,90,100,50]]},270:{y:[60,100,140,120],n:[200,200,130,80]},
  271:{y:[100,140,180,150],n:[140,150,100,70]},272:{d:[[180,160,120,80],[120,130,130,100],[100,110,110,80],[90,100,110,70],[80,100,110,60]]},273:{y:[70,100,130,120],n:[200,190,130,80]},274:{y:[60,100,150,140],n:[180,190,130,80]},275:{d:[[130,140,130,100],[80,100,120,100],[100,120,130,80],[120,130,120,80],[70,80,100,80]]},276:{y:[130,150,140,110],n:[130,140,110,70]},277:{y:[80,120,160,140],n:[160,180,120,80]},278:{d:[[180,150,130,100],[100,120,130,90],[60,80,110,80],[80,100,110,70],[80,100,110,70]]},279:{y:[80,130,180,160],n:[140,150,120,60]},280:{y:[50,90,150,170],n:[190,220,100,40]},
  281:{y:[80,120,140,100],n:[140,180,140,100]},282:{d:[[100,140,140,100],[140,160,140,100],[120,140,130,90],[110,130,130,100],[80,100,110,80]]},283:{y:[100,140,120,80],n:[130,160,150,120]},284:{y:[110,130,130,90],n:[130,160,140,100]},285:{d:[[120,130,120,100],[110,130,130,100],[100,120,140,110],[80,100,120,100],[90,110,120,100]]},286:{y:[70,100,140,120],n:[150,180,150,90]},287:{y:[90,110,120,100],n:[140,160,150,130]},288:{d:[[80,100,130,110],[120,140,130,100],[100,130,140,110],[100,120,130,110],[70,90,110,100]]},289:{y:[70,100,130,110],n:[150,180,150,110]},290:{y:[90,120,150,120],n:[140,160,130,90]},
  291:{d:[[110,130,120,90],[120,140,130,100],[100,120,130,100],[100,120,130,100],[70,90,120,100]]},292:{y:[100,130,130,90],n:[130,160,140,100]},293:{y:[80,110,130,110],n:[150,180,150,100]},294:{d:[[120,140,130,100],[90,110,130,110],[110,130,130,100],[80,100,120,110],[100,120,120,90]]},295:{y:[110,130,130,90],n:[130,160,140,100]},296:{y:[120,140,130,100],n:[110,150,140,110]},297:{d:[[60,80,100,120],[140,150,130,100],[120,140,130,100],[100,120,130,110],[110,130,130,90]]},298:{y:[110,130,130,90],n:[130,160,140,100]},299:{y:[100,130,130,90],n:[140,160,140,110]},300:{d:[[130,140,120,90],[110,130,130,100],[100,120,130,110],[120,140,120,90],[80,100,120,100]]},
  301:{y:[100,130,140,110],n:[120,150,140,110]},302:{y:[110,130,130,100],n:[120,150,140,110]},303:{d:[[100,120,130,100],[120,140,130,100],[110,130,140,100],[120,140,130,110],[90,110,120,100]]},304:{y:[80,110,130,110],n:[160,180,140,90]},305:{y:[110,140,130,100],n:[120,150,140,100]},306:{d:[[100,120,130,100],[120,140,130,100],[100,120,130,100],[80,100,120,100],[100,120,130,110]]},307:{y:[100,130,130,100],n:[120,150,140,110]},308:{y:[90,120,130,110],n:[140,170,140,100]},309:{d:[[100,120,140,110],[120,140,140,100],[100,120,130,110],[110,130,140,110],[80,100,120,100]]},310:{y:[120,140,130,100],n:[110,150,140,100]},
  311:{y:[110,130,130,100],n:[120,150,140,110]},312:{d:[[120,140,130,100],[110,130,130,110],[120,140,130,100],[100,120,130,110],[80,100,120,100]]},313:{y:[110,130,130,100],n:[120,150,140,110]},314:{y:[100,120,130,110],n:[130,160,140,100]},315:{d:[[100,120,130,110],[120,140,130,100],[110,130,140,110],[110,130,130,100],[90,110,120,100]]},316:{y:[110,140,130,100],n:[120,150,140,110]},317:{y:[100,120,140,110],n:[140,160,130,100]},318:{d:[[110,130,140,110],[120,140,130,100],[100,120,130,110],[120,140,130,100],[80,100,120,100]]},319:{y:[90,110,130,110],n:[150,180,150,100]},320:{y:[80,110,130,120],n:[160,180,140,100]},
  321:{y:[45,95,180,280],n:[80,140,120,60]},322:{d:[[95,120,150,85],[110,105,140,95],[85,110,155,100],[65,80,120,85],[50,85,110,120]]},323:{y:[55,75,100,120],n:[140,180,150,85]},324:{y:[70,100,140,180],n:[120,150,130,60]},325:{d:[[120,110,140,85],[100,95,130,95],[95,110,145,90],[70,85,110,80],[115,105,125,80]]},326:{y:[30,50,75,95],n:[185,220,195,60]},327:{y:[100,130,140,110],n:[85,110,130,95]},328:{d:[[110,105,125,85],[95,100,140,100],[85,95,130,110],[70,80,100,95],[80,95,120,85]]},329:{y:[50,70,95,110],n:[140,180,150,65]},330:{y:[60,100,140,150],n:[110,140,130,70]},
  331:{d:[[85,100,130,100],[110,115,140,85],[80,90,120,105],[105,120,135,80],[115,110,135,85]]},332:{y:[80,110,150,160],n:[70,100,120,75]},333:{y:[75,95,130,100],n:[95,110,140,100]},334:{d:[[105,110,130,85],[110,115,125,80],[95,105,135,90],[65,75,105,120],[85,95,125,100]]},335:{y:[80,125,180,220],n:[60,95,120,40]},336:{y:[85,110,140,110],n:[95,120,130,65]},337:{d:[[95,100,120,85],[110,120,140,95],[60,70,100,100],[105,115,130,80],[80,90,120,110]]},338:{y:[100,120,140,130],n:[75,110,130,95]},339:{y:[105,125,155,140],n:[80,110,125,60]},340:{d:[[100,110,140,90],[110,105,135,85],[95,105,135,95],[105,115,140,80],[85,95,125,100]]},
  341:{y:[40,60,95,110],n:[165,200,185,85]},342:{y:[65,95,130,110],n:[110,140,150,80]},343:{d:[[85,100,130,100],[110,120,140,85],[105,115,135,80],[75,85,110,105],[80,85,125,110]]},344:{y:[85,100,120,140],n:[95,125,140,95]},345:{y:[110,130,140,100],n:[85,110,130,95]},346:{d:[[95,110,135,95],[80,90,120,110],[90,105,130,100],[75,85,110,110],[110,120,135,80]]},347:{y:[100,135,180,200],n:[55,80,125,45]},348:{y:[75,95,120,110],n:[95,125,150,100]},349:{d:[[95,105,130,95],[100,115,140,90],[105,120,135,85],[110,115,130,85],[90,100,125,105]]},350:{y:[90,130,170,200],n:[70,100,110,50]},
  351:{y:[75,100,140,180],n:[60,90,120,95]},352:{d:[[85,100,125,100],[90,105,130,95],[95,110,140,90],[110,120,135,80],[80,85,110,115]]},353:{y:[50,70,100,110],n:[140,180,150,60]},354:{y:[75,95,130,160],n:[90,120,145,85]},355:{d:[[75,85,110,130],[95,110,135,100],[80,95,120,110],[90,105,125,105],[105,115,130,85]]},356:{y:[100,130,160,190],n:[65,95,115,45]},357:{y:[80,100,130,140],n:[90,120,140,80]},358:{d:[[70,85,110,120],[85,100,125,110],[90,110,130,95],[95,115,135,90],[85,100,125,105]]},359:{y:[95,115,140,150],n:[85,110,130,75]},360:{y:[60,80,110,130],n:[125,155,155,85]},
  361:{d:[[110,120,130,85],[100,115,135,95],[105,115,130,90],[95,105,125,100],[90,110,135,95]]},362:{y:[95,110,140,160],n:[85,120,140,65]},363:{d:[[85,95,120,105],[95,105,130,100],[105,120,135,90],[110,125,135,85],[75,85,110,120]]},364:{y:[100,125,150,160],n:[75,110,125,65]},365:{d:[[50,60,85,105],[85,105,140,120],[110,130,150,110],[95,110,135,115],[85,100,130,125]]},366:{y:[40,55,85,110],n:[180,210,180,60]},367:{d:[[95,110,135,95],[105,125,140,85],[85,100,125,105],[100,120,130,90],[75,85,110,125]]},368:{y:[105,130,155,170],n:[70,95,120,55]},369:{d:[[100,115,140,95],[110,125,135,90],[95,105,130,100],[105,120,135,85],[90,105,130,110]]},370:{y:[80,105,135,140],n:[95,125,145,75]},
  371:{d:[[70,80,110,130],[90,110,140,120],[100,120,135,105],[85,100,125,115],[95,110,130,100]]},372:{y:[110,125,140,150],n:[80,105,135,75]},373:{d:[[95,110,135,100],[85,100,125,110],[90,105,130,105],[105,120,140,95],[85,100,125,110]]},374:{y:[110,125,150,145],n:[85,105,130,70]},375:{d:[[75,85,110,125],[100,120,140,105],[95,110,135,110],[85,100,125,115],[105,125,140,95]]},376:{y:[95,120,150,135],n:[90,115,135,80]},377:{d:[[95,115,135,105],[90,110,135,110],[100,120,135,100],[70,85,110,120],[105,120,130,95]]},378:{y:[70,90,120,135],n:[120,150,155,70]},379:{d:[[100,120,140,100],[105,120,135,95],[95,110,130,105],[100,120,135,100],[85,105,125,115]]},380:{y:[120,140,160,160],n:[60,80,100,40]},
  381:{d:[[95,115,135,105],[100,120,140,95],[90,110,130,110],[105,120,135,90],[85,105,125,115]]},382:{y:[95,120,150,140],n:[85,110,135,80]},383:{d:[[85,100,130,120],[100,115,140,105],[105,120,140,95],[90,105,130,110],[75,85,110,130]]},384:{y:[100,120,150,160],n:[85,110,130,70]},385:{d:[[95,115,140,110],[90,110,130,110],[100,120,140,100],[80,95,120,115],[85,105,125,115]]},386:{y:[80,100,140,150],n:[95,130,135,75]},387:{d:[[75,90,120,135],[90,110,135,110],[100,120,140,95],[95,115,135,105],[85,100,125,115]]},388:{y:[85,110,140,160],n:[95,130,130,65]},389:{d:[[100,120,140,95],[95,115,135,105],[85,100,125,115],[70,85,110,125],[105,120,135,95]]},390:{y:[90,115,145,160],n:[85,115,130,70]},
  391:{d:[[85,100,130,120],[95,115,140,110],[90,110,135,110],[75,90,115,125],[95,110,130,105]]},392:{y:[120,140,160,150],n:[60,80,95,55]},393:{d:[[95,115,140,110],[100,120,140,100],[70,85,110,130],[105,120,135,95],[85,100,125,115]]},394:{y:[60,85,115,130],n:[130,160,155,65]},395:{d:[[110,125,140,105],[100,120,140,100],[105,125,140,95],[95,110,130,110],[90,105,130,115]]},396:{y:[70,95,125,140],n:[105,140,150,85]},397:{d:[[80,95,120,130],[100,120,140,100],[105,120,140,95],[75,90,115,125],[95,115,130,110]]},398:{y:[85,110,140,165],n:[95,125,130,65]},399:{d:[[80,95,120,130],[95,110,135,115],[105,125,145,100],[90,110,135,115],[85,105,130,120]]},400:{y:[85,110,140,155],n:[95,125,135,75]},
  401:{y:[45,120,180,55],n:[280,200,90,30]},402:{d:[[180,220,140,60],[240,240,80,40],[80,120,150,110],[40,60,80,150]]},403:{y:[30,110,280,380],n:[120,70,20,10]},404:{y:[80,150,200,170],n:[140,150,80,30]},405:{d:[[20,60,120,80],[90,180,150,80],[150,220,140,40],[40,90,120,60]]},406:{y:[60,180,240,280],n:[90,80,40,30]},407:{y:[20,50,100,150],n:[320,250,80,30]},408:{d:[[40,80,120,100],[120,200,220,140],[240,240,120,40],[180,160,100,80]]},409:{y:[140,240,180,80],n:[180,120,40,20]},410:{y:[90,130,160,120],n:[200,160,100,40]},
  411:{d:[[40,90,140,80],[150,240,180,80],[200,210,120,40],[110,140,120,80]]},412:{y:[120,200,200,130],n:[120,120,60,50]},413:{y:[100,200,240,200],n:[100,100,40,20]},414:{d:[[80,140,180,140],[200,260,160,80],[140,180,140,80],[40,60,100,100]]},415:{y:[280,280,120,60],n:[130,90,40,20]},416:{y:[70,140,180,160],n:[200,150,70,30]},417:{d:[[80,100,120,100],[140,200,180,120],[180,240,150,60],[240,220,120,40]]},418:{y:[100,120,140,100],n:[240,220,140,40]},419:{y:[40,80,140,180],n:[300,200,40,20]},420:{d:[[60,100,140,100],[140,180,200,140],[200,240,120,40],[160,160,120,80]]},
  421:{y:[80,140,160,100],n:[240,200,120,60]},422:{y:[120,220,220,160],n:[140,100,30,10]},423:{d:[[70,110,140,80],[160,220,180,120],[200,240,120,40],[120,160,120,40]]},424:{y:[100,140,160,120],n:[220,200,100,60]},425:{y:[140,220,220,180],n:[120,80,30,10]},426:{y:[20,30,80,870],n:[0,0,0,0]},427:{d:[[40,30,20,10],[50,40,30,20],[20,30,50,880],[30,40,30,50]]},428:{y:[0,0,0,0],n:[10,20,70,900]},429:{y:[30,60,200,710],n:[0,0,0,0]},430:{d:[[30,40,50,40],[40,50,50,40],[20,30,50,890],[30,40,40,50]]},
  431:{y:[0,0,0,0],n:[10,20,70,900]},432:{y:[10,30,100,860],n:[0,0,0,0]},433:{d:[[30,40,50,50],[80,100,120,120],[50,80,150,620],[40,60,80,80]]},434:{y:[100,140,200,160],n:[100,150,100,50]},435:{y:[40,60,120,180],n:[260,240,80,20]},436:{d:[[40,50,70,60],[50,60,70,50],[30,50,100,820],[40,50,60,50]]},437:{y:[20,50,150,780],n:[0,0,0,0]},438:{y:[10,40,150,800],n:[0,0,0,0]},439:{d:[[40,50,60,50],[30,50,120,800],[40,50,60,50],[50,50,50,50]]},440:{y:[280,240,120,80],n:[150,100,20,10]}
};

const generateFakeResults = (question) => {
  const dist = REALISTIC_DIST[question.id];
  const evaluators = [];
  let id = 0;

  if (question.type === 'binary' && dist?.y) {
    // Binary: dist.y = yes counts by confidence, dist.n = no counts
    dist.y.forEach((count, confIdx) => {
      for (let i = 0; i < count; i++) {
        evaluators.push({ id: `e${id++}`, answer: 0, confidence: confIdx + 1, score: 40 + Math.floor(Math.random() * 40) });
      }
    });
    dist.n.forEach((count, confIdx) => {
      for (let i = 0; i < count; i++) {
        evaluators.push({ id: `e${id++}`, answer: 1, confidence: confIdx + 1, score: 40 + Math.floor(Math.random() * 40) });
      }
    });
  } else if (dist?.d) {
    // Multiple choice: dist.d = array of [conf1,conf2,conf3,conf4] per option
    dist.d.forEach((optCounts, optIdx) => {
      optCounts.forEach((count, confIdx) => {
        for (let i = 0; i < count; i++) {
          evaluators.push({ id: `e${id++}`, answer: optIdx, confidence: confIdx + 1, score: 40 + Math.floor(Math.random() * 40) });
        }
      });
    });
  } else {
    // Fallback for any missing data
    const count = 600 + Math.floor(Math.random() * 200);
    if (question.type === 'binary') {
      for (let i = 0; i < count; i++) {
        evaluators.push({ id: `e${id++}`, answer: Math.random() > 0.5 ? 0 : 1, confidence: 1 + Math.floor(Math.random() * 4), score: 40 + Math.floor(Math.random() * 40) });
      }
    } else {
      const optLen = question.options?.length || 4;
      for (let i = 0; i < count; i++) {
        evaluators.push({ id: `e${id++}`, answer: Math.floor(Math.random() * optLen), confidence: 1 + Math.floor(Math.random() * 4), score: 40 + Math.floor(Math.random() * 40) });
      }
    }
  }
  return { evaluators };
};

// Convert QOD distribution data to evaluators format (so QOD can use same components as regular Q&A)
const qotdDistributionToEvaluators = (qotdData) => {
  if (!qotdData) return { evaluators: [] };
  const evaluators = [];
  let id = 0;

  if (qotdData.type === 'binary') {
    // distribution.yes[0..3] = counts for conf 1-4, same for .no
    qotdData.distribution.yes.forEach((count, confIdx) => {
      for (let i = 0; i < count; i++) {
        evaluators.push({ id: `qe${id++}`, answer: 0, confidence: confIdx + 1, score: 50 + Math.floor(Math.random() * 30) });
      }
    });
    qotdData.distribution.no.forEach((count, confIdx) => {
      for (let i = 0; i < count; i++) {
        evaluators.push({ id: `qe${id++}`, answer: 1, confidence: confIdx + 1, score: 50 + Math.floor(Math.random() * 30) });
      }
    });
  } else {
    // distribution[optIdx][confIdx] = count
    qotdData.distribution.forEach((optDist, optIdx) => {
      optDist.forEach((count, confIdx) => {
        for (let i = 0; i < count; i++) {
          evaluators.push({ id: `qe${id++}`, answer: optIdx, confidence: confIdx + 1, score: 50 + Math.floor(Math.random() * 30) });
        }
      });
    });
  }
  return { evaluators };
};

// ==================== DEMO PRE-POPULATION ====================
// Generate 20 pre-answered questions for demo experience
const generateDemoAnswers = () => {
  const answers = {};
  const now = Date.now();
  // Pre-answer first 20 questions with varied timestamps over past 7 days
  for (let i = 1; i <= 20; i++) {
    const q = QUESTIONS.find(q => q.id === i);
    if (!q) continue;
    const daysAgo = Math.floor(Math.random() * 7);
    const hoursAgo = Math.floor(Math.random() * 24);
    const timestamp = now - (daysAgo * 86400000) - (hoursAgo * 3600000);
    if (q.type === 'binary') {
      answers[i] = { answer: Math.random() > 0.5 ? 0 : 1, confidence: 1 + Math.floor(Math.random() * 4), timestamp };
    } else {
      answers[i] = { answer: Math.floor(Math.random() * (q.options?.length || 4)), confidence: 1 + Math.floor(Math.random() * 4), timestamp };
    }
  }
  return answers;
};

const generateDemoCommunityResults = () => {
  const results = {};
  for (let i = 1; i <= 20; i++) {
    const q = QUESTIONS.find(q => q.id === i);
    if (q) results[i] = generateFakeResults(q);
  }
  return results;
};

// ==================== ASSESSMENTS DATA ====================
const ASSESS_SCALES = {
  frequency: [
    { v: 1, l: 'Never' }, { v: 2, l: 'Rarely' }, { v: 3, l: 'Sometimes' },
    { v: 4, l: 'Often' }, { v: 5, l: 'Always' },
  ],
  agreement: [
    { v: 1, l: 'Strongly Disagree' }, { v: 2, l: 'Disagree' }, { v: 3, l: 'Neutral' },
    { v: 4, l: 'Agree' }, { v: 5, l: 'Strongly Agree' },
  ],
  likeme: [
    { v: 1, l: 'Not like me' }, { v: 2, l: 'A little unlike me' }, { v: 3, l: 'Neutral' },
    { v: 4, l: 'A little like me' }, { v: 5, l: 'Very like me' },
  ],
  likelihood: [
    { v: 1, l: 'Never would' }, { v: 2, l: 'Unlikely' }, { v: 3, l: 'Maybe' },
    { v: 4, l: 'Likely' }, { v: 5, l: 'Definitely' },
  ],
};

const ASSESS_TESTS = {
  // Big Five broken into 5 bite-sized modules by trait
  'bigfive-E': {
    name: 'Extraversion', icon: 'ðŸŽ‰', color: 'violet', scale: 'likeme', parent: 'bigfive', trait: 'E',
    description: 'How you engage with the social world',
    items: [
      { q: "I am the life of the party", t: 'E', k: '+' },
      { q: "I feel comfortable around people", t: 'E', k: '+' },
      { q: "I start conversations", t: 'E', k: '+' },
      { q: "I talk to many different people at parties", t: 'E', k: '+' },
      { q: "I don't mind being the center of attention", t: 'E', k: '+' },
      { q: "I don't talk a lot", t: 'E', k: '-' },
      { q: "I keep in the background", t: 'E', k: '-' },
      { q: "I have little to say", t: 'E', k: '-' },
      { q: "I don't like to draw attention to myself", t: 'E', k: '-' },
      { q: "I am quiet around strangers", t: 'E', k: '-' },
    ]
  },
  'bigfive-A': {
    name: 'Agreeableness', icon: 'ðŸ¤', color: 'violet', scale: 'likeme', parent: 'bigfive', trait: 'A',
    description: 'How you relate to others',
    items: [
      { q: "I sympathize with others' feelings", t: 'A', k: '+' },
      { q: "I am interested in people", t: 'A', k: '+' },
      { q: "I take time out for others", t: 'A', k: '+' },
      { q: "I feel others' emotions", t: 'A', k: '+' },
      { q: "I make people feel at ease", t: 'A', k: '+' },
      { q: "I am not really interested in others", t: 'A', k: '-' },
      { q: "I insult people", t: 'A', k: '-' },
      { q: "I am not interested in other people's problems", t: 'A', k: '-' },
      { q: "I feel little concern for others", t: 'A', k: '-' },
      { q: "I am hard to get to know", t: 'A', k: '-' },
    ]
  },
  'bigfive-C': {
    name: 'Conscientiousness', icon: 'ðŸ“‹', color: 'violet', scale: 'likeme', parent: 'bigfive', trait: 'C',
    description: 'How you approach tasks and goals',
    items: [
      { q: "I am always prepared", t: 'C', k: '+' },
      { q: "I pay attention to details", t: 'C', k: '+' },
      { q: "I get chores done right away", t: 'C', k: '+' },
      { q: "I like order", t: 'C', k: '+' },
      { q: "I follow a schedule", t: 'C', k: '+' },
      { q: "I leave my belongings around", t: 'C', k: '-' },
      { q: "I make a mess of things", t: 'C', k: '-' },
      { q: "I forget to put things back", t: 'C', k: '-' },
      { q: "I shirk my duties", t: 'C', k: '-' },
      { q: "I neglect my responsibilities", t: 'C', k: '-' },
    ]
  },
  'bigfive-N': {
    name: 'Emotional Range', icon: 'ðŸŒŠ', color: 'violet', scale: 'likeme', parent: 'bigfive', trait: 'N',
    description: 'How you experience emotions',
    items: [
      { q: "I get stressed out easily", t: 'N', k: '+' },
      { q: "I worry about things", t: 'N', k: '+' },
      { q: "I am easily disturbed", t: 'N', k: '+' },
      { q: "I get upset easily", t: 'N', k: '+' },
      { q: "I change my mood a lot", t: 'N', k: '+' },
      { q: "I am relaxed most of the time", t: 'N', k: '-' },
      { q: "I seldom feel blue", t: 'N', k: '-' },
      { q: "I am not easily bothered by things", t: 'N', k: '-' },
      { q: "I rarely get irritated", t: 'N', k: '-' },
      { q: "I keep my emotions under control", t: 'N', k: '-' },
    ]
  },
  'bigfive-O': {
    name: 'Openness', icon: 'ðŸŽ¨', color: 'violet', scale: 'likeme', parent: 'bigfive', trait: 'O',
    description: 'How you explore ideas and experiences',
    items: [
      { q: "I have a vivid imagination", t: 'O', k: '+' },
      { q: "I have excellent ideas", t: 'O', k: '+' },
      { q: "I am quick to understand things", t: 'O', k: '+' },
      { q: "I use difficult words", t: 'O', k: '+' },
      { q: "I spend time reflecting on things", t: 'O', k: '+' },
      { q: "I am not interested in abstract ideas", t: 'O', k: '-' },
      { q: "I do not have a good imagination", t: 'O', k: '-' },
      { q: "I have difficulty understanding abstract ideas", t: 'O', k: '-' },
      { q: "I am not interested in theoretical discussions", t: 'O', k: '-' },
      { q: "I avoid philosophical discussions", t: 'O', k: '-' },
    ]
  },
  adhd: {
    name: 'ADHD Screen', icon: 'âš¡', color: 'blue', scale: 'frequency',
    items: [
      { q: "I have trouble wrapping up final details once the hard parts are done" },
      { q: "I have difficulty getting organized for tasks" },
      { q: "I have problems remembering appointments" },
      { q: "I avoid or delay starting tasks that require thought" },
      { q: "I fidget when I have to sit for a long time" },
      { q: "I feel driven by a motor, overly active" },
    ]
  },
  cognitive: {
    name: 'Cognitive Style', icon: 'ðŸ§©', color: 'teal', scale: 'agreement',
    items: [
      { q: "I notice things others missâ€”small sounds, subtle changes" },
      { q: "I'm drawn to details before seeing the big picture" },
      { q: "Switching between tasks feels draining" },
      { q: "Getting back on track after interruption takes effort" },
      { q: "I take things literally, missing the subtext" },
      { q: "I don't naturally sense when someone wants to end a conversation" },
      { q: "I rely on words more than tone or expressions" },
      { q: "Movie characters' decisions often puzzle me" },
      { q: "I enjoy organizing info into categories and systems" },
      { q: "Learning rules and patterns is deeply satisfying" },
    ]
  },
  attachment: {
    name: 'Attachment', icon: 'ðŸ’', color: 'pink', scale: 'agreement',
    items: [
      { q: "When I don't hear from someone, I assume something is wrong", d: 'anx' },
      { q: "I look for signs a partner might be losing interest", d: 'anx' },
      { q: "Feeling truly secure in a relationship is rare", d: 'anx' },
      { q: "I need more reassurance than most that I'm valued", d: 'anx' },
      { q: "The possibility of being left weighs on me heavily", d: 'anx' },
      { q: "I push for closeness in ways that feel desperate after", d: 'anx' },
      { q: "I'm most comfortable not depending on anyone", d: 'av' },
      { q: "Opening up emotionally makes me feel exposed", d: 'av' },
      { q: "When relationships get too close, I want space", d: 'av' },
      { q: "I'd rather solve problems alone than ask a partner", d: 'av' },
      { q: "Emotional distance feels safer than vulnerability", d: 'av' },
      { q: "I've been told I'm hard to read", d: 'av' },
    ]
  },
  risk: {
    name: 'Risk Tolerance', icon: 'ðŸŽ²', color: 'amber', scale: 'likelihood',
    items: [
      { q: "Invest 20% of savings in a high-risk opportunity" },
      { q: "Quit a stable job to start a business" },
      { q: "Lend significant money to a friend" },
      { q: "Share an unpopular opinion publicly" },
      { q: "Confront a friend about something bothering me" },
      { q: "Introduce myself to a stranger at an event" },
      { q: "Try an extreme sport like skydiving" },
      { q: "Travel solo to an unfamiliar country" },
      { q: "Eat street food in a foreign country" },
      { q: "Take a job in a completely new field" },
      { q: "Challenge my boss's idea in a meeting" },
      { q: "Negotiate aggressively for higher salary" },
      { q: "Bend rules slightly to help someone I care about" },
      { q: "Keep extra change from a cashier's mistake" },
      { q: "Tell a white lie to avoid hurting feelings" },
    ]
  },
  // Character - Integrity (HEXACO Honesty-Humility)
  integrity: {
    name: 'Integrity Core', icon: 'ðŸ’Ž', color: 'emerald', scale: 'agreement',
    description: 'Your relationship with honesty and status',
    items: [
      { q: "I wouldn't use flattery to get ahead, even if it would work", k: '+' },
      { q: "If I knew I'd never be caught, I'd be tempted to cheat", k: '-' },
      { q: "Having a lot of money is not especially important to me", k: '+' },
      { q: "I would enjoy owning expensive luxury goods", k: '-' },
      { q: "I deserve more respect than the average person", k: '-' },
      { q: "I want people to know I'm an important, high-status person", k: '-' },
    ]
  },
  // Shadow Self - Dark Triad modules
  'shadow-M': {
    name: 'Strategic Mind', icon: 'â™Ÿï¸', color: 'slate', scale: 'agreement', parent: 'shadow', trait: 'M',
    description: 'Machiavellianism - tactical thinking',
    items: [
      { q: "It's wise to keep some things hidden from others", k: '+' },
      { q: "You should wait for the right moment to address wrongs", k: '+' },
      { q: "Most people can be influenced through their insecurities", k: '+' },
      { q: "I prefer strategies where I come out ahead", k: '+' },
      { q: "I carefully manage what different people know about me", k: '+' },
      { q: "Long-term planning beats short-term honesty", k: '+' },
    ]
  },
  'shadow-N': {
    name: 'Self-Image', icon: 'ðŸ‘‘', color: 'slate', scale: 'agreement', parent: 'shadow', trait: 'N',
    description: 'Narcissism - confidence and admiration',
    items: [
      { q: "I have a natural talent for influencing people", k: '+' },
      { q: "I like being the center of attention", k: '+' },
      { q: "I know I'm special because people tell me so", k: '+' },
      { q: "I insist on getting the respect I deserve", k: '+' },
      { q: "I'm more capable than most people I meet", k: '+' },
      { q: "I enjoy receiving compliments and recognition", k: '+' },
    ]
  },
  'shadow-P': {
    name: 'Detachment', icon: 'ðŸ–¤', color: 'slate', scale: 'agreement', parent: 'shadow', trait: 'P',
    description: 'Psychopathy - emotional detachment',
    items: [
      { q: "I stay calm in situations that upset others", k: '+' },
      { q: "People say I can be insensitive sometimes", k: '+' },
      { q: "I make decisions based on logic, not feelings", k: '+' },
      { q: "I rarely feel guilty about my choices", k: '+' },
      { q: "I get bored easily and need stimulation", k: '+' },
      { q: "Other people's problems aren't my concern", k: '+' },
    ]
  },
  // Rhythm - Chronotype
  chronotype: {
    name: 'Chronotype', icon: 'ðŸŒ…', color: 'blue', scale: 'agreement',
    description: 'Your natural energy rhythm throughout the day',
    items: [
      { q: "I naturally wake up early without an alarm", k: '+' },
      { q: "My best thinking happens in the morning", k: '+' },
      { q: "I feel most creative late at night", k: '-' },
      { q: "I struggle to focus after 9pm", k: '+' },
      { q: "Weekend mornings are for sleeping in", k: '-' },
      { q: "I'm usually the first one ready to leave social events", k: '+' },
    ]
  }
};

const ASSESS_C = {
  violet: { bg: 'bg-violet-500', text: 'text-violet-400', light: 'bg-violet-500/20', border: 'border-violet-500/30', grad: 'from-violet-600 to-violet-500' },
  blue: { bg: 'bg-blue-500', text: 'text-blue-400', light: 'bg-blue-500/20', border: 'border-blue-500/30', grad: 'from-blue-600 to-blue-500' },
  teal: { bg: 'bg-teal-500', text: 'text-teal-400', light: 'bg-teal-500/20', border: 'border-teal-500/30', grad: 'from-teal-600 to-teal-500' },
  rose: { bg: 'bg-rose-500', text: 'text-rose-400', light: 'bg-rose-500/20', border: 'border-rose-500/30', grad: 'from-rose-600 to-rose-500' },
  pink: { bg: 'bg-fuchsia-500', text: 'text-fuchsia-400', light: 'bg-fuchsia-500/20', border: 'border-fuchsia-500/30', grad: 'from-fuchsia-600 to-fuchsia-500' },
  emerald: { bg: 'bg-emerald-500', text: 'text-emerald-400', light: 'bg-emerald-500/20', border: 'border-emerald-500/30', grad: 'from-emerald-600 to-emerald-500' },
  slate: { bg: 'bg-slate-500', text: 'text-slate-400', light: 'bg-slate-500/20', border: 'border-slate-500/30', grad: 'from-slate-600 to-slate-500' },
  amber: { bg: 'bg-amber-500', text: 'text-amber-400', light: 'bg-amber-500/20', border: 'border-amber-500/30', grad: 'from-amber-600 to-amber-500' },
};

// Assessment categories for compact picker view
const ASSESS_CATEGORIES = {
  personality: { name: 'Personality', icon: 'ðŸŽ­', color: 'violet', tests: ['bigfive-E', 'bigfive-A', 'bigfive-C', 'bigfive-N', 'bigfive-O'] },
  character: { name: 'Character', icon: 'ðŸ’Ž', color: 'emerald', tests: ['integrity'] },
  shadow: { name: 'Shadow Self', icon: 'ðŸŒ‘', color: 'slate', tests: ['shadow-M', 'shadow-N', 'shadow-P'] },
  mind: { name: 'Mind', icon: 'ðŸ§ ', color: 'blue', tests: ['adhd', 'cognitive', 'chronotype'] },
  relationships: { name: 'Relationships', icon: 'ðŸ’š', color: 'pink', tests: ['attachment'] },
  behavior: { name: 'Behavior', icon: 'ðŸŽ²', color: 'amber', tests: ['risk'] },
};

const ASSESS_TRAITS = { E: 'Extraversion', A: 'Agreeableness', C: 'Conscientiousness', N: 'Neuroticism', O: 'Openness' };

const ASSESS_DEMO_PROFILES = {
  1: {
    name: 'Alex', desc: 'Confident exterior, sensitive soul', color: 'violet',
    bigfive: { E: [5,5,4,5,4,2,2,2,2,3], A: [4,4,4,4,4,2,1,2,2,3], C: [4,4,4,4,4,2,2,2,2,2], N: [4,4,4,5,4,2,2,3,2,2], O: [4,4,4,3,4,2,2,2,2,3] },
    adhd: [2,2,2,2,2,2], cognitive: [2,2,2,2,2,2,2,2,3,3],
    attachment: [4,4,4,5,4,4,2,2,2,2,2,2], risk: [4,4,3,4,4,4,3,4,3,4,4,4,3,2,3],
    integrity: [4,2,4,3,2,2], shadow: { M: [3,3,4,3,4,3], N: [4,4,4,4,4,4], P: [2,3,2,2,3,2] },
    chronotype: [4,5,2,4,2,4],
    skip: ['shadow-N', 'chronotype', 'adhd', 'risk'], // 71%
  },
  2: {
    name: 'Bob', desc: 'Laid back genius', color: 'teal',
    bigfive: { E: [3,3,2,2,3,3,4,3,3,4], A: [5,5,5,5,5,1,1,1,1,2], C: [2,3,2,2,2,4,3,4,3,3], N: [1,2,1,2,2,5,5,5,5,5], O: [5,5,5,5,5,1,1,1,1,1] },
    adhd: [3,4,3,4,2,2], cognitive: [4,4,3,3,3,3,2,3,5,5],
    attachment: [2,2,2,2,2,2,2,2,2,2,2,2], risk: [3,3,3,4,3,3,2,4,4,4,4,3,3,2,3],
    integrity: [5,1,5,2,1,1], shadow: { M: [4,4,4,4,4,4], N: [2,2,2,2,2,2], P: [3,3,4,3,3,3] },
    chronotype: [1,2,5,1,5,2],
    skip: ['bigfive-N', 'bigfive-O', 'integrity', 'chronotype', 'shadow-P'], // 64%
  },
  3: {
    name: 'Cindy', desc: 'Lucky optimist, loving life', color: 'pink',
    bigfive: { E: [5,5,5,5,5,1,1,1,1,1], A: [5,5,5,5,5,1,1,1,1,1], C: [2,2,2,2,2,4,4,4,4,4], N: [1,1,1,1,1,5,5,5,5,5], O: [3,2,2,2,3,3,4,4,4,3] },
    adhd: [4,4,4,3,4,4], cognitive: [2,2,2,2,1,2,2,2,2,2],
    attachment: [2,2,2,1,2,2,2,2,2,2,2,2], risk: [5,5,5,5,5,5,5,5,5,5,4,4,4,3,4],
    integrity: [3,3,2,4,3,3], shadow: { M: [2,2,2,2,2,2], N: [4,5,4,4,4,5], P: [2,2,2,2,4,2] },
    chronotype: [3,3,3,3,3,3],
    skip: ['adhd', 'shadow-M', 'shadow-P', 'risk', 'bigfive-N', 'cognitive'], // 57%
  }
};

const ASSESS_STORAGE_KEY = 'aura-assessments-v1';

// Calculate assessment results
const ASSESS_SHADOW_TRAITS = { M: 'Machiavellianism', N: 'Narcissism', P: 'Psychopathy' };

const calculateAssessResults = (testId, resp) => {
  const test = ASSESS_TESTS[testId];
  const results = {};
  // Big Five module (single trait)
  if (test.parent === 'bigfive') {
    let sum = 0, count = 0;
    test.items.forEach((item, i) => {
      if (resp[i]) {
        let value = resp[i];
        if (item.k === '-') value = 6 - value;
        sum += value; count++;
      }
    });
    results.trait = test.trait;
    results.traitName = ASSESS_TRAITS[test.trait];
    results.score = count > 0 ? Math.round((sum / (count * 5)) * 100) : 0;
  // Shadow module (Dark Triad)
  } else if (test.parent === 'shadow') {
    let sum = 0, count = 0;
    test.items.forEach((item, i) => {
      if (resp[i]) {
        let value = resp[i];
        if (item.k === '-') value = 6 - value;
        sum += value; count++;
      }
    });
    results.trait = test.trait;
    results.traitName = ASSESS_SHADOW_TRAITS[test.trait];
    results.score = count > 0 ? Math.round((sum / (count * 5)) * 100) : 0;
  // Integrity (HEXACO)
  } else if (testId === 'integrity') {
    let sum = 0, count = 0;
    test.items.forEach((item, i) => {
      if (resp[i]) {
        let value = resp[i];
        if (item.k === '-') value = 6 - value;
        sum += value; count++;
      }
    });
    results.score = count > 0 ? Math.round((sum / (count * 5)) * 100) : 0;
  } else if (testId === 'adhd') {
    results.indicators = Object.values(resp).filter(v => v >= 4).length;
  } else if (testId === 'cognitive') {
    results.score = Math.round((Object.values(resp).reduce((a, b) => a + b, 0) / (test.items.length * 5)) * 100);
  } else if (testId === 'attachment') {
    let anxSum = 0, avSum = 0, anxCount = 0, avCount = 0;
    test.items.forEach((item, i) => {
      if (resp[i]) {
        if (item.d === 'anx') { anxSum += resp[i]; anxCount++; }
        else { avSum += resp[i]; avCount++; }
      }
    });
    results.anxiety = (anxSum / anxCount).toFixed(1);
    results.avoidance = (avSum / avCount).toFixed(1);
    const highAnx = results.anxiety > 3, highAv = results.avoidance > 3;
    results.style = !highAnx && !highAv ? 'Secure' : highAnx && !highAv ? 'Anxious' : !highAnx && highAv ? 'Avoidant' : 'Fearful';
  } else if (testId === 'risk') {
    results.score = Math.round((Object.values(resp).reduce((a, b) => a + b, 0) / (test.items.length * 5)) * 100);
  } else if (testId === 'chronotype') {
    let sum = 0, count = 0;
    test.items.forEach((item, i) => {
      if (resp[i]) {
        let value = resp[i];
        if (item.k === '-') value = 6 - value;
        sum += value; count++;
      }
    });
    results.score = count > 0 ? Math.round((sum / (count * 5)) * 100) : 0;
    // High score = Morning Lark, Low score = Night Owl
    results.type = results.score > 60 ? 'Morning Lark' : results.score < 40 ? 'Night Owl' : 'Third Bird';
  }
  return results;
};

// ==================== STORAGE ====================
const STORAGE_KEY = 'aura-demo-vI';
const getInitialState = () => {
  const demoAnswers = generateDemoAnswers();
  return {
    answers: demoAnswers, skipped: [], saved: [], viewed: [],
    settings: { darkMode: null, undoDelay: 1, showStreak: true, requireConfirmation: true, showTips: true },
    stats: { answered: Object.keys(demoAnswers).length, streak: 3, lastAnswerDate: new Date().toDateString() }
  };
};

const demoStorage = {
  get: () => {
    try {
      const data = localStorage.getItem(STORAGE_KEY);
      if (data) return { ...getInitialState(), ...JSON.parse(data) };
    } catch (e) {}
    return getInitialState();
  },
  set: (data) => { try { localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); } catch (e) {} },
  clear: () => { try { localStorage.removeItem(STORAGE_KEY); } catch (e) {} }
};
// Reset to fresh state with 20 answers
demoStorage.clear();

const getInitialDarkMode = () => {
  const settings = demoStorage.get().settings;
  if (settings.darkMode !== null) return settings.darkMode;
  return window.matchMedia('(prefers-color-scheme: dark)').matches;
};

// ==================== HOOKS ====================
const useDisplayMode = () => {
  const getMode = () => {
    try {
      if (window.matchMedia('(display-mode: standalone)').matches) return 'mobile';
      if (window.navigator.standalone === true) return 'mobile';
      if (window.innerWidth <= 768) return 'mobile';
      if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) return 'mobile';
    } catch (e) {}
    return 'desktop';
  };
  const [mode, setMode] = useState('desktop');
  useEffect(() => {
    setMode(getMode());
    const handleResize = () => setMode(getMode());
    window.addEventListener('resize', handleResize);
    return () => window.removeEventListener('resize', handleResize);
  }, []);
  return mode;
};

const useSwipe = ({ onSwipeLeft, onSwipeRight, enabled = true }) => {
  const touchStartX = useRef(0);
  const touchStartY = useRef(0);

  const handleTouchStart = useCallback((e) => {
    if (!enabled) return;
    touchStartX.current = e.touches[0].clientX;
    touchStartY.current = e.touches[0].clientY;
  }, [enabled]);

  const handleTouchEnd = useCallback((e) => {
    if (!enabled) return;
    const deltaX = e.changedTouches[0].clientX - touchStartX.current;
    const deltaY = e.changedTouches[0].clientY - touchStartY.current;
    if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > 50) {
      if (deltaX > 0 && onSwipeRight) onSwipeRight();
      else if (deltaX < 0 && onSwipeLeft) onSwipeLeft();
    }
  }, [enabled, onSwipeLeft, onSwipeRight]);

  return { handlers: { onTouchStart: handleTouchStart, onTouchEnd: handleTouchEnd } };
};

// ==================== COMPONENTS ====================

// ProgressCircle - Reusable circular progress indicator with gradient
const PROGRESS_GRADIENTS = {
  violet: { from: '#8b5cf6', to: '#a78bfa' },
  blue: { from: '#3b82f6', to: '#60a5fa' },
  teal: { from: '#14b8a6', to: '#2dd4bf' },
  rose: { from: '#f43f5e', to: '#fb7185' },
  pink: { from: '#d946ef', to: '#e879f9' },
  emerald: { from: '#10b981', to: '#34d399' },
  amber: { from: '#f59e0b', to: '#fbbf24' },
  gray: { from: '#6b7280', to: '#9ca3af' },
  slate: { from: '#64748b', to: '#94a3b8' },
};

const ProgressCircle = ({
  progress = 0,
  size = 48,
  strokeWidth = 3,
  color = 'violet',
  icon = null,
  text = null,
  gradientId = 'prog',
  darkMode = true,
  glow = true,
  iconSize = 'text-lg',
  textSize = 'text-sm',
  orbit = false,
  onClick = null,
  title = null
}) => {
  const radius = (size - strokeWidth) / 2;
  const circumference = 2 * Math.PI * radius;
  const grad = PROGRESS_GRADIENTS[color] || PROGRESS_GRADIENTS.violet;
  const hasProgress = progress > 0;
  const isComplete = progress >= 100;
  const glowOpacity = Math.min(0.5, (progress / 100) * 0.5);

  return (
    <div
      className={`relative flex items-center justify-center ${onClick ? 'cursor-pointer hover:scale-110 transition-transform' : ''}`}
      style={{ width: size, height: size }}
      onClick={onClick}
      title={title}
    >
      {/* Outer glow - scales with progress */}
      {glow && hasProgress && (
        <div className="absolute inset-0 rounded-full blur-md transition-opacity"
             style={{ background: `linear-gradient(135deg, ${grad.from}, ${grad.to})`, opacity: glowOpacity }} />
      )}
      {/* Inner glow - only when complete */}
      {glow && isComplete && (
        <div className="absolute rounded-full blur-sm opacity-60"
             style={{
               width: size * 0.6, height: size * 0.6,
               background: `radial-gradient(circle, ${grad.from}40, transparent)`
             }} />
      )}
      {/* Orbiting dot */}
      {orbit && (
        <div className="absolute inset-0 orbit-anim" style={{ width: size, height: size }}>
          <div className="absolute rounded-full"
               style={{
                 width: 6, height: 6,
                 background: `linear-gradient(135deg, ${grad.from}, ${grad.to})`,
                 boxShadow: `0 0 8px ${grad.from}`,
                 left: size/2 - 3,
                 top: -3
               }} />
        </div>
      )}
      <svg width={size} height={size} className="absolute">
        <defs>
          <linearGradient id={gradientId} x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" stopColor={hasProgress ? grad.from : '#374151'} />
            <stop offset="100%" stopColor={hasProgress ? grad.to : '#4b5563'} />
          </linearGradient>
        </defs>
        <circle cx={size/2} cy={size/2} r={radius} fill="none"
                stroke={darkMode ? '#1f2937' : '#e5e7eb'} strokeWidth={strokeWidth} />
        <circle cx={size/2} cy={size/2} r={radius} fill="none"
                stroke={`url(#${gradientId})`} strokeWidth={strokeWidth} strokeLinecap="round"
                strokeDasharray={circumference}
                strokeDashoffset={circumference * (1 - progress / 100)}
                transform={`rotate(-90 ${size/2} ${size/2})`}
                className="transition-all duration-500" />
      </svg>
      {icon && !text && <span className={`relative z-10 ${iconSize}`}>{icon}</span>}
      {text !== null && (
        <span className={`relative z-10 font-bold ${textSize}`} style={{ color: hasProgress ? grad.to : (darkMode ? '#6b7280' : '#9ca3af') }}>
          {text}
        </span>
      )}
    </div>
  );
};

// PhoneFrame - Desktop wrapper
const PhoneFrame = ({ children, darkMode = true }) => (
  <div className="min-h-screen bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 flex items-center justify-center p-4">
    <div className="relative bg-[#1a1a1c] rounded-[55px] p-3 shadow-2xl" style={{ filter: 'drop-shadow(0 25px 50px rgba(0,0,0,0.4))' }}>
      <div className="absolute -left-[3px] top-[100px] w-[3px] h-[28px] bg-[#2a2a2c] rounded-l-sm" />
      <div className="absolute -left-[3px] top-[145px] w-[3px] h-[50px] bg-[#2a2a2c] rounded-l-sm" />
      <div className="absolute -left-[3px] top-[205px] w-[3px] h-[50px] bg-[#2a2a2c] rounded-l-sm" />
      <div className="absolute -right-[3px] top-[160px] w-[3px] h-[65px] bg-[#2a2a2c] rounded-r-sm" />
      <div className={`relative overflow-hidden flex flex-col ${darkMode ? 'bg-gray-950' : 'bg-gray-100'}`} style={{ width: 393, height: 852, borderRadius: 44 }}>
        <div className="absolute top-3 left-1/2 -translate-x-1/2 w-[126px] h-[37px] bg-black rounded-full z-30" />
        <div className={`flex-shrink-0 flex items-end justify-between px-8 pb-2 h-[54px] ${TH('text-primary', darkMode)} text-sm font-semibold relative z-20`}>
          <span>9:41</span>
          <div className="flex gap-1.5 items-center">
            <svg className="w-[18px] h-[12px]" viewBox="0 0 18 12" fill="currentColor"><path d="M1 4a1 1 0 011-1h1a1 1 0 011 1v4a1 1 0 01-1 1H2a1 1 0 01-1-1V4zM6 3a1 1 0 011-1h1a1 1 0 011 1v5a1 1 0 01-1 1H7a1 1 0 01-1-1V3zM11 2a1 1 0 011-1h1a1 1 0 011 1v6a1 1 0 01-1 1h-1a1 1 0 01-1-1V2z"/></svg>
            <svg className="w-[17px] h-[11px]" viewBox="0 0 17 11" fill="currentColor"><path d="M8.5 2.5a6 6 0 014.24 1.76.75.75 0 001.06-1.06A7.5 7.5 0 008.5 1a7.5 7.5 0 00-5.3 2.2.75.75 0 001.06 1.06A6 6 0 018.5 2.5z"/><path d="M8.5 5.5a3 3 0 012.12.88.75.75 0 001.06-1.06 4.5 4.5 0 00-6.36 0 .75.75 0 001.06 1.06A3 3 0 018.5 5.5z"/><circle cx="8.5" cy="9" r="1.5"/></svg>
            <div className="flex items-center">
              <div className={`w-[25px] h-[12px] border-[1.5px] ${darkMode ? 'border-white' : 'border-gray-900'} rounded-[3px] flex items-center p-[2px]`}>
                <div className={`w-[17px] h-[7px] ${TH('bg-inverted', darkMode)} rounded-[1px]`} />
              </div>
              <div className={`w-[1.5px] h-[5px] ${TH('bg-inverted', darkMode)} ml-[1px] rounded-r-sm`} />
            </div>
          </div>
        </div>
        <div className="flex-1 flex flex-col overflow-hidden">{children}</div>
        <div className={`absolute bottom-2 left-1/2 -translate-x-1/2 w-[134px] h-[5px] ${TH('bg-inverted', darkMode)} rounded-full opacity-60 z-20`} />
      </div>
    </div>
  </div>
);

// NavBar
const NavBar = ({ darkMode, stats, showStreak, onHome, onDoubleClickHome, onSettings, onProfile }) => (
  <div className={`flex items-center justify-between px-4 py-2 ${darkMode ? 'bg-gray-950/70 border-b border-white/5' : 'bg-white/70 border-b border-gray-200/50'} backdrop-blur-md`}>
    <button onClick={onHome} onDoubleClick={onDoubleClickHome} className="text-xl btn-feedback">ðŸŒ€</button>
    <button onClick={onProfile} className={`flex items-center gap-2 px-2 py-1 rounded-lg btn-feedback ${darkMode ? 'hover:bg-gray-800/50' : 'hover:bg-gray-200'}`}>
      <span className={`text-sm ${TH('text-muted', darkMode)}`}>{stats.answered} answered</span>
      {showStreak && stats.streak > 0 && <span className="text-sm text-orange-400">ðŸ”¥{stats.streak}</span>}
    </button>
    <button onClick={onSettings} className={`text-xl btn-feedback ${TH('text-muted', darkMode)}`}>â˜°</button>
  </div>
);

// LaunchScreen
const LaunchScreen = ({ onDemo, onLogin, darkMode }) => (
  <div className="flex-1 flex flex-col items-center justify-center p-8" style={{backgroundColor: darkMode ? '#030712' : '#f9fafb'}}>
    <div className="text-6xl mb-4">ðŸŒ€</div>
    <h1 className="text-3xl font-bold mb-2" style={{color: darkMode ? '#fff' : '#111'}}>Aura</h1>
    <p className="text-sm mb-12" style={{color: darkMode ? '#9ca3af' : '#6b7280'}}>Answer questions with confidence</p>
    <div className="w-full max-w-xs space-y-3">
      <button onClick={onLogin} className={`w-full py-3 px-6 rounded-xl font-medium btn-feedback ${darkMode ? 'shine-card shine-blue glow-blue' : ''}`} style={{backgroundColor: darkMode ? '#fff' : '#111', color: darkMode ? '#111' : '#fff'}}>Login / Sign Up</button>
      <button onClick={onDemo} className="w-full py-3 px-6 rounded-xl font-medium btn-feedback" style={{backgroundColor: darkMode ? '#1f2937' : '#f3f4f6', color: darkMode ? '#d1d5db' : '#374151'}}>Try Demo</button>
    </div>
    <p className="text-sm mt-6 text-center max-w-xs" style={{color: darkMode ? '#4b5563' : '#9ca3af'}}>Demo answers aren't saved to community.<br/>Login to contribute real data.</p>
  </div>
);

// ConfidenceSegments - fills up inside button
const ConfidenceSegments = ({ level, color = 'violet', active = false, darkMode = true }) => {
  const colors = {
    emerald: ['rgba(6,78,59,0.6)', 'rgba(4,120,87,0.7)', 'rgba(5,150,105,0.8)', 'rgba(16,185,129,0.9)'],
    rose: ['rgba(136,19,55,0.6)', 'rgba(190,18,60,0.7)', 'rgba(225,29,72,0.8)', 'rgba(244,63,94,0.9)'],
  };
  const shades = colors[color] || colors.emerald;
  if (!active || level === 0) return null;
  return (
    <div className="absolute bottom-0 left-0 right-0 h-2 flex">
      {[1, 2, 3, 4].map(i => (
        <div key={i} className={`flex-1 transition-all duration-150 ${i === 1 ? 'rounded-bl-xl' : ''} ${i === 4 ? 'rounded-br-xl' : ''}`}
          style={{
            backgroundColor: level >= i ? shades[i - 1] : 'rgba(0,0,0,0.2)',
            borderRight: i < 4 ? '1px solid rgba(0,0,0,0.3)' : 'none'
          }}
        />
      ))}
    </div>
  );
};

// BinaryChart - confidence breakdown
const BinaryChart = ({ evaluators, userResponse, darkMode = true }) => {
  if (!evaluators || evaluators.length === 0) return null;
  const allVotes = userResponse ? [...evaluators, { ...userResponse, id: 'user', score: 50 }] : evaluators;
  const userConf = userResponse ? Math.min(4, Math.max(1, userResponse.confidence || 1)) - 1 : -1;
  const data = [
    { label: 'Yes', answer: 0, confCounts: [0,0,0,0] },
    { label: 'No', answer: 1, confCounts: [0,0,0,0] },
  ];
  allVotes.forEach(v => {
    if (v.answer === 0) data[0].confCounts[v.confidence - 1]++;
    else if (v.answer === 1) data[1].confCounts[v.confidence - 1]++;
  });
  data.forEach(d => d.count = d.confCounts.reduce((a, b) => a + b, 0));
  const total = data[0].count + data[1].count;
  const sorted = [...data].sort((a, b) => b.count - a.count);
  const maxCount = Math.max(data[0].count, data[1].count, 1);
  // Colors: index 0=conf1(light), 3=conf4(dark) - display order is conf4â†’conf1 (darkâ†’light)
  const yesColors = ['#a7f3d0', '#6ee7b7', '#34d399', '#10b981']; // lightâ†’dark
  const noColors = ['#fecaca', '#fda4af', '#fb7185', '#f43f5e'];   // lightâ†’dark

  return (
    <div className="space-y-2">
      {sorted.map((opt) => {
        const isUserRow = userResponse?.answer === opt.answer;
        const pct = total > 0 ? Math.round((opt.count / total) * 100) : 0;
        const barWidth = maxCount > 0 ? (opt.count / maxCount) * 100 : 0;
        const emptyWidth = 100 - barWidth;
        const colors = opt.answer === 0 ? yesColors : noColors;
        return (
          <div key={opt.answer} className="flex items-center gap-2">
            <span className={`text-sm ${opt.answer === 0 ? (darkMode ? 'text-emerald-400' : 'text-emerald-600') : (darkMode ? 'text-rose-400' : 'text-rose-600')} ${isUserRow ? 'font-bold px-1.5 py-0.5 rounded-full border border-current' : 'w-12'}`}>
              {opt.label}
            </span>
            <span className={`text-sm w-10 ${opt.answer === 0 ? (darkMode ? 'text-emerald-400' : 'text-emerald-600') : (darkMode ? 'text-rose-400' : 'text-rose-600')}`}>{pct}%</span>
            <div className="flex-1 h-4 rounded-full overflow-hidden bg-black">
              <div className="h-full flex">
                {[3, 2, 1, 0].map(confIdx => {
                  const count = opt.confCounts[confIdx];
                  const segWidth = opt.count > 0 ? (count / maxCount) * 100 : 0;
                  const isUserSeg = isUserRow && confIdx === userConf;
                  return segWidth > 0 ? (
                    <div key={confIdx} className="h-full" style={{ width: `${segWidth}%`, background: colors[confIdx], ...(isUserSeg ? { border: '3px solid white', borderRadius: '12px', zIndex: 10, position: 'relative' } : {}) }} />
                  ) : null;
                })}
                {emptyWidth > 0 && (
                  <div className="h-full rounded-r-full" style={{ width: `${emptyWidth}%`, border: `1px solid ${colors[0]}`, borderLeft: 'none' }} />
                )}
              </div>
            </div>
          </div>
        );
      })}
    </div>
  );
};

// MultipleChoiceChart
const MultipleChoiceChart = ({ evaluators, userResponse, options, darkMode = true }) => {
  if (!evaluators || evaluators.length === 0) return null;
  const allVotes = userResponse ? [...evaluators, { ...userResponse, id: 'user', score: 50 }] : evaluators;
  const userConf = userResponse ? Math.min(4, Math.max(1, userResponse.confidence || 1)) - 1 : -1;
  const data = options.map((label, i) => {
    const votes = allVotes.filter(v => v.answer === i);
    const confCounts = [0, 0, 0, 0];
    votes.forEach(v => confCounts[v.confidence - 1]++);
    return { label, index: i, count: votes.length, confCounts };
  });
  const total = allVotes.length;
  const sorted = [...data].sort((a, b) => b.count - a.count);
  const maxCount = Math.max(...data.map(d => d.count), 1);

  return (
    <div className="space-y-1">
      {sorted.filter(opt => opt.count > 0).slice(0, 5).map((opt, rank) => {
        const isUserRow = userResponse?.answer === opt.index;
        const pct = total > 0 ? Math.round((opt.count / total) * 100) : 0;
        const barWidth = maxCount > 0 ? (opt.count / maxCount) * 100 : 0;
        const emptyWidth = 100 - barWidth;
        const optColor = MC_COLORS[opt.index % MC_COLORS.length];
        return (
          <div key={opt.index} className="flex items-center gap-2">
            <span className={`text-sm w-24 truncate ${isUserRow ? 'font-bold px-1.5 py-0.5 rounded-full border border-current' : ''}`} style={{ color: optColor.hex }}>{opt.label}</span>
            <span className="text-sm w-10" style={{ color: optColor.hex }}>{pct}%</span>
            <div className="flex-1 h-4 rounded-full overflow-hidden" style={{ border: `1px solid ${optColor.shades[0]}` }}>
              <div className="h-full flex">
                {[3, 2, 1, 0].map(confIdx => {
                  const count = opt.confCounts[confIdx];
                  const segWidth = opt.count > 0 ? (count / maxCount) * 100 : 0;
                  const isUserSeg = isUserRow && confIdx === userConf;
                  return segWidth > 0 ? (
                    <div key={confIdx} className="h-full" style={{ width: `${segWidth}%`, background: optColor.shades[confIdx], ...(isUserSeg ? { border: '3px solid white', borderRadius: '12px', zIndex: 10, position: 'relative' } : {}) }} />
                  ) : null;
                })}
              </div>
            </div>
          </div>
        );
      })}
    </div>
  );
};

// Mini Community Results - shows comparison with user's answer
const MiniCommunityResults = ({ question, results, userResponse, darkMode, onClick }) => {
  if (!results || !results.evaluators || !userResponse) return null;
  const total = results.evaluators.length;
  const isBinary = question.type === 'binary';
  const userConf = Math.min(4, Math.max(1, userResponse.confidence || 1)) - 1; // 0-3 index

  // Confidence color shades: index 0=conf4(dark), 1=conf3, 2=conf2, 3=conf1(light)
  const yesColors = ['#10b981', '#34d399', '#6ee7b7', '#a7f3d0']; // emerald darkâ†’light
  const noColors = ['#ef4444', '#f87171', '#fca5a5', '#fecaca'];   // rose darkâ†’light

  // Build segments: conf4, conf3, conf2, conf1 (left to right, dark to light)
  // Returns segments with conf index to check for user highlight
  const buildSegments = (byConf, colors, maxWidth) => {
    const segments = [];
    for (let i = 3; i >= 0; i--) { // conf4(i=3) first, then conf3, conf2, conf1
      if (byConf[i] > 0) {
        segments.push({
          width: (byConf[i] / maxWidth) * 100,
          color: colors[3 - i], // conf4â†’colors[0](dark), conf1â†’colors[3](light)
          conf: i // original confidence index (0-3 where 3=conf4)
        });
      }
    }
    return segments;
  };

  if (isBinary) {
    const yesByConf = [0, 0, 0, 0];
    const noByConf = [0, 0, 0, 0];
    results.evaluators.forEach(e => {
      const conf = Math.min(4, Math.max(1, e.confidence || 1)) - 1;
      if (e.answer === 0) yesByConf[conf]++;
      else noByConf[conf]++;
    });
    const yesTotal = yesByConf.reduce((a, b) => a + b, 0);
    const noTotal = noByConf.reduce((a, b) => a + b, 0);
    const yesPct = Math.round((yesTotal / total) * 100);
    const noPct = 100 - yesPct;
    const userIsYes = userResponse.answer === 0;
    const maxCount = Math.max(yesTotal, noTotal);

    // Winner on top
    const yesWins = yesPct >= noPct;
    const rows = yesWins
      ? [{ label: 'Yes', pct: yesPct, byConf: yesByConf, colors: yesColors, isYes: true },
         { label: 'No', pct: noPct, byConf: noByConf, colors: noColors, isYes: false }]
      : [{ label: 'No', pct: noPct, byConf: noByConf, colors: noColors, isYes: false },
         { label: 'Yes', pct: yesPct, byConf: yesByConf, colors: yesColors, isYes: true }];
    const winnerGlow = yesWins ? 'glow-emerald' : 'glow-rose';

    return (
      <button onClick={onClick} className={`w-full px-3 py-2 rounded-lg text-left transition-all active:scale-[0.99] ${darkMode ? `bg-gray-900/80 hover:bg-gray-800 shine-card ${winnerGlow}` : 'bg-gray-100 hover:bg-gray-200'}`}>
        <div className={`text-sm font-medium mb-1.5 truncate ${TH('text-secondary', darkMode)}`}>
          {question.text}
        </div>
        <div className="space-y-1">
          {rows.map(row => {
            const isUserRow = row.isYes === userIsYes;
            const segments = buildSegments(row.byConf, row.colors, maxCount);
            const totalWidth = segments.reduce((a, s) => a + s.width, 0);
            const emptyWidth = 100 - totalWidth;
            return (
              <div key={row.label} className="flex items-center gap-2">
                <span className={`text-sm ${isUserRow ? 'font-bold px-1.5 py-0.5 rounded-full border border-current' : 'w-8'}`} style={{ color: row.colors[0] }}>
                  {row.label}
                </span>
                <span className={`text-sm w-6`} style={{ color: row.colors[0] }}>{row.pct}</span>
                <div className="flex-1 h-2 rounded-full overflow-hidden bg-black">
                  <div className="h-full flex">
                    {segments.map((s, i) => {
                      // Highlight only the segment matching user's answer AND confidence
                      const isUserSegment = isUserRow && s.conf === userConf;
                      return (
                        <div key={i} className="h-full" style={{
                          width: `${s.width}%`,
                          backgroundColor: s.color,
                          ...(isUserSegment ? { border: '3px solid white', borderRadius: '12px', zIndex: 10, position: 'relative' } : {})
                        }} />
                      );
                    })}
                    {/* Empty portion: hollow pill outline (lightest color border, black center) */}
                    {emptyWidth > 0 && (
                      <div className="h-full rounded-r-full" style={{
                        width: `${emptyWidth}%`,
                        border: `1px solid ${row.colors[3]}`,
                        borderLeft: 'none'
                      }} />
                    )}
                  </div>
                </div>
              </div>
            );
          })}
        </div>
        <div className={`text-sm text-right mt-1 ${TH('text-faint', darkMode)}`}>{total} responses â†’</div>
      </button>
    );
  }

  // MC - separate bars per option, sorted by popularity
  const optionData = {};
  results.evaluators.forEach(e => {
    if (!optionData[e.answer]) optionData[e.answer] = { total: 0, byConf: [0, 0, 0, 0] };
    optionData[e.answer].total++;
    const conf = Math.min(4, Math.max(1, e.confidence || 1)) - 1;
    optionData[e.answer].byConf[conf]++;
  });
  const sorted = Object.entries(optionData).sort((a, b) => b[1].total - a[1].total).slice(0, 5);
  const maxCount = sorted[0]?.[1]?.total || 1;
  const winnerIdx = sorted[0] ? parseInt(sorted[0][0]) : 0;
  const mcGlowMap = ['glow-blue', 'glow-teal', 'glow-emerald', 'glow-rose', 'glow-violet'];
  const winnerGlow = mcGlowMap[winnerIdx % mcGlowMap.length];

  return (
    <button onClick={onClick} className={`w-full px-3 py-2 rounded-lg text-left transition-all active:scale-[0.99] ${darkMode ? `bg-gray-900/80 hover:bg-gray-800 shine-card ${winnerGlow}` : 'bg-gray-100 hover:bg-gray-200'}`}>
      <div className={`text-sm font-medium mb-1.5 truncate ${TH('text-secondary', darkMode)}`}>
        {question.text}
      </div>
      <div className="space-y-1">
        {sorted.map(([idx, data]) => {
          const i = parseInt(idx);
          const isUserRow = i === userResponse.answer;
          const pct = Math.round((data.total / total) * 100);
          const color = MC_COLORS[i % MC_COLORS.length];
          const label = question.options?.[i] || `Option ${i + 1}`;
          // Build segments: conf4â†’conf1, darkâ†’light (shades[3]=dark, shades[0]=light)
          const segments = [];
          for (let c = 3; c >= 0; c--) {
            if (data.byConf[c] > 0) {
              segments.push({
                width: (data.byConf[c] / maxCount) * 100,
                color: color.shades[c], // shades[3]=dark, shades[0]=light
                conf: c
              });
            }
          }
          const totalWidth = segments.reduce((a, s) => a + s.width, 0);
          const emptyWidth = 100 - totalWidth;
          return (
            <div key={i} className="flex items-center gap-2">
              <span className={`text-sm w-20 truncate ${isUserRow ? 'font-bold px-1.5 py-0.5 rounded-full border border-current' : ''}`} style={{ color: color.hex }}>
                {label}
              </span>
              <span className={`text-sm w-6`} style={{ color: color.hex }}>{pct}</span>
              <div className="flex-1 h-1.5 rounded-full overflow-hidden bg-black">
                <div className="h-full flex">
                  {segments.map((s, si) => {
                    // Highlight only the segment matching user's answer AND confidence
                    const isUserSegment = isUserRow && s.conf === userConf;
                    return (
                      <div key={si} className="h-full" style={{
                        width: `${s.width}%`,
                        backgroundColor: s.color,
                        ...(isUserSegment ? { border: '3px solid white', borderRadius: '12px', zIndex: 10, position: 'relative' } : {})
                      }} />
                    );
                  })}
                  {/* Empty portion: hollow pill outline (lightest color border, black center) */}
                  {emptyWidth > 0 && (
                    <div className="h-full rounded-r-full" style={{
                      width: `${emptyWidth}%`,
                      border: `1px solid ${color.shades[0]}`,
                      borderLeft: 'none'
                    }} />
                  )}
                </div>
              </div>
            </div>
          );
        })}
      </div>
      <div className={`text-sm text-right mt-1 ${TH('text-faint', darkMode)}`}>{total} responses â†’</div>
    </button>
  );
};

// Shared Community Results Rows - used by FullResultsPanel, AnsweredQuestionView, and QOTD
const CommunityResultsRows = ({ question, results, userResponse, darkMode, options }) => {
  const isBinary = question?.type === 'binary';
  const total = results?.evaluators?.length || 1;
  const userAnswer = userResponse?.answer;
  const userConf = userResponse ? Math.min(4, Math.max(1, userResponse.confidence || 1)) - 1 : -1;
  const questionOptions = options || question?.options || [];

  // Build rows data
  const allRows = [];
  if (isBinary) {
    const yesColors = ['#6ee7b7', '#34d399', '#10b981', '#059669'];
    const noColors = ['#fca5a5', '#f87171', '#ef4444', '#dc2626'];
    const yesByConf = [0, 0, 0, 0], noByConf = [0, 0, 0, 0];
    (results?.evaluators || []).forEach(e => {
      const conf = Math.min(4, Math.max(1, e.confidence || 1)) - 1;
      if (e.answer === 0) yesByConf[conf]++; else noByConf[conf]++;
    });
    const yesTotal = yesByConf.reduce((a, b) => a + b, 0);
    const noTotal = noByConf.reduce((a, b) => a + b, 0);
    const maxCount = Math.max(yesTotal, noTotal);
    allRows.push({ label: 'Yes', pct: Math.round((yesTotal / total) * 100), byConf: yesByConf, colors: yesColors, isUser: userAnswer === 0, maxCount });
    allRows.push({ label: 'No', pct: Math.round((noTotal / total) * 100), byConf: noByConf, colors: noColors, isUser: userAnswer === 1, maxCount });
  } else {
    const optionData = {};
    (results?.evaluators || []).forEach(e => {
      if (!optionData[e.answer]) optionData[e.answer] = { total: 0, byConf: [0, 0, 0, 0] };
      optionData[e.answer].total++;
      const conf = Math.min(4, Math.max(1, e.confidence || 1)) - 1;
      optionData[e.answer].byConf[conf]++;
    });
    const maxCount = Math.max(...Object.values(optionData).map(d => d.total), 1);
    questionOptions.forEach((opt, idx) => {
      const data = optionData[idx] || { total: 0, byConf: [0, 0, 0, 0] };
      const pct = Math.round((data.total / total) * 100);
      const colors = MC_COLORS[idx % MC_COLORS.length].shades;
      allRows.push({ label: opt, pct, byConf: data.byConf, colors, isUser: userAnswer === idx, maxCount });
    });
  }
  allRows.sort((a, b) => b.pct - a.pct);

  // Render confidence bar
  const renderBar = (byConf, colors, maxCount, isUser) => {
    const totalCount = byConf.reduce((a, b) => a + b, 0);
    if (totalCount === 0) return <div className="flex-1 h-5 rounded-full" style={{ border: `1px solid ${colors[0]}40` }} />;
    const segments = [];
    for (let i = 0; i <= 3; i++) {
      if (byConf[i] > 0) segments.push({ width: (byConf[i] / maxCount) * 100, color: colors[i], conf: i });
    }
    segments.reverse();
    const totalWidth = segments.reduce((a, s) => a + s.width, 0);
    const showEmpty = (100 - totalWidth) > 2;
    return (
      <div className="flex-1 h-5 rounded-full overflow-hidden flex" style={{ border: showEmpty ? `1px solid ${colors[0]}40` : 'none' }}>
        {segments.map((s, i) => {
          const isUserSeg = isUser && s.conf === userConf;
          const isLast = i === segments.length - 1;
          const isFirst = i === 0;
          return (
            <div key={i} className={`h-full ${isLast ? 'rounded-r-full' : ''} ${isFirst ? 'rounded-l-full' : ''}`} style={{
              width: showEmpty ? `${s.width}%` : (isLast ? undefined : `${s.width}%`),
              flex: !showEmpty && isLast ? 1 : undefined,
              backgroundColor: s.color,
              ...(isUserSeg ? { boxShadow: 'inset 0 0 0 3px white', zIndex: 10, position: 'relative' } : {})
            }} />
          );
        })}
      </div>
    );
  };

  return (
    <div className="space-y-1">
      {allRows.map((row, i) => (
        <div key={i} className="flex items-center gap-2">
          <div className={isBinary ? 'w-10' : 'w-[35%]'} style={{ flexShrink: 0 }}>
            <span className={`text-sm font-semibold truncate block ${row.isUser ? 'underline' : ''}`}
              style={{ color: row.colors[1] }}>
              {row.label}
            </span>
          </div>
          <span className="text-sm w-9 font-bold text-right" style={{ color: row.colors[1] }}>{row.pct}%</span>
          {renderBar(row.byConf, row.colors, row.maxCount, row.isUser)}
        </div>
      ))}
    </div>
  );
};

// Full Results Panel (modal)
const FullResultsPanel = ({ question, results, userResponse, darkMode, onClose, onSwipeLeft, onSwipeRight }) => {
  const isBinary = question.type === 'binary';
  const touchStartX = React.useRef(0);
  const total = results?.evaluators?.length || 1;
  const userAnswer = userResponse?.answer;
  const userConf = userResponse ? Math.min(4, Math.max(1, userResponse.confidence || 1)) - 1 : -1;

  const handleTouchStart = (e) => { touchStartX.current = e.touches[0].clientX; };
  const handleTouchEnd = (e) => {
    const diff = e.changedTouches[0].clientX - touchStartX.current;
    if (Math.abs(diff) > 50) {
      if (diff > 0 && onSwipeRight) onSwipeRight();
      else if (diff < 0 && onSwipeLeft) onSwipeLeft();
    }
  };

  // Build rows data - same logic as expanded view
  const allRows = [];
  if (isBinary) {
    const yesColors = ['#6ee7b7', '#34d399', '#10b981', '#059669'];
    const noColors = ['#fca5a5', '#f87171', '#ef4444', '#dc2626'];
    const yesByConf = [0, 0, 0, 0], noByConf = [0, 0, 0, 0];
    (results?.evaluators || []).forEach(e => {
      const conf = Math.min(4, Math.max(1, e.confidence || 1)) - 1;
      if (e.answer === 0) yesByConf[conf]++; else noByConf[conf]++;
    });
    const yesTotal = yesByConf.reduce((a, b) => a + b, 0);
    const noTotal = noByConf.reduce((a, b) => a + b, 0);
    const maxCount = Math.max(yesTotal, noTotal);
    allRows.push({ label: 'Yes', pct: Math.round((yesTotal / total) * 100), byConf: yesByConf, colors: yesColors, isUser: userAnswer === 0, maxCount });
    allRows.push({ label: 'No', pct: Math.round((noTotal / total) * 100), byConf: noByConf, colors: noColors, isUser: userAnswer === 1, maxCount });
  } else {
    const optionData = {};
    (results?.evaluators || []).forEach(e => {
      if (!optionData[e.answer]) optionData[e.answer] = { total: 0, byConf: [0, 0, 0, 0] };
      optionData[e.answer].total++;
      const conf = Math.min(4, Math.max(1, e.confidence || 1)) - 1;
      optionData[e.answer].byConf[conf]++;
    });
    const maxCount = Math.max(...Object.values(optionData).map(d => d.total), 1);
    question.options?.forEach((opt, idx) => {
      const data = optionData[idx] || { total: 0, byConf: [0, 0, 0, 0] };
      const pct = Math.round((data.total / total) * 100);
      const colors = MC_COLORS[idx % MC_COLORS.length].shades;
      allRows.push({ label: opt, pct, byConf: data.byConf, colors, isUser: userAnswer === idx, maxCount });
    });
  }
  allRows.sort((a, b) => b.pct - a.pct);

  // Render confidence bar - same as expanded view
  const renderBar = (byConf, colors, maxCount, isUser) => {
    const totalCount = byConf.reduce((a, b) => a + b, 0);
    if (totalCount === 0) return <div className="flex-1 h-5 rounded-full" style={{ border: `1px solid ${colors[0]}40` }} />;
    const segments = [];
    for (let i = 0; i <= 3; i++) {
      if (byConf[i] > 0) segments.push({ width: (byConf[i] / maxCount) * 100, color: colors[i], conf: i });
    }
    segments.reverse();
    const totalWidth = segments.reduce((a, s) => a + s.width, 0);
    const showEmpty = (100 - totalWidth) > 2;
    return (
      <div className="flex-1 h-5 rounded-full overflow-hidden flex" style={{ border: showEmpty ? `1px solid ${colors[0]}40` : 'none' }}>
        {segments.map((s, i) => {
          const isUserSeg = isUser && s.conf === userConf;
          const isLast = i === segments.length - 1;
          const isFirst = i === 0;
          return (
            <div key={i} className={`h-full ${isLast ? 'rounded-r-full' : ''} ${isFirst ? 'rounded-l-full' : ''}`} style={{
              width: showEmpty ? `${s.width}%` : (isLast ? undefined : `${s.width}%`),
              flex: !showEmpty && isLast ? 1 : undefined,
              backgroundColor: s.color,
              ...(isUserSeg ? { border: '3px solid white', borderRadius: isFirst && isLast ? '999px' : isFirst ? '999px 0 0 999px' : isLast ? '0 999px 999px 0' : '0', zIndex: 10, position: 'relative' } : {})
            }} />
          );
        })}
      </div>
    );
  };

  return (
    <div className="fixed inset-0 z-50 flex items-end justify-center bg-black/60" onClick={onClose}>
      <div
        className={`w-full max-w-md rounded-t-2xl ${darkMode ? 'bg-gray-900' : 'bg-white'}`}
        style={{ animation: 'slideUp 0.2s ease-out' }}
        onTouchStart={handleTouchStart}
        onTouchEnd={handleTouchEnd}
        onClick={onClose}
      >
        {/* Header - full question text */}
        <div className="px-4 pt-3 pb-1">
          <div className="flex items-center gap-2 mb-1">
            <span className={`text-sm font-black uppercase tracking-wide ${TH('text-sky', darkMode)}`}>LAST:</span>
            <span className={`text-sm ${TH('text-subtle', darkMode)}`}>{total} responses</span>
          </div>
          <p className={`text-base font-medium ${TH('text-bright', darkMode)}`}>{question.text}</p>
        </div>

        {/* All rows - same format as expanded */}
        <div className="px-4 pb-4 pt-2 space-y-1">
          {allRows.map((row, i) => (
            <div key={i} className="flex items-center gap-1">
              <div className={isBinary ? 'w-14 sm:w-12' : 'w-[40%]'} style={{ flexShrink: 0 }}>
                <span className="text-base sm:text-sm font-semibold inline-block truncate max-w-full px-1.5 py-0.5 rounded-full border"
                  style={{ color: row.colors[1], borderColor: row.isUser ? row.colors[1] : 'transparent' }}>
                  {row.label}
                </span>
              </div>
              <span className="text-base sm:text-sm w-8 sm:w-7 font-bold text-right" style={{ color: row.colors[1] }}>{row.pct}</span>
              {renderBar(row.byConf, row.colors, row.maxCount, row.isUser)}
            </div>
          ))}
        </div>

        {/* Tap hint */}
        <div className={`text-sm text-center pb-4 ${TH('text-faint', darkMode)}`}>
          tap anywhere to close
        </div>
      </div>
    </div>
  );
};

// Shared BottomSheet Component
const BottomSheet = ({ onClose, darkMode, children }) => (
  <div className="fixed inset-0 bg-black/70 flex items-end justify-center z-50 pb-8" onClick={onClose}>
    <div
      className={`rounded-xl p-4 w-[calc(100%-2rem)] max-w-xs ${
        darkMode ? 'bg-gray-900' : 'bg-white shadow-xl border border-gray-200'
      }`}
      onClick={e => e.stopPropagation()}
    >
      {children}
    </div>
  </div>
);

// Shared OptionChip Component
const OptionChip = ({ label, selected, onClick, darkMode, accentColor = 'violet' }) => {
  const baseClass = darkMode ? 'bg-gray-800 text-gray-400 hover:bg-gray-700' : 'bg-gray-200 text-gray-600 hover:bg-gray-300';
  const selectedClass = {
    violet: 'bg-violet-600 text-white',
    rose: 'bg-rose-500 text-white',
    amber: 'bg-amber-500 text-white',
  }[accentColor] || 'bg-violet-600 text-white';

  return (
    <button
      onClick={onClick}
      className={`px-2.5 py-1 rounded-lg text-xs transition-colors ${selected ? selectedClass : baseClass}`}
    >
      {label}
    </button>
  );
};

// Question Flag Modal
const QUESTION_FLAG_REASONS = ['Unclear', 'Biased', 'Duplicate', 'Wrong'];
const QuestionFlagModal = ({ questionId, onClose, onFlag, onClear, existingFlag, darkMode = true }) => {
  const [selected, setSelected] = React.useState(
    existingFlag ? existingFlag.split(', ').filter(r => QUESTION_FLAG_REASONS.includes(r)) : []
  );
  const [other, setOther] = React.useState(
    existingFlag ? existingFlag.split(', ').filter(r => !QUESTION_FLAG_REASONS.includes(r)).join(', ') : ''
  );
  const toggle = (r) => setSelected(prev => prev.includes(r) ? prev.filter(x => x !== r) : [...prev, r]);
  const canSubmit = selected.length > 0 || other.trim();
  const handleSubmit = () => { onFlag(questionId, [...selected, other.trim()].filter(Boolean).join(', ')); onClose(); };

  return (
    <BottomSheet onClose={onClose} darkMode={darkMode}>
      <div className="flex items-center gap-2 mb-3">
        <span className="text-rose-400">âš‘</span>
        <span className={`text-sm font-medium ${TH('text-primary', darkMode)}`}>Flag question</span>
      </div>
      <div className="flex gap-1.5 mb-3 flex-wrap">
        {QUESTION_FLAG_REASONS.map(r => (
          <OptionChip key={r} label={r} selected={selected.includes(r)} onClick={() => toggle(r)} darkMode={darkMode} accentColor="rose" />
        ))}
      </div>
      <input type="text" value={other} onChange={(e) => setOther(e.target.value)} placeholder="Other..."
        className={`w-full px-3 py-2 rounded-lg text-sm mb-3 ${TH('bg-input', darkMode)} border ${TH('border-subtle', darkMode)} focus:outline-none focus:border-rose-500`}
      />
      <div className="flex gap-2">
        <button onClick={onClose} className={`py-2 px-4 rounded-lg text-sm btn-feedback ${darkMode ? 'bg-gray-800/50 text-gray-400' : 'bg-gray-200 text-gray-600'}`}>Cancel</button>
        {existingFlag && <button onClick={() => { onClear(questionId); onClose(); }} className={`py-2 px-4 rounded-lg text-sm btn-feedback ${darkMode ? 'bg-gray-800 text-gray-300' : 'bg-gray-200 text-gray-700'}`}>Clear</button>}
        <button onClick={handleSubmit} disabled={!canSubmit} className={`flex-1 py-2 rounded-lg text-sm font-medium btn-feedback ${canSubmit ? 'bg-rose-500 text-white' : darkMode ? 'bg-gray-800 text-gray-600 cursor-not-allowed' : 'bg-gray-200 text-gray-400 cursor-not-allowed'}`}>
          {existingFlag ? 'Update' : 'Flag'}
        </button>
      </div>
    </BottomSheet>
  );
};

// Explanation Modal - multi-select with optional custom input
const EXPLANATION_REASONS = ['Gut feel', 'Research', 'Experience', 'Logic'];
const ExplanationModal = ({ questionId, onClose, onSave, onClear, existingExplanation, darkMode = true }) => {
  const [selected, setSelected] = React.useState(
    existingExplanation ? existingExplanation.split(', ').filter(r => EXPLANATION_REASONS.includes(r)) : []
  );
  const [other, setOther] = React.useState(
    existingExplanation ? existingExplanation.split(', ').filter(r => !EXPLANATION_REASONS.includes(r)).join(', ') : ''
  );
  const toggle = (r) => setSelected(prev => prev.includes(r) ? prev.filter(x => x !== r) : [...prev, r]);
  const canSubmit = selected.length > 0 || other.trim();
  const handleSubmit = () => { onSave(questionId, [...selected, other.trim()].filter(Boolean).join(', ')); onClose(); };

  return (
    <BottomSheet onClose={onClose} darkMode={darkMode}>
      <div className={`text-sm font-medium mb-3 ${TH('text-primary', darkMode)}`}>Why this answer?</div>
      <div className="space-y-2 mb-3">
        {EXPLANATION_REASONS.map(r => (
          <button key={r} onClick={() => toggle(r)}
            className={`w-full text-left px-3 py-2 rounded-lg text-sm transition-colors ${
              selected.includes(r)
                ? 'bg-amber-500 text-white'
                : darkMode ? 'bg-gray-800 text-gray-300 hover:bg-gray-700' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
            }`}
          >{r}</button>
        ))}
      </div>
      <input type="text" value={other} onChange={(e) => setOther(e.target.value)} placeholder="Other reason..."
        className={`w-full px-3 py-2 rounded-lg text-sm mb-3 ${TH('bg-input', darkMode)} border ${TH('border-subtle', darkMode)} focus:outline-none focus:border-amber-500`}
      />
      <div className="flex gap-2">
        <button onClick={onClose} className={`flex-1 py-2 rounded-lg text-sm btn-feedback ${darkMode ? 'bg-gray-800 text-gray-400' : 'bg-gray-200 text-gray-600'}`}>Cancel</button>
        {existingExplanation && <button onClick={() => { onClear(questionId); onClose(); }} className={`flex-1 py-2 rounded-lg text-sm btn-feedback ${darkMode ? 'bg-gray-800 text-gray-300' : 'bg-gray-200 text-gray-700'}`}>Clear</button>}
        <button onClick={handleSubmit} disabled={!canSubmit} className={`flex-1 py-2 rounded-lg text-sm font-medium btn-feedback ${canSubmit ? 'bg-amber-500 text-white' : darkMode ? 'bg-gray-800 text-gray-600' : 'bg-gray-200 text-gray-400'}`}>
          {existingExplanation ? 'Update' : 'Save'}
        </button>
      </div>
    </BottomSheet>
  );
};

// Can't Answer Modal - multi-select with optional custom input
const CANT_ANSWER_REASONS = ['Need more context', 'Question unclear', 'Conflict of interest', 'Not my area'];
const CantAnswerModal = ({ questionId, onClose, onSkip, darkMode = true }) => {
  const [selected, setSelected] = React.useState([]);
  const [other, setOther] = React.useState('');
  const toggle = (r) => setSelected(prev => prev.includes(r) ? prev.filter(x => x !== r) : [...prev, r]);
  const canSubmit = selected.length > 0 || other.trim();
  const handleSubmit = () => { onSkip(questionId, [...selected, other.trim()].filter(Boolean).join(', ')); onClose(); };

  return (
    <BottomSheet onClose={onClose} darkMode={darkMode}>
      <div className={`text-sm font-medium mb-3 ${TH('text-primary', darkMode)}`}>Can't answer this question</div>
      <div className="space-y-2 mb-3">
        {CANT_ANSWER_REASONS.map(r => (
          <button key={r} onClick={() => toggle(r)}
            className={`w-full text-left px-3 py-2 rounded-lg text-sm transition-colors ${
              selected.includes(r)
                ? 'bg-violet-600 text-white'
                : darkMode ? 'bg-gray-800 text-gray-300 hover:bg-gray-700' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
            }`}
          >{r}</button>
        ))}
      </div>
      <input type="text" value={other} onChange={(e) => setOther(e.target.value)} placeholder="Other reason..."
        className={`w-full px-3 py-2 rounded-lg text-sm mb-3 ${TH('bg-input', darkMode)} border ${TH('border-subtle', darkMode)} focus:outline-none focus:border-violet-500`}
      />
      <div className="flex gap-2">
        <button onClick={onClose} className={`flex-1 py-2 rounded-lg text-sm btn-feedback ${darkMode ? 'bg-gray-800 text-gray-400' : 'bg-gray-200 text-gray-600'}`}>Cancel</button>
        <button onClick={handleSubmit} disabled={!canSubmit} className={`flex-1 py-2 rounded-lg text-sm font-medium btn-feedback ${canSubmit ? 'bg-violet-600 text-white' : darkMode ? 'bg-gray-800 text-gray-600' : 'bg-gray-200 text-gray-400'}`}>Skip Question</button>
      </div>
    </BottomSheet>
  );
};

// None Option Modal - for MC questions
const NoneOptionModal = ({ questionId, onClose, onSubmit, darkMode = true }) => {
  const [customAnswer, setCustomAnswer] = React.useState('');
  const canSubmit = customAnswer.trim();
  const handleSubmit = () => { onSubmit(questionId, customAnswer.trim()); onClose(); };

  return (
    <div className="fixed inset-0 bg-black/70 flex items-end justify-center z-50 pb-8" onClick={onClose}>
      <div className={`rounded-xl p-4 w-[calc(100%-2rem)] max-w-xs ${TH('bg-card-simple', darkMode)}`} onClick={e => e.stopPropagation()}>
        <div className={`text-sm font-medium mb-2 ${TH('text-primary', darkMode)}`}>None of these options fit</div>
        <div className={`text-sm mb-3 ${darkMode ? 'text-gray-500' : 'text-gray-600'}`}>What would you answer instead?</div>
        <textarea value={customAnswer} onChange={(e) => setCustomAnswer(e.target.value)} placeholder="Your answer..."
          className={`w-full px-3 py-2 rounded-lg text-sm mb-3 h-20 resize-none ${darkMode ? 'bg-gray-800 text-white border-gray-700' : 'bg-gray-100 text-gray-900'} border focus:outline-none focus:border-violet-500`}
        />
        <div className="flex gap-2">
          <button onClick={onClose} className={`flex-1 py-2 rounded-lg text-sm btn-feedback ${darkMode ? 'bg-gray-800 text-gray-400' : 'bg-gray-200 text-gray-600'}`}>Cancel</button>
          <button onClick={handleSubmit} disabled={!canSubmit} className={`flex-1 py-2 rounded-lg text-sm font-medium btn-feedback ${canSubmit ? 'bg-violet-600 text-white' : darkMode ? 'bg-gray-800 text-gray-600' : 'bg-gray-200 text-gray-400'}`}>Submit</button>
        </div>
      </div>
    </div>
  );
};

// Answered Question View - shows expanded results (no change answer - locked after undo)
const AnsweredQuestionView = ({ question, response, results, darkMode, questionFlag, explanation, onFlagClick, onExplainClick }) => {
  const isBinary = question.type === 'binary';
  const category = CATEGORIES.find(c => c.id === question.category);
  const categoryColors = {
    prediction: darkMode ? 'bg-amber-900/30 text-amber-400' : 'bg-amber-100 text-amber-700',
    reasoning: darkMode ? 'bg-violet-900/30 text-violet-400' : 'bg-violet-100 text-violet-700',
    judgment: darkMode ? 'bg-teal-900/30 text-teal-400' : 'bg-teal-100 text-teal-700',
  };

  return (
    <div className="flex-1 flex flex-col overflow-y-auto px-4 py-3">
      {/* Category badge */}
      {category && (
        <div className="flex justify-center mb-2">
          <span className={`px-2 py-0.5 rounded-full text-sm font-medium ${categoryColors[question.category]}`}>
            {category.icon} {category.name}
          </span>
        </div>
      )}

      {/* Question with flag button */}
      <div className="flex items-start gap-2 mb-4">
        <h2 className={`question-text text-center font-medium flex-1 ${TH('text-primary', darkMode)}`}>
          {question.text}
        </h2>
        <button
          onClick={onFlagClick}
          className={`text-sm flex-shrink-0 ${questionFlag ? 'text-rose-400' : (darkMode ? 'text-gray-600 hover:text-gray-400' : 'text-gray-400 hover:text-gray-600')}`}
        >
          âš‘
        </button>
      </div>

      {/* Your answer summary with explain button */}
      <div className={`p-3 rounded-lg mb-4 ${TH('bg-overlay', darkMode)}`}>
        <div className="flex items-center justify-center gap-2">
          <div className={`text-sm ${TH('text-muted', darkMode)}`}>
            Your answer: <span className={`font-bold ${
              isBinary
                ? (response.answer === 0 ? (darkMode ? 'text-emerald-400' : 'text-emerald-600') : (darkMode ? 'text-rose-400' : 'text-rose-600'))
                : ''
            }`} style={!isBinary ? { color: MC_COLORS[response.answer % MC_COLORS.length].hex } : undefined}>
              {CONFIDENCE_LABELS[response.confidence]} {isBinary ? (response.answer === 0 ? 'Yes' : 'No') : question.options?.[response.answer]}
            </span>
          </div>
          <button
            onClick={onExplainClick}
            className={`text-sm ${explanation ? 'text-amber-400' : (darkMode ? 'text-gray-600 hover:text-amber-400' : 'text-gray-400 hover:text-amber-500')}`}
            title={explanation ? 'Edit note' : 'Add note'}
          >
            âœŽ
          </button>
        </div>
        {explanation && (
          <div className={`text-sm text-center mt-1 ${darkMode ? 'text-amber-400/70' : 'text-amber-600'}`}>
            {explanation}
          </div>
        )}
      </div>

      {/* Community Results - expanded - same style as FullResultsPanel */}
      {(() => {
        const total = results?.evaluators?.length || 1;
        const userAnswer = response?.answer;
        const userConf = response ? Math.min(4, Math.max(1, response.confidence || 1)) - 1 : -1;

        // Build rows data - same logic as FullResultsPanel
        const allRows = [];
        if (isBinary) {
          const yesColors = ['#6ee7b7', '#34d399', '#10b981', '#059669'];
          const noColors = ['#fca5a5', '#f87171', '#ef4444', '#dc2626'];
          const yesByConf = [0, 0, 0, 0], noByConf = [0, 0, 0, 0];
          (results?.evaluators || []).forEach(e => {
            const conf = Math.min(4, Math.max(1, e.confidence || 1)) - 1;
            if (e.answer === 0) yesByConf[conf]++; else noByConf[conf]++;
          });
          const yesTotal = yesByConf.reduce((a, b) => a + b, 0);
          const noTotal = noByConf.reduce((a, b) => a + b, 0);
          const maxCount = Math.max(yesTotal, noTotal);
          allRows.push({ label: 'Yes', pct: Math.round((yesTotal / total) * 100), byConf: yesByConf, colors: yesColors, isUser: userAnswer === 0, maxCount });
          allRows.push({ label: 'No', pct: Math.round((noTotal / total) * 100), byConf: noByConf, colors: noColors, isUser: userAnswer === 1, maxCount });
        } else {
          const optionData = {};
          (results?.evaluators || []).forEach(e => {
            if (!optionData[e.answer]) optionData[e.answer] = { total: 0, byConf: [0, 0, 0, 0] };
            optionData[e.answer].total++;
            const conf = Math.min(4, Math.max(1, e.confidence || 1)) - 1;
            optionData[e.answer].byConf[conf]++;
          });
          const maxCount = Math.max(...Object.values(optionData).map(d => d.total), 1);
          question.options?.forEach((opt, idx) => {
            const data = optionData[idx] || { total: 0, byConf: [0, 0, 0, 0] };
            const pct = Math.round((data.total / total) * 100);
            const colors = MC_COLORS[idx % MC_COLORS.length].shades;
            allRows.push({ label: opt, pct, byConf: data.byConf, colors, isUser: userAnswer === idx, maxCount });
          });
        }
        allRows.sort((a, b) => b.pct - a.pct);

        // Render confidence bar - same as FullResultsPanel
        const renderBar = (byConf, colors, maxCount, isUser) => {
          const totalCount = byConf.reduce((a, b) => a + b, 0);
          if (totalCount === 0) return <div className="flex-1 h-5 rounded-full" style={{ border: `1px solid ${colors[0]}40` }} />;
          const segments = [];
          for (let i = 0; i <= 3; i++) {
            if (byConf[i] > 0) segments.push({ width: (byConf[i] / maxCount) * 100, color: colors[i], conf: i });
          }
          segments.reverse();
          const totalWidth = segments.reduce((a, s) => a + s.width, 0);
          const showEmpty = (100 - totalWidth) > 2;
          return (
            <div className="flex-1 h-5 rounded-full overflow-hidden flex" style={{ border: showEmpty ? `1px solid ${colors[0]}40` : 'none' }}>
              {segments.map((s, i) => {
                const isUserSeg = isUser && s.conf === userConf;
                const isLast = i === segments.length - 1;
                const isFirst = i === 0;
                return (
                  <div key={i} className={`h-full ${isLast ? 'rounded-r-full' : ''} ${isFirst ? 'rounded-l-full' : ''}`} style={{
                    width: showEmpty ? `${s.width}%` : (isLast ? undefined : `${s.width}%`),
                    flex: !showEmpty && isLast ? 1 : undefined,
                    backgroundColor: s.color,
                    ...(isUserSeg ? { border: '3px solid white', borderRadius: isFirst && isLast ? '999px' : isFirst ? '999px 0 0 999px' : isLast ? '0 999px 999px 0' : '0', zIndex: 10, position: 'relative' } : {})
                  }} />
                );
              })}
            </div>
          );
        };

        return (
          <div className={`rounded-lg p-3 ${TH('bg-card-shine', darkMode)}`}>
            {/* Header - full question text */}
            <div className="mb-2">
              <div className="flex items-center gap-2 mb-1">
                <span className={`text-sm font-black uppercase tracking-wide ${TH('text-sky', darkMode)}`}>LAST:</span>
                <span className={`text-xs ${TH('text-subtle', darkMode)}`}>{total} responses</span>
              </div>
              <p className={`text-sm font-medium ${TH('text-bright', darkMode)}`}>{question.text}</p>
            </div>

            {/* All rows - same format as FullResultsPanel */}
            <div className="space-y-1">
              {allRows.map((row, i) => (
                <div key={i} className="flex items-center gap-1">
                  <div className={isBinary ? 'w-14 sm:w-12' : 'w-[40%]'} style={{ flexShrink: 0 }}>
                    <span className="text-base sm:text-sm font-semibold inline-block truncate max-w-full px-1.5 py-0.5 rounded-full border"
                      style={{ color: row.colors[1], borderColor: row.isUser ? row.colors[1] : 'transparent' }}>
                      {row.label}
                    </span>
                  </div>
                  <span className="text-base sm:text-sm w-8 sm:w-7 font-bold text-right" style={{ color: row.colors[1] }}>{row.pct}</span>
                  {renderBar(row.byConf, row.colors, row.maxCount, row.isUser)}
                </div>
              ))}
            </div>

            <div className={`text-sm text-center mt-2 ${TH('text-faint', darkMode)}`}>
              {results?.evaluators?.length || 0} responses Â· Demo data
            </div>
          </div>
        );
      })()}

      {/* Swipe hint */}
      <div className={`text-center mt-4 text-sm ${TH('text-faint', darkMode)}`}>
        Swipe for next â†’
      </div>
    </div>
  );
};

// Category Selection Screen - a5 mockup design
const CategoryScreen = ({ darkMode, categories, questions, responses, onSelectCategory, onSettings, stats, qotdData, qotdResponse, onQotdClick, onResetQotd, onAssessments, assessCompleted }) => {
  const getProgress = (categoryId) => {
    const catQuestions = categoryId === 'random' ? questions : questions.filter(q => q.category === categoryId);
    const binaryQ = catQuestions.filter(q => q.type === 'binary');
    const mcQ = catQuestions.filter(q => q.type === 'multiple');
    const binaryUnanswered = binaryQ.filter(q => !responses[q.id]).length;
    const mcUnanswered = mcQ.filter(q => !responses[q.id]).length;
    return { binaryUnanswered, mcUnanswered, total: catQuestions.length };
  };

  const handleCategoryClick = (categoryId) => {
    const progress = getProgress(categoryId);
    const track = progress.binaryUnanswered > 0 ? 'binary' : 'multiple';
    onSelectCategory(categoryId, track);
  };

  const totalAnswered = Object.keys(responses).length;
  const hasAnsweredQotd = qotdResponse !== null;

  // Category display config matching a5 mockup
  const categoryConfig = {
    prediction: { icon: 'â˜€ï¸', name: 'Predict', tagline: 'What will happen?', featured: true },
    reasoning: { icon: 'ðŸ§ ', name: 'Think', tagline: 'Logic puzzles & analysis', featured: false },
    judgment: { icon: 'âš–ï¸', name: 'Judge', tagline: 'Ethics & opinions', featured: false },
  };

  return (
    <div className={`flex-1 flex flex-col relative ${TH('bg-main', darkMode)}`}>
      {/* Header - a5 style */}
      <div className="flex items-center justify-between px-5 pt-4 pb-2">
        <span className="text-3xl cursor-pointer select-none" onDoubleClick={onResetQotd}>ðŸŒ€</span>
        <div className="flex items-center gap-3">
          <span className={`text-sm ${TH('text-muted', darkMode)}`}>
            {totalAnswered} answered {stats.streak > 0 && <span className="text-orange-400">ðŸ”¥{stats.streak}</span>}
          </span>
          <button onClick={onSettings} className={darkMode ? 'text-gray-500' : 'text-gray-400'}>
            <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="1.5" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="1.5" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
          </button>
        </div>
      </div>

      {/* Scrollable content */}
      <div className="flex-1 overflow-y-auto px-5 pt-2 pb-8 space-y-5 scroll-smooth">
        {/* QOD Card - a5 style with shine */}
        {qotdData && (
          <button
            onClick={onQotdClick}
            className={`w-full p-4 rounded-2xl text-center transition-colors shine-card shine-blue glow-blue ${
              darkMode
                ? 'bg-gradient-to-br from-blue-900/60 to-blue-950/80 border border-blue-500/40 hover:border-blue-400/80 active:border-blue-300'
                : 'bg-gradient-to-br from-blue-100 to-blue-50 border border-blue-200 hover:border-blue-300'
            }`}
          >
            <div className={`font-medium text-sm mb-2 ${darkMode ? 'text-blue-400' : 'text-blue-600'}`}>
              ðŸŒ€ Question of the Day
            </div>
            <p className={`text-lg font-semibold leading-snug ${TH('text-primary', darkMode)}`}>
              {qotdData.text}
            </p>
            {!hasAnsweredQotd && (
              <div className={`text-sm mt-2 ${darkMode ? 'text-blue-400/70' : 'text-blue-500'}`}>
                Tap to answer â†’
              </div>
            )}
          </button>
        )}

        {/* Welcome heading */}
        <h1 className={`text-3xl font-bold text-center ${TH('text-primary', darkMode)}`}>
          What's on your mind?
        </h1>

        {/* Category Cards - a5 style */}
        <div className="space-y-4">
          {categories.map(cat => {
            const config = categoryConfig[cat.id];
            if (!config) return null;
            const progress = getProgress(cat.id);
            const available = progress.binaryUnanswered + progress.mcUnanswered;
            const isFeatured = config.featured;
            // Distinct color config per category
            const colorConfig = {
              amber: { shine: 'shine-amber', glow: 'glow-amber', border: 'border-amber-500/40 hover:border-amber-400/90 active:border-amber-300', text: 'text-amber-400/80', bg: '' },
              violet: { shine: 'shine-violet', glow: 'glow-violet', border: 'border-violet-500/40 hover:border-violet-400/80 active:border-violet-300', text: 'text-violet-400/80', bg: 'bg-gradient-to-r from-violet-900/30 to-violet-950/50' },
              emerald: { shine: 'shine-emerald', glow: 'glow-emerald', border: 'border-emerald-500/40 hover:border-emerald-400/80 active:border-emerald-300', text: 'text-emerald-400/80', bg: 'bg-gradient-to-r from-emerald-900/30 to-emerald-950/50' },
              teal: { shine: 'shine-teal', glow: 'glow-teal', border: 'border-teal-500/40 hover:border-teal-400/80 active:border-teal-300', text: 'text-teal-400/80', bg: 'bg-gradient-to-r from-teal-900/30 to-teal-950/50' },
            };
            const cc = colorConfig[cat.color] || colorConfig.teal;
            const shineClass = cc.shine;
            const glowClass = cc.glow;
            const borderColor = cc.border;
            const bgGradient = cc.bg;
            const textColor = cc.text;

            return (
              <button
                key={cat.id}
                onClick={() => handleCategoryClick(cat.id)}
                disabled={available === 0}
                className={`w-full ${isFeatured ? 'py-5 px-5' : 'py-4 px-5'} rounded-2xl text-left transition-colors shine-card ${shineClass} ${glowClass} border ${borderColor} ${isFeatured ? 'starry-bg overflow-hidden' : bgGradient} ${available === 0 ? 'opacity-40' : ''}`}
              >
                <div className={`flex items-center gap-4 ${isFeatured ? 'relative z-10' : ''}`}>
                  <span className={isFeatured ? 'text-3xl' : 'text-2xl'}>{config.icon}</span>
                  <div>
                    <div className={`${isFeatured ? 'text-xl' : 'text-lg'} font-semibold ${TH('text-primary', darkMode)}`}>{config.name}</div>
                    <div className={`text-sm ${darkMode ? textColor : 'text-gray-500'}`}>{config.tagline}</div>
                  </div>
                </div>
              </button>
            );
          })}

          {/* Surprise me - rose accent */}
          {(() => {
            const progress = getProgress('random');
            const available = progress.binaryUnanswered + progress.mcUnanswered;
            return (
              <button
                onClick={() => handleCategoryClick('random')}
                disabled={available === 0}
                className={`w-full py-4 px-5 rounded-2xl text-left transition-colors shine-card shine-rose glow-rose border border-rose-500/40 hover:border-rose-400/80 active:border-rose-300 bg-gradient-to-r from-rose-900/30 to-rose-950/50 ${available === 0 ? 'opacity-40' : ''}`}
              >
                <div className="flex items-center gap-4">
                  <span className="text-2xl">âœ¨</span>
                  <div>
                    <div className={`text-lg font-semibold ${TH('text-primary', darkMode)}`}>Surprise me</div>
                    <div className={`text-sm ${darkMode ? 'text-rose-400/80' : 'text-rose-500'}`}>Explore something unexpected</div>
                  </div>
                </div>
              </button>
            );
          })()}

          {/* Reveal Card - cyan/sky accent for self-discovery */}
          <button
            onClick={onAssessments}
            className={`w-full py-4 px-5 rounded-2xl text-left transition-colors shine-card shine-blue glow-blue border ${
              darkMode
                ? 'border-sky-500/40 hover:border-sky-400/80 active:border-sky-300 bg-gradient-to-r from-sky-900/30 to-cyan-950/50'
                : 'border-sky-300 hover:border-sky-400 bg-gradient-to-r from-sky-50 to-cyan-50'
            }`}
          >
            <div className="flex items-center gap-4">
              <span className="text-2xl">ðŸªž</span>
              <div className="flex-1">
                <div className={`text-lg font-semibold ${TH('text-primary', darkMode)}`}>Reveal</div>
                <div className={`text-sm ${darkMode ? 'text-sky-400/80' : 'text-sky-600'}`}>Discover yourself</div>
              </div>
            </div>
          </button>

          {/* Bottom spacer for comfortable scrolling */}
          <div className="h-4" />
        </div>
      </div>

      {/* Scroll fade indicator at bottom */}
      <div className={`pointer-events-none absolute bottom-0 left-0 right-0 h-12 bg-gradient-to-t ${darkMode ? 'from-gray-950' : 'from-gray-100'} to-transparent`} />
    </div>
  );
};

// UndoBar - selected answer bubble sweeps across its row, styled like actual buttons
const UndoBar = ({ darkMode, undoDelay, onUndo, answer, confidence, isBinary, options, fullHeight, requireConfirmation = true }) => {
  const answerText = isBinary
    ? (answer === 0 ? 'YES' : 'NO')
    : `${String.fromCharCode(65 + answer)}. ${options?.[answer] || ''}`;

  // Get the exact button gradient colors based on confidence
  const conf = Math.min(confidence, 4);
  let bgGradient;
  if (isBinary) {
    const yesShades = darkMode
      ? [['#065f46', '#059669'], ['#047857', '#10b981'], ['#059669', '#34d399'], ['#10b981', '#6ee7b7']]
      : [['#a7f3d0', '#6ee7b7'], ['#6ee7b7', '#34d399'], ['#34d399', '#10b981'], ['#10b981', '#059669']];
    const noShades = darkMode
      ? [['#9f1239', '#e11d48'], ['#be123c', '#f43f5e'], ['#e11d48', '#fb7185'], ['#f43f5e', '#fda4af']]
      : [['#fecdd3', '#fda4af'], ['#fda4af', '#fb7185'], ['#fb7185', '#f43f5e'], ['#f43f5e', '#e11d48']];
    const shades = answer === 0 ? yesShades : noShades;
    const s = shades[conf - 1];
    bgGradient = `linear-gradient(135deg, ${s[0]} 0%, ${s[1]} 100%)`;
  } else {
    const color = MC_COLORS[answer % MC_COLORS.length];
    bgGradient = `linear-gradient(135deg, ${color.shades[conf - 1]} 0%, ${color.shades[Math.min(conf, 3)]} 100%)`;
  }

  // Button dimensions accounting for checkmark slots
  // MC: px-4 (16px), with confirmation: gap-1.5 (6px) + checkmark w-9 (36px) = 42px extra on right
  // Y/N: px-4 (16px), outer gap-1.5 (6px) splits halves, each half has button + gap-1.5 + checkmark
  // Y/N with confirmation: button ends 45px before center (3px half-gap + 6px inner gap + 36px checkmark)

  return (
    <div
      onClick={onUndo}
      className={`relative cursor-pointer active:opacity-80 overflow-hidden ${fullHeight ? 'h-full' : 'rounded-xl'}`}
    >
      {/* Light backdrop */}
      <div className={`h-full ${darkMode ? 'bg-gray-900/40' : 'bg-white/40'}`}>
        {/* Selected answer bubble positioned exactly over its button */}
        <div
          className={`absolute overflow-hidden ${isBinary ? 'rounded-xl' : 'rounded-lg'}`}
          style={isBinary ? (requireConfirmation ? {
            // Y/N with confirmation: YES | gap-2 (8px) | submit(44px) | gap-2 (8px) | NO
            top: '12px',
            height: '57px',
            left: answer === 0 ? '16px' : 'calc(50% + 30px)',
            right: answer === 0 ? 'calc(50% + 30px)' : '16px',
          } : {
            // Y/N without confirmation: grid-cols-2 gap-2
            top: '12px',
            height: '57px',
            left: answer === 0 ? '16px' : 'calc(50% + 4px)',
            right: answer === 0 ? 'calc(50% + 4px)' : '16px',
          }) : {
            // MC buttons: wrapper extends 16px past each side (-left-4 -right-4)
            // Need to add 16px to both left and right to compensate
            // Base: 16px (px-4 padding) + 16px (wrapper offset) = 32px
            // Right with checkmark: 32px + 42px (6px gap + 36px checkmark) = 74px
            left: '32px',
            right: requireConfirmation ? '74px' : '32px',
            top: `${12 + answer * 44}px`,
            height: '40px',
          }}
        >
          {/* Button styled exactly like the real answer buttons */}
          <div
            className={`relative h-full flex items-center overflow-hidden ${isBinary ? 'justify-center' : 'px-3 text-base text-white'}`}
            style={{ background: bgGradient }}
          >
            {/* Sweep overlay */}
            <div
              className="absolute inset-0 bg-black/30"
              style={{ animation: `sweepFill ${undoDelay}s linear forwards` }}
            />
            {/* Answer text - match actual button styling */}
            {isBinary ? (
              <div className="relative z-10 flex items-center justify-center gap-1.5">
                <span className="text-2xl font-bold text-white">{answer === 0 ? 'YES' : 'NO'}</span>
                <span className="text-sm font-medium text-white/70">â—†{confidence}</span>
              </div>
            ) : (
              <>
                <span className="relative z-10 font-medium mr-1 opacity-60">{String.fromCharCode(65 + answer)}.</span>
                <span className="relative z-10 truncate">{options?.[answer] || ''}</span>
                <span className="absolute top-1/2 right-2 -translate-y-1/2 z-10 text-sm font-bold bg-white/30 w-5 h-5 rounded-full flex items-center justify-center">
                  {confidence}
                </span>
              </>
            )}
          </div>
        </div>
      </div>
    </div>
  );
};

// Tip Banner
const TipBanner = ({ darkMode, onDismiss }) => (
  <div
    onClick={onDismiss}
    className={`rounded-md px-3 py-1 flex items-center justify-between cursor-pointer mb-2 ${
      darkMode ? 'bg-violet-900/30 border border-violet-500/30' : 'bg-violet-100 border border-violet-300'
    }`}
  >
    <span className={`text-sm ${darkMode ? 'text-violet-300' : 'text-violet-700'}`}>
      <span className="font-medium">Tip:</span> Confident? Tap up to four times
    </span>
    <span className={`text-sm ml-2 ${darkMode ? 'text-violet-500' : 'text-violet-400'}`}>âœ•</span>
  </div>
);

// QuestionCard (compact)
const QuestionCard = ({ question, darkMode, evidenceExpanded, onToggleEvidence }) => {
  const category = CATEGORIES.find(c => c.id === question.category);
  const hasEvidence = question.preEvidence && question.preEvidence.length > 0;
  const categoryColors = {
    prediction: darkMode ? 'bg-amber-900/30 text-amber-400' : 'bg-amber-100 text-amber-700',
    reasoning: darkMode ? 'bg-violet-900/30 text-violet-400' : 'bg-violet-100 text-violet-700',
    judgment: darkMode ? 'bg-teal-900/30 text-teal-400' : 'bg-teal-100 text-teal-700',
  };
  const glowMap = { prediction: 'glow-amber', reasoning: 'glow-violet', judgment: 'glow-teal' };
  const cardGlow = darkMode && question.category ? glowMap[question.category] || '' : '';
  return (
    <div className={`space-y-2 ${cardGlow ? `p-4 rounded-2xl ${cardGlow}` : ''}`}>
      {category && (
        <div className="flex justify-center">
          <span className={`px-2 py-0.5 rounded-full text-sm font-medium ${categoryColors[question.category]}`}>{category.icon} {category.name}</span>
        </div>
      )}
      <h2 className={`question-text text-center font-medium ${TH('text-primary', darkMode)}`}>{question.text}</h2>
      {hasEvidence && (
        <div className={`rounded-xl overflow-hidden ${darkMode ? 'bg-gradient-to-b from-gray-800/80 to-gray-900/80' : 'bg-white border border-gray-200 shadow-sm'}`}>
          <button
            onClick={onToggleEvidence}
            className={`w-full px-4 py-3 flex items-center justify-between transition-colors ${
              darkMode
                ? 'hover:bg-gray-700/30'
                : 'hover:bg-gray-50'
            }`}
          >
            <span className="flex items-center gap-2">
              <span className={`w-8 h-8 rounded-lg flex items-center justify-center text-base ${
                darkMode ? 'bg-violet-500/20 text-violet-400' : 'bg-violet-100 text-violet-600'
              }`}>ðŸ“Š</span>
              <span className={`text-sm font-medium ${darkMode ? 'text-gray-200' : 'text-gray-800'}`}>
                Evidence <span className={`ml-1 ${TH('text-subtle', darkMode)}`}>({question.preEvidence.length})</span>
              </span>
            </span>
            <span className={`w-6 h-6 rounded-full flex items-center justify-center text-xs transition-transform duration-200 ${
              darkMode ? 'bg-gray-700 text-gray-400' : 'bg-gray-200 text-gray-500'
            } ${evidenceExpanded ? 'rotate-180' : ''}`}>â–¼</span>
          </button>
          {evidenceExpanded && (
            <div className={`px-4 pb-4 space-y-3`}>
              {question.preEvidence.map((item, i) => (
                <div key={i} className={`rounded-lg p-3 ${darkMode ? 'bg-gray-800/60' : 'bg-gray-50'}`}>
                  {item.type === 'stat' ? (
                    <div className="flex items-center justify-between">
                      <span className={`text-sm ${TH('text-muted', darkMode)}`}>{item.label}</span>
                      <span className={`text-sm font-semibold px-2 py-0.5 rounded ${
                        darkMode ? 'bg-emerald-500/20 text-emerald-400' : 'bg-emerald-100 text-emerald-700'
                      }`}>{item.value}</span>
                    </div>
                  ) : (
                    <div className={`flex gap-2`}>
                      <span className={`text-lg leading-none ${darkMode ? 'text-gray-600' : 'text-gray-300'}`}>"</span>
                      <span className={`text-sm italic ${TH('text-muted', darkMode)}`}>{item.text}</span>
                    </div>
                  )}
                </div>
              ))}
            </div>
          )}
        </div>
      )}
    </div>
  );
};

// Binary Answer Buttons - FIXED POSITION, no transforms
const BinaryButtons = ({ darkMode, tappedAnswer, tapCount, isAnswered, currentResponse, onTap, onRightClick, pendingSubmit, requireConfirmation, onSubmit, onClear }) => {
  // Color shades for gradient (light to dark by confidence)
  const yesShades = {
    1: darkMode ? ['#065f46', '#059669'] : ['#a7f3d0', '#6ee7b7'],
    2: darkMode ? ['#047857', '#10b981'] : ['#6ee7b7', '#34d399'],
    3: darkMode ? ['#059669', '#34d399'] : ['#34d399', '#10b981'],
    4: darkMode ? ['#10b981', '#6ee7b7'] : ['#10b981', '#059669'],
  };
  const noShades = {
    1: darkMode ? ['#9f1239', '#e11d48'] : ['#fecdd3', '#fda4af'],
    2: darkMode ? ['#be123c', '#f43f5e'] : ['#fda4af', '#fb7185'],
    3: darkMode ? ['#e11d48', '#fb7185'] : ['#fb7185', '#f43f5e'],
    4: darkMode ? ['#f43f5e', '#fda4af'] : ['#f43f5e', '#e11d48'],
  };

  const getButtonStyle = (answer) => {
    const isSelected = tappedAnswer === answer;
    const isPending = pendingSubmit?.answer === answer;
    const wasAnswered = currentResponse?.answer === answer;
    const shades = answer === 0 ? yesShades : noShades;
    const conf = isSelected ? tapCount : (currentResponse?.confidence || pendingSubmit?.confidence || 2);

    // NO TRANSFORMS - buttons stay fixed
    if (wasAnswered || isPending) {
      const s = shades[Math.min(conf, 4)];
      return { background: `linear-gradient(135deg, ${s[0]} 0%, ${s[1]} 100%)`, boxShadow: 'none', color: 'white' };
    }
    if (isSelected) {
      const s = shades[Math.min(tapCount, 4)];
      return { background: `linear-gradient(135deg, ${s[0]} 0%, ${s[1]} 100%)`, boxShadow: `0 0 ${tapCount * 8}px rgba(${answer === 0 ? '16,185,129' : '244,63,94'}, ${0.2 + tapCount * 0.15})`, color: 'white' };
    }
    if (isAnswered) {
      return { background: darkMode ? 'rgb(31,41,55)' : 'rgb(243,244,246)', boxShadow: 'none', color: darkMode ? 'rgb(107,114,128)' : 'rgb(156,163,175)' };
    }
    return {
      background: darkMode ? 'rgb(31,41,55)' : 'rgb(255,255,255)',
      boxShadow: 'none',
      color: darkMode ? 'rgb(209,213,219)' : (answer === 0 ? 'rgb(5,150,105)' : 'rgb(225,29,72)'),
      border: darkMode ? 'none' : `2px solid ${answer === 0 ? 'rgb(167,243,208)' : 'rgb(254,205,211)'}`,
    };
  };

  const showSubmit = tappedAnswer !== null && requireConfirmation && !isAnswered && !pendingSubmit;

  // Full width buttons when auto-submit (no checkmark slots needed)
  if (!requireConfirmation) {
    return (
      <div className="grid grid-cols-2 gap-2">
        {[0, 1].map(answer => (
          <button
            key={answer}
            onClick={() => !isAnswered && !pendingSubmit && onTap(answer)}
            onContextMenu={(e) => onRightClick && onRightClick(e, answer)}
            disabled={isAnswered || pendingSubmit}
            className={`relative h-[57px] rounded-xl font-bold overflow-hidden select-none btn-feedback ${tappedAnswer === answer ? (answer === 0 ? 'ring-2 ring-emerald-400 shine-card shine-emerald' : 'ring-2 ring-rose-400 shine-card shine-rose') : ''}`}
            style={getButtonStyle(answer)}
          >
            <ConfidenceSegments level={tapCount} color={answer === 0 ? 'emerald' : 'rose'} active={tappedAnswer === answer} darkMode={darkMode} />
            <div className="relative z-10 flex items-center justify-center h-full gap-1.5">
              <span className="text-2xl font-bold">{answer === 0 ? 'YES' : 'NO'}</span>
              {tappedAnswer === answer && <span className="text-sm font-medium opacity-70">â—†{tapCount}</span>}
            </div>
          </button>
        ))}
      </div>
    );
  }

  // With centered checkmark between buttons when confirmation required
  return (
    <div className="flex items-center gap-2">
      {/* YES button */}
      <button
        onClick={() => !isAnswered && !pendingSubmit && onTap(0)}
        onContextMenu={(e) => onRightClick && onRightClick(e, 0)}
        disabled={isAnswered || pendingSubmit}
        className={`flex-1 relative h-[57px] rounded-xl font-bold overflow-hidden select-none btn-feedback ${tappedAnswer === 0 ? 'ring-2 ring-emerald-400 shine-card shine-emerald' : ''}`}
        style={getButtonStyle(0)}
      >
        <ConfidenceSegments level={tapCount} color="emerald" active={tappedAnswer === 0} darkMode={darkMode} />
        <div className="relative z-10 flex items-center justify-center h-full gap-1.5">
          <span className="text-2xl font-bold">YES</span>
          {tappedAnswer === 0 && <span className="text-sm font-medium opacity-70">â—†{tapCount}</span>}
        </div>
      </button>
      {/* Centered submit/clear buttons - FIXED height container to prevent any shift */}
      <div className="w-11 h-[57px] flex-shrink-0 flex flex-col items-center justify-center">
        {showSubmit && (
          <>
            <button
              onClick={() => onClear && onClear()}
              className={`w-6 h-6 rounded-full btn-feedback flex items-center justify-center text-xs ${darkMode ? 'bg-gray-700 text-gray-400' : 'bg-gray-200 text-gray-500'}`}
            >
              âœ•
            </button>
            <button
              onClick={() => onSubmit && onSubmit(tappedAnswer, tapCount)}
              className={`w-10 h-10 rounded-full text-white shadow-lg btn-feedback flex items-center justify-center text-lg ${tappedAnswer === 0 ? 'bg-emerald-500' : 'bg-rose-500'}`}
            >
              âœ“
            </button>
          </>
        )}
      </div>
      {/* NO button */}
      <button
        onClick={() => !isAnswered && !pendingSubmit && onTap(1)}
        onContextMenu={(e) => onRightClick && onRightClick(e, 1)}
        disabled={isAnswered || pendingSubmit}
        className={`flex-1 relative h-[57px] rounded-xl font-bold overflow-hidden select-none btn-feedback ${tappedAnswer === 1 ? 'ring-2 ring-rose-400 shine-card shine-rose' : ''}`}
        style={getButtonStyle(1)}
      >
        <ConfidenceSegments level={tapCount} color="rose" active={tappedAnswer === 1} darkMode={darkMode} />
        <div className="relative z-10 flex items-center justify-center h-full gap-1.5">
          <span className="text-2xl font-bold">NO</span>
          {tappedAnswer === 1 && <span className="text-sm font-medium opacity-70">â—†{tapCount}</span>}
        </div>
      </button>
    </div>
  );
};

// Multiple Choice Buttons - vG style
const MCButtons = ({ options, darkMode, tappedAnswer, tapCount, isAnswered, currentResponse, onTap, onRightClick, pendingSubmit, requireConfirmation, onSubmit, onClear }) => {
  const getOptionStyle = (option, index) => {
    const color = MC_COLORS[index % MC_COLORS.length];
    const isSelected = tappedAnswer === index;
    const isPending = pendingSubmit?.answer === index;
    const wasAnswered = currentResponse?.answer === index;
    const conf = isSelected ? tapCount : (currentResponse?.confidence || pendingSubmit?.confidence || 2);

    // NO TRANSFORMS - buttons stay fixed
    if (wasAnswered || isPending) {
      return {
        background: `linear-gradient(135deg, ${color.shades[conf - 1]} 0%, ${color.shades[Math.min(conf, 3)]} 100%)`,
        boxShadow: 'none',
        color: 'white',
        border: '2px solid transparent',
      };
    }
    if (isSelected) {
      return {
        background: `linear-gradient(135deg, ${color.shades[tapCount - 1]} 0%, ${color.shades[Math.min(tapCount, 3)]} 100%)`,
        boxShadow: `0 0 ${tapCount * 6}px rgba(${color.rgb}, ${0.2 + tapCount * 0.12})`,
        color: 'white',
        border: `2px solid ${color.hex}`,
      };
    }
    if (isAnswered) {
      return {
        background: darkMode ? 'rgb(31,41,55)' : 'rgb(243,244,246)',
        boxShadow: 'none',
        color: darkMode ? 'rgb(107,114,128)' : 'rgb(156,163,175)',
        border: '2px solid transparent',
      };
    }
    return {
      background: darkMode ? 'rgb(31,41,55)' : 'rgb(255,255,255)',
      boxShadow: 'none',
      color: darkMode ? 'rgb(209,213,219)' : 'rgb(55,65,81)',
      border: darkMode ? '2px solid transparent' : '2px solid rgb(229,231,235)',
    };
  };

  const selectedColor = tappedAnswer !== null ? MC_COLORS[tappedAnswer % MC_COLORS.length] : null;
  const showSubmit = tappedAnswer !== null && requireConfirmation && !isAnswered && !pendingSubmit;
  const getShineClass = (index) => {
    const shineMap = ['shine-blue', 'shine-teal', 'shine-emerald', 'shine-rose', 'shine-violet'];
    return shineMap[index % shineMap.length];
  };

  return (
    <div className="space-y-1">
      {options.map((option, index) => {
        const isSelected = tappedAnswer === index;
        const style = getOptionStyle(option, index);
        return (
          <div key={option} className="flex items-center gap-1.5">
            <button
              onClick={() => !isAnswered && !pendingSubmit && onTap(index)}
              onContextMenu={(e) => onRightClick && onRightClick(e, index)}
              disabled={isAnswered || pendingSubmit}
              className={`${requireConfirmation ? 'flex-1' : 'w-full'} h-[40px] px-3 rounded-lg text-left text-base overflow-hidden relative btn-feedback ${isSelected ? `shine-card ${getShineClass(index)}` : ''}`}
              style={style}
            >
              <span className="font-medium mr-1 opacity-60">{String.fromCharCode(65 + index)}.</span>
              <span className="truncate">{option}</span>
              {isSelected && (
                <span className="absolute top-1/2 right-2 -translate-y-1/2 text-sm font-bold bg-white/30 w-5 h-5 rounded-full flex items-center justify-center">
                  {tapCount}
                </span>
              )}
            </button>
            {/* Clear/Submit slot - FIXED height to prevent shift */}
            {requireConfirmation && (
              <div className="w-9 h-[40px] flex-shrink-0 flex flex-col items-center justify-center">
                {isSelected && showSubmit && (
                  <>
                    <button
                      onClick={() => onClear && onClear()}
                      className={`w-4 h-4 rounded-full btn-feedback flex items-center justify-center text-[10px] ${darkMode ? 'bg-gray-700 text-gray-400' : 'bg-gray-200 text-gray-500'}`}
                    >
                      âœ•
                    </button>
                    <button
                      onClick={() => onSubmit && onSubmit(tappedAnswer, tapCount)}
                      className="w-8 h-8 rounded-full text-white shadow-lg btn-feedback flex items-center justify-center text-base"
                      style={{ backgroundColor: selectedColor?.hex || '#8b5cf6' }}
                    >
                      âœ“
                    </button>
                  </>
                )}
              </div>
            )}
          </div>
        );
      })}
    </div>
  );
};

// SettingsScreen
const SettingsScreen = ({ darkMode, setDarkMode, undoDelay, setUndoDelay, requireConfirmation, setRequireConfirmation, showTips, setShowTips, showStreak, setShowStreak, onBack, onReset, onResetAssessments, hasAssessmentData, onHistory }) => (
  <div className={`flex-1 flex flex-col overflow-hidden ${TH('bg-main', darkMode)}`}>
    <div className={`flex items-center justify-between px-4 py-3 border-b ${TH('border-base', darkMode)}`}>
      <button onClick={onBack} className={`text-sm btn-feedback ${TH('text-violet', darkMode)}`}>â† Back</button>
      <h1 className={`font-semibold ${TH('text-primary', darkMode)}`}>Settings</h1>
      <div className="w-12" />
    </div>
    <div className="flex-1 overflow-y-auto p-4 space-y-3">
      {/* History link - Coming Soon */}
      <div className={`w-full rounded-lg p-3 ${TH('bg-overlay', darkMode)}`}>
        <div className="flex items-center justify-between">
          <div className={`text-sm font-medium ${TH('text-subtle', darkMode)}`}>ðŸ“‹ Answer History</div>
          <span className={`text-xs px-2 py-0.5 rounded-full ${darkMode ? 'bg-gray-800 text-gray-500' : 'bg-gray-200 text-gray-500'}`}>Coming Soon</span>
        </div>
      </div>
      <div className={`rounded-lg p-3 ${TH('bg-card-shine', darkMode)}`}>
        <div className="flex items-center justify-between">
          <div><div className={`text-sm font-medium ${TH('text-primary', darkMode)}`}>Theme</div></div>
          <button onClick={() => setDarkMode(!darkMode)} className={`relative w-12 h-6 rounded-full btn-feedback ${darkMode ? 'bg-violet-600' : 'bg-gray-200'}`}>
            <div className={`absolute top-0.5 w-5 h-5 bg-white rounded-full shadow transition-transform flex items-center justify-center text-sm ${darkMode ? 'translate-x-6' : 'translate-x-0.5'}`}>{darkMode ? 'ðŸŒ™' : 'â˜€ï¸'}</div>
          </button>
        </div>
      </div>
      <div className={`rounded-lg p-3 ${TH('bg-card-shine', darkMode)}`}>
        <div className="flex items-center justify-between mb-2">
          <div className={`text-sm font-medium ${TH('text-primary', darkMode)}`}>Undo Delay</div>
          <span className={`text-sm font-bold ${TH('text-violet', darkMode)}`}>{undoDelay === 0 ? 'Off' : `${undoDelay}s`}</span>
        </div>
        <input type="range" min="0" max="3" step="0.5" value={undoDelay} onChange={(e) => setUndoDelay(parseFloat(e.target.value))} className={`w-full h-1.5 rounded-lg appearance-none cursor-pointer accent-violet-500 ${darkMode ? 'bg-gray-700' : 'bg-gray-200'}`} />
      </div>
      <div className={`rounded-lg p-3 ${TH('bg-card-shine', darkMode)}`}>
        <div className="flex items-center justify-between">
          <div><div className={`text-sm font-medium ${TH('text-primary', darkMode)}`}>Require Submit Button</div><div className={`text-sm ${darkMode ? 'text-gray-500' : 'text-gray-500'}`}>Off = auto-submit on tap</div></div>
          <button onClick={() => setRequireConfirmation(!requireConfirmation)} className={`relative w-12 h-6 rounded-full btn-feedback ${requireConfirmation ? 'bg-violet-600' : darkMode ? 'bg-gray-600' : 'bg-gray-200'}`}>
            <div className={`absolute top-0.5 w-5 h-5 bg-white rounded-full shadow transition-transform ${requireConfirmation ? 'translate-x-6' : 'translate-x-0.5'}`} />
          </button>
        </div>
      </div>
      <div className={`rounded-lg p-3 ${TH('bg-card-shine', darkMode)}`}>
        <div className="flex items-center justify-between">
          <div><div className={`text-sm font-medium ${TH('text-primary', darkMode)}`}>Show Tips</div><div className={`text-sm ${darkMode ? 'text-gray-500' : 'text-gray-500'}`}>Gesture hints for new users</div></div>
          <button onClick={() => setShowTips(!showTips)} className={`relative w-12 h-6 rounded-full btn-feedback ${showTips ? 'bg-violet-600' : darkMode ? 'bg-gray-600' : 'bg-gray-200'}`}>
            <div className={`absolute top-0.5 w-5 h-5 bg-white rounded-full shadow transition-transform ${showTips ? 'translate-x-6' : 'translate-x-0.5'}`} />
          </button>
        </div>
      </div>
      <div className={`rounded-lg p-3 ${TH('bg-card-shine', darkMode)}`}>
        <div className="flex items-center justify-between">
          <div><div className={`text-sm font-medium ${TH('text-primary', darkMode)}`}>Streak Counter</div><div className={`text-sm ${darkMode ? 'text-gray-500' : 'text-gray-500'}`}>Show ðŸ”¥ during play</div></div>
          <button onClick={() => setShowStreak(!showStreak)} className={`relative w-12 h-6 rounded-full btn-feedback ${showStreak ? 'bg-violet-600' : darkMode ? 'bg-gray-600' : 'bg-gray-200'}`}>
            <div className={`absolute top-0.5 w-5 h-5 bg-white rounded-full shadow transition-transform ${showStreak ? 'translate-x-6' : 'translate-x-0.5'}`} />
          </button>
        </div>
      </div>
      {/* Keyboard shortcuts */}
      <div className={`rounded-lg p-3 ${darkMode ? 'bg-gray-900/50 border border-gray-800' : 'bg-white border border-gray-200'}`}>
        <div className={`text-sm font-medium mb-2 ${TH('text-dim', darkMode)}`}>Keyboard Shortcuts</div>
        <div className={`text-sm space-y-1 ${darkMode ? 'text-gray-500' : 'text-gray-600'}`}>
          <div className="flex justify-between"><span>Yes / Option A</span><span className="font-mono">Y or 1</span></div>
          <div className="flex justify-between"><span>No / Option B-E</span><span className="font-mono">N or 2-5</span></div>
          <div className="flex justify-between"><span>Next question</span><span className="font-mono">â†’ or Space</span></div>
          <div className="flex justify-between"><span>Previous question</span><span className="font-mono">â†</span></div>
          <div className="flex justify-between"><span>Undo</span><span className="font-mono">Esc</span></div>
        </div>
      </div>
      <div className="flex gap-2">
        {hasAssessmentData && (
          <button onClick={onResetAssessments} className={`flex-1 py-2.5 rounded-lg text-sm font-medium btn-feedback ${darkMode ? 'bg-amber-900/30 text-amber-400' : 'bg-amber-100 text-amber-600'}`}>Clear Assessments</button>
        )}
        <button onClick={onReset} className={`${hasAssessmentData ? 'flex-1' : 'w-full'} py-2.5 rounded-lg text-sm font-medium btn-feedback ${darkMode ? 'bg-rose-900/30 text-rose-400' : 'bg-rose-100 text-rose-600'}`}>Reset Demo</button>
      </div>
      <div className={`text-sm text-center ${TH('text-faint', darkMode)}`}>Aura Player vQ</div>
    </div>
  </div>
);

// ==================== MAIN APP ====================
function App() {
  const displayMode = useDisplayMode();
  const [questions] = useState(() => shuffleArray(QUESTIONS));
  const [screen, setScreen] = useState('categories');
  const [previousScreen, setPreviousScreen] = useState('categories');
  const [currentIndex, setCurrentIndex] = useState(0);
  const [darkMode, setDarkMode] = useState(getInitialDarkMode);
  const [responses, setResponses] = useState(() => demoStorage.get().answers);
  const [communityResults, setCommunityResults] = useState(() => generateDemoCommunityResults());
  const [undoDelay, setUndoDelay] = useState(() => demoStorage.get().settings.undoDelay);
  const [requireConfirmation, setRequireConfirmation] = useState(() => demoStorage.get().settings.requireConfirmation);
  const [showTips, setShowTips] = useState(() => demoStorage.get().settings.showTips !== false);
  const [showGestureHint, setShowGestureHint] = useState(true);
  const [stats, setStats] = useState(() => demoStorage.get().stats);
  const [pendingSubmit, setPendingSubmit] = useState(null);
  const [inGracePeriod, setInGracePeriod] = useState(false); // Grace period for multi-tap confidence
  const [justUndone, setJustUndone] = useState(false); // Shows "Undone" modal after canceling submit
  const [tappedAnswer, setTappedAnswer] = useState(null);
  const [tapCount, setTapCount] = useState(0);
  const [evidenceExpanded, setEvidenceExpanded] = useState(false);
  const [showFullResults, setShowFullResults] = useState(null);
  const [lastAnsweredQuestion, setLastAnsweredQuestion] = useState(null); // Track the question we just answered
  const [communityBrowseIndex, setCommunityBrowseIndex] = useState(0); // For browsing through answered questions
  const [communityDisplayMode, setCommunityDisplayMode] = useState('compact'); // 'compact', 'hidden'
  const [communityExpanded, setCommunityExpanded] = useState(false); // Slide-up expanded view
  const [selectedCategory, setSelectedCategory] = useState(null); // For category filtering
  const [selectedTrack, setSelectedTrack] = useState(null); // 'binary' or 'multiple'
  const [questionFlags, setQuestionFlags] = useState({}); // { [questionId]: "flag text" }
  const [answerExplanations, setAnswerExplanations] = useState({}); // { [questionId]: "explanation" }
  const [showQuestionFlagModal, setShowQuestionFlagModal] = useState(null); // questionId or null
  const [showExplanationModal, setShowExplanationModal] = useState(null); // questionId or null
  const [savedQuestions, setSavedQuestions] = useState(new Set()); // Questions saved for later
  const [skippedQuestions, setSkippedQuestions] = useState(new Set()); // Questions skipped

  // Question of the Day state
  const [qotdData, setQotdData] = useState(() => getRandomQOTD());
  const [qotdResponse, setQotdResponse] = useState(null); // { answer, confidence }

  // Reset QOD to a new random question
  const resetQotd = () => {
    setQotdData(getRandomQOTD());
    setQotdResponse(null);
    setQotdTappedAnswer(null);
    setQotdTapCount(0);
  };
  const [qotdTappedAnswer, setQotdTappedAnswer] = useState(null);
  const [qotdTapCount, setQotdTapCount] = useState(0);

  // QOTD tap handler (same logic as regular questions)
  const handleQotdTap = (answer) => {
    if (qotdResponse) return; // Already answered
    if (qotdTappedAnswer === answer) {
      setQotdTapCount(Math.min(4, qotdTapCount + 1));
    } else {
      setQotdTappedAnswer(answer);
      setQotdTapCount(1);
    }
  };

  const submitQotdAnswer = () => {
    if (qotdTappedAnswer === null) return;
    setQotdResponse({ answer: qotdTappedAnswer, confidence: qotdTapCount });
    setQotdTappedAnswer(null);
    setQotdTapCount(0);
  };

  // Profile/History state
  const [showStreak, setShowStreak] = useState(true);
  const [historyFilter, setHistoryFilter] = useState('all');

  // Modal state for Can't Answer / None Option
  const [showCantAnswerModal, setShowCantAnswerModal] = useState(null);
  const [showNoneOptionModal, setShowNoneOptionModal] = useState(false);
  const [sessionAnsweredCategories, setSessionAnsweredCategories] = useState(new Set()); // Categories user has answered in this session
  const [sessionAnsweredIds, setSessionAnsweredIds] = useState(new Set()); // Question IDs answered THIS session (show results only for these)

  // Assessment state
  const [assessCurrentTestId, setAssessCurrentTestId] = useState(null);
  const [assessCurrentIndex, setAssessCurrentIndex] = useState(0);
  const [assessResponses, setAssessResponses] = useState({});
  const [assessSkipped, setAssessSkipped] = useState([]);
  const [assessCompleted, setAssessCompleted] = useState(() => {
    try { const s = localStorage.getItem(ASSESS_STORAGE_KEY); return s ? JSON.parse(s).completed || {} : {}; } catch { return {}; }
  });
  const [assessInProgress, setAssessInProgress] = useState(() => {
    try { const s = localStorage.getItem(ASSESS_STORAGE_KEY); return s ? JSON.parse(s).inProgress || {} : {}; } catch { return {}; }
  });
  const [assessPending, setAssessPending] = useState(null);
  const [assessShowCompletion, setAssessShowCompletion] = useState(false);
  const [assessShowDemoMenu, setAssessShowDemoMenu] = useState(false);
  const [assessShowExitConfirm, setAssessShowExitConfirm] = useState(false);
  const [assessExpandedCategory, setAssessExpandedCategory] = useState(null);
  const [analysisExpanded, setAnalysisExpanded] = useState({});
  const [assessShowDemoInfo, setAssessShowDemoInfo] = useState(false);
  const [assessProfileSwitching, setAssessProfileSwitching] = useState(false);
  const [assessDemoActive, setAssessDemoActive] = useState(() => {
    try { const s = localStorage.getItem(ASSESS_STORAGE_KEY); return s ? JSON.parse(s).demoActive || false : false; } catch { return false; }
  });
  const [assessDemoProfile, setAssessDemoProfile] = useState(() => {
    try { const s = localStorage.getItem(ASSESS_STORAGE_KEY); return s ? JSON.parse(s).demoProfile || null : null; } catch { return null; }
  });
  const [assessSavedUserData, setAssessSavedUserData] = useState(() => {
    try { const s = localStorage.getItem(ASSESS_STORAGE_KEY); return s ? JSON.parse(s).savedUserData || null : null; } catch { return null; }
  });
  const assessTimeoutRef = useRef(null);

  const submitTimeoutRef = useRef(null);
  const tapTimeoutRef = useRef(null);
  const graceTimeoutRef = useRef(null);
  const pendingSubmitStartRef = useRef(null);
  const CONFIDENCE_GRACE_PERIOD = 600; // ms to allow additional taps to increase confidence

  const currentQuestion = questions[currentIndex];
  const currentResponse = currentQuestion ? responses[currentQuestion.id] : null;
  const isAnswered = !!currentResponse;
  const currentResults = currentQuestion ? communityResults[currentQuestion.id] : null;
  const isBinary = currentQuestion?.type === 'binary';

  // Last answered question for bottom community results (not just prev index)
  const lastAnsweredResponse = lastAnsweredQuestion ? responses[lastAnsweredQuestion.id] : null;
  const lastAnsweredResults = lastAnsweredQuestion ? communityResults[lastAnsweredQuestion.id] : null;

  // Calculate progress
  const totalQuestions = questions.length;
  const answeredCount = Object.keys(responses).length;

  useEffect(() => {
    const data = demoStorage.get();
    data.settings = { ...data.settings, darkMode, undoDelay, requireConfirmation, showTips };
    demoStorage.set(data);
  }, [darkMode, undoDelay, requireConfirmation, showTips]);

  // Find next unanswered question
  const findNextUnanswered = useCallback((fromIndex) => {
    for (let i = fromIndex + 1; i < questions.length; i++) {
      if (!responses[questions[i].id]) return i;
    }
    for (let i = 0; i < fromIndex; i++) {
      if (!responses[questions[i].id]) return i;
    }
    return null;
  }, [questions, responses]);

  // Check if question matches current category and track filters
  const matchesFilters = useCallback((q) => {
    if (selectedCategory && selectedCategory !== 'random' && q.category !== selectedCategory) return false;
    if (selectedTrack === 'binary' && q.type !== 'binary') return false;
    if (selectedTrack === 'multiple' && q.type !== 'multiple') return false;
    return true;
  }, [selectedCategory, selectedTrack]);

  const goToNext = useCallback(() => {
    let nextIdx = null;
    // Find next unanswered matching filters
    for (let i = currentIndex + 1; i < questions.length; i++) {
      if (matchesFilters(questions[i]) && !responses[questions[i].id]) {
        nextIdx = i;
        break;
      }
    }
    if (nextIdx === null) {
      // Wrap around
      for (let i = 0; i < currentIndex; i++) {
        if (matchesFilters(questions[i]) && !responses[questions[i].id]) {
          nextIdx = i;
          break;
        }
      }
    }
    if (nextIdx !== null) {
      setCurrentIndex(nextIdx);
      setTappedAnswer(null);
      setTapCount(0);
      setEvidenceExpanded(false);
      setCommunityBrowseIndex(0);
      setJustUndone(false); // Clear undo popup when leaving
    } else {
      setScreen('categories');
    }
  }, [currentIndex, matchesFilters, questions, responses]);

  const goToPrev = useCallback(() => {
    for (let i = currentIndex - 1; i >= 0; i--) {
      if (matchesFilters(questions[i])) {
        setCurrentIndex(i);
        setTappedAnswer(null);
        setTapCount(0);
        setEvidenceExpanded(false);
        setCommunityBrowseIndex(0);
        setJustUndone(false); // Clear undo popup when leaving
        return;
      }
    }
  }, [currentIndex, matchesFilters, questions]);

  // Skip question - move to next without answering
  const skipQuestion = useCallback(() => {
    if (currentQuestion) {
      setSkippedQuestions(prev => new Set([...prev, currentQuestion.id]));
    }
    setTappedAnswer(null);
    setTapCount(0);
    goToNext();
  }, [currentQuestion, goToNext]);

  // Save question for later
  const saveForLater = useCallback(() => {
    if (currentQuestion) {
      setSavedQuestions(prev => new Set([...prev, currentQuestion.id]));
    }
    setTappedAnswer(null);
    setTapCount(0);
    goToNext();
  }, [currentQuestion, goToNext]);

  const { handlers: swipeHandlers } = useSwipe({
    onSwipeLeft: goToNext,
    onSwipeRight: goToPrev,
    enabled: screen === 'question' && !pendingSubmit
  });

  // Assessment swipe handlers
  const assessSwipeNext = useCallback(() => {
    if (assessCurrentIndex < assessTotalQuestions - 1) assessGoToQuestion(assessCurrentIndex + 1, 'fwd');
  }, [assessCurrentIndex, assessTotalQuestions]);
  const assessSwipePrev = useCallback(() => {
    if (assessCurrentIndex > 0) assessGoToQuestion(assessCurrentIndex - 1, 'back');
  }, [assessCurrentIndex]);
  const { handlers: assessSwipeHandlers } = useSwipe({
    onSwipeLeft: assessSwipeNext,
    onSwipeRight: assessSwipePrev,
    enabled: screen === 'assess-question' && !assessPending
  });

  const handleAnswerTap = (answer) => {
    if (isAnswered) return;

    // During grace period, allow confidence increases on pending answer
    if (pendingSubmit && inGracePeriod) {
      if (answer === pendingSubmit.answer && pendingSubmit.confidence < 4) {
        // Increase confidence during grace period
        const newConfidence = Math.min(pendingSubmit.confidence + 1, 4);
        setPendingSubmit({ ...pendingSubmit, confidence: newConfidence });
        pendingSubmitStartRef.current = Date.now(); // Reset grace period timer
        // Reset grace period
        if (graceTimeoutRef.current) clearTimeout(graceTimeoutRef.current);
        graceTimeoutRef.current = setTimeout(() => setInGracePeriod(false), CONFIDENCE_GRACE_PERIOD);
        // Restart the submit timeout with new confidence
        if (submitTimeoutRef.current) clearTimeout(submitTimeoutRef.current);
        if (undoDelay > 0) {
          submitTimeoutRef.current = setTimeout(() => {
            finalizeSubmit(answer, newConfidence, pendingSubmit.community);
          }, undoDelay * 1000);
        }
      }
      return;
    }

    // If pending but not in grace period, ignore tap (handled by overlay)
    if (pendingSubmit) return;

    if (tapTimeoutRef.current) clearTimeout(tapTimeoutRef.current);

    let newTapCount;
    if (tappedAnswer === answer) {
      newTapCount = Math.min(tapCount + 1, 4);
      setTapCount(newTapCount);
    } else {
      newTapCount = 1;
      setTappedAnswer(answer);
      setTapCount(1);
    }

    // Auto-submit if not requiring confirmation
    if (!requireConfirmation) {
      tapTimeoutRef.current = setTimeout(() => {
        submitAnswer(answer, newTapCount);
      }, 400);
    }
  };

  // Right-click to decrease confidence
  const handleAnswerRightClick = (e, answer) => {
    e.preventDefault();
    if (isAnswered || pendingSubmit) return;
    if (tappedAnswer !== answer) return; // Can only decrease if this answer is selected

    if (tapCount > 1) {
      setTapCount(tapCount - 1);
    }
  };

  const submitAnswer = (answer, confidence) => {
    if (submitTimeoutRef.current) clearTimeout(submitTimeoutRef.current);
    if (tapTimeoutRef.current) clearTimeout(tapTimeoutRef.current);
    if (justUndone) setJustUndone(false); // Clear undo state

    const community = generateFakeResults(currentQuestion);

    setPendingSubmit({ answer, confidence, community });
    pendingSubmitStartRef.current = Date.now(); // Track when pending started for grace period
    setTappedAnswer(null);
    setTapCount(0);

    // Start grace period for multi-tap confidence
    setInGracePeriod(true);
    if (graceTimeoutRef.current) clearTimeout(graceTimeoutRef.current);
    graceTimeoutRef.current = setTimeout(() => setInGracePeriod(false), CONFIDENCE_GRACE_PERIOD);

    // Hide gesture hint after first answer
    if (showGestureHint) setShowGestureHint(false);

    if (undoDelay === 0) {
      finalizeSubmit(answer, confidence, community);
    } else {
      submitTimeoutRef.current = setTimeout(() => {
        finalizeSubmit(answer, confidence, community);
      }, undoDelay * 1000);
    }
  };

  const finalizeSubmit = (answer, confidence, community) => {
    if (graceTimeoutRef.current) clearTimeout(graceTimeoutRef.current);
    setInGracePeriod(false);
    const data = demoStorage.get();
    data.answers[currentQuestion.id] = { answer, confidence, timestamp: Date.now() };
    data.stats.answered = Object.keys(data.answers).length;
    const today = new Date().toDateString();
    if (data.stats.lastAnswerDate !== today) {
      const yesterday = new Date(Date.now() - 86400000).toDateString();
      data.stats.streak = data.stats.lastAnswerDate === yesterday ? data.stats.streak + 1 : 1;
      data.stats.lastAnswerDate = today;
    }
    demoStorage.set(data);

    // Capture to Firebase (if configured)
    captureResponse(currentQuestion.id, answer, confidence);

    // Track this as last answered question BEFORE advancing
    setLastAnsweredQuestion(currentQuestion);
    setCommunityBrowseIndex(0); // Reset to show most recent

    // Track that user has answered in this category this session
    if (currentQuestion.category) {
      setSessionAnsweredCategories(prev => new Set([...prev, currentQuestion.category]));
    }
    // Track this question as answered THIS session (for showing results)
    setSessionAnsweredIds(prev => new Set([...prev, currentQuestion.id]));

    setResponses(data.answers);
    setCommunityResults(prev => ({ ...prev, [currentQuestion.id]: community }));
    setStats(data.stats);
    setPendingSubmit(null);

    // Go straight to next question (no flash of results screen)
    goToNext();
  };

  const handleUndo = () => {
    if (submitTimeoutRef.current) clearTimeout(submitTimeoutRef.current);
    if (graceTimeoutRef.current) clearTimeout(graceTimeoutRef.current);
    setInGracePeriod(false);
    // Restore selection state like vG
    if (pendingSubmit) {
      setTappedAnswer(pendingSubmit.answer);
      setTapCount(pendingSubmit.confidence);
      setJustUndone(true);
    }
    setPendingSubmit(null);
  };

  const clearUndoneState = () => {
    setTappedAnswer(null);
    setTapCount(0);
    setJustUndone(false);
  };

  // Keyboard shortcuts
  useEffect(() => {
    const handleKeyDown = (e) => {
      // Skip if typing in input/textarea
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
      // Skip on non-question screens
      if (screen !== 'question' && screen !== 'qotd') return;

      const key = e.key.toLowerCase();

      // Question screen shortcuts
      if (screen === 'question' && !isAnswered) {
        if (key === 'y' || key === '1') {
          e.preventDefault();
          handleAnswerTap(0);
        } else if (key === 'n' || key === '2') {
          e.preventDefault();
          handleAnswerTap(1);
        } else if (['3', '4', '5'].includes(key) && !isBinary) {
          e.preventDefault();
          handleAnswerTap(parseInt(key) - 1);
        } else if (key === 'escape' && pendingSubmit) {
          e.preventDefault();
          handleUndo();
        }
      }

      // QOTD screen shortcuts
      if (screen === 'qotd' && !qotdResponse) {
        const qotdIsBinary = qotdData?.type === 'binary';
        if (key === 'y' || key === '1') {
          e.preventDefault();
          handleQotdTap(0);
        } else if (key === 'n' || key === '2') {
          e.preventDefault();
          handleQotdTap(1);
        } else if (['3', '4', '5'].includes(key) && !qotdIsBinary) {
          e.preventDefault();
          handleQotdTap(parseInt(key) - 1);
        }
      }

      // Navigation (question screen only)
      if (screen === 'question') {
        if (key === 'arrowright' || key === ' ') {
          e.preventDefault();
          goToNext();
        } else if (key === 'arrowleft') {
          e.preventDefault();
          goToPrev();
        }
      }
    };

    window.addEventListener('keydown', handleKeyDown);
    return () => window.removeEventListener('keydown', handleKeyDown);
  }, [screen, isAnswered, isBinary, pendingSubmit, qotdResponse, qotdData, handleAnswerTap, handleUndo, handleQotdTap, goToNext, goToPrev]);

  // Go to settings, remembering where we came from
  const goToSettings = () => {
    setPreviousScreen(screen);
    setScreen('settings');
  };

  // Question flag handlers
  const handleQuestionFlag = (questionId, flagText) => {
    setQuestionFlags(prev => ({ ...prev, [questionId]: flagText }));
  };

  const handleClearQuestionFlag = (questionId) => {
    setQuestionFlags(prev => {
      const next = { ...prev };
      delete next[questionId];
      return next;
    });
  };

  // Explanation handlers
  const handleSaveExplanation = (questionId, text) => {
    setAnswerExplanations(prev => ({ ...prev, [questionId]: text }));
  };

  const handleClearExplanation = (questionId) => {
    setAnswerExplanations(prev => {
      const next = { ...prev };
      delete next[questionId];
      return next;
    });
  };

  // Category selection with track support
  const handleSelectCategory = (categoryId, track = null) => {
    setSelectedCategory(categoryId);
    setSelectedTrack(track);
    // Find first unanswered in this category+track
    let filtered = categoryId === 'random'
      ? questions
      : questions.filter(q => q.category === categoryId);
    if (track === 'binary') filtered = filtered.filter(q => q.type === 'binary');
    if (track === 'multiple') filtered = filtered.filter(q => q.type === 'multiple');
    const firstUnanswered = filtered.findIndex(q => !responses[q.id]);
    if (firstUnanswered !== -1) {
      const actualIndex = questions.findIndex(q => q.id === filtered[firstUnanswered].id);
      setCurrentIndex(actualIndex);
    }
    setScreen('question');
  };

  const startDemo = () => {
    // Go to category selection screen
    setSelectedCategory(null);
    setTappedAnswer(null);
    setTapCount(0);
    setScreen('categories');
  };

  const resetDemo = () => {
    demoStorage.clear();
    const freshState = getInitialState();
    setResponses(freshState.answers);
    setCommunityResults(generateDemoCommunityResults());
    setStats(freshState.stats);
    setCurrentIndex(0);
    setShowGestureHint(true);
    setQotdResponse(null);
    setQotdTappedAnswer(null);
    setQotdTapCount(0);
    setScreen('launch');
  };

  // ==================== ASSESSMENT FUNCTIONS ====================
  const assessSaveToStorage = (completed, progress, demoActive = assessDemoActive, savedUserData = assessSavedUserData, demoProfile = assessDemoProfile) => {
    localStorage.setItem(ASSESS_STORAGE_KEY, JSON.stringify({ completed, inProgress: progress, demoActive, savedUserData, demoProfile }));
  };

  const assessCurrentTest = assessCurrentTestId ? ASSESS_TESTS[assessCurrentTestId] : null;
  const assessTestColor = assessCurrentTest ? ASSESS_C[assessCurrentTest.color] : null;
  const assessCurrentScale = assessCurrentTest ? ASSESS_SCALES[assessCurrentTest.scale] : null;
  const assessTotalQuestions = assessCurrentTest?.items.length || 0;

  const assessStartTest = (testId) => {
    setAssessCurrentTestId(testId);
    const progress = assessInProgress[testId];
    setAssessCurrentIndex(progress?.index || 0);
    setAssessResponses(progress?.responses || {});
    setAssessSkipped(progress?.skipped || []);
    setAssessPending(null);
    setScreen('assess-question');
  };

  const assessSaveAndExit = () => {
    clearTimeout(assessTimeoutRef.current);
    const newProgress = { ...assessInProgress, [assessCurrentTestId]: { index: assessCurrentIndex, responses: assessResponses, skipped: assessSkipped } };
    setAssessInProgress(newProgress);
    assessSaveToStorage(assessCompleted, newProgress);
    setScreen('assess-picker');
  };

  const assessGoToQuestion = (index, direction) => {
    setAssessCurrentIndex(index);
    setAssessPending(null);
  };

  const assessHandleAnswerTap = (value) => {
    setAssessPending(value);
    clearTimeout(assessTimeoutRef.current);
    assessTimeoutRef.current = setTimeout(() => assessFinalizeSubmit(value), undoDelay * 1000);
  };

  const assessHandleUndo = () => {
    clearTimeout(assessTimeoutRef.current);
    setAssessPending(null);
  };

  const assessFinalizeSubmit = (value) => {
    const newResponses = { ...assessResponses, [assessCurrentIndex]: value };
    setAssessResponses(newResponses);
    const newSkipped = assessSkipped.filter(i => i !== assessCurrentIndex);
    setAssessSkipped(newSkipped);
    setAssessPending(null);
    assessAdvanceToNext(newResponses, newSkipped);
  };

  const assessAdvanceToNext = (resp, skipped) => {
    const total = assessCurrentTest.items.length;
    const answeredCount = Object.keys(resp).length;
    if (answeredCount >= total) { assessCompleteTest(resp); return; }
    for (let i = assessCurrentIndex + 1; i < total; i++) {
      if (resp[i] === undefined) { assessGoToQuestion(i, 'fwd'); return; }
    }
    for (let i = 0; i < assessCurrentIndex; i++) {
      if (resp[i] === undefined) { assessGoToQuestion(i, 'fwd'); return; }
    }
  };

  const assessCanFinish = () => {
    if (!assessCurrentTest) return false;
    return Object.keys(assessResponses).length >= assessCurrentTest.items.length;
  };

  const assessFinishAssessment = () => {
    if (assessCanFinish()) assessCompleteTest(assessResponses);
  };

  const assessCompleteTest = (resp) => {
    const results = calculateAssessResults(assessCurrentTestId, resp);
    const newCompleted = { ...assessCompleted, [assessCurrentTestId]: results };
    setAssessCompleted(newCompleted);
    const { [assessCurrentTestId]: _, ...remainingProgress } = assessInProgress;
    setAssessInProgress(remainingProgress);
    assessSaveToStorage(newCompleted, remainingProgress);
    setAssessShowCompletion(true);
    setTimeout(() => {
      setAssessShowCompletion(false);
      setScreen('assess-results');
    }, 1500);
  };

  const assessLoadDemoProfile = (profileNum) => {
    // Trigger animation
    setAssessProfileSwitching(true);
    setTimeout(() => setAssessProfileSwitching(false), 600);

    // Save current user data before loading demo (only if not already in demo mode)
    const savedData = !assessDemoActive ? {
      completed: { ...assessCompleted },
      inProgress: { ...assessInProgress }
    } : assessSavedUserData;

    if (!assessDemoActive) {
      setAssessSavedUserData(savedData);
    }

    const profile = ASSESS_DEMO_PROFILES[profileNum];
    const skipList = profile.skip || [];
    const newCompleted = {};
    Object.keys(ASSESS_TESTS).forEach(testId => {
      // Skip tests in the skip list
      if (skipList.includes(testId)) return;

      const test = ASSESS_TESTS[testId];
      const answers = {};
      if (test.parent === 'bigfive') {
        // Big Five module - get trait from test.trait
        const traitData = profile.bigfive[test.trait];
        traitData.forEach((val, i) => { answers[i] = val; });
      } else if (test.parent === 'shadow') {
        // Shadow module - get trait from test.trait
        const traitData = profile.shadow[test.trait];
        traitData.forEach((val, i) => { answers[i] = val; });
      } else {
        profile[testId].forEach((val, i) => { answers[i] = val; });
      }
      newCompleted[testId] = calculateAssessResults(testId, answers);
    });
    setAssessCompleted(newCompleted);
    setAssessInProgress({});
    setAssessDemoActive(true);
    setAssessDemoProfile(profileNum);
    assessSaveToStorage(newCompleted, {}, true, savedData, profileNum);
    setAssessShowDemoMenu(false);
  };

  const assessClearDemo = () => {
    // Trigger animation
    setAssessProfileSwitching(true);
    setTimeout(() => setAssessProfileSwitching(false), 600);

    // Restore user data from before demo
    if (assessSavedUserData) {
      setAssessCompleted(assessSavedUserData.completed);
      setAssessInProgress(assessSavedUserData.inProgress);
      assessSaveToStorage(assessSavedUserData.completed, assessSavedUserData.inProgress, false, null, null);
    } else {
      setAssessCompleted({});
      setAssessInProgress({});
      assessSaveToStorage({}, {}, false, null, null);
    }
    setAssessDemoActive(false);
    setAssessDemoProfile(null);
    setAssessSavedUserData(null);
  };

  const assessClearAll = () => {
    setAssessCompleted({});
    setAssessInProgress({});
    setAssessDemoActive(false);
    setAssessSavedUserData(null);
    assessSaveToStorage({}, {}, false, null);
    setAssessShowDemoMenu(false);
  };

  const renderContent = () => {
    if (screen === 'launch') return <LaunchScreen onDemo={startDemo} onLogin={() => {}} darkMode={darkMode} />;
    if (screen === 'settings') return (
      <SettingsScreen
        darkMode={darkMode}
        setDarkMode={setDarkMode}
        undoDelay={undoDelay}
        setUndoDelay={setUndoDelay}
        requireConfirmation={requireConfirmation}
        setRequireConfirmation={setRequireConfirmation}
        showTips={showTips}
        setShowTips={setShowTips}
        showStreak={showStreak}
        setShowStreak={setShowStreak}
        onBack={() => setScreen(previousScreen)}
        onReset={resetDemo}
        onResetAssessments={() => {
          localStorage.removeItem(ASSESS_STORAGE_KEY);
          setAssessCompleted({});
          setAssessInProgress({});
          setAssessResponses({});
          setAssessSkipped([]);
        }}
        hasAssessmentData={Object.keys(assessCompleted).length > 0 || Object.keys(assessInProgress).length > 0}
        onHistory={() => setScreen('history')}
      />
    );

    // Profile screen
    if (screen === 'profile') {
      const answeredList = Object.entries(responses).map(([id, r]) => ({ id: parseInt(id), ...r }));
      const answered = answeredList.length;
      const avgConf = answered > 0 ? (answeredList.reduce((s, r) => s + r.confidence, 0) / answered).toFixed(1) : 'â€”';
      const confDist = [0, 0, 0, 0];
      answeredList.forEach(r => confDist[r.confidence - 1]++);
      const categoryBreakdown = {};
      answeredList.forEach(r => {
        const q = questions.find(q => q.id === r.id);
        if (q) {
          if (!categoryBreakdown[q.category]) categoryBreakdown[q.category] = { count: 0, confDist: [0, 0, 0, 0] };
          categoryBreakdown[q.category].count++;
          categoryBreakdown[q.category].confDist[r.confidence - 1]++;
        }
      });
      return (
        <div className={`flex-1 flex flex-col overflow-hidden ${darkMode ? 'text-white bg-gray-950' : 'text-gray-900 bg-gray-50'}`}>
          <div className={`h-[44px] flex-shrink-0 flex items-center gap-2 px-3 border-b ${TH('border-base', darkMode)}`}>
            <button onClick={() => setScreen('categories')} className={darkMode ? 'text-gray-400' : 'text-gray-500'}>â†</button>
            <span className="font-medium flex-1">Profile</span>
          </div>
          <div className="flex-1 p-4 overflow-y-auto space-y-4">
            <div className="flex items-center gap-3">
              <div className="w-12 h-12 bg-gradient-to-br from-violet-500 to-fuchsia-500 rounded-full flex items-center justify-center font-bold text-lg text-white">D</div>
              <div><h2 className="font-medium">DemoUser</h2></div>
            </div>
            <div className="grid grid-cols-2 gap-2">
              <div className={`rounded-lg p-3 text-center ${TH('bg-card-simple', darkMode)}`}>
                <div className="text-2xl font-bold">{answered}</div>
                <div className="text-sm text-gray-500">Answered</div>
              </div>
              <div className={`rounded-lg p-3 text-center ${TH('bg-card-simple', darkMode)}`}>
                <div className="text-2xl font-bold text-orange-400">ðŸ”¥ {stats.streak}</div>
                <div className="text-sm text-gray-500">Day Streak</div>
              </div>
              <div className={`rounded-lg p-3 text-center ${TH('bg-card-simple', darkMode)}`}>
                <div className="text-2xl font-bold">{avgConf}</div>
                <div className="text-sm text-gray-500">Avg Confidence</div>
              </div>
              <div className={`rounded-lg p-3 text-center ${TH('bg-card-simple', darkMode)}`}>
                <div className={`text-2xl font-bold ${darkMode ? 'text-emerald-400' : 'text-emerald-500'}`}>0</div>
                <div className="text-sm text-gray-500">Task Points</div>
              </div>
            </div>
            {answered > 0 && (
              <div className={`rounded-lg p-3 ${TH('bg-card-shine', darkMode)}`}>
                <div className={`text-sm mb-2 ${TH('text-dim', darkMode)}`}>Confidence Distribution</div>
                <div className="flex items-center gap-4">
                  <div className="relative w-24 h-24 flex-shrink-0">
                    <svg viewBox="0 0 36 36" className="w-full h-full -rotate-90">
                      {(() => {
                        const total = confDist.reduce((a, b) => a + b, 0);
                        const colors = ['#c4b5fd', '#a78bfa', '#8b5cf6', '#6d28d9'];
                        let cumulative = 0;
                        return confDist.map((count, i) => {
                          const pct = total > 0 ? (count / total) * 100 : 0;
                          const offset = cumulative;
                          cumulative += pct;
                          if (pct === 0) return null;
                          return <circle key={i} cx="18" cy="18" r="14" fill="transparent" stroke={colors[i]} strokeWidth="6" strokeDasharray={`${pct} ${100 - pct}`} strokeDashoffset={-offset} />;
                        });
                      })()}
                    </svg>
                    <div className="absolute inset-0 flex flex-col items-center justify-center">
                      <span className="text-lg font-bold">{answered}</span>
                      <span className="text-sm text-gray-500">total</span>
                    </div>
                  </div>
                  <div className="flex-1 space-y-1">
                    {confDist.map((count, i) => {
                      const pct = answered > 0 ? Math.round((count / answered) * 100) : 0;
                      const colors = ['bg-violet-300', 'bg-violet-400', 'bg-violet-500', 'bg-violet-700'];
                      return (
                        <div key={i} className="flex items-center gap-2 text-sm">
                          <div className={`w-3 h-3 rounded-sm ${colors[i]}`} />
                          <span className={`flex-1 ${TH('text-dim', darkMode)}`}>{CONFIDENCE_LABELS[i + 1]}</span>
                          <span className={darkMode ? 'text-gray-500' : 'text-gray-600'}>{count}</span>
                          <span className={`w-8 text-right ${TH('text-faint', darkMode)}`}>{pct}%</span>
                        </div>
                      );
                    })}
                  </div>
                </div>
              </div>
            )}
            {Object.keys(categoryBreakdown).length > 0 && (
              <div className={`rounded-lg p-3 ${TH('bg-card-shine', darkMode)}`}>
                <div className={`text-sm mb-2 ${TH('text-dim', darkMode)}`}>By Category</div>
                <div className="space-y-2">
                  {CATEGORIES.filter(c => categoryBreakdown[c.id]).map(cat => {
                    const { count, confDist: catConf } = categoryBreakdown[cat.id];
                    const total = questions.filter(q => q.category === cat.id).length;
                    const pct = Math.round((count / total) * 100);
                    const colors = ['#c4b5fd', '#a78bfa', '#8b5cf6', '#6d28d9'];
                    return (
                      <div key={cat.id} className="flex items-center gap-2">
                        <span className="text-sm w-5">{cat.icon}</span>
                        <div className={`flex-1 h-3 rounded-full overflow-hidden flex ${darkMode ? 'bg-gray-800' : 'bg-gray-100'}`}>
                          {catConf.map((c, i) => {
                            const segPct = count > 0 ? (c / count) * pct : 0;
                            if (segPct === 0) return null;
                            return <div key={i} className="h-full" style={{ width: `${segPct}%`, background: colors[i] }} />;
                          })}
                        </div>
                        <span className="text-sm text-gray-500 w-8 text-right">{count}</span>
                      </div>
                    );
                  })}
                </div>
              </div>
            )}
            <div className={`rounded-lg p-3 ${darkMode ? 'bg-gray-900/50 border border-gray-800' : 'bg-white border border-gray-300'}`}>
              <div className={`text-sm mb-2 ${TH('text-dim', darkMode)}`}>Coming Soon</div>
              <div className="space-y-1.5 text-sm text-gray-500">
                <div className="flex items-center gap-2"><span className="text-amber-400">â—†</span><span>Accuracy tracking & calibration</span></div>
                <div className="flex items-center gap-2"><span className="text-amber-400">â—†</span><span>Leaderboard position</span></div>
                <div className="flex items-center gap-2"><span className="text-amber-400">â—†</span><span>Prediction resolution history</span></div>
              </div>
            </div>
          </div>
        </div>
      );
    }

    // History screen
    if (screen === 'history') {
      const answeredQuestions = questions
        .filter(q => responses[q.id])
        .map(q => ({ ...q, response: responses[q.id], community: communityResults[q.id] }))
        .sort((a, b) => (b.response.timestamp || 0) - (a.response.timestamp || 0));
      const filteredQuestions = answeredQuestions.filter(q => {
        if (historyFilter === 'all') return true;
        if (historyFilter === 'binary') return q.type === 'binary';
        if (historyFilter === 'multiple') return q.type === 'multiple';
        if (historyFilter === 'flagged') return questionFlags[q.id] || answerExplanations[q.id];
        return q.category === historyFilter;
      });
      const getAnswerLabel = (q) => {
        if (q.type === 'binary') return q.response.answer === 0 ? 'YES' : 'NO';
        return q.options?.[q.response.answer] || '?';
      };
      return (
        <div className={`flex-1 flex flex-col ${darkMode ? 'text-white bg-gray-950' : 'text-gray-900 bg-gray-50'}`}>
          <div className={`h-[44px] flex-shrink-0 flex items-center gap-2 px-3 border-b ${TH('border-base', darkMode)}`}>
            <button onClick={() => setScreen('settings')} className={darkMode ? 'text-gray-400' : 'text-gray-500'}>â†</button>
            <span className="font-medium flex-1">History</span>
            <span className={`text-sm ${darkMode ? 'text-gray-500' : 'text-gray-500'}`}>{answeredQuestions.length} answered</span>
          </div>
          <div className="flex gap-1 p-2 overflow-x-auto">
            {[{ id: 'all', label: 'All' }, { id: 'binary', label: 'Y/N' }, { id: 'multiple', label: 'MC' }, { id: 'flagged', label: 'âš‘' }, ...CATEGORIES.map(c => ({ id: c.id, label: c.icon }))].map(f => (
              <button key={f.id} onClick={() => setHistoryFilter(f.id)}
                className={`px-2.5 py-1 rounded-lg text-sm whitespace-nowrap transition-colors ${historyFilter === f.id ? 'bg-violet-600 text-white' : darkMode ? 'bg-gray-800 text-gray-400' : 'bg-white text-gray-600 border border-gray-200'}`}>
                {f.label}
              </button>
            ))}
          </div>
          <div className="flex-1 overflow-y-auto p-2 space-y-1">
            {filteredQuestions.length === 0 ? (
              <div className="flex-1 flex flex-col items-center justify-center text-center py-8">
                <div className="text-3xl mb-2">ðŸ“‹</div>
                <p className="text-gray-500 text-sm">No questions match this filter</p>
              </div>
            ) : filteredQuestions.map(q => {
              const catInfo = CATEGORIES.find(c => c.id === q.category);
              const isExpanded = evidenceExpanded === `history-${q.id}`;
              return (
                <div key={q.id} className={`rounded-lg p-3 ${TH('bg-card-simple', darkMode)}`}>
                  <div className="flex items-start gap-2">
                    <span className="text-sm">{catInfo?.icon || 'â—†'}</span>
                    <div className="flex-1 min-w-0">
                      <p className={`text-sm leading-snug line-clamp-2 ${darkMode ? 'text-gray-200' : 'text-gray-800'}`}>{q.text}</p>
                      <div className="flex items-center gap-2 mt-1.5">
                        <span className={`text-sm font-medium ${q.type === 'binary' ? (q.response.answer === 0 ? (darkMode ? 'text-emerald-400' : 'text-emerald-600') : (darkMode ? 'text-rose-400' : 'text-rose-600')) : (darkMode ? 'text-violet-400' : 'text-violet-600')}`}>
                          {getAnswerLabel(q)}
                        </span>
                        <ConfidenceDots level={q.response.confidence} />
                        <span className="text-sm text-gray-500">{CONFIDENCE_LABELS[q.response.confidence]}</span>
                        {questionFlags[q.id] && <span className="text-sm text-rose-400">âš‘</span>}
                        {answerExplanations[q.id] && <span className="text-sm text-amber-400">âœŽ</span>}
                      </div>
                    </div>
                  </div>
                  {q.community && (
                    <button onClick={() => setEvidenceExpanded(isExpanded ? null : `history-${q.id}`)} className="w-full mt-2 text-left">
                      <div className={`flex items-center justify-between text-sm ${darkMode ? 'text-gray-600' : 'text-gray-500'}`}>
                        <span>{q.community.evaluators?.length || 0} responses</span>
                        <span>{isExpanded ? 'â–²' : 'â–¼'}</span>
                      </div>
                      {isExpanded && (
                        <div className="mt-2">
                          {q.type === 'binary' ? <BinaryChart evaluators={q.community.evaluators} userResponse={q.response} darkMode={darkMode} /> : <MultipleChoiceChart evaluators={q.community.evaluators} userResponse={q.response} options={q.options} darkMode={darkMode} />}
                        </div>
                      )}
                    </button>
                  )}
                </div>
              );
            })}
          </div>
        </div>
      );
    }

    // Question of the Day screen - uses SAME components as regular Q&A, just with blue glow
    if (screen === 'qotd') {
      // Convert QOD data to question-like format for reusing components
      const qotdQuestion = {
        id: qotdData.id,
        text: qotdData.text,
        type: qotdData.type,
        category: 'qotd',
        options: qotdData.options || []
      };
      const qotdCommunityResults = qotdDistributionToEvaluators(qotdData);
      const isBinary = qotdData.type === 'binary';
      const hasAnswered = qotdResponse !== null;

      // Blue glow style - pronounced
      const blueGlowStyle = {
        background: darkMode
          ? 'radial-gradient(ellipse at center top, rgba(59, 130, 246, 0.25) 0%, rgba(59, 130, 246, 0.12) 35%, rgba(59, 130, 246, 0.04) 60%, transparent 80%), #030712'
          : 'radial-gradient(ellipse at center top, rgba(59, 130, 246, 0.2) 0%, rgba(59, 130, 246, 0.08) 35%, rgba(59, 130, 246, 0.02) 60%, transparent 80%), #f9fafb'
      };

      // Go to first unanswered question in regular Q&A
      const goToQuestions = () => {
        const firstUnanswered = questions.findIndex(q => !responses[q.id]);
        if (firstUnanswered >= 0) {
          setCurrentIndex(firstUnanswered);
          setScreen('questions');
        } else {
          setScreen('categories');
        }
      };

      return (
        <div className="flex-1 flex flex-col overflow-hidden relative" style={blueGlowStyle}>
          {/* Navigation Bar */}
          <div className={`h-[36px] flex-shrink-0 flex items-center gap-2 px-3 ${darkMode ? 'bg-gray-900/50' : 'bg-white/80 border-b border-gray-200'}`}>
            <button onClick={() => setScreen('categories')} className={`text-xl font-bold w-8 h-8 flex items-center justify-center ${TH('btn-ghost', darkMode)}`}>â—€</button>
            <div className={`flex-1 h-2 rounded-full overflow-hidden ${darkMode ? 'bg-gray-800' : 'bg-gray-300'}`}>
              <div className="h-full bg-blue-500 transition-all duration-300" style={{ width: hasAnswered ? '100%' : '0%' }} />
            </div>
            <button onClick={goToQuestions} className={`text-xl font-bold w-8 h-8 flex items-center justify-center ${TH('btn-ghost', darkMode)}`}>â–¶</button>
          </div>

          {/* QOD badge row */}
          <div className={`h-[28px] flex-shrink-0 flex items-center justify-center gap-2 ${darkMode ? 'bg-blue-900/20' : 'bg-blue-50'}`}>
            <span className="text-sm">â˜€ï¸</span>
            <span className={`text-sm font-medium ${darkMode ? 'text-blue-400' : 'text-blue-600'}`}>Question of the Day</span>
            <span className={`text-sm ${darkMode ? 'text-gray-500' : 'text-gray-500'}`}>Day {qotdData.day} Â· {getQotdTimeRemaining()}</span>
            {!hasAnswered && <span className="text-amber-500 text-sm font-medium">+{qotdData.reward}</span>}
          </div>

          {/* ANSWERED VIEW - tap anywhere to return to menu */}
          {hasAnswered ? (
            <div className="flex-1 flex flex-col overflow-y-auto px-4 py-3 cursor-pointer" onClick={() => setScreen('categories')}>
              {/* Question */}
              <h2 className={`question-text text-center font-medium mb-4 ${TH('text-primary', darkMode)}`}>{qotdData.text}</h2>

              {/* Your answer summary - same as regular results */}
              <div className={`p-3 rounded-lg mb-4 ${TH('bg-overlay', darkMode)}`}>
                <div className={`text-sm text-center ${TH('text-muted', darkMode)}`}>
                  Your answer: <span className={`font-bold ${isBinary ? (qotdResponse.answer === 0 ? 'text-emerald-400' : 'text-rose-400') : ''}`} style={!isBinary ? { color: MC_COLORS[qotdResponse.answer % MC_COLORS.length].hex } : undefined}>
                    {CONFIDENCE_LABELS[qotdResponse.confidence]} {isBinary ? (qotdResponse.answer === 0 ? 'Yes' : 'No') : qotdData.options?.[qotdResponse.answer]}
                  </span>
                </div>
              </div>

              {/* Community Results - uses shared component */}
              <div className={`rounded-lg p-3 ${TH('bg-card-shine', darkMode)}`}>
                <div className="flex items-center gap-2 mb-2">
                  <span className={`text-sm font-medium ${TH('text-secondary', darkMode)}`}>Community Results</span>
                  <span className={`text-xs ${TH('text-subtle', darkMode)}`}>{qotdCommunityResults.evaluators.length.toLocaleString()} responses</span>
                </div>
                <CommunityResultsRows
                  question={qotdQuestion}
                  results={qotdCommunityResults}
                  userResponse={qotdResponse}
                  darkMode={darkMode}
                  options={qotdData.options}
                />
              </div>

              {/* Sponsor */}
              <div className={`flex items-center justify-center gap-2 mt-4 p-2 rounded-lg ${darkMode ? 'bg-gray-900/30' : 'bg-gray-50'}`}>
                <span className="text-sm">{qotdData.sponsor.avatar}</span>
                <span className={`text-sm ${darkMode ? 'text-gray-600' : 'text-gray-500'}`}>Sponsored by {qotdData.sponsor.name}</span>
              </div>
            </div>
          ) : (
            <>
              {/* UNANSWERED VIEW - same layout as regular Q&A */}
              <div className="flex-1 flex flex-col justify-center px-4 pb-3 overflow-y-auto">
                <QuestionCard question={qotdQuestion} darkMode={darkMode} evidenceExpanded={false} onToggleEvidence={() => {}} />
                {/* Sponsor under question */}
                <div className={`flex items-center justify-center gap-2 mt-3 ${darkMode ? 'text-gray-600' : 'text-gray-500'}`}>
                  <span className="text-sm">{qotdData.sponsor.avatar}</span>
                  <span className="text-sm">Sponsored by {qotdData.sponsor.name}</span>
                </div>
              </div>

              {/* Fixed Bottom - SAME answer buttons as regular Q&A */}
              <div className={`flex-shrink-0 border-t ${darkMode ? 'border-gray-800 bg-gray-950/80' : 'border-gray-200 bg-white/80'}`}>
                <div className={`px-4 pt-3 ${isBinary ? 'h-[93px]' : ''}`}>
                  {isBinary ? (
                    <BinaryButtons
                      darkMode={darkMode}
                      tappedAnswer={qotdTappedAnswer}
                      tapCount={qotdTapCount}
                      isAnswered={false}
                      currentResponse={null}
                      onTap={handleQotdTap}
                      onRightClick={() => {}}
                      pendingSubmit={null}
                      requireConfirmation={true}
                      onSubmit={submitQotdAnswer}
                      onClear={() => { setQotdTappedAnswer(null); setQotdTapCount(0); }}
                    />
                  ) : (
                    <MCButtons
                      options={qotdData.options || []}
                      darkMode={darkMode}
                      tappedAnswer={qotdTappedAnswer}
                      tapCount={qotdTapCount}
                      isAnswered={false}
                      currentResponse={null}
                      onTap={handleQotdTap}
                      onRightClick={() => {}}
                      pendingSubmit={null}
                      requireConfirmation={true}
                      onSubmit={submitQotdAnswer}
                      onClear={() => { setQotdTappedAnswer(null); setQotdTapCount(0); }}
                    />
                  )}
                </div>

                {/* Bottom spacer */}
                <div className="h-[40px]" />
              </div>
            </>
          )}
        </div>
      );
    }

    // ==================== ASSESSMENT SCREENS ====================
    // Assessment Picker Screen
    if (screen === 'assess-picker') {
      // AssessmentCircle component for picker - uses shared ProgressCircle
      const AssessmentCircle = ({ testId, test }) => {
        const isCompleted = assessCompleted[testId];
        const progress = assessInProgress[testId];
        const progressPct = isCompleted ? 100 : progress ? Math.round((Object.keys(progress.responses || {}).length / test.items.length) * 100) : 0;
        return (
          <ProgressCircle
            progress={progressPct}
            size={64}
            strokeWidth={4}
            color={test.color}
            icon={test.icon}
            gradientId={`picker-grad-${testId}`}
            darkMode={darkMode}
            iconSize="text-2xl"
          />
        );
      };

      return (
        <div className={`h-full flex flex-col ${TH('bg-main', darkMode)}`}>
          {/* Demo Menu Overlay */}
          {assessShowDemoMenu && (
            <div className="absolute inset-0 z-50 flex items-center justify-center bg-black/80" onClick={() => setAssessShowDemoMenu(false)}>
              <div className={`mx-4 p-4 rounded-2xl ${darkMode ? 'bg-gray-900 border border-gray-700' : 'bg-white'}`} onClick={e => e.stopPropagation()}>
                <div className={`text-center mb-4 ${TH('text-primary', darkMode)}`}>
                  <div className="text-lg font-semibold">{assessDemoActive ? 'Switch Profile' : 'Load Demo Profile'}</div>
                  <div className={`text-xs mt-1 ${TH('text-subtle', darkMode)}`}>
                    {assessDemoActive ? 'Your data is saved in the background' : 'See how different personalities score'}
                  </div>
                </div>
                <div className="space-y-2">
                  {/* Back to My Data option - only show if demo active and user has saved data */}
                  {assessDemoActive && assessSavedUserData && (
                    <button onClick={() => { assessClearDemo(); setAssessShowDemoMenu(false); }} className={`w-full p-3 rounded-xl text-left flex items-center gap-3 ${darkMode ? 'bg-blue-900/30 border border-blue-500/30 hover:bg-blue-900/50' : 'bg-blue-50 border border-blue-200 hover:bg-blue-100'}`}>
                      <div className="w-10 h-10 rounded-full flex items-center justify-center text-lg bg-blue-600 text-white">ðŸ‘¤</div>
                      <div className="flex-1"><div className={`font-medium ${darkMode ? 'text-blue-300' : 'text-blue-700'}`}>Back to My Data</div><div className={`text-xs ${darkMode ? 'text-blue-400/70' : 'text-blue-600'}`}>Restore your saved answers</div></div>
                    </button>
                  )}
                  {Object.entries(ASSESS_DEMO_PROFILES).map(([num, profile]) => {
                    const profColors = { violet: 'bg-violet-600', teal: 'bg-teal-600', amber: 'bg-amber-500', emerald: 'bg-emerald-600', blue: 'bg-blue-600', pink: 'bg-pink-600' };
                    return (
                      <button key={num} onClick={() => assessLoadDemoProfile(Number(num))} className={`w-full p-3 rounded-xl text-left flex items-center gap-3 ${darkMode ? 'bg-gray-800 hover:bg-gray-700' : 'bg-gray-100 hover:bg-gray-200'}`}>
                        <div className={`w-10 h-10 rounded-full flex items-center justify-center text-lg font-bold text-white ${profColors[profile.color] || 'bg-violet-600'}`}>{num}</div>
                        <div className="flex-1"><div className={`font-medium ${TH('text-primary', darkMode)}`}>{profile.name}</div><div className={`text-xs ${TH('text-dim', darkMode)}`}>{profile.desc}</div></div>
                      </button>
                    );
                  })}
                </div>
                <div className="flex gap-2 mt-3">
                  <button onClick={assessClearAll} className={`flex-1 py-2 text-sm rounded-lg ${darkMode ? 'bg-red-900/30 text-red-400 hover:bg-red-900/50' : 'bg-red-100 text-red-600 hover:bg-red-200'}`}>Clear All Data</button>
                  <button onClick={() => setAssessShowDemoMenu(false)} className={`flex-1 py-2 text-sm ${TH('text-subtle', darkMode)}`}>Cancel</button>
                </div>
              </div>
            </div>
          )}
          <div className={`h-[44px] flex-shrink-0 flex items-center gap-3 px-4 border-b ${TH('border-base', darkMode)}`}>
            <button onClick={() => setScreen('categories')} className={darkMode ? 'text-gray-400' : 'text-gray-500'}>â†</button>
            <span className="text-2xl cursor-pointer select-none" onDoubleClick={assessClearDemo}>ðŸªž</span>
            <span className={`font-semibold flex-1 ${TH('text-primary', darkMode)}`}>Reveal</span>
            <button onClick={() => setScreen('assess-analysis')} className={`px-3 py-1.5 rounded-full text-sm font-medium ${Object.keys(assessCompleted).length > 0 ? 'bg-violet-600 text-white' : (darkMode ? 'bg-gray-800 text-gray-500' : 'bg-gray-200 text-gray-400')}`}>Analysis</button>
          </div>
          {/* Profile Selector */}
          <div className="px-4 py-1.5">
            <div className="flex items-center justify-center gap-2">
              {/* Me button */}
              <button onClick={assessClearDemo}
                className={`px-3 py-1 rounded-full text-xs font-medium transition-all ${
                  !assessDemoActive
                    ? 'bg-blue-500 text-white shadow-lg shadow-blue-500/30'
                    : (darkMode ? 'bg-blue-900/30 text-blue-400/60 hover:bg-blue-900/50' : 'bg-blue-100 text-blue-400 hover:bg-blue-200')
                }`}>
                Me
              </button>
              {/* Separator */}
              <div className={`h-5 w-px ${darkMode ? 'bg-gray-700' : 'bg-gray-300'}`} />
              {/* Demo label */}
              <div className="flex items-center gap-1">
                <span className={`text-[10px] uppercase tracking-wide ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>Demo</span>
                <button onClick={() => setAssessShowDemoInfo(!assessShowDemoInfo)}
                  className={`text-[10px] transition-all ${assessShowDemoInfo ? (darkMode ? 'text-gray-300' : 'text-gray-600') : (darkMode ? 'text-gray-500 hover:text-gray-400' : 'text-gray-400 hover:text-gray-500')}`}>
                  â“˜
                </button>
              </div>
              {/* Character pills */}
              {Object.entries(ASSESS_DEMO_PROFILES).map(([num, profile]) => {
                const isActive = assessDemoActive && assessDemoProfile === Number(num);
                const colorMap = {
                  violet: { active: 'bg-violet-500 text-white shadow-lg shadow-violet-500/30', dim: darkMode ? 'bg-violet-900/30 text-violet-400/60 hover:bg-violet-900/50' : 'bg-violet-100 text-violet-400 hover:bg-violet-200' },
                  teal: { active: 'bg-teal-500 text-white shadow-lg shadow-teal-500/30', dim: darkMode ? 'bg-teal-900/30 text-teal-400/60 hover:bg-teal-900/50' : 'bg-teal-100 text-teal-400 hover:bg-teal-200' },
                  pink: { active: 'bg-fuchsia-500 text-white shadow-lg shadow-fuchsia-500/30', dim: darkMode ? 'bg-fuchsia-900/30 text-fuchsia-400/60 hover:bg-fuchsia-900/50' : 'bg-fuchsia-100 text-fuchsia-400 hover:bg-fuchsia-200' },
                };
                const colors = colorMap[profile.color] || colorMap.violet;
                return (
                  <button key={num} onClick={() => assessLoadDemoProfile(Number(num))}
                    className={`px-2.5 py-1 rounded-full text-xs font-medium transition-all ${isActive ? colors.active : colors.dim}`}>
                    {profile.name}
                  </button>
                );
              })}
            </div>
            {/* Expandable demo info */}
            {assessShowDemoInfo && (
              <div className={`mt-2 p-2 rounded-lg text-xs space-y-1 ${darkMode ? 'bg-gray-800/50' : 'bg-gray-100'}`}>
                {Object.entries(ASSESS_DEMO_PROFILES).map(([num, profile]) => {
                  const colorMap = { violet: 'text-violet-400', teal: 'text-teal-400', pink: 'text-fuchsia-400' };
                  return (
                    <div key={num} className="flex items-center gap-2">
                      <span className={`font-medium ${colorMap[profile.color]}`}>{profile.name}:</span>
                      <span className={darkMode ? 'text-gray-400' : 'text-gray-600'}>{profile.desc}</span>
                    </div>
                  );
                })}
              </div>
            )}
          </div>
          <div className="flex-1 overflow-auto p-4 pb-24 space-y-3 hide-scrollbar">
            {/* Category-based view with glowing circles */}
            {Object.entries(ASSESS_CATEGORIES).map(([catId, cat]) => {
              const catTests = cat.tests.map(id => [id, ASSESS_TESTS[id]]);
              const totalQuestions = catTests.reduce((sum, [_, t]) => sum + t.items.length, 0);
              const answeredQuestions = catTests.reduce((sum, [id, t]) => {
                if (assessCompleted[id]) return sum + t.items.length;
                const prog = assessInProgress[id];
                return sum + (prog ? Object.keys(prog.responses || {}).length : 0);
              }, 0);
              const remainingQuestions = totalQuestions - answeredQuestions;
              const progressPct = (answeredQuestions / totalQuestions) * 100;
              const allComplete = remainingQuestions === 0;
              const isExpanded = assessExpandedCategory === catId;
              const colors = ASSESS_C[cat.color];
              const hasModules = catTests.length > 1;
              // For multi-module: count incomplete modules
              const remainingModules = catTests.filter(([id]) => !assessCompleted[id]).length;

              // For single-test categories, go directly to test (no chevron)
              if (!hasModules) {
                const [testId, test] = catTests[0];
                const isCompleted = assessCompleted[testId];
                return (
                  <button key={catId} onClick={() => isCompleted ? (setAssessCurrentTestId(testId), setScreen('assess-results')) : assessStartTest(testId)} className={`w-full p-4 rounded-2xl ${TH('bg-card', darkMode)} flex items-center gap-4`}>
                    <ProgressCircle
                      progress={progressPct}
                      size={56}
                      strokeWidth={4}
                      color={cat.color}
                      text={allComplete ? 'âœ“' : remainingQuestions}
                      gradientId={`cat-${catId}`}
                      darkMode={darkMode}
                      textSize={allComplete ? 'text-lg' : 'text-base'}
                      orbit={assessProfileSwitching}
                    />
                    <div className="flex-1 text-left">
                      <div className={`font-semibold ${TH('text-primary', darkMode)}`}>{cat.name}</div>
                      <div className={`text-sm ${colors.text}`}>
                        {allComplete ? 'Complete' : progressPct > 0 ? `${remainingQuestions} left` : `${remainingQuestions} questions`}
                      </div>
                    </div>
                  </button>
                );
              }

              // Multi-test categories: [Aggregate Ring] [Text] [Module Circles] [Chevron]
              const handleCatToggle = () => {
                const wasExpanded = isExpanded;
                setAssessExpandedCategory(wasExpanded ? null : catId);
                if (!wasExpanded) {
                  setTimeout(() => document.getElementById(`cat-${catId}`)?.scrollIntoView({ behavior: 'smooth', block: 'nearest' }), 50);
                }
              };
              return (
                <div key={catId} id={`cat-${catId}`} className={`rounded-2xl overflow-hidden ${TH('bg-card', darkMode)}`}>
                  <button onClick={handleCatToggle} className={`w-full p-4 text-left flex items-center gap-3`}>
                    {/* Aggregate progress ring */}
                    <ProgressCircle
                      progress={progressPct}
                      size={52}
                      strokeWidth={4}
                      color={cat.color}
                      text={allComplete ? 'âœ“' : remainingModules}
                      orbit={assessProfileSwitching}
                      gradientId={`cat-${catId}`}
                      darkMode={darkMode}
                      textSize={allComplete ? 'text-base' : 'text-sm'}
                    />
                    {/* Text */}
                    <div className="flex-1 min-w-0">
                      <div className={`font-semibold ${TH('text-primary', darkMode)}`}>{cat.name}</div>
                      <div className={`text-sm ${colors.text}`}>
                        {allComplete ? 'Complete' : progressPct > 0 ? `${remainingModules} left` : `${remainingModules} modules`}
                      </div>
                    </div>
                    {/* Module circles */}
                    <div className="flex gap-1 items-center">
                      {catTests.map(([id, test]) => {
                        const modCompleted = assessCompleted[id];
                        const modProgress = assessInProgress[id];
                        const modAnswered = modCompleted ? test.items.length : modProgress ? Object.keys(modProgress.responses || {}).length : 0;
                        const modPct = (modAnswered / test.items.length) * 100;
                        return (
                          <ProgressCircle
                            key={id}
                            progress={modPct}
                            size={28}
                            strokeWidth={2}
                            color={cat.color}
                            icon={test.icon}
                            gradientId={`mod-ring-${id}`}
                            darkMode={darkMode}
                            iconSize="text-xs"
                            glow={false}
                          />
                        );
                      })}
                    </div>
                    <span className={`transition-transform ${isExpanded ? 'rotate-90' : ''} ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>â€º</span>
                  </button>
                  {/* Expanded module list */}
                  {isExpanded && (
                    <div className={`divide-y ${darkMode ? 'divide-gray-800/50' : 'divide-gray-200'} border-t ${darkMode ? 'border-gray-800/50' : 'border-gray-200'}`}>
                      {catTests.map(([id, test]) => {
                        const isCompleted = assessCompleted[id];
                        const progress = assessInProgress[id];
                        const answered = isCompleted ? test.items.length : progress ? Object.keys(progress.responses || {}).length : 0;
                        const remaining = test.items.length - answered;
                        const modProgressPct = (answered / test.items.length) * 100;
                        return (
                          <button key={id} onClick={() => isCompleted ? (setAssessCurrentTestId(id), setScreen('assess-results')) : assessStartTest(id)} className={`w-full p-3 text-left flex items-center gap-3 ${darkMode ? 'hover:bg-gray-800/50' : 'hover:bg-gray-50'}`}>
                            <ProgressCircle
                              progress={modProgressPct}
                              size={40}
                              strokeWidth={3}
                              color={cat.color}
                              text={isCompleted ? 'âœ“' : remaining}
                              gradientId={`mod-${id}`}
                              darkMode={darkMode}
                              textSize={isCompleted ? 'text-sm' : 'text-xs'}
                            />
                            <div className="flex-1 min-w-0">
                              <div className={`font-medium text-sm ${TH('text-primary', darkMode)}`}>{test.name}</div>
                              <div className={`text-xs ${TH('text-subtle', darkMode)}`}>{test.description}</div>
                            </div>
                            <span className={darkMode ? 'text-gray-600' : 'text-gray-400'}>â€º</span>
                          </button>
                        );
                      })}
                    </div>
                  )}
                </div>
              );
            })}
          </div>
        </div>
      );
    }

    // Assessment Question Screen
    if (screen === 'assess-question') {
      if (!assessCurrentTest) return null;
      const currentItem = assessCurrentTest.items[assessCurrentIndex];
      const segments = [];
      for (let i = 0; i < assessTotalQuestions; i++) {
        segments.push({
          isAnswered: assessResponses[i] !== undefined,
          isSkipped: assessSkipped.includes(i) && assessResponses[i] === undefined,
          isCurrent: i === assessCurrentIndex
        });
      }
      const gradientStyles = {
        violet: ['bg-violet-950/30 border-violet-800/40', 'bg-violet-950/50 border-violet-700/50', 'bg-violet-900/40 border-violet-600/50', 'bg-violet-900/60 border-violet-500/60', 'bg-violet-800/70 border-violet-400/70'],
        blue: ['bg-blue-950/30 border-blue-800/40', 'bg-blue-950/50 border-blue-700/50', 'bg-blue-900/40 border-blue-600/50', 'bg-blue-900/60 border-blue-500/60', 'bg-blue-800/70 border-blue-400/70'],
        teal: ['bg-teal-950/30 border-teal-800/40', 'bg-teal-950/50 border-teal-700/50', 'bg-teal-900/40 border-teal-600/50', 'bg-teal-900/60 border-teal-500/60', 'bg-teal-800/70 border-teal-400/70'],
        rose: ['bg-rose-950/30 border-rose-800/40', 'bg-rose-950/50 border-rose-700/50', 'bg-rose-900/40 border-rose-600/50', 'bg-rose-900/60 border-rose-500/60', 'bg-rose-800/70 border-rose-400/70'],
        pink: ['bg-fuchsia-950/30 border-fuchsia-800/40', 'bg-fuchsia-950/50 border-fuchsia-700/50', 'bg-fuchsia-900/40 border-fuchsia-600/50', 'bg-fuchsia-900/60 border-fuchsia-500/60', 'bg-fuchsia-800/70 border-fuchsia-400/70'],
        emerald: ['bg-emerald-950/30 border-emerald-800/40', 'bg-emerald-950/50 border-emerald-700/50', 'bg-emerald-900/40 border-emerald-600/50', 'bg-emerald-900/60 border-emerald-500/60', 'bg-emerald-800/70 border-emerald-400/70'],
        slate: ['bg-slate-950/30 border-slate-800/40', 'bg-slate-950/50 border-slate-700/50', 'bg-slate-900/40 border-slate-600/50', 'bg-slate-900/60 border-slate-500/60', 'bg-slate-800/70 border-slate-400/70'],
        amber: ['bg-amber-950/30 border-amber-800/40', 'bg-amber-950/50 border-amber-700/50', 'bg-amber-900/40 border-amber-600/50', 'bg-amber-900/60 border-amber-500/60', 'bg-amber-800/70 border-amber-400/70'],
      };
      const selectedStyles = { violet: 'bg-violet-600 ring-violet-400 border-violet-400', blue: 'bg-blue-600 ring-blue-400 border-blue-400', teal: 'bg-teal-600 ring-teal-400 border-teal-400', rose: 'bg-rose-600 ring-rose-400 border-rose-400', pink: 'bg-fuchsia-600 ring-fuchsia-400 border-fuchsia-400', emerald: 'bg-emerald-600 ring-emerald-400 border-emerald-400', slate: 'bg-slate-600 ring-slate-400 border-slate-400', amber: 'bg-amber-600 ring-amber-400 border-amber-400' };
      const pendingStyles = { violet: 'bg-violet-600 border-violet-400', blue: 'bg-blue-600 border-blue-400', teal: 'bg-teal-600 border-teal-400', rose: 'bg-rose-600 border-rose-400', pink: 'bg-fuchsia-600 border-fuchsia-400', emerald: 'bg-emerald-600 border-emerald-400', slate: 'bg-slate-600 border-slate-400', amber: 'bg-amber-600 border-amber-400' };
      const numColors = { violet: 'text-violet-400/70', blue: 'text-blue-400/70', teal: 'text-teal-400/70', rose: 'text-rose-400/70', pink: 'text-fuchsia-400/70', emerald: 'text-emerald-400/70', slate: 'text-slate-400/70', amber: 'text-amber-400/70' };

      return (
        <div className={`h-full flex flex-col ${TH('bg-main', darkMode)}`} {...assessSwipeHandlers}>
          {/* Completion Celebration */}
          {assessShowCompletion && (
            <div className="absolute inset-0 z-50 flex items-center justify-center bg-gray-950/95">
              <div className="relative">
                <div className="absolute inset-0 rounded-full blur-3xl opacity-60 celebrate-glow" style={{ background: `linear-gradient(135deg, ${assessTestColor.bg.includes('violet') ? '#8b5cf6' : assessTestColor.bg.includes('blue') ? '#3b82f6' : assessTestColor.bg.includes('teal') ? '#14b8a6' : assessTestColor.bg.includes('pink') ? '#ec4899' : assessTestColor.bg.includes('rose') ? '#f43f5e' : '#10b981'}, transparent)`, width: '200px', height: '200px', marginLeft: '-50px', marginTop: '-50px' }} />
                <svg width="140" height="140" className="celebrate-ring"><circle cx="70" cy="70" r="60" fill="none" stroke="url(#complete-grad)" strokeWidth="6" strokeLinecap="round" strokeDasharray="377" /><defs><linearGradient id="complete-grad" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stopColor="#8b5cf6" /><stop offset="100%" stopColor="#10b981" /></linearGradient></defs></svg>
                <div className="absolute inset-0 flex items-center justify-center celebrate-pulse"><span className="text-5xl">{assessCurrentTest.icon}</span></div>
              </div>
              <div className="absolute bottom-1/3 text-center"><div className="text-white text-xl font-semibold">Complete!</div><div className="text-gray-400 text-sm mt-1">Calculating your results...</div></div>
            </div>
          )}
          {/* Exit Confirmation Popup */}
          {assessShowExitConfirm && (
            <div className="absolute inset-0 z-50 flex items-center justify-center bg-black/80" onClick={() => setAssessShowExitConfirm(false)}>
              <div className={`mx-6 p-5 rounded-2xl ${darkMode ? 'bg-gray-900 border border-gray-700' : 'bg-white'}`} onClick={e => e.stopPropagation()}>
                <div className={`text-center mb-4 ${TH('text-primary', darkMode)}`}>
                  <div className="text-lg font-semibold">Exit Assessment?</div>
                  <div className={`text-sm mt-2 ${TH('text-subtle', darkMode)}`}>Your answers will not be saved.</div>
                </div>
                <div className="flex gap-3">
                  <button onClick={() => { setAssessShowExitConfirm(false); assessSaveAndExit(); }} className={`flex-1 py-3 rounded-xl font-medium ${darkMode ? 'bg-violet-600 text-white' : 'bg-violet-600 text-white'}`}>Save</button>
                  <button onClick={() => { setAssessShowExitConfirm(false); clearTimeout(assessTimeoutRef.current); setAssessPending(null); setScreen('assess-picker'); }} className={`flex-1 py-3 rounded-xl font-medium ${darkMode ? 'bg-red-600 text-white' : 'bg-red-500 text-white'}`}>Exit</button>
                </div>
              </div>
            </div>
          )}
          {/* Navigation Bar */}
          <div className={`h-[44px] flex-shrink-0 flex items-center gap-2 px-3 border-b ${TH('border-base', darkMode)}`}>
            {assessCanFinish() ? <button onClick={assessFinishAssessment} className={`text-sm font-semibold ${assessTestColor.text}`}>Finish âœ“</button> : <button onClick={assessSaveAndExit} className={`text-sm font-semibold ${TH('text-muted-flip', darkMode)}`}>Save</button>}
            <button onClick={() => assessCurrentIndex > 0 && assessGoToQuestion(assessCurrentIndex - 1, 'back')} disabled={assessCurrentIndex === 0} className={`text-xl font-bold w-8 h-8 flex items-center justify-center ${assessCurrentIndex === 0 ? (darkMode ? 'text-gray-700' : 'text-gray-300') : (darkMode ? 'text-gray-300' : 'text-gray-600')}`}>â—€</button>
            <div className="flex-1 text-center"><div className={`text-xs ${assessTestColor.text}`}>{assessCurrentTest.name}</div><div className={`text-sm font-medium ${TH('text-primary', darkMode)}`}>{assessCurrentIndex + 1} / {assessTotalQuestions}</div></div>
            <button onClick={() => assessCurrentIndex < assessTotalQuestions - 1 && assessGoToQuestion(assessCurrentIndex + 1, 'fwd')} disabled={assessCurrentIndex === assessTotalQuestions - 1} className={`text-xl font-bold w-8 h-8 flex items-center justify-center ${assessCurrentIndex === assessTotalQuestions - 1 ? (darkMode ? 'text-gray-700' : 'text-gray-300') : (darkMode ? 'text-gray-300' : 'text-gray-600')}`}>â–¶</button>
            <button onClick={() => setAssessShowExitConfirm(true)} className={`text-sm font-semibold ${TH('text-muted-flip', darkMode)}`}>Exit</button>
          </div>
          {/* Clickable Progress bar */}
          <div className={`flex h-2.5 gap-px px-1 py-0.5 ${darkMode ? 'bg-gray-900' : 'bg-gray-100'}`}>
            {segments.map((seg, i) => (<button key={i} onClick={() => assessGoToQuestion(i, i > assessCurrentIndex ? 'fwd' : 'back')} className={`flex-1 rounded-sm transition-colors hover:opacity-80 ${seg.isAnswered ? assessTestColor.bg : seg.isSkipped ? 'bg-amber-500' : seg.isCurrent ? (darkMode ? 'bg-white' : 'bg-gray-900') : (darkMode ? 'bg-gray-800' : 'bg-gray-300')}`} />))}
          </div>
          {/* Question + Answers */}
          <div className="flex-1 flex flex-col" onClick={() => assessPending !== null && assessHandleUndo()}>
            <div className="flex-1 flex flex-col justify-center px-4 pb-4">
              <div className={`p-5 rounded-2xl ${TH('bg-card', darkMode)}`}>
                <h2 className={`text-xl font-medium text-center leading-relaxed text-balance ${TH('text-primary', darkMode)}`}>{currentItem.q}</h2>
              </div>
            </div>
            <div className="flex-shrink-0 px-4 pb-4 space-y-2">
              {assessCurrentScale.map((option, i) => {
                const isSelected = assessResponses[assessCurrentIndex] === option.v;
                const isPending = assessPending === option.v;
                const colorTint = gradientStyles[assessCurrentTest.color][i];
                const selStyle = selectedStyles[assessCurrentTest.color];
                const pendStyle = pendingStyles[assessCurrentTest.color];
                const numColor = numColors[assessCurrentTest.color];
                return (
                  <button key={option.v} onClick={(e) => { e.stopPropagation(); if (!assessPending) assessHandleAnswerTap(option.v); }} className={`w-full py-3.5 px-4 rounded-xl flex items-center justify-between transition-colors border relative overflow-hidden ${isSelected ? `${selStyle} text-white ring-2 ring-offset-1 ${darkMode ? 'ring-offset-gray-950' : 'ring-offset-white'}` : isPending ? `${pendStyle} text-white` : `${colorTint} ${darkMode ? 'text-gray-200' : 'text-gray-700'}`}`}>
                    {isPending && <div className="absolute inset-0 bg-black/30" style={{ animation: `countdownShrink ${undoDelay}s linear forwards`, transformOrigin: 'left' }} />}
                    <span className="text-left relative z-10">{option.l}</span>
                    <div className="flex items-center gap-2 relative z-10">
                      {isPending && <span className="text-white/70 text-xs">tap to undo</span>}
                      <span className={`text-sm font-medium ${isSelected || isPending ? 'text-white/70' : numColor}`}>{option.v}</span>
                    </div>
                  </button>
                );
              })}
            </div>
          </div>
        </div>
      );
    }

    // Assessment Results Screen
    if (screen === 'assess-results') {
      const test = ASSESS_TESTS[assessCurrentTestId];
      const results = assessCompleted[assessCurrentTestId];
      const colors = ASSESS_C[test.color];

      // Enhanced trait info with Strength + Shadow framework
      const traitInfo = {
        E: { low: 'Reserved', high: 'Outgoing',
          strength: v => v > 60 ? 'Natural connector who energizes groups' : v < 40 ? 'Deep thinker who recharges through reflection' : 'Flexible between social and solo modes',
          shadow: v => v > 60 ? 'May struggle with alone time or quiet reflection' : v < 40 ? 'Networking and small talk can feel draining' : 'Neither extreme poses significant friction',
          tip: v => v > 60 ? 'Schedule deliberate quiet time for processing' : v < 40 ? 'Prepare conversation starters before social events' : 'Trust your instincts on when to engage vs. withdraw'
        },
        A: { low: 'Analytical', high: 'Empathetic',
          strength: v => v > 60 ? 'Creates harmony and builds trust easily' : v < 40 ? 'Cuts through noise to find truth' : 'Balances compassion with objectivity',
          shadow: v => v > 60 ? 'May avoid necessary conflict or hard truths' : v < 40 ? 'Directness can come across as cold' : 'Neither extreme poses significant friction',
          tip: v => v > 60 ? 'Practice saying "no" in low-stakes situations' : v < 40 ? 'Pause to acknowledge emotions before giving feedback' : 'Use your balance as a mediator strength'
        },
        C: { low: 'Flexible', high: 'Organized',
          strength: v => v > 60 ? 'Reliable executor who delivers consistently' : v < 40 ? 'Adapts quickly to changing circumstances' : 'Balances planning with adaptability',
          shadow: v => v > 60 ? 'Rigidity and perfectionism can slow you down' : v < 40 ? 'Details and follow-through may slip' : 'Neither extreme poses significant friction',
          tip: v => v > 60 ? 'Embrace "good enough" for low-stakes tasks' : v < 40 ? 'Use external systems (calendars, reminders) as scaffolding' : 'Leverage your flexibility as a superpower'
        },
        N: { low: 'Calm', high: 'Sensitive',
          strength: v => v > 60 ? 'Deep emotional intelligence and empathy' : v < 40 ? 'Steady presence under pressure' : 'Moderate emotional responsiveness',
          shadow: v => v > 60 ? 'Emotional intensity can be overwhelming' : v < 40 ? 'May miss emotional cues or seem detached' : 'Neither extreme poses significant friction',
          tip: v => v > 60 ? 'Develop grounding techniques for intense moments' : v < 40 ? 'Check in explicitly with others about their feelings' : 'Your balance helps you support others effectively'
        },
        O: { low: 'Practical', high: 'Curious',
          strength: v => v > 60 ? 'Visionary thinking and creative problem-solving' : v < 40 ? 'Grounded execution and proven methods' : 'Blends innovation with practicality',
          shadow: v => v > 60 ? 'May chase novelty over finishing projects' : v < 40 ? 'Resistance to change or new approaches' : 'Neither extreme poses significant friction',
          tip: v => v > 60 ? 'Set "finish before starting new" rules' : v < 40 ? 'Schedule time to explore one new idea monthly' : 'Use your balance to bridge visionaries and operators'
        },
      };
      const adhdLevel = results?.indicators >= 4 ? { label: 'High Indicators', color: 'text-rose-400', bg: 'from-rose-500 to-orange-500', desc: 'Several indicators present. These patterns may significantly impact daily life.', strength: 'Hyperfocus, creativity, out-of-the-box thinking', shadow: 'Time blindness, task initiation, emotional regulation' } : results?.indicators >= 2 ? { label: 'Moderate Indicators', color: 'text-amber-400', bg: 'from-amber-500 to-yellow-500', desc: 'Some indicators present. Worth monitoring how they affect you.', strength: 'Bursts of productive energy, adaptability', shadow: 'Occasional focus challenges, restlessness' } : { label: 'Low Indicators', color: 'text-emerald-400', bg: 'from-emerald-500 to-teal-500', desc: 'Few indicators. Likely typical neurological patterns.', strength: 'Consistent focus and task management', shadow: 'May not relate to ADHD experiences' };
      const riskLevel = results?.score >= 70 ? { label: 'Bold Explorer', desc: 'You embrace uncertainty and chase big opportunities', strength: 'Seizes opportunities others miss, comfortable with ambiguity', shadow: 'May underestimate downsides or act impulsively', tip: 'Build in a 24-hour rule for major decisions' } : results?.score >= 40 ? { label: 'Calculated Risk Taker', desc: 'You weigh risks carefully before acting', strength: 'Makes informed bets, balances caution with action', shadow: 'Analysis paralysis on edge cases', tip: 'Set decision deadlines to avoid overthinking' } : { label: 'Security Seeker', desc: 'You prefer stability and careful planning', strength: 'Protects against downside, builds lasting foundations', shadow: 'May miss opportunities that require a leap', tip: 'Practice small, reversible risks to build comfort' };
      const attachInfo = {
        Secure: { desc: 'You feel comfortable with intimacy and independence', strength: 'Forms deep bonds while maintaining healthy boundaries', shadow: 'May not fully understand others\' attachment struggles', tip: 'Use your security to create safe space for others' },
        Anxious: { desc: 'You seek closeness but worry about abandonment', strength: 'Deeply committed, attuned to relationship dynamics', shadow: 'Reassurance-seeking can strain relationships', tip: 'Build self-soothing practices for anxious moments' },
        Avoidant: { desc: 'You value independence and may keep emotional distance', strength: 'Self-sufficient, maintains boundaries effectively', shadow: 'May push away those who get too close', tip: 'Practice small vulnerability with trusted people' },
        Fearful: { desc: 'You desire closeness but fear vulnerability', strength: 'Deep capacity for connection when trust is built', shadow: 'Push-pull dynamics can confuse partners', tip: 'Work with a therapist on attachment patterns' }
      };
      const integrityLevel = results?.score >= 70 ? { label: 'The Sincere Idealist', strength: 'Trusted implicitly, builds authentic relationships', shadow: 'May judge others who bend rules pragmatically', tip: 'Accept that others navigate ethics differently' } : results?.score >= 40 ? { label: 'The Balanced Pragmatist', strength: 'Adapts approach while maintaining core values', shadow: 'Occasional uncertainty about the "right" choice', tip: 'Define your non-negotiables clearly' } : { label: 'The Strategic Navigator', strength: 'Reads situations and optimizes outcomes skillfully', shadow: 'Others may question your motives', tip: 'Be transparent about your reasoning process' };
      const shadowInfo = {
        M: { high: 'Strategic Thinker', mid: 'Situational Tactician', low: 'Transparent Operator', strength: s => s > 60 ? 'Masterful at navigating complex social dynamics' : s < 40 ? 'Builds trust through authentic openness' : 'Flexes between directness and strategy', shadow: s => s > 60 ? 'Others may perceive manipulation' : s < 40 ? 'May be outmaneuvered by strategic players' : 'Occasional uncertainty on approach' },
        N: { high: 'Confident Leader', mid: 'Healthy Self-Regard', low: 'Humble Collaborator', strength: s => s > 60 ? 'Commands attention and inspires others' : s < 40 ? 'Elevates team over self, builds loyalty' : 'Balances confidence with humility', shadow: s => s > 60 ? 'May not see blind spots or hear criticism' : s < 40 ? 'May undersell yourself or defer too much' : 'Neither extreme causes friction' },
        P: { high: 'Cool Under Pressure', mid: 'Emotionally Balanced', low: 'Deeply Empathetic', strength: s => s > 60 ? 'Makes hard decisions without emotional interference' : s < 40 ? 'Deep connections and emotional attunement' : 'Balances logic and emotion well', shadow: s => s > 60 ? 'May seem cold or miss emotional cues' : s < 40 ? 'Emotional contagion can be draining' : 'Neither extreme causes friction' }
      };
      const chronoInfo = {
        'Morning Lark': { strength: 'Peak focus in early hours when distractions are low', shadow: 'Energy crashes in late afternoon/evening', tip: 'Front-load important work before noon' },
        'Night Owl': { strength: 'Creative breakthroughs in quiet late hours', shadow: 'Mornings feel like wading through mud', tip: 'Protect your night time for deep work' },
        'Third Bird': { strength: 'Adaptable energy that works with any schedule', shadow: 'May lack the intensity peaks others have', tip: 'Experiment to find your personal sweet spots' }
      };

      const ResultCard = ({ icon, title, subtitle, children }) => (
        <div onClick={(e) => e.stopPropagation()} className={`rounded-2xl overflow-hidden ${darkMode ? 'bg-gray-900/80 border border-gray-800' : 'bg-white border border-gray-200'}`}>
          <div className={`p-5 bg-gradient-to-br ${colors.grad}`}>
            <div className="text-center">
              <span className="text-4xl">{icon}</span>
              <h2 className="text-white text-xl font-bold mt-2">{title}</h2>
              {subtitle && <p className="text-white/70 text-sm mt-1">{subtitle}</p>}
            </div>
          </div>
          <div className="p-4 space-y-4">{children}</div>
        </div>
      );

      const InsightRow = ({ emoji, label, text }) => (
        <div className="flex gap-3">
          <span className="text-lg">{emoji}</span>
          <div className="flex-1">
            <div className={`text-xs font-medium uppercase tracking-wide ${colors.text}`}>{label}</div>
            <p className={`text-sm mt-0.5 ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>{text}</p>
          </div>
        </div>
      );

      const ScoreGauge = ({ value, label, lowLabel, highLabel }) => {
        // Spectrum indicator with marker - shows position, not progress
        // Uses blue â†’ purple gradient (neutral spectrum, no good/bad implication)
        // Arc: 270Â° starting at lower-left, through top, to lower-right
        // 0% = lower-left (-225Â°), 50% = top (-90Â°), 100% = lower-right (45Â°)
        const angle = ((value / 100) * 270) - 225;
        const rad = (angle * Math.PI) / 180;
        const markerX = 48 + 40 * Math.cos(rad);
        const markerY = 48 + 40 * Math.sin(rad);
        return (
          <div className="text-center">
            <div className="relative w-24 h-24 mx-auto">
              <svg className="w-24 h-24" viewBox="0 0 96 96">
                <defs>
                  <linearGradient id="spectrumGrad" x1="0%" y1="50%" x2="100%" y2="50%">
                    <stop offset="0%" stopColor="#06b6d4" />
                    <stop offset="100%" stopColor="#8b5cf6" />
                  </linearGradient>
                </defs>
                {/* Full spectrum arc (270Â°, gap at bottom) */}
                <circle cx="48" cy="48" r="40" stroke="url(#spectrumGrad)" strokeWidth="8" fill="none"
                  strokeDasharray="188.5 251.2" strokeLinecap="round" transform="rotate(135 48 48)" />
                {/* Position marker */}
                <circle cx={markerX} cy={markerY} r="7" fill="white" stroke={darkMode ? '#111827' : '#374151'} strokeWidth="3" />
              </svg>
              <div className="absolute inset-0 flex items-center justify-center">
                <span className={`text-2xl font-bold ${colors.text}`}>{value}%</span>
              </div>
            </div>
            {(lowLabel || highLabel) && (
              <div className={`flex justify-between text-[10px] mt-1 px-2 ${TH('text-dim', darkMode)}`}>
                <span>{lowLabel}</span><span>{highLabel}</span>
              </div>
            )}
            {label && <div className={`text-xs mt-1 ${TH('text-dim', darkMode)}`}>{label}</div>}
          </div>
        );
      };

      return (
        <div className={`h-full flex flex-col ${TH('bg-main', darkMode)}`} onClick={() => setScreen('assess-picker')}>
          <div className={`h-[44px] flex-shrink-0 flex items-center px-4 border-b ${TH('border-base', darkMode)}`}>
            <button onClick={(e) => { e.stopPropagation(); setScreen('assess-picker'); }} className={`text-lg ${TH('text-dim', darkMode)}`}>â†</button>
            <span className={`flex-1 text-center font-medium ${TH('text-primary', darkMode)}`}>Your Results</span>
            <div className="w-6" />
          </div>
          <div className="flex-1 overflow-auto p-4 space-y-4 hide-scrollbar">

            {/* Big Five Results */}
            {test.parent === 'bigfive' && results && (
              <ResultCard icon={test.icon} title={results.traitName} subtitle={`${traitInfo[test.trait].low} â†” ${traitInfo[test.trait].high}`}>
                <ScoreGauge value={results.score} lowLabel={traitInfo[test.trait].low} highLabel={traitInfo[test.trait].high} />
                <div className="space-y-3 pt-2">
                  <InsightRow emoji="ðŸ’ª" label="Your Strength" text={traitInfo[test.trait].strength(results.score)} />
                  <InsightRow emoji="âš¡" label="Watch For" text={traitInfo[test.trait].shadow(results.score)} />
                  <InsightRow emoji="ðŸ’¡" label="Pro Tip" text={traitInfo[test.trait].tip(results.score)} />
                </div>
                {(() => {
                  const bigFiveModules = Object.entries(ASSESS_TESTS).filter(([_, t]) => t.parent === 'bigfive');
                  const completedModules = bigFiveModules.filter(([id]) => assessCompleted[id]);
                  const remaining = bigFiveModules.length - completedModules.length;
                  return remaining > 0 ? (
                    <div className={`p-3 rounded-xl text-sm ${darkMode ? 'bg-violet-900/30 text-violet-300' : 'bg-violet-50 text-violet-700'}`}>
                      ðŸŽ­ {remaining} more module{remaining > 1 ? 's' : ''} to complete Big Five
                    </div>
                  ) : (
                    <div className={`p-3 rounded-xl text-sm ${darkMode ? 'bg-violet-900/30 text-violet-300' : 'bg-violet-50 text-violet-700'}`}>
                      ðŸŽ­ Big Five complete! View Analysis for insights.
                    </div>
                  );
                })()}
              </ResultCard>
            )}

            {/* Shadow Results */}
            {test.parent === 'shadow' && results && (
              <ResultCard icon={test.icon} title={results.score > 60 ? shadowInfo[test.trait].high : results.score < 40 ? shadowInfo[test.trait].low : shadowInfo[test.trait].mid} subtitle={results.traitName}>
                <ScoreGauge value={results.score} lowLabel={shadowInfo[test.trait].low} highLabel={shadowInfo[test.trait].high} />
                <div className="space-y-3 pt-2">
                  <InsightRow emoji="ðŸ’ª" label="Your Strength" text={shadowInfo[test.trait].strength(results.score)} />
                  <InsightRow emoji="âš¡" label="Watch For" text={shadowInfo[test.trait].shadow(results.score)} />
                </div>
                {(() => {
                  const shadowModules = Object.entries(ASSESS_TESTS).filter(([_, t]) => t.parent === 'shadow');
                  const remaining = shadowModules.length - shadowModules.filter(([id]) => assessCompleted[id]).length;
                  return remaining > 0 ? (
                    <div className={`p-3 rounded-xl text-sm ${darkMode ? 'bg-slate-800/50 text-slate-300' : 'bg-slate-100 text-slate-700'}`}>
                      ðŸŒ‘ {remaining} more module{remaining > 1 ? 's' : ''} to complete Shadow Self
                    </div>
                  ) : (
                    <div className={`p-3 rounded-xl text-sm ${darkMode ? 'bg-slate-800/50 text-slate-300' : 'bg-slate-100 text-slate-700'}`}>
                      ðŸŒ‘ Shadow Self complete! View Analysis for insights.
                    </div>
                  );
                })()}
              </ResultCard>
            )}

            {/* Integrity Results */}
            {assessCurrentTestId === 'integrity' && results && (
              <ResultCard icon={test.icon} title={integrityLevel.label} subtitle="Honesty-Humility">
                <ScoreGauge value={results.score} lowLabel="Flexible" highLabel="Principled" />
                <div className="space-y-3 pt-2">
                  <InsightRow emoji="ðŸ’ª" label="Your Strength" text={integrityLevel.strength} />
                  <InsightRow emoji="âš¡" label="Watch For" text={integrityLevel.shadow} />
                  <InsightRow emoji="ðŸ’¡" label="Pro Tip" text={integrityLevel.tip} />
                </div>
              </ResultCard>
            )}

            {/* ADHD Results */}
            {assessCurrentTestId === 'adhd' && (
              <ResultCard icon={test.icon} title={adhdLevel.label} subtitle={`${results.indicators}/6 indicators present`}>
                <div className="flex justify-center gap-2 py-2">
                  {[1,2,3,4,5,6].map(i => (
                    <div key={i} className={`w-8 h-8 rounded-full flex items-center justify-center text-sm font-medium ${i <= results.indicators ? `bg-gradient-to-br ${adhdLevel.bg} text-white` : (darkMode ? 'bg-gray-800 text-gray-600' : 'bg-gray-200 text-gray-400')}`}>{i}</div>
                  ))}
                </div>
                <div className="space-y-3 pt-2">
                  <InsightRow emoji="ðŸ’ª" label="Potential Strength" text={adhdLevel.strength} />
                  <InsightRow emoji="âš¡" label="Potential Challenge" text={adhdLevel.shadow} />
                </div>
                <div className={`p-3 rounded-xl text-sm ${darkMode ? 'bg-blue-950/40 text-blue-300' : 'bg-blue-50 text-blue-700'}`}>
                  âš ï¸ This is a screening tool, not a diagnosis. Consult a professional for evaluation.
                </div>
              </ResultCard>
            )}

            {/* Cognitive/ND Results */}
            {assessCurrentTestId === 'cognitive' && (
              <ResultCard icon={test.icon} title={results.score > 60 ? 'Neurodivergent Patterns' : results.score < 40 ? 'Neurotypical Patterns' : 'Mixed Patterns'} subtitle="Cognitive Style">
                <div className={`p-4 rounded-xl ${TH('bg-elevated', darkMode)}`}>
                  <div className={`flex justify-between text-xs mb-2 ${TH('text-dim', darkMode)}`}>
                    <span>Neurotypical</span><span>Neurodivergent</span>
                  </div>
                  <div className="h-4 rounded-full overflow-hidden relative bg-gradient-to-r from-gray-400 via-teal-500 to-teal-400">
                    <div className="absolute top-1/2 -translate-y-1/2 w-5 h-5 bg-white rounded-full border-2 border-gray-800 shadow-lg"
                      style={{ left: `calc(${results.score}% - 10px)` }} />
                  </div>
                  <div className="text-center mt-3">
                    <span className={`text-3xl font-bold ${colors.text}`}>{results.score}%</span>
                    <p className={`text-xs mt-1 ${TH('text-dim', darkMode)}`}>alignment with ND traits</p>
                  </div>
                </div>
              </ResultCard>
            )}

            {/* Attachment Results */}
            {assessCurrentTestId === 'attachment' && (
              <ResultCard icon={test.icon} title={results.style} subtitle="Attachment Style">
                <div className={`grid grid-cols-2 gap-4 p-4 rounded-xl ${TH('bg-elevated', darkMode)}`}>
                  <div className="text-center">
                    <div className="text-3xl font-bold text-rose-400">{results.anxiety}</div>
                    <div className={`text-xs mt-1 ${TH('text-dim', darkMode)}`}>Anxiety</div>
                  </div>
                  <div className="text-center">
                    <div className="text-3xl font-bold text-sky-400">{results.avoidance}</div>
                    <div className={`text-xs mt-1 ${TH('text-dim', darkMode)}`}>Avoidance</div>
                  </div>
                </div>
                <div className="space-y-3 pt-2">
                  <InsightRow emoji="ðŸ’¬" label="What This Means" text={attachInfo[results.style].desc} />
                  <InsightRow emoji="ðŸ’ª" label="Your Strength" text={attachInfo[results.style].strength} />
                  <InsightRow emoji="âš¡" label="Watch For" text={attachInfo[results.style].shadow} />
                  <InsightRow emoji="ðŸ’¡" label="Pro Tip" text={attachInfo[results.style].tip} />
                </div>
              </ResultCard>
            )}

            {/* Risk Results */}
            {assessCurrentTestId === 'risk' && (
              <ResultCard icon={test.icon} title={riskLevel.label} subtitle="Risk Tolerance">
                <ScoreGauge value={results.score} lowLabel="Cautious" highLabel="Bold" />
                <div className="space-y-3 pt-2">
                  <InsightRow emoji="ðŸ’ª" label="Your Strength" text={riskLevel.strength} />
                  <InsightRow emoji="âš¡" label="Watch For" text={riskLevel.shadow} />
                  <InsightRow emoji="ðŸ’¡" label="Pro Tip" text={riskLevel.tip} />
                </div>
              </ResultCard>
            )}

            {/* Chronotype Results */}
            {assessCurrentTestId === 'chronotype' && results && (
              <ResultCard icon={results.type === 'Morning Lark' ? 'ðŸŒ…' : results.type === 'Night Owl' ? 'ðŸ¦‰' : 'ðŸ¦'} title={results.type} subtitle="Energy Rhythm">
                <div className={`p-4 rounded-xl ${TH('bg-elevated', darkMode)}`}>
                  <div className={`flex justify-between text-xs mb-2 ${TH('text-dim', darkMode)}`}>
                    <span>ðŸŒ… Morning</span><span>Night ðŸŒ™</span>
                  </div>
                  <div className="h-4 rounded-full overflow-hidden relative bg-gradient-to-r from-amber-400 via-sky-400 to-indigo-500">
                    <div className="absolute top-1/2 -translate-y-1/2 w-5 h-5 bg-white rounded-full border-2 border-gray-800 shadow-lg"
                      style={{ left: `calc(${100 - results.score}% - 10px)` }} />
                  </div>
                </div>
                <div className="space-y-3 pt-2">
                  <InsightRow emoji="ðŸ’ª" label="Your Strength" text={chronoInfo[results.type].strength} />
                  <InsightRow emoji="âš¡" label="Watch For" text={chronoInfo[results.type].shadow} />
                  <InsightRow emoji="ðŸ’¡" label="Pro Tip" text={chronoInfo[results.type].tip} />
                </div>
              </ResultCard>
            )}

            <button onClick={(e) => { e.stopPropagation(); setScreen('assess-picker'); }} className={`w-full py-4 rounded-xl bg-gradient-to-r ${colors.grad} text-white font-medium`}>Done</button>
          </div>
        </div>
      );
    }

    // Assessment Analysis Screen
    if (screen === 'assess-analysis') {
      const completedCount = Object.keys(assessCompleted).length;

      // Helper to get Big Five trait scores from modules
      const getBigFiveScores = () => {
        const scores = {};
        ['E', 'A', 'C', 'N', 'O'].forEach(trait => {
          const moduleId = `bigfive-${trait}`;
          if (assessCompleted[moduleId]) {
            scores[trait] = assessCompleted[moduleId].score;
          }
        });
        return scores;
      };
      const bigFive = getBigFiveScores();
      const hasBigFive = Object.keys(bigFive).length > 0;

      const getInsights = () => {
        const cats = {
          personality: { label: 'ðŸŽ­ Personality Patterns', items: [], navTo: 'bigfive' },
          relationships: { label: 'ðŸ’• Relationship Dynamics', items: [], navTo: 'attachment' },
          cognition: { label: 'ðŸ§  Cognitive Style', items: [], navTo: 'cognitive' },
          shadow: { label: 'ðŸŒ‘ Shadow & Values', items: [], navTo: 'shadow' },
          archetypes: { label: 'âš¡ Your Archetypes', items: [], navTo: null }
        };
        // Big Five + Risk combinations â†’ personality
        if (hasBigFive && assessCompleted.risk) {
          if (bigFive.O > 60 && assessCompleted.risk.score > 60) cats.personality.items.push({ icon: 'ðŸš€', text: 'High openness + risk tolerance suggests you thrive exploring new ventures' });
          if (bigFive.N > 60 && assessCompleted.risk.score < 40) cats.personality.items.push({ icon: 'ðŸ›¡ï¸', text: 'Your sensitivity combined with caution helps you avoid regrettable decisions' });
          if (bigFive.E > 60 && assessCompleted.risk.score > 50) cats.personality.items.push({ icon: 'ðŸŒŸ', text: 'Outgoing nature + willingness to take risks = natural leadership qualities' });
          if (bigFive.C > 70 && assessCompleted.risk.score < 40) cats.personality.items.push({ icon: 'ðŸ“Š', text: 'High conscientiousness + low risk tolerance = methodical planner who values stability' });
          if (bigFive.A > 60 && assessCompleted.risk.score < 50) cats.personality.items.push({ icon: 'ðŸ¤', text: 'Your agreeable nature combined with measured risk-taking makes you a reliable collaborator' });
        }
        // Big Five internal patterns â†’ personality
        if (hasBigFive) {
          if (bigFive.E > 60 && bigFive.A > 60) cats.personality.items.push({ icon: 'â˜€ï¸', text: 'High extraversion + agreeableness = warm, approachable social presence' });
          if (bigFive.N > 60 && bigFive.O > 60) cats.personality.items.push({ icon: 'ðŸŽ¨', text: 'Emotional depth + openness often fuels artistic or creative expression' });
          if (bigFive.C > 70 && bigFive.N < 40) cats.personality.items.push({ icon: 'âš“', text: 'High conscientiousness + emotional stability = calm under pressure' });
          if (bigFive.E < 40 && bigFive.O > 60) cats.personality.items.push({ icon: 'ðŸ“š', text: 'Introversion + openness suggests rich inner life and deep interests' });
        }
        // Attachment combinations â†’ relationships
        if (assessCompleted.attachment && hasBigFive) {
          if (assessCompleted.attachment.style === 'Anxious' && bigFive.N > 50) cats.relationships.items.push({ icon: 'ðŸ’­', text: 'Your emotional sensitivity may intensify relationship concerns' });
          if (assessCompleted.attachment.style === 'Avoidant' && bigFive.E < 40) cats.relationships.items.push({ icon: 'ðŸ ', text: 'You recharge alone and maintain independence in relationships' });
          if (assessCompleted.attachment.style === 'Secure' && bigFive.A > 50) cats.relationships.items.push({ icon: 'ðŸ’š', text: 'Secure attachment + agreeableness = strong relationship foundation' });
          if (assessCompleted.attachment.style === 'Anxious' && bigFive.E > 60) cats.relationships.items.push({ icon: 'ðŸŽ­', text: 'Social energy + anxious attachment may mean you seek reassurance through connection' });
          if (assessCompleted.attachment.style === 'Avoidant' && bigFive.C > 60) cats.relationships.items.push({ icon: 'ðŸŽ¯', text: 'Independence + conscientiousness suggests you channel energy into personal achievement' });
        }
        if (assessCompleted.adhd && assessCompleted.attachment) {
          if (assessCompleted.adhd.indicators >= 3 && assessCompleted.attachment.style === 'Anxious') cats.relationships.items.push({ icon: 'ðŸŒªï¸', text: 'ADHD + anxious attachment can intensify emotional experiences in relationships' });
        }
        // ADHD combinations â†’ cognition
        if (assessCompleted.adhd && hasBigFive) {
          if (assessCompleted.adhd.indicators >= 3 && bigFive.C < 40) cats.cognition.items.push({ icon: 'âš¡', text: 'ADHD traits align with your flexible, spontaneous approach' });
          if (assessCompleted.adhd.indicators >= 3 && bigFive.O > 60) cats.cognition.items.push({ icon: 'ðŸ’¡', text: 'High openness + ADHD traits may fuel creative bursts' });
          if (assessCompleted.adhd.indicators >= 3 && bigFive.E > 60) cats.cognition.items.push({ icon: 'ðŸŽª', text: 'ADHD + extraversion often creates an energetic, entertaining presence' });
          if (assessCompleted.adhd.indicators < 2 && bigFive.C > 70) cats.cognition.items.push({ icon: 'ðŸ“‹', text: 'Low ADHD indicators + high conscientiousness = natural ability to stay focused and organized' });
        }
        // Cognitive/ND combinations â†’ cognition
        if (assessCompleted.cognitive && hasBigFive) {
          if (assessCompleted.cognitive.score > 60 && bigFive.C > 60) cats.cognition.items.push({ icon: 'ðŸ§©', text: 'ND traits + conscientiousness = detail-oriented systematic thinker' });
          if (assessCompleted.cognitive.score > 60 && bigFive.O > 60) cats.cognition.items.push({ icon: 'ðŸ”®', text: 'ND traits + openness can create unique, unconventional perspectives' });
          if (assessCompleted.cognitive.score > 50 && bigFive.A < 40) cats.cognition.items.push({ icon: 'ðŸ”¬', text: 'ND traits + low agreeableness may mean you prioritize truth over social harmony' });
        }
        if (assessCompleted.cognitive && assessCompleted.risk) {
          if (assessCompleted.cognitive.score > 60 && assessCompleted.risk.score > 60) cats.cognition.items.push({ icon: 'ðŸŽ²', text: 'ND traits + high risk tolerance may lead to unconventional life choices' });
        }
        // Integrity combinations â†’ shadow
        if (assessCompleted.integrity) {
          const integ = assessCompleted.integrity.score;
          if (integ > 70 && assessCompleted.risk?.score > 60) cats.shadow.items.push({ icon: 'âš”ï¸', text: 'The Bold Truth-Teller: High integrity + risk tolerance = you speak unpopular truths without fear' });
          if (integ > 70 && hasBigFive && bigFive.A > 60) cats.shadow.items.push({ icon: 'ðŸ•Šï¸', text: 'High integrity + agreeableness = you build trust through authentic kindness' });
          if (integ < 40 && hasBigFive && bigFive.E > 60) insights.push({ icon: 'ðŸŽ­', text: 'Social charisma + flexible ethics may help you navigate complex social situations' });
        }
        // Shadow Self combinations
        const shadowM = assessCompleted['shadow-M']?.score;
        const shadowN = assessCompleted['shadow-N']?.score;
        const shadowP = assessCompleted['shadow-P']?.score;
        if (shadowM !== undefined) {
          if (shadowM > 70 && assessCompleted.attachment?.style === 'Secure') cats.shadow.items.push({ icon: 'ðŸ›¡ï¸', text: 'The Protective Strategist: Strategic mind + secure attachment = you use tactics to protect your inner circle' });
          if (shadowM > 70 && hasBigFive && bigFive.C > 60) cats.shadow.items.push({ icon: 'â™Ÿï¸', text: 'Strategic thinking + conscientiousness = patient, long-term planner' });
        }
        if (shadowN !== undefined) {
          if (shadowN > 70 && hasBigFive && bigFive.E > 60) cats.shadow.items.push({ icon: 'ðŸ‘‘', text: 'High self-regard + extraversion = natural performer who commands attention' });
          if (shadowN > 70 && assessCompleted.risk?.score > 60) cats.shadow.items.push({ icon: 'ðŸš€', text: 'Confidence + risk tolerance = bold moves driven by self-belief' });
        }
        if (shadowP !== undefined) {
          if (shadowP > 60 && hasBigFive && bigFive.N < 40) cats.shadow.items.push({ icon: 'ðŸ§Š', text: 'Emotional detachment + stability = calm decision-maker in crisis situations' });
          if (shadowP > 60 && assessCompleted.cognitive?.score > 60) cats.shadow.items.push({ icon: 'ðŸ”¬', text: 'Detachment + ND traits = analytical mind unswayed by emotional noise' });
        }
        // Archetypes - complex multi-trait patterns
        if (assessCompleted.cognitive?.score > 60 && assessCompleted.adhd?.indicators >= 3) {
          cats.archetypes.items.push({ icon: 'âš¡', text: 'The Rapid Prototyper: High-bandwidth mind that solves complex problems in creative bursts' });
        }
        if (assessCompleted.integrity?.score > 70 && shadowM > 60) {
          cats.archetypes.items.push({ icon: 'ðŸŽ¯', text: 'The Principled Strategist: Strong ethics guide your tactical decisions' });
        }
        if (assessCompleted.adhd?.indicators >= 3 && hasBigFive && bigFive.O > 60 && assessCompleted.cognitive?.score > 50) {
          cats.archetypes.items.push({ icon: 'ðŸŒ€', text: 'The Creative Maverick: Your divergent thinking, curiosity, and high-bandwidth processing create unconventional solutions others miss' });
        }
        if (hasBigFive && bigFive.E < 40 && bigFive.C > 70 && assessCompleted.integrity?.score > 70) {
          cats.archetypes.items.push({ icon: 'ðŸ¦‰', text: 'The Quiet Guardian: Reserved demeanor masks deep reliability and unwavering principles' });
        }
        if (shadowN > 60 && assessCompleted.attachment?.style === 'Anxious' && hasBigFive && bigFive.E > 60) {
          cats.archetypes.items.push({ icon: 'ðŸŽª', text: 'The Performer: You crave both spotlight and reassuranceâ€”success validates, but approval sustains' });
        }
        if (hasBigFive && bigFive.A > 70 && bigFive.N < 40 && assessCompleted.attachment?.style === 'Secure') {
          cats.archetypes.items.push({ icon: 'ðŸŒŠ', text: 'The Steady Anchor: Calm, caring presence that others naturally lean on in turbulent times' });
        }
        if (shadowM > 60 && shadowP > 50 && hasBigFive && bigFive.C > 60) {
          cats.archetypes.items.push({ icon: 'ðŸŽ­', text: 'The Calculated Player: Strategic detachment + discipline = you execute complex plans without emotional interference' });
        }
        if (assessCompleted.risk?.score > 70 && assessCompleted.adhd?.indicators >= 3 && hasBigFive && bigFive.N < 40) {
          cats.archetypes.items.push({ icon: 'ðŸ„', text: 'The Thrill Architect: High risk tolerance + impulsivity + emotional stability = you thrive in chaos others avoid' });
        }
        if (assessCompleted.integrity?.score > 70 && assessCompleted.attachment?.style === 'Secure' && hasBigFive && bigFive.A > 60) {
          cats.archetypes.items.push({ icon: 'ðŸ›ï¸', text: 'The Trust Builder: Authentic, secure, and kindâ€”you create psychological safety for those around you' });
        }
        // More personality patterns
        if (hasBigFive && bigFive.N > 70 && bigFive.O > 70) {
          cats.archetypes.items.push({ icon: 'ðŸŒ™', text: 'The Sensitive Visionary: Emotional intensity fuels rich imaginationâ€”depth is your superpower and burden' });
        }
        if (hasBigFive && bigFive.C < 30 && bigFive.O > 70) {
          cats.archetypes.items.push({ icon: 'ðŸ¦‹', text: 'The Free Spirit: Structure feels suffocating; you bloom in open-ended creative exploration' });
        }
        if (assessCompleted.attachment?.style === 'Avoidant' && shadowP > 50) {
          cats.archetypes.items.push({ icon: 'ðŸ”ï¸', text: 'The Lone Wolf: Independence isn\'t preferenceâ€”it\'s how you process the world most effectively' });
        }
        if (assessCompleted.cognitive?.score > 70 && hasBigFive && bigFive.A < 40) {
          cats.cognition.items.push({ icon: 'âš–ï¸', text: 'The Truth Seeker: ND traits + directness = you prioritize accuracy over social comfort' });
        }
        if (shadowN < 30 && hasBigFive && bigFive.A > 70) {
          cats.shadow.items.push({ icon: 'ðŸ•Šï¸', text: 'The Humble Helper: Low ego + high agreeableness = you genuinely elevate others without seeking credit' });
        }
        if (assessCompleted.risk?.score < 30 && hasBigFive && bigFive.N > 60) {
          cats.personality.items.push({ icon: 'ðŸ¢', text: 'The Careful Navigator: Your caution isn\'t timidityâ€”it\'s wisdom born from emotional awareness' });
        }
        if (assessCompleted.integrity?.score < 40 && assessCompleted.risk?.score > 70) {
          cats.archetypes.items.push({ icon: 'ðŸƒ', text: 'The Wild Card: Flexible ethics + high risk tolerance = you play by your own rules' });
        }
        if (hasBigFive && bigFive.E > 70 && bigFive.N > 60 && assessCompleted.attachment?.style === 'Anxious') {
          cats.archetypes.items.push({ icon: 'ðŸŽ ', text: 'The Social Chameleon: You energize rooms but secretly wonder if they\'d notice if you left' });
        }
        // Chronotype combinations
        if (assessCompleted.chronotype) {
          const chrono = assessCompleted.chronotype;
          if (chrono.type === 'Morning Lark' && hasBigFive && bigFive.C > 60) {
            cats.personality.items.push({ icon: 'ðŸŒ…', text: 'The Early Achiever: Morning energy + conscientiousness = you conquer your day before others wake' });
          }
          if (chrono.type === 'Night Owl' && hasBigFive && bigFive.O > 60) {
            cats.personality.items.push({ icon: 'ðŸŒ™', text: 'The Midnight Muse: Night energy + openness = creative breakthroughs in the quiet hours' });
          }
          if (chrono.type === 'Night Owl' && assessCompleted.adhd?.indicators >= 3) {
            cats.cognition.items.push({ icon: 'ðŸ¦‡', text: 'The Night Rider: ADHD + night owl = your brain comes alive when the world goes quiet' });
          }
          if (chrono.type === 'Morning Lark' && assessCompleted.integrity?.score > 70) {
            cats.shadow.items.push({ icon: 'ðŸ“', text: 'The Disciplined Dawn: Early riser + high integrity = you do the right thing before anyone\'s watching' });
          }
        }
        // Return both flat list and categories
        const allInsights = Object.values(cats).flatMap(c => c.items);
        return { all: allInsights, categories: cats };
      };
      const insightData = getInsights();
      const insights = insightData.all;
      const insightCategories = insightData.categories;

      // ProgressRing - uses shared ProgressCircle
      const ProgressRing = ({ testId, test }) => {
        const isCompleted = assessCompleted[testId];
        const progress = assessInProgress[testId];
        const answered = isCompleted ? test.items.length : progress ? Object.keys(progress.responses || {}).length : 0;
        const progressPct = (answered / test.items.length) * 100;
        return (
          <ProgressCircle
            progress={progressPct}
            size={48}
            strokeWidth={3}
            color={test.color}
            icon={test.icon}
            gradientId={`analysis-grad-${testId}`}
            darkMode={darkMode}
          />
        );
      };

      const AssessmentRow = ({ testId }) => {
        const test = ASSESS_TESTS[testId];
        const results = assessCompleted[testId];
        const progress = assessInProgress[testId];
        const colors = ASSESS_C[test.color];
        const answered = results ? test.items.length : progress ? Object.keys(progress.responses || {}).length : 0;
        const isComplete = !!results;
        const getResultSummary = () => {
          if (!results) return null;
          if (test.parent === 'bigfive') return `${results.score}%`;
          if (test.parent === 'shadow') return `${results.score}%`;
          if (testId === 'integrity') return results.score >= 70 ? 'High' : results.score >= 40 ? 'Moderate' : 'Low';
          if (testId === 'adhd') return results.indicators >= 4 ? 'High' : results.indicators >= 2 ? 'Moderate' : 'Low';
          if (testId === 'cognitive') return `${results.score}% ND`;
          if (testId === 'attachment') return results.style;
          if (testId === 'risk') return results.score >= 70 ? 'Bold' : results.score >= 40 ? 'Balanced' : 'Cautious';
          if (testId === 'chronotype') return results.type;
        };
        return (
          <button onClick={() => isComplete ? (setAssessCurrentTestId(testId), setScreen('assess-results')) : assessStartTest(testId)} className={`w-full p-3 rounded-xl flex items-center gap-3 ${TH('bg-card', darkMode)}`}>
            <ProgressRing testId={testId} test={test} />
            <div className="flex-1 text-left"><div className={`text-sm font-medium ${TH('text-primary', darkMode)}`}>{test.name}</div><div className={`text-xs ${TH('text-subtle', darkMode)}`}>{isComplete ? 'âœ“ Complete' : answered > 0 ? `${answered}/${test.items.length} answered` : 'Not started'}</div></div>
            {isComplete ? <span className={`text-sm font-semibold ${colors.text}`}>{getResultSummary()}</span> : <span className={`text-xs ${colors.text}`}>{answered > 0 ? 'Continue â†’' : 'Start â†’'}</span>}
          </button>
        );
      };

      // Collapsible Analysis Card component
      const AnalysisCard = ({ id, icon, title, subtitle, color, isComplete, children, compactContent }) => {
        const isExpanded = analysisExpanded[id];
        const colorStyles = {
          violet: { bg: darkMode ? 'bg-violet-900/20 border-violet-500/30' : 'bg-violet-50 border-violet-200', text: 'text-violet-400', bar: 'bg-violet-500' },
          slate: { bg: darkMode ? 'bg-slate-900/40 border-slate-500/30' : 'bg-slate-50 border-slate-200', text: 'text-slate-400', bar: 'bg-slate-500' },
          emerald: { bg: darkMode ? 'bg-emerald-900/20 border-emerald-500/30' : 'bg-emerald-50 border-emerald-200', text: 'text-emerald-400', bar: 'bg-emerald-500' },
          blue: { bg: darkMode ? 'bg-blue-900/20 border-blue-500/30' : 'bg-blue-50 border-blue-200', text: 'text-blue-400', bar: 'bg-blue-500' },
          pink: { bg: darkMode ? 'bg-fuchsia-900/20 border-fuchsia-500/30' : 'bg-fuchsia-50 border-fuchsia-200', text: 'text-fuchsia-400', bar: 'bg-fuchsia-500' },
          amber: { bg: darkMode ? 'bg-amber-900/20 border-amber-500/30' : 'bg-amber-50 border-amber-200', text: 'text-amber-400', bar: 'bg-amber-500' },
          teal: { bg: darkMode ? 'bg-teal-900/20 border-teal-500/30' : 'bg-teal-50 border-teal-200', text: 'text-teal-400', bar: 'bg-teal-500' },
        };
        const incompleteStyle = darkMode ? 'bg-gray-900/40 border-gray-700/50' : 'bg-gray-50 border-gray-200';
        const cs = colorStyles[color] || colorStyles.violet;
        const handleToggle = () => {
          const wasExpanded = isExpanded;
          setAnalysisExpanded(prev => ({ ...prev, [id]: !prev[id] }));
          // Scroll into view when expanding
          if (!wasExpanded) {
            setTimeout(() => {
              document.getElementById(`analysis-${id}`)?.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }, 50);
          }
        };
        return (
          <div id={`analysis-${id}`} className={`rounded-xl border overflow-hidden ${isComplete ? cs.bg : incompleteStyle}`}>
            <button onClick={handleToggle}
              className="w-full p-4 flex items-center gap-3 text-left">
              <span className={`text-2xl ${isComplete ? '' : 'opacity-50 grayscale'}`}>{icon}</span>
              <div className="flex-1 min-w-0">
                <div className={`font-semibold ${TH('text-primary', darkMode)} ${isComplete ? '' : 'opacity-70'}`}>{title}</div>
                <div className={`text-xs flex items-center gap-1 ${isComplete ? 'text-emerald-400' : TH('text-subtle', darkMode)}`}>
                  {isComplete ? <span>âœ“ Complete</span> : <span className="opacity-60">{subtitle}</span>}
                </div>
              </div>
              {isComplete && !isExpanded && compactContent}
              <span className={`text-sm transition-transform ${isExpanded ? 'rotate-180' : ''} ${TH('text-dim', darkMode)}`}>â–¼</span>
            </button>
            {isExpanded && (
              <div className={`px-4 pb-4 border-t ${darkMode ? 'border-gray-800' : 'border-gray-200'}`}>
                <div className="pt-4">{children}</div>
              </div>
            )}
          </div>
        );
      };

      // Trait descriptions for expanded view
      const traitDescriptions = {
        E: { name: 'Extraversion', low: 'Reserved', high: 'Outgoing', desc: s => s > 60 ? 'You energize in social settings and enjoy being around people.' : s < 40 ? 'You recharge through solitude and prefer deeper one-on-one connections.' : 'You balance social and solo time comfortably.' },
        A: { name: 'Agreeableness', low: 'Analytical', high: 'Empathetic', desc: s => s > 60 ? 'You prioritize harmony and naturally consider others\' feelings.' : s < 40 ? 'You value directness and truth over diplomatic softening.' : 'You balance compassion with objectivity.' },
        C: { name: 'Conscientiousness', low: 'Flexible', high: 'Organized', desc: s => s > 60 ? 'You thrive with structure, planning, and follow-through.' : s < 40 ? 'You prefer spontaneity and adapt quickly to change.' : 'You balance planning with adaptability.' },
        N: { name: 'Neuroticism', low: 'Calm', high: 'Sensitive', desc: s => s > 60 ? 'You experience emotions intensely and are highly attuned to your inner world.' : s < 40 ? 'You stay steady under pressure and recover quickly from setbacks.' : 'You have moderate emotional reactivity.' },
        O: { name: 'Openness', low: 'Practical', high: 'Curious', desc: s => s > 60 ? 'You seek novelty, abstract ideas, and creative exploration.' : s < 40 ? 'You prefer proven, concrete approaches and practical solutions.' : 'You balance tradition with exploration.' },
      };
      const shadowDescriptions = {
        M: { name: 'Strategic Mind', desc: s => s > 60 ? 'High tactical awarenessâ€”you naturally read situations and plan accordingly.' : s < 40 ? 'Straightforward approachâ€”you prefer transparency over strategy.' : 'Situational tacticianâ€”you flex between direct and strategic.' },
        N: { name: 'Self-Image', desc: s => s > 60 ? 'Strong self-regardâ€”you\'re confident in your abilities and value recognition.' : s < 40 ? 'Humble presenceâ€”you prefer to elevate others over yourself.' : 'Healthy self-regardâ€”balanced confidence without ego.' },
        P: { name: 'Detachment', desc: s => s > 60 ? 'Emotionally detachedâ€”you make decisions based on logic, not feelings.' : s < 40 ? 'Deeply empatheticâ€”you feel others\' emotions strongly.' : 'Emotionally balancedâ€”you blend logic with emotional awareness.' },
      };

      return (
        <div className={`h-full flex flex-col ${TH('bg-main', darkMode)}`}>
          <div className={`h-[44px] flex-shrink-0 flex items-center px-4 border-b ${TH('border-base', darkMode)}`}>
            <button onClick={() => setScreen('assess-picker')} className={`text-lg ${TH('text-dim', darkMode)}`}>â†</button>
            <span className={`flex-1 text-center font-medium ${TH('text-primary', darkMode)}`}>Analysis</span>
            <div className="w-6" />
          </div>
          <div className="flex-1 overflow-auto p-4 pb-24 space-y-3 hide-scrollbar">

            {/* Meta Analysis - at top with nested dropdowns */}
            <AnalysisCard id="meta" icon="âœ¨" title="Meta Analysis"
              subtitle={insights.length > 0 ? `${insights.length} insight${insights.length > 1 ? 's' : ''} discovered` : 'Complete 3+ assessments'}
              color="violet" isComplete={insights.length > 0}
              compactContent={insights.length > 0 && (
                <div className="flex -space-x-1">
                  {insights.slice(0, 3).map((ins, i) => (
                    <span key={i} className="text-sm">{ins.icon}</span>
                  ))}
                  {insights.length > 3 && <span className={`text-xs ${TH('text-dim', darkMode)}`}>+{insights.length - 3}</span>}
                </div>
              )}>
              {insights.length > 0 ? (
                <div className="space-y-2">
                  {Object.entries(insightCategories).map(([catId, cat]) => {
                    if (cat.items.length === 0) return null;
                    const isSubExpanded = analysisExpanded[`meta-${catId}`];
                    const handleSubToggle = (e) => {
                      e.stopPropagation();
                      const wasExpanded = isSubExpanded;
                      setAnalysisExpanded(prev => ({ ...prev, [`meta-${catId}`]: !prev[`meta-${catId}`] }));
                      if (!wasExpanded) {
                        setTimeout(() => document.getElementById(`meta-sub-${catId}`)?.scrollIntoView({ behavior: 'smooth', block: 'nearest' }), 50);
                      }
                    };
                    return (
                      <div key={catId} id={`meta-sub-${catId}`} className={`rounded-lg overflow-hidden ${darkMode ? 'bg-gray-900/50' : 'bg-white/50'}`}>
                        <button
                          onClick={handleSubToggle}
                          className="w-full px-3 py-2 flex items-center justify-between text-left"
                        >
                          <span className={`text-sm font-medium ${TH('text-primary', darkMode)}`}>{cat.label}</span>
                          <div className="flex items-center gap-2">
                            <span className={`text-xs ${TH('text-dim', darkMode)}`}>{cat.items.length}</span>
                            <span className={`text-xs transition-transform ${isSubExpanded ? 'rotate-180' : ''} ${TH('text-dim', darkMode)}`}>â–¼</span>
                          </div>
                        </button>
                        {isSubExpanded && (
                          <div className={`px-3 pb-3 space-y-2 border-t ${darkMode ? 'border-gray-800' : 'border-gray-200'}`}>
                            {cat.items.map((ins, i) => (
                              <div key={i} className="flex items-start gap-2 pt-2">
                                <span className="text-base">{ins.icon}</span>
                                <p className={`text-xs leading-relaxed flex-1 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>{ins.text}</p>
                                {cat.navTo && (
                                  <button
                                    onClick={(e) => { e.stopPropagation(); setAnalysisExpanded(prev => ({ ...prev, [cat.navTo]: true })); }}
                                    className={`text-[10px] px-1.5 py-0.5 rounded ${darkMode ? 'bg-violet-900/50 text-violet-400 hover:bg-violet-900' : 'bg-violet-100 text-violet-600 hover:bg-violet-200'}`}
                                  >â†’</button>
                                )}
                              </div>
                            ))}
                          </div>
                        )}
                      </div>
                    );
                  })}
                </div>
              ) : (
                <p className={`text-sm ${TH('text-dim', darkMode)}`}>Complete more assessments to unlock cross-pattern insights about how your traits interact.</p>
              )}
            </AnalysisCard>

            {/* Progress Overview - compact */}
            <div className={`px-3 py-2 rounded-xl ${TH('bg-card', darkMode)}`}>
              <div className="flex items-center justify-between mb-2">
                <span className={`text-xs font-medium ${TH('text-primary', darkMode)}`}>Progress</span>
                <span className={`text-[10px] ${TH('text-dim', darkMode)}`}>{completedCount}/{Object.keys(ASSESS_TESTS).length}</span>
              </div>
              <div className="flex flex-wrap gap-1 justify-center">
                {Object.entries(ASSESS_TESTS).map(([id, test]) => {
                  const done = assessCompleted[id];
                  const inProg = assessInProgress[id];
                  const pct = done ? 100 : inProg ? Math.round((Object.keys(inProg.responses || {}).length / test.items.length) * 100) : 0;
                  const sectionId = test.parent || id;
                  return (
                    <div
                      key={id}
                      className="p-1 cursor-pointer relative group"
                      onClick={() => {
                        if (done) {
                          setAssessCurrentTestId(id);
                          setScreen('assess-results');
                        } else {
                          assessStartTest(id);
                        }
                      }}
                    >
                      {/* Instant tooltip */}
                      <div className={`absolute bottom-full left-1/2 -translate-x-1/2 mb-1 px-2 py-1 rounded-lg text-xs font-medium whitespace-nowrap opacity-0 group-hover:opacity-100 pointer-events-none z-50 transition-opacity duration-75 ${darkMode ? 'bg-gray-800 text-white' : 'bg-gray-900 text-white'}`}>
                        {test.name}{pct > 0 && <span className="ml-1 opacity-70">{pct}%</span>}
                        <span className={`block text-[10px] text-center ${done ? 'text-emerald-400' : 'text-blue-400'}`}>{done ? 'View' : pct > 0 ? 'Continue' : 'Start'}</span>
                      </div>
                      <ProgressCircle
                        progress={pct}
                        size={28}
                        strokeWidth={2}
                        color={test.color}
                        icon={test.icon}
                        gradientId={`overview-${id}`}
                        darkMode={darkMode}
                        iconSize="text-[10px]"
                        glow={true}
                      />
                    </div>
                  );
                })}
              </div>
            </div>

            {/* Big Five */}
            {(() => {
              const bigFiveIds = ['bigfive-E', 'bigfive-A', 'bigfive-C', 'bigfive-N', 'bigfive-O'];
              const completedBF = bigFiveIds.filter(id => assessCompleted[id]).length;
              const allBFComplete = completedBF === 5;
              return (
                <AnalysisCard id="bigfive" icon="ðŸŽ­" title="Big Five Personality" subtitle={`${completedBF}/5 modules`} color="violet" isComplete={allBFComplete}
                  compactContent={allBFComplete && (
                    <div className="flex gap-1">
                      {bigFiveIds.map(id => (
                        <div key={id} className="w-6 h-6 rounded-full bg-violet-500/20 flex items-center justify-center">
                          <span className="text-[10px] font-bold text-violet-400">{assessCompleted[id]?.score}</span>
                        </div>
                      ))}
                    </div>
                  )}>
                  {allBFComplete ? (
                    <div className="space-y-4">
                      {/* Radar Chart */}
                      {(() => {
                        const scores = bigFiveIds.map(id => assessCompleted[id]?.score || 0);
                        const labels = ['E', 'A', 'C', 'N', 'O'];
                        const size = 160, cx = size/2, cy = size/2, r = 55;
                        const angles = labels.map((_, i) => (i * 2 * Math.PI / 5) - Math.PI/2);
                        const points = scores.map((s, i) => {
                          const dist = (s / 100) * r;
                          return { x: cx + dist * Math.cos(angles[i]), y: cy + dist * Math.sin(angles[i]) };
                        });
                        const pathD = points.map((p, i) => `${i === 0 ? 'M' : 'L'} ${p.x} ${p.y}`).join(' ') + ' Z';
                        return (
                          <div className="flex justify-center py-2">
                            <svg width={size} height={size} className="overflow-visible">
                              {[0.25, 0.5, 0.75, 1].map(scale => (
                                <polygon key={scale} points={angles.map(a => `${cx + r * scale * Math.cos(a)},${cy + r * scale * Math.sin(a)}`).join(' ')}
                                  fill="none" stroke={darkMode ? '#374151' : '#e5e7eb'} strokeWidth="1" />
                              ))}
                              {angles.map((a, i) => (
                                <line key={i} x1={cx} y1={cy} x2={cx + r * Math.cos(a)} y2={cy + r * Math.sin(a)}
                                  stroke={darkMode ? '#374151' : '#e5e7eb'} strokeWidth="1" />
                              ))}
                              <path d={pathD} fill="rgba(139, 92, 246, 0.3)" stroke="#8b5cf6" strokeWidth="2" />
                              {points.map((p, i) => <circle key={i} cx={p.x} cy={p.y} r="5" fill="#8b5cf6" />)}
                              {labels.map((lbl, i) => {
                                const lx = cx + (r + 18) * Math.cos(angles[i]);
                                const ly = cy + (r + 18) * Math.sin(angles[i]);
                                return <text key={lbl} x={lx} y={ly} textAnchor="middle" dominantBaseline="middle"
                                  className={`text-xs font-bold ${darkMode ? 'fill-violet-400' : 'fill-violet-600'}`}>{lbl}</text>;
                              })}
                            </svg>
                          </div>
                        );
                      })()}
                      {/* Detailed breakdowns */}
                      <div className="space-y-3">
                        {bigFiveIds.map(id => {
                          const result = assessCompleted[id];
                          const trait = ASSESS_TESTS[id].trait;
                          const info = traitDescriptions[trait];
                          return (
                            <div key={id} className={`p-3 rounded-lg ${darkMode ? 'bg-gray-900/50' : 'bg-white'}`}>
                              <div className="flex items-center justify-between mb-2">
                                <span className={`text-sm font-medium ${TH('text-primary', darkMode)}`}>{info.name}</span>
                                <span className="text-sm font-bold text-violet-400">{result?.score}%</span>
                              </div>
                              <div className={`h-2 rounded-full mb-2 ${darkMode ? 'bg-gray-800' : 'bg-gray-200'}`}>
                                <div className="h-full bg-violet-500 rounded-full" style={{ width: `${result?.score || 0}%` }} />
                              </div>
                              <div className={`flex justify-between text-xs mb-2 ${TH('text-dim', darkMode)}`}>
                                <span>{info.low}</span><span>{info.high}</span>
                              </div>
                              <p className={`text-sm leading-relaxed ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>{info.desc(result?.score)}</p>
                            </div>
                          );
                        })}
                      </div>
                    </div>
                  ) : (
                    <div className="space-y-2">
                      <div className="flex gap-1.5">
                        {bigFiveIds.map(id => {
                          const done = assessCompleted[id];
                          const inProg = assessInProgress[id];
                          return <div key={id} className={`flex-1 h-2 rounded-full ${done ? 'bg-violet-500' : inProg ? 'bg-violet-500/40' : (darkMode ? 'bg-gray-700' : 'bg-gray-300')}`} />;
                        })}
                      </div>
                      <p className={`text-sm ${TH('text-dim', darkMode)}`}>Complete all 5 modules to see your personality profile.</p>
                    </div>
                  )}
                </AnalysisCard>
              );
            })()}

            {/* Shadow Self */}
            {(() => {
              const shadowIds = ['shadow-M', 'shadow-N', 'shadow-P'];
              const completedShadow = shadowIds.filter(id => assessCompleted[id]).length;
              const allShadowComplete = completedShadow === 3;
              return (
                <AnalysisCard id="shadow" icon="ðŸŒ‘" title="Shadow Self" subtitle={`${completedShadow}/3 modules`} color="slate" isComplete={allShadowComplete}
                  compactContent={allShadowComplete && (
                    <div className="flex gap-1">
                      {shadowIds.map(id => (
                        <div key={id} className="w-6 h-6 rounded-full bg-slate-500/20 flex items-center justify-center">
                          <span className="text-[10px] font-bold text-slate-400">{assessCompleted[id]?.score}</span>
                        </div>
                      ))}
                    </div>
                  )}>
                  {allShadowComplete ? (
                    <div className="space-y-3">
                      {shadowIds.map(id => {
                        const result = assessCompleted[id];
                        const trait = ASSESS_TESTS[id].trait;
                        const info = shadowDescriptions[trait];
                        return (
                          <div key={id} className={`p-3 rounded-lg ${darkMode ? 'bg-gray-900/50' : 'bg-white'}`}>
                            <div className="flex items-center justify-between mb-2">
                              <span className={`text-sm font-medium ${TH('text-primary', darkMode)}`}>{info.name}</span>
                              <span className="text-sm font-bold text-slate-400">{result?.score}%</span>
                            </div>
                            <div className={`h-2 rounded-full mb-2 ${darkMode ? 'bg-gray-800' : 'bg-gray-200'}`}>
                              <div className="h-full bg-slate-500 rounded-full" style={{ width: `${result?.score || 0}%` }} />
                            </div>
                            <p className={`text-sm leading-relaxed ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>{info.desc(result?.score)}</p>
                          </div>
                        );
                      })}
                    </div>
                  ) : (
                    <div className="space-y-2">
                      <div className="flex gap-1.5">
                        {shadowIds.map(id => {
                          const done = assessCompleted[id];
                          const inProg = assessInProgress[id];
                          return <div key={id} className={`flex-1 h-2 rounded-full ${done ? 'bg-slate-500' : inProg ? 'bg-slate-500/40' : (darkMode ? 'bg-gray-700' : 'bg-gray-300')}`} />;
                        })}
                      </div>
                      <p className={`text-sm ${TH('text-dim', darkMode)}`}>Complete all 3 modules to reveal your shadow profile.</p>
                    </div>
                  )}
                </AnalysisCard>
              );
            })()}

            {/* Individual Assessments */}
            {Object.keys(ASSESS_TESTS).filter(id => !ASSESS_TESTS[id].parent).map(testId => {
              const test = ASSESS_TESTS[testId];
              const results = assessCompleted[testId];
              const progress = assessInProgress[testId];
              const colors = ASSESS_C[test.color];
              const getCompactResult = () => {
                if (!results) return null;
                if (testId === 'integrity') return results.score >= 70 ? 'High' : results.score >= 40 ? 'Moderate' : 'Low';
                if (testId === 'adhd') return `${results.indicators}/6`;
                if (testId === 'cognitive') return `${results.score}%`;
                if (testId === 'attachment') return results.style;
                if (testId === 'risk') return `${results.score}%`;
                if (testId === 'chronotype') return results.type;
                return null;
              };
              const getDetailedContent = () => {
                if (!results) {
                  const answered = progress ? Object.keys(progress.responses || {}).length : 0;
                  const total = test.items.length;
                  const pct = Math.round((answered / total) * 100);
                  return (
                    <div className="space-y-3">
                      <p className={`text-sm ${TH('text-dim', darkMode)}`}>{test.description || 'Discover insights about yourself.'}</p>
                      {progress && (
                        <div className="space-y-1">
                          <div className="flex justify-between text-xs">
                            <span className={TH('text-dim', darkMode)}>Progress</span>
                            <span className={colors.text}>{answered}/{total}</span>
                          </div>
                          <div className={`h-2 rounded-full ${darkMode ? 'bg-gray-800' : 'bg-gray-200'}`}>
                            <div className={`h-full rounded-full bg-gradient-to-r ${ASSESS_C[test.color].grad}`} style={{ width: `${pct}%` }} />
                          </div>
                        </div>
                      )}
                      <button
                        onClick={() => assessStartTest(testId)}
                        className={`w-full py-3 rounded-xl font-medium text-white bg-gradient-to-r ${ASSESS_C[test.color].grad}`}
                      >
                        {progress ? 'Resume' : 'Start'} â†’
                      </button>
                    </div>
                  );
                }
                if (testId === 'integrity') return (
                  <div className="space-y-2">
                    <div className={`flex items-center justify-between p-3 rounded-lg ${darkMode ? 'bg-gray-900/50' : 'bg-white'}`}>
                      <span className={TH('text-primary', darkMode)}>Score</span>
                      <span className={`font-bold ${colors.text}`}>{results.score}%</span>
                    </div>
                    <p className={`text-sm leading-relaxed ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                      {results.score >= 70 ? 'You value authenticity and fairness. You\'re unlikely to use flattery or manipulation to get ahead, and you don\'t feel a strong need for status symbols.' :
                       results.score >= 40 ? 'You balance principles with pragmatism. You navigate ethical situations thoughtfully, adapting your approach to context.' :
                       'You\'re strategically flexible. You adapt your approach based on the situation and what\'s needed to achieve your goals.'}
                    </p>
                  </div>
                );
                if (testId === 'adhd') return (
                  <div className="space-y-2">
                    <div className="flex justify-center gap-2 py-2">
                      {[1,2,3,4,5,6].map(i => (
                        <div key={i} className={`w-8 h-8 rounded-full flex items-center justify-center text-sm font-medium ${i <= results.indicators ? 'bg-blue-500 text-white' : (darkMode ? 'bg-gray-800 text-gray-600' : 'bg-gray-200 text-gray-400')}`}>{i}</div>
                      ))}
                    </div>
                    <p className={`text-sm leading-relaxed ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                      {results.indicators >= 4 ? 'Several ADHD indicators present. These patterns may significantly impact focus, time management, and emotional regulation. Consider professional evaluation.' :
                       results.indicators >= 2 ? 'Some ADHD indicators present. You may experience occasional challenges with focus or impulsivity. Worth monitoring.' :
                       'Few ADHD indicators. Your attention and focus patterns appear to be in the typical range.'}
                    </p>
                    <div className={`p-2 rounded-lg text-xs ${darkMode ? 'bg-blue-950/40 text-blue-300' : 'bg-blue-50 text-blue-700'}`}>
                      âš ï¸ This is a screening tool, not a diagnosis.
                    </div>
                  </div>
                );
                if (testId === 'cognitive') return (
                  <div className="space-y-2">
                    <div className={`p-3 rounded-lg ${darkMode ? 'bg-gray-900/50' : 'bg-white'}`}>
                      <div className={`flex justify-between text-xs mb-2 ${TH('text-dim', darkMode)}`}><span>Neurotypical</span><span>Neurodivergent</span></div>
                      <div className="h-4 rounded-full overflow-hidden relative bg-gradient-to-r from-gray-400 via-teal-500 to-teal-400">
                        <div className="absolute top-1/2 -translate-y-1/2 w-4 h-4 bg-white rounded-full border-2 border-gray-800 shadow-lg"
                          style={{ left: `calc(${results.score}% - 8px)` }} />
                      </div>
                      <div className="text-center mt-2"><span className={`text-2xl font-bold ${colors.text}`}>{results.score}%</span></div>
                    </div>
                    <p className={`text-sm leading-relaxed ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                      {results.score > 60 ? 'Your cognitive patterns align with neurodivergent profiles. You may process information, perceive details, or think in ways that differ from neurotypical patterns.' :
                       results.score < 40 ? 'Your cognitive patterns align with neurotypical profiles. Your thinking and processing styles are within typical ranges.' :
                       'You show a mix of neurotypical and neurodivergent patterns. Your cognitive style blends elements of both.'}
                    </p>
                  </div>
                );
                if (testId === 'attachment') return (
                  <div className="space-y-2">
                    <div className={`p-3 rounded-lg ${darkMode ? 'bg-gray-900/50' : 'bg-white'}`}>
                      <div className="grid grid-cols-2 gap-4 text-center">
                        <div><div className="text-2xl font-bold text-rose-400">{results.anxiety}</div><div className={`text-xs ${TH('text-dim', darkMode)}`}>Anxiety</div></div>
                        <div><div className="text-2xl font-bold text-sky-400">{results.avoidance}</div><div className={`text-xs ${TH('text-dim', darkMode)}`}>Avoidance</div></div>
                      </div>
                    </div>
                    <p className={`text-sm leading-relaxed ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                      {results.style === 'Secure' ? 'You\'re comfortable with intimacy and independence. You can depend on others and let them depend on you.' :
                       results.style === 'Anxious' ? 'You seek closeness but may worry about abandonment. You\'re highly attuned to relationship dynamics.' :
                       results.style === 'Avoidant' ? 'You value independence and may keep some emotional distance. You\'re self-sufficient in relationships.' :
                       'You desire closeness but may fear vulnerability. Building trust takes time, but deep connections are possible.'}
                    </p>
                  </div>
                );
                if (testId === 'risk') return (
                  <div className="space-y-2">
                    <div className={`flex items-center justify-between p-3 rounded-lg ${darkMode ? 'bg-gray-900/50' : 'bg-white'}`}>
                      <span className={TH('text-primary', darkMode)}>Risk Appetite</span>
                      <span className={`font-bold ${colors.text}`}>{results.score}%</span>
                    </div>
                    <p className={`text-sm leading-relaxed ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                      {results.score >= 70 ? 'You\'re a bold explorer who embraces uncertainty. You\'re comfortable with ambiguity and willing to take chances for potential rewards.' :
                       results.score >= 40 ? 'You\'re a calculated risk-taker. You weigh pros and cons carefully before making decisions involving uncertainty.' :
                       'You prefer security and stability. You\'re thoughtful about potential downsides and favor proven paths.'}
                    </p>
                  </div>
                );
                if (testId === 'chronotype') return (
                  <div className="space-y-2">
                    <div className={`p-3 rounded-lg ${darkMode ? 'bg-gray-900/50' : 'bg-white'}`}>
                      <div className={`flex justify-between text-xs mb-2 ${TH('text-dim', darkMode)}`}><span>ðŸŒ… Morning</span><span>Night ðŸŒ™</span></div>
                      <div className="h-4 rounded-full overflow-hidden relative bg-gradient-to-r from-amber-400 via-sky-400 to-indigo-500">
                        <div className="absolute top-1/2 -translate-y-1/2 w-4 h-4 bg-white rounded-full border-2 border-gray-800 shadow-lg"
                          style={{ left: `calc(${100 - results.score}% - 8px)` }} />
                      </div>
                    </div>
                    <p className={`text-sm leading-relaxed ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                      {results.type === 'Morning Lark' ? 'You\'re naturally energized in the morning. Your best thinking and focus happen early in the day. Protect your mornings for important work.' :
                       results.type === 'Night Owl' ? 'You come alive in the evening. Your creativity and focus peak in the quiet late hours. Design your schedule around this rhythm when possible.' :
                       'You\'re a Third Bird with flexible energy. You adapt well to different schedules and don\'t have extreme peaks or valleys.'}
                    </p>
                  </div>
                );
                return null;
              };
              const progressInfo = progress ? `${Object.keys(progress.responses || {}).length}/${test.items.length} answered` : 'Not started';
              return (
                <AnalysisCard key={testId} id={testId} icon={test.icon} title={test.name} subtitle={progressInfo} color={test.color} isComplete={!!results}
                  compactContent={results && <span className={`text-sm font-semibold ${colors.text}`}>{getCompactResult()}</span>}>
                  {getDetailedContent()}
                </AnalysisCard>
              );
            })}

          </div>
        </div>
      );
    }

    if (screen === 'categories') return (
      <CategoryScreen
        darkMode={darkMode}
        categories={CATEGORIES}
        questions={questions}
        responses={responses}
        onSelectCategory={handleSelectCategory}
        onSettings={goToSettings}
        stats={stats}
        qotdData={qotdData}
        qotdResponse={qotdResponse}
        onQotdClick={() => setScreen('qotd')}
        onResetQotd={resetQotd}
        onAssessments={() => setScreen('assess-picker')}
        assessCompleted={assessCompleted}
      />
    );

    if (!currentQuestion) return (
      <div className={`flex-1 flex items-center justify-center ${TH('text-primary', darkMode)}`}>
        <div className="text-center p-8"><div className="text-4xl mb-4">ðŸŽ‰</div><div className="text-xl font-medium mb-2">All done!</div></div>
      </div>
    );

    const progress = totalQuestions > 0 ? answeredCount / totalQuestions : 0;
    const hasNext = findNextUnanswered(currentIndex) !== null || currentIndex < questions.length - 1;

    // Generate results for current question if answered but no results yet
    const currentQuestionResults = currentResults || (isAnswered ? generateFakeResults(currentQuestion) : null);
    if (isAnswered && !currentResults) {
      setCommunityResults(prev => ({ ...prev, [currentQuestion.id]: currentQuestionResults }));
    }

    return (
      <div
        className="flex-1 flex flex-col overflow-hidden relative"
        {...swipeHandlers}
      >
        {/* Full-screen undo overlay - uses portal to escape stacking context (mobile only, desktop has its own) */}
        {pendingSubmit && displayMode !== 'desktop' && ReactDOM.createPortal(
          <div
            className="fixed inset-0 z-[9999]"
            onClick={handleUndo}
            onTouchEnd={(e) => { e.preventDefault(); handleUndo(); }}
            style={{ cursor: 'pointer' }}
          />,
          document.body
        )}
        {/* Circle Track Selector - remaining counts by type */}
        <div className={`h-[68px] flex-shrink-0 flex items-center gap-3 px-3 ${darkMode ? 'bg-gray-900/50' : 'bg-white border-b border-gray-200'}`}>
          <button
            onClick={goToPrev}
            disabled={currentIndex === 0}
            className={`text-xl font-bold w-8 h-8 flex items-center justify-center ${
              currentIndex === 0
                ? (darkMode ? 'text-gray-700' : 'text-gray-300')
                : (darkMode ? 'text-gray-300 active:text-white' : 'text-gray-600 active:text-gray-900')
            }`}
          >
            â—€
          </button>
          {(() => {
            const ynCount = questions.filter(q => q.type === 'binary' && !responses[q.id]).length;
            const mcCount = questions.filter(q => q.type === 'multiple' && !responses[q.id]).length;
            const allCount = ynCount + mcCount;

            const switchTrack = (newTrack) => {
              const toggledTrack = selectedTrack === newTrack ? null : newTrack;
              setSelectedTrack(toggledTrack);
              if (toggledTrack && currentQuestion?.type !== toggledTrack) {
                const matchIdx = questions.findIndex(q => q.type === toggledTrack && !responses[q.id]);
                if (matchIdx >= 0) setCurrentIndex(matchIdx);
              }
            };

            return (
              <div className="flex-1 flex items-center justify-center gap-3">
                {/* Binary (Y/N) circle - green/red */}
                <div
                  className={`q-circle q-circle-binary ${selectedTrack === 'binary' ? 'q-circle-current' : ''} ${selectedTrack && selectedTrack !== 'binary' ? 'q-circle-adjacent' : ''}`}
                  onClick={() => switchTrack('binary')}
                  style={{ cursor: 'pointer' }}
                >
                  <div className={`q-circle-inner ${TH('bg-card-full', darkMode)}`}>
                    {ynCount > 0 ? ynCount : 'âœ“'}
                  </div>
                </div>
                {/* MC circle - 5 colors */}
                <div
                  className={`q-circle q-circle-mc ${selectedTrack === 'multiple' ? 'q-circle-current' : ''} ${selectedTrack && selectedTrack !== 'multiple' ? 'q-circle-adjacent' : ''}`}
                  onClick={() => switchTrack('multiple')}
                  style={{ cursor: 'pointer' }}
                >
                  <div className={`q-circle-inner ${TH('bg-card-full', darkMode)}`}>
                    {mcCount > 0 ? mcCount : 'âœ“'}
                  </div>
                </div>
                {/* All/Combined circle - white/silver */}
                <div
                  className={`q-circle q-circle-mixed ${!selectedTrack ? 'q-circle-current' : 'q-circle-adjacent'}`}
                  onClick={() => switchTrack(null)}
                  style={{ cursor: 'pointer' }}
                >
                  <div className={`q-circle-inner ${TH('bg-card-full', darkMode)}`}>
                    {allCount > 0 ? allCount : 'âœ“'}
                  </div>
                </div>
              </div>
            );
          })()}
          <button
            onClick={goToNext}
            disabled={!hasNext}
            className={`text-xl font-bold w-8 h-8 flex items-center justify-center ${
              !hasNext
                ? (darkMode ? 'text-gray-700' : 'text-gray-300')
                : (darkMode ? 'text-gray-300 active:text-white' : 'text-gray-600 active:text-gray-900')
            }`}
          >
            â–¶
          </button>
        </div>

        {/* ANSWERED QUESTION VIEW - shows full results (only for questions answered THIS session) */}
        {isAnswered && !pendingSubmit && sessionAnsweredIds.has(currentQuestion.id) ? (
          <AnsweredQuestionView
            question={currentQuestion}
            response={currentResponse}
            results={currentQuestionResults}
            darkMode={darkMode}
            questionFlag={questionFlags[currentQuestion.id]}
            explanation={answerExplanations[currentQuestion.id]}
            onFlagClick={() => setShowQuestionFlagModal(currentQuestion.id)}
            onExplainClick={() => setShowExplanationModal(currentQuestion.id)}
          />
        ) : isAnswered && !pendingSubmit ? (
          /* Previously answered question - show empty space to maintain layout */
          <div className="flex-1 flex flex-col">
            <div className="flex-1" /> {/* Empty space */}
            <div className={`flex-shrink-0 border-t px-4 py-6 ${darkMode ? 'border-gray-800 bg-gray-950' : 'border-gray-200 bg-white'}`}>
              <div className={`text-center text-sm ${TH('text-faint', darkMode)}`}>
                Already answered Â· Use arrows to navigate
              </div>
            </div>
          </div>
        ) : (
          <>
            {/* QUESTION AREA - centered in available space */}
            <div className="flex-1 flex flex-col justify-center px-4 pb-3 overflow-y-auto">
              <QuestionCard
                question={currentQuestion}
                darkMode={darkMode}
                evidenceExpanded={evidenceExpanded}
                onToggleEvidence={() => setEvidenceExpanded(!evidenceExpanded)}
              />
            </div>

            {/* FIXED BOTTOM AREA - answer zones */}
            <div className={`flex-shrink-0 border-t ${darkMode ? 'border-gray-800 bg-gray-950' : 'border-gray-200 bg-white'}`}>

              {/* Undone banner - above buttons, not overlaying */}
              {justUndone && (
                <div className="px-4 pt-3 pb-2">
                  <div className={`rounded-xl px-4 py-3 flex items-center justify-between ${darkMode ? 'bg-amber-500/15 border border-amber-500/50' : 'bg-amber-100 border border-amber-300'}`}>
                    <span className={`text-sm font-bold ${darkMode ? 'text-amber-400' : 'text-amber-700'}`}>
                      Undone â€” tap to change or resubmit
                    </span>
                    <button
                      onClick={clearUndoneState}
                      className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-colors ${
                        darkMode ? 'bg-gray-800 text-gray-300 hover:bg-gray-700' : 'bg-white text-gray-700 hover:bg-gray-50 border border-gray-200'
                      }`}
                    >
                      Clear
                    </button>
                  </div>
                </div>
              )}

              {/* Tip Banner - shows once for new users */}
              {showTips && showGestureHint && !isAnswered && !pendingSubmit && !justUndone && (
                <div className="px-4 pt-2">
                  <TipBanner darkMode={darkMode} onDismiss={() => setShowGestureHint(false)} />
                </div>
              )}

              {/* Answer zone wrapper - UndoBar overlays this area */}
              <div className="relative">
                {/* Y/N UndoBar - positioned at wrapper level, covers answer buttons + action row */}
                {pendingSubmit && isBinary && (
                  <div className="absolute inset-0 z-20">
                    <UndoBar
                      darkMode={darkMode}
                      undoDelay={undoDelay}
                      onUndo={handleUndo}
                      answer={pendingSubmit.answer}
                      confidence={pendingSubmit.confidence}
                      isBinary={true}
                      options={null}
                      fullHeight={true}
                      requireConfirmation={requireConfirmation}
                    />
                  </div>
                )}

                {/* ZONE 1: Answer Buttons */}
                <div className={`relative px-4 ${justUndone ? 'pt-0' : (showTips && showGestureHint && !isAnswered && !pendingSubmit ? 'pt-0' : 'pt-3')}`}>
                  {/* MC UndoBar - covers just the MC buttons area */}
                  {pendingSubmit && !isBinary && (
                    <div className="absolute -left-4 -right-4 top-0 bottom-0 z-20">
                      <UndoBar
                        darkMode={darkMode}
                        undoDelay={undoDelay}
                        onUndo={handleUndo}
                        answer={pendingSubmit.answer}
                        confidence={pendingSubmit.confidence}
                        isBinary={false}
                        options={currentQuestion.options}
                        fullHeight={true}
                        requireConfirmation={requireConfirmation}
                      />
                    </div>
                  )}
                  <div className={pendingSubmit ? 'opacity-60 pointer-events-none' : ''}>
                    {isBinary ? (
                      <BinaryButtons
                        darkMode={darkMode}
                        tappedAnswer={tappedAnswer}
                        tapCount={tapCount}
                        isAnswered={isAnswered}
                        currentResponse={currentResponse}
                        onTap={handleAnswerTap}
                        onRightClick={handleAnswerRightClick}
                        pendingSubmit={pendingSubmit}
                        requireConfirmation={requireConfirmation}
                        onSubmit={submitAnswer}
                        onClear={() => { setTappedAnswer(null); setTapCount(0); }}
                      />
                    ) : (
                      <MCButtons
                        options={currentQuestion.options}
                        darkMode={darkMode}
                        tappedAnswer={tappedAnswer}
                        tapCount={tapCount}
                        isAnswered={isAnswered}
                        currentResponse={currentResponse}
                        onTap={handleAnswerTap}
                        onRightClick={handleAnswerRightClick}
                        pendingSubmit={pendingSubmit}
                        requireConfirmation={requireConfirmation}
                        onSubmit={submitAnswer}
                        onClear={() => { setTappedAnswer(null); setTapCount(0); }}
                      />
                    )}
                  </div>
                </div>

                {/* Action buttons row */}
                <div className={`relative h-[36px] px-4 mt-2 flex items-center justify-center`}>
                  {pendingSubmit ? (
                    /* Undo hint text - colored to match answer */
                    <div
                      onClick={handleUndo}
                      className="cursor-pointer text-sm font-medium"
                      style={{
                        color: isBinary
                          ? (pendingSubmit.answer === 0 ? '#10b981' : '#ef4444')
                          : MC_COLORS[pendingSubmit.answer % MC_COLORS.length]?.hex || '#8b5cf6'
                      }}
                    >
                      Tap anywhere to Undo
                    </div>
                  ) : !isAnswered ? (
                    <div className="flex gap-1.5">
                      <button
                        onClick={() => isBinary ? setShowCantAnswerModal(currentQuestion?.id) : setShowNoneOptionModal(true)}
                        className={`px-4 py-1.5 rounded-lg text-sm transition-colors ${TH('btn-secondary', darkMode)}`}
                      >
                        {isBinary ? "Can't" : "None"}
                      </button>
                      <button
                        onClick={() => setShowExplanationModal(currentQuestion?.id)}
                        className={`px-4 py-1.5 rounded-lg text-sm transition-colors ${
                          answerExplanations[currentQuestion?.id]
                            ? 'bg-amber-900/30 text-amber-400'
                            : darkMode ? 'bg-gray-800/60 text-gray-500 hover:bg-gray-700/60' : 'bg-gray-200 text-gray-500'
                        }`}
                      >
                        Explain
                      </button>
                      <button
                        onClick={skipQuestion}
                        className={`px-4 py-1.5 rounded-lg text-sm transition-colors ${TH('btn-secondary', darkMode)}`}
                      >
                        Skip
                      </button>
                      <button
                        onClick={saveForLater}
                        className={`px-4 py-1.5 rounded-lg text-sm transition-colors ${
                          savedQuestions.has(currentQuestion?.id)
                            ? 'bg-violet-900/30 text-violet-400'
                            : darkMode ? 'bg-gray-800/60 text-gray-500 hover:bg-gray-700/60' : 'bg-gray-200 text-gray-500'
                        }`}
                      >
                        {savedQuestions.has(currentQuestion?.id) ? 'âœ“ Saved' : 'Save'}
                      </button>
                    </div>
                  ) : null}
                </div>
              </div>

              {/* ZONE 3: Community Browse */}
              <div className="px-4 pb-3 pt-1">
                {(() => {
                  // Only show community results after user has answered at least one question this session
                  const hasAnsweredThisSession = sessionAnsweredCategories.size > 0;

                  // Get list of answered questions with results, sorted by answer time (most recent first)
                  const answeredList = questions
                    .filter(q => responses[q.id] && communityResults[q.id])
                    .sort((a, b) => (responses[b.id]?.timestamp || 0) - (responses[a.id]?.timestamp || 0));
                  if (answeredList.length === 0 || !hasAnsweredThisSession) {
                    return (
                      <div className={`h-full flex items-center justify-center text-sm ${TH('text-faint', darkMode)}`}>
                        Swipe for next â†’
                      </div>
                    );
                  }
                  const safeIdx = Math.min(communityBrowseIndex, answeredList.length - 1);
                  const browseQ = answeredList[safeIdx];
                  const browseResponse = responses[browseQ.id];
                  const browseResults = communityResults[browseQ.id];

                  // Get user's answer display
                  const isBinaryQ = browseQ.type === 'binary';
                  const userAnswer = browseResponse?.answer;
                  const userAnswerText = isBinaryQ
                    ? (userAnswer === 0 ? 'YES' : 'NO')
                    : (browseQ.options?.[userAnswer] || '?');
                  const userAnswerColor = isBinaryQ
                    ? (userAnswer === 0 ? 'text-emerald-400' : 'text-rose-400')
                    : 'text-violet-400';

                  // Hidden mode - just a thin expandable line with + button
                  if (communityDisplayMode === 'hidden') {
                    return (
                      <div className="flex items-center justify-center gap-2" onClick={() => { if (pendingSubmit) handleUndo(); }}>
                        <div className={`flex-1 h-px ${TH('bg-elevated', darkMode)}`} />
                        <button
                          onClick={() => { if (pendingSubmit) { handleUndo(); return; } setCommunityDisplayMode('compact'); }}
                          className={`w-8 h-8 rounded-full flex items-center justify-center text-lg font-light ${
                            darkMode ? 'bg-gray-800 text-gray-400 hover:bg-gray-700' : 'bg-gray-200 text-gray-500 hover:bg-gray-300'
                          } transition-colors`}
                        >+</button>
                        <div className={`flex-1 h-px ${TH('bg-elevated', darkMode)}`} />
                      </div>
                    );
                  }

                  // Compact mode with confidence-segmented bars (conf 4 in center, lower outward)
                  const userConf = Math.min(4, Math.max(1, browseResponse?.confidence || 1)) - 1;
                  const total = browseResults?.evaluators?.length || 1;

                  // Build centered confidence bar: conf4 in center, conf3, conf2, conf1 outward
                  const renderCenteredBar = (byConf, colors, maxCount, isUser) => {
                    // Colors: [dark/conf4, mid-dark/conf3, mid-light/conf2, light/conf1]
                    const totalCount = byConf.reduce((a, b) => a + b, 0);
                    if (totalCount === 0) return null;

                    // Calculate widths for each confidence level relative to max
                    const segments = [];
                    for (let i = 0; i <= 3; i++) { // conf1(i=0) to conf4(i=3)
                      if (byConf[i] > 0) {
                        segments.push({
                          width: (byConf[i] / maxCount) * 100,
                          color: colors[i],
                          conf: i
                        });
                      }
                    }
                    // Reverse so conf4 (dark) is first/left, conf1 (light) is last/right
                    segments.reverse();

                    const totalWidth = segments.reduce((a, s) => a + s.width, 0);
                    const emptyWidth = 100 - totalWidth;

                    const showEmpty = emptyWidth > 2; // Only show empty if significant
                    return (
                      <div className="flex-1 h-5 rounded-full overflow-hidden flex" style={{ backgroundColor: showEmpty ? 'transparent' : 'transparent', border: showEmpty ? `1px solid ${colors[0]}40` : 'none' }}>
                        {segments.map((s, i) => {
                          const isUserSeg = isUser && s.conf === userConf;
                          const isLast = i === segments.length - 1;
                          const isFirst = i === 0;
                          // Border radius: rounded on edges, flat in middle
                          const userRadius = isFirst && isLast ? '999px' : isFirst ? '999px 0 0 999px' : isLast ? '0 999px 999px 0' : '0';
                          return (
                            <div key={i} className={`h-full ${isLast ? 'rounded-r-full' : ''} ${isFirst ? 'rounded-l-full' : ''}`} style={{
                              width: showEmpty ? `${s.width}%` : (isLast ? undefined : `${s.width}%`),
                              flex: !showEmpty && isLast ? 1 : undefined,
                              backgroundColor: s.color,
                              ...(isUserSeg ? { border: '3px solid white', borderRadius: userRadius, zIndex: 10, position: 'relative' } : {})
                            }} />
                          );
                        })}
                      </div>
                    );
                  };

                  return (
                    <div
                      className="relative"
                      onTouchStart={(e) => { e.stopPropagation(); e.currentTarget.dataset.touchX = e.touches[0].clientX; }}
                      onTouchEnd={(e) => {
                        e.stopPropagation();
                        // During pending submit (non-grace), any touch should undo
                        if (pendingSubmit) {
                          handleUndo();
                          return;
                        }
                        const startX = parseFloat(e.currentTarget.dataset.touchX);
                        const endX = e.changedTouches[0].clientX;
                        const diff = endX - startX;
                        if (Math.abs(diff) > 50) {
                          if (diff > 0 && safeIdx > 0) setCommunityBrowseIndex(safeIdx - 1);
                          else if (diff < 0 && safeIdx < answeredList.length - 1) setCommunityBrowseIndex(safeIdx + 1);
                        }
                      }}
                      onClick={() => {
                        // During pending submit (non-grace), any click should undo
                        if (pendingSubmit) {
                          handleUndo();
                        }
                      }}
                    >
                      {/* Header with LAST and hide button - clickable to expand */}
                      <div
                        className="flex items-center gap-1 mb-1 cursor-pointer"
                        onClick={() => {
                          if (pendingSubmit) { handleUndo(); return; }
                          setCommunityExpanded(true);
                        }}
                      >
                        <span className={`text-sm font-black uppercase tracking-wide ${TH('text-sky', darkMode)}`}>LAST:</span>
                        <span className={`text-base truncate flex-1 font-medium ${TH('text-bright', darkMode)}`}>{browseQ.text}</span>
                        <button
                          onClick={(e) => { e.stopPropagation(); if (pendingSubmit) { handleUndo(); return; } setCommunityDisplayMode('hidden'); }}
                          className={`w-5 h-5 rounded flex items-center justify-center text-sm shrink-0 ${
                            darkMode ? 'text-gray-500 hover:text-gray-300' : 'text-gray-400 hover:text-gray-600'
                          }`}
                        >âˆ’</button>
                      </div>

                      {/* Content - clickable to expand */}
                      <div
                        className="cursor-pointer"
                        onClick={() => {
                          if (pendingSubmit) { handleUndo(); return; }
                          setCommunityExpanded(true);
                        }}
                      >
                        {isBinaryQ ? (() => {
                          const yesColors = ['#6ee7b7', '#34d399', '#10b981', '#059669'];
                          const noColors = ['#fca5a5', '#f87171', '#ef4444', '#dc2626'];

                          const yesByConf = [0, 0, 0, 0];
                          const noByConf = [0, 0, 0, 0];
                          (browseResults?.evaluators || []).forEach(e => {
                            const conf = Math.min(4, Math.max(1, e.confidence || 1)) - 1;
                            if (e.answer === 0) yesByConf[conf]++;
                            else noByConf[conf]++;
                          });

                          const yesTotal = yesByConf.reduce((a, b) => a + b, 0);
                          const noTotal = noByConf.reduce((a, b) => a + b, 0);
                          const yesPct = Math.round((yesTotal / total) * 100);
                          const noPct = 100 - yesPct;
                          const maxCount = Math.max(yesTotal, noTotal);

                          const rows = yesPct >= noPct
                            ? [{ label: 'Yes', pct: yesPct, byConf: yesByConf, colors: yesColors, isYes: true },
                               { label: 'No', pct: noPct, byConf: noByConf, colors: noColors, isYes: false }]
                            : [{ label: 'No', pct: noPct, byConf: noByConf, colors: noColors, isYes: false },
                               { label: 'Yes', pct: yesPct, byConf: yesByConf, colors: yesColors, isYes: true }];

                          return (
                            <div className="space-y-1">
                              {rows.map(row => {
                                const isUser = row.isYes ? userAnswer === 0 : userAnswer === 1;
                                return (
                                  <div key={row.label} className="flex items-center gap-1">
                                    <div className="w-14 sm:w-12 flex-shrink-0">
                                      <span className="text-base sm:text-sm font-semibold px-1.5 py-0.5 rounded-full border" style={{ color: row.colors[1], borderColor: isUser ? row.colors[1] : 'transparent' }}>{row.label}</span>
                                    </div>
                                    <span className="text-base sm:text-sm w-8 sm:w-7 font-bold text-right" style={{ color: row.colors[1] }}>{row.pct}</span>
                                    {renderCenteredBar(row.byConf, row.colors, maxCount, isUser)}
                                  </div>
                                );
                              })}
                              <div className={`text-sm text-center pt-1 ${TH('text-subtle', darkMode)}`}>Tap to Expand</div>
                            </div>
                          );
                        })() : (() => {
                          /* MC: show user's pick + top pick, tap to expand all */
                          const optionData = {};
                          (browseResults?.evaluators || []).forEach(e => {
                            if (!optionData[e.answer]) optionData[e.answer] = { total: 0, byConf: [0, 0, 0, 0] };
                            optionData[e.answer].total++;
                            const conf = Math.min(4, Math.max(1, e.confidence || 1)) - 1;
                            optionData[e.answer].byConf[conf]++;
                          });

                          const sorted = Object.entries(optionData).sort((a, b) => b[1].total - a[1].total);
                          const topIdx = parseInt(sorted[0]?.[0] || 0);
                          const secondIdx = parseInt(sorted[1]?.[0] || 0);
                          const showSecond = userAnswer === topIdx ? secondIdx : topIdx;
                          const maxCount = sorted[0]?.[1]?.total || 1;

                          const userPct = Math.round(((optionData[userAnswer]?.total || 0) / total) * 100);
                          const otherPct = Math.round(((optionData[showSecond]?.total || 0) / total) * 100);

                          // Use actual MC_COLORS for each answer
                          const userColors = MC_COLORS[userAnswer % MC_COLORS.length].shades;
                          const otherColors = MC_COLORS[showSecond % MC_COLORS.length].shades;

                          const renderRow = (idx, colors, pct, isUser) => {
                            const data = optionData[idx] || { total: 0, byConf: [0, 0, 0, 0] };
                            const label = browseQ.options?.[idx] || '?';
                            return (
                              <div key={idx} className="flex items-center gap-1">
                                <div style={{ width: '40%' }} className="flex-shrink-0">
                                  <span className="text-base sm:text-sm font-semibold inline-block truncate max-w-full px-1.5 py-0.5 rounded-full border" style={{ color: colors[1], borderColor: isUser ? colors[1] : 'transparent' }}>{label}</span>
                                </div>
                                <span className="text-base sm:text-sm w-8 sm:w-7 font-bold text-right" style={{ color: colors[1] }}>{pct}</span>
                                {renderCenteredBar(data.byConf, colors, maxCount, isUser)}
                              </div>
                            );
                          };

                          const rowsOrdered = userPct >= otherPct
                            ? [{ idx: userAnswer, colors: userColors, pct: userPct, isUser: true },
                               { idx: showSecond, colors: otherColors, pct: otherPct, isUser: false }]
                            : [{ idx: showSecond, colors: otherColors, pct: otherPct, isUser: false },
                               { idx: userAnswer, colors: userColors, pct: userPct, isUser: true }];

                          return (
                            <div className="space-y-1">
                              {rowsOrdered.map(r => renderRow(r.idx, r.colors, r.pct, r.isUser))}
                              <div className={`text-sm text-center pt-1 ${TH('text-subtle', darkMode)}`}>Tap to Expand</div>
                            </div>
                          );
                        })()}
                      </div>
                      <div
                        className={`h-px mt-2 cursor-pointer ${darkMode ? 'bg-gray-700' : 'bg-gray-300'}`}
                        onClick={() => {
                          if (pendingSubmit) { handleUndo(); return; }
                          setCommunityExpanded(true);
                        }}
                      />

                      {/* Expanded slide-up panel */}
                      {communityExpanded && (() => {
                        const allRows = [];

                        if (isBinaryQ) {
                          const yesColors = ['#6ee7b7', '#34d399', '#10b981', '#059669'];
                          const noColors = ['#fca5a5', '#f87171', '#ef4444', '#dc2626'];
                          const yesByConf = [0, 0, 0, 0];
                          const noByConf = [0, 0, 0, 0];
                          (browseResults?.evaluators || []).forEach(e => {
                            const conf = Math.min(4, Math.max(1, e.confidence || 1)) - 1;
                            if (e.answer === 0) yesByConf[conf]++;
                            else noByConf[conf]++;
                          });
                          const yesTotal = yesByConf.reduce((a, b) => a + b, 0);
                          const noTotal = noByConf.reduce((a, b) => a + b, 0);
                          const yesPct = Math.round((yesTotal / total) * 100);
                          const noPct = 100 - yesPct;
                          const maxCount = Math.max(yesTotal, noTotal);

                          allRows.push({ label: 'Yes', pct: yesPct, byConf: yesByConf, colors: yesColors, isUser: userAnswer === 0, maxCount });
                          allRows.push({ label: 'No', pct: noPct, byConf: noByConf, colors: noColors, isUser: userAnswer === 1, maxCount });
                          allRows.sort((a, b) => b.pct - a.pct);
                        } else {
                          // MC: show ALL options
                          const optionData = {};
                          (browseResults?.evaluators || []).forEach(e => {
                            if (!optionData[e.answer]) optionData[e.answer] = { total: 0, byConf: [0, 0, 0, 0] };
                            optionData[e.answer].total++;
                            const conf = Math.min(4, Math.max(1, e.confidence || 1)) - 1;
                            optionData[e.answer].byConf[conf]++;
                          });
                          const maxCount = Math.max(...Object.values(optionData).map(d => d.total), 1);

                          // Add all options, sorted by votes
                          browseQ.options?.forEach((opt, idx) => {
                            const data = optionData[idx] || { total: 0, byConf: [0, 0, 0, 0] };
                            const pct = Math.round((data.total / total) * 100);
                            const colors = MC_COLORS[idx % MC_COLORS.length].shades;
                            allRows.push({ label: opt, pct, byConf: data.byConf, colors, isUser: userAnswer === idx, maxCount, idx });
                          });
                          allRows.sort((a, b) => b.pct - a.pct);
                        }

                        return (
                          <div
                            className="fixed inset-0 z-50"
                            onClick={() => setCommunityExpanded(false)}
                          >
                            {/* Slide-up panel - click anywhere closes */}
                            <div
                              className={`absolute bottom-0 left-0 right-0 rounded-t-2xl ${darkMode ? 'bg-gray-900' : 'bg-white'} shadow-2xl`}
                              style={{ animation: 'slideUp 0.2s ease-out' }}
                            >
                              {/* Header - full question text in expanded view */}
                              <div className="px-4 pt-3 pb-1">
                                <div className="flex items-center gap-2 mb-1">
                                  <span className={`text-sm font-black uppercase tracking-wide ${TH('text-sky', darkMode)}`}>LAST:</span>
                                  <span className={`text-sm ${TH('text-subtle', darkMode)}`}>{total} responses</span>
                                </div>
                                <p className={`text-base font-medium ${TH('text-bright', darkMode)}`}>{browseQ.text}</p>
                              </div>

                              {/* All rows - same format as compact */}
                              <div className="px-4 pb-4 pt-2 space-y-1">
                                {allRows.map((row, i) => (
                                  <div key={i} className="flex items-center gap-1">
                                    <div className={isBinaryQ ? 'w-14 sm:w-12' : 'w-[40%]'} style={{ flexShrink: 0 }}>
                                      <span className="text-base sm:text-sm font-semibold inline-block truncate max-w-full px-1.5 py-0.5 rounded-full border"
                                        style={{ color: row.colors[1], borderColor: row.isUser ? row.colors[1] : 'transparent' }}>
                                        {row.label}
                                      </span>
                                    </div>
                                    <span className="text-base sm:text-sm w-8 sm:w-7 font-bold text-right" style={{ color: row.colors[1] }}>{row.pct}</span>
                                    {renderCenteredBar(row.byConf, row.colors, row.maxCount, row.isUser)}
                                  </div>
                                ))}
                              </div>

                              {/* Tap hint */}
                              <div className={`text-sm text-center pb-4 ${TH('text-faint', darkMode)}`}>
                                tap anywhere to close
                              </div>
                            </div>
                          </div>
                        );
                      })()}
                    </div>
                  );
                })()}
              </div>
            </div>
          </>
        )}

        {/* Full Results Modal */}
        {showFullResults && (() => {
          const answeredList = questions
            .filter(q => responses[q.id] && communityResults[q.id])
            .sort((a, b) => (responses[b.id]?.timestamp || 0) - (responses[a.id]?.timestamp || 0));
          const currentIdx = answeredList.findIndex(q => q.id === showFullResults.question.id);
          const goTo = (idx) => {
            if (idx >= 0 && idx < answeredList.length) {
              const q = answeredList[idx];
              setShowFullResults({ question: q, results: communityResults[q.id], response: responses[q.id] });
            }
          };
          return (
            <FullResultsPanel
              question={showFullResults.question}
              results={showFullResults.results}
              userResponse={showFullResults.response}
              darkMode={darkMode}
              onClose={() => setShowFullResults(null)}
              onSwipeLeft={() => goTo(currentIdx + 1)}
              onSwipeRight={() => goTo(currentIdx - 1)}
            />
          );
        })()}

        {/* Question Flag Modal */}
        {showQuestionFlagModal && (
          <QuestionFlagModal
            darkMode={darkMode}
            questionId={showQuestionFlagModal}
            onClose={() => setShowQuestionFlagModal(null)}
            onFlag={handleQuestionFlag}
            onClear={handleClearQuestionFlag}
            existingFlag={questionFlags[showQuestionFlagModal]}
          />
        )}

        {/* Explanation Modal */}
        {showExplanationModal && (
          <ExplanationModal
            darkMode={darkMode}
            questionId={showExplanationModal}
            onClose={() => setShowExplanationModal(null)}
            onSave={handleSaveExplanation}
            onClear={handleClearExplanation}
            existingExplanation={answerExplanations[showExplanationModal]}
          />
        )}

        {/* Can't Answer Modal (binary) */}
        {showCantAnswerModal && (
          <CantAnswerModal
            darkMode={darkMode}
            questionId={showCantAnswerModal}
            onClose={() => setShowCantAnswerModal(null)}
            onSkip={(qId, reason) => {
              setQuestionFlags(prev => ({ ...prev, [qId]: `Can't: ${reason}` }));
              setSkippedQuestions(prev => new Set([...prev, qId]));
              goToNext();
            }}
          />
        )}

        {/* None Option Modal (MC) */}
        {showNoneOptionModal && (
          <NoneOptionModal
            darkMode={darkMode}
            questionId={currentQuestion?.id}
            onClose={() => setShowNoneOptionModal(false)}
            onSubmit={(qId, answer) => {
              setQuestionFlags(prev => ({ ...prev, [qId]: `None fit: ${answer}` }));
              setSkippedQuestions(prev => new Set([...prev, qId]));
              goToNext();
            }}
          />
        )}
      </div>
    );
  };

  if (displayMode === 'desktop') {
    return (
      <>
        {/* Undo overlay - covers entire viewport during ANY pending state */}
        {pendingSubmit && (
          <div
            className="fixed inset-0 z-[9999] bg-transparent"
            onClick={handleUndo}
            onMouseDown={handleUndo}
            style={{ cursor: 'pointer', background: 'transparent' }}
          />
        )}
        <PhoneFrame darkMode={darkMode}>
          {/* Global stars background for dark mode */}
          {darkMode && <div className="global-stars" />}
          <div className="flex-1 flex flex-col overflow-hidden">
            {screen !== 'launch' && screen !== 'settings' && screen !== 'categories' && (
              <NavBar darkMode={darkMode} stats={stats} showStreak={showStreak} onHome={() => setScreen('categories')} onDoubleClickHome={resetDemo} onSettings={goToSettings} onProfile={() => setScreen('profile')} />
            )}
            {renderContent()}
          </div>
        </PhoneFrame>
      </>
    );
  }

  return (
    <div
      className={`h-full flex flex-col ${TH('bg-main', darkMode)}`}
      onClickCapture={(e) => {
        if (pendingSubmit) {
          e.stopPropagation();
          handleUndo();
        }
      }}
    >
      {/* Global stars background for dark mode */}
      {darkMode && <div className="global-stars" />}
      {screen !== 'launch' && screen !== 'settings' && screen !== 'categories' && (
        <div className="safe-top">
          <NavBar darkMode={darkMode} stats={stats} showStreak={showStreak} onHome={() => setScreen('categories')} onDoubleClickHome={resetDemo} onSettings={goToSettings} onProfile={() => setScreen('profile')} />
        </div>
      )}
      <div className="flex-1 flex flex-col overflow-hidden">{renderContent()}</div>
      <div className="safe-bottom" />
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
