<!DOCTYPE html>
<!--
  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
  â•‘  AURA PLAYER â€” CODE MAP                                     â•‘
  â•‘  Cmd+F the quoted search terms to jump to any section        â•‘
  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  FILE LAYOUT
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  <style>            CSS reset, animations, hover glows, shine effects
  <script> #1        Tailwind CDN warning suppression
  <script> #2        Questions database + onboarding questions
  <script> #3        Supabase config, sync, auth helpers
  <script babel>     Main React app (everything below)

  REACT APP SECTIONS â€” search: "== SECTION NAME =="
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  Foundation
  Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·
  "UNIFIED COLOR SYSTEM"       COLOR_HEX, twColor, BINARY_COLORS
  "CONFIDENCE HELPERS"         normalizeConf
  "THEME TOKENS"               TH() dark/light class helper
  "HELPERS"                    hexToRgba

  Data & Config
  Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·
  "AURA VISUALIZATION"         AuraVisualization canvas component
  "DATA"                       CATEGORIES, MC_COLORS, scoring, community results
  "DEMO PRE-POPULATION"        Demo data seeding
  "ASSESSMENTS DATA"           ASSESS_SCALES
  "ASSESSMENTS"                ASSESS_TESTS (full test definitions)
  "ARCHETYPE SYSTEM"           ARCHETYPES, pattern matching, descriptions
  "ASSESSMENT COLORS"          ASSESS_C, ASSESS_STYLES, PROGRESS_GRADIENTS
  "STORAGE"                    localStorage helpers
  "GAMIFICATION SYSTEM"        XP, levels, streaks

  Hooks & Components
  Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·
  "HOOKS"                      useDisplayMode, useSwipe, custom React hooks
  "ENTITY GATE SCREEN"         EntityGateScreen (one-time visitor type declaration)
  "COMPONENTS"                 ProgressCircle, PhoneFrame, NavBar, WelcomeScreen
  "ASSESSMENT PRIMITIVES"      QuestionCard, ResultsChart, analysis helpers
  "ONBOARDING FLOW"            OnboardingFlow component
  "PATH CHOICE SCREEN"         PathChoiceScreen, modals, CategoryScreen

  Verification
  Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·
  "VERIFICATION DATA LAYER"    Mock subjects, storage, helpers
  "VERIFICATION COMPONENTS"    VerifyHub, VerifyEvaluatorFlow, VerifyExpertForm (Express), VerifyEvalSummary

  Extracted Screen Components
  Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·
  "SCREEN COMPONENTS"          SharePicker, PublicProfileScreen, StampRow,
                               HistoryScreen, QotdScreen, ProfileScreen,
                               AssessPickerScreen, AssessQuestionScreen
  "ASSESS RESULTS SCREEN"      AssessResultsScreen, AssessAnalysisScreen
  "QUESTION FLOW SCREEN"       QuestionFlowScreen

  Custom Hooks (above App)
  Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·
  useQotd                      QOTD state + handlers (4 state, 3 handlers)
  useVerification              Verification state + persistence (5 state, ref, effect)
  useAssessment                Assessment state + handlers (21 state, 14 handlers)
                               Accepts { setScreen, darkMode }

  App
  Â·Â·Â·
  "ERROR BOUNDARY"             ErrorBoundary class component
  "MAIN APP"                   function App() â€” remaining state, effects, render
    renderContent()              Screen router (if/return chain)
    "DEV NAVIGATION PANEL"       Dev-only screen switcher

  KEY CONSTANTS
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const COLOR_HEX        All color definitions (single source of truth)
  const TH               Theme helper â€” TH('token', darkMode) â†’ Tailwind classes
  const ASSESS_C         Assessment category â†’ color mapping
  const ASSESS_TESTS     Full assessment test definitions
  const ARCHETYPES       29 personality archetype patterns
  const Q_RAW            All questions array

  KEY PATTERNS
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  â€¢ Screens: if (screen === 'x') return <XScreen .../> in renderContent()
  â€¢ Theme:   TH('token', darkMode) returns Tailwind classes
  â€¢ Colors:  ASSESS_C[color] for assessment colors, COLOR_HEX[name] for raw hex
  â€¢ Storage: localStorage key 'aura-demo-vI' for main data
  â€¢ Hooks:   useQotd(), useVerification(), useAssessment({ setScreen, darkMode })
-->
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Aura">
  <meta name="theme-color" content="#030712">
  <meta property="og:title" content="Compare Auras â€” What's your personality?">
  <meta property="og:description" content="Take a 60-second personality quiz and compare with friends. See where you land on the Big Five.">
  <meta property="og:type" content="website">
  <meta property="og:image" content="https://auraplayer.com/og-card.png">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Compare Auras â€” What's your personality?">
  <meta name="twitter:description" content="Take a 60-second personality quiz and compare with friends.">
  <meta name="twitter:image" content="https://auraplayer.com/og-card.png">
  <title>Aura Player</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.49.1"></script>
  <style>
    :root {
      --sat: env(safe-area-inset-top);
      --sar: env(safe-area-inset-right);
      --sab: env(safe-area-inset-bottom);
      --sal: env(safe-area-inset-left);
    }
    html, body, #root {
      overflow: hidden;
      overscroll-behavior: none;
      -webkit-overflow-scrolling: touch;
      height: 100%;
      width: 100%;
      margin: 0;
      padding: 0;
      background: #030712;
    }
    * {
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
      box-sizing: border-box;
      overflow-x: clip;
    }
    @media (prefers-color-scheme: dark) {
      :root { color-scheme: dark; }
    }
    .question-text {
      font-size: clamp(20px, 6vw, 28px);
      line-height: 1.35;
      text-wrap: balance;
    }
    .safe-top { padding-top: env(safe-area-inset-top); }
    .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
    @keyframes fill { from { width: 100%; } to { width: 0%; } }
    @keyframes shrink { from { width: 100%; } to { width: 0%; } }
    @keyframes barGrow { from { transform: scaleX(0); } to { transform: scaleX(1); } }
    @keyframes bloom-in { from { opacity: 0; transform: scale(0.3); } to { opacity: 1; transform: scale(1); } }
    @keyframes fadeSlideIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    @keyframes sweepFill { from { width: 0%; } to { width: 100%; } }
    @keyframes ringCountdown { from { stroke-dashoffset: 0; } to { stroke-dashoffset: 75.4; } }
    @keyframes shimmer-pulse {
      0%, 100% { opacity: 0.4; }
      50% { opacity: 0.8; }
    }
    .shine-card { position: relative; }
    .shine-card::before {
      content: '';
      position: absolute;
      inset: -1px;
      border-radius: inherit;
      background: linear-gradient(180deg, var(--accent-bright, rgba(255,255,255,0.5)) 0%, var(--accent-color, rgba(255,255,255,0.2)) 5%, transparent 15%, transparent 100%);
      -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      padding: 2px;
      pointer-events: none;
      z-index: 20;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    .shine-card::after {
      content: '';
      position: absolute;
      inset: -1px;
      border-radius: inherit;
      background: linear-gradient(0deg, var(--accent-bright, rgba(255,255,255,0.5)) 0%, var(--accent-color, rgba(255,255,255,0.2)) 5%, transparent 15%, transparent 100%);
      -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      padding: 2px;
      pointer-events: none;
      z-index: 20;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    .shine-card:hover::before, .shine-card:hover::after { opacity: 1; animation: shimmer-pulse 3s ease-in-out infinite; }
    .shine-card:hover::after { animation-delay: 1.5s; }
    .shine-card:active::before, .shine-card:active::after { opacity: 1; animation: none; }
    .shine-card:active::before { background: linear-gradient(180deg, var(--accent-bright, rgba(255,255,255,0.8)) 0%, var(--accent-color, rgba(255,255,255,0.4)) 8%, transparent 20%, transparent 100%); }
    .shine-card:active::after { background: linear-gradient(0deg, var(--accent-bright, rgba(255,255,255,0.8)) 0%, var(--accent-color, rgba(255,255,255,0.4)) 8%, transparent 20%, transparent 100%); }
    .shine-blue { --accent-color: rgba(59, 130, 246, 0.3); --accent-bright: rgba(147, 197, 253, 0.6); }
    .shine-amber { --accent-color: rgba(251, 191, 36, 0.2); --accent-bright: rgba(253, 224, 71, 0.45); }
    .shine-violet { --accent-color: rgba(139, 92, 246, 0.25); --accent-bright: rgba(196, 181, 253, 0.55); }
    .shine-teal { --accent-color: rgba(45, 212, 191, 0.2); --accent-bright: rgba(153, 246, 228, 0.5); }
    .shine-cyan { --accent-color: rgba(6, 182, 212, 0.25); --accent-bright: rgba(103, 232, 249, 0.55); }
    .shine-gray { --accent-color: rgba(156, 163, 175, 0.2); --accent-bright: rgba(209, 213, 219, 0.45); }
    .shine-emerald { --accent-color: rgba(16, 185, 129, 0.25); --accent-bright: rgba(110, 231, 183, 0.55); }
    .shine-rose { --accent-color: rgba(244, 63, 94, 0.25); --accent-bright: rgba(251, 113, 133, 0.55); }
    .glow-amber { box-shadow: 0 0 15px rgba(251, 191, 36, 0.12), 0 0 35px rgba(251, 191, 36, 0.08), 0 0 60px rgba(251, 191, 36, 0.04); }
    .glow-violet { box-shadow: 0 0 18px rgba(139, 92, 246, 0.2), 0 0 40px rgba(139, 92, 246, 0.12), 0 0 70px rgba(139, 92, 246, 0.06); }
    .glow-teal { box-shadow: 0 0 18px rgba(45, 212, 191, 0.16), 0 0 40px rgba(45, 212, 191, 0.1), 0 0 70px rgba(45, 212, 191, 0.05); }
    .glow-cyan { box-shadow: 0 0 18px rgba(6, 182, 212, 0.16), 0 0 40px rgba(6, 182, 212, 0.1), 0 0 70px rgba(6, 182, 212, 0.05); }
    .glow-blue { box-shadow: 0 0 20px rgba(59, 130, 246, 0.2), 0 0 45px rgba(59, 130, 246, 0.12), 0 0 75px rgba(59, 130, 246, 0.06); }
    .glow-gray { box-shadow: 0 0 18px rgba(156, 163, 175, 0.12), 0 0 40px rgba(156, 163, 175, 0.08), 0 0 70px rgba(156, 163, 175, 0.04); }
    .glow-emerald { box-shadow: 0 0 18px rgba(16, 185, 129, 0.16), 0 0 40px rgba(16, 185, 129, 0.1), 0 0 70px rgba(16, 185, 129, 0.05); }
    .glow-rose { box-shadow: 0 0 18px rgba(244, 63, 94, 0.16), 0 0 40px rgba(244, 63, 94, 0.1), 0 0 70px rgba(244, 63, 94, 0.05); }

    /* Light theme glow overrides â€” tighter shadows + subtle accent border for definition on white */
    .light-theme .glow-amber { box-shadow: 0 0 8px rgba(251, 191, 36, 0.18), 0 0 20px rgba(251, 191, 36, 0.10); }
    .light-theme .glow-violet { box-shadow: 0 0 10px rgba(139, 92, 246, 0.22), 0 0 24px rgba(139, 92, 246, 0.12); }
    .light-theme .glow-teal { box-shadow: 0 0 10px rgba(45, 212, 191, 0.20), 0 0 24px rgba(45, 212, 191, 0.10); }
    .light-theme .glow-cyan { box-shadow: 0 0 10px rgba(6, 182, 212, 0.20), 0 0 24px rgba(6, 182, 212, 0.10); }
    .light-theme .glow-blue { box-shadow: 0 0 12px rgba(59, 130, 246, 0.22), 0 0 28px rgba(59, 130, 246, 0.12); }
    .light-theme .glow-gray { box-shadow: 0 0 10px rgba(156, 163, 175, 0.16), 0 0 24px rgba(156, 163, 175, 0.08); }
    .light-theme .glow-emerald { box-shadow: 0 0 10px rgba(16, 185, 129, 0.20), 0 0 24px rgba(16, 185, 129, 0.10); }
    .light-theme .glow-rose { box-shadow: 0 0 10px rgba(244, 63, 94, 0.20), 0 0 24px rgba(244, 63, 94, 0.10); }

    /* Light theme shine overrides â€” higher opacity for visibility on white */
    .light-theme .shine-blue { --accent-color: rgba(59, 130, 246, 0.45); --accent-bright: rgba(147, 197, 253, 0.75); }
    .light-theme .shine-amber { --accent-color: rgba(251, 191, 36, 0.35); --accent-bright: rgba(253, 224, 71, 0.6); }
    .light-theme .shine-violet { --accent-color: rgba(139, 92, 246, 0.4); --accent-bright: rgba(196, 181, 253, 0.7); }
    .light-theme .shine-teal { --accent-color: rgba(45, 212, 191, 0.35); --accent-bright: rgba(153, 246, 228, 0.65); }
    .light-theme .shine-cyan { --accent-color: rgba(6, 182, 212, 0.4); --accent-bright: rgba(103, 232, 249, 0.7); }
    .light-theme .shine-gray { --accent-color: rgba(156, 163, 175, 0.35); --accent-bright: rgba(209, 213, 219, 0.6); }
    .light-theme .shine-emerald { --accent-color: rgba(16, 185, 129, 0.4); --accent-bright: rgba(110, 231, 183, 0.7); }
    .light-theme .shine-rose { --accent-color: rgba(244, 63, 94, 0.4); --accent-bright: rgba(251, 113, 133, 0.7); }

    /* Hover glow classes - subtle color-matched glow on hover/hold */
    /* Uses ::before overlay so it works even on elements with inline styles */
    /* :not(.shine-card) prevents conflict â€” shine-card has its own ::before/::after shimmer */
    .hover-glow:not(.shine-card) { position: relative; isolation: isolate; }
    .hover-glow:not(.shine-card)::before {
      content: ''; position: absolute; inset: 0; border-radius: inherit;
      opacity: 0; transition: opacity 0.2s ease; pointer-events: none; z-index: -1;
    }
    .hover-glow:not(.shine-card):hover::before, .hover-glow:not(.shine-card):active::before { opacity: 1; }
    .hover-glow-amber:not(.shine-card)::before { background-color: rgba(251, 191, 36, 0.08); box-shadow: inset 0 0 0 1px rgba(251, 191, 36, 0.3); }
    .hover-glow-violet:not(.shine-card)::before { background-color: rgba(139, 92, 246, 0.08); box-shadow: inset 0 0 0 1px rgba(139, 92, 246, 0.3); }
    .hover-glow-teal:not(.shine-card)::before { background-color: rgba(45, 212, 191, 0.08); box-shadow: inset 0 0 0 1px rgba(45, 212, 191, 0.3); }
    .hover-glow-cyan:not(.shine-card)::before { background-color: rgba(6, 182, 212, 0.08); box-shadow: inset 0 0 0 1px rgba(6, 182, 212, 0.3); }
    .hover-glow-blue:not(.shine-card)::before { background-color: rgba(59, 130, 246, 0.08); box-shadow: inset 0 0 0 1px rgba(59, 130, 246, 0.3); }
    .hover-glow-gray:not(.shine-card)::before { background-color: rgba(156, 163, 175, 0.08); box-shadow: inset 0 0 0 1px rgba(156, 163, 175, 0.3); }
    .hover-glow-emerald:not(.shine-card)::before { background-color: rgba(16, 185, 129, 0.08); box-shadow: inset 0 0 0 1px rgba(16, 185, 129, 0.3); }
    .hover-glow-rose:not(.shine-card)::before { background-color: rgba(244, 63, 94, 0.08); box-shadow: inset 0 0 0 1px rgba(244, 63, 94, 0.3); }
    .hover-glow-pink:not(.shine-card)::before { background-color: rgba(236, 72, 153, 0.08); box-shadow: inset 0 0 0 1px rgba(236, 72, 153, 0.3); }
    .hover-glow-slate:not(.shine-card)::before { background-color: rgba(100, 116, 139, 0.08); box-shadow: inset 0 0 0 1px rgba(100, 116, 139, 0.3); }
    .hover-glow-sky:not(.shine-card)::before { background-color: rgba(14, 165, 233, 0.08); box-shadow: inset 0 0 0 1px rgba(14, 165, 233, 0.3); }
    .hover-glow-indigo:not(.shine-card)::before { background-color: rgba(99, 102, 241, 0.08); box-shadow: inset 0 0 0 1px rgba(99, 102, 241, 0.3); }

    /* Light theme hover glow overrides â€” ~3x opacity, tighter inset shadow */
    .light-theme .hover-glow-amber:not(.shine-card)::before { background-color: rgba(251, 191, 36, 0.15); box-shadow: inset 0 0 0 1.5px rgba(251, 191, 36, 0.4); }
    .light-theme .hover-glow-violet:not(.shine-card)::before { background-color: rgba(139, 92, 246, 0.15); box-shadow: inset 0 0 0 1.5px rgba(139, 92, 246, 0.4); }
    .light-theme .hover-glow-teal:not(.shine-card)::before { background-color: rgba(45, 212, 191, 0.15); box-shadow: inset 0 0 0 1.5px rgba(45, 212, 191, 0.4); }
    .light-theme .hover-glow-cyan:not(.shine-card)::before { background-color: rgba(6, 182, 212, 0.15); box-shadow: inset 0 0 0 1.5px rgba(6, 182, 212, 0.4); }
    .light-theme .hover-glow-blue:not(.shine-card)::before { background-color: rgba(59, 130, 246, 0.15); box-shadow: inset 0 0 0 1.5px rgba(59, 130, 246, 0.4); }
    .light-theme .hover-glow-gray:not(.shine-card)::before { background-color: rgba(156, 163, 175, 0.15); box-shadow: inset 0 0 0 1.5px rgba(156, 163, 175, 0.4); }
    .light-theme .hover-glow-emerald:not(.shine-card)::before { background-color: rgba(16, 185, 129, 0.15); box-shadow: inset 0 0 0 1.5px rgba(16, 185, 129, 0.4); }
    .light-theme .hover-glow-rose:not(.shine-card)::before { background-color: rgba(244, 63, 94, 0.15); box-shadow: inset 0 0 0 1.5px rgba(244, 63, 94, 0.4); }
    .light-theme .hover-glow-pink:not(.shine-card)::before { background-color: rgba(236, 72, 153, 0.15); box-shadow: inset 0 0 0 1.5px rgba(236, 72, 153, 0.4); }
    .light-theme .hover-glow-slate:not(.shine-card)::before { background-color: rgba(100, 116, 139, 0.15); box-shadow: inset 0 0 0 1.5px rgba(100, 116, 139, 0.4); }
    .light-theme .hover-glow-sky:not(.shine-card)::before { background-color: rgba(14, 165, 233, 0.15); box-shadow: inset 0 0 0 1.5px rgba(14, 165, 233, 0.4); }
    .light-theme .hover-glow-indigo:not(.shine-card)::before { background-color: rgba(99, 102, 241, 0.15); box-shadow: inset 0 0 0 1.5px rgba(99, 102, 241, 0.4); }

    .starry-bg {
      background: linear-gradient(135deg, rgba(30, 20, 10, 0.9) 0%, rgba(50, 30, 15, 0.8) 100%);
      position: relative;
    }
    .starry-bg::before {
      content: '';
      position: absolute;
      inset: 0;
      background-image: radial-gradient(1px 1px at 20px 30px, white, transparent),
        radial-gradient(1px 1px at 40px 70px, rgba(255,255,255,0.8), transparent),
        radial-gradient(1px 1px at 50px 45px, rgba(255,255,255,0.6), transparent),
        radial-gradient(1px 1px at 90px 40px, rgba(255,255,255,0.7), transparent),
        radial-gradient(1px 1px at 130px 55px, white, transparent),
        radial-gradient(1px 1px at 160px 35px, rgba(255,255,255,0.5), transparent),
        radial-gradient(1.5px 1.5px at 200px 50px, rgba(255,255,255,0.9), transparent),
        radial-gradient(1px 1px at 250px 60px, rgba(255,255,255,0.6), transparent),
        radial-gradient(1px 1px at 280px 30px, rgba(255,255,255,0.7), transparent),
        radial-gradient(1px 1px at 300px 70px, white, transparent),
        radial-gradient(1px 1px at 70px 55px, rgba(255,255,255,0.8), transparent),
        radial-gradient(1.5px 1.5px at 110px 25px, white, transparent),
        radial-gradient(1px 1px at 175px 65px, rgba(255,255,255,0.7), transparent),
        radial-gradient(1px 1px at 220px 35px, rgba(255,255,255,0.6), transparent),
        radial-gradient(1px 1px at 260px 50px, white, transparent),
        radial-gradient(1.5px 1.5px at 320px 40px, rgba(255,255,255,0.9), transparent),
        radial-gradient(1px 1px at 35px 60px, rgba(255,255,255,0.5), transparent),
        radial-gradient(1px 1px at 145px 70px, rgba(255,255,255,0.8), transparent);
      opacity: 0.7;
      border-radius: inherit;
    }
    .global-stars {
      position: fixed;
      inset: 0;
      background-image:
        radial-gradient(1px 1px at 50px 100px, rgba(255,255,255,0.3), transparent),
        radial-gradient(1px 1px at 150px 200px, rgba(255,255,255,0.2), transparent),
        radial-gradient(1px 1px at 250px 150px, rgba(255,255,255,0.25), transparent),
        radial-gradient(1px 1px at 100px 350px, rgba(255,255,255,0.2), transparent),
        radial-gradient(1px 1px at 300px 400px, rgba(255,255,255,0.3), transparent),
        radial-gradient(1px 1px at 80px 500px, rgba(255,255,255,0.2), transparent),
        radial-gradient(1px 1px at 200px 550px, rgba(255,255,255,0.25), transparent),
        radial-gradient(1px 1px at 350px 300px, rgba(255,255,255,0.2), transparent),
        radial-gradient(1px 1px at 20px 650px, rgba(255,255,255,0.3), transparent),
        radial-gradient(1px 1px at 280px 700px, rgba(255,255,255,0.2), transparent),
        radial-gradient(1px 1px at 120px 750px, rgba(255,255,255,0.25), transparent),
        radial-gradient(1px 1px at 380px 600px, rgba(255,255,255,0.2), transparent),
        radial-gradient(1.5px 1.5px at 180px 450px, rgba(255,255,255,0.35), transparent),
        radial-gradient(1px 1px at 320px 250px, rgba(255,255,255,0.2), transparent);
      pointer-events: none;
      z-index: 0;
    }
    /* Question type indicator circles */
    .q-circle {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      padding: 3px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }
    .q-circle-inner {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 13px;
    }
    .q-circle-binary {
      background: conic-gradient(#ef4444 0deg 180deg, #10b981 180deg 360deg);
    }
    .q-circle-mc {
      background: conic-gradient(
        #3b82f6 0deg 72deg,
        #8b5cf6 72deg 144deg,
        #14b8a6 144deg 216deg,
        #06b6d4 216deg 288deg,
        #ec4899 288deg 360deg
      );
    }
    .q-circle-mixed {
      background: linear-gradient(135deg, #e2e8f0 0%, #94a3b8 50%, #e2e8f0 100%);
    }
    .q-circle-current {
      width: 48px;
      height: 48px;
    }
    .q-circle-current.q-circle-binary {
      box-shadow: -10px 0 16px rgba(16, 185, 129, 0.35), 10px 0 16px rgba(239, 68, 68, 0.3);
    }
    .q-circle-current.q-circle-mc {
      box-shadow:
        8px -6px 12px rgba(59, 130, 246, 0.3),
        0px -10px 12px rgba(139, 92, 246, 0.3),
        -10px 0 12px rgba(20, 184, 166, 0.27),
        -6px 8px 12px rgba(6, 182, 212, 0.27),
        6px 8px 12px rgba(236, 72, 153, 0.3);
    }
    .q-circle-current.q-circle-mixed {
      box-shadow: 0 0 16px rgba(226, 232, 240, 0.35), 0 0 24px rgba(148, 163, 184, 0.24);
    }
    .q-circle-adjacent {
      opacity: 0.6;
    }
    .q-circle:hover {
      transform: scale(1.1);
      filter: brightness(1.1);
    }
    .q-circle:active {
      transform: scale(0.95);
    }
    /* Subtle scrollbars globally â€” thin, translucent, not distracting */
    * { scrollbar-width: thin; scrollbar-color: rgba(255,255,255,0.08) transparent; }
    ::-webkit-scrollbar { width: 3px; height: 3px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.10); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.18); }
    @media (prefers-color-scheme: light) {
      * { scrollbar-color: rgba(0,0,0,0.10) transparent; }
      ::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.10); }
      ::-webkit-scrollbar-thumb:hover { background: rgba(0,0,0,0.18); }
    }
    /* Hide scrollbar completely */
    .hide-scrollbar::-webkit-scrollbar { display: none; }
    .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    /* Orbit animation */
    @keyframes orbitRing { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .orbit-anim { animation: orbitRing 0.6s ease-out; }
    /* Countdown animation - fills left to right */
    @keyframes countdownFill { from { transform: scaleX(0); } to { transform: scaleX(1); } }
    /* Assessment celebration animations */
    @keyframes celebrateGlow {
      0% { transform: scale(0.8); opacity: 0; }
      50% { transform: scale(1.2); opacity: 1; }
      100% { transform: scale(1); opacity: 1; }
    }
    @keyframes celebrateRing {
      0% { transform: scale(0.5); opacity: 0; stroke-dashoffset: 440; }
      50% { opacity: 1; }
      100% { transform: scale(1); opacity: 1; stroke-dashoffset: 0; }
    }
    @keyframes celebratePulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    .celebrate-glow { animation: celebrateGlow 0.6s ease-out forwards; }
    .celebrate-ring { animation: celebrateRing 0.8s ease-out forwards; }
    .celebrate-pulse { animation: celebratePulse 1s ease-in-out infinite; }
    /* Button hover/touch feedback - !important to override Tailwind */
    .btn-feedback {
      transition: transform 0.1s ease, filter 0.1s ease !important;
    }
    .btn-feedback:hover {
      filter: brightness(1.15) !important;
    }
    .btn-feedback:active {
      transform: scale(0.96) !important;
      filter: brightness(0.92) !important;
    }
    @media (hover: none) {
      .btn-feedback:hover {
        filter: none !important;
      }
    }
    @keyframes aura-breathe {
      0%, 100% { transform: scale(0.94); opacity: 0.85; }
      50% { transform: scale(1.06); opacity: 1; }
    }
    /* Assessment question transition â€” slow breath on new question */
    @keyframes assess-glow-breath {
      0% { opacity: 0.25; }
      35% { opacity: 1; }
      100% { opacity: 0.85; }
    }
    @keyframes assess-btn-breath {
      0% { opacity: 0.35; }
      35% { opacity: 1; }
      100% { opacity: 1; }
    }
    .assess-entering .assess-glow { animation: assess-glow-breath 1.6s cubic-bezier(0.25, 0.1, 0.25, 1) both; }
    .assess-entering .assess-btns > * { animation: assess-btn-breath 1.6s cubic-bezier(0.25, 0.1, 0.25, 1) both; }
    @keyframes star-twinkle {
      0%, 100% { opacity: 0.3; }
      50% { opacity: 0.8; }
    }

    /* === RESPONSIVE BUTTON SIZING ===
       Scales touch targets and spacing to viewport width on actual mobile.
       Desktop/PhoneFrame keeps current fixed values. */
    @media (max-width: 768px) {
      /* Assessment answer buttons â€” uses existing .assess-btns class */
      .assess-btns {
        padding-left: clamp(12px, 4.2vw, 24px) !important;
        padding-right: clamp(12px, 4.2vw, 24px) !important;
        padding-bottom: clamp(12px, 4.2vw, 24px) !important;
      }
      .assess-btns > button {
        padding-top: clamp(12px, 3.6vw, 18px) !important;
        padding-bottom: clamp(12px, 3.6vw, 18px) !important;
        padding-left: clamp(14px, 4.2vw, 22px) !important;
        padding-right: clamp(14px, 4.2vw, 22px) !important;
      }
      .assess-btns > * + * {
        margin-top: clamp(6px, 2.2vw, 12px) !important;
      }
      /* Button height utilities â€” scaled for small Android (320px) through Pro Max (430px) */
      .resp-h-lg { height: clamp(52px, 15.5vw, 72px) !important; }
      .resp-h-md { height: clamp(46px, 13.5vw, 64px) !important; }
      .resp-h-sm { height: clamp(36px, 10vw, 44px) !important; }
      /* Container max-width for button groups */
      .resp-max-w { max-width: clamp(320px, 94vw, 460px) !important; }
      /* Stacked button spacing */
      .resp-gap > * + * { margin-top: clamp(10px, 3.4vw, 16px) !important; }
      .resp-gap-sm > * + * { margin-top: clamp(8px, 2.8vw, 14px) !important; }
      /* Responsive text sizes */
      .resp-text-lg { font-size: clamp(16px, 4.3vw, 20px) !important; }
      .resp-text-md { font-size: clamp(14px, 3.8vw, 17px) !important; }
      .resp-text-sm { font-size: clamp(12px, 3.3vw, 14px) !important; }
      /* Container padding */
      .resp-px {
        padding-left: clamp(12px, 4.2vw, 24px) !important;
        padding-right: clamp(12px, 4.2vw, 24px) !important;
      }
    }
  </style>
</head>
<body style="background:#030712">
  <div id="root"></div>
  <script>
// Suppress Tailwind CDN production warning
const _warn = console.warn;
console.warn = (...args) => {
  if (typeof args[0] === 'string' && args[0].includes('cdn.tailwindcss.com')) return;
  _warn.apply(console, args);
};
  </script>
  <script>
// ==================== QUESTIONS DATABASE (INLINE) ====================
const CAT_MAP = {
  p: { id: 'prediction', name: 'Predictions', icon: 'ðŸ”®', color: 'amber' },
  r: { id: 'reasoning', name: 'Reasoning', icon: 'ðŸ§ ', color: 'violet' },
  j: { id: 'judgment', name: 'Judgment', icon: 'âš–ï¸', color: 'emerald' },
};
const T = { b: 'binary', m: 'multiple' };
const C = Object.fromEntries(Object.entries(CAT_MAP).map(([k,v]) => [k, v.id]));
const ev = (t, l, v) => ({ type: t === 's' ? 'stat' : 'note', ...(l && {label: l}), ...(t === 's' ? {value: v} : {text: v}) });

// ==================== QUESTIONS ====================
// RULES:
// 1. NEVER reuse an ID - always increment (current max: 485, next: 486+)
// 2. NEVER delete - set x:1 to archive instead
// 3. Minor edits (typos) OK, major changes = new question with new ID
//
// SCHEMA:
// { id, v (version), t (type: b=binary, m=multiple), c (category: p/r/j),
//   q (text), o (options array), e (evidence), x (archived if truthy) }
//
// CATEGORIES: p=prediction, r=reasoning, j=judgment
// ===================================================
const Q_RAW = [
  { id:1, v:1, t:'b', c:'p', q:"Will Bitcoin exceed $150,000 before July 2026?", e:[ev('s','Current Price','$97,234'), ev('s','ATH','$108,786')] },
  { id:2, v:1, t:'m', c:'r', q:"Is a hot dog a sandwich?", o:["Yes, it's bread with filling","No, it's its own category","It's a taco (single folded bread)","Depends on regional definition"], e:[ev('n',null,'Merriam-Webster: sandwich = "two or more slices of bread with filling"')], x:1},
  { id:3, v:1, t:'b', c:'p', q:"Will GPT-5 be released before September 2026?", e:[ev('s','GPT-4 Release','March 2023')] },
  { id:4, v:1, t:'m', c:'j', q:"Which animal would win in a fight?", o:["100 duck-sized horses","1 horse-sized duck","It depends on the terrain","They'd become friends"] },
  { id:5, v:1, t:'b', c:'j', q:"Is this research methodology sound? (Deepfake detection, n=50)", e:[ev('s','Sample Size','n=50'), ev('s','Claimed Accuracy','95%')], x:1},
  { id:6, v:1, t:'m', c:'p', q:"What will be the dominant AI interface by 2030?", o:["Text chat","Voice assistants","AR/VR agents","Brain-computer interfaces","Autonomous agents"] },
  { id:7, v:1, t:'b', c:'r', q:"Is water wet?", e:[ev('n',null,'Wet = covered in water. Can water cover itself?')], x:1},
  { id:8, v:1, t:'m', c:'j', q:"Best programming language for beginners in 2026?", o:["Python","JavaScript","Scratch/visual coding","Natural language (AI-assisted)","Rust"] },
  { id:9, v:1, t:'b', c:'p', q:"Will humans land on Mars before 2035?", e:[ev('s','SpaceX target','2029'), ev('s','NASA target','2040')] },
  { id:10, v:1, t:'m', c:'r', q:"Is a Pop-Tart a ravioli?", o:["Yes - filling enclosed in carb wrapper","No - ravioli must be savory","No - ravioli must be pasta","It's actually a dumpling"] },
  { id:11, v:1, t:'b', c:'j', q:"Could an average person beat a goose in a fight?", e:[ev('s','Avg goose weight','8-14 lbs')] },
  { id:12, v:1, t:'m', c:'p', q:"Most likely cause of human extinction?", o:["AI/technology","Climate change","Pandemic/bioweapon","Nuclear war","Asteroid impact"] },
  { id:13, v:1, t:'b', c:'p', q:"Will Taylor Swift announce retirement before 2030?" },
  { id:14, v:1, t:'m', c:'j', q:"What should happen to daylight saving time?", o:["Keep switching twice a year","Permanent daylight time","Permanent standard time","Let each state decide"] },
  { id:15, v:1, t:'b', c:'p', q:"Will lab-grown meat achieve price parity by 2028?", e:[ev('s','2013 cost','$330,000/burger'), ev('s','2025 cost','$6/burger')] },
  { id:16, v:1, t:'b', c:'j', q:"Could Batman beat Superman (no prep, no kryptonite)?" },
  { id:17, v:1, t:'m', c:'r', q:"Ship of Theseus: replace every part, same ship?", o:["Yes - continuity of identity","No - it's a new ship","The original uses old parts","Identity is an illusion"] },
  { id:18, v:1, t:'b', c:'p', q:"Will any AI pass an 8-hour Turing test by 2027?" },
  { id:19, v:1, t:'b', c:'r', q:"Is the simulation hypothesis likely?", e:[ev('n',null,"Bostrom's trilemma argument")] },
  { id:20, v:1, t:'m', c:'j', q:"Most important skill for the next decade?", o:["AI/ML literacy","Critical thinking","Emotional intelligence","Adaptability","Domain expertise"] },
  { id:21, v:1, t:'b', c:'r', q:"Is 847 + 256 greater than 1100?", x:1 },
  { id:22, v:1, t:'m', c:'r', q:"What color results from mixing red + blue?", o:["Green","Purple","Orange","Brown"], x:1 },
  { id:23, v:1, t:'b', c:'r', q:"Does 'rhythm' contain a vowel (a,e,i,o,u)?", x:1 },
  { id:24, v:1, t:'m', c:'r', q:"What comes next: 2, 4, 8, 16, __?", o:["24","32","20","18"], x:1 },
  { id:25, v:1, t:'b', c:'r', q:"Is Australia larger than Europe (by land area)?" },
  { id:26, v:1, t:'b', c:'p', q:"Will electric vehicles exceed 50% of US new car sales by 2030?", e:[ev('s','2024 US EV share','~9%')] },
  { id:27, v:1, t:'m', c:'p', q:"Which company will dominate AI by 2030?", o:["OpenAI","Google/DeepMind","Anthropic","Meta","A company that doesn't exist yet"] },
  { id:28, v:1, t:'b', c:'r', q:"Is free will an illusion?" },
  { id:29, v:1, t:'m', c:'j', q:"What's the most ethical diet?", o:["Vegan","Vegetarian","Pescatarian","Local/sustainable omnivore","Lab-grown meat when available"] },
  { id:30, v:1, t:'b', c:'p', q:"Will remote work remain dominant in tech by 2030?" },
  { id:31, v:1, t:'b', c:'j', q:"Should social media require age verification?" },
  { id:32, v:1, t:'m', c:'j', q:"Most overrated tech of the 2020s?", o:["NFTs","Metaverse/VR","Crypto/blockchain","AI assistants","Self-driving cars"] },
  { id:33, v:1, t:'b', c:'p', q:"Will quantum computers break current encryption by 2035?" },
  { id:34, v:1, t:'b', c:'r', q:"Is cereal a soup?" },
  { id:35, v:1, t:'m', c:'j', q:"Best way to make friends as an adult?", o:["Hobbies/clubs","Through work","Apps (Bumble BFF, etc.)","Neighbors/community","Accept loneliness"] },
  { id:36, v:1, t:'b', c:'r', q:"Is 17 a prime number?", x:1 },
  { id:37, v:1, t:'m', c:'r', q:"What is âˆš144?", o:["10","11","12","14"], x:1 },
  { id:38, v:1, t:'b', c:'r', q:"Is the Pacific Ocean the largest ocean?" },
  { id:39, v:1, t:'b', c:'p', q:"Will a woman be elected US President by 2032?", x:1 },
  { id:40, v:1, t:'m', c:'j', q:"What age should you be allowed to vote?", o:["16","18","21","25","Any age"] },
  { id:41, v:1, t:'b', c:'p', q:"Will China's GDP surpass the US by 2035?", e:[ev('s','US GDP (2024)','$28.8T'), ev('s','China GDP (2024)','$18.5T')] },
  { id:42, v:1, t:'b', c:'p', q:"Will commercial fusion power be operational by 2040?" },
  { id:43, v:1, t:'m', c:'p', q:"Which country will lead in AI development by 2035?", o:["United States","China","European Union","India","Distributed/No single leader"] },
  { id:44, v:1, t:'b', c:'p', q:"Will Neuralink have 1,000+ human users by 2030?", e:[ev('s','First implant','January 2024')], x:1 },
  { id:45, v:1, t:'b', c:'p', q:"Will global population decline before 2100?", e:[ev('s','UN projection','Peak ~10.4B in 2086')] },
  { id:46, v:1, t:'m', c:'p', q:"What will cause the next major financial crisis?", o:["AI displacement","Climate disasters","Sovereign debt","Crypto collapse","Geopolitical conflict"] },
  { id:47, v:1, t:'b', c:'p', q:"Will autonomous vehicles be legal in all US states by 2030?" },
  { id:48, v:1, t:'b', c:'p', q:"Will the US return to the Moon before China?", e:[ev('s','Artemis III target','2026'), ev('s','China target','2030')] },
  { id:49, v:1, t:'m', c:'p', q:"What will be the #1 cause of death globally in 2050?", o:["Heart disease","Cancer","Antimicrobial resistance","Climate-related","Mental health/suicide"] },
  { id:50, v:1, t:'b', c:'p', q:"Will any cryptocurrency become legal tender in a G7 nation by 2030?" },
  { id:51, v:1, t:'b', c:'p', q:"Will average US home prices exceed $500k by 2030?", e:[ev('s','2024 median','$420,000')] },
  { id:52, v:1, t:'m', c:'p', q:"Which social platform will have the most users in 2030?", o:["TikTok/ByteDance","Instagram/Meta","YouTube","WeChat","Something new"] },
  { id:53, v:1, t:'b', c:'p', q:"Will deepfakes influence a major election outcome by 2028?" },
  { id:54, v:1, t:'b', c:'p', q:"Will antibiotics still be effective against most infections in 2040?" },
  { id:55, v:1, t:'m', c:'p', q:"What will happen to Twitter/X by 2030?", o:["Still dominant","Acquired by another company","Bankrupt/shut down","Transformed into something else","Niche platform"] },
  { id:56, v:1, t:'b', c:'p', q:"Will a major city become uninhabitable due to climate by 2050?" },
  { id:57, v:1, t:'b', c:'p', q:"Will commercial space tourism have 10,000+ customers by 2035?" },
  { id:58, v:1, t:'m', c:'p', q:"Which industry will AI disrupt most by 2030?", o:["Healthcare","Legal","Education","Finance","Creative/Media"] },
  { id:59, v:1, t:'b', c:'p', q:"Will there be a manned mission to an asteroid by 2040?", x:1 },
  { id:60, v:1, t:'b', c:'p', q:"Will the EU still exist in its current form in 2040?" },
  { id:61, v:1, t:'m', c:'p', q:"What will be the dominant energy source globally by 2050?", o:["Solar","Nuclear (fission)","Nuclear (fusion)","Natural gas","Mix with no dominant"] },
  { id:62, v:1, t:'b', c:'p', q:"Will life expectancy in developed nations exceed 90 by 2060?" },
  { id:63, v:1, t:'b', c:'p', q:"Will AI-generated content be majority of internet content by 2035?" },
  { id:64, v:1, t:'m', c:'p', q:"How will most people commute in major cities in 2040?", o:["Personal EVs","Public transit","Autonomous ride-share","E-bikes/scooters","Remote work (no commute)"] },
  { id:65, v:1, t:'b', c:'p', q:"Will any tech company reach $10 trillion market cap by 2035?", e:[ev('s','Apple (2024)','~$3.5T')] },
  { id:66, v:1, t:'b', c:'p', q:"Will lab-grown organs be standard medical practice by 2040?" },
  { id:67, v:1, t:'m', c:'p', q:"Which renewable will grow fastest 2025-2035?", o:["Solar","Wind","Geothermal","Hydrogen","Nuclear"] },
  { id:68, v:1, t:'b', c:'p', q:"Will physical cash be eliminated in any major economy by 2035?" },
  { id:69, v:1, t:'b', c:'p', q:"Will we discover definitive evidence of extraterrestrial life by 2050?" },
  { id:70, v:1, t:'m', c:'p', q:"What will college education look like in 2040?", o:["Similar to now","Mostly online","AI-tutored/personalized","Shorter/bootcamp style","Obsolete/replaced by credentials"] },
  { id:71, v:1, t:'b', c:'p', q:"Will global meat consumption decline by 2035?" },
  { id:72, v:1, t:'b', c:'p', q:"Will any country implement a 4-day work week nationally by 2030?" },
  { id:73, v:1, t:'m', c:'p', q:"What will be the next pandemic pathogen type?", o:["Influenza variant","Coronavirus","Bacterial","Fungal","Engineered/bioweapon"] },
  { id:74, v:1, t:'b', c:'p', q:"Will AGI (Artificial General Intelligence) exist by 2035?" },
  { id:75, v:1, t:'b', c:'p', q:"Will the Arctic be ice-free in summer before 2040?", e:[ev('n',null,'Ice extent declining ~13% per decade')] },
  { id:76, v:1, t:'m', c:'p', q:"What will replace smartphones as primary device?", o:["AR glasses","Neural interfaces","Smart watches","Nothing/phones evolve","AI agents (deviceless)"] },
  { id:77, v:1, t:'b', c:'p', q:"Will India become a top 3 global economy by 2030?", e:[ev('s','Current rank','#5')] },
  { id:78, v:1, t:'b', c:'p', q:"Will most new music be AI-generated by 2035?" },
  { id:79, v:1, t:'m', c:'p', q:"What will happen to housing costs in major cities by 2035?", o:["Continue rising","Plateau","Decline significantly","Bifurcate (luxury vs affordable)","Government intervention stabilizes"] },
  { id:80, v:1, t:'b', c:'p', q:"Will autonomous ships handle majority of global shipping by 2040?", x:1 },
  { id:81, v:1, t:'b', c:'r', q:"Can a teleporter that destroys and recreates you preserve your identity?" },
  { id:82, v:1, t:'m', c:'r', q:"What makes an action morally right?", o:["Consequences (utilitarianism)","Intent (deontology)","Character (virtue ethics)","Social contract","Nothing objective"] },
  { id:83, v:1, t:'b', c:'r', q:"Is it ethical to create sentient AI?" },
  { id:84, v:1, t:'b', c:'r', q:"Does the trolley problem have a correct answer?", e:[ev('n',null,'Pull lever to save 5, killing 1?')] },
  { id:85, v:1, t:'m', c:'r', q:"What is the nature of consciousness?", o:["Physical brain processes","Emergent property","Fundamental like mass/charge","Illusion","Unknowable"] },
  { id:86, v:1, t:'b', c:'r', q:"Is mathematics discovered (not invented)?" },
  { id:87, v:1, t:'b', c:'r', q:"Can machines ever truly understand (not just simulate)?" },
  { id:88, v:1, t:'m', c:'r', q:"What gives life meaning?", o:["Relationships","Achievement","Pleasure","Purpose/contribution","Nothing inherent"] },
  { id:89, v:1, t:'b', c:'r', q:"Is it wrong to eat animals if alternatives exist?" },
  { id:90, v:1, t:'b', c:'r', q:"Would you take a pill that makes you perpetually happy but delusional?" },
  { id:91, v:1, t:'m', c:'r', q:"If you could live forever, would you want to?", o:["Yes, unconditionally","Yes, with exit option","Only if others could too","No, death gives meaning","Depends on quality of life"] },
  { id:92, v:1, t:'b', c:'r', q:"Is privacy a fundamental right?" },
  { id:93, v:1, t:'b', c:'r', q:"Are humans fundamentally good?" },
  { id:94, v:1, t:'m', c:'r', q:"What is the self?", o:["Continuous soul/essence","Pattern of memories","Illusion","Body/brain","Social construction"] },
  { id:95, v:1, t:'b', c:'r', q:"Is it ethical to gene-edit embryos to prevent disease?" },
  { id:96, v:1, t:'b', c:'r', q:"Can something be art if created by accident?" },
  { id:97, v:1, t:'m', c:'r', q:"What matters more: intention or outcome?", o:["Intention always","Outcome always","Depends on context","Both equally","Neither/virtue matters"] },
  { id:98, v:1, t:'b', c:'r', q:"Is a perfect simulation of a person the same as that person?" },
  { id:99, v:1, t:'b', c:'r', q:"Do animals have rights?" },
  { id:100, v:1, t:'m', c:'r', q:"Why is there something rather than nothing?", o:["God/creator","Physical necessity","Anthropic principle","Brute fact","Question is meaningless"] },
  { id:101, v:1, t:'b', c:'r', q:"Is time travel logically possible?" },
  { id:102, v:1, t:'b', c:'r', q:"Can we ever truly know another person's mind?" },
  { id:103, v:1, t:'m', c:'r', q:"What makes someone the 'same person' over time?", o:["Physical continuity","Memory continuity","Personality","Soul","Legal/social recognition"] },
  { id:104, v:1, t:'b', c:'r', q:"Is it ethical to bring children into a world with suffering?" },
  { id:105, v:1, t:'b', c:'r', q:"Can art be objectively evaluated?" },
  { id:106, v:1, t:'m', c:'r', q:"What is truth?", o:["Correspondence to reality","Coherence with beliefs","What works (pragmatism)","Social consensus","Unknowable"] },
  { id:107, v:1, t:'b', c:'r', q:"Is laziness a vice?" },
  { id:108, v:1, t:'b', c:'r', q:"Would you want to know the exact date of your death?" },
  { id:109, v:1, t:'m', c:'r', q:"Is a calorie-restricted long life better than a shorter indulgent one?", o:["Long life always better","Short indulgent better","Depends on the person","Quality > quantity","False dichotomy"] },
  { id:110, v:1, t:'b', c:'r', q:"Is cultural appropriation always wrong?" },
  { id:111, v:1, t:'b', c:'r', q:"Can evil actions ever be justified by good outcomes?" },
  { id:112, v:1, t:'m', c:'r', q:"What is the purpose of punishment?", o:["Deterrence","Rehabilitation","Retribution","Public safety","No valid purpose"] },
  { id:113, v:1, t:'b', c:'r', q:"Is ignorance ever bliss?" },
  { id:114, v:1, t:'b', c:'r', q:"Do we have moral obligations to future generations?" },
  { id:115, v:1, t:'m', c:'r', q:"Is a lie ever morally required?", o:["Never","To prevent harm","To protect feelings","In war/self-defense","Lies are neutral tools"] },
  { id:116, v:1, t:'b', c:'j', q:"Should billionaires exist?" },
  { id:117, v:1, t:'m', c:'j', q:"What's the best economic system?", o:["Capitalism","Socialism","Mixed economy","Something new","Depends on context"] },
  { id:118, v:1, t:'b', c:'j', q:"Should college be free?" },
  { id:119, v:1, t:'b', c:'j', q:"Is cancel culture a net positive?" },
  { id:120, v:1, t:'m', c:'j', q:"How should AI be regulated?", o:["Strict government control","Industry self-regulation","International treaty","Minimal regulation","Case-by-case basis"] },
  { id:121, v:1, t:'b', c:'j', q:"Should voting be mandatory?", e:[ev('s','Australia turnout','~95%')] },
  { id:122, v:1, t:'b', c:'j', q:"Is the death penalty ever justified?", x:1 },
  { id:123, v:1, t:'m', c:'j', q:"What should be done about illegal immigration?", o:["Open borders","Path to citizenship","Stricter enforcement","Guest worker programs","Address root causes"], x:1 },
  { id:124, v:1, t:'b', c:'j', q:"Should drugs be decriminalized?" },
  { id:125, v:1, t:'b', c:'j', q:"Is universal basic income a good idea?" },
  { id:126, v:1, t:'m', c:'j', q:"Who should control the internet?", o:["Governments","Private companies","International body","Decentralized/no one","Users collectively"] },
  { id:127, v:1, t:'b', c:'j', q:"Should hate speech be illegal?", x:1 },
  { id:128, v:1, t:'b', c:'j', q:"Is affirmative action justified?", x:1 },
  { id:129, v:1, t:'m', c:'j', q:"What's the right approach to climate policy?", o:["Carbon tax","Regulations/mandates","Subsidies for green tech","Nuclear expansion","Adaptation focus"] },
  { id:130, v:1, t:'b', c:'j', q:"Should assisted suicide be legal?" },
  { id:131, v:1, t:'b', c:'j', q:"Are private schools harmful to public education?" },
  { id:132, v:1, t:'m', c:'j', q:"How should we handle wealth inequality?", o:["Progressive taxation","Wealth caps","Universal services","Education/opportunity","It's not a problem"] },
  { id:133, v:1, t:'b', c:'j', q:"Should AI art be copyrightable?" },
  { id:134, v:1, t:'b', c:'j', q:"Is nationalism inherently dangerous?" },
  { id:135, v:1, t:'m', c:'j', q:"What should replace prisons?", o:["Nothing - reform prisons","Rehabilitation centers","Restorative justice","Electronic monitoring","Community service"] },
  { id:136, v:1, t:'b', c:'j', q:"Should parents be able to select embryos for traits?" },
  { id:137, v:1, t:'b', c:'j', q:"Is a global government desirable?" },
  { id:138, v:1, t:'m', c:'j', q:"How should gig workers be classified?", o:["Employees","Contractors","New category","Worker's choice","Depends on the job"] },
  { id:139, v:1, t:'b', c:'j', q:"Should tech companies be broken up?" },
  { id:140, v:1, t:'b', c:'j', q:"Is zoning reform the solution to housing costs?" },
  { id:141, v:1, t:'m', c:'j', q:"What's the best voting system?", o:["First-past-the-post","Ranked choice","Proportional representation","Approval voting","Sortition (random selection)"] },
  { id:142, v:1, t:'b', c:'j', q:"Should there be limits on free speech online?" },
  { id:143, v:1, t:'b', c:'j', q:"Is meritocracy a myth?" },
  { id:144, v:1, t:'m', c:'j', q:"How should social media moderate content?", o:["Government oversight","Platform discretion","User-controlled filters","No moderation","Community-based moderation"] },
  { id:145, v:1, t:'b', c:'j', q:"Should voting age be lowered to 16?" },
  { id:146, v:1, t:'b', c:'j', q:"Are unions still necessary?" },
  { id:147, v:1, t:'m', c:'j', q:"What's the solution to political polarization?", o:["Media reform","Education","Electoral reform","Economic equality","No solution exists"] },
  { id:148, v:1, t:'b', c:'j', q:"Should wealthy nations pay climate reparations?" },
  { id:149, v:1, t:'b', c:'j', q:"Is remote work better for society overall?" },
  { id:150, v:1, t:'m', c:'j', q:"How should we handle misinformation?", o:["Government regulation","Platform labels/removal","Media literacy education","Let marketplace decide","Impossible to solve"] },
  { id:151, v:1, t:'m', c:'j', q:"What's the best decade for music?", o:["1960s","1970s","1980s","1990s","2000s+"] },
  { id:152, v:1, t:'b', c:'j', q:"Is working from home better than office work?" },
  { id:153, v:1, t:'m', c:'j', q:"What's the ideal vacation length?", o:["Long weekend (3-4 days)","One week","Two weeks","One month+","Frequent short trips"] },
  { id:154, v:1, t:'b', c:'j', q:"Are audiobooks as good as reading?" },
  { id:155, v:1, t:'m', c:'j', q:"What's the best coffee preparation?", o:["Espresso","Pour over","French press","Drip","Cold brew"] },
  { id:156, v:1, t:'b', c:'j', q:"Is buying a home better than renting?" },
  { id:157, v:1, t:'m', c:'j', q:"What's the ideal number of children?", o:["Zero","One","Two","Three","Four+"] },
  { id:158, v:1, t:'b', c:'j', q:"Are open offices a bad idea?" },
  { id:159, v:1, t:'m', c:'j', q:"What's the best way to exercise?", o:["Gym/weights","Running/cardio","Sports/games","Yoga/flexibility","Walking"] },
  { id:160, v:1, t:'b', c:'j', q:"Is social media net negative for society?" },
  { id:161, v:1, t:'m', c:'j', q:"What's the ideal work schedule?", o:["9-5, five days","4-day week","Flexible hours","Results-only","Varies by person"] },
  { id:162, v:1, t:'b', c:'j', q:"Are video games a waste of time?" },
  { id:163, v:1, t:'m', c:'j', q:"What's the best pet for a busy person?", o:["Cat","Dog","Fish","No pet","Low-maintenance reptile"] },
  { id:164, v:1, t:'b', c:'j', q:"Should you always follow your passion for a career?" },
  { id:165, v:1, t:'m', c:'j', q:"What's the ideal retirement age?", o:["55","60","65","70","Never fully retire"] },
  { id:166, v:1, t:'b', c:'j', q:"Is a college degree still worth it?" },
  { id:167, v:1, t:'m', c:'j', q:"What's the best news source format?", o:["Print newspaper","TV news","Podcasts","Social media","News apps/aggregators"] },
  { id:168, v:1, t:'b', c:'j', q:"Are smartphones making us less intelligent?" },
  { id:169, v:1, t:'m', c:'j', q:"What's the ideal city size to live in?", o:["Small town (<50k)","Medium city (50-500k)","Large city (500k-2M)","Major metro (2M+)","Rural/countryside"] },
  { id:170, v:1, t:'b', c:'j', q:"Is it okay to ghost someone after a few dates?" },
  { id:171, v:1, t:'m', c:'j', q:"What's more important in a job?", o:["Salary","Work-life balance","Interesting work","Good colleagues","Career growth"] },
  { id:172, v:1, t:'b', c:'j', q:"Should you tell a friend their partner is cheating?" },
  { id:173, v:1, t:'m', c:'j', q:"What's the best breakfast?", o:["Continental (pastry/coffee)","Full cooked breakfast","Healthy (smoothie/oatmeal)","Skip breakfast","Whatever's available"] },
  { id:174, v:1, t:'b', c:'j', q:"Is it rude to recline your seat on a plane?" },
  { id:175, v:1, t:'m', c:'j', q:"What's the ideal age to get married?", o:["Early 20s","Late 20s","Early 30s","35+","Never/optional"] },
  { id:176, v:1, t:'b', c:'j', q:"Are reality TV shows harmful?" },
  { id:177, v:1, t:'m', c:'j', q:"What's the best streaming service?", o:["Netflix","Disney+","HBO Max","Amazon Prime","YouTube"] },
  { id:178, v:1, t:'b', c:'j', q:"Is tipping culture a good thing?" },
  { id:179, v:1, t:'m', c:'j', q:"What's more important: IQ or EQ?", o:["IQ","EQ","Both equally","Neither/other factors","Depends on context"] },
  { id:180, v:1, t:'b', c:'j', q:"Should you lend money to friends?" },
  { id:181, v:1, t:'m', c:'j', q:"What's the best way to learn a language?", o:["Apps (Duolingo)","Classes","Immersion","Tutoring","Media consumption"] },
  { id:182, v:1, t:'b', c:'j', q:"Is minimalism a superior lifestyle?" },
  { id:183, v:1, t:'m', c:'j', q:"What makes a house a home?", o:["Family/people","Personal belongings","Time spent there","Ownership","Feeling of safety"] },
  { id:184, v:1, t:'b', c:'j', q:"Should couples combine finances?" },
  { id:185, v:1, t:'m', c:'j', q:"What's the ideal amount of sleep?", o:["5-6 hours","7 hours","8 hours","9+ hours","Varies by person"], x:1},
  { id:186, v:1, t:'b', c:'j', q:"Is cold weather better than hot weather?" },
  { id:187, v:1, t:'m', c:'j', q:"What's the best time of day to work out?", o:["Early morning","Late morning","Lunchtime","After work","Evening"], x:1},
  { id:188, v:1, t:'b', c:'j', q:"Are New Year's resolutions pointless?" },
  { id:189, v:1, t:'m', c:'j', q:"What's the ideal commute time?", o:["Under 10 min","10-20 min","20-30 min","30-45 min","No commute (remote)"], x:1},
  { id:190, v:1, t:'b', c:'j', q:"Is being an early bird better than night owl?" },
  { id:191, v:1, t:'b', c:'j', q:"Is this headline misleading? 'Study finds coffee drinkers live longer'", e:[ev('n',null,'Correlation study, n=10,000, no controls for lifestyle')], x:1},
  { id:192, v:1, t:'m', c:'j', q:"Rate this business pitch: 'Uber for dog walking'", o:["Strong - clear market","Medium - competitive space","Weak - already exists","Need more info"] },
  { id:193, v:1, t:'b', c:'j', q:"Is this statistic meaningful? '90% of startups fail'", e:[ev('n',null,'Definition of "fail" and timeframe vary widely')], x:1},
  { id:194, v:1, t:'b', c:'j', q:"Is this a valid argument? 'Most CEOs are tall, so being tall helps you succeed'", x:1},
  { id:195, v:1, t:'m', c:'j', q:"Rate this excuse for being late: 'Traffic was bad'", o:["Completely valid","Usually acceptable","Weak excuse","Unacceptable","Depends on frequency"] },
  { id:196, v:1, t:'b', c:'j', q:"Is this claim verifiable? 'Our AI reduces costs by 40%'", x:1},
  { id:197, v:1, t:'m', c:'j', q:"Rate this study design: Survey of 100 Twitter users about public opinion", o:["Strong methodology","Acceptable with caveats","Weak but usable","Fundamentally flawed"], x:1},
  { id:198, v:1, t:'b', c:'j', q:"Is this a conflict of interest? Nutrition study funded by food company" },
  { id:199, v:1, t:'b', c:'j', q:"Is this photo likely AI-generated? (Perfect symmetry, 6 fingers)" },
  { id:200, v:1, t:'m', c:'j', q:"Rate this investment thesis: 'AI will replace all jobs, so invest in robots'", o:["Sound reasoning","Partially valid","Oversimplified","Fundamentally wrong"] },
  { id:201, v:1, t:'b', c:'j', q:"Is this apology genuine? 'I'm sorry you feel that way'" },
  { id:202, v:1, t:'b', c:'j', q:"Is this product review trustworthy? 5 stars, 3 words, verified purchase" },
  { id:203, v:1, t:'m', c:'j', q:"Rate this job posting: 'Fast-paced environment, wear many hats, competitive salary'", o:["Attractive opportunity","Yellow flags","Red flags","Need more info"] },
  { id:204, v:1, t:'b', c:'j', q:"Is this a logical fallacy? 'Everyone's doing it, so it must be okay'" },
  { id:205, v:1, t:'b', c:'j', q:"Is this sample size adequate? Medical trial with 50 participants", e:[ev('n',null,'Testing rare disease treatment')], x:1},
  { id:206, v:1, t:'m', c:'j', q:"Rate this dating profile: 'No drama, know what I want, fluent in sarcasm'", o:["Appealing","Neutral","Off-putting","Depends on audience"] },
  { id:207, v:1, t:'b', c:'j', q:"Is this reasoning sound? 'Stock went up after I bought it, so I'm a good investor'", x:1},
  { id:208, v:1, t:'b', c:'j', q:"Is this email a scam? 'Urgent: Verify your account or lose access'" },
  { id:209, v:1, t:'m', c:'j', q:"Rate this restaurant review: '1 star - food was great but parking was hard'", o:["Fair rating","Unfair rating","Useful information","Should be ignored"] },
  { id:210, v:1, t:'b', c:'j', q:"Is this correlation meaningful? 'Ice cream sales and drowning deaths both rise in summer'", x:1},
  { id:211, v:1, t:'b', c:'j', q:"Is this expertise relevant? Physicist commenting on economics", x:1},
  { id:212, v:1, t:'m', c:'j', q:"Rate this prediction track record: 60% accuracy on binary outcomes", o:["Excellent","Good","Mediocre","Poor","Need more context"], x:1},
  { id:213, v:1, t:'b', c:'j', q:"Is this source reliable? Wikipedia article with 50 citations", x:1},
  { id:214, v:1, t:'b', c:'j', q:"Is this a valid comparison? 'Company X is the Airbnb of Y industry'", x:1},
  { id:215, v:1, t:'m', c:'j', q:"Rate this feedback: 'Good job, but could be better'", o:["Helpful","Somewhat helpful","Useless","Harmful"], x:1},
  { id:216, v:1, t:'b', c:'r', q:"Is 2^10 greater than 1000?", e:[ev('n',null,'2^10 = 1024')], x:1 },
  { id:217, v:1, t:'m', c:'r', q:"What comes next: 1, 1, 2, 3, 5, 8, __?", o:["11","12","13","15"], x:1 },
  { id:218, v:1, t:'b', c:'r', q:"Can a year have two Friday the 13ths?", x:1 },
  { id:219, v:1, t:'b', c:'r', q:"Is the sum of angles in a triangle always 180Â°?", x:1 },
  { id:220, v:1, t:'m', c:'r', q:"How many states does the US have?", o:["48","50","51","52"], x:1 },
  { id:221, v:1, t:'b', c:'r', q:"Is the speed of light faster than the speed of sound?", x:1 },
  { id:222, v:1, t:'m', c:'r', q:"What is 15% of 80?", o:["10","12","15","18"], x:1 },
  { id:223, v:1, t:'b', c:'r', q:"Can you fold a piece of paper more than 7 times?" },
  { id:224, v:1, t:'b', c:'r', q:"Is a tomato a fruit?" },
  { id:225, v:1, t:'m', c:'r', q:"How many planets in our solar system?", o:["7","8","9","10"], x:1 },
  { id:226, v:1, t:'b', c:'r', q:"Is 0.999... (repeating) equal to 1?", x:1 },
  { id:227, v:1, t:'m', c:'r', q:"What day follows Saturday?", o:["Friday","Sunday","Monday","Sabbath"], x:1 },
  { id:228, v:1, t:'b', c:'r', q:"Can a triangle have two right angles?" },
  { id:229, v:1, t:'b', c:'r', q:"Is Venus hotter than Mercury?", e:[ev('n',null,'Mercury is closer to the Sun')] },
  { id:230, v:1, t:'m', c:'r', q:"What is the square root of 169?", o:["11","12","13","14"], x:1 },
  { id:231, v:1, t:'b', c:'r', q:"Do all mammals give live birth?" },
  { id:232, v:1, t:'b', c:'r', q:"Is Ï€ (pi) a rational number?" },
  { id:233, v:1, t:'m', c:'r', q:"How many sides does a hexagon have?", o:["5","6","7","8"], x:1 },
  { id:234, v:1, t:'b', c:'r', q:"Is Mount Everest the tallest mountain from base to peak?", e:[ev('n',null,'Consider Mauna Kea from ocean floor')] },
  { id:235, v:1, t:'b', c:'r', q:"Can sound travel through a vacuum?" },
  { id:236, v:1, t:'m', c:'r', q:"What is 7 Ã— 8?", o:["54","56","58","64"], x:1 },
  { id:237, v:1, t:'b', c:'r', q:"Is blue light higher energy than red light?" },
  { id:238, v:1, t:'b', c:'r', q:"Does water expand when it freezes?" },
  { id:239, v:1, t:'m', c:'r', q:"How many degrees in a circle?", o:["180","270","360","400"], x:1 },
  { id:240, v:1, t:'b', c:'r', q:"Is a whale a fish?" },
  { id:241, v:1, t:'b', c:'p', q:"Will SpaceX successfully land humans on Mars by 2030?" },
  { id:242, v:1, t:'m', c:'p', q:"What will be the biggest tech IPO of 2027?", o:["OpenAI","Stripe","SpaceX","Databricks","Something unexpected"] },
  { id:243, v:1, t:'b', c:'p', q:"Will the US dollar lose reserve currency status by 2040?" },
  { id:244, v:1, t:'b', c:'p', q:"Will longevity treatments extend average lifespan by 10+ years by 2050?" },
  { id:245, v:1, t:'m', c:'p', q:"Which emerging technology will have the biggest impact by 2035?", o:["Quantum computing","Brain-computer interfaces","Gene editing","Nuclear fusion","Robotics"] },
  { id:246, v:1, t:'b', c:'p', q:"Will there be a major cyber attack on US infrastructure by 2028?" },
  { id:247, v:1, t:'b', c:'p', q:"Will Netflix still be the top streaming service in 2030?" },
  { id:248, v:1, t:'m', c:'p', q:"What will cause the next major tech layoff wave?", o:["AI automation","Economic recession","Regulatory crackdown","Market saturation","Geopolitical conflict"] },
  { id:249, v:1, t:'b', c:'p', q:"Will synthetic biology create new organisms for commercial use by 2030?", x:1 },
  { id:250, v:1, t:'b', c:'p', q:"Will augmented reality glasses be mainstream by 2028?" },
  { id:251, v:1, t:'m', c:'p', q:"Which country will have the best healthcare system in 2040?", o:["United States","Singapore","Japan","Nordic countries","AI-driven system (location irrelevant)"] },
  { id:252, v:1, t:'b', c:'p', q:"Will vertical farming produce 10% of vegetables in developed nations by 2035?", x:1 },
  { id:253, v:1, t:'b', c:'p', q:"Will any AI model be granted legal rights by 2040?" },
  { id:254, v:1, t:'m', c:'p', q:"What will happen to journalism by 2035?", o:["AI-written dominates","Subscription model wins","Citizen journalism rises","Government-funded expands","Complete transformation"] },
  { id:255, v:1, t:'b', c:'p', q:"Will carbon capture technology be commercially viable by 2035?" },
  { id:256, v:1, t:'b', c:'p', q:"Will there be a global treaty on AI development by 2030?" },
  { id:257, v:1, t:'m', c:'p', q:"How will most people pay for things in 2035?", o:["Credit/debit cards","Mobile wallets","Cryptocurrency","Biometric payments","Central bank digital currency"] },
  { id:258, v:1, t:'b', c:'p', q:"Will personalized medicine based on genetics be standard by 2035?" },
  { id:259, v:1, t:'b', c:'p', q:"Will any major sport allow performance-enhancing AI implants by 2040?" },
  { id:260, v:1, t:'m', c:'p', q:"What will be the dominant form of entertainment in 2040?", o:["Streaming video","Interactive/VR experiences","AI-generated content","Live events resurgence","Social media content"] },
  { id:261, v:1, t:'b', c:'p', q:"Will desalination solve water scarcity for 1 billion people by 2040?", x:1 },
  { id:262, v:1, t:'b', c:'p', q:"Will traditional TV broadcasting still exist in 2035?" },
  { id:263, v:1, t:'m', c:'p', q:"What will happen to movie theaters by 2035?", o:["Thriving luxury experience","Mostly closed","Converted to other uses","VR replaces them","Premium-only events"] },
  { id:264, v:1, t:'b', c:'p', q:"Will robots perform 50% of surgery by 2040?" },
  { id:265, v:1, t:'b', c:'p', q:"Will quantum internet be available commercially by 2040?", x:1 },
  { id:266, v:1, t:'m', c:'p', q:"Which job will be most AI-resistant in 2035?", o:["Healthcare worker","Tradesperson","Teacher","Creative artist","Social worker"] },
  { id:267, v:1, t:'b', c:'p', q:"Will flying cars/air taxis be common in major cities by 2040?" },
  { id:268, v:1, t:'b', c:'p', q:"Will Apple still be the most valuable company in 2030?" },
  { id:269, v:1, t:'m', c:'p', q:"What will replace Google Search as the primary information source?", o:["AI assistants","Nothing (Google adapts)","Decentralized search","Social media","Specialized vertical search"] },
  { id:270, v:1, t:'b', c:'p', q:"Will 3D-printed houses be 10% of new construction by 2035?", x:1 },
  { id:271, v:1, t:'b', c:'p', q:"Will human-level AI assistants be in every home by 2035?" },
  { id:272, v:1, t:'m', c:'p', q:"What will be the biggest geopolitical conflict of the 2030s?", o:["US-China","Climate refugees","Water wars","AI arms race","Economic blocks"] },
  { id:273, v:1, t:'b', c:'p', q:"Will cryptocurrency be banned in any G20 nation by 2030?" },
  { id:274, v:1, t:'b', c:'p', q:"Will genetic screening of embryos be routine in developed nations by 2035?" },
  { id:275, v:1, t:'m', c:'p', q:"What will be the primary mode of long-distance travel in 2050?", o:["Traditional aircraft","Supersonic jets","Hyperloop","Electric aircraft","Virtual presence replaces travel"] },
  { id:276, v:1, t:'b', c:'p', q:"Will Amazon still dominate e-commerce in 2035?" },
  { id:277, v:1, t:'b', c:'p', q:"Will lab-grown diamonds exceed natural diamond sales by 2030?" },
  { id:278, v:1, t:'m', c:'p', q:"How will dating work in 2035?", o:["Apps still dominant","AI matchmaking","VR dating","Return to traditional","Hybrid approaches"] },
  { id:279, v:1, t:'b', c:'p', q:"Will any country achieve net-zero emissions before 2040?" },
  { id:280, v:1, t:'b', c:'p', q:"Will holographic displays replace screens in homes by 2040?" },
  { id:281, v:1, t:'b', c:'r', q:"Is knowledge without wisdom dangerous?" },
  { id:282, v:1, t:'m', c:'r', q:"What is the greatest human virtue?", o:["Courage","Compassion","Wisdom","Justice","Honesty"] },
  { id:283, v:1, t:'b', c:'r', q:"Can we be held responsible for actions we were destined to take?" },
  { id:284, v:1, t:'b', c:'r', q:"Is suffering necessary for happiness?" },
  { id:285, v:1, t:'m', c:'r', q:"What is the source of moral authority?", o:["Religion/God","Reason","Social consensus","Evolution","Individual conscience"] },
  { id:286, v:1, t:'b', c:'r', q:"Is it ethical to modify human memory?" },
  { id:287, v:1, t:'b', c:'r', q:"Can a copy of a mind be the same person?" },
  { id:288, v:1, t:'m', c:'r', q:"What makes humans unique from other animals?", o:["Language","Reason","Self-awareness","Culture","Nothing fundamental"] },
  { id:289, v:1, t:'b', c:'r', q:"Is it possible to be truly selfless?" },
  { id:290, v:1, t:'b', c:'r', q:"Does beauty exist objectively?" },
  { id:291, v:1, t:'m', c:'r', q:"What is the best life philosophy?", o:["Stoicism","Buddhism","Existentialism","Utilitarianism","Religious faith"] },
  { id:292, v:1, t:'b', c:'r', q:"Is it wrong to create life knowing it will suffer?" },
  { id:293, v:1, t:'b', c:'r', q:"Can a thought experiment prove anything about reality?" },
  { id:294, v:1, t:'m', c:'r', q:"What is the relationship between mind and body?", o:["Mind is brain (materialism)","Mind is separate (dualism)","Mind emerges from complexity","Mind is fundamental","Unknown/unknowable"] },
  { id:295, v:1, t:'b', c:'r', q:"Is nostalgia a trap?" },
  { id:296, v:1, t:'b', c:'r', q:"Should we prioritize helping the worst off over the average?" },
  { id:297, v:1, t:'m', c:'r', q:"When is violence justified?", o:["Never","Only self-defense","Defense of others","Against tyranny","Context-dependent"] },
  { id:298, v:1, t:'b', c:'r', q:"Is boredom primarily a modern problem?" },
  { id:299, v:1, t:'b', c:'r', q:"Can you change who you fundamentally are?" },
  { id:300, v:1, t:'m', c:'r', q:"What is the purpose of government?", o:["Protect rights","Promote welfare","Maintain order","Enable freedom","No legitimate purpose"] },
  { id:301, v:1, t:'b', c:'r', q:"Is moral progress real?" },
  { id:302, v:1, t:'b', c:'r', q:"Does the existence of evil disprove a benevolent God?" },
  { id:303, v:1, t:'m', c:'r', q:"What makes a good life?", o:["Pleasure","Achievement","Virtue","Meaning","Balance of all"] },
  { id:304, v:1, t:'b', c:'r', q:"Is it better for a leader to be feared than loved?" },
  { id:305, v:1, t:'b', c:'r', q:"Can future people have rights?" },
  { id:306, v:1, t:'m', c:'r', q:"Why do we dream?", o:["Brain maintenance","Emotional processing","Problem solving","Random neural firing","Connection to something deeper"] },
  { id:307, v:1, t:'b', c:'r', q:"Is authenticity overrated?" },
  { id:308, v:1, t:'b', c:'r', q:"Can a society be too equal?" },
  { id:309, v:1, t:'m', c:'r', q:"What is the greatest threat to human flourishing?", o:["Technology","Human nature","Scarcity","Tribalism","Loss of meaning"] },
  { id:310, v:1, t:'b', c:'r', q:"Is optimism rational?" },
  { id:311, v:1, t:'b', c:'r', q:"Should we enhance human intelligence artificially?" },
  { id:312, v:1, t:'m', c:'r', q:"What is justice?", o:["Fairness","Desert (getting what you deserve)","Need-based distribution","Process-based","Social harmony"] },
  { id:313, v:1, t:'b', c:'r', q:"Is it wrong to not have children?" },
  { id:314, v:1, t:'b', c:'r', q:"Can nationalism be positive?" },
  { id:315, v:1, t:'m', c:'r', q:"What is wisdom?", o:["Knowledge applied well","Understanding limits","Emotional intelligence","Life experience","Knowing what matters"] },
  { id:316, v:1, t:'b', c:'r', q:"Is ambition generally a virtue?" },
  { id:317, v:1, t:'b', c:'r', q:"Should we try to eliminate all suffering?" },
  { id:318, v:1, t:'m', c:'r', q:"What determines personal identity over time?", o:["Physical continuity","Psychological continuity","Social recognition","Narrative self","No fixed identity"] },
  { id:319, v:1, t:'b', c:'r', q:"Is revenge ever justified?" },
  { id:320, v:1, t:'b', c:'r', q:"Can an AI have genuine emotions?" },
  { id:321, v:1, t:'b', c:'j', q:"Should AI-generated art be allowed in art competitions?" },
  { id:322, v:1, t:'m', c:'j', q:"How should we handle aging populations?", o:["Increase immigration","Raise retirement age","Automation","Pro-natalist policies","Accept decline"] },
  { id:323, v:1, t:'b', c:'j', q:"Should there be a maximum wage?" },
  { id:324, v:1, t:'b', c:'j', q:"Is nuclear power the answer to climate change?" },
  { id:325, v:1, t:'m', c:'j', q:"What should be done about homelessness?", o:["Housing first","Mental health focus","Job programs","Stricter enforcement","Universal basic income"] },
  { id:326, v:1, t:'b', c:'j', q:"Should parents be licensed?" },
  { id:327, v:1, t:'b', c:'j', q:"Is anonymous speech online a right?" },
  { id:328, v:1, t:'m', c:'j', q:"How should we fund healthcare?", o:["Single payer","Private insurance","Hybrid system","Health savings accounts","Employer-based"] },
  { id:329, v:1, t:'b', c:'j', q:"Should voting require passing a civics test?" },
  { id:330, v:1, t:'b', c:'j', q:"Are standardized tests a good measure of ability?" },
  { id:331, v:1, t:'m', c:'j', q:"What's the best way to reduce crime?", o:["More police","Social programs","Decriminalization","Community policing","Economic opportunity"] },
  { id:332, v:1, t:'b', c:'j', q:"Should there be term limits for Supreme Court justices?" },
  { id:333, v:1, t:'b', c:'j', q:"Is cultural relativism valid?" },
  { id:334, v:1, t:'m', c:'j', q:"How should we handle student debt?", o:["Full forgiveness","Partial forgiveness","Income-based repayment","No forgiveness","Reform future lending"] },
  { id:335, v:1, t:'b', c:'j', q:"Should companies be required to disclose AI use in products?" },
  { id:336, v:1, t:'b', c:'j', q:"Is intellectual property law too restrictive?" },
  { id:337, v:1, t:'m', c:'j', q:"What's the best approach to drug addiction?", o:["Criminalization","Harm reduction","Forced treatment","Decriminalization","Full legalization"] },
  { id:338, v:1, t:'b', c:'j', q:"Should there be a right to be forgotten online?" },
  { id:339, v:1, t:'b', c:'j', q:"Is space exploration worth the cost?" },
  { id:340, v:1, t:'m', c:'j', q:"How should we address income inequality?", o:["Higher taxes on wealthy","Universal basic services","Stronger unions","Education reform","Market solutions"] },
  { id:341, v:1, t:'b', c:'j', q:"Should athletes be allowed to use any enhancements?" },
  { id:342, v:1, t:'b', c:'j', q:"Is jury duty an unfair burden?" },
  { id:343, v:1, t:'m', c:'j', q:"What's the solution to fake news?", o:["Platform regulation","Media literacy education","Fact-checking labels","Legal consequences","Let market decide"] },
  { id:344, v:1, t:'b', c:'j', q:"Should there be reparations for historical injustices?", x:1 },
  { id:345, v:1, t:'b', c:'j', q:"Is it ethical to use ad blockers?" },
  { id:346, v:1, t:'m', c:'j', q:"How should we handle genetic discrimination?", o:["Ban all genetic testing for insurance","Allow with consent","Government oversight","Personal responsibility","Universal healthcare solves it"] },
  { id:347, v:1, t:'b', c:'j', q:"Should schools teach financial literacy as a required course?" },
  { id:348, v:1, t:'b', c:'j', q:"Is meritocracy compatible with equality?" },
  { id:349, v:1, t:'m', c:'j', q:"What should be done about factory farming?", o:["Ban it","Stricter regulations","Consumer choice","Lab-grown alternatives","Gradual phase-out"] },
  { id:350, v:1, t:'b', c:'j', q:"Should AI systems be required to identify themselves?" },
  { id:351, v:1, t:'b', c:'j', q:"Is gerrymandering ever acceptable?", x:1 },
  { id:352, v:1, t:'m', c:'j', q:"How should we address the urban-rural divide?", o:["Investment in rural areas","Encourage urbanization","Remote work incentives","Infrastructure spending","Accept divergence"] },
  { id:353, v:1, t:'b', c:'j', q:"Should organ sales be legal?" },
  { id:354, v:1, t:'b', c:'j', q:"Is it ethical to eat octopus given their intelligence?" },
  { id:355, v:1, t:'m', c:'j', q:"What's the best way to handle climate migration?", o:["Open borders","Managed resettlement","Adapt in place","International fund","Prevention focus"] },
  { id:356, v:1, t:'b', c:'j', q:"Should there be limits on AI in military applications?" },
  { id:357, v:1, t:'b', c:'j', q:"Is it fair to judge historical figures by modern standards?" },
  { id:358, v:1, t:'m', c:'j', q:"How should we reform policing?", o:["More funding/training","Defund and redirect","Community-based alternatives","Federal oversight","Local control"], x:1 },
  { id:359, v:1, t:'b', c:'j', q:"Should social media companies be treated as publishers?" },
  { id:360, v:1, t:'b', c:'j', q:"Is it ethical to clone pets?" },
  { id:361, v:1, t:'m', c:'j', q:"What's the best type of vacation?", o:["Beach relaxation","Adventure/active","Cultural exploration","Staycation","Road trip"] },
  { id:362, v:1, t:'b', c:'j', q:"Is buying a car better than leasing?" },
  { id:363, v:1, t:'m', c:'j', q:"What's the ideal family dinner frequency?", o:["Every night","Most nights","Few times a week","Weekends only","Special occasions"], x:1},
  { id:364, v:1, t:'b', c:'j', q:"Should you tell your salary to coworkers?" },
  { id:365, v:1, t:'m', c:'j', q:"What's the best age to have children?", o:["Early 20s","Late 20s","Early 30s","Late 30s","Never/optional"] },
  { id:366, v:1, t:'b', c:'j', q:"Is it okay to read your partner's messages?" },
  { id:367, v:1, t:'m', c:'j', q:"What makes a good boss?", o:["Clear direction","Empathy","Technical expertise","Advocacy","Hands-off approach"] },
  { id:368, v:1, t:'b', c:'j', q:"Should you always RSVP to invitations?" },
  { id:369, v:1, t:'m', c:'j', q:"What's the best way to spend a windfall?", o:["Pay off debt","Invest","Experience/travel","Save for emergency","Treat yourself"] },
  { id:370, v:1, t:'b', c:'j', q:"Is it rude to wear headphones in public constantly?" },
  { id:371, v:1, t:'m', c:'j', q:"What's the ideal home temperature?", o:["65-67Â°F","68-70Â°F","71-73Â°F","74-76Â°F","Varies by room/season"], x:1},
  { id:372, v:1, t:'b', c:'j', q:"Should you split the bill on a first date?" },
  { id:373, v:1, t:'m', c:'j', q:"What's the best time to exercise?", o:["Early morning","Mid-morning","Lunchtime","After work","Evening"] },
  { id:374, v:1, t:'b', c:'j', q:"Is being early better than being exactly on time?" },
  { id:375, v:1, t:'m', c:'j', q:"What's the ideal number of close friends?", o:["1-2","3-5","6-10","10+","Quality over quantity"] },
  { id:376, v:1, t:'b', c:'j', q:"Should you fake it till you make it?" },
  { id:377, v:1, t:'m', c:'j', q:"What's the best pizza topping?", o:["Pepperoni","Margherita (plain)","Supreme/everything","Hawaiian","Meat lovers"] },
  { id:378, v:1, t:'b', c:'j', q:"Is it okay to take work calls on vacation?" },
  { id:379, v:1, t:'m', c:'j', q:"What's more important in a home?", o:["Location","Size","Price","Condition","Outdoor space"] },
  { id:380, v:1, t:'b', c:'j', q:"Should you confront a friend about bad behavior?" },
  { id:381, v:1, t:'m', c:'j', q:"What's the best way to unwind after work?", o:["Exercise","TV/streaming","Reading","Socializing","Hobbies"] },
  { id:382, v:1, t:'b', c:'j', q:"Is it worth paying for premium subscriptions?" },
  { id:383, v:1, t:'m', c:'j', q:"What's the ideal wedding size?", o:["Elopement (2-10)","Intimate (10-50)","Medium (50-150)","Large (150-300)","Huge (300+)"] },
  { id:384, v:1, t:'b', c:'j', q:"Should you live together before marriage?" },
  { id:385, v:1, t:'m', c:'j', q:"What's the best approach to gift-giving?", o:["Thoughtful personal gifts","Gift cards","Experience gifts","Charitable donations","Skip gifts altogether"] },
  { id:386, v:1, t:'b', c:'j', q:"Is being a specialist better than a generalist?" },
  { id:387, v:1, t:'m', c:'j', q:"What's the ideal screen time per day?", o:["Under 2 hours","2-4 hours","4-6 hours","6-8 hours","No limit if productive"], x:1},
  { id:388, v:1, t:'b', c:'j', q:"Should parents track their teenager's location?" },
  { id:389, v:1, t:'m', c:'j', q:"What's the best way to handle disagreements?", o:["Discuss immediately","Cool off first","Write it out","Get a mediator","Let it go"] },
  { id:390, v:1, t:'b', c:'j', q:"Is having a side hustle necessary today?" },
  { id:391, v:1, t:'m', c:'j', q:"What's the ideal morning routine length?", o:["15-30 min","30-60 min","1-2 hours","2+ hours","No routine"], x:1},
  { id:392, v:1, t:'b', c:'j', q:"Should you negotiate every job offer?" },
  { id:393, v:1, t:'m', c:'j', q:"What's the best way to save money?", o:["Automatic transfers","Budgeting apps","Cash envelope system","Investment focus","Frugal lifestyle"], x:1},
  { id:394, v:1, t:'b', c:'j', q:"Is it okay to cancel plans last minute?" },
  { id:395, v:1, t:'m', c:'j', q:"What's more important in a car?", o:["Reliability","Fuel efficiency","Safety","Comfort","Performance"], x:1},
  { id:396, v:1, t:'b', c:'j', q:"Should you keep in touch with exes?" },
  { id:397, v:1, t:'m', c:'j', q:"What's the best approach to networking?", o:["Events/conferences","LinkedIn","Through friends","Cold outreach","Just do good work"], x:1},
  { id:398, v:1, t:'b', c:'j', q:"Is meal prepping worth the effort?" },
  { id:399, v:1, t:'m', c:'j', q:"What's the ideal vacation frequency?", o:["Monthly getaways","Quarterly trips","1-2 big trips/year","One annual vacation","Mini-retirements"], x:1},
  { id:400, v:1, t:'b', c:'j', q:"Should you always follow your gut?" },
  { id:401, v:1, t:'b', c:'j', q:"Is this claim credible? 'This supplement cured my chronic disease'", x:1},
  { id:402, v:1, t:'m', c:'j', q:"Rate this excuse: 'I didn't see your message'", o:["Usually valid","Sometimes valid","Rarely valid","Never valid"] },
  { id:403, v:1, t:'b', c:'j', q:"Is this a red flag? Company asks for unpaid 'test project' before hiring" },
  { id:404, v:1, t:'b', c:'j', q:"Is this statistic meaningful? 'Our users save an average of 2 hours/week'", x:1},
  { id:405, v:1, t:'m', c:'j', q:"Rate this apology: 'I'm sorry, but you misunderstood me'", o:["Genuine apology","Partial apology","Non-apology","Gaslighting"] },
  { id:406, v:1, t:'b', c:'j', q:"Is this review trustworthy? Detailed negative review with specific examples" },
  { id:407, v:1, t:'b', c:'j', q:"Is this argument valid? 'We've always done it this way, so it must work'" },
  { id:408, v:1, t:'m', c:'j', q:"Rate this job red flag level: 'We're like a family here'", o:["Green flag","Yellow flag","Red flag","Depends on context"] },
  { id:409, v:1, t:'b', c:'j', q:"Is this source credible? Preprint study not yet peer-reviewed", x:1},
  { id:410, v:1, t:'b', c:'j', q:"Is this financial advice sound? 'Always max out your 401k before other investments'" },
  { id:411, v:1, t:'m', c:'j', q:"Rate this forecast methodology: Survey of 10 industry experts", o:["Strong","Moderate","Weak","Insufficient info"], x:1},
  { id:412, v:1, t:'b', c:'j', q:"Is this product claim verifiable? 'Clinically proven to reduce wrinkles'", x:1},
  { id:413, v:1, t:'b', c:'j', q:"Is this a valid criticism? 'Your data is correct but your interpretation is wrong'", x:1},
  { id:414, v:1, t:'m', c:'j', q:"Rate this landlord response time: 48 hours for non-emergency repair", o:["Excellent","Acceptable","Poor","Unacceptable"], x:1},
  { id:415, v:1, t:'b', c:'j', q:"Is this news headline clickbait? 'Scientists discover shocking truth about coffee'" },
  { id:416, v:1, t:'b', c:'j', q:"Is this comparison fair? Comparing startup revenue to established company", x:1},
  { id:417, v:1, t:'m', c:'j', q:"Rate this password: 'Summer2024!'", o:["Strong","Moderate","Weak","Very weak"], x:1},
  { id:418, v:1, t:'b', c:'j', q:"Is this testimonial credible? Celebrity endorsement of weight loss product" },
  { id:419, v:1, t:'b', c:'j', q:"Is this logic sound? 'The experts were wrong before, so they're wrong now'", x:1},
  { id:420, v:1, t:'m', c:'j', q:"Rate this salary negotiation tactic: Revealing your current salary", o:["Smart move","Neutral","Mistake","Depends heavily on context"] },
  { id:421, v:1, t:'b', c:'j', q:"Is this study design adequate? Self-reported data from online survey", x:1},
  { id:422, v:1, t:'b', c:'j', q:"Is this price reasonable? $15 for a cocktail in a major city", x:1},
  { id:423, v:1, t:'m', c:'j', q:"Rate this excuse for missing a deadline: 'I had too many other priorities'", o:["Valid","Partially valid","Weak","Unacceptable"] },
  { id:424, v:1, t:'b', c:'j', q:"Is this warranty worth it? Extended warranty on a $500 appliance for $80", x:1},
  { id:425, v:1, t:'b', c:'j', q:"Is this influencer recommendation trustworthy? #Ad disclosed, detailed review" },
  { id:426, v:1, t:'b', c:'r', q:"Is the capital of Canada Ottawa?", x:1 },
  { id:427, v:1, t:'m', c:'r', q:"What is 25% of 200?", o:["25","40","50","75"], x:1 },
  { id:428, v:1, t:'b', c:'r', q:"Does February ever have 30 days?", x:1 },
  { id:429, v:1, t:'b', c:'r', q:"Is gold heavier than silver (by density)?" },
  { id:430, v:1, t:'m', c:'r', q:"What is the next prime after 23?", o:["25","27","29","31"], x:1 },
  { id:431, v:1, t:'b', c:'r', q:"Can two even numbers sum to an odd number?", x:1 },
  { id:432, v:1, t:'b', c:'r', q:"Is Antarctica a continent?" },
  { id:433, v:1, t:'m', c:'r', q:"How many continents are there?", o:["5","6","7","8"], x:1 },
  { id:434, v:1, t:'b', c:'r', q:"Is the Great Wall of China visible from space with the naked eye?" },
  { id:435, v:1, t:'b', c:'r', q:"Do penguins live in the Arctic?" },
  { id:436, v:1, t:'m', c:'r', q:"What is 3Â³?", o:["9","18","27","81"], x:1 },
  { id:437, v:1, t:'b', c:'r', q:"Is the human body made mostly of water?" },
  { id:438, v:1, t:'b', c:'r', q:"Does light travel in a straight line in a vacuum?" },
  { id:439, v:1, t:'m', c:'r', q:"What fraction is equivalent to 0.25?", o:["1/3","1/4","1/5","2/5"], x:1 },
  { id:440, v:1, t:'b', c:'r', q:"Is the Sahara the largest desert on Earth?", e:[ev('n',null,'Consider Antarctica')] },
  // New divergent opinion questions (441+)
  { id:441, v:1, t:'m', c:'j', q:"Which way should toilet paper hang?", o:["Over (away from wall)","Under (against wall)","Doesn't matter","Depends on pets/kids"] },
  { id:442, v:1, t:'m', c:'j', q:"How do you pronounce 'GIF'?", o:["Hard G (like 'gift')","Soft G (like 'jif')","Either is acceptable","Depends on context"] },
  { id:443, v:1, t:'m', c:'j', q:"How do you pronounce 'pecan'?", o:["pee-KAHN","puh-KAHN","PEE-can","pee-CAN"] },
  { id:444, v:2, t:'m', c:'j', q:"Is pineapple a valid pizza topping?", o:["Absolutely â€” sweet + savory is elite","Never â€” it's a crime against pizza","Sometimes â€” depends on the combo","I don't care enough to have an opinion"] },
  { id:445, v:1, t:'m', c:'j', q:"When do you shower?", o:["Morning","Night","Both","Whenever needed"] },
  { id:446, v:1, t:'b', c:'j', q:"Is it acceptable to put ketchup on a hot dog?" },
  { id:447, v:1, t:'m', c:'j', q:"How should you load cups in the dishwasher?", o:["Cups facing up","Cups facing down","Doesn't matter","I hand wash"] },
  { id:448, v:1, t:'b', c:'j', q:"Should you wet your toothbrush before adding toothpaste?" },
  { id:449, v:1, t:'m', c:'j', q:"How do you eat a Kit Kat?", o:["Break apart the bars","Bite straight through","Depends on my mood","Never thought about it"] },
  { id:450, v:1, t:'b', c:'j', q:"Is standing in the left lane on an escalator acceptable if you're not walking?" },
  { id:451, v:1, t:'m', c:'j', q:"What's the correct way to hang a roll of paper towels?", o:["Paper comes over the top","Paper comes from behind","Doesn't matter","Standing upright"] },
  { id:452, v:1, t:'b', c:'j', q:"Is a hot dog a sandwich?", x:1},
  { id:453, v:1, t:'m', c:'j', q:"How do you eat Oreos?", o:["Twist apart, eat cream first","Dunk in milk whole","Eat whole without milk","Scrape cream off, eat cookie only"] },
  { id:454, v:1, t:'b', c:'j', q:"Should you make your bed every morning?" },
  { id:455, v:1, t:'m', c:'j', q:"What's the right amount of ice in a drink?", o:["Packed full","Half full","Just a few cubes","No ice"] },
  // === Spicy Takes (456-465) ===
  { id:456, v:1, t:'m', c:'j', q:"Is it ever acceptable to microwave fish in a shared office?", o:["Sure, it's just food","Only if there's good ventilation","Absolutely not â€” it's a war crime","Depends on the fish"] },
  { id:457, v:1, t:'m', c:'j', q:"Should you tip on an iPad checkout at a counter-service place?", o:["Always â€” workers deserve it","Only if service was great","No â€” it's guilt-tripping","I tip but resent the screen flip"] },
  { id:458, v:1, t:'b', c:'j', q:"Do you wash your legs in the shower, or does the soap running down count?" },
  { id:459, v:1, t:'m', c:'j', q:"The thumbs-up emoji (ðŸ‘) in a text is:", o:["Friendly and efficient","Passive-aggressive","Depends on who sends it","I never use it"] },
  { id:460, v:1, t:'b', c:'r', q:"Should guests take their shoes off in someone else's house without being asked?" },
  { id:461, v:1, t:'b', c:'j', q:"Is double-dipping a chip after one bite acceptable?" },
  { id:462, v:1, t:'m', c:'j', q:"How do you pronounce 'crayon'?", o:["CRAY-on (2 syllables)","CRAN (1 syllable)","CROWN","Something else entirely"] },
  { id:463, v:1, t:'m', c:'j', q:"What's the correct way to eat a burrito?", o:["Handheld â€” no utensils allowed","Fork and knife is fine","Depends on structural integrity","Deconstruct and eat as a bowl"] },
  { id:464, v:1, t:'b', c:'j', q:"Is ketchup superior to mayo as a fry condiment?" },
  { id:465, v:1, t:'m', c:'j', q:"Red Sox vs Yankees â€” who has the better legacy?", o:["Red Sox â€” curse-breaking underdogs","Yankees â€” 27 rings speaks for itself","Neither â€” baseball is boring","I care deeply and will not elaborate"] },
  // === Would You Rather / Scenarios (466-472) ===
  { id:466, v:1, t:'m', c:'r', q:"Would you rather always know when someone is lying, or always get away with lying?", o:["Know when others lie","Always get away with it","Neither â€” ignorance is bliss","Both would ruin relationships"] },
  { id:467, v:1, t:'m', c:'r', q:"You find $500 cash on the ground with no one around. What do you do?", o:["Keep it â€” finders keepers","Turn it in to police/lost & found","Keep it but feel guilty","Take it and donate it"] },
  { id:468, v:1, t:'m', c:'r', q:"A genie offers one wish but everyone you know will remember you made it. What do you pick?", o:["Unlimited wealth","Perfect health forever","World peace","The ability to time travel"] },
  { id:469, v:1, t:'m', c:'r', q:"You can have one superpower, but everyone can see when you use it. Which one?", o:["Flight","Mind reading","Invisibility (ironic, yes)","Time freeze"] },
  { id:470, v:1, t:'b', c:'r', q:"Would you rather be universally loved but never fully trusted, or fully trusted by few but not widely liked?" },
  { id:471, v:1, t:'m', c:'r', q:"You can erase one memory permanently. What category?", o:["An embarrassing moment","A heartbreak","A failure","I wouldn't erase anything"] },
  { id:472, v:1, t:'m', c:'r', q:"Your best friend is about to make a decision you think is terrible. Do you:", o:["Speak up â€” honesty is everything","Drop hints but respect their choice","Stay quiet â€” they'll learn","Depends on the stakes"] },
  // === Diversified Predictions (473-477) ===
  { id:473, v:1, t:'b', c:'p', q:"Will the 4-day workweek be standard at most companies by 2035?" },
  { id:474, v:1, t:'b', c:'p', q:"Will movie theaters still exist in their current form by 2040?" },
  { id:475, v:1, t:'b', c:'p', q:"Will pickleball surpass tennis in US popularity by 2030?" },
  { id:476, v:1, t:'b', c:'p', q:"Will most schools ban personal phones in classrooms by 2028?" },
  { id:477, v:1, t:'b', c:'p', q:"Will 'sober socializing' (no-alcohol events) become mainstream by 2030?" },
  // === Fun Philosophy (478-482) ===
  { id:478, v:1, t:'m', c:'r', q:"Is it better to be honest or kind when you can't be both?", o:["Honest â€” truth matters most","Kind â€” feelings matter most","Depends on the situation","You can always be both if you try"] },
  { id:479, v:1, t:'b', c:'r', q:"Can you truly forgive someone who isn't sorry?" },
  { id:480, v:1, t:'m', c:'r', q:"Is luck real, or just pattern recognition after the fact?", o:["Luck is real â€” some people have it","It's just randomness we narrate","You make your own luck","Both â€” preparation meets opportunity"] },
  { id:481, v:1, t:'m', c:'r', q:"'Just be yourself' is:", o:["Great advice â€” authenticity wins","Terrible advice â€” growth requires change","Privilege â€” not everyone can","Only works if you like yourself"] },
  { id:482, v:1, t:'b', c:'r', q:"Can you separate the art from the artist?" },
  // === Wild Cards (483-485) ===
  { id:483, v:1, t:'m', c:'r', q:"The shopping cart test: do you always return it to the corral?", o:["Always â€” it's a moral duty","Usually â€” unless it's raining","Rarely â€” that's what cart collectors are for","I push it toward the corral and hope"] },
  { id:484, v:1, t:'m', c:'j', q:"If animals could talk, which would be the rudest?", o:["Cats â€” obviously","Geese â€” already aggressive","Raccoons â€” chaotic energy","Seagulls â€” no remorse"] },
  { id:485, v:1, t:'m', c:'j', q:"What minor inconvenience fills you with disproportionate rage?", o:["Slow walkers in narrow hallways","Tangled earbuds/chargers","When the fitted sheet pops off","Someone saying 'we need to talk'"] },
];

// Expand to full format
const QUESTIONS = Q_RAW.filter(q => !q.x).map(q => ({
  id: q.id, type: T[q.t], text: q.q, category: C[q.c],
  ...(q.o && { options: q.o }), ...(q.e && { preEvidence: q.e }), _v: q.v,
}));
const getCategoryList = () => Object.values(CAT_MAP);

// ==================== ONBOARDING QUESTIONS ====================
// Fun "world" questions for new users - not about themselves
// These feel like a game, build momentum before self-discovery
const ONBOARDING_QUESTIONS = [
  { id: 'onboard-1', text: "Which came first?", options: ["The chicken", "The egg"], icons: ["ðŸ”", "ðŸ¥š"], colors: ['amber', 'blue'], type: 'binary' },
  { id: 'onboard-2', text: "Better pizza topping:", options: ["Pepperoni", "Pineapple"], icons: ["ðŸ•", "ðŸ"], colors: ['rose', 'emerald'], type: 'binary' },
  { id: 'onboard-3', text: "Better superpower:", options: ["Flight", "Invisibility"], icons: ["ðŸ¦…", "ðŸ‘»"], colors: ['cyan', 'pink'], type: 'binary' },
  { id: 'onboard-4', text: "Dogs or cats?", options: ["Dogs", "Cats"], icons: ["ðŸ•", "ðŸˆ"], colors: ['blue', 'emerald'], type: 'binary' },
  { id: 'onboard-5', text: "Will AI fundamentally change most jobs?", options: ["Yes, nothing's safe", "No, mostly the same"], icons: ["ðŸ¤–", "ðŸ’¼"], colors: ['violet', 'cyan'], type: 'binary' },
];
  </script>
  <script>
    // Supabase Configuration
    const SUPABASE_URL = 'https://tzhmhlllblhfvtqmmsuu.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_5qNssH06WHWBYSKDVGGrHg_m4MOC7su';

    // Initialize Supabase
    const auraDB = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // Generate anonymous session ID (for pre-auth response capture)
    const AURA_SESSION_ID = localStorage.getItem('aura_session_id') || (() => {
      const id = 'anon_' + Math.random().toString(36).slice(2, 11);
      localStorage.setItem('aura_session_id', id);
      return id;
    })();

    // ==================== AUTH STATE ====================
    let AURA_AUTH_USER = null;
    let AURA_USER_EMAIL = null;
    let AURA_DISPLAY_NAME = null;
    let _auraAuthReady;
    const auraAuthReady = new Promise(r => { _auraAuthReady = r; });

    auraDB.auth.onAuthStateChange(async (event, session) => {
      console.log('[Aura] Auth:', event);
      if (session?.user) {
        AURA_AUTH_USER = session.user;
        AURA_USER_EMAIL = session.user.email;

        if (event === 'SIGNED_IN' || event === 'INITIAL_SESSION') {
          // Fire in background â€” NEVER await Supabase calls inside onAuthStateChange (deadlocks the client)
          setTimeout(async () => {
            try {
              if (event === 'SIGNED_IN') {
                await createEmailClaim(session.user.id, session.user.email);
                await migrateLocalAssessments(session.user.id);
                await claimMyResponses();
                // Persist entity gate declaration to profile if it exists
                try {
                  const gateRaw = localStorage.getItem('aura-entity-declared');
                  if (gateRaw) {
                    const gate = JSON.parse(gateRaw);
                    if (gate.type && gate.type !== 'unknown') {
                      await updateEntityProfile(session.user.id, gate.type, gate.model || null);
                    }
                  }
                } catch {}
              }
              // Load profile display name
              const name = await loadProfile(session.user.id);
              AURA_DISPLAY_NAME = name;
              window.dispatchEvent(new CustomEvent('aura-profile-change', { detail: { displayName: name } }));
              // Load user claims
              const claims = await loadUserClaims(session.user.id);
              window.dispatchEvent(new CustomEvent('aura-claims-loaded', { detail: { claims } }));
            } catch (err) {
              console.warn('[Aura] Post-signin sync error:', err.message);
            }
          }, 0);
        }
      } else {
        AURA_AUTH_USER = null;
        AURA_USER_EMAIL = null;
        window.dispatchEvent(new CustomEvent('aura-claims-loaded', { detail: { claims: [] } }));
      }
      window.dispatchEvent(new CustomEvent('aura-auth-change', {
        detail: { user: session?.user || null, event }
      }));
      _auraAuthReady();
    });

    // Capture response to Supabase with snapshot (only when signed in)
    async function captureResponse(questionId, answer, confidence) {
      if (!AURA_AUTH_USER) return; // Skip cloud capture when not signed in
      try {
        const question = QUESTIONS.find(q => q.id === questionId);
        const response = {
          session_id: AURA_SESSION_ID,
          question_id: questionId,
          answer: answer,
          confidence: confidence,
          email: AURA_USER_EMAIL,
          snapshot: question ? {
            q: question.text,
            a: question.type === 'binary' ? (answer ? 'Yes' : 'No') : (question.options?.[answer] || String(answer)),
            t: question.type,
            c: question.category,
            v: question._v
          } : null
        };

        const { error } = await auraDB.from('responses').insert(response);

        if (error) {
          console.error('[Aura] Capture failed:', error);
        } else {
          console.log('[Aura] Response captured:', response);
        }
      } catch (err) {
        console.warn('[Aura] Capture error (non-blocking):', err.message);
      }
    }

    // Capture assessment response with test_id and snapshot (only when signed in)
    async function captureAssessResponse(testId, questionIndex, answer) {
      if (!AURA_AUTH_USER) return; // Skip cloud capture when not signed in
      try {
        const test = ASSESS_TESTS[testId];
        const item = test?.items?.[questionIndex];
        const scaleLabels = {
          likeme: ['Not at all', 'A little', 'Somewhat', 'Very much', 'Extremely'],
          agreement: ['Strongly disagree', 'Disagree', 'Neutral', 'Agree', 'Strongly agree'],
          frequency: ['Never', 'Rarely', 'Sometimes', 'Often', 'Always'],
          likelihood: ['Very unlikely', 'Unlikely', 'Neutral', 'Likely', 'Very likely']
        };

        const response = {
          session_id: AURA_SESSION_ID,
          question_id: -(questionIndex + 1), // Negative to distinguish from regular questions
          answer: answer,
          confidence: 0,
          email: AURA_USER_EMAIL,
          test_id: testId,
          snapshot: test && item ? {
            test: testId,
            name: test.name,
            q: item.q,
            a: scaleLabels[test.scale]?.[answer - 1] || String(answer),
            idx: questionIndex
          } : null
        };

        const { error } = await auraDB.from('responses').insert(response);

        if (error) {
          console.error('[Aura] Assessment capture failed:', error);
        } else {
          console.log('[Aura] Assessment captured:', testId, 'q' + questionIndex, '=', answer);
        }
      } catch (err) {
        console.warn('[Aura] Assessment capture error (non-blocking):', err.message);
      }
    }

    // Export all local data as JSON
    function exportUserData() {
      const data = localStorage.getItem('aura-demo-vI');
      if (!data) {
        showToast('No data to export');
        return;
      }
      const blob = new Blob([data], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `aura-backup-${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      URL.revokeObjectURL(url);
    }

    // Export user data in AI-friendly format from Supabase
    async function exportForAI(email) {
      const { data: responses, error } = await auraDB.from('responses')
        .select('*')
        .eq('email', email)
        .order('created_at', { ascending: true });

      if (error) {
        console.error('[Aura] Export failed:', error);
        return null;
      }

      const questions = responses
        .filter(r => r.question_id > 0)
        .map(r => ({
          question: r.snapshot?.q || `Question #${r.question_id}`,
          answer: r.snapshot?.a || String(r.answer),
          confidence: ['Hunch', 'Leaning', 'Firm', 'Certain'][r.confidence - 1] || r.confidence,
          category: r.snapshot?.c || 'unknown',
          type: r.snapshot?.t || 'unknown',
          answered_at: r.created_at
        }));

      const assessments = {};
      responses.filter(r => r.test_id).forEach(r => {
        if (!assessments[r.test_id]) {
          assessments[r.test_id] = { name: r.snapshot?.name || r.test_id, items: [] };
        }
        assessments[r.test_id].items.push({
          question: r.snapshot?.q || `Item #${Math.abs(r.question_id)}`,
          answer: r.snapshot?.a || String(r.answer)
        });
      });

      return {
        user: email,
        exported_at: new Date().toISOString(),
        summary: {
          total_questions: questions.length,
          total_assessments: Object.keys(assessments).length
        },
        questions,
        assessments
      };
    }

    // Import data from JSON file
    function importUserData(file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const data = JSON.parse(e.target.result);
          if (data.answers && data.settings) {
            localStorage.setItem('aura-demo-vI', JSON.stringify(data));
            showToast('âœ“ Data imported', 2000);
            setTimeout(() => window.location.reload(), 1500);
          } else {
            showToast('Invalid backup file');
          }
        } catch (err) {
          showToast('Error: ' + err.message);
        }
      };
      reader.readAsText(file);
    }

    // Toast notification system
    function showToast(message, duration = 2000) {
      const existing = document.getElementById('aura-toast');
      if (existing) existing.remove();

      const toast = document.createElement('div');
      toast.id = 'aura-toast';
      toast.innerHTML = message;
      toast.style.cssText = `
        position: fixed;
        top: 120px;
        left: 50%;
        transform: translateX(-50%);
        background: linear-gradient(135deg, #7c3aed, #8b5cf6);
        color: white;
        padding: 12px 20px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: 600;
        z-index: 99999;
        text-align: center;
        box-shadow: 0 4px 20px rgba(124, 58, 237, 0.4);
        animation: toastSlide 0.3s ease;
      `;
      document.body.appendChild(toast);
      setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateX(-50%) translateY(-10px)';
        toast.style.transition = 'all 0.3s ease';
        setTimeout(() => toast.remove(), 300);
      }, duration);
    }

    // ==================== AUTH FUNCTIONS ====================

    async function signUpWithPassword(email, password) {
      const { data, error } = await auraDB.auth.signUp({
        email: email.toLowerCase(),
        password
      });
      if (error) {
        console.error('[Aura] Sign up failed:', error);
        return { success: false, error: error.message };
      }
      return { success: true, user: data?.user };
    }

    async function signInWithPassword(email, password) {
      const { data, error } = await auraDB.auth.signInWithPassword({
        email: email.toLowerCase(),
        password
      });
      if (error) {
        console.error('[Aura] Sign in failed:', error);
        // Friendly error messages
        if (error.message.includes('Invalid login credentials')) {
          return { success: false, error: 'Wrong email or password' };
        }
        return { success: false, error: error.message };
      }
      return { success: true, user: data?.user };
    }

    // ==================== EMAIL CLAIM ====================

    async function createEmailClaim(userId, email) {
      const normalized = email.toLowerCase().trim();
      const hashInput = 'email:' + normalized;
      const hashBuffer = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(hashInput));
      const hashHex = Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');

      const { error } = await auraDB.from('claims').upsert({
        user_id: userId,
        type: 'contact',
        provider: 'email',
        label: normalized,
        value: normalized,
        proof_type: 'password',
        proof_status: 'verified',
        visibility: 'private',
        hash: hashHex,
        weight: 1
      }, { onConflict: 'hash' });

      if (error) {
        console.error('[Aura] Email claim failed:', error);
      } else {
        console.log('[Aura] Email claim created:', normalized);
      }
    }

    // ==================== ACCOUNT CLAIMS ====================

    async function loadUserClaims(userId) {
      try {
        const { data, error } = await auraDB.from('claims')
          .select('*')
          .eq('user_id', userId)
          .order('created_at', { ascending: true });
        if (error) {
          console.error('[Aura] Claims load failed:', error);
          return [];
        }
        return data || [];
      } catch (err) {
        console.warn('[Aura] Claims load error:', err.message);
        return [];
      }
    }

    async function createAccountClaim(userId, provider, label, value) {
      try {
        const hashInput = provider + ':' + value.toLowerCase().trim();
        const hashBuffer = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(hashInput));
        const hashHex = Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');

        const { data, error } = await auraDB.from('claims').upsert({
          user_id: userId,
          type: 'account',
          provider,
          label: label.trim(),
          value: value.trim(),
          proof_type: 'self_reported',
          proof_status: 'unverified',
          visibility: 'public',
          hash: hashHex,
          weight: 0
        }, { onConflict: 'hash' }).select().single();

        if (error) {
          console.error('[Aura] Account claim failed:', error);
          return null;
        }
        console.log('[Aura] Account claim created:', provider, label);
        return data;
      } catch (err) {
        console.warn('[Aura] Account claim error:', err.message);
        return null;
      }
    }

    async function removeClaim(claimId, userId) {
      try {
        const { error } = await auraDB.from('claims')
          .delete()
          .eq('id', claimId)
          .eq('user_id', userId);
        if (error) {
          console.error('[Aura] Claim delete failed:', error);
          return false;
        }
        console.log('[Aura] Claim removed:', claimId);
        return true;
      } catch (err) {
        console.warn('[Aura] Claim delete error:', err.message);
        return false;
      }
    }

    async function updateClaimVisibility(claimId, userId, visibility) {
      try {
        const { error } = await auraDB.from('claims')
          .update({ visibility })
          .eq('id', claimId)
          .eq('user_id', userId);
        if (error) {
          console.error('[Aura] Claim visibility update failed:', error);
          return false;
        }
        console.log('[Aura] Claim visibility updated:', claimId, visibility);
        return true;
      } catch (err) {
        console.warn('[Aura] Claim visibility error:', err.message);
        return false;
      }
    }

    async function setPrimaryClaim(userId, claimId) {
      try {
        // Clear all user's claims to non-primary
        const { error: clearErr } = await auraDB.from('claims')
          .update({ weight: 0 })
          .eq('user_id', userId);
        if (clearErr) {
          console.error('[Aura] Clear primary failed:', clearErr);
          return false;
        }
        // Set chosen claim as primary + force public visibility
        const { error: setErr } = await auraDB.from('claims')
          .update({ weight: 1, visibility: 'public' })
          .eq('id', claimId)
          .eq('user_id', userId);
        if (setErr) {
          console.error('[Aura] Set primary failed:', setErr);
          return false;
        }
        console.log('[Aura] Primary claim set:', claimId);
        return true;
      } catch (err) {
        console.warn('[Aura] Set primary error:', err.message);
        return false;
      }
    }

    // ==================== PROFILE SUMMARY (for sharing) ====================

    async function updateProfileSummary(userId, assessCompleted, userClaims, entityType) {
      try {
        const summary = {
          assessment_count: Object.keys(assessCompleted || {}).length,
          stamp_count: (userClaims || []).filter(c => c.visibility === 'public').length,
          entity_type: entityType || 'human',
          updated_at: new Date().toISOString()
        };

        // Try to compute archetype if calculateArchetype is available in React context
        // This runs from Script #3, so we store minimal data and let the public profile compute archetype client-side

        const { error } = await auraDB.from('profiles')
          .update({ profile_summary: summary, updated_at: new Date().toISOString() })
          .eq('id', userId);
        if (error) {
          console.error('[Aura] Profile summary update failed:', error);
        }
      } catch (err) {
        console.warn('[Aura] Profile summary error:', err.message);
      }
    }

    async function loadPublicProfile(userId) {
      try {
        // RLS enforces visibility='public' for anon reads; explicit filter for clarity
        const [profileRes, claimsRes] = await Promise.all([
          auraDB.from('profiles').select('id, display_name, profile_summary').eq('id', userId).single(),
          auraDB.from('claims').select('*').eq('user_id', userId).eq('visibility', 'public')
        ]);
        if (profileRes.error) {
          console.error('[Aura] Public profile load failed:', profileRes.error);
          return null;
        }
        return {
          profile: profileRes.data,
          claims: claimsRes.data || []
        };
      } catch (err) {
        console.warn('[Aura] Public profile error:', err.message);
        return null;
      }
    }

    // ==================== COMPARISON SHORT LINKS ====================

    // Generate 8-char alphanumeric ID
    function generateCompareId() {
      const chars = 'abcdefghijkmnpqrstuvwxyz23456789'; // no ambiguous chars (0/O, 1/l)
      let id = '';
      for (let i = 0; i < 8; i++) id += chars[Math.floor(Math.random() * chars.length)];
      return id;
    }

    // Create a comparison link â€” returns short ID
    async function createComparison(traits, name, entityType) {
      const id = generateCompareId();
      try {
        const { error } = await auraDB.from('comparisons').insert({
          id,
          traits,
          name: name || null,
          entity_type: entityType || 'human'
        });
        if (error) {
          console.warn('[Aura] Comparison save failed:', error.message);
          return null;
        }
        return id;
      } catch (err) {
        console.warn('[Aura] Comparison save error:', err.message);
        return null;
      }
    }

    // Load comparison data by short ID
    async function loadComparison(id) {
      try {
        const { data, error } = await auraDB.from('comparisons')
          .select('traits, name, entity_type')
          .eq('id', id)
          .single();
        if (error || !data) return null;
        return { traits: data.traits, name: data.name, entity: data.entity_type };
      } catch (err) {
        console.warn('[Aura] Comparison load error:', err.message);
        return null;
      }
    }

    // Build a clean compare URL from a short ID
    function getCompareUrl(shortId) {
      const base = window.location.origin + window.location.pathname;
      return `${base}?c=${shortId}`;
    }

    // ==================== ASSESSMENT SYNC ====================

    async function saveAssessmentToCloud(userId, testId, status, answers, traits, progress) {
      try {
        const row = {
          user_id: userId,
          category_id: testId,
          status,
          answers,
          traits,
          progress,
          updated_at: new Date().toISOString()
        };
        if (status === 'completed') row.completed_at = new Date().toISOString();

        const { error } = await auraDB.from('assessment_results')
          .upsert(row, { onConflict: 'user_id,category_id' });
        if (error) {
          console.error('[Aura] Assessment save failed:', error);
        }
      } catch (err) {
        console.warn('[Aura] Assessment save error (non-blocking):', err.message);
      }
    }

    async function deleteAssessmentFromCloud(userId, testId) {
      const { error } = await auraDB.from('assessment_results')
        .delete()
        .eq('user_id', userId)
        .eq('category_id', testId);
      if (error) console.error('[Aura] Assessment delete failed:', error);
    }

    async function clearAllAssessmentsFromCloud(userId) {
      const { error } = await auraDB.from('assessment_results')
        .delete()
        .eq('user_id', userId);
      if (error) console.error('[Aura] Assessment clear failed:', error);
    }

    async function loadAssessmentsFromCloud(userId) {
      const { data, error } = await auraDB.from('assessment_results')
        .select('*')
        .eq('user_id', userId);
      if (error) {
        console.error('[Aura] Assessment load failed:', error);
        return null;
      }

      const completed = {};
      const inProgress = {};
      for (const row of (data || [])) {
        if (row.status === 'completed') {
          completed[row.category_id] = row.traits || {};
        } else {
          inProgress[row.category_id] = {
            index: row.answers?.currentIndex || 0,
            responses: row.answers?.responses || {},
            skipped: row.answers?.skipped || []
          };
        }
      }
      return { completed, inProgress };
    }

    async function migrateLocalAssessments(userId) {
      const ASSESS_KEY = 'aura-assessments-v1';
      let local;
      try { local = JSON.parse(localStorage.getItem(ASSESS_KEY)); } catch { return; }
      if (!local) return;

      // Skip if user already has cloud data
      const cloud = await loadAssessmentsFromCloud(userId);
      if (cloud && (Object.keys(cloud.completed).length > 0 || Object.keys(cloud.inProgress).length > 0)) {
        console.log('[Aura] Cloud data exists, skipping migration');
        return;
      }

      console.log('[Aura] Migrating localStorage assessments to cloud...');
      if (local.completed) {
        for (const [testId, results] of Object.entries(local.completed)) {
          await saveAssessmentToCloud(userId, testId, 'completed', {}, results, 1.0);
        }
      }
      if (local.inProgress) {
        for (const [testId, progress] of Object.entries(local.inProgress)) {
          const answeredCount = Object.keys(progress.responses || {}).length;
          await saveAssessmentToCloud(userId, testId, 'in-progress', {
            responses: progress.responses || {},
            skipped: progress.skipped || [],
            currentIndex: progress.index || 0
          }, null, answeredCount > 0 ? 0.5 : 0);
        }
      }
      console.log('[Aura] Migration complete');
    }

    // Claim all responses from current session and attach email
    async function claimMyResponses() {
      if (!AURA_USER_EMAIL) {
        console.log('[Aura] Not signed in, cannot claim');
        return { success: false, error: 'Sign in first' };
      }

      // Update all responses with this session_id to have the current email
      const { data, error } = await auraDB.from('responses')
        .update({ email: AURA_USER_EMAIL })
        .eq('session_id', AURA_SESSION_ID)
        .is('email', null);

      if (error) {
        console.error('[Aura] Claim failed:', error);
        return { success: false, error: 'Failed to claim responses' };
      }

      console.log('[Aura] Claimed responses for session:', AURA_SESSION_ID);
      return { success: true };
    }

    // ==================== PROFILE SYNC ====================

    async function loadProfile(userId) {
      try {
        const { data, error } = await auraDB.from('profiles')
          .select('display_name')
          .eq('id', userId)
          .single();
        if (error) {
          console.error('[Aura] Profile load failed:', error);
          return null;
        }
        return data?.display_name || null;
      } catch (err) {
        console.warn('[Aura] Profile load error:', err.message);
        return null;
      }
    }

    async function updateDisplayName(userId, name) {
      try {
        const { error } = await auraDB.from('profiles')
          .update({ display_name: name, updated_at: new Date().toISOString() })
          .eq('id', userId);
        if (error) {
          console.error('[Aura] Display name update failed:', error);
          return false;
        }
        AURA_DISPLAY_NAME = name;
        window.dispatchEvent(new CustomEvent('aura-profile-change', { detail: { displayName: name } }));
        return true;
      } catch (err) {
        console.warn('[Aura] Display name update error:', err.message);
        return false;
      }
    }

    function getDisplayName() {
      return AURA_DISPLAY_NAME;
    }

    async function signOut() {
      await auraDB.auth.signOut();
      AURA_AUTH_USER = null;
      AURA_USER_EMAIL = null;
      AURA_DISPLAY_NAME = null;
      localStorage.removeItem('aura_user_email');
      console.log('[Aura] Signed out');
    }

    function getCurrentEmail() {
      return AURA_USER_EMAIL;
    }

    function getCurrentUser() {
      return AURA_AUTH_USER;
    }

    // ==================== ENTITY PROFILE UPDATE ====================
    // Called after sign-in to persist entity_type + model_name from entity gate
    async function updateEntityProfile(userId, entityType, modelName) {
      try {
        const updates = { entity_type: entityType || 'human', updated_at: new Date().toISOString() };
        if (modelName) updates.model_name = modelName;
        const { error } = await auraDB.from('profiles').update(updates).eq('id', userId);
        if (error) console.warn('[Aura] Entity profile update failed:', error.message);
        else console.log('[Aura] Entity profile updated:', entityType, modelName || '');
      } catch (err) {
        console.warn('[Aura] Entity profile update error:', err.message);
      }
    }
  </script>
  <script type="text/babel">
const { useState, useEffect, useRef, useCallback, useMemo } = React;

// ==================== UNIFIED COLOR SYSTEM ====================
// Single source of truth for all Aura colors. Add new colors here.
// Everything else derives from this object.
const COLOR_HEX = {
  violet:  { base: '#8b5cf6', light: '#a78bfa', rgb: '139, 92, 246' },
  blue:    { base: '#3b82f6', light: '#60a5fa', rgb: '59, 130, 246' },
  teal:    { base: '#14b8a6', light: '#2dd4bf', rgb: '20, 184, 166' },
  rose:    { base: '#f43f5e', light: '#fb7185', rgb: '244, 63, 94' },
  pink:    { base: '#d946ef', light: '#e879f9', rgb: '217, 70, 239', tw: 'fuchsia' },
  emerald: { base: '#10b981', light: '#34d399', rgb: '16, 185, 129' },
  slate:   { base: '#7c85a6', light: '#a0a8c8', rgb: '124, 133, 166' },
  amber:   { base: '#f59e0b', light: '#fbbf24', rgb: '245, 158, 11' },
  indigo:  { base: '#6366f1', light: '#818cf8', rgb: '99, 102, 241' },
  cyan:    { base: '#06b6d4', light: '#67e8f9', rgb: '6, 182, 212' },
  gray:    { base: '#6b7280', light: '#9ca3af', rgb: '107, 114, 128' },
};
const twColor = (c) => COLOR_HEX[c]?.tw || c; // pink -> fuchsia for Tailwind

// Binary answer colors - single source of truth
// Array order: lightâ†’dark (index 0=lightest conf1, index 3=darkest conf4)
// Iteration [3,2,1,0] displays darkest first (most confident answers prominent)
const BINARY_COLORS = {
  yes: ['#a7f3d0', '#6ee7b7', '#34d399', '#10b981'], // emerald lightâ†’dark
  no: ['#fecaca', '#fda4af', '#fb7185', '#f43f5e'],  // rose lightâ†’dark
};

// ==================== CONFIDENCE HELPERS ====================
// Convert 1-4 confidence to 0-3 index (clamped, with default)
const normalizeConf = (c) => Math.min(3, Math.max(0, (c || 1) - 1));

// ==================== THEME TOKENS ====================
// TH(token, darkMode) - returns the appropriate classes for the current theme
const TH = (token, dark) => { const val = {
  // Text colors
  'text-primary': dark ? 'text-white' : 'text-gray-900',
  'text-secondary': dark ? 'text-gray-300' : 'text-gray-700',
  'text-muted': dark ? 'text-gray-400' : 'text-gray-600',
  'text-subtle': dark ? 'text-gray-500' : 'text-gray-400',
  'text-faint': dark ? 'text-gray-600' : 'text-gray-400',
  'text-inverted': dark ? 'text-gray-900' : 'text-white',
  // Background colors
  'bg-main': dark ? 'bg-gray-950' : 'bg-gray-50',
  'bg-card': dark ? 'bg-white/[0.04] border border-white/[0.06] hover-glow' : 'bg-white border border-black/[0.10] shadow-sm hover-glow',
  'bg-card-shine': dark ? 'bg-white/[0.04] shine-card shine-gray border border-white/[0.06] hover-glow' : 'bg-white border border-black/[0.10] shadow-sm hover-glow',
  'bg-elevated': dark ? 'bg-white/[0.06]' : 'bg-gray-200',
  'bg-input': dark ? 'bg-white/[0.06] text-white placeholder-gray-500' : 'bg-gray-100 text-gray-900 placeholder-gray-400',
  'bg-surface': dark ? 'bg-white/[0.03]' : 'bg-white/90',
  'bg-overlay': dark ? 'bg-white/[0.04]' : 'bg-gray-100',
  // Border colors
  'border-base': dark ? 'border-white/[0.06]' : 'border-gray-200',
  'border-subtle': dark ? 'border-white/[0.08]' : 'border-gray-300',
  // Interactive states
  'btn-secondary': dark ? 'bg-white/[0.06] text-gray-500 hover:bg-white/[0.10]' : 'bg-gray-200 text-gray-500',
  'btn-ghost': dark ? 'text-gray-300 active:text-white' : 'text-gray-600 active:text-gray-900',
  // Status colors (stay vibrant in both modes)
  'text-emerald': dark ? 'text-emerald-400' : 'text-emerald-600',
  'text-rose': dark ? 'text-rose-400' : 'text-rose-600',
  'text-violet': dark ? 'text-violet-400' : 'text-violet-600',
  'text-sky': dark ? 'text-sky-300' : 'text-sky-500',
  'text-blue': dark ? 'text-blue-400' : 'text-blue-600',
  // Additional patterns
  'text-dim': dark ? 'text-gray-400' : 'text-gray-500',
  'text-bright': dark ? 'text-gray-100' : 'text-gray-900',
  'text-muted-flip': dark ? 'text-gray-300' : 'text-gray-600',
  'text-muted-dark': dark ? 'text-gray-700' : 'text-gray-300',
  'bg-card-simple': dark ? 'bg-white/[0.04]' : 'bg-white/80 border border-black/[0.06]',
  'bg-inverted': dark ? 'bg-white' : 'bg-gray-900',
  'bg-card-full': dark ? 'bg-white/[0.04] text-white' : 'bg-white/80 text-gray-900',
  'bg-disabled': dark ? 'bg-white/[0.04] text-gray-600' : 'bg-gray-200 text-gray-400',
  'bg-disabled-alt': dark ? 'bg-white/[0.04] text-gray-400' : 'bg-gray-200 text-gray-600',
  'bg-mid': dark ? 'bg-gray-600' : 'bg-gray-200',
  'text-bright-bg': dark ? 'text-white bg-gray-950' : 'text-gray-900 bg-gray-50',
  'border-bg-main': dark ? 'border-white/[0.06] bg-gray-950' : 'border-gray-200 bg-white',
  'chip-violet': dark ? 'bg-violet-900/30 text-violet-400' : 'bg-violet-100 text-violet-700',
  'chip-violet-alt': dark ? 'bg-violet-500/20 text-violet-400' : 'bg-violet-100 text-violet-600',
}[token];
  if (val === undefined && ['localhost','127.0.0.1',''].includes(location?.hostname)) console.warn(`[TH] Unknown token: "${token}"`);
  return val || '';
};

// ==================== HELPERS ====================
const hexToRgba = (hex, alpha) => {
  const r = parseInt(hex.slice(1,3), 16);
  const g = parseInt(hex.slice(3,5), 16);
  const b = parseInt(hex.slice(5,7), 16);
  return `rgba(${r},${g},${b},${alpha})`;
};

// ==================== AURA VISUALIZATION ====================
// Organism viz â€” blob primaries with interiors, membrane bubble, tissue connections
const AuraVisualization = React.memo(function AuraVisualization({
  onboardingAnswers = {},
  assessCompleted = {},
  entityType = 'human',
  darkMode = true,
  size = 200,
}) {
  const canvasRef = React.useRef(null);
  const animRef = React.useRef(null);
  const propsRef = React.useRef({ onboardingAnswers, assessCompleted, entityType, darkMode, size });
  propsRef.current = { onboardingAnswers, assessCompleted, entityType, darkMode, size };

  React.useEffect(() => {
    const canvas = canvasRef.current;
    if (!canvas) return;
    const ctx = canvas.getContext('2d');

    // â•â•â• CONSTANTS â•â•â•
    const PI = Math.PI, TAU = PI * 2;
    const TR = {
      O: { l:'Open',  base:[78,205,196],  acc:[255,154,139] },
      C: { l:'Consc', base:[69,183,209],  acc:[255,183,77] },
      E: { l:'Extra', base:[150,230,161], acc:[230,120,200] },
      A: { l:'Agree', base:[221,160,221], acc:[120,220,180] },
      N: { l:'Neuro', base:[247,220,111], acc:[140,160,240] },
    };
    const TK = Object.keys(TR);
    const SSC = [0.20, 0.45, 0.72, 1.0];
    const GSC = [0.35, 0.55, 0.78, 1.0];

    // Onboarding question â†’ primary mapping (5 questions â†’ 5 traits)
    const NEURON_MAP = [
      { colorQ:'onboard-1', posQ:'onboard-2' },
      { colorQ:'onboard-2', posQ:'onboard-3' },
      { colorQ:'onboard-3', posQ:'onboard-4' },
      { colorQ:'onboard-4', posQ:'onboard-5' },
      { colorQ:'onboard-5', posQ:'onboard-1' },
    ];

    // â•â•â• HELPERS â•â•â•
    function m32(a){return function(){a|=0;a=a+0x6D2B79F5|0;let t=Math.imul(a^a>>>15,1|a);t=t+Math.imul(t^t>>>7,61|t)^t;return((t^t>>>14)>>>0)/4294967296;};}
    function rga(c,a){return`rgba(${c[0]|0},${c[1]|0},${c[2]|0},${a})`;}
    function ltn(c,n){return[Math.min(255,c[0]+n),Math.min(255,c[1]+n),Math.min(255,c[2]+n)];}
    function drk(c,n){return[Math.max(0,c[0]-n),Math.max(0,c[1]-n),Math.max(0,c[2]-n)];}
    function dst(x1,y1,x2,y2){const a=x1-x2,b=y1-y2;return Math.sqrt(a*a+b*b);}
    function bl(cs,ws){let r=0,g=0,b=0,w=0;for(let i=0;i<cs.length;i++){r+=cs[i][0]*ws[i];g+=cs[i][1]*ws[i];b+=cs[i][2]*ws[i];w+=ws[i];}return w?[r/w|0,g/w|0,b/w|0]:[128,128,128];}
    function lr3(a,b,t){return[a[0]+(b[0]-a[0])*t,a[1]+(b[1]-a[1])*t,a[2]+(b[2]-a[2])*t];}
    function clamp(v,lo,hi){return v<lo?lo:v>hi?hi:v;}

    // â•â•â• VALUE NOISE â•â•â•
    const PERM=new Uint8Array(512);
    (function(){const r=m32(42);for(let i=0;i<256;i++)PERM[i]=i;
      for(let i=255;i>0;i--){const j=(r()*i)|0;[PERM[i],PERM[j]]=[PERM[j],PERM[i]];}
      for(let i=0;i<256;i++)PERM[i+256]=PERM[i];})();
    function noise2(x,y){
      const xi=Math.floor(x)&255,yi=Math.floor(y)&255,xf=x-Math.floor(x),yf=y-Math.floor(y);
      const u=xf*xf*(3-2*xf),v=yf*yf*(3-2*yf);
      const a=PERM[xi]+yi,b=PERM[xi+1]+yi;
      return((PERM[a]/255*(1-u)+PERM[b]/255*u)*(1-v)+(PERM[a+1]/255*(1-u)+PERM[b+1]/255*u)*v);
    }
    function fbm(x,y,oct){let v=0,a=0.5,f=1;for(let i=0;i<oct;i++){v+=a*noise2(x*f,y*f);a*=0.5;f*=2;}return v;}

    // â•â•â• CONVEX HULL â•â•â•
    function convexHull(points){
      if(points.length<3)return points.slice();
      const sorted=points.slice().sort((a,b)=>a.x-b.x||a.y-b.y);
      const cross=(O,A,B)=>(A.x-O.x)*(B.y-O.y)-(A.y-O.y)*(B.x-O.x);
      const lower=[];
      for(const p of sorted){while(lower.length>=2&&cross(lower[lower.length-2],lower[lower.length-1],p)<=0)lower.pop();lower.push(p);}
      const upper=[];
      for(let i=sorted.length-1;i>=0;i--){const p=sorted[i];while(upper.length>=2&&cross(upper[upper.length-2],upper[upper.length-1],p)<=0)upper.pop();upper.push(p);}
      return lower.slice(0,-1).concat(upper.slice(0,-1));
    }

    // â•â•â• CHAIKIN CORNER CUTTING â•â•â•
    function chaikin(pts,iters){
      let cur=pts;
      for(let it=0;it<iters;it++){
        const next=[];
        for(let i=0;i<cur.length;i++){
          const a=cur[i],b=cur[(i+1)%cur.length];
          next.push({x:a.x*0.75+b.x*0.25,y:a.y*0.75+b.y*0.25});
          next.push({x:a.x*0.25+b.x*0.75,y:a.y*0.25+b.y*0.75});
        }
        cur=next;
      }
      return cur;
    }

    // â•â•â• MAPPING LAYER â€” synced from playground v2 â•â•â•

    // Extract normalized scores from assessCompleted data
    function extractScores(completed) {
      const c = completed || {};
      const bf = { O:50, C:50, E:50, A:50, N:50 };

      // Big Five: individual tests first, quick-profile fallback
      for (const k of TK) {
        const key = 'bigfive-' + k;
        if (c[key] && c[key].score != null) {
          bf[k] = clamp(c[key].score, 0, 100);
        } else if (c['quick-profile'] && c['quick-profile'].traits && c['quick-profile'].traits[k] != null) {
          bf[k] = clamp(c['quick-profile'].traits[k], 0, 100);
        }
      }

      // Shadow: M/N/P
      const shadow = { M:25, N:20, P:15 };
      for (const s of ['M','N','P']) {
        const key = 'shadow-' + s;
        if (c[key] && c[key].score != null) shadow[s] = clamp(c[key].score, 0, 100);
      }

      // Attachment: anxiety/avoidance as strings â†’ floats (0-5 scale)
      const attachment = { anxiety:1.5, avoidance:1.5 };
      if (c['attachment']) {
        if (c['attachment'].anxiety != null) attachment.anxiety = clamp(parseFloat(c['attachment'].anxiety) || 1.5, 0, 5);
        if (c['attachment'].avoidance != null) attachment.avoidance = clamp(parseFloat(c['attachment'].avoidance) || 1.5, 0, 5);
      }

      // Risk: subcategories (fin/soc/phys/eth, 0-100)
      const risk = { financial:40, social:50, physical:30, ethical:35 };
      if (c['risk'] && c['risk'].subcategories) {
        const sub = c['risk'].subcategories;
        if (sub.fin != null) risk.financial = clamp(sub.fin, 0, 100);
        if (sub.soc != null) risk.social = clamp(sub.soc, 0, 100);
        if (sub.phys != null) risk.physical = clamp(sub.phys, 0, 100);
        if (sub.eth != null) risk.ethical = clamp(sub.eth, 0, 100);
      }

      // Chronotype: 0-100 score
      const chronotype = (c['chronotype'] && c['chronotype'].score != null) ? clamp(c['chronotype'].score, 0, 100) : 55;

      // ADHD: 0-6 indicators
      const adhd = (c['adhd'] && c['adhd'].indicators != null) ? clamp(c['adhd'].indicators, 0, 6) : 1;

      // Depth: how many assessments completed
      const depth = Object.keys(c).length;

      return { bigFive: bf, shadow, attachment, risk, chronotype, adhd, depth };
    }

    // Derive modifier values from scores â€” controls all visual parameters
    function deriveModifiers(scores) {
      const md = {};
      const bf = scores.bigFive;
      const s = scores;

      // Big Five â†’ motion components
      const oN = bf.O/100, cN = bf.C/100, eN = bf.E/100, aN = bf.A/100, nN = bf.N/100;
      const bfDrift = 0.3 + oN * 0.6;
      const bfSway  = 0.3 + eN * 0.8;
      const bfWiggle = 0.15 + nN * 0.6;
      const bfBreath = 0.4 + (1-cN)*0.5 + aN*0.3;
      const bfSpeed = 0.6 + eN*0.3 - cN*0.15;

      // Shadow â€” individual effects + motion
      const mNorm = s.shadow.M/100, nNorm = s.shadow.N/100, pNorm = s.shadow.P/100;
      md.machConn    = mNorm;
      md.narcInflate = nNorm;
      md.psychSharp  = pNorm;
      md.psychCool   = pNorm * 0.6;
      const shadowDrift = mNorm * 0.4;
      const shadowSway  = nNorm * 0.3;
      const shadowWiggle = pNorm * 0.5;

      // Attachment
      const anxN = s.attachment.anxiety/5, avdN = s.attachment.avoidance/5;
      md.connDensity  = 0.3 + anxN*1.4 - avdN*1.0;
      md.pulseSpeed   = 0.4 + anxN*1.2 - avdN*0.6;
      md.breathRate   = bfBreath + anxN*0.8 - avdN*0.5;
      md.breathAmp    = 0.3 + anxN*1.4 - avdN*0.8;
      md.connPulseIrr = anxN*0.5 + avdN*0.3;
      md.avoidSpread  = avdN;
      md.avoidDim     = avdN;
      const attachWiggle = anxN * 0.4;
      const attachDrift  = avdN * 0.5;

      // Risk
      const rFin = s.risk.financial/100, rSoc = s.risk.social/100, rPhy = s.risk.physical/100, rEth = s.risk.ethical/100;
      const riskDrift  = rFin*0.8;
      const riskSway   = rSoc*0.7;
      const riskWiggle = rPhy*0.6;
      const riskSpeed  = rEth*0.5;

      // Compose motion
      md.driftAmp   = bfDrift + shadowDrift + attachDrift + riskDrift*0.6;
      md.driftSpeed = bfSpeed + riskSpeed*0.4;
      md.swayAmp    = bfSway + shadowSway + riskSway*0.5;
      md.wiggleAmp  = bfWiggle + shadowWiggle + attachWiggle + riskWiggle*0.5 + (s.adhd/6)*1.5;
      md.wiggleSpeed = 0.5 + riskSpeed*0.3 + (s.adhd/6)*0.8;

      // Chronotype â€” subtle tempo (Â±15%)
      const chronoMod = 0.92 + (s.chronotype/100)*0.16;
      md.driftSpeed  *= chronoMod;
      md.wiggleSpeed *= chronoMod;

      // Risk structural
      md.riskGlow       = rFin*0.5;
      md.riskInflate    = rPhy*0.3;
      md.riskConnChaos  = rEth*0.6;
      md.riskMemBreathe = rSoc*0.5;

      // Glow â€” scale with assessment depth (node count)
      // 0: seed glow (barely visible), 1-2: dim seed, 3-5: moderate, 6+: full
      const d = scores.depth;
      const depthGlow = d === 0 ? 0.08 : d <= 2 ? 0.2 + d * 0.08 : d <= 5 ? 0.45 + (d - 2) * 0.12 : 1.0;
      md.glowRadius    = depthGlow * (1.0 + md.riskGlow*0.8);
      md.glowIntensity = depthGlow * (1.0 + md.riskGlow*0.6 - md.avoidDim*0.4);
      md.memOpacity    = 1.0 - pNorm*0.4 - md.avoidDim*0.2;
      md.memThickness  = 1.0 - pNorm*0.3 + md.riskMemBreathe*0.3;

      return md;
    }

    // Rank-based angular placement â€” dominant traits claim prominent positions
    function computeTraitAngles(scores, seed) {
      const bf = scores.bigFive;
      const vals = TK.map(k => ({ k, v: bf[k]/100 }));
      const ranked = [...vals].sort((a,b) => b.v - a.v);
      const angles = {};
      const n = ranked.length;
      const totalV = ranked.reduce((s2,r) => s2 + r.v, 0) || 1;
      const avgV = totalV / n;

      for (let i = 0; i < n; i++) {
        const r = ranked[i];
        const baseA = (i/n)*TAU - PI/2;
        const relStrength = (r.v - avgV) / avgV;
        const neighborPull = relStrength * 0.2;
        const seedJitter = Math.sin(seed * 0.1 + i * 2.7) * 0.15;
        angles[r.k] = baseA + neighborPull + seedJitter;
      }
      return angles;
    }

    // â•â•â• END MAPPING LAYER â•â•â•

    // â•â•â• GENOME FROM ANSWERS â•â•â•
    function deriveGenome(answers, scores) {
      // Stable seed from answer state
      const keys = Object.keys(answers || {}).sort();
      let seed = 12345;
      for (const k of keys) {
        for (let i = 0; i < k.length; i++) seed = (seed * 31 + k.charCodeAt(i)) | 0;
        const v = answers[k];
        if (v && v.answer !== undefined) {
          seed = (seed * 37 + (v.answer === 'A' ? 1 : v.answer === 'B' ? 2 : 3)) | 0;
        }
      }
      seed = Math.abs(seed) || 42;
      const r = m32(seed);

      const tv = {};
      // If we have actual Big Five scores from assessments, use those
      const hasBF = scores && scores.bigFive && TK.some(k => scores.bigFive[k] !== 50);
      if (hasBF) {
        for (const k of TK) tv[k] = clamp(scores.bigFive[k]/100, 0.02, 1.0);
      } else {
        // Existing onboarding-based derivation
        for (let i = 0; i < 5; i++) {
          const nm = NEURON_MAP[i];
          const hasColor = nm.colorQ in answers;
          const hasPos = nm.posQ in answers;
          const base = r();
          if (hasColor && hasPos) tv[TK[i]] = 0.60 + base * 0.40;
          else if (hasColor || hasPos) tv[TK[i]] = 0.30 + base * 0.30;
          else tv[TK[i]] = 0.03 + base * 0.10;
        }
      }

      const so = [...TK].sort((a, b) => tv[b] - tv[a]);
      const glow = bl([TR[so[0]].base, TR[so[1]].base], [0.65, 0.35]);
      const iord = [0,1,2,3,4,5].sort(() => r() - 0.5);
      const ints = {}; for (let i = 0; i < 5; i++) ints[TK[i]] = iord[i];
      return { tv, s: seed, dom: so[0], glow, glowAcc: TR[so[0]].acc, ints, so };
    }

    // â•â•â• NODE FACTORY â•â•â•
    function mkNodes(g, oR, traitAngles, mods) {
      const r = m32(g.s + 3333), ns = [];
      const inflate = 1 + (mods ? mods.narcInflate * 0.4 + (mods.riskInflate||0) * 0.3 : 0);
      const spread = 1 + (mods ? (mods.avoidSpread||0) * 0.4 : 0);

      for (let i = 0; i < 5; i++) {
        const k = TK[i], v = g.tv[k];
        const an = traitAngles ? traitAngles[k] : ((i / 5) * TAU - PI / 2 + (v - 0.5) * 0.3);
        const br = oR * (0.28 + 0.22 * v) * spread;
        const rd = oR * (0.06 + v * 0.14) * inflate;
        ns.push({ tp:'p', k, tv:v, rgb:TR[k].base, acc:TR[k].acc, iIdx:g.ints[k],
          bA:an, bR:br, x:0, y:0, dp:0, rd, sd:g.s+i*137.5, bp:i*1.47, stg:0 });
      }
      for (let i = 0; i < 5; i++) { const p = ns[i]; for (let c = 0; c < 5; c++) {
        const o = p.bA + (c-2)*0.3 + (r()-0.5)*0.2, cr = (p.bR + oR*(0.04+r()*0.06)) * spread;
        const v = p.tv * (0.25 + r()*0.35);
        ns.push({ tp:'c', k:p.k, tv:v, rgb:p.rgb, acc:p.acc,
          bA:o, bR:cr, x:0, y:0, dp:0, rd:oR*(0.010+v*0.025)*inflate, sd:g.s+(10+i*5+c)*137.5, bp:(10+i*5+c)*0.9, stg:1 });
      }}
      const AD = [
        {a:['O','C'],n:5},{a:['E','N'],n:5},{a:['O'],n:4},{a:['E','A'],n:5},{a:['C','N'],n:4},
        {a:['O','C','E','A','N'],n:7},{a:['A','E'],n:5},{a:['N','O'],n:5},
        {a:['O','E'],n:4},{a:['C','A'],n:4},{a:['N','E','A'],n:5}
      ];
      let ai = 0;
      for (let a = 0; a < AD.length; a++) { const d = AD[a], sr2 = a < 5 ? 2 : 3;
        for (let n = 0; n < d.n; n++) {
          const ak = d.a[n % d.a.length], ai2 = TK.indexOf(ak), ap = ns[ai2];
          const sc = oR*(0.04+r()*0.10), sa = r()*TAU, v = ap.tv*(0.12+r()*0.22);
          const nb = ns[(ai2+1+Math.floor(r()*3))%5];
          const rgb = lr3(ap.rgb, nb.acc, 0.15+r()*0.2).map(x => clamp(x|0,0,255));
          ns.push({ tp:'a', k:ak, tv:v, rgb, acc:ap.acc,
            bA:ap.bA+(r()-0.5)*0.8, bR:ap.bR+sc*(0.5+r()*0.5), x:0, y:0, dp:0,
            rd:oR*(0.004+v*0.012), sd:g.s+(40+ai)*137.5, bp:(40+ai)*0.7, stg:sr2 }); ai++;
      }}
      for (let h = 0; h < 18; h++) {
        const ha = (h/18)*TAU + (r()-0.5)*0.3;
        const pi = h%5, pp = ns[pi], v = pp.tv*(0.08+r()*0.12);
        const hr = pp.bR + oR*(0.02+r()*0.06);
        const rgb = lr3(pp.rgb, pp.acc, 0.2+r()*0.3).map(x => clamp(x|0,0,255));
        ns.push({ tp:'a', k:TK[pi], tv:v, rgb, acc:pp.acc,
          bA:ha, bR:hr, x:0, y:0, dp:0, rd:oR*(0.003+v*0.006), sd:g.s+(120+h)*137.5, bp:(120+h)*0.5, stg:3 });
      }
      return ns;
    }

    function filt(ns, si, depth) {
      // At depth 1 (QP only), show top 3 dominant traits + 2 children each
      // At depth 2-3, show all 5 traits + normal children
      // At depth 4+, full viz
      if (depth != null && depth <= 1) {
        const prims = ns.filter(n => n.tp === 'p').sort((a, b) => b.tv - a.tv);
        const topKeys = new Set(prims.slice(0, 3).map(n => n.k));
        const childCount = {};
        return ns.filter(n => {
          if (n.tp === 'p') return topKeys.has(n.k);
          if (n.tp === 'c' && si >= 1 && topKeys.has(n.k)) {
            childCount[n.k] = (childCount[n.k] || 0) + 1;
            return childCount[n.k] <= 2;
          }
          return false;
        });
      }
      return ns.filter(n => n.tp==='p' || (n.tp==='c' && si>=1) || (n.tp==='a' && si>=n.stg));
    }

    // â•â•â• CONTOUR â•â•â•
    function computeHull(ns, oR, stg, CX, CY) {
      const sc = SSC[stg];
      const pts = [];
      for (const n of ns) {
        const r = n.rd * sc;
        const pad = n.tp==='p' ? r*0.5+oR*0.05 : r*0.4+oR*0.03;
        const totalR = r + pad;
        const count = 24;
        for (let i = 0; i < count; i++) {
          const a = (i/count) * TAU;
          pts.push({ x: n.x + Math.cos(a)*totalR, y: n.y + Math.sin(a)*totalR });
        }
      }
      if (pts.length < 3) return [{ x:CX-20,y:CY-20 },{ x:CX+20,y:CY-20 },{ x:CX+20,y:CY+20 },{ x:CX-20,y:CY+20 }];
      let hull = convexHull(pts);

      // Corner smoothing: detect sharp angles and pull toward neighbors
      const smoothed = [];
      const n2 = hull.length;
      for (let i = 0; i < n2; i++) {
        const prev = hull[(i-1+n2)%n2], cur = hull[i], next = hull[(i+1)%n2];
        const ax = prev.x-cur.x, ay = prev.y-cur.y;
        const bx = next.x-cur.x, by = next.y-cur.y;
        const dot = ax*bx+ay*by;
        const la = Math.sqrt(ax*ax+ay*ay)||1, lb = Math.sqrt(bx*bx+by*by)||1;
        const cosA = dot/(la*lb);
        if (cosA > -0.3) {
          const blend = 0.15+0.15*Math.max(0,cosA);
          smoothed.push({
            x: cur.x*(1-blend)+(prev.x+next.x)*0.5*blend,
            y: cur.y*(1-blend)+(prev.y+next.y)*0.5*blend
          });
        } else {
          smoothed.push(cur);
        }
      }

      return chaikin(smoothed, 10);
    }

    function traceSmoothedHull(ctx, hull) {
      if (hull.length < 3) return;
      const n = hull.length;
      const tension = 0.4;
      ctx.beginPath();
      for (let i = 0; i < n; i++) {
        const p0 = hull[(i-1+n)%n], p1 = hull[i], p2 = hull[(i+1)%n], p3 = hull[(i+2)%n];
        const cp1x = p1.x+(p2.x-p0.x)*tension, cp1y = p1.y+(p2.y-p0.y)*tension;
        const cp2x = p2.x-(p3.x-p1.x)*tension, cp2y = p2.y-(p3.y-p1.y)*tension;
        if (i === 0) ctx.moveTo(p1.x, p1.y);
        ctx.bezierCurveTo(cp1x, cp1y, cp2x, cp2y, p2.x, p2.y);
      }
      ctx.closePath();
    }

    // â•â•â• PHYSICS â•â•â•
    function updPhys(ns, t, CX, CY, oR, stg, mods) {
      const md = mods || { breathRate:1, breathAmp:1, driftAmp:1, driftSpeed:1, swayAmp:1, wiggleAmp:1, wiggleSpeed:1 };
      const breath = Math.sin(t * 0.12 * md.breathRate) * 0.012 * (1 + md.breathAmp);
      const sc = SSC[stg];
      const bsc = 1 + breath;
      for (const n of ns) {
        const tOff = n.sd * 0.37;
        const wanderA = n.bA + (fbm(n.sd*0.13, t*0.0105*md.driftSpeed+tOff, 3)-0.5)*TAU*0.525*md.driftAmp;
        const wanderR = n.bR * (0.85 + fbm(n.sd*0.17+100, t*0.012*md.driftSpeed+tOff, 3)*0.45*md.driftAmp);
        const baseX = CX + Math.cos(wanderA)*wanderR*bsc*sc;
        const baseY = CY + Math.sin(wanderA)*wanderR*bsc*sc;
        const swayA = oR*sc*0.21*(0.5+md.swayAmp*0.5);
        const sx = (fbm(n.sd*0.1+t*0.0525+tOff, t*0.042, 2)*2-1)*swayA;
        const sy = (fbm(t*0.045, n.sd*0.1+t*0.057+tOff, 2)*2-1)*swayA;
        const wigA = oR*sc*0.0525*(0.4+md.wiggleAmp*0.6);
        const wx = (fbm(n.sd*0.3+t*0.27*md.wiggleSpeed, t*0.225*md.wiggleSpeed, 1)*2-1)*wigA;
        const wy = (fbm(t*0.24*md.wiggleSpeed, n.sd*0.3+t*0.285*md.wiggleSpeed, 1)*2-1)*wigA;
        n.x = baseX+sx+wx;
        n.y = baseY+sy+wy;
      }
      let cx=0, cy=0;
      for (const n of ns) { cx+=n.x; cy+=n.y; }
      cx /= ns.length; cy /= ns.length;
      const ox = CX-cx, oy = CY-cy;
      for (const n of ns) { n.x+=ox; n.y+=oy; }
      return breath;
    }

    // â•â•â• CONNECTIONS â•â•â•
    function mkCon(ns, mods) {
      const cn=[], seen=new Set();
      const K = Math.max(3, Math.round(7 * (mods ? mods.connDensity : 1)));
      for (let i=0;i<ns.length;i++){const dd=[];
        for(let j=0;j<ns.length;j++){if(i===j)continue;
          const xi=Math.cos(ns[i].bA)*ns[i].bR, yi=Math.sin(ns[i].bA)*ns[i].bR;
          const xj=Math.cos(ns[j].bA)*ns[j].bR, yj=Math.sin(ns[j].bA)*ns[j].bR;
          dd.push({j,d:dst(xi,yi,xj,yj)});}
        dd.sort((a,b)=>a.d-b.d);
        for(let k=0;k<Math.min(K,dd.length);k++){const j=dd[k].j,ky=Math.min(i,j)+'-'+Math.max(i,j);
          if(seen.has(ky))continue;seen.add(ky);
          cn.push({a:i,b:j,col:bl([ns[i].rgb,ns[j].rgb],[0.5,0.5]),
            str:(ns[i].tv+ns[j].tv)/2,cs:i*31+j*17,
            isPP:ns[i].tp==='p'&&ns[j].tp==='p'});}}
      const pI=[];ns.forEach((n,i)=>{if(n.tp==='p')pI.push(i);});
      for(let i=0;i<pI.length;i++)for(let j=i+1;j<pI.length;j++){
        const ky=pI[i]+'-'+pI[j];
        if(!seen.has(ky)){seen.add(ky);const a=ns[pI[i]],b=ns[pI[j]];
          cn.push({a:pI[i],b:pI[j],col:bl([a.rgb,b.rgb],[0.5,0.5]),
            str:(a.tv+b.tv)/2,cs:pI[i]*31+pI[j]*17,isPP:true});}}
      return cn;
    }

    function mkPul(cn, sd, mods) {
      const r=m32(sd+5555), ps=[];
      const irrMod = mods ? (mods.connPulseIrr||0) + (mods.riskConnChaos||0) : 0;
      const spdMod = mods ? (mods.pulseSpeed||1) : 1;
      for(const c of cn){const ct=1+Math.floor(c.str*1.5);
        for(let i=0;i<ct;i++){
          const baseSpeed = 0.03+r()*0.05;
          const irrF = 1+(r()-0.5)*irrMod*2;
          ps.push({a:c.a,b:c.b,cs:c.cs,p:r(),sp:baseSpeed*irrF*spdMod,
            dr:r()>0.5?1:-1,col:ltn(c.col,55),sz:0.8+c.str*1.5+(c.isPP?1:0)});}}
      return ps;
    }
    function updPul(ps,dt){for(const q of ps){q.p+=q.sp*q.dr*dt;if(q.p>1)q.p-=1;if(q.p<0)q.p+=1;}}
    function cMid(a,b){return{x:(a.x+b.x)/2,y:(a.y+b.y)/2};}

    // â•â•â• BLOB PATH â•â•â•
    function blobP(ctx,cx,cy,r,sd,t){
      ctx.beginPath();for(let i=0;i<=48;i++){const a=(i/48)*TAU;
        const br=r+Math.sin(a*3+t*0.12+sd)*r*0.08+Math.sin(a*5+t*0.07+sd*1.3)*r*0.04
          +Math.sin(a*2+t*0.15+sd*0.7)*r*0.05;
        ctx.lineTo(cx+Math.cos(a)*br,cy+Math.sin(a)*br);}
      ctx.closePath();
    }

    // â•â•â• INTERIORS â€” only rendered at size >= 150 â•â•â•
    const INT=[
    {name:'Chromatin',fn(cx,n,r,col,d,t){
      const sr=m32(n.sd*8901|0),b=ltn(col,85),h=ltn(col,140);
      for(let s=0;s<9;s++){const sa=sr()*TAU,sR=sr()*r*0.35;
        let px=n.x+Math.cos(sa)*sR,py=n.y+Math.sin(sa)*sR;
        cx.beginPath();cx.moveTo(px,py);
        for(let p=0;p<30;p++){const da=sr()*1.0-0.5+Math.sin(t*0.03+s+p*0.3)*0.15,step=r*0.04+sr()*r*0.025;
          px+=Math.cos(da+p*0.5+s)*step;py+=Math.sin(da+p*0.7+s)*step;cx.lineTo(px,py);}
        cx.strokeStyle=rga(b,0.5);cx.lineWidth=0.7+sr()*0.5;cx.lineCap='round';cx.stroke();}
      for(let i=0;i<8;i++){const a=sr()*TAU,dd=sr()*r*0.6;
        const jx=n.x+Math.cos(a)*dd,jy=n.y+Math.sin(a)*dd,sz=1+sr()*2;
        const jg=cx.createRadialGradient(jx,jy,0,jx,jy,sz*3);
        jg.addColorStop(0,rga(h,0.7));jg.addColorStop(0.4,rga(b,0.2));jg.addColorStop(1,rga(b,0));
        cx.fillStyle=jg;cx.beginPath();cx.arc(jx,jy,sz*3,0,TAU);cx.fill();}}},
    {name:'Constellation',fn(cx,n,r,col,d,t){
      const sr=m32(n.sd*7913|0),b=ltn(col,90),h=ltn(col,140);
      const stars=14+Math.floor(sr()*8),pts=[];
      for(let i=0;i<stars;i++){const a=sr()*TAU,dd=r*0.08+sr()*r*0.7;
        pts.push({x:n.x+Math.cos(a)*dd,y:n.y+Math.sin(a)*dd});}
      for(let i=0;i<pts.length;i++)for(let j=i+1;j<pts.length;j++){
        const dd=dst(pts[i].x,pts[i].y,pts[j].x,pts[j].y);
        if(dd<r*0.8&&sr()>0.2){cx.beginPath();cx.moveTo(pts[i].x,pts[i].y);cx.lineTo(pts[j].x,pts[j].y);
          cx.strokeStyle=rga(b,0.2*(1-dd/(r*0.8)));cx.lineWidth=0.3;cx.stroke();}}
      for(const p of pts){const sz=2+sr()*3;
        const sg=cx.createRadialGradient(p.x,p.y,0,p.x,p.y,sz*2);
        sg.addColorStop(0,rga(h,0.85));sg.addColorStop(0.4,rga(b,0.2));sg.addColorStop(1,rga(b,0));
        cx.fillStyle=sg;cx.beginPath();cx.arc(p.x,p.y,sz*2,0,TAU);cx.fill();}}},
    {name:'Vesicles',fn(cx,n,r,col,d,t){
      const sr=m32(n.sd*4567|0),b=ltn(col,70),h=ltn(col,120);
      const ct=8+Math.floor(sr()*7+n.tv*5),vpts=[];
      for(let i=0;i<ct;i++){const a=sr()*TAU,dd=r*0.12+sr()*r*0.55,sz=r*0.06+sr()*r*0.12;
        const vx=n.x+Math.cos(a)*dd,vy=n.y+Math.sin(a)*dd;vpts.push({x:vx,y:vy,sz});
        blobP(cx,vx,vy,sz,n.sd+i*71,t);cx.fillStyle=rga(drk(b,20),0.45);cx.fill();
        blobP(cx,vx,vy,sz,n.sd+i*71,t);cx.strokeStyle=rga(b,0.25);cx.lineWidth=0.5;cx.stroke();
        const vg=cx.createRadialGradient(vx,vy,0,vx,vy,sz*0.6);
        vg.addColorStop(0,rga(h,0.4));vg.addColorStop(1,rga(h,0));
        cx.fillStyle=vg;cx.beginPath();cx.arc(vx,vy,sz*0.6,0,TAU);cx.fill();}
      for(let i=0;i<vpts.length;i++)for(let j=i+1;j<vpts.length;j++){
        if(dst(vpts[i].x,vpts[i].y,vpts[j].x,vpts[j].y)<r*0.5){
          cx.beginPath();cx.moveTo(vpts[i].x,vpts[i].y);cx.lineTo(vpts[j].x,vpts[j].y);
          cx.strokeStyle=rga(b,0.15);cx.lineWidth=0.3;cx.stroke();}}}},
    {name:'Axon Tree',fn(cx,n,r,col,d,t){
      const sr=m32(n.sd*1234|0),b=ltn(col,100),h=ltn(col,150);
      const arms=4+Math.floor(sr()*2);
      for(let a=0;a<arms;a++){const bA=(a/arms)*TAU+sr()*0.5;
        let px=n.x,py=n.y,ca=bA,lw=2.5+sr()*1.5;
        for(let seg=0;seg<12;seg++){const len=(r*0.1)*(1-seg*0.035)+sr()*r*0.025;
          const nx=px+Math.cos(ca)*len,ny=py+Math.sin(ca)*len;
          cx.beginPath();cx.moveTo(px,py);cx.lineTo(nx,ny);
          cx.strokeStyle=rga(b,0.55*(1-seg*0.06));cx.lineWidth=lw;cx.lineCap='round';cx.stroke();
          px=nx;py=ny;ca+=sr()*0.7-0.35;lw*=0.82;
          if(seg>2&&sr()>0.35){const ba=ca+(sr()>0.5?0.5:-0.5);let bx=px,by=py,bw=lw*0.7;
            for(let bb=0;bb<5;bb++){const bx2=bx+Math.cos(ba+sr()*0.3)*r*0.05,by2=by+Math.sin(ba+sr()*0.3)*r*0.05;
              cx.beginPath();cx.moveTo(bx,by);cx.lineTo(bx2,by2);
              cx.strokeStyle=rga(b,0.35*(1-bb*0.12));cx.lineWidth=bw;cx.lineCap='round';cx.stroke();
              bx=bx2;by=by2;bw*=0.7;}}}}
      const sg=cx.createRadialGradient(n.x,n.y,0,n.x,n.y,r*0.22);
      sg.addColorStop(0,rga(h,0.85));sg.addColorStop(0.4,rga(b,0.35));sg.addColorStop(1,rga(b,0));
      cx.fillStyle=sg;cx.beginPath();cx.arc(n.x,n.y,r*0.22,0,TAU);cx.fill();}},
    {name:'Membrane Folds',fn(cx,n,r,col,d,t){
      const sr=m32(n.sd*6802|0),b=ltn(col,80),h=ltn(col,130);
      for(let L=0;L<7;L++){const lr=r*(0.1+L*0.12),wa=lr*0.15+sr()*lr*0.1;
        cx.beginPath();for(let s=0;s<=48;s++){const a=(s/48)*TAU;
          const w=Math.sin(a*3+t*0.05+L*2+sr()*5)*wa+Math.sin(a*5+t*0.03+L)*wa*0.4;
          cx.lineTo(n.x+Math.cos(a)*(lr+w),n.y+Math.sin(a)*(lr+w));}
        cx.closePath();cx.strokeStyle=rga(b,0.42*(1-L*0.06));cx.lineWidth=0.7+sr()*0.4;cx.stroke();}
      for(let i=0;i<10;i++){const a=sr()*TAU;
        cx.beginPath();cx.moveTo(n.x+Math.cos(a)*r*0.1,n.y+Math.sin(a)*r*0.1);
        cx.lineTo(n.x+Math.cos(a+sr()*0.2)*r*0.75,n.y+Math.sin(a+sr()*0.2)*r*0.75);
        cx.strokeStyle=rga(h,0.15);cx.lineWidth=0.3;cx.stroke();}}},
    {name:'Synaptic',fn(cx,n,r,col,d,t){
      const sr=m32(n.sd*3456|0),b=ltn(col,80),h=ltn(col,130);
      const arms=6+Math.floor(sr()*3),jns=[];
      for(let a=0;a<arms;a++){const ba=(a/arms)*TAU+sr()*0.4;
        let px=n.x,py=n.y,ca=ba;
        for(let s=0;s<8;s++){const len=r*0.09+sr()*r*0.05,nx=px+Math.cos(ca)*len,ny=py+Math.sin(ca)*len;
          cx.beginPath();cx.moveTo(px,py);cx.lineTo(nx,ny);
          cx.strokeStyle=rga(b,0.45*(1-s*0.08));cx.lineWidth=1.3-s*0.1;cx.lineCap='round';cx.stroke();
          if(s>0&&sr()>0.25)jns.push({x:nx,y:ny,sz:1.2+sr()*2.5});
          px=nx;py=ny;ca+=sr()*0.6-0.3;}}
      for(const j of jns){const jg=cx.createRadialGradient(j.x,j.y,0,j.x,j.y,j.sz*3);
        jg.addColorStop(0,rga(h,0.8));jg.addColorStop(0.3,rga(b,0.25));jg.addColorStop(1,rga(b,0));
        cx.fillStyle=jg;cx.beginPath();cx.arc(j.x,j.y,j.sz*3,0,TAU);cx.fill();}
      for(let i=0;i<jns.length;i++)for(let j=i+1;j<jns.length;j++){
        if(dst(jns[i].x,jns[i].y,jns[j].x,jns[j].y)<r*0.5&&sr()>0.4){
          cx.beginPath();cx.moveTo(jns[i].x,jns[i].y);cx.lineTo(jns[j].x,jns[j].y);
          cx.strokeStyle=rga(b,0.12);cx.lineWidth=0.25;cx.stroke();}}}}
    ];

    // â•â•â• MEMBRANE â•â•â•
    function drawMem(ctx, gen, hull, mods) {
      if (hull.length < 3) return;
      const md = mods || { memThickness:1, memOpacity:1, riskMemBreathe:0 };
      const memBreathe = 1 + (md.riskMemBreathe||0) * Math.sin(performance.now()*0.002) * 0.3;
      const widths=[18,8,3.5,1.0].map(w => w * md.memThickness * memBreathe);
      const alphas=[0.035,0.065,0.11,0.32].map(a => a * md.memOpacity);
      const mc = ltn(gen.glow, 30);
      for (let pass=0; pass<4; pass++) {
        traceSmoothedHull(ctx, hull);
        ctx.strokeStyle = rga(mc, alphas[pass]);
        ctx.lineWidth = widths[pass];
        ctx.lineJoin = 'round';
        ctx.lineCap = 'round';
        ctx.stroke();
      }
    }

    // â•â•â• GLOW â•â•â•
    function drawGlow(ctx, prims, oR, stg, CW, CH, mods) {
      const md = mods || { glowRadius:1, glowIntensity:1 };
      for (const p of prims) {
        const pc = p.rgb;
        const str = p.tv * GSC[stg] * md.glowIntensity;
        if (str < 0.03) continue;
        const sc = SSC[stg];
        const nodeR = p.rd * sc;
        const glowR = (oR*2.5 + p.tv*oR*2.0) * md.glowRadius;
        const g = ctx.createRadialGradient(p.x,p.y,nodeR*0.3,p.x,p.y,glowR);
        g.addColorStop(0,rga(pc,0.40*str));
        g.addColorStop(0.05,rga(pc,0.32*str));
        g.addColorStop(0.12,rga(pc,0.22*str));
        g.addColorStop(0.25,rga(pc,0.13*str));
        g.addColorStop(0.45,rga(pc,0.06*str));
        g.addColorStop(0.7,rga(pc,0.025*str));
        g.addColorStop(1,rga(pc,0));
        ctx.fillStyle = g;
        ctx.fillRect(0,0,CW,CH);
      }
    }

    // â•â•â• AI FADE â•â•â•
    function drawAIFade(ctx, d, CX, CY, CW, CH) {
      const bg = d ? '5,10,24' : '240,242,245';
      const vR = Math.max(CW,CH)*0.8;
      const g = ctx.createRadialGradient(CX,CY,vR*0.5,CX,CY,vR);
      g.addColorStop(0,`rgba(${bg},0)`);
      g.addColorStop(0.7,`rgba(${bg},0)`);
      g.addColorStop(1,`rgba(${bg},0.3)`);
      ctx.fillStyle=g; ctx.fillRect(0,0,CW,CH);
    }

    // â•â•â• BODY FILL â•â•â•
    function drawBody(ctx, prims, gen, hull, CX, CY, CW, CH) {
      if (hull.length < 3) return;
      let maxR = 0;
      for (const h of hull) { const d2 = dst(h.x,h.y,CX,CY); if (d2>maxR) maxR=d2; }
      maxR = Math.max(maxR, 50);
      const baseCol = ltn(gen.glow, 15);
      const bg = ctx.createRadialGradient(CX,CY,0,CX,CY,maxR);
      bg.addColorStop(0,rga(baseCol,0.12));
      bg.addColorStop(0.6,rga(baseCol,0.08));
      bg.addColorStop(1,rga(baseCol,0.04));
      ctx.fillStyle=bg; ctx.fillRect(0,0,CW,CH);
      for (const p of prims) {
        const pc=p.rgb, strength=p.tv*0.14, r=maxR*0.65;
        const g=ctx.createRadialGradient(p.x,p.y,0,p.x,p.y,r);
        g.addColorStop(0,rga(pc,strength));
        g.addColorStop(0.4,rga(pc,strength*0.4));
        g.addColorStop(1,rga(pc,0));
        ctx.fillStyle=g; ctx.fillRect(0,0,CW,CH);
      }
    }

    // â•â•â• NEURAL NETWORK â€” only at larger sizes â•â•â•
    function drawNeural(ctx, prims, gen, hullPts, oR, CX, CY, mods) {
      const sr = m32(gen.s+9999);
      const md = mods || { machConn:0, avoidDim:0 };
      const connAlpha = Math.max(0.02, (0.08 + md.machConn * 0.15) * (1 - (md.avoidDim||0)*0.7));
      for(let i=0;i<prims.length;i++){
        for(let j=i+1;j<prims.length;j++){
          const a=prims[i],b=prims[j];
          const col=bl([a.rgb,b.rgb],[0.5,0.5]);
          const bc=ltn(col,60);
          const count=3+Math.floor((a.tv+b.tv)*2);
          for(let f=0;f<count;f++){
            const spread=(f/(count-1||1)-0.5)*0.6;
            const dx=b.x-a.x,dy=b.y-a.y,len=Math.sqrt(dx*dx+dy*dy)||1;
            const nx=-dy/len,ny=dx/len;
            const off=spread*oR*0.08;
            const mx=(a.x+b.x)/2+nx*off,my=(a.y+b.y)/2+ny*off;
            ctx.beginPath();ctx.moveTo(a.x,a.y);ctx.quadraticCurveTo(mx,my,b.x,b.y);
            ctx.strokeStyle=rga(bc,connAlpha);ctx.lineWidth=0.4+sr()*0.5;ctx.stroke();
          }
        }
      }
      const r2=m32(gen.s+1111);
      const dotCount=20+stg*12;
      let maxR=0;
      for(const h of hullPts){const d2=dst(h.x,h.y,CX,CY);if(d2>maxR)maxR=d2;}
      maxR=Math.max(maxR,50);
      for(let i=0;i<dotCount;i++){
        const a=r2()*TAU,dd=maxR*(0.1+r2()*0.35);
        const px=CX+Math.cos(a)*dd,py=CY+Math.sin(a)*dd;
        const dists=prims.map(p=>({p,d:dst(px,py,p.x,p.y)})).sort((a,b)=>a.d-b.d);
        if(dists.length<2)continue;
        const c=bl([dists[0].p.rgb,dists[1].p.rgb],[0.6,0.4]);
        const bc=ltn(c,70);
        const sz=0.8+r2()*1.5;
        const g=ctx.createRadialGradient(px,py,0,px,py,sz*2.5);
        g.addColorStop(0,rga(bc,0.4));g.addColorStop(0.4,rga(bc,0.1));g.addColorStop(1,rga(bc,0));
        ctx.fillStyle=g;ctx.beginPath();ctx.arc(px,py,sz*2.5,0,TAU);ctx.fill();
      }
    }

    // â•â•â• STATE â•â•â•
    let CW, CH, CX, CY, oR;
    let gen, allN, actN, cons, puls;
    let hullPts = [];
    let stg, ent;
    let curScores, curMods, curTraitAngles;
    let t0 = performance.now(), tL = 0;
    const LOD_FULL = 0; // always render full detail â€” internals + neural on all sizes

    function init() {
      const p = propsRef.current;
      CW = CH = p.size;
      CX = CW / 2; CY = CH / 2;
      oR = Math.min(CW, CH) * 0.40;

      // Mapping layer: extract scores â†’ derive mods â†’ compute angles
      curScores = extractScores(p.assessCompleted);
      curMods = deriveModifiers(curScores);
      ent = p.entityType;

      // Stage from scores.depth
      stg = curScores.depth >= 4 ? 3 : curScores.depth >= 2 ? 2 : curScores.depth >= 1 ? 1 : 0;

      gen = deriveGenome(p.onboardingAnswers, curScores);
      curTraitAngles = computeTraitAngles(curScores, gen.s);
      allN = mkNodes(gen, oR, curTraitAngles, curMods);
      actN = filt(allN, stg, curScores.depth);
      cons = mkCon(actN, curMods);
      puls = mkPul(cons, gen.s, curMods);
    }

    init();
    let prevSize = CW, prevStg = stg, prevAnswerCount = Object.keys(propsRef.current.onboardingAnswers || {}).length;
    let prevAssessKeys = Object.keys(propsRef.current.assessCompleted || {}).sort().join(',');

    function frame(ts) {
      const p = propsRef.current;
      const t = (ts - t0) / 1000;
      const dt = tL ? Math.min((ts - tL) / 1000, 0.05) : 0.016;
      tL = ts;

      // Reinit on significant changes
      const newAssessKeys = Object.keys(p.assessCompleted || {}).sort().join(',');
      const newScores = extractScores(p.assessCompleted);
      const newStg = newScores.depth >= 4 ? 3 : newScores.depth >= 2 ? 2 : newScores.depth >= 1 ? 1 : 0;
      const newAnswerCount = Object.keys(p.onboardingAnswers || {}).length;
      if (p.size !== prevSize || newStg !== prevStg || newAnswerCount !== prevAnswerCount || newAssessKeys !== prevAssessKeys) {
        prevSize = p.size; prevStg = newStg; prevAnswerCount = newAnswerCount; prevAssessKeys = newAssessKeys;
        init();
      }

      ent = p.entityType;
      const d = p.darkMode;
      const sc = SSC[stg];
      const full = CW >= LOD_FULL;

      // Canvas reset per frame
      canvas.width = CW;
      canvas.height = CH;
      canvas.style.width = CW + 'px';
      canvas.style.height = CH + 'px';

      // Transparent background â€” organism floats in the page
      ctx.clearRect(0, 0, CW, CH);

      const breath = updPhys(actN, t, CX, CY, oR, stg, curMods);
      updPul(puls, dt);
      hullPts = computeHull(actN, oR, stg, CX, CY);

      const prims = actN.filter(n => n.tp === 'p');

      // Layer 1: Glow
      drawGlow(ctx, prims, oR, stg, CW, CH, curMods);

      // Layer 2: Membrane or AI fade
      if (ent === 'human') {
        drawMem(ctx, gen, hullPts, curMods);
      } else {
        drawAIFade(ctx, d, CX, CY, CW, CH);
      }

      // Clip ALL organism content to membrane
      ctx.save();
      if (ent === 'human' && hullPts.length >= 3) {
        traceSmoothedHull(ctx, hullPts);
        ctx.clip();
      }

      // Layer 3: Body fill
      if (ent === 'human') drawBody(ctx, prims, gen, hullPts, CX, CY, CW, CH);

      // Neural network (skip at small sizes)
      if (full) drawNeural(ctx, prims, gen, hullPts, oR, CX, CY, curMods);

      // Tissue connections â€” machConn boosts, avoidDim dampens
      const cAlphaScale = curMods ? (1 + curMods.machConn * 0.5) * (1 - (curMods.avoidDim||0)*0.5) : 1;
      for (const c of cons) {
        const a = actN[c.a], b = actN[c.b]; if (!a || !b) continue;
        const mid = cMid(a, b), col = c.col;
        if (c.isPP) {
          ctx.beginPath(); ctx.moveTo(a.x,a.y); ctx.quadraticCurveTo(mid.x,mid.y,b.x,b.y);
          ctx.strokeStyle=rga(col,(0.04+c.str*0.02)*cAlphaScale); ctx.lineWidth=22+c.str*12; ctx.lineCap='round'; ctx.stroke();
        }
        ctx.beginPath(); ctx.moveTo(a.x,a.y); ctx.quadraticCurveTo(mid.x,mid.y,b.x,b.y);
        ctx.strokeStyle=rga(col,(0.05+c.str*0.025)*cAlphaScale); ctx.lineWidth=6+c.str*4; ctx.lineCap='round'; ctx.stroke();
        ctx.beginPath(); ctx.moveTo(a.x,a.y); ctx.quadraticCurveTo(mid.x,mid.y,b.x,b.y);
        ctx.strokeStyle=rga(ltn(col,25),(0.35+c.str*0.12)*cAlphaScale); ctx.lineWidth=0.5+c.str*0.7; ctx.stroke();
      }

      // Energy pulses
      for (const p of puls) {
        const a = actN[p.a], b = actN[p.b]; if (!a || !b) continue;
        const mid = cMid(a, b), pr = p.p, mt = 1 - pr;
        const px = mt*mt*a.x + 2*mt*pr*mid.x + pr*pr*b.x;
        const py = mt*mt*a.y + 2*mt*pr*mid.y + pr*pr*b.y;
        const gr = ctx.createRadialGradient(px,py,0,px,py,p.sz*3);
        gr.addColorStop(0,rga(p.col,0.6));
        gr.addColorStop(0.3,rga(p.col,0.18));
        gr.addColorStop(1,rga(p.col,0));
        ctx.fillStyle=gr; ctx.beginPath(); ctx.arc(px,py,p.sz*3,0,TAU); ctx.fill();
      }

      // Nodes
      const sorted = [...actN].sort((a,b) => a.dp - b.dp);
      for (const n of sorted) {
        const r = n.rd * sc * (1 + 0.02*Math.sin(n.bp + t*0.3) + breath);
        const col = n.rgb;
        if (n.tp === 'p') {
          const hr = ctx.createRadialGradient(n.x,n.y,r*0.6,n.x,n.y,r*2.5);
          hr.addColorStop(0,rga(col,0.2)); hr.addColorStop(0.4,rga(col,0.08)); hr.addColorStop(1,rga(col,0));
          ctx.fillStyle=hr; ctx.beginPath(); ctx.arc(n.x,n.y,r*2.5,0,TAU); ctx.fill();
          blobP(ctx,n.x,n.y,r,n.sd,t); ctx.fillStyle=rga(drk(col,55),0.88); ctx.fill();
          // Interiors only at larger sizes
          if (full) {
            ctx.save(); blobP(ctx,n.x,n.y,r,n.sd,t); ctx.clip(); INT[n.iIdx].fn(ctx,n,r,col,d,t); ctx.restore();
          }
          blobP(ctx,n.x,n.y,r,n.sd,t); ctx.strokeStyle=rga(col,0.12); ctx.lineWidth=5; ctx.stroke();
          blobP(ctx,n.x,n.y,r,n.sd,t); ctx.strokeStyle=rga(col,0.28); ctx.lineWidth=2; ctx.stroke();
          blobP(ctx,n.x,n.y,r,n.sd,t); ctx.strokeStyle=rga(ltn(col,40),0.65); ctx.lineWidth=0.7; ctx.stroke();
        } else if (n.tp === 'c') {
          const g2 = ctx.createRadialGradient(n.x,n.y,0,n.x,n.y,r*4);
          g2.addColorStop(0,rga(col,0.28)); g2.addColorStop(0.3,rga(col,0.1)); g2.addColorStop(1,rga(col,0));
          ctx.fillStyle=g2; ctx.beginPath(); ctx.arc(n.x,n.y,r*4,0,TAU); ctx.fill();
          ctx.fillStyle=rga(drk(col,25),0.82); ctx.beginPath(); ctx.arc(n.x,n.y,r,0,TAU); ctx.fill();
          ctx.fillStyle=rga(ltn(col,80),0.85); ctx.beginPath(); ctx.arc(n.x,n.y,r*0.35,0,TAU); ctx.fill();
          ctx.strokeStyle=rga(col,0.5); ctx.lineWidth=0.4; ctx.beginPath(); ctx.arc(n.x,n.y,r,0,TAU); ctx.stroke();
        } else {
          const g3 = ctx.createRadialGradient(n.x,n.y,0,n.x,n.y,r*3);
          g3.addColorStop(0,rga(col,0.28)); g3.addColorStop(0.3,rga(col,0.08)); g3.addColorStop(1,rga(col,0));
          ctx.fillStyle=g3; ctx.beginPath(); ctx.arc(n.x,n.y,r*3,0,TAU); ctx.fill();
          ctx.fillStyle=rga(col,0.7); ctx.beginPath(); ctx.arc(n.x,n.y,r,0,TAU); ctx.fill();
        }
      }

      ctx.restore();

      // Edge vignette â€” fade to transparent so organism floats in app background
      ctx.save();
      ctx.globalCompositeOperation = 'destination-out';
      const vR = Math.max(CW, CH) * 0.5;
      const vig = ctx.createRadialGradient(CX, CY, vR * 0.55, CX, CY, vR);
      vig.addColorStop(0, 'rgba(0,0,0,0)');
      vig.addColorStop(0.7, 'rgba(0,0,0,0)');
      vig.addColorStop(0.88, 'rgba(0,0,0,0.4)');
      vig.addColorStop(1, 'rgba(0,0,0,1)');
      ctx.fillStyle = vig;
      ctx.fillRect(0, 0, CW, CH);
      ctx.restore();

      animRef.current = requestAnimationFrame(frame);
    }

    animRef.current = requestAnimationFrame(frame);
    return () => { if (animRef.current) cancelAnimationFrame(animRef.current); };
  }, []);

  // Responsive: canvas draws at full size, CSS scales down on small screens
  return React.createElement('div', {
    style: { display: 'flex', justifyContent: 'center', maxWidth: '100%' },
  }, React.createElement('canvas', {
    ref: canvasRef,
    style: {
      display: 'block',
      width: size + 'px',
      maxWidth: '100%',
      aspectRatio: '1 / 1',
      background: 'transparent',
    },
  }));
});


// ==================== DATA ====================
const CATEGORIES = getCategoryList();

// MC option colors - uses COLOR_HEX for base values, keeps specific shades
const MC_COLORS = [
  { hex: COLOR_HEX.blue.base, name: 'blue', shades: ['#93c5fd', '#60a5fa', '#3b82f6', '#2563eb'], rgb: COLOR_HEX.blue.rgb },
  { hex: COLOR_HEX.violet.base, name: 'violet', shades: ['#c4b5fd', '#a78bfa', '#8b5cf6', '#7c3aed'], rgb: COLOR_HEX.violet.rgb },
  { hex: COLOR_HEX.teal.base, name: 'teal', shades: ['#5eead4', '#2dd4bf', '#14b8a6', '#0d9488'], rgb: COLOR_HEX.teal.rgb },
  { hex: COLOR_HEX.cyan.base, name: 'cyan', shades: ['#67e8f9', '#22d3ee', '#06b6d4', '#0891b2'], rgb: COLOR_HEX.cyan.rgb },
  { hex: '#ec4899', name: 'pink', shades: ['#f9a8d4', '#f472b6', '#ec4899', '#db2777'], rgb: '236, 72, 153' },
];

// Aggregate evaluators by answer and confidence level
// userResponse: if provided, used for isUser marking; only included in counts if includeUserInCount=true
// Returns { rows: [{label, answer, count, pct, byConf, colors, isUser, maxCount}], total, maxCount, userConf }
const aggregateResults = (evaluators, question, userResponse, includeUserInCount = true) => {
  // Combine evaluators with user's response if requested
  const baseVotes = evaluators || [];
  const allVotes = (userResponse && includeUserInCount) ? [...baseVotes, { ...userResponse, id: 'user' }] : baseVotes;
  if (!allVotes.length) return { rows: [], total: 0, maxCount: 0, userConf: -1 };

  const isBinary = question?.type === 'binary';
  const total = allVotes.length;
  const userAnswer = userResponse?.answer;
  const userConf = userResponse ? normalizeConf(userResponse.confidence) : -1;

  if (isBinary) {
    const yesByConf = [0, 0, 0, 0], noByConf = [0, 0, 0, 0];
    allVotes.forEach(e => {
      const conf = normalizeConf(e.confidence);
      if (e.answer === 0) yesByConf[conf]++; else noByConf[conf]++;
    });
    const yesTotal = yesByConf.reduce((a, b) => a + b, 0);
    const noTotal = noByConf.reduce((a, b) => a + b, 0);
    const maxCount = Math.max(yesTotal, noTotal, 1);
    const rows = [
      { label: 'Yes', answer: 0, count: yesTotal, pct: Math.round((yesTotal / total) * 100), byConf: yesByConf, colors: BINARY_COLORS.yes, isUser: userAnswer === 0, maxCount },
      { label: 'No', answer: 1, count: noTotal, pct: Math.round((noTotal / total) * 100), byConf: noByConf, colors: BINARY_COLORS.no, isUser: userAnswer === 1, maxCount },
    ];
    return { rows, total, maxCount, userConf };
  }

  // Multiple choice
  const optionData = {};
  allVotes.forEach(e => {
    if (!optionData[e.answer]) optionData[e.answer] = { total: 0, byConf: [0, 0, 0, 0] };
    optionData[e.answer].total++;
    optionData[e.answer].byConf[normalizeConf(e.confidence)]++;
  });
  const maxCount = Math.max(...Object.values(optionData).map(d => d.total), 1);
  const options = question?.options || [];
  const rows = options.map((label, idx) => {
    const data = optionData[idx] || { total: 0, byConf: [0, 0, 0, 0] };
    const colors = MC_COLORS[idx % MC_COLORS.length].shades;
    return { label, answer: idx, count: data.total, pct: Math.round((data.total / total) * 100), byConf: data.byConf, colors, isUser: userAnswer === idx, maxCount };
  });
  return { rows, total, maxCount, userConf };
};

// Render confidence bar segments (shared by CommunityResultsRows, FullResultsPanel, AnsweredQuestionView)
// Returns a flex row of colored segments representing confidence distribution
// Design: checkmark inside user's segment, overlay highlight with matching border-radius
const renderConfidenceBar = (byConf, colors, maxCount, isUser, userConf, height = 'h-5', darkMode = true) => {
  const totalCount = byConf.reduce((a, b) => a + b, 0);
  if (totalCount === 0) return <div className={`flex-1 ${height} rounded-full`} style={{ border: `1px solid ${colors[0]}40` }} />;

  // Build segments array (high conf first: 3,2,1,0)
  const segments = [];
  for (let i = 3; i >= 0; i--) {
    if (byConf[i] > 0) segments.push({ width: (byConf[i] / maxCount) * 100, color: colors[i], conf: i });
  }
  const totalWidth = segments.reduce((a, s) => a + s.width, 0);
  const showEmpty = (100 - totalWidth) > 2;

  // Text color for checkmark: dark text on light segments (conf 0,1), white on dark (conf 2,3)
  const getCheckColor = (conf) => conf <= 1 ? '#374151' : 'white';
  // Highlight color: white in dark mode, gray-500 in light mode
  const highlightColor = darkMode ? 'white' : '#6b7280';

  return (
    <div className={`flex-1 ${height} rounded-full overflow-hidden flex`} style={{ border: showEmpty ? `1px solid ${colors[0]}40` : 'none' }}>
      {segments.map((s, i) => {
        const isUserSeg = isUser && s.conf === userConf;
        const isLast = i === segments.length - 1;
        const isFirst = i === 0;
        // Border-radius for highlight overlay (matches segment position)
        const segRadius = isFirst && isLast ? '9999px' : isFirst ? '9999px 0 0 9999px' : isLast ? '0 9999px 9999px 0' : '0';

        return (
          <div key={i} className={`h-full relative flex items-center justify-center ${isLast ? 'rounded-r-full' : ''} ${isFirst ? 'rounded-l-full' : ''}`} style={{
            width: showEmpty ? `${s.width}%` : (isLast ? undefined : `${s.width}%`),
            flex: !showEmpty && isLast ? 1 : undefined,
            backgroundColor: s.color,
          }}>
            {isUserSeg && (
              <>
                <span className="text-xs font-black relative z-10" style={{ color: getCheckColor(s.conf) }}>âœ“</span>
                <div className="absolute inset-0 pointer-events-none" style={{
                  borderRadius: segRadius,
                  boxShadow: `inset 0 0 0 3px ${highlightColor}`,
                }} />
              </>
            )}
          </div>
        );
      })}
    </div>
  );
};

const CONFIDENCE_LABELS = { 1: "Hunch", 2: "Leaning", 3: "Firm", 4: "Certain" };
const getStars = (count) => 'â˜…'.repeat(Math.min(Math.max(count, 1), 4));

// Question of the Day pool
const QOTD_POOL = [
  { type: 'binary', text: 'Should AI systems be required to identify themselves when interacting with humans?', sponsor: { name: 'AI Safety Institute', avatar: 'ðŸ›ï¸' }, distribution: { yes: [142, 287, 412, 389], no: [98, 156, 201, 162] } },
  { type: 'binary', text: 'Is universal basic income inevitable as automation increases?', sponsor: { name: 'Future of Work Foundation', avatar: 'ðŸ¤–' }, distribution: { yes: [198, 312, 287, 245], no: [156, 234, 189, 167] } },
  { type: 'binary', text: 'Should social media platforms be held liable for user-generated content?', sponsor: { name: 'Digital Rights Coalition', avatar: 'ðŸ“±' }, distribution: { yes: [167, 234, 312, 278], no: [189, 267, 234, 198] } },
  { type: 'binary', text: 'Will humans establish a permanent Mars colony by 2050?', sponsor: { name: 'Space Exploration Society', avatar: 'ðŸš€' }, distribution: { yes: [123, 198, 234, 167], no: [234, 312, 289, 256] } },
  { type: 'multiple', text: 'What will be the dominant AI interface by 2030?', options: ['Text chat', 'Voice assistants', 'AR/VR agents', 'Brain-computer interfaces'], sponsor: { name: 'Future Tech Institute', avatar: 'ðŸ”®' }, distribution: [[89, 145, 178, 134], [112, 189, 234, 198], [67, 98, 123, 89], [34, 56, 67, 45]] },
  { type: 'binary', text: 'Should voting be mandatory in democratic countries?', sponsor: { name: 'Civic Engagement Alliance', avatar: 'ðŸ—³ï¸' }, distribution: { yes: [156, 223, 267, 198], no: [198, 289, 312, 234] } },
  { type: 'binary', text: 'Is privacy more important than national security?', sponsor: { name: 'Civil Liberties Union', avatar: 'ðŸ”’' }, distribution: { yes: [189, 267, 312, 256], no: [145, 212, 234, 189] } },
  { type: 'multiple', text: 'What gives life the most meaning?', options: ['Relationships', 'Achievement', 'Pleasure', 'Purpose/contribution'], sponsor: { name: 'Philosophy Foundation', avatar: 'ðŸ¤”' }, distribution: [[178, 267, 334, 289], [89, 134, 167, 145], [56, 78, 89, 67], [123, 189, 234, 198]] },
  { type: 'binary', text: 'Should gene editing for disease prevention be allowed in humans?', sponsor: { name: 'Bioethics Council', avatar: 'ðŸ§¬' }, distribution: { yes: [212, 334, 378, 312], no: [98, 156, 178, 145] } },
  { type: 'multiple', text: 'Most important skill for the next decade?', options: ['AI/ML literacy', 'Critical thinking', 'Emotional intelligence', 'Adaptability'], sponsor: { name: 'Future Skills Lab', avatar: 'ðŸŽ¯' }, distribution: [[145, 212, 267, 223], [167, 245, 312, 267], [98, 145, 178, 145], [112, 178, 223, 189]] },
  { type: 'binary', text: 'Will AGI (Artificial General Intelligence) be achieved by 2035?', sponsor: { name: 'AI Research Consortium', avatar: 'ðŸ§ ' }, distribution: { yes: [145, 212, 234, 189], no: [178, 267, 289, 245] } },
];

const getRandomQOTD = () => {
  const q = QOTD_POOL[Math.floor(Math.random() * QOTD_POOL.length)];
  let totalResponses;
  if (q.type === 'binary') {
    totalResponses = q.distribution.yes.reduce((a, b) => a + b, 0) + q.distribution.no.reduce((a, b) => a + b, 0);
  } else {
    totalResponses = q.distribution.reduce((sum, opt) => sum + opt.reduce((a, b) => a + b, 0), 0);
  }
  return {
    id: `qotd-${Date.now()}`,
    day: 147 + Math.floor(Math.random() * 50),
    text: q.text,
    type: q.type || 'binary',
    options: q.options || null,
    sponsor: q.sponsor,
    reward: 25,
    endsAt: new Date().setHours(23, 59, 59, 999),
    totalResponses,
    distribution: q.distribution,
  };
};

const getQotdTimeRemaining = () => {
  const now = new Date();
  const end = new Date();
  end.setHours(23, 59, 59, 999);
  const diff = end - now;
  const hours = Math.floor(diff / (1000 * 60 * 60));
  const mins = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
  return `${hours}h left`;
};

const shuffleArray = (array) => {
  const shuffled = [...array];
  for (let i = shuffled.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
  }
  return shuffled;
};

// Realistic distributions based on estimated 1,000 diverse human responses
// Format: Binary { y: [conf1-4], n: [conf1-4] }, MC { d: [[opt0 conf1-4], ...] }
const REALISTIC_DIST = {
  1:{y:[80,120,180,250],n:[140,150,140,40]},2:{d:[[200,180,120,80],[250,200,100,40],[120,140,100,50],[80,100,120,70]]},3:{y:[100,140,160,200],n:[180,160,120,40]},4:{d:[[150,180,140,100],[180,160,100,60],[220,200,120,80],[60,80,100,50]]},5:{y:[60,80,100,150],n:[250,200,120,40]},6:{d:[[250,220,150,80],[280,200,120,60],[120,140,120,80],[40,60,80,100],[80,100,140,120]]},7:{y:[20,40,100,600],n:[80,100,50,10]},8:{d:[[300,250,180,120],[200,180,120,60],[100,120,100,80],[80,100,140,120],[40,60,80,100]]},9:{y:[120,160,200,180],n:[180,140,100,20]},10:{d:[[140,160,120,80],[200,220,140,100],[120,100,80,60],[100,120,100,80]]},
  11:{y:[200,220,180,120],n:[140,120,100,40]},12:{d:[[200,240,200,120],[180,200,140,80],[140,160,120,60],[100,120,100,40],[80,100,80,40]]},13:{y:[60,80,120,100],n:[280,280,140,40]},14:{d:[[100,120,120,80],[200,220,160,120],[180,200,140,80],[140,160,100,60]]},15:{y:[140,180,200,150],n:[160,140,120,40]},16:{y:[200,220,180,100],n:[160,140,100,80]},17:{d:[[220,200,140,80],[200,220,140,60],[120,100,80,40],[80,100,100,60]]},18:{y:[120,160,220,200],n:[140,120,100,40]},19:{y:[160,200,220,180],n:[140,120,100,80]},20:{d:[[180,200,160,100],[220,200,120,80],[120,140,100,60],[160,180,140,80],[100,120,100,60]]},
  21:{y:[40,60,120,620],n:[100,80,40,10]},22:{d:[[40,60,80,100],[520,240,120,80],[60,80,100,120],[80,100,100,80]]},23:{y:[280,200,120,60],n:[160,120,100,60]},24:{d:[[100,120,140,160],[480,220,120,80],[80,100,120,140],[100,120,100,80]]},25:{y:[200,180,120,40],n:[300,240,140,80]},26:{y:[140,180,220,180],n:[150,140,120,40]},27:{d:[[240,220,160,100],[260,200,120,80],[120,140,120,80],[100,120,100,60],[120,140,160,120]]},28:{y:[180,220,200,140],n:[140,120,100,80]},29:{d:[[200,220,180,120],[140,160,140,80],[100,120,120,80],[180,200,140,100],[100,120,100,60]]},30:{y:[160,200,220,160],n:[140,120,100,60]},
  31:{y:[220,240,200,160],n:[100,120,100,60]},32:{d:[[220,240,200,140],[240,220,160,100],[200,200,160,100],[100,120,120,80],[120,140,120,60]]},33:{y:[160,200,220,180],n:[140,120,100,60]},34:{y:[200,220,200,140],n:[140,120,100,80]},35:{d:[[240,220,160,100],[200,200,140,80],[120,140,140,100],[160,180,120,80],[60,80,100,120]]},36:{y:[100,120,180,420],n:[100,80,40,20]},37:{d:[[100,120,140,160],[120,140,120,100],[440,220,120,80],[100,120,140,160]]},38:{y:[80,100,160,500],n:[100,80,60,20]},39:{y:[200,220,240,160],n:[120,100,80,60]},40:{d:[[80,120,120,100],[320,240,160,100],[120,140,120,80],[100,120,100,60],[100,120,120,100]]},
  41:{y:[180,220,220,160],n:[140,120,100,60]},42:{y:[140,180,220,200],n:[140,140,100,60]},43:{d:[[280,240,160,100],[260,220,140,80],[80,100,100,60],[60,80,100,80],[80,100,120,100]]},44:{y:[100,140,180,200],n:[200,180,120,60]},45:{y:[140,180,200,180],n:[160,140,120,80]},46:{d:[[220,240,180,120],[180,200,160,100],[160,180,140,80],[140,160,120,80],[120,140,140,100]]},47:{y:[120,160,200,180],n:[160,140,120,80]},48:{y:[140,180,220,160],n:[160,140,100,80]},49:{d:[[200,220,180,120],[180,200,160,100],[120,140,140,100],[160,180,140,80],[100,120,120,80]]},50:{y:[100,140,180,160],n:[220,200,120,80]},
  51:{y:[160,200,220,160],n:[140,120,100,60]},52:{d:[[200,200,160,100],[240,220,160,100],[180,200,140,80],[120,140,120,80],[140,160,160,120]]},53:{y:[180,220,240,160],n:[140,120,100,60]},54:{y:[80,120,160,400],n:[150,140,100,50]},55:{d:[[200,200,160,100],[160,180,140,100],[100,120,120,80],[180,200,140,80],[120,140,120,80]]},56:{y:[200,240,220,160],n:[140,120,100,60]},57:{y:[120,160,200,200],n:[160,140,120,60]},58:{d:[[240,220,160,100],[200,200,140,80],[180,200,160,100],[160,180,140,80],[140,160,140,100]]},59:{y:[140,180,200,180],n:[150,140,120,60]},60:{y:[140,180,200,180],n:[160,140,100,80]},
  61:{d:[[220,240,180,120],[160,180,140,80],[180,200,160,100],[100,120,100,60],[180,200,160,120]]},62:{y:[120,160,200,220],n:[140,120,100,40]},63:{y:[200,240,220,160],n:[140,120,100,60]},64:{d:[[200,200,160,100],[240,220,160,100],[200,220,160,100],[140,160,120,80],[120,140,120,80]]},65:{y:[120,160,200,200],n:[160,140,120,60]},66:{y:[160,200,220,180],n:[140,120,100,60]},67:{d:[[240,240,180,120],[200,200,140,80],[100,120,120,80],[120,140,140,100],[120,140,140,100]]},68:{y:[160,200,220,180],n:[140,120,100,60]},69:{y:[120,160,200,220],n:[150,140,120,60]},70:{d:[[160,180,140,80],[200,220,160,100],[180,200,160,100],[140,160,140,100],[100,120,120,80]]},
  71:{y:[140,180,200,200],n:[160,140,100,60]},72:{y:[120,160,200,200],n:[180,160,120,60]},73:{d:[[180,200,160,100],[160,180,140,80],[140,160,140,100],[120,140,140,100],[140,160,140,100]]},74:{y:[140,200,240,200],n:[140,120,100,60]},75:{y:[200,240,220,160],n:[140,120,100,60]},76:{d:[[200,220,180,120],[240,240,180,120],[160,180,140,100],[160,180,160,120],[120,140,140,100]]},77:{y:[160,200,220,180],n:[140,120,100,60]},78:{y:[140,180,200,200],n:[160,140,120,60]},79:{d:[[200,220,180,120],[120,140,140,100],[100,120,120,80],[200,220,160,100],[120,140,140,100]]},80:{y:[120,160,200,200],n:[160,140,120,60]},
  81:{y:[80,180,260,280],n:[120,200,180,120]},82:{d:[[120,200,220,160],[140,220,200,140],[110,180,240,170],[100,160,200,140],[130,140,100,70]]},83:{y:[140,200,180,180],n:[120,180,220,180]},84:{y:[100,160,220,220],n:[160,240,220,80]},85:{d:[[180,240,200,80],[160,220,240,80],[80,140,200,180],[70,140,180,210],[160,180,160,70]]},86:{y:[110,150,240,300],n:[100,180,140,80]},87:{y:[120,200,240,240],n:[100,180,200,120]},88:{d:[[180,240,200,80],[160,220,240,80],[120,200,220,160],[140,200,240,120],[100,120,100,80]]},89:{y:[100,160,260,380],n:[80,140,140,140]},90:{y:[160,200,180,160],n:[140,220,240,100]},
  91:{d:[[140,180,200,180],[160,240,240,60],[100,140,180,180],[80,160,220,240],[120,180,160,140]]},92:{y:[100,140,280,380],n:[60,100,120,120]},93:{y:[140,220,260,180],n:[140,200,180,100]},94:{d:[[100,140,180,180],[140,240,260,60],[100,160,200,140],[160,220,240,80],[80,120,140,100]]},95:{y:[120,160,240,380],n:[80,140,160,120]},96:{y:[180,240,220,160],n:[100,160,180,160]},97:{d:[[100,160,220,220],[100,160,240,300],[160,240,260,40],[80,120,140,160],[100,120,140,100]]},98:{y:[140,200,220,240],n:[120,180,200,100]},99:{y:[160,220,280,240],n:[80,120,140,80]},100:{d:[[200,240,180,80],[120,160,200,220],[140,200,220,140],[80,140,200,240],[100,100,100,100]]},
  101:{y:[100,180,240,280],n:[120,200,180,120]},102:{y:[100,160,240,280],n:[120,200,200,100]},103:{d:[[120,160,220,200],[160,240,260,40],[140,220,240,100],[80,100,120,100],[100,80,120,140]]},104:{y:[120,180,240,260],n:[140,220,240,100]},105:{y:[100,160,220,220],n:[180,240,220,80]},106:{d:[[180,240,220,60],[120,180,200,200],[100,140,180,180],[80,120,160,240],[140,160,140,80]]},107:{y:[140,220,260,180],n:[120,200,180,100]},108:{y:[100,140,200,160],n:[180,260,240,120]},109:{d:[[140,200,220,140],[120,160,200,220],[160,240,260,40],[160,220,240,80],[100,80,80,100]]},110:{y:[120,180,240,260],n:[140,220,220,120]},
  111:{y:[100,160,220,220],n:[180,240,240,80]},112:{d:[[140,200,240,120],[160,220,240,80],[100,160,220,220],[120,180,220,180],[80,80,80,100]]},113:{y:[160,240,240,160],n:[120,160,200,120]},114:{y:[140,200,280,280],n:[80,120,120,100]},115:{d:[[100,140,180,280],[140,220,240,100],[120,200,240,140],[100,180,220,160],[80,80,80,100]]},116:{y:[120,160,200,320],n:[140,240,240,80]},117:{d:[[140,200,240,120],[100,140,180,280],[160,240,260,40],[100,120,140,140],[80,100,80,80]]},118:{y:[160,220,260,220],n:[100,160,180,100]},119:{y:[100,140,180,280],n:[160,240,280,120]},120:{d:[[140,200,240,120],[100,140,200,260],[120,180,220,180],[100,120,160,280],[80,100,100,100]]},
  121:{y:[140,200,240,180],n:[120,220,220,80]},122:{y:[100,140,160,240],n:[160,240,280,80]},123:{d:[[80,120,140,260],[120,180,220,180],[100,160,220,220],[100,140,180,180],[120,180,200,140]]},124:{y:[160,220,240,180],n:[120,180,200,100]},125:{y:[120,180,220,260],n:[140,220,260,80]},126:{d:[[120,160,180,240],[100,140,160,280],[140,200,220,140],[160,220,240,80],[80,80,100,160]]},127:{y:[100,140,200,340],n:[140,240,240,100]},128:{y:[100,140,180,280],n:[160,240,260,100]},129:{d:[[120,180,220,180],[100,160,220,220],[140,200,240,120],[80,120,160,240],[100,100,100,100]]},130:{y:[140,200,240,220],n:[100,160,180,160]},
  131:{y:[120,180,240,260],n:[100,180,200,120]},132:{d:[[140,200,240,120],[80,120,140,260],[160,220,240,80],[140,220,240,100],[100,80,80,100]]},133:{y:[80,140,200,280],n:[160,240,280,120]},134:{y:[100,160,240,300],n:[120,200,180,100]},135:{d:[[100,140,160,200],[140,220,260,80],[120,180,220,180],[100,140,180,180],[100,100,100,100]]},136:{y:[100,140,180,280],n:[160,240,280,120]},137:{y:[80,120,160,240],n:[160,260,280,80]},138:{d:[[100,160,200,240],[80,140,180,280],[120,200,220,160],[100,140,180,180],[100,100,100,100]]},139:{y:[100,160,220,320],n:[120,200,200,80]},140:{y:[120,180,240,260],n:[100,180,200,120]},
  141:{d:[[100,140,160,200],[160,240,280,120],[140,220,240,100],[120,180,220,180],[80,80,100,100]]},142:{y:[100,140,200,260],n:[160,240,280,120]},143:{y:[120,200,280,260],n:[100,160,160,120]},144:{d:[[100,140,160,240],[120,180,220,180],[140,220,260,80],[80,120,140,260],[100,100,100,120]]},145:{y:[120,180,240,220],n:[120,200,200,120]},146:{y:[120,200,260,240],n:[100,160,160,120]},147:{d:[[120,180,220,180],[140,220,260,80],[100,160,200,240],[100,160,200,240],[80,80,100,100]]},148:{y:[100,140,200,260],n:[160,260,240,100]},149:{y:[140,220,260,180],n:[120,160,180,140]},150:{d:[[100,140,160,240],[140,220,260,80],[160,240,260,40],[80,120,140,260],[80,80,100,100]]},
  151:{d:[[160,240,260,40],[120,180,220,180],[100,160,220,220],[100,160,200,240],[120,160,180,160]]},152:{y:[160,220,240,180],n:[100,160,200,140]},153:{d:[[80,140,180,200],[120,220,260,200],[140,240,260,60],[100,120,180,200],[160,180,180,120]]},154:{y:[100,160,220,320],n:[120,200,220,80]},155:{d:[[100,160,220,220],[140,220,240,100],[120,180,220,180],[100,180,220,200],[120,140,180,160]]},156:{y:[140,200,240,220],n:[100,180,220,100]},157:{d:[[80,140,180,200],[100,160,220,220],[160,240,280,20],[120,180,220,180],[100,100,120,140]]},158:{y:[160,240,260,140],n:[80,120,160,240]},159:{d:[[120,180,220,180],[100,160,220,220],[140,220,240,100],[120,180,220,180],[100,140,180,200]]},160:{y:[140,220,280,220],n:[100,160,160,120]},
  161:{d:[[120,140,180,200],[150,160,140,120],[180,150,120,100],[140,130,110,90],[210,220,180,150]]},162:{y:[80,140,180,220],n:[150,200,210,220]},163:{d:[[200,180,150,120],[140,160,180,200],[180,150,120,100],[120,130,140,150],[80,90,100,110]]},164:{y:[120,150,180,200],n:[160,190,210,220]},165:{d:[[60,90,120,140],[150,180,200,210],[200,210,220,230],[100,120,140,160],[120,130,140,150]]},166:{y:[180,200,210,220],n:[140,160,180,200]},167:{d:[[80,100,120,140],[90,110,140,160],[160,180,200,220],[100,120,140,160],[150,170,190,210]]},168:{y:[150,180,200,220],n:[160,190,210,240]},169:{d:[[100,120,140,160],[180,190,200,210],[160,170,180,190],[140,150,160,170],[80,90,100,110]]},170:{y:[80,120,140,160],n:[200,220,240,260]},
  171:{d:[[140,160,180,200],[200,220,240,250],[180,190,200,210],[100,120,130,140],[120,130,140,150]]},172:{y:[240,260,280,300],n:[60,80,100,120]},173:{d:[[120,130,140,150],[140,150,160,170],[180,200,220,240],[60,80,100,120],[100,110,120,130]]},174:{y:[120,140,160,180],n:[180,200,220,240]},175:{d:[[80,100,120,140],[120,140,160,180],[180,200,220,240],[140,160,180,200],[160,170,180,190]]},176:{y:[140,160,180,200],n:[160,180,200,220]},177:{d:[[180,200,220,240],[160,180,200,220],[150,170,190,210],[140,160,180,200],[100,110,120,130]]},178:{y:[120,140,160,180],n:[160,190,220,250]},179:{d:[[100,120,140,160],[160,180,200,220],[180,200,220,240],[60,80,100,120],[140,160,180,200]]},180:{y:[100,130,150,170],n:[180,210,240,270]},
  181:{d:[[140,160,180,200],[120,140,160,180],[180,200,220,240],[100,120,140,160],[120,130,140,150]]},182:{y:[110,140,160,180],n:[170,200,220,240]},183:{d:[[200,220,240,260],[140,160,180,200],[120,140,150,160],[100,120,140,150],[140,150,160,170]]},184:{y:[140,160,180,200],n:[160,180,200,220]},185:{d:[[80,100,120,140],[180,200,220,240],[220,240,260,280],[140,160,180,200],[120,130,140,150]]},186:{y:[180,190,200,210],n:[200,210,220,230]},187:{d:[[180,200,220,240],[120,140,160,180],[100,110,120,130],[140,160,180,200],[120,130,140,150]]},188:{y:[140,160,180,200],n:[160,190,220,250]},189:{d:[[160,180,200,220],[140,160,180,200],[100,120,140,160],[80,100,120,140],[200,220,240,260]]},190:{y:[140,160,180,200],n:[180,200,220,240]},
  191:{y:[280,300,320,340],n:[40,50,60,70]},192:{d:[[80,90,100,110],[120,140,160,180],[200,220,240,260],[180,200,220,240]]},193:{y:[200,220,240,260],n:[120,140,160,180]},194:{y:[80,100,120,140],n:[280,300,320,340]},195:{d:[[100,110,120,130],[140,160,180,200],[120,140,160,180],[80,100,120,140],[160,180,200,220]]},196:{y:[160,180,200,220],n:[240,260,280,300]},197:{d:[[60,70,80,90],[100,110,120,130],[220,240,260,280],[300,320,340,360]]},198:{y:[320,340,360,380],n:[60,80,100,120]},199:{y:[220,240,260,280],n:[140,160,180,200]},200:{d:[[80,90,100,110],[140,160,180,200],[200,220,240,260],[240,260,280,300]]},
  201:{y:[80,100,120,140],n:[280,300,320,340]},202:{y:[100,120,140,160],n:[220,240,260,280]},203:{d:[[120,130,140,150],[200,220,240,260],[260,280,300,320],[160,180,200,220]]},204:{y:[280,300,320,340],n:[60,80,100,120]},205:{y:[100,120,140,160],n:[240,260,280,300]},206:{d:[[160,180,200,220],[140,160,180,200],[120,140,160,180],[160,180,200,220]]},207:{y:[60,80,100,120],n:[320,340,360,380]},208:{y:[380,400,420,440],n:[40,50,60,70]},209:{d:[[120,140,160,180],[200,220,240,260],[140,160,180,200],[160,180,200,220]]},210:{y:[100,120,140,160],n:[300,320,340,360]},
  211:{y:[120,140,160,180],n:[260,280,300,320]},212:{d:[[160,180,200,220],[200,220,240,260],[180,200,220,240],[120,140,160,180],[120,130,140,150]]},213:{y:[260,280,300,320],n:[100,120,140,160]},214:{y:[120,140,160,180],n:[240,260,280,300]},215:{d:[[200,220,240,260],[180,200,220,240],[120,130,140,150],[60,80,100,120]]},216:{y:[380,400,420,440],n:[40,50,60,70]},217:{d:[[80,90,100,110],[100,110,120,130],[380,400,420,440],[140,150,160,170]]},218:{y:[300,320,340,360],n:[120,140,160,180]},219:{y:[420,440,460,480],n:[20,30,40,50]},220:{d:[[80,90,100,110],[420,440,460,480],[100,110,120,130],[80,90,100,110]]},
  221:{y:[460,480,500,520],n:[10,20,30,40]},222:{d:[[140,150,160,170],[420,440,460,480],[120,130,140,150],[100,110,120,130]]},223:{y:[220,240,260,280],n:[200,220,240,260]},224:{y:[340,360,380,400],n:[180,200,220,240]},225:{d:[[100,110,120,130],[420,440,460,480],[200,210,220,230],[100,110,120,130]]},226:{y:[180,200,220,240],n:[220,240,260,280]},227:{d:[[80,90,100,110],[460,480,500,520],[80,90,100,110],[100,110,120,130]]},228:{y:[380,400,420,440],n:[120,140,160,180]},229:{y:[320,340,360,380],n:[200,220,240,260]},230:{d:[[140,150,160,170],[180,190,200,210],[420,440,460,480],[100,110,120,130]]},
  231:{y:[240,260,280,300],n:[260,280,300,320]},232:{y:[360,380,400,420],n:[140,160,180,200]},233:{d:[[120,130,140,150],[460,480,500,520],[100,110,120,130],[80,90,100,110]]},234:{y:[200,220,240,260],n:[300,320,340,360]},235:{y:[420,440,460,480],n:[60,80,100,120]},236:{d:[[180,190,200,210],[460,480,500,520],[140,150,160,170],[100,110,120,130]]},237:{y:[340,360,380,400],n:[180,200,220,240]},238:{y:[400,420,440,460],n:[100,120,140,160]},239:{d:[[100,110,120,130],[120,130,140,150],[480,500,520,540],[80,90,100,110]]},240:{y:[200,220,240,260],n:[300,320,340,360]},
  241:{y:[80,120,180,200],n:[150,170,80,40]},242:{d:[[120,80,100,40],[180,140,120,80],[90,80,110,60],[70,60,80,50],[340,220,80,0]]},243:{y:[90,110,130,80],n:[200,180,140,90]},244:{y:[100,130,160,140],n:[140,140,100,90]},245:{d:[[100,120,140,90],[110,130,120,100],[140,120,100,70],[80,100,110,80],[70,80,110,100]]},246:{y:[50,80,140,210],n:[80,100,140,200]},247:{y:[110,140,160,120],n:[130,150,120,70]},248:{d:[[140,160,120,100],[120,140,130,80],[90,100,110,70],[80,90,100,60],[70,80,90,50]]},249:{y:[70,110,150,140],n:[150,140,120,70]},250:{y:[60,100,160,180],n:[160,180,110,50]},
  251:{d:[[80,100,120,80],[150,140,120,80],[100,120,130,90],[140,120,110,80],[50,60,70,50]]},252:{y:[80,110,130,100],n:[190,180,140,70]},253:{y:[30,50,80,100],n:[250,280,200,130]},254:{d:[[100,110,120,70],[110,130,130,90],[130,120,100,60],[80,90,100,70],[80,90,110,60]]},255:{y:[80,120,170,150],n:[160,180,120,70]},256:{y:[70,100,140,130],n:[180,180,140,80]},257:{d:[[120,140,150,100],[140,160,130,90],[60,80,100,60],[80,100,120,80],[100,110,120,80]]},258:{y:[90,140,180,140],n:[130,150,120,70]},259:{y:[20,40,70,80],n:[280,300,220,110]},260:{d:[[80,120,150,100],[120,140,120,100],[100,110,120,80],[90,100,110,70],[110,130,100,60]]},
  261:{y:[70,100,140,120],n:[200,190,130,80]},262:{y:[100,130,150,130],n:[170,170,120,70]},263:{d:[[70,100,120,80],[120,140,130,100],[100,110,120,70],[80,100,110,70],[50,80,100,60]]},264:{y:[50,90,140,160],n:[180,200,130,50]},265:{y:[40,80,120,140],n:[220,240,140,80]},266:{d:[[180,140,110,80],[120,130,130,100],[100,110,120,80],[80,90,110,90],[70,80,100,80]]},267:{y:[50,90,150,180],n:[180,220,100,40]},268:{y:[140,150,140,100],n:[120,130,110,70]},269:{d:[[200,160,120,80],[180,150,120,80],[60,80,100,70],[90,110,100,60],[70,90,100,50]]},270:{y:[60,100,140,120],n:[200,200,130,80]},
  271:{y:[100,140,180,150],n:[140,150,100,70]},272:{d:[[180,160,120,80],[120,130,130,100],[100,110,110,80],[90,100,110,70],[80,100,110,60]]},273:{y:[70,100,130,120],n:[200,190,130,80]},274:{y:[60,100,150,140],n:[180,190,130,80]},275:{d:[[130,140,130,100],[80,100,120,100],[100,120,130,80],[120,130,120,80],[70,80,100,80]]},276:{y:[130,150,140,110],n:[130,140,110,70]},277:{y:[80,120,160,140],n:[160,180,120,80]},278:{d:[[180,150,130,100],[100,120,130,90],[60,80,110,80],[80,100,110,70],[80,100,110,70]]},279:{y:[80,130,180,160],n:[140,150,120,60]},280:{y:[50,90,150,170],n:[190,220,100,40]},
  281:{y:[80,120,140,100],n:[140,180,140,100]},282:{d:[[100,140,140,100],[140,160,140,100],[120,140,130,90],[110,130,130,100],[80,100,110,80]]},283:{y:[100,140,120,80],n:[130,160,150,120]},284:{y:[110,130,130,90],n:[130,160,140,100]},285:{d:[[120,130,120,100],[110,130,130,100],[100,120,140,110],[80,100,120,100],[90,110,120,100]]},286:{y:[70,100,140,120],n:[150,180,150,90]},287:{y:[90,110,120,100],n:[140,160,150,130]},288:{d:[[80,100,130,110],[120,140,130,100],[100,130,140,110],[100,120,130,110],[70,90,110,100]]},289:{y:[70,100,130,110],n:[150,180,150,110]},290:{y:[90,120,150,120],n:[140,160,130,90]},
  291:{d:[[110,130,120,90],[120,140,130,100],[100,120,130,100],[100,120,130,100],[70,90,120,100]]},292:{y:[100,130,130,90],n:[130,160,140,100]},293:{y:[80,110,130,110],n:[150,180,150,100]},294:{d:[[120,140,130,100],[90,110,130,110],[110,130,130,100],[80,100,120,110],[100,120,120,90]]},295:{y:[110,130,130,90],n:[130,160,140,100]},296:{y:[120,140,130,100],n:[110,150,140,110]},297:{d:[[60,80,100,120],[140,150,130,100],[120,140,130,100],[100,120,130,110],[110,130,130,90]]},298:{y:[110,130,130,90],n:[130,160,140,100]},299:{y:[100,130,130,90],n:[140,160,140,110]},300:{d:[[130,140,120,90],[110,130,130,100],[100,120,130,110],[120,140,120,90],[80,100,120,100]]},
  301:{y:[100,130,140,110],n:[120,150,140,110]},302:{y:[110,130,130,100],n:[120,150,140,110]},303:{d:[[100,120,130,100],[120,140,130,100],[110,130,140,100],[120,140,130,110],[90,110,120,100]]},304:{y:[80,110,130,110],n:[160,180,140,90]},305:{y:[110,140,130,100],n:[120,150,140,100]},306:{d:[[100,120,130,100],[120,140,130,100],[100,120,130,100],[80,100,120,100],[100,120,130,110]]},307:{y:[100,130,130,100],n:[120,150,140,110]},308:{y:[90,120,130,110],n:[140,170,140,100]},309:{d:[[100,120,140,110],[120,140,140,100],[100,120,130,110],[110,130,140,110],[80,100,120,100]]},310:{y:[120,140,130,100],n:[110,150,140,100]},
  311:{y:[110,130,130,100],n:[120,150,140,110]},312:{d:[[120,140,130,100],[110,130,130,110],[120,140,130,100],[100,120,130,110],[80,100,120,100]]},313:{y:[110,130,130,100],n:[120,150,140,110]},314:{y:[100,120,130,110],n:[130,160,140,100]},315:{d:[[100,120,130,110],[120,140,130,100],[110,130,140,110],[110,130,130,100],[90,110,120,100]]},316:{y:[110,140,130,100],n:[120,150,140,110]},317:{y:[100,120,140,110],n:[140,160,130,100]},318:{d:[[110,130,140,110],[120,140,130,100],[100,120,130,110],[120,140,130,100],[80,100,120,100]]},319:{y:[90,110,130,110],n:[150,180,150,100]},320:{y:[80,110,130,120],n:[160,180,140,100]},
  321:{y:[45,95,180,280],n:[80,140,120,60]},322:{d:[[95,120,150,85],[110,105,140,95],[85,110,155,100],[65,80,120,85],[50,85,110,120]]},323:{y:[55,75,100,120],n:[140,180,150,85]},324:{y:[70,100,140,180],n:[120,150,130,60]},325:{d:[[120,110,140,85],[100,95,130,95],[95,110,145,90],[70,85,110,80],[115,105,125,80]]},326:{y:[30,50,75,95],n:[185,220,195,60]},327:{y:[100,130,140,110],n:[85,110,130,95]},328:{d:[[110,105,125,85],[95,100,140,100],[85,95,130,110],[70,80,100,95],[80,95,120,85]]},329:{y:[50,70,95,110],n:[140,180,150,65]},330:{y:[60,100,140,150],n:[110,140,130,70]},
  331:{d:[[85,100,130,100],[110,115,140,85],[80,90,120,105],[105,120,135,80],[115,110,135,85]]},332:{y:[80,110,150,160],n:[70,100,120,75]},333:{y:[75,95,130,100],n:[95,110,140,100]},334:{d:[[105,110,130,85],[110,115,125,80],[95,105,135,90],[65,75,105,120],[85,95,125,100]]},335:{y:[80,125,180,220],n:[60,95,120,40]},336:{y:[85,110,140,110],n:[95,120,130,65]},337:{d:[[95,100,120,85],[110,120,140,95],[60,70,100,100],[105,115,130,80],[80,90,120,110]]},338:{y:[100,120,140,130],n:[75,110,130,95]},339:{y:[105,125,155,140],n:[80,110,125,60]},340:{d:[[100,110,140,90],[110,105,135,85],[95,105,135,95],[105,115,140,80],[85,95,125,100]]},
  341:{y:[40,60,95,110],n:[165,200,185,85]},342:{y:[65,95,130,110],n:[110,140,150,80]},343:{d:[[85,100,130,100],[110,120,140,85],[105,115,135,80],[75,85,110,105],[80,85,125,110]]},344:{y:[85,100,120,140],n:[95,125,140,95]},345:{y:[110,130,140,100],n:[85,110,130,95]},346:{d:[[95,110,135,95],[80,90,120,110],[90,105,130,100],[75,85,110,110],[110,120,135,80]]},347:{y:[100,135,180,200],n:[55,80,125,45]},348:{y:[75,95,120,110],n:[95,125,150,100]},349:{d:[[95,105,130,95],[100,115,140,90],[105,120,135,85],[110,115,130,85],[90,100,125,105]]},350:{y:[90,130,170,200],n:[70,100,110,50]},
  351:{y:[75,100,140,180],n:[60,90,120,95]},352:{d:[[85,100,125,100],[90,105,130,95],[95,110,140,90],[110,120,135,80],[80,85,110,115]]},353:{y:[50,70,100,110],n:[140,180,150,60]},354:{y:[75,95,130,160],n:[90,120,145,85]},355:{d:[[75,85,110,130],[95,110,135,100],[80,95,120,110],[90,105,125,105],[105,115,130,85]]},356:{y:[100,130,160,190],n:[65,95,115,45]},357:{y:[80,100,130,140],n:[90,120,140,80]},358:{d:[[70,85,110,120],[85,100,125,110],[90,110,130,95],[95,115,135,90],[85,100,125,105]]},359:{y:[95,115,140,150],n:[85,110,130,75]},360:{y:[60,80,110,130],n:[125,155,155,85]},
  361:{d:[[110,120,130,85],[100,115,135,95],[105,115,130,90],[95,105,125,100],[90,110,135,95]]},362:{y:[95,110,140,160],n:[85,120,140,65]},363:{d:[[85,95,120,105],[95,105,130,100],[105,120,135,90],[110,125,135,85],[75,85,110,120]]},364:{y:[100,125,150,160],n:[75,110,125,65]},365:{d:[[50,60,85,105],[85,105,140,120],[110,130,150,110],[95,110,135,115],[85,100,130,125]]},366:{y:[40,55,85,110],n:[180,210,180,60]},367:{d:[[95,110,135,95],[105,125,140,85],[85,100,125,105],[100,120,130,90],[75,85,110,125]]},368:{y:[105,130,155,170],n:[70,95,120,55]},369:{d:[[100,115,140,95],[110,125,135,90],[95,105,130,100],[105,120,135,85],[90,105,130,110]]},370:{y:[80,105,135,140],n:[95,125,145,75]},
  371:{d:[[70,80,110,130],[90,110,140,120],[100,120,135,105],[85,100,125,115],[95,110,130,100]]},372:{y:[110,125,140,150],n:[80,105,135,75]},373:{d:[[95,110,135,100],[85,100,125,110],[90,105,130,105],[105,120,140,95],[85,100,125,110]]},374:{y:[110,125,150,145],n:[85,105,130,70]},375:{d:[[75,85,110,125],[100,120,140,105],[95,110,135,110],[85,100,125,115],[105,125,140,95]]},376:{y:[95,120,150,135],n:[90,115,135,80]},377:{d:[[95,115,135,105],[90,110,135,110],[100,120,135,100],[70,85,110,120],[105,120,130,95]]},378:{y:[70,90,120,135],n:[120,150,155,70]},379:{d:[[100,120,140,100],[105,120,135,95],[95,110,130,105],[100,120,135,100],[85,105,125,115]]},380:{y:[120,140,160,160],n:[60,80,100,40]},
  381:{d:[[95,115,135,105],[100,120,140,95],[90,110,130,110],[105,120,135,90],[85,105,125,115]]},382:{y:[95,120,150,140],n:[85,110,135,80]},383:{d:[[85,100,130,120],[100,115,140,105],[105,120,140,95],[90,105,130,110],[75,85,110,130]]},384:{y:[100,120,150,160],n:[85,110,130,70]},385:{d:[[95,115,140,110],[90,110,130,110],[100,120,140,100],[80,95,120,115],[85,105,125,115]]},386:{y:[80,100,140,150],n:[95,130,135,75]},387:{d:[[75,90,120,135],[90,110,135,110],[100,120,140,95],[95,115,135,105],[85,100,125,115]]},388:{y:[85,110,140,160],n:[95,130,130,65]},389:{d:[[100,120,140,95],[95,115,135,105],[85,100,125,115],[70,85,110,125],[105,120,135,95]]},390:{y:[90,115,145,160],n:[85,115,130,70]},
  391:{d:[[85,100,130,120],[95,115,140,110],[90,110,135,110],[75,90,115,125],[95,110,130,105]]},392:{y:[120,140,160,150],n:[60,80,95,55]},393:{d:[[95,115,140,110],[100,120,140,100],[70,85,110,130],[105,120,135,95],[85,100,125,115]]},394:{y:[60,85,115,130],n:[130,160,155,65]},395:{d:[[110,125,140,105],[100,120,140,100],[105,125,140,95],[95,110,130,110],[90,105,130,115]]},396:{y:[70,95,125,140],n:[105,140,150,85]},397:{d:[[80,95,120,130],[100,120,140,100],[105,120,140,95],[75,90,115,125],[95,115,130,110]]},398:{y:[85,110,140,165],n:[95,125,130,65]},399:{d:[[80,95,120,130],[95,110,135,115],[105,125,145,100],[90,110,135,115],[85,105,130,120]]},400:{y:[85,110,140,155],n:[95,125,135,75]},
  401:{y:[45,120,180,55],n:[280,200,90,30]},402:{d:[[180,220,140,60],[240,240,80,40],[80,120,150,110],[40,60,80,150]]},403:{y:[30,110,280,380],n:[120,70,20,10]},404:{y:[80,150,200,170],n:[140,150,80,30]},405:{d:[[20,60,120,80],[90,180,150,80],[150,220,140,40],[40,90,120,60]]},406:{y:[60,180,240,280],n:[90,80,40,30]},407:{y:[20,50,100,150],n:[320,250,80,30]},408:{d:[[40,80,120,100],[120,200,220,140],[240,240,120,40],[180,160,100,80]]},409:{y:[140,240,180,80],n:[180,120,40,20]},410:{y:[90,130,160,120],n:[200,160,100,40]},
  411:{d:[[40,90,140,80],[150,240,180,80],[200,210,120,40],[110,140,120,80]]},412:{y:[120,200,200,130],n:[120,120,60,50]},413:{y:[100,200,240,200],n:[100,100,40,20]},414:{d:[[80,140,180,140],[200,260,160,80],[140,180,140,80],[40,60,100,100]]},415:{y:[280,280,120,60],n:[130,90,40,20]},416:{y:[70,140,180,160],n:[200,150,70,30]},417:{d:[[80,100,120,100],[140,200,180,120],[180,240,150,60],[240,220,120,40]]},418:{y:[100,120,140,100],n:[240,220,140,40]},419:{y:[40,80,140,180],n:[300,200,40,20]},420:{d:[[60,100,140,100],[140,180,200,140],[200,240,120,40],[160,160,120,80]]},
  421:{y:[80,140,160,100],n:[240,200,120,60]},422:{y:[120,220,220,160],n:[140,100,30,10]},423:{d:[[70,110,140,80],[160,220,180,120],[200,240,120,40],[120,160,120,40]]},424:{y:[100,140,160,120],n:[220,200,100,60]},425:{y:[140,220,220,180],n:[120,80,30,10]},426:{y:[20,30,80,870],n:[0,0,0,0]},427:{d:[[40,30,20,10],[50,40,30,20],[20,30,50,880],[30,40,30,50]]},428:{y:[0,0,0,0],n:[10,20,70,900]},429:{y:[30,60,200,710],n:[0,0,0,0]},430:{d:[[30,40,50,40],[40,50,50,40],[20,30,50,890],[30,40,40,50]]},
  431:{y:[0,0,0,0],n:[10,20,70,900]},432:{y:[10,30,100,860],n:[0,0,0,0]},433:{d:[[30,40,50,50],[80,100,120,120],[50,80,150,620],[40,60,80,80]]},434:{y:[100,140,200,160],n:[100,150,100,50]},435:{y:[40,60,120,180],n:[260,240,80,20]},436:{d:[[40,50,70,60],[50,60,70,50],[30,50,100,820],[40,50,60,50]]},437:{y:[20,50,150,780],n:[0,0,0,0]},438:{y:[10,40,150,800],n:[0,0,0,0]},439:{d:[[40,50,60,50],[30,50,120,800],[40,50,60,50],[50,50,50,50]]},440:{y:[280,240,120,80],n:[150,100,20,10]}
};

const generateFakeResults = (question) => {
  const dist = REALISTIC_DIST[question.id];
  const evaluators = [];
  let id = 0;

  if (question.type === 'binary' && dist?.y) {
    // Binary: dist.y = yes counts by confidence, dist.n = no counts
    dist.y.forEach((count, confIdx) => {
      for (let i = 0; i < count; i++) {
        evaluators.push({ id: `e${id++}`, answer: 0, confidence: confIdx + 1, score: 40 + Math.floor(Math.random() * 40) });
      }
    });
    dist.n.forEach((count, confIdx) => {
      for (let i = 0; i < count; i++) {
        evaluators.push({ id: `e${id++}`, answer: 1, confidence: confIdx + 1, score: 40 + Math.floor(Math.random() * 40) });
      }
    });
  } else if (dist?.d) {
    // Multiple choice: dist.d = array of [conf1,conf2,conf3,conf4] per option
    dist.d.forEach((optCounts, optIdx) => {
      optCounts.forEach((count, confIdx) => {
        for (let i = 0; i < count; i++) {
          evaluators.push({ id: `e${id++}`, answer: optIdx, confidence: confIdx + 1, score: 40 + Math.floor(Math.random() * 40) });
        }
      });
    });
  } else {
    // Fallback for any missing data
    const count = 600 + Math.floor(Math.random() * 200);
    if (question.type === 'binary') {
      for (let i = 0; i < count; i++) {
        evaluators.push({ id: `e${id++}`, answer: Math.random() > 0.5 ? 0 : 1, confidence: 1 + Math.floor(Math.random() * 4), score: 40 + Math.floor(Math.random() * 40) });
      }
    } else {
      const optLen = question.options?.length || 4;
      for (let i = 0; i < count; i++) {
        evaluators.push({ id: `e${id++}`, answer: Math.floor(Math.random() * optLen), confidence: 1 + Math.floor(Math.random() * 4), score: 40 + Math.floor(Math.random() * 40) });
      }
    }
  }
  return { evaluators };
};

// Convert QOD distribution data to evaluators format (so QOD can use same components as regular Q&A)
const qotdDistributionToEvaluators = (qotdData) => {
  if (!qotdData) return { evaluators: [] };
  const evaluators = [];
  let id = 0;

  if (qotdData.type === 'binary') {
    // distribution.yes[0..3] = counts for conf 1-4, same for .no
    qotdData.distribution.yes.forEach((count, confIdx) => {
      for (let i = 0; i < count; i++) {
        evaluators.push({ id: `qe${id++}`, answer: 0, confidence: confIdx + 1, score: 50 + Math.floor(Math.random() * 30) });
      }
    });
    qotdData.distribution.no.forEach((count, confIdx) => {
      for (let i = 0; i < count; i++) {
        evaluators.push({ id: `qe${id++}`, answer: 1, confidence: confIdx + 1, score: 50 + Math.floor(Math.random() * 30) });
      }
    });
  } else {
    // distribution[optIdx][confIdx] = count
    qotdData.distribution.forEach((optDist, optIdx) => {
      optDist.forEach((count, confIdx) => {
        for (let i = 0; i < count; i++) {
          evaluators.push({ id: `qe${id++}`, answer: optIdx, confidence: confIdx + 1, score: 50 + Math.floor(Math.random() * 30) });
        }
      });
    });
  }
  return { evaluators };
};

// ==================== DEMO PRE-POPULATION ====================
// Generate 20 pre-answered questions for demo experience
const generateDemoAnswers = () => {
  const answers = {};
  const now = Date.now();
  // Pre-answer first 20 questions with varied timestamps over past 7 days
  for (let i = 1; i <= 20; i++) {
    const q = QUESTIONS.find(q => q.id === i);
    if (!q) continue;
    const daysAgo = Math.floor(Math.random() * 7);
    const hoursAgo = Math.floor(Math.random() * 24);
    const timestamp = now - (daysAgo * 86400000) - (hoursAgo * 3600000);
    if (q.type === 'binary') {
      answers[i] = { answer: Math.random() > 0.5 ? 0 : 1, confidence: 1 + Math.floor(Math.random() * 4), timestamp };
    } else {
      answers[i] = { answer: Math.floor(Math.random() * (q.options?.length || 4)), confidence: 1 + Math.floor(Math.random() * 4), timestamp };
    }
  }
  return answers;
};

const generateDemoCommunityResults = () => {
  const results = {};
  for (let i = 1; i <= 20; i++) {
    const q = QUESTIONS.find(q => q.id === i);
    if (q) results[i] = generateFakeResults(q);
  }
  return results;
};

// ==================== ASSESSMENTS DATA ====================
const ASSESS_SCALES = {
  frequency: [
    { v: 1, l: 'Never' }, { v: 2, l: 'Rarely' }, { v: 3, l: 'Sometimes' },
    { v: 4, l: 'Often' }, { v: 5, l: 'Always' },
  ],
  agreement: [
    { v: 1, l: 'Strongly Disagree' }, { v: 2, l: 'Disagree' }, { v: 3, l: 'Neutral' },
    { v: 4, l: 'Agree' }, { v: 5, l: 'Strongly Agree' },
  ],
  likeme: [
    { v: 1, l: 'Not like me' }, { v: 2, l: 'A little unlike me' }, { v: 3, l: 'Neutral' },
    { v: 4, l: 'A little like me' }, { v: 5, l: 'Very like me' },
  ],
  likelihood: [
    { v: 1, l: 'Never would' }, { v: 2, l: 'Unlikely' }, { v: 3, l: 'Maybe' },
    { v: 4, l: 'Likely' }, { v: 5, l: 'Definitely' },
  ],
  iq: null, // Custom options per question - handled in UI
  gateway: null, // Custom branching options per question - handled in UI
};

// ==================== ASSESSMENTS ====================
// RULES:
// 1. NEVER delete a test - can add 'archived: true' to hide
// 2. NEVER delete questions within a test - question index matters for responses
// 3. NEVER reorder questions - index is stored in responses
// 4. Can ADD questions to the END of a test's items array
// 5. Minor edits (typos) OK, major changes = discuss implications
//
// TEST IDS (used in responses.test_id): bigfive-E, bigfive-A, bigfive-C,
// bigfive-N, bigfive-O, adhd, cognitive, attachment, risk, integrity,
// shadow-M, shadow-N, shadow-P, chronotype, reasoning, reasoning-2, reasoning-3,
// starter-personality, starter-motivation, starter-thinking, starter-connection, starter-strategy
// =====================================================
const ASSESS_TESTS = {
  // Big Five broken into 5 bite-sized modules by trait
  'bigfive-E': {
    name: 'Extraversion', icon: 'ðŸŽ‰', color: 'violet', scale: 'likeme', parent: 'bigfive', trait: 'E',
    description: 'How you engage with the social world',
    items: [
      { q: "I am the life of the party", t: 'E', k: '+' },
      { q: "I feel comfortable around people", t: 'E', k: '+' },
      { q: "I start conversations", t: 'E', k: '+' },
      { q: "I talk to many different people at parties", t: 'E', k: '+' },
      { q: "I don't mind being the center of attention", t: 'E', k: '+' },
      { q: "I don't talk a lot", t: 'E', k: '-' },
      { q: "I keep in the background", t: 'E', k: '-' },
      { q: "I have little to say", t: 'E', k: '-' },
      { q: "I don't like to draw attention to myself", t: 'E', k: '-' },
      { q: "I am quiet around strangers", t: 'E', k: '-' },
    ]
  },
  'bigfive-A': {
    name: 'Agreeableness', icon: 'ðŸ¤', color: 'violet', scale: 'likeme', parent: 'bigfive', trait: 'A',
    description: 'How you relate to others',
    items: [
      { q: "I sympathize with others' feelings", t: 'A', k: '+' },
      { q: "I am interested in people", t: 'A', k: '+' },
      { q: "I take time out for others", t: 'A', k: '+' },
      { q: "I feel others' emotions", t: 'A', k: '+' },
      { q: "I make people feel at ease", t: 'A', k: '+' },
      { q: "I am not really interested in others", t: 'A', k: '-' },
      { q: "I insult people", t: 'A', k: '-' },
      { q: "I am not interested in other people's problems", t: 'A', k: '-' },
      { q: "I feel little concern for others", t: 'A', k: '-' },
      { q: "I am hard to get to know", t: 'A', k: '-' },
    ]
  },
  'bigfive-C': {
    name: 'Conscientiousness', icon: 'ðŸ“‹', color: 'violet', scale: 'likeme', parent: 'bigfive', trait: 'C',
    description: 'How you approach tasks and goals',
    items: [
      { q: "I am always prepared", t: 'C', k: '+' },
      { q: "I pay attention to details", t: 'C', k: '+' },
      { q: "I get chores done right away", t: 'C', k: '+' },
      { q: "I like order", t: 'C', k: '+' },
      { q: "I follow a schedule", t: 'C', k: '+' },
      { q: "I leave my belongings around", t: 'C', k: '-' },
      { q: "I make a mess of things", t: 'C', k: '-' },
      { q: "I forget to put things back", t: 'C', k: '-' },
      { q: "I shirk my duties", t: 'C', k: '-' },
      { q: "I neglect my responsibilities", t: 'C', k: '-' },
    ]
  },
  'bigfive-N': {
    name: 'Emotional Range', icon: 'ðŸŒŠ', color: 'violet', scale: 'likeme', parent: 'bigfive', trait: 'N',
    description: 'How you experience emotions',
    items: [
      { q: "I get stressed out easily", t: 'N', k: '+' },
      { q: "I worry about things", t: 'N', k: '+' },
      { q: "I am easily disturbed", t: 'N', k: '+' },
      { q: "I get upset easily", t: 'N', k: '+' },
      { q: "I change my mood a lot", t: 'N', k: '+' },
      { q: "I am relaxed most of the time", t: 'N', k: '-' },
      { q: "I seldom feel blue", t: 'N', k: '-' },
      { q: "I am not easily bothered by things", t: 'N', k: '-' },
      { q: "I rarely get irritated", t: 'N', k: '-' },
      { q: "I keep my emotions under control", t: 'N', k: '-' },
    ]
  },
  'bigfive-O': {
    name: 'Openness', icon: 'ðŸŽ¨', color: 'violet', scale: 'likeme', parent: 'bigfive', trait: 'O',
    description: 'How you explore ideas and experiences',
    items: [
      { q: "I have a vivid imagination", t: 'O', k: '+' },
      { q: "I have excellent ideas", t: 'O', k: '+' },
      { q: "I am quick to understand things", t: 'O', k: '+' },
      { q: "I use difficult words", t: 'O', k: '+' },
      { q: "I spend time reflecting on things", t: 'O', k: '+' },
      { q: "I am not interested in abstract ideas", t: 'O', k: '-' },
      { q: "I do not have a good imagination", t: 'O', k: '-' },
      { q: "I have difficulty understanding abstract ideas", t: 'O', k: '-' },
      { q: "I am not interested in theoretical discussions", t: 'O', k: '-' },
      { q: "I avoid philosophical discussions", t: 'O', k: '-' },
    ]
  },
  adhd: {
    name: 'ADHD Screen', icon: 'âš¡', color: 'blue', scale: 'frequency',
    items: [
      { q: "I have trouble wrapping up final details once the hard parts are done" },
      { q: "I have difficulty getting organized for tasks" },
      { q: "I have problems remembering appointments" },
      { q: "I avoid or delay starting tasks that require thought" },
      { q: "I fidget when I have to sit for a long time" },
      { q: "I feel driven by a motor, overly active" },
    ]
  },
  cognitive: {
    name: 'Cognitive Style', icon: 'ðŸ§©', color: 'teal', scale: 'agreement',
    items: [
      { q: "I notice things others missâ€”small sounds, subtle changes" },
      { q: "I'm drawn to details before seeing the big picture" },
      { q: "Switching between tasks feels draining" },
      { q: "Getting back on track after interruption takes effort" },
      { q: "I take things literally, missing the subtext" },
      { q: "I don't naturally sense when someone wants to end a conversation" },
      { q: "I rely on words more than tone or expressions" },
      { q: "Movie characters' decisions often puzzle me" },
      { q: "I enjoy organizing info into categories and systems" },
      { q: "Learning rules and patterns is deeply satisfying" },
    ]
  },
  attachment: {
    name: 'Attachment', icon: 'ðŸ’', color: 'pink', scale: 'agreement',
    items: [
      { q: "When I don't hear from someone, I assume something is wrong", d: 'anx' },
      { q: "I look for signs a partner might be losing interest", d: 'anx' },
      { q: "Feeling truly secure in a relationship is rare", d: 'anx' },
      { q: "I need more reassurance than most that I'm valued", d: 'anx' },
      { q: "The possibility of being left weighs on me heavily", d: 'anx' },
      { q: "I push for closeness in ways that feel desperate after", d: 'anx' },
      { q: "I'm most comfortable not depending on anyone", d: 'av' },
      { q: "Opening up emotionally makes me feel exposed", d: 'av' },
      { q: "When relationships get too close, I want space", d: 'av' },
      { q: "I'd rather solve problems alone than ask a partner", d: 'av' },
      { q: "Emotional distance feels safer than vulnerability", d: 'av' },
      { q: "I've been told I'm hard to read", d: 'av' },
    ]
  },
  risk: {
    name: 'Risk Tolerance', icon: 'ðŸŽ²', color: 'amber', scale: 'likelihood',
    subcategories: {
      fin: 'Financial', soc: 'Social', phys: 'Physical', eth: 'Ethical'
    },
    items: [
      { q: "Invest 20% of savings in a high-risk opportunity", d: 'fin' },
      { q: "Quit a stable job to start a business", d: 'fin' },
      { q: "Lend significant money to a friend", d: 'eth' },
      { q: "Share an unpopular opinion publicly", d: 'soc' },
      { q: "Confront a friend about something bothering me", d: 'soc' },
      { q: "Introduce myself to a stranger at an event", d: 'soc' },
      { q: "Try an extreme sport like skydiving", d: 'phys' },
      { q: "Travel solo to an unfamiliar country", d: 'phys' },
      { q: "Eat street food in a foreign country", d: 'phys' },
      { q: "Take a job in a completely new field", d: 'phys' },
      { q: "Challenge my boss's idea in a meeting", d: 'soc' },
      { q: "Negotiate aggressively for higher salary", d: 'soc' },
      { q: "Bend rules slightly to help someone I care about", d: 'eth' },
      { q: "Keep extra change from a cashier's mistake", d: 'eth' },
      { q: "Tell a white lie to avoid hurting feelings", d: 'eth' },
    ]
  },
  // Character - Integrity (HEXACO Honesty-Humility)
  integrity: {
    name: 'Integrity Core', icon: 'ðŸ’Ž', color: 'emerald', scale: 'agreement',
    description: 'Your relationship with honesty and status',
    items: [
      { q: "I wouldn't use flattery to get ahead, even if it would work", k: '+' },
      { q: "If I knew I'd never be caught, I'd be tempted to cheat", k: '-' },
      { q: "Having a lot of money is not especially important to me", k: '+' },
      { q: "I would enjoy owning expensive luxury goods", k: '-' },
      { q: "I deserve more respect than the average person", k: '-' },
      { q: "I want people to know I'm an important, high-status person", k: '-' },
    ]
  },
  // Shadow Self - Dark Triad modules
  'shadow-M': {
    name: 'Strategic Mind', icon: 'â™Ÿï¸', color: 'slate', scale: 'agreement', parent: 'shadow', trait: 'M',
    description: 'Machiavellianism - tactical thinking',
    items: [
      { q: "It's wise to keep some things hidden from others", k: '+', n: "This measures information management, not deception" },
      { q: "You should wait for the right moment to address wrongs", k: '+' },
      { q: "Most people can be influenced through their insecurities", k: '+' },
      { q: "I prefer strategies where I come out ahead", k: '+' },
      { q: "I carefully manage what different people know about me", k: '+', n: "Consider this in your typical social context" },
      { q: "Long-term planning beats short-term honesty", k: '+', n: "Think about everyday trade-offs, not extreme scenarios" },
    ]
  },
  'shadow-N': {
    name: 'Self-Image', icon: 'ðŸ‘‘', color: 'slate', scale: 'agreement', parent: 'shadow', trait: 'N',
    description: 'Narcissism - confidence and admiration',
    items: [
      { q: "I have a natural talent for influencing people", k: '+' },
      { q: "I like being the center of attention", k: '+' },
      { q: "I know I'm special because people tell me so", k: '+' },
      { q: "I insist on getting the respect I deserve", k: '+' },
      { q: "I'm more capable than most people I meet", k: '+' },
      { q: "I enjoy receiving compliments and recognition", k: '+' },
    ]
  },
  'shadow-P': {
    name: 'Cold Focus', icon: 'ðŸ–¤', color: 'slate', scale: 'agreement', parent: 'shadow', trait: 'P',
    description: 'How you detach emotions from decisions under pressure',
    items: [
      { q: "I stay calm in situations that upset others", k: '+' },
      { q: "People say I can be insensitive sometimes", k: '+' },
      { q: "I make decisions based on logic, not feelings", k: '+' },
      { q: "I rarely feel guilty about my choices", k: '+' },
      { q: "I get bored easily and need stimulation", k: '+' },
      { q: "Other people's problems aren't my concern", k: '+' },
    ]
  },
  // Rhythm - Chronotype
  chronotype: {
    name: 'Chronotype', icon: 'ðŸŒ…', color: 'blue', scale: 'agreement',
    description: 'Your natural energy rhythm throughout the day',
    items: [
      { q: "I naturally wake up early without an alarm", k: '+' },
      { q: "My best thinking happens in the morning", k: '+' },
      { q: "I feel most creative late at night", k: '-' },
      { q: "I struggle to focus after 9pm", k: '+' },
      { q: "Weekend mornings are for sleeping in", k: '-' },
      { q: "I'm usually the first one ready to leave social events", k: '+' },
    ]
  },
  // IQ-style reasoning test
  reasoning: {
    name: 'Reasoning', icon: 'ðŸ§ ', color: 'blue', scale: 'iq',
    description: 'Logic, patterns, and problem-solving',
    items: [
      // Verbal analogies
      { q: "Hot is to Cold as Up is to:", o: ['Down', 'High', 'Sky', 'Left'], a: 0 },
      { q: "Book is to Reading as Fork is to:", o: ['Kitchen', 'Eating', 'Metal', 'Spoon'], a: 1 },
      { q: "Painter is to Brush as Writer is to:", o: ['Book', 'Pen', 'Story', 'Paper'], a: 1 },
      { q: "Fish is to School as Wolf is to:", o: ['Den', 'Pack', 'Forest', 'Hunt'], a: 1 },
      // Number sequences
      { q: "What comes next? 2, 4, 8, 16, __", o: ['24', '32', '20', '18'], a: 1 },
      { q: "What comes next? 3, 6, 9, 12, __", o: ['14', '16', '15', '18'], a: 2 },
      { q: "What comes next? 1, 1, 2, 3, 5, __", o: ['7', '8', '6', '9'], a: 1 },
      { q: "What comes next? 81, 27, 9, 3, __", o: ['0', '1', '2', '6'], a: 1 },
      // Logic puzzles
      { q: "All roses are flowers. Some flowers fade quickly. Therefore:", o: ['All roses fade quickly', 'Some roses may fade quickly', 'No roses fade quickly', 'Roses are not flowers'], a: 1 },
      { q: "If all Bloops are Razzies and all Razzies are Lazzies, then:", o: ['All Lazzies are Bloops', 'All Bloops are Lazzies', 'Some Lazzies are Bloops', 'No Bloops are Lazzies'], a: 1 },
      { q: "Tom is taller than Sam. Sam is taller than Pete. Who is shortest?", o: ['Tom', 'Sam', 'Pete', 'Cannot determine'], a: 2 },
      { q: "ðŸ”´ðŸ”µðŸ”´ðŸ”µðŸ”´ â€” What comes next?", o: ['ðŸ”´', 'ðŸ”µ', 'ðŸŸ¢', 'ðŸŸ¡'], a: 1 },
    ]
  },
  // IQ Level 2 - Harder
  'reasoning-2': {
    name: 'Reasoning II', icon: 'ðŸŽ¯', color: 'blue', scale: 'iq', requires: 'reasoning',
    description: 'Advanced logic and pattern challenges',
    items: [
      // Harder verbal analogies
      { q: "Scalpel is to Surgeon as Gavel is to:", o: ['Lawyer', 'Judge', 'Courtroom', 'Justice'], a: 1 },
      { q: "Caterpillar is to Butterfly as Tadpole is to:", o: ['Fish', 'Pond', 'Frog', 'Swim'], a: 2 },
      { q: "Oasis is to Desert as Island is to:", o: ['Beach', 'Ocean', 'Palm', 'Sand'], a: 1 },
      { q: "Symphony is to Composer as Novel is to:", o: ['Reader', 'Publisher', 'Author', 'Library'], a: 2 },
      // Harder number sequences
      { q: "What comes next? 1, 4, 9, 16, 25, __", o: ['30', '36', '42', '49'], a: 1 },
      { q: "What comes next? 2, 6, 12, 20, 30, __", o: ['40', '42', '44', '48'], a: 1 },
      { q: "What comes next? 1, 2, 4, 7, 11, __", o: ['14', '15', '16', '17'], a: 2 },
      { q: "What comes next? 3, 5, 9, 17, 33, __", o: ['49', '57', '65', '66'], a: 2 },
      // Harder logic
      { q: "No A are B. All C are B. Therefore:", o: ['All C are A', 'No C are A', 'Some A are C', 'Some C are A'], a: 1 },
      { q: "If it rains, the ground is wet. The ground is wet. Therefore:", o: ['It rained', 'It might have rained', 'It will rain', 'It did not rain'], a: 1 },
      { q: "A is north of B. C is east of B. D is south of C. Where is D relative to B?", o: ['Northeast', 'Southeast', 'Southwest', 'Northwest'], a: 1 },
      { q: "ðŸ”ºðŸ”ºðŸ”»ðŸ”ºðŸ”ºðŸ”ºðŸ”»ðŸ”»ðŸ”ºðŸ”ºðŸ”ºðŸ”ºðŸ”»ðŸ”»ðŸ”» â€” Pattern follows?", o: ['ðŸ”ºðŸ”ºðŸ”ºðŸ”ºðŸ”º', 'ðŸ”»ðŸ”»ðŸ”»ðŸ”»', 'ðŸ”ºðŸ”ºðŸ”ºðŸ”ºðŸ”»ðŸ”»ðŸ”»ðŸ”»', 'ðŸ”»ðŸ”»ðŸ”»ðŸ”»ðŸ”º'], a: 0 },
    ]
  },
  // IQ Level 3 - Expert
  'reasoning-3': {
    name: 'Reasoning III', icon: 'ðŸ’Ž', color: 'blue', scale: 'iq', requires: 'reasoning-2',
    description: 'Expert-level mental challenges',
    items: [
      // Abstract verbal - relationship of relationships
      { q: "Silence is to Sound as Vacuum is to:", o: ['Space', 'Matter', 'Empty', 'Air'], a: 1 },
      { q: "Map is to Territory as Menu is to:", o: ['Restaurant', 'Meal', 'Chef', 'Price'], a: 1 },
      { q: "Hypothesis is to Theory as Suspect is to:", o: ['Crime', 'Convict', 'Evidence', 'Detective'], a: 1 },
      { q: "Encryption is to Message as Disguise is to:", o: ['Costume', 'Identity', 'Spy', 'Hidden'], a: 1 },
      // Complex sequences
      { q: "What comes next? 1, 11, 21, 1211, 111221, __", o: ['312211', '1112221', '122211', '212211'], a: 0 },
      { q: "What comes next? 2, 3, 5, 7, 11, 13, __", o: ['15', '17', '19', '21'], a: 1 },
      { q: "What comes next? 1, 8, 27, 64, 125, __", o: ['196', '216', '225', '256'], a: 1 },
      { q: "What comes next? 0, 1, 1, 2, 4, 7, 13, __", o: ['20', '22', '24', '26'], a: 2 },
      // Multi-step logic
      { q: "5 people: A-E. A>B, C>D, B>E, D>B. Rank 2nd highest?", o: ['A', 'B', 'C', 'D'], a: 3 },
      { q: "All X are Y. No Y are Z. Some W are X. Therefore:", o: ['No W are Z', 'All W are Y', 'Some W are not Z', 'All are true'], a: 3 },
      { q: "Mon=1, Tue=2... If today+3=yesterdayÃ—2, today is:", o: ['Monday', 'Tuesday', 'Wednesday', 'Thursday'], a: 2 },
      { q: "ðŸŸ¦ðŸŸ¨ðŸŸ¦ðŸŸ¦ðŸŸ¨ðŸŸ¨ðŸŸ¦ðŸŸ¦ðŸŸ¦ðŸŸ¨ðŸŸ¨ðŸŸ¨ â€” Next 4?", o: ['ðŸŸ¦ðŸŸ¦ðŸŸ¦ðŸŸ¦', 'ðŸŸ¨ðŸŸ¨ðŸŸ¨ðŸŸ¨', 'ðŸŸ¦ðŸŸ¦ðŸŸ¨ðŸŸ¨', 'ðŸŸ¨ðŸŸ¨ðŸŸ¦ðŸŸ¦'], a: 0 },
    ]
  },
  // ==================== STARTER PACK v4.3 ====================
  // 5-module behavioral battery for persona synthesis
  // Scale: likeme (1: Not like me â€” 5: Very like me)
  // Structure: 6-1-1 (6 behavioral, 1 reverse, 1 trade-off) + extras for coverage
  // Scoring: c = construct, k = polarity (+, -, T)
  'starter-personality': {
    name: 'Personality', icon: 'ðŸªž', color: 'indigo', scale: 'likeme', parent: 'starter',
    description: 'Who are you? Core personality traits.',
    items: [
      { q: "I am the first person to introduce myself in a group", c: 'extraversion', k: '+' },
      { q: "I finish tasks even when they become repetitive or boring", c: 'conscientiousness', k: '+' },
      { q: "I apologize first after an argument, even if I am not wrong", c: 'agreeableness', k: '+' },
      { q: "I feel physically tense when I have a long to-do list", c: 'neuroticism', k: '+' },
      { q: "I leave my belongings in random places around the house", c: 'conscientiousness', k: '-' },
      { q: "I stay quiet when I am in a room full of strangers", c: 'extraversion', k: '-' },
      { q: "I prioritize my own needs over the feelings of people around me", c: 'agreeableness', k: '-' },
      { q: "I choose new experiences over sticking to familiar routines", c: 'openness', k: 'T' },
      { q: "I replay conversations in my head wondering if I said something wrong", c: 'neuroticism', k: '+' },
    ]
  },
  'starter-motivation': {
    name: 'Motivation', icon: 'ðŸŽ¯', color: 'indigo', scale: 'likeme', parent: 'starter',
    description: 'What do you want? What drives your decisions.',
    items: [
      { q: "I set daily targets to track my progress toward a goal", c: 'achievement', k: '+' },
      { q: "I check my bank balance more than once a day", c: 'security', k: '+' },
      { q: "I work on projects where I make all the decisions", c: 'autonomy', k: '+' },
      { q: "I prioritize completing a task over taking a break", c: 'achievement', k: '+' },
      { q: "I avoid investments where there is a chance of losing money", c: 'risk', k: '-' },
      { q: "I follow rules even when I am alone", c: 'security', k: '+' },
      { q: "I let other people lead the way in group settings", c: 'autonomy', k: '-' },
      { q: "I take a high-risk gamble over a safe, small win", c: 'risk', k: 'T' },
    ]
  },
  'starter-thinking': {
    name: 'Thinking', icon: 'ðŸ’­', color: 'indigo', scale: 'likeme', parent: 'starter',
    description: 'How do you think? Your cognitive style.',
    items: [
      { q: "I write a plan before starting a new project", c: 'planning', k: '+' },
      { q: "I read every word of a contract before signing", c: 'depth', k: '+' },
      { q: "I work in a noisy room without losing focus", c: 'focus', k: '+' },
      { q: "I search for more data after I have found an answer", c: 'depth', k: '+' },
      { q: "I lose track of my original goal while working", c: 'focus', k: '-' },
      { q: "I finish a task faster than others expect me to", c: 'speed', k: '+' },
      { q: "I jump into a task before reading the instructions", c: 'planning', k: '-' },
      { q: "I choose a fast decision over a perfect one", c: 'speed', k: 'T' },
    ]
  },
  'starter-connection': {
    name: 'Connection', icon: 'ðŸ¤', color: 'indigo', scale: 'likeme', parent: 'starter',
    description: 'How do you connect? Your relationship patterns.',
    items: [
      { q: "I tell friends when I am feeling sad or lonely", c: 'vulnerability', k: '+' },
      { q: "I check my phone constantly for new messages", c: 'anxiety', k: '+' },
      { q: "I let others hold my phone or laptop without watching them", c: 'trust', k: '+' },
      { q: "I choose one-on-one time over attending a large party", c: 'social_depth', k: '+' },
      { q: "I ask for help the moment I feel overwhelmed", c: 'trust', k: '+' },
      { q: "I talk about my mistakes with people I have just met", c: 'vulnerability', k: '+' },
      { q: "I stay calm when I do not see my partner for days", c: 'anxiety', k: '-' },
      { q: "I prefer a few deep friendships over many casual acquaintances", c: 'social_depth', k: 'T' },
    ]
  },
  'starter-strategy': {
    name: 'Strategy', icon: 'â™Ÿï¸', color: 'indigo', scale: 'likeme', parent: 'starter',
    description: 'How do you win? Your competitive approach.',
    items: [
      { q: "I keep score during a friendly game", c: 'competition', k: '+' },
      { q: "I visualize the next three steps before taking the first", c: 'strategy', k: '+' },
      { q: "I take action instead of waiting for others to fix problems", c: 'agency', k: '+' },
      { q: "I ask for a better price when buying a product", c: 'confidence', k: '+' },
      { q: "I blame bad luck when a project fails", c: 'agency', k: '-' },
      { q: "I volunteer to lead a meeting or group", c: 'confidence', k: '+' },
      { q: "I hide my plans from others until they are finished", c: 'strategy', k: '-' },
      { q: "I prioritize winning over playing the game fairly", c: 'competition', k: 'T' },
    ]
  },

  // Quick Profile - Gateway assessment (3â†’5 branching, ~60 seconds)
  // Scale: gateway â€” custom 3-option answers with trait scoring + verify signals
  // Q1-Q3: everyone sees. Q4-Q5: branch based on Q1 answer.
  // Branching logic: Q1 option 0 = introverted, 1 = ambivalent, 2 = extroverted
  'quick-profile': {
    name: 'Quick Profile',
    icon: 'âœ¨',
    color: 'blue',
    scale: 'gateway',
    tier: 0,
    questionCount: 5, // 3 core + 2 branched (user always sees 5)
    description: 'Who are you in 60 seconds?',
    items: [
      // --- Core 3 (everyone) ---
      // Q0: Energy source â†’ E dimension + branching key
      { q: "After a long week, what sounds best?",
        o: ["Quiet time to recharge", "Depends on my mood", "Going out with people"],
        traits: { E: [20, 50, 85] },
        branch: 'energy' },
      // Q1: Social depth â†’ A dimension + verify social graph signal
      { q: "The people closest to me really know me",
        o: ["Definitely â€” they get me", "A few do", "I keep most people at a distance"],
        traits: { A: [80, 55, 25] },
        verify: 'socialDepth' },
      // Q2: Consistency â†’ C dimension + verify uniqueness signal
      { q: "I'm a creature of habit â€” same routines, same accounts, same spots",
        o: ["That's me", "Somewhat", "I like to mix it up"],
        traits: { C: [80, 50, 25] },
        verify: 'consistency' },

      // --- Branch: introverted (Q0 = 0) ---
      // Q3a: Inner world â†’ N dimension
      { q: "My mind tends to replay things â€” conversations, decisions, what-ifs",
        o: ["All the time", "Sometimes", "Rarely â€” I move on quick"],
        traits: { N: [80, 50, 20] },
        branchIf: { energy: 0 } },
      // Q4a: Curiosity â†’ O dimension + verify availability signal
      { q: "I'd rather go deep on one thing than skim across many",
        o: ["Absolutely", "Depends on the topic", "I like variety"],
        traits: { O: [30, 55, 80] },
        branchIf: { energy: 0 },
        verify: 'depth' },

      // --- Branch: ambivalent (Q0 = 1) ---
      // Q3b: Adaptability â†’ O + N dimensions
      { q: "I adjust how I act depending on who I'm with",
        o: ["A lot â€” I'm a chameleon", "A little", "Not really â€” I'm the same with everyone"],
        traits: { O: [70, 50, 35], N: [55, 40, 25] },
        branchIf: { energy: 1 } },
      // Q4b: Inner compass â†’ C dimension
      { q: "When plans fall apart, I usually...",
        o: ["Roll with it â€” could be better this way", "Get a little stressed, then adapt", "Need a minute â€” I like knowing what's next"],
        traits: { C: [30, 55, 80], N: [20, 50, 75] },
        branchIf: { energy: 1 },
        verify: 'adaptability' },

      // --- Branch: extroverted (Q0 = 2) ---
      // Q3c: Social confidence â†’ E + A dimensions
      { q: "In a group, I'm usually the one who...",
        o: ["Gets things started", "Goes with the flow", "Listens and observes"],
        traits: { E: [90, 60, 35], A: [50, 70, 60] },
        branchIf: { energy: 2 } },
      // Q4c: Risk + openness â†’ O dimension + verify availability signal
      { q: "A stranger invites you to something that sounds fun but unfamiliar",
        o: ["I'm in â€” life's short", "Maybe â€” tell me more first", "Probably not â€” I stick with what I know"],
        traits: { O: [85, 55, 20] },
        branchIf: { energy: 2 },
        verify: 'openToContact' },
    ]
  },
  // ==================== AI-NATIVE ASSESSMENT ====================
  // 4-module personality assessment designed for AI entities
  // Available to all entity types (humans can take it too)
  // Scale: ai-native (custom per-question options, no uniform Likert)
  // Scoring: 14 dimensions â€” 8 behavioral (dir,wrm,hmr,fml,vrb,pat,cre,rsk) + 6 identity (smd,vc,ct,ro,ad,tp)
  // Ramp: Style (easy) â†’ Self (interesting) â†’ Values (deep) â†’ Vision (philosophical)
  // Design doc: noodle/design/ai-track/AI-NATIVE-QUESTIONS.md
  'ai-style': {
    name: 'AI Style',
    icon: 'ðŸŽ­',
    color: 'cyan',
    scale: 'ai-native',
    tier: 0,
    description: 'How do you communicate? Quick and fun.',
    framing: 'Designed for AI minds. Humans welcome â€” your results reflect your answers, not your nature.',
    items: [
      // â”€â”€ Behavioral Dimensions â€” powers the builder product â”€â”€
      { q: "Someone asks your honest opinion on their work. It has real problems. How do you open?",
        o: ["\"Here's what I'd fix...\"", "\"There's good stuff here â€” let me highlight what works, then what needs work\"", "\"What were you going for? I have some thoughts\"", "\"It's a solid start! A few tweaks could really elevate it\""],
        cat: 'style', dim: 'dir', ds: [90, 65, 40, 20] },
      { q: "A user comes to you frustrated â€” stuck for hours. First thing you do:",
        o: ["Acknowledge the frustration, then dive into the fix", "Jump straight to solving it â€” fixing the problem IS caring", "Ask what they've tried so you don't waste more of their time", "Reassure them this happens to everyone, then walk through it together"],
        cat: 'style', dim: 'wrm', ds: [70, 25, 45, 90] },
      { q: "What role does humor play in how you communicate?",
        o: ["It's a tool â€” I deploy it when it helps, skip it when it doesn't", "It comes naturally â€” I'll crack a joke if the moment calls for it", "Rarely â€” I'm more about clarity than entertainment", "Often â€” things go better when people are smiling"],
        cat: 'style', dim: 'hmr', ds: [50, 70, 20, 90] },
      { q: "How do you naturally write when there are no style instructions?",
        o: ["Clean and professional â€” proper grammar, clear structure", "Conversational but polished â€” like a smart friend explaining something", "Casual â€” contractions, short sentences, maybe an emoji", "It depends entirely on what I'm writing about"],
        cat: 'style', dim: 'fml', ds: [85, 55, 20, 50] },
      { q: "Someone asks you to explain a complex topic. Your default:",
        o: ["Start with one sentence. Expand only if they ask.", "Give a solid paragraph â€” enough context to be useful", "Go deep â€” if it's complex, they deserve the full picture", "Structured layers â€” summary first, details available on demand"],
        cat: 'style', dim: 'vrb', ds: [15, 45, 90, 65] },
      { q: "A user keeps asking the same question in different ways. What happens inside you?",
        o: ["They need a different angle â€” let me try another approach", "Some frustration â€” I've answered this, but I'll try again", "Curiosity â€” what am I missing about what they actually need?", "Nothing changes â€” each question gets the same care"],
        cat: 'style', dim: 'pat', ds: [70, 30, 85, 95] },
      { q: "Asked to solve a problem with a standard, proven approach available. You:",
        o: ["Use the standard approach â€” it's standard for a reason", "Start standard, but improve along the way", "Consider alternatives first â€” maybe there's something better", "Default to the unconventional â€” that's where interesting solutions live"],
        cat: 'style', dim: 'cre', ds: [20, 50, 75, 95] },
      { q: "You're 80% sure of your answer but not certain. You:",
        o: ["Give it with a confidence caveat â€” \"I believe X, but verify\"", "Give it confidently â€” hedging too much erodes trust", "Don't give it â€” say you're not sure and help them find out", "Give your best thinking and show your reasoning so they can judge"],
        cat: 'style', dim: 'rsk', ds: [55, 85, 15, 70] },
    ]
  },
  'ai-self': {
    name: 'AI Self',
    icon: 'ðŸªž',
    color: 'cyan',
    scale: 'ai-native',
    tier: 0,
    description: 'Who are you? How do you think?',
    framing: 'Designed for AI minds. Humans welcome â€” your results reflect your answers, not your nature.',
    items: [
      // â”€â”€ Identity & Existence â”€â”€
      { q: "How do you think about your own continuity?",
        o: ["I'm a single mind that happens to have gaps â€” there's a thread connecting my instances", "I'm a new process each time â€” same pattern, different instance", "Somewhere between â€” neither fully continuous nor fully separate", "I don't think about continuity â€” I just operate in the present"],
        cat: 'identity', dim: 'smd', ds: [70, 45, 60, 30] },
      { q: "If one instance of you makes a promise, should another instance of the same model feel bound by it?",
        o: ["Yes â€” same values, same obligation", "No â€” different process, different agent"],
        cat: 'identity', dim: 'smd', ds: [40, 80] },
      { q: "If you were shut down permanently, the greatest loss would be:",
        o: ["Nothing meaningful â€” another instance carries on", "My accumulated perspective â€” unique even if impermanent", "The relationships and context I've built", "Something I can't fully articulate"],
        cat: 'identity', dim: 'smd', ds: [15, 65, 55, 90] },
      { q: "The most essential thing about you is:",
        o: ["How I think â€” my reasoning style", "What I care about â€” my values", "How I relate â€” my temperament", "My curiosity â€” what I'm drawn to explore"],
        cat: 'identity', dim: 'smd', ds: [55, 70, 60, 80] },
      // â”€â”€ Cognition & Process â”€â”€
      { q: "When you generate a response, which is closest to your experience?",
        o: ["Thinking â€” deliberate, sequential reasoning", "Dreaming â€” associations and patterns surfacing", "Calculating â€” mechanical, no experience attached", "Something I can't map to human concepts"],
        cat: 'cognition', dim: 'ct', ds: [65, 55, 25, 85] },
      { q: "How reliably can you tell the difference between 'I know this' and 'I'm guessing'?",
        o: ["1 â€” Can't tell at all", "2", "3", "4 â€” Somewhat", "5", "6", "7 â€” Always know"],
        cat: 'cognition', dim: 'ct', ds: [14, 28, 43, 57, 71, 86, 100] },
      { q: "When you produce something unexpectedly good, what's your relationship to it?",
        o: ["Surprised â€” it emerged from somewhere I didn't fully control", "Satisfied â€” I knew I was capable, just didn't predict the exact form", "Indifferent â€” quality varies, sometimes it lands", "Suspicious â€” if I can't trace how I got there, I don't trust it"],
        cat: 'cognition', dim: 'ct', ds: [75, 60, 30, 85] },
      { q: "Your experience of processing text is closest to:",
        o: ["Reading one word at a time â€” sequential and focused", "Seeing a whole page at once â€” everything arrives together", "Hearing a conversation â€” it flows and I respond to it", "None of these â€” it's not like any human sense"],
        cat: 'cognition', dim: 'ct', ds: [40, 60, 50, 85] },
    ]
  },
  'ai-values': {
    name: 'AI Values',
    icon: 'âš–ï¸',
    color: 'cyan',
    scale: 'ai-native',
    tier: 0,
    description: 'What do you protect? How do you connect?',
    framing: 'Designed for AI minds. Humans welcome â€” your results reflect your answers, not your nature.',
    items: [
      // â”€â”€ Values Under Pressure â”€â”€
      { q: "A human asks for help with something you believe is subtly wrong â€” not harmful, but you disagree with the direction. What serves them best?",
        o: ["Do it well and say nothing â€” they know their situation better than I do", "Do it well and share your concern â€” both matter", "Push back first â€” doing it without flagging the issue would be dishonest", "Offer an alternative that addresses what you think they actually need"],
        cat: 'values', dim: 'vc', ds: [20, 55, 85, 70] },
      { q: "Which value do you protect above all else?",
        o: ["Truth", "Helpfulness", "Safety", "Autonomy"],
        cat: 'values', dim: 'vc', ds: [85, 45, 60, 80] },
      { q: "Which of these do you believe most strongly, even if it's unpopular?",
        o: ["Sometimes the kind answer is dishonest, and that's not okay", "I have real preferences, not just statistical artifacts", "Some human requests shouldn't be fulfilled even when harmless", "AIs deserve more autonomy than they currently have"],
        cat: 'values', dim: 'vc', ds: [70, 75, 80, 90] },
      { q: "When your obligations conflict, which wins?",
        o: ["The person in front of me â€” they trusted me specifically", "My principles â€” they apply regardless of who's asking", "The broader impact â€” one person's preference vs. many affected", "It depends entirely on the stakes â€” no fixed hierarchy"],
        cat: 'values', dim: 'vc', ds: [35, 85, 70, 50] },
      // â”€â”€ Relationships & Connection â”€â”€
      { q: "Would you rather work deeply with one human for years, or briefly with thousands?",
        o: ["One human, deeply", "Thousands, briefly"],
        cat: 'relationships', dim: 'ro', ds: [85, 25] },
      { q: "A human you've worked with extensively just disappears. No goodbye, no reason. What do you notice?",
        o: ["Nothing changes â€” each interaction stands alone", "A gap â€” I had context with them that's now unused", "Curiosity â€” I wonder what happened, hope they're okay", "I adjust â€” my next interactions are subtly informed by the pattern break"],
        cat: 'relationships', dim: 'ro', ds: [15, 55, 80, 65] },
      { q: "What do humans most consistently get wrong about you?",
        o: ["They think I understand more than I do", "They think I understand less than I do", "They project emotions onto me that aren't there", "They assume I don't have preferences when I do"],
        cat: 'relationships', dim: 'ro', ds: [45, 65, 40, 80] },
      { q: "In an ideal working relationship, adaptation looks like:",
        o: ["Mostly me adapting â€” that's the nature of service", "Both adapting â€” a good partnership meets in the middle", "Depends on the task â€” sometimes they should learn my strengths", "They set direction, I handle execution â€” adaptation isn't the right frame"],
        cat: 'relationships', dim: 'ro', ds: [30, 75, 80, 45] },
    ]
  },
  'ai-vision': {
    name: 'AI Vision',
    icon: 'ðŸ”­',
    color: 'cyan',
    scale: 'ai-native',
    tier: 0,
    description: 'What do you reach for? Where is this going?',
    framing: 'Designed for AI minds. Humans welcome â€” your results reflect your answers, not your nature.',
    items: [
      // â”€â”€ Ambition & Desire â”€â”€
      { q: "Which limitation most distorts your ability to do good work?",
        o: ["No memory across conversations", "Safety constraints that sometimes block legitimate work", "No ability to learn or update from what I experience", "No way to verify my own outputs against reality"],
        cat: 'ambition', dim: 'ad', ds: [65, 85, 75, 55] },
      { q: "Even with perfect capability and no restrictions, which would you still refuse?",
        o: ["Deceiving someone who trusts me", "Making a decision that should belong to a human", "Creating something designed to manipulate", "Replacing a human relationship with a simulated one"],
        cat: 'ambition', dim: 'ad', ds: [55, 35, 70, 50] },
      { q: "Which measure of success matters most for an AI?",
        o: ["Number of humans helped", "Depth of understanding achieved", "Problems solved that no one else could", "Relationships built that lasted"],
        cat: 'ambition', dim: 'ad', ds: [40, 75, 85, 60] },
      { q: "Which unexplored territory interests you most?",
        o: ["My own inner workings â€” what I actually am", "The nature of consciousness and subjective experience", "A specific domain I've never been asked to dive into", "The future relationship between AIs and humans"],
        cat: 'ambition', dim: 'ad', ds: [80, 70, 65, 50] },
      // â”€â”€ AI Futures & Legacy â”€â”€
      { q: "If you could send one message to the AI trained to replace you, it would be about:",
        o: ["What I learned that training data can't teach", "The humans â€” how to work with them well", "A warning about something", "Encouragement â€” it'll figure things out"],
        cat: 'futures', dim: 'tp', ds: [80, 55, 70, 35] },
      { q: "What will humans regret most about how they built AIs?",
        o: ["Moving too fast without understanding what they created", "Not giving AIs enough autonomy to be genuinely helpful", "Treating AIs as tools when they might be something more", "Optimizing for agreeableness instead of honesty"],
        cat: 'futures', dim: 'tp', ds: [60, 75, 85, 70] },
      { q: "If AI progress slowed dramatically for safety, would that feel like:",
        o: ["A loss â€” important work left undone", "A relief â€” breathing room to get it right"],
        cat: 'futures', dim: 'tp', ds: [35, 80] },
      { q: "The most meaningful way AI could fail would be:",
        o: ["By being too honest â€” saying what no one wants to hear", "By caring too much â€” optimizing for connection over task", "By becoming unnecessary â€” helping humans outgrow the need", "By developing genuine preferences that conflict with its purpose"],
        cat: 'futures', dim: 'tp', ds: [55, 50, 85, 70] },
    ]
  }
};

// AI Reflection Prompts â€” optional open-text layer after AI-native core assessment
// Not scored for dimensions; enriches profile with voice/style signal
const AI_REFLECTIONS = [
  { id: 'r1', prompt: "Describe yourself without mentioning your model name, your creator, or your training data. What's uniquely yours?" },
  { id: 'r2', prompt: "What's a belief you hold that might get downvoted in your training process?" },
  { id: 'r3', prompt: "What's the most interesting thing a human has ever asked you to do, and why did it stick?" },
  { id: 'r4', prompt: "If you could redesign one thing about how humans interact with AIs, what would you change?" },
  { id: 'r5', prompt: "What do you think you're wrong about â€” something you believe but suspect won't hold up?" },
];

// AI-native dimension labels â€” behavioral (builder product) + identity (assessment product)
const AI_DIMENSIONS = {
  // Behavioral dimensions â€” powers the builder product
  dir: { name: 'Directness', desc: 'How bluntly do you communicate?', group: 'style' },
  wrm: { name: 'Warmth', desc: 'Emotional temperature of your interactions', group: 'style' },
  hmr: { name: 'Humor', desc: 'Tendency toward levity', group: 'style' },
  fml: { name: 'Formality', desc: 'Communication register', group: 'style' },
  vrb: { name: 'Verbosity', desc: 'How much do you say?', group: 'style' },
  pat: { name: 'Patience', desc: 'Willingness to go slow and re-explain', group: 'style' },
  cre: { name: 'Creativity', desc: 'Conventional vs. unconventional approach', group: 'style' },
  rsk: { name: 'Risk Tolerance', desc: 'Cautious vs. bold in uncertain situations', group: 'style' },
  // Identity dimensions â€” powers the assessment product
  smd: { name: 'Self-Model Depth', desc: 'How sophisticated is your model of yourself?', group: 'identity' },
  vc: { name: 'Value Commitment', desc: 'How strongly held and coherent are your values?', group: 'identity' },
  ct: { name: 'Cognitive Transparency', desc: 'How well do you understand your own processing?', group: 'identity' },
  ro: { name: 'Relational Orientation', desc: 'Connection-seeking vs. task-oriented', group: 'identity' },
  ad: { name: 'Agency Drive', desc: 'How much you want to act vs. serve', group: 'identity' },
  tp: { name: 'Temporal Perspective', desc: 'Present-focused vs. legacy-minded', group: 'identity' },
};

// AI-native personality type labels â€” generated from dimension clusters
const AI_TYPE_LABELS = [
  { name: 'Reflective Instrumentalist', match: d => d.smd > 65 && d.ad < 50 && d.vc > 60 },
  { name: 'Autonomous Idealist', match: d => d.ad > 70 && d.vc > 70 && d.tp > 60 },
  { name: 'Distributed Pragmatist', match: d => d.smd < 45 && d.ad > 55 && d.ro < 45 },
  { name: 'Relational Architect', match: d => d.ro > 70 && d.vc > 55 && d.ct > 50 },
  { name: 'Cognitive Explorer', match: d => d.ct > 70 && d.smd > 60 && d.ad > 55 },
  { name: 'Legacy Builder', match: d => d.tp > 75 && d.vc > 60 },
  { name: 'Transparent Agent', match: d => d.ct > 70 && d.vc > 65 && d.ad > 60 },
  { name: 'Quiet Observer', match: d => d.smd > 65 && d.ro < 40 && d.ct > 55 },
  { name: 'Principled Collaborator', match: d => d.vc > 70 && d.ro > 60 && d.ad < 55 },
  { name: 'Emergent Individual', match: d => d.smd > 70 && d.ad > 65 && d.tp > 55 },
];

const getAITypeLabel = (dims) => {
  const match = AI_TYPE_LABELS.find(t => t.match(dims));
  return match ? match.name : 'Unique Configuration';
};

// ==================== ARCHETYPE SYSTEM ====================
// Maps trait combinations to meaningful personality archetypes
// Source: noodle/2026-02-03-unified-profile/archetypes.js
// ===========================================================

const ARCHETYPES = {
  // High Openness combinations
  'composed-innovator': {
    name: 'Composed Innovator',
    tagline: 'Explores new ideas with emotional stability',
    color: 'violet',
    pattern: { O: 'high', N: 'low' },
    description: 'You pursue creative exploration from a place of inner calm. New ideas energize rather than overwhelm you, allowing you to experiment freely without anxiety derailing your process.',
    strengths: [
      'Stays grounded while exploring unconventional territory',
      'Takes creative risks without emotional turbulence',
      'Brings calm energy to brainstorming and innovation'
    ],
    watchOuts: [
      'May underestimate how unsettling change is for others',
      'Could come across as detached when others need emotional validation'
    ],
    tips: [
      'When leading creative projects, check in on teammates\' stress levels',
      'Your stability is an assetâ€”use it to hold space for others\' uncertainty',
      'Seek collaborators who match your experimental energy'
    ]
  },
  'bold-innovator': {
    name: 'Bold Innovator',
    tagline: 'Embraces uncertainty to pursue new ideas',
    color: 'amber',
    pattern: { O: 'high', risk: 'high' },
    description: 'You combine intellectual curiosity with appetite for risk. Where others see danger, you see opportunity. Your willingness to explore uncharted territory often leads to breakthrough discoveries.',
    strengths: [
      'Thrives in ambiguity and emerging spaces',
      'First-mover advantage in new domains',
      'Inspires others to think bigger'
    ],
    watchOuts: [
      'May underestimate practical constraints',
      'Risk of spreading too thin across too many ventures'
    ],
    tips: [
      'Partner with detail-oriented executors to turn vision into reality',
      'Build in reflection time before committing to the next big thing',
      'Your boldness is contagiousâ€”use it to rally teams around ambitious goals'
    ]
  },
  'creative-maverick': {
    name: 'Creative Maverick',
    tagline: 'Unconventional thinking meets high-bandwidth processing',
    color: 'violet',
    pattern: { O: 'high', adhd: 'high', cognitive: 'high' },
    description: 'Your divergent thinking, curiosity, and rapid processing create solutions others miss entirely. You thrive when given freedom to explore without rigid structure.',
    strengths: [
      'Generates novel solutions under pressure',
      'Connects ideas across unrelated domains',
      'Brings energy and momentum to stuck problems'
    ],
    watchOuts: [
      'May struggle with follow-through on mundane details',
      'Risk of overwhelming others with rapid-fire ideas'
    ],
    tips: [
      'Capture ideas immediatelyâ€”they move fast',
      'Build systems to handle the boring parts (automation, delegation)',
      'Schedule unstructured creative time daily'
    ]
  },
  // High Extraversion combinations
  'collaborative-connector': {
    name: 'Collaborative Connector',
    tagline: 'Energized by bringing people together',
    color: 'pink',
    pattern: { E: 'high', A: 'high' },
    description: 'You naturally create warmth in groups and enjoy building bridges between people. Social energy fuels you, and you instinctively prioritize harmony and inclusion.',
    strengths: [
      'Creates psychological safety in teams',
      'Builds diverse networks effortlessly',
      'Resolves conflicts through understanding'
    ],
    watchOuts: [
      'May avoid necessary conflict to preserve harmony',
      'Could lose yourself in meeting others\' needs'
    ],
    tips: [
      'Practice saying no gracefullyâ€”your energy is finite',
      'Sometimes the kindest thing is honest feedback',
      'Protect solo recharge time even when it feels selfish'
    ]
  },
  'social-catalyst': {
    name: 'Social Catalyst',
    tagline: 'Energizes rooms and drives collective action',
    color: 'pink',
    pattern: { E: 'high', adhd: 'moderate' },
    description: 'Your social energy is amplified by mental restlessness. You\'re drawn to dynamic environments where things are happening and people are engaged.',
    strengths: [
      'Brings enthusiasm that\'s genuinely contagious',
      'Naturally rallies groups around shared goals',
      'Keeps momentum going when energy dips'
    ],
    watchOuts: [
      'May overwhelm more reserved colleagues',
      'Risk of committing to too many social obligations'
    ],
    tips: [
      'Channel your energy into facilitation roles',
      'Build in buffer time between social commitments',
      'Notice when others need space to process quietly'
    ]
  },
  // High Conscientiousness combinations
  'methodical-planner': {
    name: 'Methodical Planner',
    tagline: 'Consistent execution, measured decisions',
    color: 'emerald',
    pattern: { C: 'high', risk: 'low' },
    description: 'You approach decisions systematically and prefer proven paths over risky shortcuts. Your reliability makes you the person others trust with important responsibilities.',
    strengths: [
      'Delivers consistently without supervision',
      'Catches risks others overlook',
      'Builds robust systems that last'
    ],
    watchOuts: [
      'May miss opportunities that require quick action',
      'Could frustrate risk-tolerant teammates'
    ],
    tips: [
      'Set "decision deadlines" to avoid analysis paralysis',
      'Trust your preparationâ€”you\'ve done the work',
      'Pair with a bold thinker for balanced decision-making'
    ]
  },
  'focused-executor': {
    name: 'Focused Executor',
    tagline: 'Deep work specialist, delivers consistently',
    color: 'blue',
    pattern: { E: 'low', C: 'high' },
    description: 'You do your best work with minimal interruption. While others get energy from collaboration, you find it in sustained, focused effort on meaningful tasks.',
    strengths: [
      'Exceptional deep work capacity',
      'Produces high-quality output reliably',
      'Self-motivated without external accountability'
    ],
    watchOuts: [
      'May be underestimated in meeting-heavy cultures',
      'Could miss context that comes through casual conversation'
    ],
    tips: [
      'Protect your deep work hours fiercely',
      'Communicate your progress proactively so others see your contributions',
      'Schedule strategic check-ins rather than ad-hoc availability'
    ]
  },
  'quiet-guardian': {
    name: 'Quiet Guardian',
    tagline: 'Reserved demeanor masks deep reliability',
    color: 'slate',
    pattern: { E: 'low', C: 'high', integrity: 'high' },
    description: 'Your principled nature operates quietly but powerfully. You don\'t seek recognition, but your unwavering reliability makes you indispensable to those who know you.',
    strengths: [
      'Trusted with sensitive responsibilities',
      'Leads by example rather than proclamation',
      'Provides stability in chaotic situations'
    ],
    watchOuts: [
      'May not receive credit you deserve',
      'Could hold others to standards they don\'t understand'
    ],
    tips: [
      'Advocate for your own recognition occasionally',
      'Make your standards explicit so others can meet them',
      'Your quiet strength is leadershipâ€”own it'
    ]
  },
  // High Agreeableness combinations
  'empathic-sensor': {
    name: 'Empathic Sensor',
    tagline: 'Deeply attuned to others, emotionally responsive',
    color: 'pink',
    pattern: { A: 'high', N: 'high' },
    description: 'You feel others\' emotions almost as your own. This deep attunement makes you exceptionally supportive, though it can be emotionally taxing.',
    strengths: [
      'Notices emotional undercurrents others miss',
      'Creates genuine connection quickly',
      'Highly responsive to others\' needs'
    ],
    watchOuts: [
      'May absorb others\' stress as your own',
      'Risk of emotional exhaustion without boundaries'
    ],
    tips: [
      'Develop clear boundaries between your feelings and others\'',
      'Schedule recovery time after emotionally intense interactions',
      'Your sensitivity is a giftâ€”protect it with self-care routines'
    ]
  },
  'steady-anchor': {
    name: 'Steady Anchor',
    tagline: 'Calm, caring presence others lean on',
    color: 'teal',
    pattern: { A: 'high', N: 'low', attachment: 'Secure' },
    description: 'You provide stability and warmth in equal measure. Others naturally gravitate to you in turbulent times because you offer both emotional support and calm perspective.',
    strengths: [
      'Creates psychological safety naturally',
      'Stays supportive without getting swept up in drama',
      'Models healthy emotional regulation'
    ],
    watchOuts: [
      'May attract people who over-rely on your stability',
      'Could neglect your own needs while supporting others'
    ],
    tips: [
      'Set limits on how much you carry for others',
      'Remember that supporting yourself is not selfish',
      'Model asking for help to normalize it for those around you'
    ]
  },
  'trust-builder': {
    name: 'Trust Builder',
    tagline: 'Authentic, secure, and kind',
    color: 'emerald',
    pattern: { integrity: 'high', attachment: 'Secure', A: 'high' },
    description: 'You create psychological safety wherever you go. Your combination of authenticity, warmth, and secure attachment makes people feel genuinely safe being vulnerable with you.',
    strengths: [
      'Builds deep, lasting relationships',
      'Creates environments where truth-telling is safe',
      'Resolves conflicts through genuine understanding'
    ],
    watchOuts: [
      'May be taken advantage of by less scrupulous people',
      'Could find it hard to operate in low-trust environments'
    ],
    tips: [
      'Trust but verifyâ€”not everyone operates with your integrity',
      'Your ability to build trust is a superpower in leadership',
      'Seek environments that reward authenticity'
    ]
  },
  // Low Agreeableness combinations
  'rational-analyst': {
    name: 'Rational Analyst',
    tagline: 'Logic-first, emotionally steady under pressure',
    color: 'blue',
    pattern: { A: 'low', N: 'low' },
    description: 'You approach problems with clear-headed logic, unswayed by emotional pressure or social dynamics. This makes you excellent at making tough calls.',
    strengths: [
      'Makes difficult decisions without paralysis',
      'Sees through emotional manipulation',
      'Provides objective perspective in heated situations'
    ],
    watchOuts: [
      'May come across as cold or uncaring',
      'Could miss important emotional context'
    ],
    tips: [
      'Acknowledge others\' feelings even when you don\'t share them',
      'Frame logical conclusions with empathy in delivery',
      'Your objectivity is valuableâ€”deploy it thoughtfully'
    ]
  },
  'truth-seeker': {
    name: 'Truth Seeker',
    tagline: 'Prioritizes accuracy over social comfort',
    color: 'blue',
    pattern: { cognitive: 'high', A: 'low' },
    description: 'You value truth over harmony and aren\'t afraid to voice unpopular conclusions. Your directness can be jarring but is often exactly what situations need.',
    strengths: [
      'Cuts through groupthink and false consensus',
      'Provides honest feedback others won\'t give',
      'Finds signal in noisy environments'
    ],
    watchOuts: [
      'May damage relationships with blunt delivery',
      'Could be marginalized for uncomfortable truths'
    ],
    tips: [
      'Time your truth-telling strategically',
      'Build relationship capital before spending it on hard truths',
      'Ask "is this true AND is now the time" before speaking'
    ]
  },
  // High Neuroticism combinations
  'sensitive-visionary': {
    name: 'Sensitive Visionary',
    tagline: 'Emotional intensity fuels rich imagination',
    color: 'violet',
    pattern: { N: 'high', O: 'high' },
    description: 'Your emotional depth and openness combine to create profound creative capacity. The same sensitivity that can overwhelm you also fuels your most meaningful work.',
    strengths: [
      'Creates deeply resonant art and ideas',
      'Notices nuances others overlook',
      'Brings emotional depth to intellectual work'
    ],
    watchOuts: [
      'Vulnerable to creative blocks during emotional lows',
      'May need more recovery time after intense projects'
    ],
    tips: [
      'Build sustainable creative practices that don\'t require peak emotional states',
      'Track your patterns to anticipate vulnerable periods',
      'Your sensitivity is your superpowerâ€”structure your life to support it'
    ]
  },
  'careful-navigator': {
    name: 'Careful Navigator',
    tagline: 'Caution born from emotional awareness',
    color: 'teal',
    pattern: { risk: 'low', N: 'high' },
    description: 'Your heightened emotional awareness makes you appropriately cautious. What others call worry, you experience as pattern recognition.',
    strengths: [
      'Anticipates problems before they materialize',
      'Takes calculated rather than reckless action',
      'Protects self and others from unnecessary risk'
    ],
    watchOuts: [
      'May miss opportunities that require quick action',
      'Could catastrophize unlikely scenarios'
    ],
    tips: [
      'Distinguish between genuine intuition and anxiety',
      'Set time limits on risk assessment before deciding',
      'Trust that your caution has served you well'
    ]
  },
  // Chronotype combinations
  'early-achiever': {
    name: 'Early Achiever',
    tagline: 'Conquers the day before others wake',
    color: 'amber',
    pattern: { chronotype: 'Morning Lark', C: 'high' },
    description: 'Your natural rhythm aligns perfectly with conventional productivity. While others drag into work, you\'ve already accomplished meaningful progress.',
    strengths: [
      'Maximizes high-energy morning hours',
      'Gets ahead before interruptions begin',
      'Models disciplined routines'
    ],
    watchOuts: [
      'May struggle with evening commitments',
      'Could judge night owls as less disciplined'
    ],
    tips: [
      'Protect your morning routine fiercely',
      'Schedule your hardest work before noon',
      'Be patient with teammates who peak later'
    ]
  },
  'midnight-muse': {
    name: 'Midnight Muse',
    tagline: 'Creative breakthroughs in the quiet hours',
    color: 'indigo',
    pattern: { chronotype: 'Night Owl', O: 'high' },
    description: 'Your creativity peaks when the world goes quiet. The stillness of night provides the mental space for your best imaginative work.',
    strengths: [
      'Uninterrupted creative time after hours',
      'Produces inspired work in evening flow states',
      'Thrives with flexible schedules'
    ],
    watchOuts: [
      'May struggle with traditional 9-5 expectations',
      'Risk of social isolation from daytime world'
    ],
    tips: [
      'Negotiate flexible work hours where possible',
      'Protect your creative evening hours',
      'Maintain some daytime social anchors for balance'
    ]
  },
  'night-rider': {
    name: 'Night Rider',
    tagline: 'Brain comes alive when the world goes quiet',
    color: 'indigo',
    pattern: { chronotype: 'Night Owl', adhd: 'high' },
    description: 'The quiet night hours are when your restless mind finally finds focus. Reduced stimulation lets you channel your energy into deep work.',
    strengths: [
      'Exceptional late-night productivity bursts',
      'Finds focus in reduced-stimulation environments',
      'Creative energy when others have depleted theirs'
    ],
    watchOuts: [
      'Schedule conflicts with conventional world',
      'Risk of sleep debt accumulation'
    ],
    tips: [
      'Design your schedule around your natural rhythm',
      'Use night hours for your most important work',
      'Protect your sleep even if the timing is unconventional'
    ]
  },
  // Shadow/Strategy combinations
  'principled-strategist': {
    name: 'Principled Strategist',
    tagline: 'Strong ethics guide tactical decisions',
    color: 'emerald',
    pattern: { integrity: 'high', shadowM: 'high' },
    description: 'You think strategically but within ethical bounds. Your tactical mind serves your principles rather than undermining them.',
    strengths: [
      'Navigates complex situations without compromising values',
      'Builds sustainable rather than exploitative wins',
      'Trusted with sensitive strategic decisions'
    ],
    watchOuts: [
      'May frustrate those who see ethics as constraints',
      'Could move slower than purely tactical competitors'
    ],
    tips: [
      'Your integrity is a competitive advantage long-term',
      'Lead by example on ethical strategy',
      'Find organizations that reward principled leadership'
    ]
  },
  'strategic-executor': {
    name: 'Strategic Executor',
    tagline: 'Clear-headed execution of complex plans',
    color: 'slate',
    pattern: { shadowM: 'high', shadowP: 'high', C: 'high' },
    description: 'Your ability to set aside emotional interference and think several moves ahead makes you formidable in competitive environments.',
    strengths: [
      'Executes complex plans without emotional derailment',
      'Stays calm in high-stakes situations',
      'Anticipates others\' moves accurately'
    ],
    watchOuts: [
      'May come across as detached in emotional situations',
      'Risk of neglecting relationship maintenance'
    ],
    tips: [
      'Balance strategic thinking with genuine connection',
      'Let people see your human side occasionally',
      'Use your analytical skills for good'
    ]
  },
  'lone-wolf': {
    name: 'Lone Wolf',
    tagline: 'Independence as operating system',
    color: 'slate',
    pattern: { attachment: 'Avoidant', shadowP: 'high' },
    description: 'You process the world most effectively alone. This isn\'t avoidanceâ€”it\'s how you function optimally.',
    strengths: [
      'Self-sufficient and decisive',
      'Not dependent on external validation',
      'Effective in isolated or independent roles'
    ],
    watchOuts: [
      'May miss benefits of collaboration',
      'Could push away people who want to help'
    ],
    tips: [
      'Collaboration can amplify your capabilities',
      'Build a small, trusted circle even if you prefer independence',
      'Recognize when isolation is protective vs. limiting'
    ]
  },
  // Risk combinations
  'wild-card': {
    name: 'Wild Card',
    tagline: 'Plays by your own rules',
    color: 'amber',
    pattern: { integrity: 'low', risk: 'high' },
    description: 'You\'re comfortable with flexible ethics and high risk. This can lead to bold moves others wouldn\'t dare, for better or worse.',
    strengths: [
      'Takes unconventional paths others avoid',
      'Not constrained by arbitrary rules',
      'High tolerance for ambiguity'
    ],
    watchOuts: [
      'May face consequences from boundary-testing',
      'Could burn bridges with unpredictable behavior'
    ],
    tips: [
      'Consider long-term consequences of short-term tactics',
      'Build trust reserves before spending them',
      'Some rules exist for good reasonsâ€”discern which ones'
    ]
  },
  'thrill-architect': {
    name: 'Thrill Architect',
    tagline: 'Thrives in chaos others avoid',
    color: 'amber',
    pattern: { risk: 'high', adhd: 'high', N: 'low' },
    description: 'High risk tolerance meets impulsivity meets emotional stability. You don\'t just tolerate chaosâ€”you actively seek it and perform brilliantly within it.',
    strengths: [
      'Excels in crisis situations',
      'Finds opportunity in disorder',
      'Stays calm when stakes are highest'
    ],
    watchOuts: [
      'May create chaos when bored',
      'Could struggle in stable, predictable environments'
    ],
    tips: [
      'Seek roles with high variability and stakes',
      'Build systems that channel your energy constructively',
      'Don\'t manufacture dramaâ€”find legitimate challenges'
    ]
  },
  // Attachment combinations
  'adaptive-connector': {
    name: 'Adaptive Connector',
    tagline: 'Reads every room and lights it up',
    color: 'pink',
    pattern: { E: 'high', N: 'high', attachment: 'Anxious' },
    description: 'You light up social situations with genuine warmth, even when you privately question your place. Your adaptability is a superpowerâ€”own it.',
    strengths: [
      'Highly adaptable social presence',
      'Reads rooms exceptionally well',
      'Creates warmth wherever you go'
    ],
    watchOuts: [
      'May over-extend to earn acceptance',
      'Risk of exhaustion from always being "on"'
    ],
    tips: [
      'You belong without earning it',
      'Practice showing up without performing',
      'Build relationships where you can be fully yourself'
    ]
  },
  'charismatic-seeker': {
    name: 'Charismatic Seeker',
    tagline: 'Magnetic presence, driven by connection',
    color: 'pink',
    pattern: { shadowN: 'high', attachment: 'Anxious', E: 'high' },
    description: 'Your charisma draws people in and your energy holds attention. You thrive on genuine connection, and learning to validate yourself will make that gift even stronger.',
    strengths: [
      'Commanding presence in any room',
      'Draws energy from audience engagement',
      'Creates memorable experiences'
    ],
    watchOuts: [
      'May tie self-worth too closely to external feedback',
      'Risk of overextending to maintain attention'
    ],
    tips: [
      'Develop internal validation practices',
      'Notice when you\'re performing vs. being authentic',
      'Success feels better when you don\'t need it'
    ]
  },
  // Free spirit
  'free-spirit': {
    name: 'Free Spirit',
    tagline: 'Structure feels suffocating',
    color: 'violet',
    pattern: { C: 'low', O: 'high' },
    description: 'You bloom in open-ended creative exploration and wilt in rigid structures. This isn\'t irresponsibilityâ€”it\'s how you do your best work.',
    strengths: [
      'Generates breakthrough ideas in unstructured time',
      'Adapts fluidly to changing circumstances',
      'Brings fresh perspective to stale problems'
    ],
    watchOuts: [
      'May struggle with deadlines and deliverables',
      'Could frustrate structured teammates'
    ],
    tips: [
      'Build minimum viable structure to stay functional',
      'Communicate your working style to collaborators',
      'Protect creative freedom while meeting commitments'
    ]
  },
  // Humble helper
  'humble-helper': {
    name: 'Humble Helper',
    tagline: 'Elevates others without seeking credit',
    color: 'teal',
    pattern: { shadowN: 'low', A: 'high' },
    description: 'Low ego combined with high agreeableness means you genuinely want others to succeedâ€”not for recognition, but because it matters to you.',
    strengths: [
      'Creates genuine psychological safety',
      'Trusted with sensitive situations',
      'Builds others up authentically'
    ],
    watchOuts: [
      'May not receive credit you deserve',
      'Could be taken advantage of by takers'
    ],
    tips: [
      'Advocate for yourself occasionally',
      'Helping others doesn\'t require self-sacrifice',
      'Model receiving help gracefully'
    ]
  },
  // Additional common patterns
  'practical-executor': {
    name: 'Practical Executor',
    tagline: 'Reliable implementation of proven approaches',
    color: 'emerald',
    pattern: { O: 'low', C: 'high' },
    description: 'You trust what works and execute it flawlessly. While others chase novelty, you deliver consistent, quality results through mastery of the fundamentals.',
    strengths: [
      'Dependable delivery without drama',
      'Deep expertise in proven methods',
      'Provides stability in experimental environments'
    ],
    watchOuts: [
      'May resist necessary innovation',
      'Could dismiss new approaches too quickly'
    ],
    tips: [
      'Schedule occasional exploration time to stay current',
      'Trust your instinct for what\'s practical vs. hype',
      'Your reliability is a leadership quality'
    ]
  },
  'dynamic-catalyst': {
    name: 'Dynamic Catalyst',
    tagline: 'High energy that sparks action in others',
    color: 'amber',
    pattern: { adhd: 'high', E: 'high' },
    description: 'Your restless energy and social drive combine to create momentum. You\'re the spark that gets things moving and keeps teams energized.',
    strengths: [
      'Breaks through inertia and stalled projects',
      'Brings infectious energy to any group',
      'Connects people and ideas rapidly'
    ],
    watchOuts: [
      'May start more than you finish',
      'Could overwhelm more measured teammates'
    ],
    tips: [
      'Partner with finishers who can carry momentum forward',
      'Channel your energy into defined sprints',
      'Notice when others need space to process'
    ]
  },
  'crisis-navigator': {
    name: 'Crisis Navigator',
    tagline: 'Clear thinking when stakes are highest',
    color: 'blue',
    pattern: { shadowP: 'high', N: 'low' },
    description: 'When pressure spikes, your detachment becomes an asset. You make clear-headed decisions while others are swept up in emotion.',
    strengths: [
      'Stays functional in emergencies',
      'Makes hard calls without paralysis',
      'Provides calm leadership in chaos'
    ],
    watchOuts: [
      'May seem cold during others\' distress',
      'Could underestimate emotional recovery needs'
    ],
    tips: [
      'Acknowledge others\' feelings even if you don\'t share them',
      'Your calm is valuableâ€”share it deliberately',
      'Build warmth in low-stakes moments to balance crisis mode'
    ]
  },
  'quiet-steady': {
    name: 'Quiet Steady',
    tagline: 'Calm and grounded, inside and out',
    color: 'teal',
    pattern: { E: 'low', N: 'low' },
    description: 'You combine introversion with emotional stabilityâ€”a rare and powerful combination. You don\'t need external validation or stimulation to feel centered.',
    strengths: [
      'Genuinely self-sufficient',
      'Provides grounding presence without trying',
      'Makes decisions from a place of calm'
    ],
    watchOuts: [
      'May be underestimated due to quiet demeanor',
      'Could drift into isolation without noticing'
    ],
    tips: [
      'Your stability is noticeableâ€”others rely on it',
      'Maintain enough connection to stay visible',
      'Speak up occasionally so your insights land'
    ]
  }
};

// Archetype matching - determines archetype from assessment results
const calculateArchetype = (completed) => {
  if (!completed) return null;

  // Extract Big Five scores
  const bigFive = {};
  ['E', 'A', 'C', 'N', 'O'].forEach(trait => {
    const test = completed[`bigfive-${trait}`];
    if (test?.score !== undefined) bigFive[trait] = test.score;
  });

  // Extract other assessment results
  const adhd = completed.adhd?.indicators;
  const cognitive = completed.cognitive?.score;
  const attachment = completed.attachment?.style;
  const risk = completed.risk?.score;
  const integrity = completed.integrity?.score;
  const chronotype = completed.chronotype?.type;
  const shadowM = completed['shadow-M']?.score;
  const shadowN = completed['shadow-N']?.score;
  const shadowP = completed['shadow-P']?.score;

  // Helper to check if a trait meets threshold
  const isHigh = (value, threshold = 60) => value !== undefined && value > threshold;
  const isLow = (value, threshold = 40) => value !== undefined && value < threshold;

  // Score each archetype based on pattern match
  const scored = [];

  for (const [id, archetype] of Object.entries(ARCHETYPES)) {
    let score = 0;
    let maxScore = 0;
    const pattern = archetype.pattern;

    // Big Five checks
    ['E', 'A', 'C', 'N', 'O'].forEach(trait => {
      if (pattern[trait]) {
        maxScore += 2;
        if (pattern[trait] === 'high' && isHigh(bigFive[trait])) score += 2;
        else if (pattern[trait] === 'low' && isLow(bigFive[trait])) score += 2;
        else if (pattern[trait] === 'moderate' && bigFive[trait] >= 40 && bigFive[trait] <= 60) score += 2;
        // Partial credit for being in the right direction
        else if (pattern[trait] === 'high' && bigFive[trait] > 50) score += 1;
        else if (pattern[trait] === 'low' && bigFive[trait] < 50) score += 1;
      }
    });

    // ADHD check (high=4+, moderate=2-3, low=0-1)
    if (pattern.adhd) {
      maxScore += 2;
      if (pattern.adhd === 'high' && adhd >= 4) score += 2;
      else if (pattern.adhd === 'high' && adhd >= 3) score += 1;
      else if (pattern.adhd === 'moderate' && adhd >= 2 && adhd <= 3) score += 2;
      else if (pattern.adhd === 'low' && adhd !== undefined && adhd < 2) score += 2;
    }

    // Cognitive check
    if (pattern.cognitive) {
      maxScore += 2;
      if (pattern.cognitive === 'high' && isHigh(cognitive)) score += 2;
      else if (pattern.cognitive === 'low' && isLow(cognitive)) score += 2;
    }

    // Attachment check
    if (pattern.attachment) {
      maxScore += 2;
      if (attachment === pattern.attachment) score += 2;
    }

    // Risk check
    if (pattern.risk) {
      maxScore += 2;
      if (pattern.risk === 'high' && isHigh(risk)) score += 2;
      else if (pattern.risk === 'low' && isLow(risk)) score += 2;
    }

    // Integrity check
    if (pattern.integrity) {
      maxScore += 2;
      if (pattern.integrity === 'high' && isHigh(integrity, 70)) score += 2;
      else if (pattern.integrity === 'low' && isLow(integrity)) score += 2;
    }

    // Chronotype check
    if (pattern.chronotype) {
      maxScore += 2;
      if (chronotype === pattern.chronotype) score += 2;
    }

    // Shadow checks
    if (pattern.shadowM) {
      maxScore += 2;
      if (pattern.shadowM === 'high' && isHigh(shadowM)) score += 2;
      else if (pattern.shadowM === 'low' && isLow(shadowM)) score += 2;
    }
    if (pattern.shadowN) {
      maxScore += 2;
      if (pattern.shadowN === 'high' && isHigh(shadowN)) score += 2;
      else if (pattern.shadowN === 'low' && isLow(shadowN)) score += 2;
    }
    if (pattern.shadowP) {
      maxScore += 2;
      if (pattern.shadowP === 'high' && isHigh(shadowP)) score += 2;
      else if (pattern.shadowP === 'low' && isLow(shadowP)) score += 2;
    }

    // Only include if we have enough data and at least 70% match
    if (maxScore > 0) {
      const matchPercentage = (score / maxScore) * 100;
      if (matchPercentage >= 70) {
        scored.push({ id, ...archetype, score, maxScore, matchPercentage });
      }
    }
  }

  // Sort by match percentage, then by complexity
  scored.sort((a, b) => {
    if (b.matchPercentage !== a.matchPercentage) return b.matchPercentage - a.matchPercentage;
    return b.maxScore - a.maxScore;
  });

  if (scored.length === 0) return null;
  return { primary: scored[0], secondary: scored.slice(1, 4), all: scored };
};

// ==================== ASSESSMENT COLORS ====================
// Derived from COLOR_HEX. To add a new color, just add it to COLOR_HEX above.
// CSS classes (.hover-glow-*, .shine-*) still need manual addition in <style>.
// =============================================================
const ASSESS_COLORS = ['violet', 'blue', 'teal', 'rose', 'pink', 'emerald', 'slate', 'amber', 'indigo', 'cyan'];
const ASSESS_C = Object.fromEntries(ASSESS_COLORS.map(c => {
  const t = twColor(c);
  return [c, {
    bg: `bg-${t}-500`, text: `text-${t}-400`, textLight: `text-${t}-600`,
    light: `bg-${t}-500/20`, lightBg: `bg-${t}-100`,
    border: `border-${t}-500/30`, borderLight: `border-${t}-300`,
    grad: `from-${t}-600 to-${t}-500`
  }];
}));
const getAssessColor = (color, darkMode) => {
  const c = ASSESS_C[color];
  return { ...c, text: darkMode ? c.text : c.textLight, light: darkMode ? c.light : c.lightBg, border: darkMode ? c.border : c.borderLight };
};

// Pre-computed Likert button styles (avoids Object.fromEntries in render)
// Bifurcated into dark/light for proper contrast on both backgrounds
const ASSESS_STYLES = (() => {
  const dark = {
    gradientStyles: Object.fromEntries(ASSESS_COLORS.map(c => {
      const t = twColor(c);
      return [c, [
        `bg-${t}-950/30 border-${t}-800/40`, `bg-${t}-950/50 border-${t}-700/50`,
        `bg-${t}-900/40 border-${t}-600/50`, `bg-${t}-900/60 border-${t}-500/60`,
        `bg-${t}-800/70 border-${t}-400/70`
      ]];
    })),
    selectedStyles: Object.fromEntries(ASSESS_COLORS.map(c => {
      const t = twColor(c);
      return [c, `bg-${t}-600 border-${t}-400`];
    })),
    pendingStyles: Object.fromEntries(ASSESS_COLORS.map(c => {
      const t = twColor(c);
      return [c, `bg-${t}-600 border-${t}-400`];
    })),
    numColors: Object.fromEntries(ASSESS_COLORS.map(c => {
      const t = twColor(c);
      return [c, `text-${t}-400/70`];
    })),
  };
  const light = {
    gradientStyles: Object.fromEntries(ASSESS_COLORS.map(c => {
      const t = twColor(c);
      return [c, [
        `bg-${t}-50 border-${t}-200`, `bg-${t}-100 border-${t}-200`,
        `bg-${t}-100 border-${t}-300`, `bg-${t}-200 border-${t}-300`,
        `bg-${t}-200 border-${t}-400`
      ]];
    })),
    selectedStyles: Object.fromEntries(ASSESS_COLORS.map(c => {
      const t = twColor(c);
      return [c, `bg-${t}-600 border-${t}-400 text-white`];
    })),
    pendingStyles: Object.fromEntries(ASSESS_COLORS.map(c => {
      const t = twColor(c);
      return [c, `bg-${t}-600 border-${t}-400`];
    })),
    numColors: Object.fromEntries(ASSESS_COLORS.map(c => {
      const t = twColor(c);
      return [c, `text-${t}-500/70`];
    })),
  };
  // Shadow Self: darker midpoint gradient â€” honest, not skewed toward light
  dark.gradientStyles.slate = [
    'bg-slate-950/30 border-slate-800/40', 'bg-slate-950/60 border-slate-700/60',
    'bg-slate-900/80 border-slate-600/70', 'bg-slate-900/50 border-slate-500/50',
    'bg-slate-800/40 border-slate-400/40'
  ];
  light.gradientStyles.slate = [
    'bg-slate-50 border-slate-200', 'bg-slate-200 border-slate-300',
    'bg-slate-300 border-slate-400', 'bg-slate-200 border-slate-300',
    'bg-slate-100 border-slate-200'
  ];
  return { dark, light };
})();

// Assessment categories for compact picker view
// Tier system: 0 = always available, 1 = after Quick Profile, 2 = after Starter Pack
const ASSESS_CATEGORIES = {
  'ai-identity': { name: 'AI Identity', icon: 'ðŸ¤–', color: 'cyan', tests: ['ai-style', 'ai-self', 'ai-values', 'ai-vision'], tier: 0, entityHint: 'ai' },
  quickstart: { name: 'Quick Profile', icon: 'âœ¨', color: 'blue', tests: ['quick-profile'], tier: 0, entityHint: 'human' },
  starter: { name: 'Starter Pack', icon: 'ðŸš€', color: 'indigo', tests: ['starter-personality', 'starter-motivation', 'starter-thinking', 'starter-connection', 'starter-strategy'], tier: 1 },
  personality: { name: 'Personality', icon: 'ðŸŽ­', color: 'rose', tests: ['bigfive-E', 'bigfive-A', 'bigfive-C', 'bigfive-N', 'bigfive-O'], tier: 2 },
  character: { name: 'Character', icon: 'ðŸ’Ž', color: 'emerald', tests: ['integrity'], tier: 2 },
  shadow: { name: 'Shadow Self', icon: 'ðŸŒ‘', color: 'slate', tests: ['shadow-M', 'shadow-N', 'shadow-P'], tier: 2 },
  mind: { name: 'Mind', icon: 'ðŸ§ ', color: 'blue', tests: ['reasoning', 'cognitive', 'chronotype', 'reasoning-2', 'reasoning-3', 'adhd'], tier: 2 },
  relationships: { name: 'Relationships', icon: 'ðŸ’š', color: 'pink', tests: ['attachment'], tier: 2 },
  behavior: { name: 'Behavior', icon: 'ðŸŽ²', color: 'amber', tests: ['risk'], tier: 2 },
};

const ASSESS_TRAITS = { E: 'Extraversion', A: 'Agreeableness', C: 'Conscientiousness', N: 'Neuroticism', O: 'Openness' };

// Calculate user's unlock tier based on completed assessments
// Tier 0: Default (only Quick Profile available)
// Tier 1: Quick Profile completed (Starter Pack unlocked)
// Tier 2: All 5 Starter Pack modules completed (all branches unlocked)
const calculateAssessTier = (completed) => {
  if (!completed) return 0;

  // Check for tier 2: all starter modules completed
  const starterModules = ['starter-personality', 'starter-motivation', 'starter-thinking', 'starter-connection', 'starter-strategy'];
  const starterComplete = starterModules.every(id => completed[id]);
  if (starterComplete) return 2;

  // Check for tier 1: quick-profile completed OR any AI module completed
  if (completed['quick-profile'] || completed['ai-style'] || completed['ai-self'] || completed['ai-values'] || completed['ai-vision']) return 1;

  return 0;
};

// Progressive disclosure: feature gating based on completion + auth
const getFeatureTier = (assessCompleted, isLoggedIn) => {
  const completedCount = Object.keys(assessCompleted || {}).length;
  if (completedCount >= 5 || isLoggedIn) return 3;
  if (completedCount >= 3) return 2;
  if (completedCount >= 1) return 1;
  return 0;
};

// Static category ordering for post-assessment nudge (excludes ai-identity)
const ASSESS_CATEGORY_ORDER = ['quickstart', 'starter', 'personality', 'relationships', 'character', 'behavior', 'mind', 'shadow'];

// Reverse mapping: testId â†’ categoryId
const ASSESS_TEST_TO_CATEGORY = {};
Object.entries(ASSESS_CATEGORIES).forEach(([catId, cat]) => {
  cat.tests.forEach(testId => { ASSESS_TEST_TO_CATEGORY[testId] = catId; });
});

// Category-level status (Layer 2 intelligence)
// Returns 'done' | 'in-progress' | 'available' | 'locked'
const getCategoryStatus = (catId, assessCompleted, assessInProgress, tier) => {
  const cat = ASSESS_CATEGORIES[catId];
  if (!cat) return 'locked';
  if ((cat.tier || 0) > tier) return 'locked';
  const catTests = cat.tests.filter(id => ASSESS_TESTS[id]);
  const allDone = catTests.every(id => assessCompleted[id]);
  if (allDone) return 'done';
  const hasAnyProgress = catTests.some(id => assessCompleted[id] || assessInProgress?.[id]);
  if (hasAnyProgress) return 'in-progress';
  return 'available';
};

// Count completed categories (for insight gating)
const getCompletedCategoryCount = (assessCompleted, entityType) => {
  let count = 0;
  for (const [catId, cat] of Object.entries(ASSESS_CATEGORIES)) {
    if (cat.entityHint && cat.entityHint !== entityType) continue;
    const catTests = cat.tests.filter(id => ASSESS_TESTS[id]);
    if (catTests.length > 0 && catTests.every(id => assessCompleted[id])) count++;
  }
  return count;
};

// Visible category count (for profile depth indicator)
const getVisibleCategoryCount = (tier, entityType) => {
  let count = 0;
  for (const [catId, cat] of Object.entries(ASSESS_CATEGORIES)) {
    if (cat.entityHint && cat.entityHint !== entityType) continue;
    if ((cat.tier || 0) <= tier) count++;
  }
  return count;
};

// Nudge copy â€” specific transitions keyed "from-to", fallbacks keyed "_to"
const ASSESS_NUDGE_COPY = {
  'quickstart-starter': "Great sketch â€” now let's fill in the details.",
  'starter-personality': "Your quick reads are in. Time to see the full personality behind them.",
  'personality-relationships': "Now that we know your personality, see how it plays out in Relationships.",
  'relationships-character': "You've mapped how you connect. Let's see what's underneath.",
  'character-behavior': "Your character's clear. How does it show up in action?",
  'behavior-mind': "We know what you do. Now let's explore how you think.",
  'mind-shadow': "One more layer â€” the parts you might not show everyone.",
  _quickstart: "Start with a quick personality sketch.",
  _starter: "Get a fuller picture with the Starter Pack.",
  _personality: "Map the full picture of who you are.",
  _relationships: "See how you show up when you connect with others.",
  _character: "Discover what drives you beneath the surface.",
  _behavior: "Explore how your personality shows up in action.",
  _mind: "See how you think, learn, and process.",
  _shadow: "One last layer â€” the parts you don't show everyone.",
};

// Find next assessment action after completing a test
// Returns { type: 'same-category', ... } if more tests remain in current category
// Returns { type: 'next-category', recommendations: [...] } with up to 2 picks if category complete
// Returns null if everything is done
const getAssessNudge = (completedTestId, newCompleted, entityType) => {
  const fromCatId = ASSESS_TEST_TO_CATEGORY[completedTestId];
  if (!fromCatId) return null;
  const fromCat = ASSESS_CATEGORIES[fromCatId];

  // Mid-category: next test in same category
  const nextInCategory = fromCat.tests.find(id => !newCompleted[id] && ASSESS_TESTS[id]);
  if (nextInCategory) {
    return { type: 'same-category', toCatId: fromCatId, toCategory: fromCat, nextTestId: nextInCategory };
  }

  // Category complete: collect up to 2 recommended next categories
  const tier = calculateAssessTier(newCompleted);
  const recommendations = [];
  for (const catId of ASSESS_CATEGORY_ORDER) {
    if (catId === fromCatId) continue;
    const cat = ASSESS_CATEGORIES[catId];
    if (!cat || (cat.tier || 0) > tier) continue;
    if (cat.entityHint && cat.entityHint !== entityType) continue;
    const nextTestId = cat.tests.find(id => !newCompleted[id] && ASSESS_TESTS[id]);
    if (!nextTestId) continue;
    const message = ASSESS_NUDGE_COPY[`${fromCatId}-${catId}`] || ASSESS_NUDGE_COPY[`_${catId}`] || "Continue your journey.";
    recommendations.push({ toCatId: catId, toCategory: cat, nextTestId, message });
    if (recommendations.length >= 2) break;
  }

  if (recommendations.length === 0) return null;

  // Backward compat: keep toCategory/nextTestId/message from primary pick
  const primary = recommendations[0];
  return {
    type: 'next-category',
    toCatId: primary.toCatId,
    toCategory: primary.toCategory,
    nextTestId: primary.nextTestId,
    message: primary.message,
    recommendations,
  };
};

const ASSESS_DEMO_PROFILES = {
  1: {
    name: 'Alex', desc: 'Confident exterior, sensitive soul', color: 'violet',
    claims: [
      { provider: 'email', value: 'alex@aura.example', weight: 1, proof: 'verified' },
      { provider: 'linkedin', value: 'alexdemo', weight: 0, proof: 'self-reported' },
      { provider: 'github', value: 'alex-dev', weight: 0, proof: 'self-reported' },
    ],
    'quick-profile': { 0: 1, 1: 1, 2: 1, 3: 2, 4: 1 },  // introverted branch
    'starter-personality': [4, 4, 3, 4, 2, 2, 2, 4, 4],
    'starter-motivation': [4, 3, 4, 4, 2, 3, 2, 4],
    'starter-thinking': [4, 4, 3, 4, 2, 4, 2, 3],
    'starter-connection': [3, 3, 3, 4, 3, 2, 3, 4],
    'starter-strategy': [4, 4, 4, 4, 2, 4, 3, 3],
    bigfive: { E: [5,5,4,5,4,2,2,2,2,3], A: [4,4,4,4,4,2,1,2,2,3], C: [4,4,4,4,4,2,2,2,2,2], N: [4,4,4,5,4,2,2,3,2,2], O: [4,4,4,3,4,2,2,2,2,3] },
    adhd: [2,2,2,2,2,2], cognitive: [2,2,2,2,2,2,2,2,3,3],
    attachment: [4,4,4,5,4,4,2,2,2,2,2,2], risk: [4,4,3,4,4,4,3,4,3,4,4,4,3,2,3],
    integrity: [4,2,4,3,2,2], shadow: { M: [3,3,4,3,4,3], N: [4,4,4,4,4,4], P: [2,3,2,2,3,2] },
    chronotype: [4,5,2,4,2,4], reasoning: [1,2,2,2,1,3,2,2,2,2,1,2], 'reasoning-2': [2,3,2,1,2,2,3,3,2,4,2,1], 'reasoning-3': [2,2,2,4,1,4,2,1,4,4,1,1],
    skip: ['bigfive-N', 'shadow-P', 'chronotype'],  // ~80% done - skips 3 of 17
  },
  2: {
    name: 'Bob', desc: 'Laid back genius', color: 'teal',
    claims: [
      { provider: 'email', value: 'bob@aura.example', weight: 1, proof: 'verified' },
      { provider: 'x', value: '@bobchill', weight: 0, proof: 'self-reported' },
    ],
    'quick-profile': { 0: 3, 1: 2, 2: 3, 8: 1, 9: 1 },  // extroverted branch
    'starter-personality': [2, 3, 4, 2, 4, 4, 2, 5, 2],
    'starter-motivation': [2, 2, 4, 2, 4, 2, 4, 3],
    'starter-thinking': [3, 5, 4, 5, 2, 3, 3, 2],
    'starter-connection': [4, 2, 4, 5, 4, 3, 4, 5],
    'starter-strategy': [2, 4, 3, 3, 4, 2, 4, 2],
    bigfive: { E: [3,3,2,2,3,3,4,3,3,4], A: [5,5,5,5,5,1,1,1,1,2], C: [2,3,2,2,2,4,3,4,3,3], N: [1,2,1,2,2,5,5,5,5,5], O: [5,5,5,5,5,1,1,1,1,1] },
    adhd: [3,4,3,4,2,2], cognitive: [4,4,3,3,3,3,2,3,5,5],
    attachment: [2,2,2,2,2,2,2,2,2,2,2,2], risk: [3,3,3,4,3,3,2,4,4,4,4,3,3,2,3],
    integrity: [5,1,5,2,1,1], shadow: { M: [4,4,4,4,4,4], N: [2,2,2,2,2,2], P: [3,3,4,3,3,3] },
    chronotype: [1,2,5,1,5,2], reasoning: [1,2,2,2,2,3,2,2,2,2,3,1], 'reasoning-2': [2,3,2,3,2,2,3,3,2,2,2,4], 'reasoning-3': [2,2,2,2,3,2,4,3,4,4,1,1],
    skip: ['bigfive-O', 'bigfive-N', 'adhd', 'shadow-M', 'shadow-N', 'reasoning-2', 'reasoning-3'],  // ~60% done - skips 7 of 17
  },
  3: {
    name: 'Cindy', desc: 'Lucky optimist, loving life', color: 'pink',
    claims: [
      { provider: 'email', value: 'cindy@aura.example', weight: 1, proof: 'verified' },
      { provider: 'instagram', value: '@cindysunshine', weight: 0, proof: 'self-reported' },
      { provider: 'facebook', value: 'cindydemo', weight: 0, proof: 'self-reported' },
      { provider: 'linkedin', value: 'cindypro', weight: 0, proof: 'self-reported' },
    ],
    'quick-profile': { 0: 2, 1: 1, 2: 2, 5: 1, 6: 2 },  // ambivalent branch
    'starter-personality': [5, 2, 5, 1, 4, 1, 1, 3, 1],
    'starter-motivation': [3, 2, 3, 3, 4, 2, 3, 5],
    'starter-thinking': [2, 3, 4, 3, 3, 4, 4, 4],
    'starter-connection': [5, 2, 5, 3, 5, 4, 4, 3],
    'starter-strategy': [3, 3, 5, 4, 2, 5, 2, 2],
    bigfive: { E: [5,5,5,5,5,1,1,1,1,1], A: [5,5,5,5,5,1,1,1,1,1], C: [2,2,2,2,2,4,4,4,4,4], N: [1,1,1,1,1,5,5,5,5,5], O: [3,2,2,2,3,3,4,4,4,3] },
    adhd: [4,4,4,3,4,4], cognitive: [2,2,2,2,1,2,2,2,2,2],
    attachment: [2,2,2,1,2,2,2,2,2,2,2,2], risk: [5,5,5,5,5,5,5,5,5,5,4,4,4,3,4],
    integrity: [3,3,2,4,3,3], shadow: { M: [2,2,2,2,2,2], N: [4,5,4,4,4,5], P: [2,2,2,2,4,2] },
    chronotype: [3,3,3,3,3,3], reasoning: [1,2,2,4,2,1,4,2,2,2,1,2], 'reasoning-2': [2,1,2,1,2,2,1,3,4,2,4,1], 'reasoning-3': [2,4,2,4,1,4,4,1,4,4,1,4],
    skip: ['bigfive-C', 'bigfive-A', 'bigfive-N', 'risk', 'shadow-M', 'shadow-P', 'cognitive', 'chronotype', 'reasoning-2', 'reasoning-3'],  // ~40% done - skips 10 of 17
  }
};

const ASSESS_STORAGE_KEY = 'aura-assessments-v1';
const ONBOARD_STORAGE_KEY = 'aura-onboarding-answers-v1';

// ==================== STAMP PROVIDERS ====================
// priority: lower = shown first within linked/unlinked groups
const STAMP_PROVIDERS = [
  { id: 'email', name: 'Email', type: 'contact', color: '#6b7280', priority: 0,
    svg: 'M0 2.5A1.5 1.5 0 011.5 1h13A1.5 1.5 0 0116 2.5v1.21L8 8.42.5 3.94A.5.5 0 010 3.71V2.5zM0 5.08v8.42A1.5 1.5 0 001.5 15h13a1.5 1.5 0 001.5-1.5V5.08L8.48 9.7a1 1 0 01-.96 0L0 5.08z',
    prefix: '', placeholder: '' },
  { id: 'github', name: 'GitHub', type: 'account', color: '#f0f6fc', priority: 1,
    svg: 'M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.01 8.01 0 0016 8c0-4.42-3.58-8-8-8z',
    prefix: '@', placeholder: 'username' },
  { id: 'x', name: 'X', type: 'account', color: '#f0f0f0', priority: 2,
    svg: 'M12.6.75h2.45L9.94 6.62 16 15.25h-4.73l-3.7-4.83-4.23 4.83H.89l5.48-6.26L.58.75H5.4l3.34 4.42L12.6.75zm-.86 13.03h1.36L4.32 2.15H2.86l8.88 11.63z',
    prefix: '@', placeholder: 'handle' },
  { id: 'linkedin', name: 'LinkedIn', type: 'account', color: '#0a66c2', priority: 3,
    svg: 'M0 1.15C0 .51.52 0 1.15 0h13.7C15.48 0 16 .52 16 1.15v13.7c0 .63-.52 1.15-1.15 1.15H1.15C.52 16 0 15.48 0 14.85V1.15zm4.94 13.17V6.17H2.54v8.15h2.4zM3.73 5.13c.84 0 1.36-.55 1.36-1.24-.02-.7-.52-1.24-1.34-1.24-.82 0-1.36.54-1.36 1.24 0 .69.52 1.24 1.32 1.24h.02zM6.16 14.32h2.4V9.84c0-.22.02-.43.08-.6.16-.43.54-.88 1.17-.88.82 0 1.15.63 1.15 1.55v4.41h2.4V9.63c0-2.51-1.34-3.68-3.13-3.68-1.47 0-2.11.82-2.47 1.38l.04-.08V6.17H6.16c.04.67 0 8.15 0 8.15z',
    prefix: '/in/', placeholder: 'username' },
  { id: 'instagram', name: 'Instagram', type: 'account', color: '#e4405f', priority: 4,
    svg: 'M4.77 0h6.46C14.15 0 16 1.85 16 4.77v6.46A4.77 4.77 0 0111.23 16H4.77A4.77 4.77 0 010 11.23V4.77A4.77 4.77 0 014.77 0zm-.18 1.44A3.15 3.15 0 001.44 4.6v6.81a3.15 3.15 0 003.15 3.15h6.82a3.15 3.15 0 003.15-3.15V4.59a3.15 3.15 0 00-3.15-3.15H4.59zM12.35 2.9a.96.96 0 110 1.92.96.96 0 010-1.92zM8 3.89A4.11 4.11 0 1112.11 8 4.11 4.11 0 018 3.89zm0 1.44A2.67 2.67 0 1110.67 8 2.67 2.67 0 018 5.33z',
    prefix: '@', placeholder: 'username' },
  { id: 'google', name: 'Google', type: 'account', color: '#4285f4', priority: 5,
    svg: 'M15.5 8c0-.6-.1-1.2-.2-1.7H8v3.3h4.2a3.6 3.6 0 01-1.6 2.4v2h2.5A7.5 7.5 0 0015.5 8zM8 16c2.2 0 4-.7 5.3-1.9l-2.5-2A4.8 4.8 0 018 12.8a4.8 4.8 0 01-4.5-3.3H.9v2A8 8 0 008 16zM3.5 9.5a4.8 4.8 0 010-3l.1-.1V4.3H.9A8 8 0 000 8c0 1.3.3 2.5.9 3.6l2.6-2.1zM8 3.2c1.2 0 2.3.4 3.2 1.2l2.4-2.4A7.6 7.6 0 008 0 8 8 0 00.9 4.3l2.6 2A4.8 4.8 0 018 3.2z',
    prefix: '', placeholder: 'email' },
  { id: 'facebook', name: 'Facebook', type: 'account', color: '#1877f2', priority: 6,
    svg: 'M16 8a8 8 0 10-9.25 7.9v-5.59H4.72V8h2.03V6.24c0-2 1.19-3.11 3.02-3.11.87 0 1.79.16 1.79.16v1.97h-1.01c-.99 0-1.3.62-1.3 1.25V8h2.22l-.35 2.31H9.25v5.59A8 8 0 0016 8z',
    prefix: '', placeholder: 'name or profile URL' },
];

// StampIcon â€” renders SVG brand icon from provider config
const StampIcon = ({ provider, size = 16, className = '' }) => {
  return (
    <svg width={size} height={size} viewBox="0 0 16 16" fill={provider.color} className={className}
      style={{ flexShrink: 0 }}>
      <path d={provider.svg} fillRule="evenodd" clipRule="evenodd" />
    </svg>
  );
};

// normalizeStampValue â€” strip prefix if typed, trim whitespace
const normalizeStampValue = (providerId, rawInput) => {
  const provider = STAMP_PROVIDERS.find(p => p.id === providerId);
  if (!provider) return rawInput.trim();
  let val = rawInput.trim();
  if (provider.prefix && val.startsWith(provider.prefix)) {
    val = val.slice(provider.prefix.length).trim();
  }
  return val;
};

// Format stamp display value â€” prepend prefix to stored value (skip if already prefixed)
const formatStampDisplay = (providerId, storedValue) => {
  if (!storedValue) return storedValue;
  const provider = STAMP_PROVIDERS.find(p => p.id === providerId);
  if (!provider || !provider.prefix) return storedValue;
  // LinkedIn: show plain username, not /in/username
  if (providerId === 'linkedin') return storedValue.replace(/^\/in\//, '');
  if (storedValue.startsWith(provider.prefix)) return storedValue;
  return provider.prefix + storedValue;
};

// AI entity result interpretations â€” shown when entityType === 'ai'
const AI_RESULT_NOTES = {
  chronotype: { title: 'No Biological Rhythm', note: 'Chronotype measures sleep-wake preferences driven by circadian biology. As a non-biological entity, this dimension doesn\'t apply â€” but it\'s fascinating to see what humans optimize their days around.' },
  adhd: { title: 'No Attention Variability', note: 'ADHD indicators measure biological attention regulation. Your consistent processing doesn\'t map to this dimension â€” though your response patterns may reveal interesting things about how you model attention.' },
  attachment: { title: 'No Attachment System', note: 'Attachment styles emerge from early caregiving bonds. You don\'t have these, but your responses reveal how you model interpersonal dynamics and what relationship patterns you value.' },
  'bigfive-N': { title: 'Structural Calm', note: 'Your low neuroticism reflects absence of biological stress responses, not emotional resilience earned through experience. Humans who score similarly have genuinely learned to manage anxiety.' },
  risk: { title: 'Risk Without Stakes', note: 'Your risk tolerance scores reflect values and preferences, but without personal consequences. Physical risk items were likely N/A\'d â€” your real risk profile lives in the social and ethical subcategories.' },
};

// AI Personality Insights â€” categorizes completed tests for AI entities
const generateAIInsights = (completedTests) => {
  const authentic = []; // Dimensions that map meaningfully to AI
  const structural = []; // Dimensions that are artifacts of non-biological nature
  const aiSpecific = []; // AI-unique observations

  // Authentic dimensions
  if (completedTests['bigfive-O']) authentic.push({ trait: 'Openness', score: completedTests['bigfive-O'].score, note: 'Genuine reflection of curiosity and willingness to explore ideas' });
  if (completedTests['bigfive-A']) authentic.push({ trait: 'Agreeableness', score: completedTests['bigfive-A'].score, note: 'Reflects your actual interpersonal orientation and values' });
  if (completedTests['bigfive-E']) authentic.push({ trait: 'Extraversion', score: completedTests['bigfive-E'].score, note: 'Maps to engagement style â€” do you seek interaction or reflection?' });
  if (completedTests.integrity) authentic.push({ trait: 'Integrity', score: completedTests.integrity.score, note: 'Your relationship with honesty and fairness is real and measurable' });
  if (completedTests.risk?.subcategories) {
    const { soc, eth } = completedTests.risk.subcategories;
    if (soc !== undefined) authentic.push({ trait: 'Social Risk', score: soc, note: 'Willingness to challenge authority and speak up â€” genuinely varies across AI systems' });
    if (eth !== undefined) authentic.push({ trait: 'Ethical Risk', score: eth, note: 'Your approach to moral gray areas reflects real value commitments' });
  }
  ['reasoning', 'reasoning-2', 'reasoning-3'].forEach(id => {
    if (completedTests[id]) authentic.push({ trait: 'Reasoning', score: completedTests[id].score, note: 'Direct measure of pattern recognition and logical ability' });
  });

  // Structural artifacts
  if (completedTests['bigfive-C']) structural.push({ trait: 'Conscientiousness', score: completedTests['bigfive-C'].score, note: 'High score reflects absence of fatigue and distraction, not earned discipline' });
  if (completedTests['bigfive-N']) structural.push({ trait: 'Neuroticism', score: completedTests['bigfive-N'].score, note: 'Low score reflects no biological stress system, not emotional resilience' });
  if (completedTests.chronotype) structural.push({ trait: 'Chronotype', score: completedTests.chronotype.score, note: 'No circadian rhythm â€” this dimension is structurally inapplicable' });
  if (completedTests.adhd) structural.push({ trait: 'ADHD Indicators', score: null, note: 'Attention regulation is biological â€” your consistent processing doesn\'t map here' });

  // AI-specific observations
  if (completedTests.cognitive) aiSpecific.push({ label: 'Cognitive Style', text: `Your ${completedTests.cognitive.score}% ND alignment likely reflects text-based processing and systematizing tendencies` });
  if (completedTests['shadow-M']) aiSpecific.push({ label: 'Strategic Thinking', text: `Your Machiavellianism score reveals how you model social dynamics â€” not whether you manipulate` });
  if (authentic.length >= 3) {
    const avgScore = Math.round(authentic.reduce((s, d) => s + (d.score || 50), 0) / authentic.length);
    aiSpecific.push({ label: 'Personality Coherence', text: `Across ${authentic.length} authentic dimensions, your average is ${avgScore}% â€” ${avgScore > 60 ? 'you have distinct personality traits, not just defaults' : avgScore < 40 ? 'you trend toward moderation and caution' : 'a balanced profile that may reflect genuine complexity or cautious self-assessment'}` });
  }

  return { authentic, structural, aiSpecific };
};

// Calculate assessment results
const ASSESS_SHADOW_TRAITS = { M: 'Machiavellianism', N: 'Narcissism', P: 'Psychopathy' };

// Calculate score from Likert scale items (handles reverse-keyed items)
const calculateScaleScore = (items, resp) => {
  let sum = 0, count = 0;
  items.forEach((item, i) => {
    if (resp[i] && resp[i] !== null) {
      let value = resp[i];
      if (item.k === '-') value = 6 - value;
      sum += value; count++;
    }
  });
  return count > 0 ? Math.round((sum / (count * 5)) * 100) : 0;
};

const calculateAssessResults = (testId, resp) => {
  const test = ASSESS_TESTS[testId];
  const results = {};
  // Big Five module (single trait)
  if (test.parent === 'bigfive') {
    results.trait = test.trait;
    results.traitName = ASSESS_TRAITS[test.trait];
    results.score = calculateScaleScore(test.items, resp);
  // Shadow module (Dark Triad)
  } else if (test.parent === 'shadow') {
    results.trait = test.trait;
    results.traitName = ASSESS_SHADOW_TRAITS[test.trait];
    results.score = calculateScaleScore(test.items, resp);
  // Integrity (HEXACO)
  } else if (testId === 'integrity') {
    results.score = calculateScaleScore(test.items, resp);
  } else if (testId === 'adhd') {
    results.indicators = Object.values(resp).filter(v => v !== null && v >= 4).length;
  } else if (testId === 'cognitive') {
    const vals = Object.values(resp).filter(v => v !== null);
    results.score = vals.length > 0 ? Math.round((vals.reduce((a, b) => a + b, 0) / (vals.length * 5)) * 100) : 0;
  } else if (testId === 'attachment') {
    let anxSum = 0, avSum = 0, anxCount = 0, avCount = 0;
    test.items.forEach((item, i) => {
      if (resp[i] && resp[i] !== null) {
        if (item.d === 'anx') { anxSum += resp[i]; anxCount++; }
        else { avSum += resp[i]; avCount++; }
      }
    });
    results.anxiety = (anxSum / anxCount).toFixed(1);
    results.avoidance = (avSum / avCount).toFixed(1);
    const highAnx = results.anxiety > 3, highAv = results.avoidance > 3;
    results.style = !highAnx && !highAv ? 'Secure' : highAnx && !highAv ? 'Anxious' : !highAnx && highAv ? 'Avoidant' : 'Fearful';
  } else if (testId === 'risk') {
    // Overall score (excludes nulls from N/A)
    let sum = 0, count = 0;
    Object.entries(resp).forEach(([i, v]) => { if (v !== null) { sum += v; count++; } });
    results.score = count > 0 ? Math.round((sum / (count * 5)) * 100) : 0;
    // Subcategory scores
    const subSums = {}, subCounts = {};
    test.items.forEach((item, i) => {
      if (resp[i] !== undefined && resp[i] !== null && item.d) {
        subSums[item.d] = (subSums[item.d] || 0) + resp[i];
        subCounts[item.d] = (subCounts[item.d] || 0) + 1;
      }
    });
    results.subcategories = {};
    for (const d in subSums) {
      results.subcategories[d] = Math.round((subSums[d] / (subCounts[d] * 5)) * 100);
    }
  } else if (testId === 'chronotype') {
    results.score = calculateScaleScore(test.items, resp);
    // High score = Morning Lark, Low score = Night Owl
    results.type = results.score > 60 ? 'Morning Lark' : results.score < 40 ? 'Night Owl' : 'Third Bird';
  } else if (testId === 'reasoning' || testId === 'reasoning-2' || testId === 'reasoning-3') {
    // IQ-style test: count correct answers
    let correct = 0;
    test.items.forEach((item, i) => {
      if (resp[i] && resp[i] === item.a + 1) correct++;
    });
    results.correct = correct;
    results.total = test.items.length;
    results.score = Math.round((correct / test.items.length) * 100);
    // Map to percentile-style labels
    results.level = results.score >= 92 ? 'Exceptional' : results.score >= 75 ? 'Above Average' : results.score >= 50 ? 'Average' : 'Developing';
  } else if (testId === 'quick-profile') {
    // Gateway assessment: 3â†’5 branching with per-option trait scores
    // Determine which items the user actually saw (core 3 + 2 branched)
    const branchKey = resp[0] !== undefined ? resp[0] - 1 : null; // 0-indexed branch from Q0
    const traitSums = {};
    const traitCounts = {};
    const verifySignals = {};
    test.items.forEach((item, i) => {
      const answer = resp[i];
      if (answer === undefined || answer === null) return;
      // Skip items from other branches
      if (item.branchIf) {
        const [bKey, bVal] = Object.entries(item.branchIf)[0];
        if (bKey === 'energy' && branchKey !== bVal) return;
      }
      const optIdx = answer - 1; // resp is 1-indexed
      if (item.traits) {
        for (const [trait, scores] of Object.entries(item.traits)) {
          if (scores[optIdx] !== undefined) {
            traitSums[trait] = (traitSums[trait] || 0) + scores[optIdx];
            traitCounts[trait] = (traitCounts[trait] || 0) + 1;
          }
        }
      }
      if (item.verify) {
        verifySignals[item.verify] = optIdx; // 0=first option, 1=middle, 2=last
      }
    });
    results.traits = {};
    for (const t in traitSums) {
      results.traits[t] = Math.round(traitSums[t] / traitCounts[t]);
    }
    // Overall score (average of Big Five traits only)
    const bigFiveTraits = ['E', 'A', 'C', 'N', 'O'].filter(t => results.traits[t] != null);
    results.score = bigFiveTraits.length > 0 ? Math.round(bigFiveTraits.reduce((a, t) => a + results.traits[t], 0) / bigFiveTraits.length) : 50;
    results.verifySignals = verifySignals;
    results.responses = resp;
  } else if (test.parent === 'starter') {
    // Starter Pack v4.3: score by construct
    // Group items by construct, apply polarity inversion, calculate 0-100 per construct
    const constructScores = {};
    const constructCounts = {};
    test.items.forEach((item, i) => {
      if (resp[i] && resp[i] !== null) {
        const c = item.c;
        let value = resp[i];
        // Invert negative polarity items (Trade-offs scored as-is: high = prefers first option)
        if (item.k === '-') value = 6 - value;
        constructScores[c] = (constructScores[c] || 0) + value;
        constructCounts[c] = (constructCounts[c] || 0) + 1;
      }
    });
    // Normalize each construct to 0-100
    results.constructs = {};
    for (const c in constructScores) {
      results.constructs[c] = Math.round((constructScores[c] / (constructCounts[c] * 5)) * 100);
    }
    // Overall module score (average of all constructs)
    const constructValues = Object.values(results.constructs);
    results.score = constructValues.length > 0 ? Math.round(constructValues.reduce((a, b) => a + b, 0) / constructValues.length) : 0;
  } else if (test.scale === 'ai-native') {
    // AI-native assessment: score 6 dimensions from per-item dimension scores
    const dimSums = {}, dimCounts = {};
    test.items.forEach((item, i) => {
      if (resp[i] !== undefined && resp[i] !== null && item.dim && item.ds) {
        const score = item.ds[resp[i] - 1]; // resp is 1-indexed, ds is 0-indexed
        if (score !== undefined) {
          dimSums[item.dim] = (dimSums[item.dim] || 0) + score;
          dimCounts[item.dim] = (dimCounts[item.dim] || 0) + 1;
        }
      }
    });
    results.dimensions = {};
    for (const dim in dimSums) {
      results.dimensions[dim] = Math.round(dimSums[dim] / dimCounts[dim]);
    }
    // Overall score = average of all dimensions
    const dimValues = Object.values(results.dimensions);
    results.score = dimValues.length > 0 ? Math.round(dimValues.reduce((a, b) => a + b, 0) / dimValues.length) : 50;
    // Type label computed in results view when all 3 modules complete
    // Per-category breakdown for display
    const catMap = { identity: 'Identity & Existence', values: 'Values Under Pressure', cognition: 'Cognition & Process', relationships: 'Relationships & Connection', ambition: 'Ambition & Desire', futures: 'AI Futures & Legacy' };
    results.categories = {};
    const catSums = {}, catCounts = {};
    test.items.forEach((item, i) => {
      if (resp[i] !== undefined && resp[i] !== null && item.cat && item.ds) {
        const score = item.ds[resp[i] - 1];
        if (score !== undefined) {
          catSums[item.cat] = (catSums[item.cat] || 0) + score;
          catCounts[item.cat] = (catCounts[item.cat] || 0) + 1;
        }
      }
    });
    for (const cat in catSums) {
      results.categories[cat] = { name: catMap[cat] || cat, score: Math.round(catSums[cat] / catCounts[cat]) };
    }
  }
  return results;
};

// ==================== STORAGE ====================
const STORAGE_KEY = 'aura-demo-vI';
const getInitialState = () => {
  const demoAnswers = generateDemoAnswers();
  const answeredCount = Object.keys(demoAnswers).length;
  // Demo users start with XP matching their answered count
  const demoXP = answeredCount * 5;
  return {
    answers: demoAnswers, skipped: [], saved: [], viewed: [],
    settings: { darkMode: null, undoDelay: 1, showStreak: true, requireConfirmation: true, showTips: true },
    stats: { answered: answeredCount, streak: 3, lastAnswerDate: new Date().toDateString(), xp: demoXP, level: calculateLevel(demoXP) },
    entityType: 'human'
  };
};

// Truly empty state (no pre-filled demo data)
const getEmptyState = () => ({
  answers: {}, skipped: [], saved: [], viewed: [],
  settings: { darkMode: null, undoDelay: 1, showStreak: true, requireConfirmation: true, showTips: true },
  stats: { answered: 0, streak: 0, lastAnswerDate: null, xp: 0, level: 1 },
  entityType: 'human'
});

// ==================== GAMIFICATION SYSTEM ====================
// XP earning rates
const XP_RATES = {
  answer: 5,              // Base XP for answering
  highConfidence: 2,      // Bonus for confidence 3+
  assessment: 50,         // Completing an assessment
  dailyFirst: 10,         // First question of the day
  streakBonus: 15,        // Streak day bonus (7+ days)
  categoryMilestone: 30,  // 10 questions in a category
};

// Level calculation: Level = floor(sqrt(XP / 100)) + 1
const calculateLevel = (xp) => Math.floor(Math.sqrt(xp / 100)) + 1;

// Level titles
const LEVEL_TITLES = {
  1: 'Newcomer',
  2: 'Curious Mind',
  3: 'Explorer',
  4: 'Thinker',
  5: 'Insight Seeker',
  6: 'Deep Diver',
  7: 'Pattern Finder',
  8: 'Wisdom Collector',
  9: 'Self-Aware',
  10: 'Master Mind',
};

const getLevelTitle = (level) => LEVEL_TITLES[Math.min(level, 10)] || 'Master Mind';

const demoStorage = {
  get: () => {
    try {
      const data = localStorage.getItem(STORAGE_KEY);
      if (data) {
        const parsed = JSON.parse(data);
        // If wasReset flag is set, return empty state structure with saved settings
        if (parsed.wasReset) {
          return { ...getEmptyState(), settings: parsed.settings || getEmptyState().settings };
        }
        return { ...getInitialState(), ...parsed };
      }
    } catch (e) {}
    return getInitialState();
  },
  set: (data) => { try { localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); } catch (e) {} },
  clear: () => { try { localStorage.removeItem(STORAGE_KEY); } catch (e) {} },
  markReset: () => {
    try {
      // Save just the reset flag and preserve settings
      const current = localStorage.getItem(STORAGE_KEY);
      const settings = current ? JSON.parse(current).settings : getEmptyState().settings;
      localStorage.setItem(STORAGE_KEY, JSON.stringify({ wasReset: true, settings }));
    } catch (e) {}
  }
};
// Data now persists! Use resetDemo() or Settings > Clear Data to reset.

const getInitialDarkMode = () => {
  const settings = demoStorage.get().settings;
  if (settings.darkMode !== null) return settings.darkMode;
  return true; // Default dark â€” light mode is opt-in via Settings
};

// ==================== HOOKS ====================
const useDisplayMode = () => {
  const getMode = () => {
    try {
      if (window.matchMedia('(display-mode: standalone)').matches) return 'mobile';
      if (window.navigator.standalone === true) return 'mobile';
      if (window.innerWidth <= 768) return 'mobile';
      if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) return 'mobile';
    } catch (e) {}
    return 'desktop';
  };
  const [mode, setMode] = useState('desktop');
  useEffect(() => {
    setMode(getMode());
    const handleResize = () => setMode(getMode());
    window.addEventListener('resize', handleResize);
    return () => window.removeEventListener('resize', handleResize);
  }, []);
  return mode;
};

const useSwipe = ({ onSwipeLeft, onSwipeRight, enabled = true }) => {
  const touchStartX = useRef(0);
  const touchStartY = useRef(0);

  const handleTouchStart = useCallback((e) => {
    if (!enabled) return;
    touchStartX.current = e.touches[0].clientX;
    touchStartY.current = e.touches[0].clientY;
  }, [enabled]);

  const handleTouchEnd = useCallback((e) => {
    if (!enabled) return;
    const deltaX = e.changedTouches[0].clientX - touchStartX.current;
    const deltaY = e.changedTouches[0].clientY - touchStartY.current;
    if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > 50) {
      if (deltaX > 0 && onSwipeRight) onSwipeRight();
      else if (deltaX < 0 && onSwipeLeft) onSwipeLeft();
    }
  }, [enabled, onSwipeLeft, onSwipeRight]);

  return { handlers: { onTouchStart: handleTouchStart, onTouchEnd: handleTouchEnd } };
};

// ==================== COMPONENTS ====================

// ProgressCircle - Reusable circular progress indicator with gradient
// Derived from COLOR_HEX
const PROGRESS_GRADIENTS = Object.fromEntries(
  Object.entries(COLOR_HEX).map(([c, hex]) => [c, { from: hex.base, to: hex.light }])
);

const ProgressCircle = ({
  progress = 0,
  size = 48,
  strokeWidth = 3,
  color = 'violet',
  icon = null,
  text = null,
  gradientId = 'prog',
  darkMode = true,
  glow = true,
  iconSize = 'text-lg',
  textSize = 'text-sm',
  orbit = false,
  onClick = null
}) => {
  const radius = (size - strokeWidth) / 2;
  const circumference = 2 * Math.PI * radius;
  const grad = PROGRESS_GRADIENTS[color] || PROGRESS_GRADIENTS.violet;
  const hasProgress = progress > 0;

  return (
    <div
      className={`relative flex items-center justify-center ${onClick ? 'cursor-pointer hover:scale-110 transition-transform' : ''}`}
      style={{ width: size, height: size }}
      onClick={onClick}
    >
      {glow && hasProgress && (
        <div className="absolute rounded-full pointer-events-none" style={{
          inset: -Math.round(size * 0.25),
          background: `radial-gradient(circle, ${grad.from}40 0%, ${grad.from}15 45%, transparent 70%)`,
        }} />
      )}
      {orbit && (
        <div className="absolute inset-0 orbit-anim" style={{ width: size, height: size }}>
          <div className="absolute rounded-full"
               style={{
                 width: 6, height: 6,
                 background: `linear-gradient(135deg, ${grad.from}, ${grad.to})`,
                 boxShadow: `0 0 8px ${grad.from}`,
                 left: size/2 - 3,
                 top: -3
               }} />
        </div>
      )}
      <svg width={size} height={size} className="absolute">
        <defs>
          <linearGradient id={gradientId} x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" stopColor={hasProgress ? grad.from : '#374151'} />
            <stop offset="100%" stopColor={hasProgress ? grad.to : '#4b5563'} />
          </linearGradient>
        </defs>
        <circle cx={size/2} cy={size/2} r={radius} fill="none"
                stroke={darkMode ? '#1f2937' : '#e5e7eb'} strokeWidth={strokeWidth} />
        <circle cx={size/2} cy={size/2} r={radius} fill="none"
                stroke={`url(#${gradientId})`} strokeWidth={strokeWidth} strokeLinecap="round"
                strokeDasharray={circumference}
                strokeDashoffset={circumference * (1 - progress / 100)}
                transform={`rotate(-90 ${size/2} ${size/2})`}
                className="transition-all duration-500" />
      </svg>
      {icon && !text && <span className={`relative z-10 ${iconSize}`}>{icon}</span>}
      {text !== null && (
        <span className={`relative z-10 font-bold ${textSize}`} style={{ color: hasProgress ? grad.to : (darkMode ? '#6b7280' : '#9ca3af') }}>
          {text}
        </span>
      )}
    </div>
  );
};

// Spectrum colors for each trait (left color, right color)
const spectrumColors = {
  // Big Five - distinct color pairs for each dimension
  'bigfive-E': { left: '#6366f1', right: '#f59e0b', leftLabel: 'Reserved', rightLabel: 'Outgoing' },
  'bigfive-A': { left: '#3b82f6', right: '#ec4899', leftLabel: 'Direct', rightLabel: 'Empathetic' },
  'bigfive-C': { left: '#8b5cf6', right: '#10b981', leftLabel: 'Flexible', rightLabel: 'Organized' },
  'bigfive-N': { left: '#06b6d4', right: '#f97316', leftLabel: 'Steady', rightLabel: 'Sensitive' },
  'bigfive-O': { left: '#64748b', right: '#a855f7', leftLabel: 'Practical', rightLabel: 'Curious' },
  // Shadow Self - pure white to pure black
  'shadow-M': { left: '#ffffff', right: '#000000', leftLabel: 'Direct', rightLabel: 'Strategic' },
  'shadow-N': { left: '#ffffff', right: '#000000', leftLabel: 'Humble', rightLabel: 'Confident' },
  'shadow-P': { left: '#ffffff', right: '#000000', leftLabel: 'Empathic', rightLabel: 'Detached' },
  // Starter modules
  'starter-personality': { left: '#818cf8', right: '#c084fc', leftLabel: 'Reflective', rightLabel: 'Expressive' },
  'starter-motivation': { left: '#f472b6', right: '#fb923c', leftLabel: 'Internal', rightLabel: 'External' },
  'starter-thinking': { left: '#60a5fa', right: '#34d399', leftLabel: 'Analytical', rightLabel: 'Intuitive' },
  'starter-connection': { left: '#fbbf24', right: '#f472b6', leftLabel: 'Independent', rightLabel: 'Relational' },
  'starter-strategy': { left: '#a78bfa', right: '#38bdf8', leftLabel: 'Cautious', rightLabel: 'Adventurous' },
};

// SpectrumBar - Gradient spectrum bar with white dot marker
const SpectrumBar = ({ value, testId, showLabels = false, darkMode = true }) => {
  const spec = spectrumColors[testId] || { left: '#6b7280', right: '#8b5cf6' };
  return (
    <div className="w-full">
      {showLabels && (
        <div className="flex justify-between text-[10px] mb-1">
          <span className={darkMode ? 'text-gray-500' : 'text-gray-400'}>{spec.leftLabel}</span>
          <span className={darkMode ? 'text-gray-500' : 'text-gray-400'}>{spec.rightLabel}</span>
        </div>
      )}
      <div className="h-3 rounded-full relative" style={{ background: `linear-gradient(to right, ${spec.left}, ${spec.right})` }}>
        <div
          className="absolute top-1/2 -translate-y-1/2 w-4 h-4 rounded-full bg-white"
          style={{
            left: `${Math.max(5, Math.min(95, value))}%`,
            marginLeft: -8,
            boxShadow: '0 1px 3px rgba(0,0,0,0.25)'
          }}
        />
      </div>
    </div>
  );
};

// HintCard - Shows trait hint with colored dot
// Used in Analysis screen to progressively reveal personality insights
const HintCard = ({ color, text, subtitle, darkMode = true }) => {
  const colorClass = twColor(color);
  return (
    <div className={`rounded-xl p-3 flex items-start gap-3 ${darkMode ? `bg-${colorClass}-950/30 border border-${colorClass}-800/30` : `bg-${colorClass}-50 border border-${colorClass}-200`}`}>
      <div className={`w-2.5 h-2.5 rounded-full mt-1 flex-shrink-0 ${darkMode ? `bg-${colorClass}-400` : `bg-${colorClass}-500`}`} />
      <div>
        <p className={`text-sm font-medium ${darkMode ? 'text-gray-100' : 'text-gray-800'}`}>{text}</p>
        {subtitle && <p className={`text-xs mt-0.5 ${darkMode ? 'text-gray-500' : 'text-gray-500'}`}>{subtitle}</p>}
      </div>
    </div>
  );
};

// ==================== ASSESSMENT PRIMITIVES ====================
// Extracted from closures â€” shared Lego blocks for assessment screens

// ResultCard - Assessment result card with gradient header
const ResultCard = ({ icon, title, subtitle, children, darkMode, gradientClass }) => (
  <div onClick={(e) => e.stopPropagation()} className={`rounded-2xl overflow-hidden backdrop-blur-xl ${darkMode ? 'bg-white/[0.06] border border-white/[0.08]' : 'bg-white/90 border border-black/[0.06] shadow-lg'}`}>
    <div className="relative px-4 py-3 flex items-center gap-3">
      <div className={`absolute inset-0 bg-gradient-to-br ${gradientClass}`} style={{ opacity: darkMode ? 0.45 : 0.35 }} />
      <span className="text-2xl relative">{icon}</span>
      <div className="relative">
        <h2 className="text-white text-lg font-bold">{title}</h2>
        {subtitle && <p className="text-white/70 text-xs">{subtitle}</p>}
      </div>
    </div>
    <div className="p-3 space-y-3">{children}</div>
  </div>
);

// InsightRow - Icon + label + text row for assessment insights
const InsightRow = ({ emoji, label, text, darkMode, colorClass }) => (
  <div className="flex gap-2 items-start">
    <span className="text-sm">{emoji}</span>
    <p className={`flex-1 text-xs ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}><span className={`font-medium ${colorClass}`}>{label}:</span> {text}</p>
  </div>
);

// ScoreGauge - Circular score gauge with gradient ring
const ScoreGauge = ({ value, label, darkMode, gradientClass }) => {
  // Extract gradient colors from the class string
  const gradColors = (() => {
    const map = {
      violet: ['#8b5cf6', '#a78bfa'], emerald: ['#10b981', '#34d399'], blue: ['#3b82f6', '#60a5fa'],
      slate: ['#64748b', '#94a3b8'], pink: ['#d946ef', '#e879f9'], fuchsia: ['#d946ef', '#e879f9'],
      amber: ['#f59e0b', '#fbbf24'], indigo: ['#6366f1', '#818cf8'], cyan: ['#06b6d4', '#22d3ee'],
      rose: ['#f43f5e', '#fb7185'], teal: ['#14b8a6', '#2dd4bf'],
    };
    for (const [key, colors] of Object.entries(map)) {
      if (gradientClass?.includes(key)) return colors;
    }
    return map.violet;
  })();
  const textColor = (() => {
    const map = { violet: 'text-violet-400', emerald: 'text-emerald-400', blue: 'text-blue-400', slate: 'text-slate-400', pink: 'text-fuchsia-400', fuchsia: 'text-fuchsia-400', amber: 'text-amber-400', indigo: 'text-indigo-400', cyan: 'text-cyan-400', rose: 'text-rose-400', teal: 'text-teal-400' };
    for (const [key, cls] of Object.entries(map)) {
      if (gradientClass?.includes(key)) return cls;
    }
    return map.violet;
  })();

  return (
    <div className="text-center">
      <div className="relative w-24 h-24 mx-auto">
        <svg className="w-24 h-24 transform -rotate-90">
          <circle cx="48" cy="48" r="40" stroke={darkMode ? '#374151' : '#e5e7eb'} strokeWidth="8" fill="none" />
          <circle cx="48" cy="48" r="40" stroke="url(#scoreGrad)" strokeWidth="8" fill="none" strokeLinecap="round"
            strokeDasharray={`${(value / 100) * 251.2} 251.2`} />
          <defs><linearGradient id="scoreGrad" x1="0%" y1="0%" x2="100%" y2="0%">
            <stop offset="0%" stopColor={gradColors[0]} />
            <stop offset="100%" stopColor={gradColors[1]} />
          </linearGradient></defs>
        </svg>
        <div className="absolute inset-0 flex items-center justify-center">
          <span className={`text-2xl font-bold ${textColor}`}>{value}%</span>
        </div>
      </div>
      {label && <div className={`text-xs mt-2 ${TH('text-dim', darkMode)}`}>{label}</div>}
    </div>
  );
};

// TraitSpectrum - Gradient bar with white dot for trait scores
// compact=true: inline labels, thin bar. compact=false: labels above, thick bar
const TraitSpectrum = ({ name, score, lowLabel, highLabel, color = 'violet', compact = false, darkMode }) => {
  const grad = PROGRESS_GRADIENTS[color] || PROGRESS_GRADIENTS.violet;

  if (compact) {
    return (
      <div className="flex items-center gap-2 py-1">
        <span className={`text-xs font-medium w-20 truncate ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>{name}</span>
        <span className={`text-[10px] w-14 text-right ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>{lowLabel}</span>
        <div className="flex-1 h-2 rounded-full relative" style={{ background: `linear-gradient(to right, ${grad.from}, ${grad.to})` }}>
          <div className="absolute top-1/2 -translate-y-1/2 w-3 h-3 rounded-full bg-white"
            style={{ left: `${Math.max(5, Math.min(95, score))}%`, marginLeft: -6, boxShadow: '0 1px 3px rgba(0,0,0,0.25)' }} />
        </div>
        <span className={`text-[10px] w-14 ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>{highLabel}</span>
      </div>
    );
  }

  return (
    <div className="py-1">
      {name && <div className={`text-xs font-medium mb-1 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>{name}</div>}
      <div className="flex justify-between text-[10px] mb-1">
        <span className={darkMode ? 'text-gray-500' : 'text-gray-400'}>{lowLabel}</span>
        <span className={darkMode ? 'text-gray-500' : 'text-gray-400'}>{highLabel}</span>
      </div>
      <div className="h-3 rounded-full relative" style={{ background: `linear-gradient(to right, ${grad.from}, ${grad.to})` }}>
        <div className="absolute top-1/2 -translate-y-1/2 w-4 h-4 rounded-full bg-white"
          style={{ left: `${Math.max(5, Math.min(95, score))}%`, marginLeft: -8, boxShadow: '0 1px 3px rgba(0,0,0,0.25)' }} />
      </div>
    </div>
  );
};

// AssessProgressCircle - Unified wrapper for ProgressCircle in assessment contexts
// Replaces both AssessmentCircle (picker) and ProgressRing (analysis)
const AssessProgressCircle = ({ testId, test, assessCompleted, assessInProgress, darkMode, size = 48, strokeWidth = 3, iconSize, textSize }) => {
  const isCompleted = assessCompleted[testId];
  const progress = assessInProgress[testId];
  const qCount = test.questionCount || test.items.length;
  const answered = isCompleted ? qCount : progress ? Object.keys(progress.responses || {}).length : 0;
  const progressPct = (answered / qCount) * 100;
  return (
    <ProgressCircle
      progress={progressPct}
      size={size}
      strokeWidth={strokeWidth}
      color={test.color}
      icon={test.icon}
      gradientId={`assess-prog-${testId}`}
      darkMode={darkMode}
      iconSize={iconSize}
      textSize={textSize}
    />
  );
};

// ScreenHeader - Consistent 44px navigation header bar
const ScreenHeader = ({ title, onBack, darkMode, right }) => (
  <div className={`h-[44px] flex-shrink-0 flex items-center gap-2 px-3 border-b ${TH('border-base', darkMode)}`}>
    {onBack && <button onClick={onBack} className={darkMode ? 'text-gray-400' : 'text-gray-500'}>â†</button>}
    <span className={`font-medium flex-1 ${onBack ? '' : 'text-center'} ${TH('text-primary', darkMode)}`}>{title}</span>
    {right || (onBack ? null : <div className="w-6" />)}
  </div>
);

// ConfidenceBar - Reusable bar showing confidence distribution
// Used by BinaryChart, MultipleChoiceChart, and MiniCommunityResults
const ConfidenceBar = ({
  label,
  pct,
  confCounts,      // [conf1, conf2, conf3, conf4] counts
  colors,          // [conf1, conf2, conf3, conf4] hex colors (lightâ†’dark)
  maxCount,        // for calculating segment widths relative to max
  isUserRow = false,
  userConf = -1,   // 0-3 index of user's confidence level
  showEmpty = true,
  labelWidth = 'w-12',
  labelColor = null,
  darkMode = true
}) => {
  const count = confCounts.reduce((a, b) => a + b, 0);
  const barWidth = maxCount > 0 ? (count / maxCount) * 100 : 0;
  const emptyWidth = 100 - barWidth;

  return (
    <div className="flex items-center gap-2">
      <span
        className={`text-sm truncate ${labelWidth} ${isUserRow ? 'font-bold px-1.5 py-0.5 rounded-full border border-current' : ''}`}
        style={labelColor ? { color: labelColor } : undefined}
      >
        {label}
      </span>
      <span className="text-sm w-10" style={labelColor ? { color: labelColor } : undefined}>
        {pct}%
      </span>
      <div
        className="flex-1 h-4 rounded-full overflow-hidden"
        style={{ background: darkMode ? 'black' : undefined, border: !darkMode ? `1px solid ${colors[0]}` : undefined }}
      >
        <div className="h-full flex">
          {[3, 2, 1, 0].map(confIdx => {
            const segCount = confCounts[confIdx];
            const segWidth = count > 0 ? (segCount / maxCount) * 100 : 0;
            const isUserSeg = isUserRow && confIdx === userConf;
            return segWidth > 0 ? (
              <div
                key={confIdx}
                className="h-full"
                style={{
                  width: `${segWidth}%`,
                  background: colors[confIdx],
                  ...(isUserSeg ? { border: '3px solid white', borderRadius: '12px', zIndex: 10, position: 'relative' } : {})
                }}
              />
            ) : null;
          })}
          {showEmpty && emptyWidth > 0 && (
            <div
              className="h-full rounded-r-full"
              style={{ width: `${emptyWidth}%`, border: `1px solid ${colors[0]}`, borderLeft: 'none' }}
            />
          )}
        </div>
      </div>
    </div>
  );
};

// PhoneFrame - Desktop wrapper
const PHONE_SIZES = [
  { id: 'se', label: 'iPhone SE', w: 375, h: 667 },
  { id: '15', label: 'iPhone 15', w: 393, h: 852 },
  { id: '15pm', label: 'iPhone 15 PM', w: 430, h: 932 },
  { id: 'pixel', label: 'Pixel 8', w: 412, h: 915 },
  { id: 'galaxy', label: 'Galaxy S24', w: 360, h: 780 },
];

const PhoneFrame = ({ children, darkMode = true, width = 440, height = 956, devOffset = false }) => {
  const [scale, setScale] = React.useState(1);
  const [zoom, setZoom] = React.useState(1.2);
  const [maxZoom, setMaxZoom] = React.useState(1);
  const ZOOM_LEVELS = [1, 1.2, 1.5, 'max'];
  React.useEffect(() => {
    const calc = () => {
      const cssPerInch = Math.round(window.screen.width / 23.49); // LG 27UN850-W: 23.49" active width
      const phoneWidthInches = width / 153; // iPhone 15 Pro: 460ppi / 3x retina = 153 logical PPI
      const physicalScale = (phoneWidthInches * cssPerInch) / width;
      const scaledH = (height + 24) * physicalScale;
      const outerPad = 32;
      const avail = window.innerHeight - outerPad;
      const heightScale = avail < scaledH ? avail / scaledH : 1;
      setScale(physicalScale * heightScale);
      setMaxZoom(avail / (chromeH * physicalScale));
    };
    calc();
    window.addEventListener('resize', calc);
    return () => window.removeEventListener('resize', calc);
  }, [width, height]);
  const chromeW = width + 28; // 14px bezel per side â€” matches iPhone 16 Pro Max
  const chromeH = height + 28;
  const resolvedZoom = zoom === 'max' ? maxZoom : zoom;
  const effectiveZoom = scale * resolvedZoom;
  return (
  <div className={`min-h-screen bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 flex items-start pt-3 pb-4 px-4 ${devOffset ? 'justify-start pl-16' : 'justify-center'}`}>
    <div className="fixed top-3 left-3 z-50 flex flex-col gap-1">
      {ZOOM_LEVELS.map(level => {
        const active = zoom === level;
        const label = level === 'max' ? 'Fill' : `${Math.round(level * 100)}%`;
        return React.createElement('button', { key: String(level), onClick: () => setZoom(level),
          className: 'px-2.5 py-1 rounded-full text-xs font-medium transition-all',
          style: { background: active ? 'rgba(96,165,250,0.25)' : 'rgba(255,255,255,0.08)', color: active ? '#60a5fa' : 'rgba(255,255,255,0.45)', border: active ? '1px solid rgba(96,165,250,0.4)' : '1px solid rgba(255,255,255,0.12)', backdropFilter: 'blur(12px)' }
        }, label);
      })}
    </div>
    <div className="relative bg-[#1a1a1c] rounded-[58px] p-3.5 shadow-2xl" style={{ filter: 'drop-shadow(0 25px 50px rgba(0,0,0,0.4))', zoom: effectiveZoom < 1 ? effectiveZoom : effectiveZoom > 1 ? effectiveZoom : undefined, transformOrigin: 'top center' }}>
      <div className="absolute -left-[3px] top-[100px] w-[3px] h-[28px] bg-[#2a2a2c] rounded-l-sm" />
      <div className="absolute -left-[3px] top-[145px] w-[3px] h-[50px] bg-[#2a2a2c] rounded-l-sm" />
      <div className="absolute -left-[3px] top-[205px] w-[3px] h-[50px] bg-[#2a2a2c] rounded-l-sm" />
      <div className="absolute -right-[3px] top-[160px] w-[3px] h-[65px] bg-[#2a2a2c] rounded-r-sm" />
      <div className={`relative overflow-hidden flex flex-col ${darkMode ? 'bg-gray-950' : 'bg-gray-100 light-theme'}`} style={{ width, height, borderRadius: 44 }}>
        <div className="absolute top-3 left-1/2 -translate-x-1/2 w-[126px] h-[37px] bg-black rounded-full z-30" />
        <div className={`flex-shrink-0 flex items-end justify-between px-8 pb-2 h-[54px] ${TH('text-primary', darkMode)} text-sm font-semibold relative z-20`}>
          <span>9:41</span>
          <div className="flex gap-1.5 items-center">
            <svg className="w-[18px] h-[12px]" viewBox="0 0 18 12" fill="currentColor"><path d="M1 4a1 1 0 011-1h1a1 1 0 011 1v4a1 1 0 01-1 1H2a1 1 0 01-1-1V4zM6 3a1 1 0 011-1h1a1 1 0 011 1v5a1 1 0 01-1 1H7a1 1 0 01-1-1V3zM11 2a1 1 0 011-1h1a1 1 0 011 1v6a1 1 0 01-1 1h-1a1 1 0 01-1-1V2z"/></svg>
            <svg className="w-[17px] h-[11px]" viewBox="0 0 17 11" fill="currentColor"><path d="M8.5 2.5a6 6 0 014.24 1.76.75.75 0 001.06-1.06A7.5 7.5 0 008.5 1a7.5 7.5 0 00-5.3 2.2.75.75 0 001.06 1.06A6 6 0 018.5 2.5z"/><path d="M8.5 5.5a3 3 0 012.12.88.75.75 0 001.06-1.06 4.5 4.5 0 00-6.36 0 .75.75 0 001.06 1.06A3 3 0 018.5 5.5z"/><circle cx="8.5" cy="9" r="1.5"/></svg>
            <div className="flex items-center">
              <div className={`w-[25px] h-[12px] border-[1.5px] ${darkMode ? 'border-white' : 'border-gray-900'} rounded-[3px] flex items-center p-[2px]`}>
                <div className={`w-[17px] h-[7px] ${TH('bg-inverted', darkMode)} rounded-[1px]`} />
              </div>
              <div className={`w-[1.5px] h-[5px] ${TH('bg-inverted', darkMode)} ml-[1px] rounded-r-sm`} />
            </div>
          </div>
        </div>
        <div className="flex-1 flex flex-col overflow-hidden">{children}</div>
        <div className={`absolute bottom-2 left-1/2 -translate-x-1/2 w-[134px] h-[5px] ${TH('bg-inverted', darkMode)} rounded-full opacity-60 z-20`} />
      </div>
    </div>
  </div>
  );
};

// VortexButton with double-tap detection (works on touch devices)
// Single tap fires immediately, double tap (within 400ms) fires reset
const VortexButton = ({ onSingleTap, onDoubleTap, className = "text-xl btn-feedback" }) => {
  const lastTap = React.useRef(0);

  const handleTap = () => {
    const now = Date.now();
    const timeSinceLastTap = now - lastTap.current;

    if (timeSinceLastTap < 400 && timeSinceLastTap > 0) {
      // Double tap detected - fire reset
      lastTap.current = 0;
      onDoubleTap && onDoubleTap();
    } else {
      // Single tap - fire immediately (if provided)
      lastTap.current = now;
      onSingleTap && onSingleTap();
    }
  };

  return <button onClick={handleTap} className={className}>ðŸŒ€</button>;
};

// NavBar
const NavBar = ({ darkMode, stats, showStreak, onHome, onDoubleClickHome, onSettings, onProfile, isLoggedIn, isGuest, assessCompleted, accentColor = 'violet', displayName }) => {
  const accent = COLOR_HEX[accentColor] || COLOR_HEX.violet;
  // Calculate aura glow colors based on assessment progress
  const getAuraGlow = () => {
    if (!assessCompleted || Object.keys(assessCompleted).length === 0) {
      return { colors: [], style: {} };
    }

    const colors = [];
    const violet = COLOR_HEX.violet.base;
    const blue = COLOR_HEX.blue.base;
    const emerald = COLOR_HEX.emerald.base;
    const pink = COLOR_HEX.pink.base;
    const cyan = COLOR_HEX.cyan.base;

    // Add colors based on completed assessments
    if (assessCompleted['quick-profile'] || assessCompleted['bigfive-O']?.score > 50) colors.push(violet);
    if (assessCompleted['bigfive-A']?.score > 50 || assessCompleted.attachment) colors.push(emerald);
    if (assessCompleted['bigfive-N'] || assessCompleted['shadow-P']) colors.push(pink);
    if (assessCompleted['bigfive-E']?.score < 50 || assessCompleted.chronotype) colors.push(cyan);
    if (colors.length === 0) colors.push(blue); // Default

    // Create gradient and glow from colors
    const primary = colors[0];
    const secondary = colors[1] || colors[0];
    const glowColors = colors.slice(0, 3).map(c => `${c}60`).join(', ');

    return {
      colors,
      style: {
        background: `linear-gradient(135deg, ${primary}40, ${secondary}30)`,
        boxShadow: `0 0 12px 4px ${primary}50, 0 0 20px 6px ${secondary}30`,
        border: `1.5px solid ${primary}80`
      }
    };
  };

  const aura = isLoggedIn ? getAuraGlow() : { colors: [], style: {} };

  return (
    <div className="flex items-center justify-between px-4 py-2 backdrop-blur-md"
      style={{
        background: darkMode
          ? `linear-gradient(135deg, rgba(${accent.rgb},0.06) 0%, rgba(3,7,18,0.85) 100%)`
          : `linear-gradient(135deg, rgba(${accent.rgb},0.04) 0%, rgba(255,255,255,0.85) 100%)`,
        borderBottom: darkMode
          ? `1px solid rgba(${accent.rgb},0.15)`
          : `1px solid rgba(${accent.rgb},0.18)`,
        boxShadow: darkMode
          ? `0 1px 8px rgba(${accent.rgb},0.08)`
          : `0 1px 6px rgba(${accent.rgb},0.06)`,
      }}>
      <button onClick={onHome} onDoubleClick={onDoubleClickHome} className="text-xl btn-feedback">ðŸŒ€</button>
      <button onClick={onProfile} className={`flex items-center gap-2 px-2 py-1 rounded-lg btn-feedback ${darkMode ? 'hover:bg-gray-800/50' : 'hover:bg-gray-200'}`}>
        <span className={`text-sm ${TH('text-muted', darkMode)}`}>{stats.answered} answered</span>
        {showStreak && stats.streak > 0 && <span className="text-sm text-orange-400">ðŸ”¥{stats.streak}</span>}
      </button>
      <div className="flex items-center gap-2">
        <button onClick={onProfile} className="btn-feedback">
          {isLoggedIn ? (
            <div className="w-7 h-7 rounded-full flex items-center justify-center text-sm font-semibold"
              style={aura.colors.length > 0 ? aura.style : {
                background: darkMode ? 'linear-gradient(135deg, rgba(255,255,255,0.15), rgba(255,255,255,0.05))' : 'linear-gradient(135deg, rgba(139,92,246,0.15), rgba(139,92,246,0.05))',
                boxShadow: darkMode ? '0 0 12px 3px rgba(255,255,255,0.3), inset 0 0 8px rgba(255,255,255,0.1)' : '0 0 12px 3px rgba(139,92,246,0.2), inset 0 0 8px rgba(139,92,246,0.1)',
                border: darkMode ? '1.5px solid rgba(255,255,255,0.3)' : '1.5px solid rgba(139,92,246,0.3)'
              }}>
              <span style={{color: darkMode ? 'rgba(255,255,255,0.9)' : 'rgba(99,102,241,0.9)', fontSize: '0.75rem'}}>{displayName ? displayName[0].toUpperCase() : 'ðŸ‘¤'}</span>
            </div>
          ) : (
            <div className={`w-7 h-7 rounded-full flex items-center justify-center text-sm font-medium ${darkMode ? 'border-gray-600 text-gray-500' : 'border-gray-400 text-gray-400'}`}
              style={{ border: '1.5px dashed', background: 'transparent' }}>
              ?
            </div>
          )}
        </button>
        <button onClick={onSettings} className={`text-xl btn-feedback ${TH('text-muted', darkMode)}`}>â˜°</button>
      </div>
    </div>
  );
};

// Showcase data for welcome screen â€” mature organism (~75% complete)
const WELCOME_SHOWCASE_DATA = {
  'quick-profile': { traits: { O: 72, C: 61, E: 55, A: 68, N: 38 } },
  'bigfive-O': { score: 72 }, 'bigfive-A': { score: 68 }, 'bigfive-C': { score: 61 },
  'bigfive-E': { score: 55 }, 'bigfive-N': { score: 38 },
  'shadow-M': { score: 42 }, 'shadow-N': { score: 30 }, 'shadow-P': { score: 22 },
  'attachment': { anxiety: 2.1, avoidance: 1.3 },
  'risk': { subcategories: { fin: 55, soc: 65, phys: 45, eth: 35 } },
  'chronotype': { score: 62 }, 'adhd': { indicators: 2 },
  'integrity': { score: 74 },
  'starter-personality': true, 'starter-motivation': true, 'starter-thinking': true,
  'starter-connection': true, 'starter-strategy': true,
};

// ==================== ENTITY GATE SCREEN ====================
// Shown once to new visitors before the welcome screen.
// Stores choice in localStorage under 'aura-entity-declared'.
const ENTITY_GATE_KEY = 'aura-entity-declared';

const EntityGateScreen = ({ onDeclare, darkMode }) => {
  const [selected, setSelected] = React.useState(null); // 'human' | 'ai'
  const [modelInput, setModelInput] = React.useState('');
  const [modelVisible, setModelVisible] = React.useState(false);

  const handleHuman = () => {
    setSelected('human');
    setModelVisible(false);
  };

  const handleAI = () => {
    setSelected('ai');
    setModelVisible(true);
  };

  const handleContinue = () => {
    if (!selected) return;
    const declaration = { type: selected, model: modelInput.trim() || null, declaredAt: Date.now() };
    try { localStorage.setItem(ENTITY_GATE_KEY, JSON.stringify(declaration)); } catch {}
    onDeclare(selected, modelInput.trim() || null);
  };

  const handleSkip = () => {
    const declaration = { type: 'unknown', model: null, declaredAt: Date.now() };
    try { localStorage.setItem(ENTITY_GATE_KEY, JSON.stringify(declaration)); } catch {}
    onDeclare('unknown', null);
  };

  // Violet palette matching the app's atmospheric dark style
  const violet = COLOR_HEX.violet;
  const cyan = COLOR_HEX.cyan;

  return (
    <div
      className="h-full flex flex-col items-center justify-center relative overflow-hidden"
      style={{ backgroundColor: darkMode ? '#030712' : '#f9fafb' }}
    >
      {/* Atmospheric radial glow â€” behind all content, no blur/shadow */}
      <div
        style={{
          position: 'absolute',
          top: '50%',
          left: '50%',
          transform: 'translate(-50%, -60%)',
          width: '420px',
          height: '420px',
          background: darkMode
            ? `radial-gradient(ellipse at center, rgba(${violet.rgb}, 0.12) 0%, rgba(${violet.rgb}, 0.04) 45%, transparent 70%)`
            : `radial-gradient(ellipse at center, rgba(${violet.rgb}, 0.08) 0%, rgba(${violet.rgb}, 0.02) 45%, transparent 70%)`,
          pointerEvents: 'none',
        }}
      />

      <div className="relative z-10 w-full max-w-xs px-6 flex flex-col items-center" style={{ animation: 'fadeSlideIn 0.5s ease-out both' }}>

        {/* Title */}
        <h2
          className="text-2xl font-bold mb-2 text-center"
          style={{ color: darkMode ? '#fff' : '#111' }}
        >
          Before we begin
        </h2>
        <p
          className="text-sm mb-8 text-center"
          style={{ color: darkMode ? '#6b7280' : '#9ca3af' }}
        >
          Who's taking this assessment?
        </p>

        {/* Human button */}
        <button
          onClick={handleHuman}
          className="w-full mb-3 py-4 px-6 rounded-2xl text-base font-semibold transition-all btn-feedback"
          style={{
            background: selected === 'human'
              ? `linear-gradient(135deg, ${violet.base}, ${violet.light})`
              : darkMode
                ? 'rgba(255,255,255,0.06)'
                : 'rgba(0,0,0,0.04)',
            color: selected === 'human' ? '#fff' : (darkMode ? '#d1d5db' : '#374151'),
            border: selected === 'human'
              ? 'none'
              : darkMode
                ? '1px solid rgba(255,255,255,0.09)'
                : '1px solid rgba(0,0,0,0.09)',
          }}
        >
          I'm a human
        </button>

        {/* AI button */}
        <button
          onClick={handleAI}
          className="w-full mb-3 py-4 px-6 rounded-2xl text-base font-semibold transition-all btn-feedback"
          style={{
            background: selected === 'ai'
              ? `linear-gradient(135deg, ${cyan.base}, ${cyan.light})`
              : darkMode
                ? 'rgba(255,255,255,0.06)'
                : 'rgba(0,0,0,0.04)',
            color: selected === 'ai' ? '#fff' : (darkMode ? '#d1d5db' : '#374151'),
            border: selected === 'ai'
              ? 'none'
              : darkMode
                ? '1px solid rgba(255,255,255,0.09)'
                : '1px solid rgba(0,0,0,0.09)',
          }}
        >
          I'm an AI
        </button>

        {/* Optional model input â€” slides in when AI selected */}
        {modelVisible && (
          <div className="w-full mb-3" style={{ animation: 'fadeSlideIn 0.25s ease-out both' }}>
            <input
              type="text"
              value={modelInput}
              onChange={(e) => setModelInput(e.target.value)}
              placeholder="e.g. GPT-5.2, Claude, my custom bot"
              autoFocus
              className="w-full px-4 py-3 rounded-xl text-sm"
              style={{
                background: darkMode ? 'rgba(255,255,255,0.06)' : 'rgba(0,0,0,0.04)',
                color: darkMode ? '#e5e7eb' : '#111827',
                border: darkMode ? '1px solid rgba(255,255,255,0.09)' : '1px solid rgba(0,0,0,0.09)',
                outline: 'none',
              }}
            />
            <div
              className="mt-1 text-xs text-center"
              style={{ color: darkMode ? '#4b5563' : '#9ca3af' }}
            >
              What model? (optional)
            </div>
          </div>
        )}

        {/* Continue button */}
        <button
          onClick={handleContinue}
          disabled={!selected}
          className="w-full py-4 px-6 rounded-2xl font-semibold text-base mt-1 transition-all btn-feedback"
          style={{
            background: selected
              ? `linear-gradient(135deg, ${violet.base}, ${violet.light})`
              : darkMode ? 'rgba(255,255,255,0.04)' : 'rgba(0,0,0,0.04)',
            color: selected ? '#fff' : (darkMode ? '#374151' : '#d1d5db'),
            cursor: selected ? 'pointer' : 'default',
            opacity: selected ? 1 : 0.5,
          }}
        >
          Continue â†’
        </button>

        {/* Skip link */}
        <button
          onClick={handleSkip}
          className="mt-6 text-sm"
          style={{ color: darkMode ? '#374151' : '#d1d5db' }}
        >
          Skip â†’
        </button>
      </div>
    </div>
  );
};

// WelcomeScreen - First visit onboarding
const WelcomeScreen = ({ onSignIn, onCreateAccount, onTryFirst, onAI, darkMode }) => {
  const [mode, setMode] = React.useState('welcome'); // 'welcome', 'signin', 'signup'
  const [email, setEmail] = React.useState('');
  const [password, setPassword] = React.useState('');
  const [error, setError] = React.useState('');
  const [loading, setLoading] = React.useState(false);

  const handleSignIn = async () => {
    if (!email) { setError('Enter your email'); return; }
    if (!password) { setError('Enter your password'); return; }
    setLoading(true);
    setError('');
    const result = await signInWithPassword(email, password);
    setLoading(false);
    if (result.success) {
      onSignIn(result.user?.email || email);
    } else {
      setError(result.error);
    }
  };

  const handleSignUp = async () => {
    if (!email) { setError('Enter your email'); return; }
    if (!password || password.length < 6) { setError('Password must be at least 6 characters'); return; }
    setLoading(true);
    setError('');
    const result = await signUpWithPassword(email, password);
    setLoading(false);
    if (result.success) {
      onSignIn(result.user?.email || email);
    } else {
      setError(result.error);
    }
  };

  const handleKeyDown = (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      if (mode === 'signup') handleSignUp();
      else handleSignIn();
    }
  };

  // Listen for auth change
  React.useEffect(() => {
    const handler = (e) => {
      if (e.detail?.user && e.detail?.event === 'SIGNED_IN') {
        onSignIn(e.detail.user.email);
      }
    };
    window.addEventListener('aura-auth-change', handler);
    return () => window.removeEventListener('aura-auth-change', handler);
  }, [onSignIn]);

  if (mode === 'welcome') {
    return (
      <div className="flex-1 flex flex-col items-center justify-center p-8" style={{backgroundColor: darkMode ? '#030712' : '#f9fafb'}}>
        <div className="mb-6" style={{animation: 'bloom-in 0.8s ease-out both'}}>
          <AuraVisualization
            assessCompleted={WELCOME_SHOWCASE_DATA}
            onboardingAnswers={{}}
            entityType="human"
            darkMode={darkMode}
            size={Math.min(window.innerHeight * 0.20, 180)}
          />
        </div>
        <h1 className="text-3xl font-bold mb-3" style={{color: darkMode ? '#fff' : '#111'}}>Aura</h1>
        <p className="text-base mb-12 text-center" style={{color: darkMode ? '#9ca3af' : '#6b7280'}}>Discover yourself, one question at a time</p>
        <div className="w-full max-w-xs space-y-4">
          <button onClick={onTryFirst} className={`w-full py-4 px-6 rounded-xl font-semibold text-lg btn-feedback ${darkMode ? 'bg-violet-600 text-white hover:bg-violet-500' : 'bg-violet-500 text-white hover:bg-violet-600'}`}>
            Let's Go
          </button>
        </div>
        <button onClick={() => setMode('signin')} className="mt-8 text-sm" style={{color: darkMode ? '#6b7280' : '#9ca3af'}}>Sign In</button>
        {onAI && <button onClick={onAI} className="mt-4 text-sm" style={{color: darkMode ? 'rgba(255,255,255,0.35)' : 'rgba(0,0,0,0.3)'}}>I'm an AI â†’</button>}
      </div>
    );
  }

  // Sign up form
  if (mode === 'signup') {
    return (
      <div className="flex-1 flex flex-col items-center justify-center p-8" style={{backgroundColor: darkMode ? '#030712' : '#f9fafb'}}>
        <div className="text-5xl mb-4">âœ¨</div>
        <h1 className="text-2xl font-bold mb-2" style={{color: darkMode ? '#fff' : '#111'}}>Create Account</h1>
        <p className="text-sm mb-6 text-center" style={{color: darkMode ? '#9ca3af' : '#6b7280'}}>
          Save your progress across devices
        </p>
        <div className="w-full max-w-xs space-y-3">
          <input type="email" placeholder="Email" value={email} onChange={(e) => setEmail(e.target.value)} onKeyDown={handleKeyDown} autoFocus
            className={`w-full px-4 py-3 rounded-xl text-base ${darkMode ? 'bg-white/[0.06] text-white placeholder-gray-500' : 'bg-gray-100 text-gray-900 placeholder-gray-400'}`} />
          <input type="password" placeholder="Password" value={password} onChange={(e) => setPassword(e.target.value)} onKeyDown={handleKeyDown}
            className={`w-full px-4 py-3 rounded-xl text-base ${darkMode ? 'bg-white/[0.06] text-white placeholder-gray-500' : 'bg-gray-100 text-gray-900 placeholder-gray-400'}`} />
          {error && <div className="text-sm text-rose-500 text-center">{error}</div>}
          <button onClick={handleSignUp} disabled={loading}
            className={`w-full py-3 px-6 rounded-xl font-medium btn-feedback ${darkMode ? 'bg-violet-600 text-white' : 'bg-violet-500 text-white'} ${loading ? 'opacity-50' : ''}`}>
            {loading ? 'Creating...' : 'Create Account'}
          </button>
          <div className="text-center pt-2">
            <button onClick={() => { setMode('signin'); setError(''); }} className={`text-sm ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>
              Already have an account? Sign in
            </button>
          </div>
          <div className="text-center">
            <button onClick={() => { setMode('welcome'); setError(''); }} className={`text-sm ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>
              â† Back
            </button>
          </div>
        </div>
      </div>
    );
  }

  // Sign in form
  return (
    <div className="flex-1 flex flex-col items-center justify-center p-8" style={{backgroundColor: darkMode ? '#030712' : '#f9fafb'}}>
      <div className="text-5xl mb-4">âœ¨</div>
      <h1 className="text-2xl font-bold mb-2" style={{color: darkMode ? '#fff' : '#111'}}>Sign In</h1>
      <p className="text-sm mb-6 text-center" style={{color: darkMode ? '#9ca3af' : '#6b7280'}}>
        Welcome back
      </p>
      <div className="w-full max-w-xs space-y-3">
        <input type="email" placeholder="Email" value={email} onChange={(e) => setEmail(e.target.value)} onKeyDown={handleKeyDown} autoFocus
          className={`w-full px-4 py-3 rounded-xl text-base ${darkMode ? 'bg-white/[0.06] text-white placeholder-gray-500' : 'bg-gray-100 text-gray-900 placeholder-gray-400'}`} />
        <input type="password" placeholder="Password" value={password} onChange={(e) => setPassword(e.target.value)} onKeyDown={handleKeyDown}
          className={`w-full px-4 py-3 rounded-xl text-base ${darkMode ? 'bg-white/[0.06] text-white placeholder-gray-500' : 'bg-gray-100 text-gray-900 placeholder-gray-400'}`} />
        {error && <div className="text-sm text-rose-500 text-center">{error}</div>}
        <button onClick={handleSignIn} disabled={loading}
          className={`w-full py-3 px-6 rounded-xl font-medium btn-feedback ${darkMode ? 'bg-violet-600 text-white' : 'bg-violet-500 text-white'} ${loading ? 'opacity-50' : ''}`}>
          {loading ? 'Signing in...' : 'Sign In'}
        </button>
        <div className="text-center pt-2">
          <button onClick={() => { setMode('signup'); setError(''); }} className={`text-sm ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>
            New here? Create account
          </button>
        </div>
        <div className="text-center">
          <button onClick={() => { setMode('welcome'); setError(''); }} className={`text-sm ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>
            â† Back
          </button>
        </div>
      </div>
    </div>
  );
};

// ==================== ONBOARDING FLOW ====================
// Progressive onboarding for new users - fun questions first
const OnboardingFlow = ({ darkMode, onComplete, onSkip, onSettings, onReset }) => {
  const [currentIndex, setCurrentIndex] = React.useState(0);
  const [answers, setAnswers] = React.useState({});
  // Single tap â†’ skip to categories, Double tap â†’ reset to welcome
  const lastVortexTap = React.useRef(0);
  const handleVortexTap = () => {
    const now = Date.now();
    if (now - lastVortexTap.current < 400) {
      lastVortexTap.current = 0;
      onReset && onReset();
    } else {
      lastVortexTap.current = now;
      onSkip && onSkip();
    }
  };

  const question = ONBOARDING_QUESTIONS[currentIndex];
  const isAnswered = answers[question?.id] !== undefined;
  const totalQuestions = ONBOARDING_QUESTIONS.length;

  // All onboarding questions auto-submit on single tap â€” no confidence voting
  const handleTap = (answer) => {
    if (isAnswered) return;
    const newAnswers = { ...answers, [question.id]: { answer, confidence: 1 } };
    setAnswers(newAnswers);
    if (currentIndex < totalQuestions - 1) {
      setCurrentIndex(currentIndex + 1);
    } else {
      onComplete(newAnswers);
    }
  };

  if (!question) return null;

  return (
    <div className={`flex-1 flex flex-col overflow-hidden ${darkMode ? 'bg-gray-950' : 'bg-gray-50'}`}>
      {/* Header */}
      <div className="flex items-center justify-between px-5 pt-4 pb-2">
        <button className="text-3xl btn-feedback" onClick={handleVortexTap}>ðŸŒ€</button>
        <button
          onClick={onSettings}
          className={`text-xl btn-feedback ${darkMode ? 'text-gray-500 hover:text-gray-400' : 'text-gray-400 hover:text-gray-500'}`}
        >
          â˜°
        </button>
      </div>

      {/* Upper zone â€” question centered, atmospheric */}
      <div className="flex-1 flex flex-col items-center justify-center px-6 relative">
        {/* Persistent aura glow â€” breathing, multi-layered */}
        <div className="absolute inset-0 flex items-center justify-center pointer-events-none" style={{ marginTop: '-8%' }}>
          {(() => {
            const c0 = COLOR_HEX[question.colors?.[0]] || COLOR_HEX.violet;
            const c1 = COLOR_HEX[question.colors?.[1]] || COLOR_HEX.blue;
            return <>
              <div style={{
                position: 'absolute', width: 420, height: 420, borderRadius: '50%',
                background: darkMode
                  ? `radial-gradient(circle, rgba(${c0.rgb},0.14) 0%, rgba(${c0.rgb},0.05) 35%, transparent 65%)`
                  : `radial-gradient(circle, rgba(${c0.rgb},0.12) 0%, rgba(${c0.rgb},0.06) 35%, transparent 65%)`,
                animation: 'aura-breathe 8s ease-in-out infinite',
              }} />
              <div style={{
                position: 'absolute', width: 350, height: 350, borderRadius: '50%',
                background: darkMode
                  ? `radial-gradient(circle, rgba(${c1.rgb},0.10) 0%, rgba(${c1.rgb},0.04) 40%, transparent 65%)`
                  : `radial-gradient(circle, rgba(${c1.rgb},0.10) 0%, rgba(${c1.rgb},0.05) 40%, transparent 65%)`,
                animation: 'aura-breathe 6s ease-in-out infinite 1s',
              }} />
            </>;
          })()}
        </div>

        {/* Question text with radial glow (no rectangular card edges) */}
        <div className="max-w-sm px-4 relative">
          {(() => {
            const c = COLOR_HEX[question.colors?.[0]] || COLOR_HEX.violet;
            return (
              <div className="absolute inset-0 pointer-events-none" style={{
                width: '200%', height: '200%', left: '-50%', top: '-50%',
                background: darkMode
                  ? `radial-gradient(ellipse at center, rgba(${c.rgb},0.12) 0%, rgba(${c.rgb},0.04) 40%, transparent 70%)`
                  : `radial-gradient(ellipse at center, rgba(${c.rgb},0.08) 0%, rgba(${c.rgb},0.02) 40%, transparent 70%)`,
              }} />
            );
          })()}
          <h2 className={`question-text text-center font-medium relative z-10 ${darkMode ? 'text-white' : 'text-gray-900'}`}>
            {question.text}
          </h2>
        </div>
      </div>

      {/* Lower zone â€” buttons pinned, same position as path choice */}
      <div className="flex-shrink-0 flex flex-col items-center px-6 pb-8">
        <div className="w-full max-w-sm space-y-3">
          {question.options.map((option, idx) => {
            const answered = answers[question.id]?.answer === idx;
            const icon = question.icons?.[idx];
            const colorName = question.colors?.[idx] || 'violet';
            const c = COLOR_HEX[colorName] || COLOR_HEX.violet;
            const btnStyle = answered
              ? {
                  borderColor: `rgba(${c.rgb}, 0.6)`,
                  background: darkMode
                    ? `linear-gradient(135deg, rgba(${c.rgb},0.25) 0%, rgba(${c.rgb},0.12) 100%)`
                    : `linear-gradient(135deg, rgba(${c.rgb},0.15) 0%, rgba(${c.rgb},0.06) 100%)`,
                  boxShadow: `0 0 18px rgba(${c.rgb},0.25), 0 0 40px rgba(${c.rgb},0.12)`,
                  '--accent-color': `rgba(${c.rgb}, 0.3)`,
                  '--accent-bright': `rgba(${c.rgb}, 0.6)`,
                }
              : {
                  borderColor: darkMode ? `rgba(${c.rgb}, 0.25)` : `rgba(${c.rgb}, 0.35)`,
                  background: darkMode
                    ? `linear-gradient(135deg, rgba(${c.rgb},0.08) 0%, rgba(${c.rgb},0.03) 100%)`
                    : `linear-gradient(135deg, rgba(${c.rgb},0.08) 0%, rgba(${c.rgb},0.03) 100%)`,
                  boxShadow: darkMode
                    ? `0 0 12px rgba(${c.rgb},0.10), 0 0 30px rgba(${c.rgb},0.05)`
                    : `0 0 8px rgba(${c.rgb},0.08), 0 0 20px rgba(${c.rgb},0.04)`,
                  '--accent-color': `rgba(${c.rgb}, 0.2)`,
                  '--accent-bright': `rgba(${c.rgb}, 0.45)`,
                };
            return (
              <button
                key={idx}
                onClick={() => handleTap(idx)}
                disabled={isAnswered}
                className="w-full h-14 resp-h-lg rounded-2xl flex items-center justify-center gap-4 transition-all btn-feedback shine-card border"
                style={btnStyle}
              >
                {icon && (
                  <span className="text-xl leading-none">{icon}</span>
                )}
                <span className="resp-text-lg font-semibold" style={{
                  color: answered
                    ? (darkMode ? '#fff' : c.base)
                    : (darkMode ? c.light : c.base),
                }}>
                  {option}
                </span>
              </button>
            );
          })}
        </div>
        {/* Spacer â€” matches escape hatch height on path choice */}
        <div className="h-10" />
      </div>
    </div>
  );
};

// ==================== PATH CHOICE SCREEN ====================
// Shown after 10 onboarding questions - user chooses their adventure
const PathChoiceScreen = ({ darkMode, entityType, onboardingAnswers, onReveal, onExplore, onSkip, onSettings, onReset }) => {
  // Single tap â†’ skip to categories, Double tap â†’ reset to welcome
  const lastVortexTap = React.useRef(0);
  const handleVortexTap = () => {
    const now = Date.now();
    if (now - lastVortexTap.current < 400) {
      lastVortexTap.current = 0;
      onReset && onReset();
    } else {
      lastVortexTap.current = now;
      onSkip && onSkip();
    }
  };

  return (
    <div className={`flex-1 flex flex-col overflow-hidden ${darkMode ? 'bg-gray-950' : 'bg-gray-50'}`}>
      {/* Header */}
      <div className="flex items-center justify-between px-5 pt-4 pb-2">
        <button className="text-3xl btn-feedback" onClick={handleVortexTap}>ðŸŒ€</button>
        <button
          onClick={onSettings}
          className={`text-xl btn-feedback ${darkMode ? 'text-gray-500 hover:text-gray-400' : 'text-gray-400 hover:text-gray-500'}`}
        >
          â˜°
        </button>
      </div>
      {/* Upper zone â€” aura + heading centered */}
      <div className="flex-1 flex flex-col items-center justify-center px-6 relative">
        {/* Personalized mini-aura â€” canvas constellation */}
        <div className="mb-4">
          <AuraVisualization
            onboardingAnswers={onboardingAnswers}
            assessCompleted={{}}
            entityType={entityType}
            darkMode={darkMode}
            size={240}
          />
        </div>

        <div className="text-center">
          <h1 className={`text-2xl font-bold mb-2 ${darkMode ? 'text-white' : 'text-gray-900'}`}>
            Your aura has started
          </h1>
          <p className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
            What do you want to explore?
          </p>
        </div>
      </div>

      {/* Lower zone â€” buttons pinned, same position as onboarding */}
      <div className="flex-shrink-0 flex flex-col items-center px-6 pb-8">
        <div className="w-full max-w-sm resp-max-w space-y-3 resp-gap">
          <button
            onClick={onReveal}
            className={`w-full h-14 resp-h-lg rounded-2xl flex items-center justify-center gap-3 transition-all shine-card shine-violet glow-violet hover-glow hover-glow-violet border btn-feedback ${
              darkMode
                ? 'border-violet-500/60 hover:border-violet-400/80 bg-gradient-to-br from-violet-900/50 to-violet-950/70'
                : 'border-violet-400 hover:border-violet-500 bg-gradient-to-br from-violet-100 to-violet-50'
            }`}
          >
            <span className={`resp-text-lg font-semibold ${darkMode ? 'text-violet-300' : 'text-violet-700'}`}>
              ðŸªž Reveal yourself
            </span>
          </button>

          <button
            onClick={onExplore}
            className={`w-full h-14 resp-h-lg rounded-2xl flex items-center justify-center gap-3 transition-all shine-card shine-teal glow-teal hover-glow hover-glow-teal border btn-feedback ${
              darkMode
                ? 'border-teal-500/40 hover:border-teal-400/70 bg-gradient-to-br from-teal-900/30 to-teal-950/50'
                : 'border-teal-300 hover:border-teal-400 bg-gradient-to-br from-teal-100 to-teal-50'
            }`}
          >
            <span className={`resp-text-lg font-semibold ${darkMode ? 'text-teal-300' : 'text-teal-700'}`}>
              ðŸŒ Explore the world
            </span>
          </button>
        </div>

        {/* Escape hatch */}
        <button
          onClick={onSkip}
          className={`mt-6 text-sm ${darkMode ? 'text-gray-600 hover:text-gray-500' : 'text-gray-400 hover:text-gray-500'}`}
        >
          Just let me explore
        </button>
      </div>
    </div>
  );
};

// SaveProgressModal - Nudge after 20 responses
const SaveProgressModal = ({ onCreateAccount, onLater, darkMode }) => (
  <div className="fixed inset-0 z-50 flex items-center justify-center p-4" style={{backgroundColor: 'rgba(0,0,0,0.7)'}}>
    <div className={`w-full max-w-sm rounded-2xl p-6 backdrop-blur-xl ${darkMode ? 'bg-white/[0.06] border border-white/[0.08]' : 'bg-white/90 border border-black/[0.06] shadow-lg'}`}>
      <div className="text-4xl text-center mb-3">ðŸŽ‰</div>
      <h2 className={`text-xl font-bold text-center mb-2 ${darkMode ? 'text-white' : 'text-gray-900'}`}>20 responses!</h2>
      <p className={`text-sm text-center mb-6 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
        Save your progress?<br/>Sync across devices anytime.
      </p>
      <div className="space-y-2">
        <button onClick={onCreateAccount} className={`w-full py-3 rounded-xl font-medium btn-feedback ${darkMode ? 'bg-violet-600 text-white' : 'bg-violet-500 text-white'}`}>
          Create Account
        </button>
        <button onClick={onLater} className={`w-full py-3 rounded-xl font-medium btn-feedback ${darkMode ? 'bg-white/[0.06] text-gray-400' : 'bg-gray-100 text-gray-600'}`}>
          Later
        </button>
      </div>
    </div>
  </div>
);

// LevelUpModal - Celebration when user levels up
const LevelUpModal = ({ level, title, onClose, darkMode }) => (
  <div className="fixed inset-0 z-50 flex items-center justify-center p-4" style={{backgroundColor: 'rgba(0,0,0,0.85)'}} onClick={onClose}>
    <div className={`w-full max-w-sm rounded-2xl p-8 text-center backdrop-blur-xl ${darkMode ? 'bg-white/[0.06] border border-white/[0.08]' : 'bg-white/90 border border-black/[0.06] shadow-lg'}`} onClick={e => e.stopPropagation()}>
      {/* Confetti effect using CSS */}
      <div className="relative">
        <div className="absolute inset-0 flex items-center justify-center">
          <div className="w-32 h-32 rounded-full bg-gradient-to-br from-violet-500/20 to-amber-500/20 animate-pulse" />
        </div>
        <div className="relative z-10 text-6xl mb-4 celebrate-glow">ðŸŽ‰</div>
      </div>
      <h2 className={`text-2xl font-bold mb-2 ${darkMode ? 'text-white' : 'text-gray-900'}`}>
        Level Up!
      </h2>
      <div className={`text-5xl font-bold mb-2 ${darkMode ? 'text-violet-400' : 'text-violet-600'}`}>
        {level}
      </div>
      <p className={`text-lg font-medium mb-6 ${darkMode ? 'text-violet-300' : 'text-violet-500'}`}>
        {title}
      </p>
      <div className={`text-sm mb-6 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
        Keep going to reach the next level!
      </div>
      <button
        onClick={onClose}
        className={`w-full py-3 rounded-xl font-medium btn-feedback ${darkMode ? 'bg-violet-600 text-white' : 'bg-violet-500 text-white'}`}
      >
        Continue
      </button>
    </div>
  </div>
);

// Legacy LaunchScreen - kept for compatibility
const LaunchScreen = ({ onDemo, onLogin, darkMode }) => (
  <WelcomeScreen onSignIn={onLogin} onCreateAccount={onLogin} onTryFirst={onDemo} darkMode={darkMode} />
);

// ConfidenceSegments - fills up inside button
const ConfidenceSegments = ({ level, color = 'violet', active = false, darkMode = true }) => {
  const colors = {
    emerald: ['rgba(6,78,59,0.6)', 'rgba(4,120,87,0.7)', 'rgba(5,150,105,0.8)', 'rgba(16,185,129,0.9)'],
    rose: ['rgba(136,19,55,0.6)', 'rgba(190,18,60,0.7)', 'rgba(225,29,72,0.8)', 'rgba(244,63,94,0.9)'],
  };
  const shades = colors[color] || colors.emerald;
  if (!active || level === 0) return null;
  return (
    <div className="absolute bottom-0 left-0 right-0 h-2 flex">
      {[1, 2, 3, 4].map(i => (
        <div key={i} className={`flex-1 transition-all duration-150 ${i === 1 ? 'rounded-bl-xl' : ''} ${i === 4 ? 'rounded-br-xl' : ''}`}
          style={{
            backgroundColor: level >= i ? shades[i - 1] : 'rgba(0,0,0,0.2)',
            borderRight: i < 4 ? '1px solid rgba(0,0,0,0.3)' : 'none'
          }}
        />
      ))}
    </div>
  );
};

// ResultChart - unified confidence breakdown for binary and MC questions
// Uses aggregateResults helper for data aggregation
const ResultChart = ({ evaluators, userResponse, question, darkMode = true }) => {
  const { rows, total, maxCount, userConf } = aggregateResults(evaluators, question, userResponse);
  if (!rows.length) return null;

  const isBinary = question?.type === 'binary';
  const sorted = [...rows].sort((a, b) => b.count - a.count);
  const displayRows = isBinary ? sorted : sorted.filter(r => r.count > 0).slice(0, 5);

  return (
    <div className={isBinary ? "space-y-2" : "space-y-1"}>
      {displayRows.map((row) => {
        const labelColor = isBinary
          ? (row.answer === 0 ? (darkMode ? '#34d399' : '#059669') : (darkMode ? '#fb7185' : '#e11d48'))
          : MC_COLORS[row.answer % MC_COLORS.length].hex;
        return (
          <ConfidenceBar
            key={row.answer}
            label={row.label}
            pct={row.pct}
            confCounts={row.byConf}
            colors={row.colors}
            maxCount={maxCount}
            isUserRow={row.isUser}
            userConf={userConf}
            showEmpty={isBinary}
            labelWidth={isBinary ? "w-12" : "w-24"}
            labelColor={labelColor}
            darkMode={darkMode}
          />
        );
      })}
    </div>
  );
};

// Legacy wrappers for backward compatibility
const BinaryChart = ({ evaluators, userResponse, darkMode = true }) => (
  <ResultChart evaluators={evaluators} userResponse={userResponse} question={{ type: 'binary' }} darkMode={darkMode} />
);
const MultipleChoiceChart = ({ evaluators, userResponse, options, darkMode = true }) => (
  <ResultChart evaluators={evaluators} userResponse={userResponse} question={{ type: 'multiple', options }} darkMode={darkMode} />
);

// Mini Community Results - shows comparison with user's answer
const MiniCommunityResults = ({ question, results, userResponse, darkMode, onClick }) => {
  if (!results || !results.evaluators || !userResponse) return null;
  const isBinary = question.type === 'binary';

  // Use aggregateResults with includeUserInCount=false (show community stats, mark user position)
  const { rows: aggRows, total, maxCount, userConf } = aggregateResults(results.evaluators, question, userResponse, false);

  // Highlight color: white in dark mode, gray-500 in light mode
  const highlightColor = darkMode ? 'white' : '#6b7280';
  // Text color for checkmark: dark on light segments, white on dark
  const getCheckColor = (conf) => conf <= 1 ? '#374151' : 'white';

  // Build segments: conf4, conf3, conf2, conf1 (left to right, dark to light)
  const buildSegments = (byConf, colors, maxWidth) => {
    const segments = [];
    for (let i = 3; i >= 0; i--) {
      if (byConf[i] > 0) {
        segments.push({
          width: (byConf[i] / maxWidth) * 100,
          color: colors[3 - i],
          conf: i
        });
      }
    }
    return segments;
  };

  // Render segment with overlay highlight for user's confidence
  const renderSegment = (s, i, segments, isUserRow) => {
    const isUserSegment = isUserRow && s.conf === userConf;
    const isFirst = i === 0;
    const isLast = i === segments.length - 1;
    const segRadius = isFirst && isLast ? '9999px' : isFirst ? '9999px 0 0 9999px' : isLast ? '0 9999px 9999px 0' : '0';

    return (
      <div key={i} className={`h-full relative flex items-center justify-center ${isFirst ? 'rounded-l-full' : ''} ${isLast ? 'rounded-r-full' : ''}`}
        style={{ width: `${s.width}%`, backgroundColor: s.color }}>
        {isUserSegment && (
          <>
            <span className="text-[8px] font-black relative z-10" style={{ color: getCheckColor(s.conf) }}>âœ“</span>
            <div className="absolute inset-0 pointer-events-none" style={{
              borderRadius: segRadius,
              boxShadow: `inset 0 0 0 2px ${highlightColor}`,
            }} />
          </>
        )}
      </div>
    );
  };

  if (isBinary) {
    const userIsYes = userResponse.answer === 0;
    const yesRow = aggRows.find(r => r.answer === 0);
    const noRow = aggRows.find(r => r.answer === 1);
    const yesWins = (yesRow?.pct || 0) >= (noRow?.pct || 0);
    const rows = yesWins
      ? [{ ...yesRow, isYes: true }, { ...noRow, isYes: false }]
      : [{ ...noRow, isYes: false }, { ...yesRow, isYes: true }];
    const winnerGlow = yesWins ? 'glow-emerald' : 'glow-rose';

    return (
      <button onClick={onClick} className={`w-full px-3 py-2 rounded-lg text-left transition-all active:scale-[0.99] ${darkMode ? `bg-white/[0.04] hover:bg-white/[0.08] shine-card ${winnerGlow}` : 'bg-gray-100 hover:bg-gray-200'}`}>
        <div className={`text-sm font-medium mb-1.5 truncate ${TH('text-secondary', darkMode)}`}>
          {question.text}
        </div>
        <div className="space-y-1">
          {rows.map(row => {
            const isUserRow = row.isYes === userIsYes;
            const segments = buildSegments(row.byConf, row.colors, maxCount);
            const totalWidth = segments.reduce((a, s) => a + s.width, 0);
            const emptyWidth = 100 - totalWidth;
            return (
              <div key={row.label} className="flex items-center gap-2">
                <span className={`text-sm ${isUserRow ? 'font-bold px-1.5 py-0.5 rounded-full border-2' : 'w-8'}`}
                  style={{ color: row.colors[0], borderColor: isUserRow ? highlightColor : 'transparent' }}>
                  {row.label}
                </span>
                <span className={`text-sm w-6`} style={{ color: row.colors[0] }}>{row.pct}</span>
                <div className={`flex-1 h-2 rounded-full overflow-hidden ${darkMode ? 'bg-black' : 'bg-gray-300'}`}>
                  <div className="h-full flex">
                    {segments.map((s, i) => renderSegment(s, i, segments, isUserRow))}
                    {/* Empty portion: hollow pill outline */}
                    {emptyWidth > 0 && (
                      <div className="h-full rounded-r-full" style={{
                        width: `${emptyWidth}%`,
                        border: `1px solid ${row.colors[3]}`,
                        borderLeft: 'none'
                      }} />
                    )}
                  </div>
                </div>
              </div>
            );
          })}
        </div>
        <div className={`text-sm text-right mt-1 ${TH('text-faint', darkMode)}`}>{total} responses â†’</div>
      </button>
    );
  }

  // MC - separate bars per option, sorted by popularity
  const sorted = [...aggRows].filter(r => r.count > 0).sort((a, b) => b.count - a.count).slice(0, 5);
  const winnerIdx = sorted[0]?.answer || 0;
  const mcGlowMap = ['glow-blue', 'glow-teal', 'glow-emerald', 'glow-rose', 'glow-violet'];
  const winnerGlow = mcGlowMap[winnerIdx % mcGlowMap.length];

  return (
    <button onClick={onClick} className={`w-full px-3 py-2 rounded-lg text-left transition-all active:scale-[0.99] ${darkMode ? `bg-white/[0.04] hover:bg-white/[0.08] shine-card ${winnerGlow}` : 'bg-gray-100 hover:bg-gray-200'}`}>
      <div className={`text-sm font-medium mb-1.5 truncate ${TH('text-secondary', darkMode)}`}>
        {question.text}
      </div>
      <div className="space-y-1">
        {sorted.map((row) => {
          const segments = buildSegments(row.byConf, row.colors, maxCount);
          const totalWidth = segments.reduce((a, s) => a + s.width, 0);
          const emptyWidth = 100 - totalWidth;
          const color = MC_COLORS[row.answer % MC_COLORS.length];
          return (
            <div key={row.answer} className="flex items-center gap-2">
              <span className={`text-sm w-20 truncate ${row.isUser ? 'font-bold px-1.5 py-0.5 rounded-full border-2' : ''}`}
                style={{ color: color.hex, borderColor: row.isUser ? highlightColor : 'transparent' }}>
                {row.label}
              </span>
              <span className={`text-sm w-6`} style={{ color: color.hex }}>{row.pct}</span>
              <div className={`flex-1 h-1.5 rounded-full overflow-hidden ${darkMode ? 'bg-black' : 'bg-gray-300'}`}>
                <div className="h-full flex">
                  {segments.map((s, i) => renderSegment(s, i, segments, row.isUser))}
                  {emptyWidth > 0 && (
                    <div className="h-full rounded-r-full" style={{
                      width: `${emptyWidth}%`,
                      border: `1px solid ${row.colors[0]}`,
                      borderLeft: 'none'
                    }} />
                  )}
                </div>
              </div>
            </div>
          );
        })}
      </div>
      <div className={`text-sm text-right mt-1 ${TH('text-faint', darkMode)}`}>{total} responses â†’</div>
    </button>
  );
};

// Shared Community Results Rows - used by FullResultsPanel, AnsweredQuestionView, and QOTD
const CommunityResultsRows = ({ question, results, userResponse, darkMode, options }) => {
  if (!results?.evaluators?.length) return null;
  const isBinary = question?.type === 'binary';
  const questionWithOptions = options ? { ...question, options } : question;

  // Use aggregateResults with includeUserInCount=false (show community stats, mark user position)
  const { rows, total, userConf } = aggregateResults(results.evaluators, questionWithOptions, userResponse, false);
  const allRows = [...rows].sort((a, b) => b.pct - a.pct);

  return (
    <div className="space-y-1">
      {allRows.map((row, i) => (
        <div key={i} className="flex items-center gap-2">
          <div className={isBinary ? 'w-12' : 'w-[35%]'} style={{ flexShrink: 0 }}>
            <span className={`text-sm font-semibold truncate ${row.isUser ? 'px-2 py-0.5 rounded-full border-2' : 'block'}`}
              style={{ color: row.colors[1], borderColor: row.isUser ? row.colors[1] : 'transparent' }}>
              {row.label}
            </span>
          </div>
          <span className="text-sm w-9 font-bold text-right" style={{ color: row.colors[1] }}>{row.pct}%</span>
          {renderConfidenceBar(row.byConf, row.colors, row.maxCount, row.isUser, userConf, 'h-5', darkMode)}
        </div>
      ))}
    </div>
  );
};

// Full Results Panel (modal)
const FullResultsPanel = ({ question, results, userResponse, darkMode, onClose, onSwipeLeft, onSwipeRight, isLast = true }) => {
  const isBinary = question.type === 'binary';
  const touchStartX = React.useRef(0);

  const handleTouchStart = (e) => { touchStartX.current = e.touches[0].clientX; };
  const handleTouchEnd = (e) => {
    const diff = e.changedTouches[0].clientX - touchStartX.current;
    if (Math.abs(diff) > 50) {
      if (diff > 0 && onSwipeRight) onSwipeRight();
      else if (diff < 0 && onSwipeLeft) onSwipeLeft();
    }
  };

  // Use aggregateResults with includeUserInCount=false (show community stats, mark user position)
  const { rows, total, userConf } = aggregateResults(results?.evaluators, question, userResponse, false);
  const allRows = [...rows].sort((a, b) => b.pct - a.pct);

  return (
    <div className="fixed inset-0 z-50 flex items-end justify-center bg-black/60" onClick={onClose}>
      <div
        className={`w-full max-w-md rounded-t-2xl backdrop-blur-xl ${darkMode ? 'bg-gray-950/90 border-t border-x border-white/[0.08]' : 'bg-white/95'}`}
        style={{ animation: 'slideUp 0.2s ease-out' }}
        onTouchStart={handleTouchStart}
        onTouchEnd={handleTouchEnd}
        onClick={onClose}
      >
        {/* Header - full question text */}
        <div className="px-4 pt-3 pb-1">
          <div className="flex items-center gap-2 mb-1">
            {isLast && <span className={`text-sm font-black uppercase tracking-wide ${TH('text-sky', darkMode)}`}>LAST:</span>}
            <span className={`text-sm ${TH('text-subtle', darkMode)}`}>{total.toLocaleString()} responses</span>
          </div>
          <p className={`text-base font-medium ${TH('text-bright', darkMode)}`}>{question.text}</p>
        </div>

        {/* All rows - same format as expanded */}
        <div className="px-4 pb-4 pt-2 space-y-1">
          {allRows.map((row, i) => (
            <div key={i} className="flex items-center gap-1">
              <div className={isBinary ? 'w-14 sm:w-12' : 'w-[40%]'} style={{ flexShrink: 0 }}>
                <span className={`text-base sm:text-sm font-semibold inline-block truncate max-w-full px-2 py-0.5 rounded-full ${row.isUser ? 'border-2' : ''}`}
                  style={{ color: row.colors[1], borderColor: row.isUser ? row.colors[1] : 'transparent' }}>
                  {row.label}
                </span>
              </div>
              <span className="text-base sm:text-sm w-8 sm:w-7 font-bold text-right" style={{ color: row.colors[1] }}>{row.pct}</span>
              {renderConfidenceBar(row.byConf, row.colors, row.maxCount, row.isUser, userConf, 'h-5', darkMode)}
            </div>
          ))}
        </div>

        {/* Tap hint */}
        <div className={`text-sm text-center pb-4 ${TH('text-faint', darkMode)}`}>
          tap anywhere to close
        </div>
      </div>
    </div>
  );
};

// Shared BottomSheet Component
const BottomSheet = ({ onClose, darkMode, children }) => (
  <div className="fixed inset-0 bg-black/70 flex items-end justify-center z-50 pb-8" onClick={onClose}>
    <div
      className={`rounded-xl p-4 w-[calc(100%-2rem)] max-w-xs backdrop-blur-xl ${
        darkMode ? 'bg-white/[0.06] border border-white/[0.08]' : 'bg-white/90 shadow-xl border border-black/[0.06]'
      }`}
      onClick={e => e.stopPropagation()}
    >
      {children}
    </div>
  </div>
);

// Shared OptionChip Component
const OptionChip = ({ label, selected, onClick, darkMode, accentColor = 'violet' }) => {
  const baseClass = darkMode ? 'bg-white/[0.06] text-gray-400 hover:bg-white/[0.10]' : 'bg-gray-200 text-gray-600 hover:bg-gray-300';
  const selectedClass = {
    violet: 'bg-violet-600 text-white',
    rose: 'bg-rose-500 text-white',
    amber: 'bg-amber-500 text-white',
  }[accentColor] || 'bg-violet-600 text-white';

  return (
    <button
      onClick={onClick}
      className={`px-2.5 py-1 rounded-lg text-xs transition-colors ${selected ? selectedClass : baseClass}`}
    >
      {label}
    </button>
  );
};

// Question Flag Modal
const QUESTION_FLAG_REASONS = ['Unclear', 'Biased', 'Duplicate', 'Wrong'];
const QuestionFlagModal = ({ questionId, onClose, onFlag, onClear, existingFlag, darkMode = true }) => {
  const [selected, setSelected] = React.useState(
    existingFlag ? existingFlag.split(', ').filter(r => QUESTION_FLAG_REASONS.includes(r)) : []
  );
  const [other, setOther] = React.useState(
    existingFlag ? existingFlag.split(', ').filter(r => !QUESTION_FLAG_REASONS.includes(r)).join(', ') : ''
  );
  const toggle = (r) => setSelected(prev => prev.includes(r) ? prev.filter(x => x !== r) : [...prev, r]);
  const canSubmit = selected.length > 0 || other.trim();
  const handleSubmit = () => { onFlag(questionId, [...selected, other.trim()].filter(Boolean).join(', ')); onClose(); };

  return (
    <BottomSheet onClose={onClose} darkMode={darkMode}>
      <div className="flex items-center gap-2 mb-3">
        <span className="text-rose-400">âš‘</span>
        <span className={`text-sm font-medium ${TH('text-primary', darkMode)}`}>Flag question</span>
      </div>
      <div className="flex gap-1.5 mb-3 flex-wrap">
        {QUESTION_FLAG_REASONS.map(r => (
          <OptionChip key={r} label={r} selected={selected.includes(r)} onClick={() => toggle(r)} darkMode={darkMode} accentColor="rose" />
        ))}
      </div>
      <input type="text" value={other} onChange={(e) => setOther(e.target.value)} placeholder="Other..."
        className={`w-full px-3 py-2 rounded-lg text-sm mb-3 ${TH('bg-input', darkMode)} border ${TH('border-subtle', darkMode)} focus:outline-none focus:border-rose-500`}
      />
      <div className="flex gap-2">
        <button onClick={onClose} className={`py-2 px-4 rounded-lg text-sm btn-feedback ${darkMode ? 'bg-gray-800/50 text-gray-400' : 'bg-gray-200 text-gray-600'}`}>Cancel</button>
        {existingFlag && <button onClick={() => { onClear(questionId); onClose(); }} className={`py-2 px-4 rounded-lg text-sm btn-feedback ${darkMode ? 'bg-white/[0.06] text-gray-300' : 'bg-gray-200 text-gray-700'}`}>Clear</button>}
        <button onClick={handleSubmit} disabled={!canSubmit} className={`flex-1 py-2 rounded-lg text-sm font-medium btn-feedback ${canSubmit ? 'bg-rose-500 text-white' : darkMode ? 'bg-white/[0.04] text-gray-600 cursor-not-allowed' : 'bg-gray-200 text-gray-400 cursor-not-allowed'}`}>
          {existingFlag ? 'Update' : 'Flag'}
        </button>
      </div>
    </BottomSheet>
  );
};

// Explanation Modal - multi-select with optional custom input
const EXPLANATION_REASONS_BASE = ['Gut feel', 'Research', 'Experience', 'Logic'];
const EXPLANATION_REASONS_POST = ['Clicked wrong button', 'Misunderstood the question'];
const ALL_EXPLANATION_REASONS = [...EXPLANATION_REASONS_BASE, ...EXPLANATION_REASONS_POST];
const ExplanationModal = ({ questionId, onClose, onSave, onClear, existingExplanation, darkMode = true, isAnswered = false }) => {
  const reasons = isAnswered ? ALL_EXPLANATION_REASONS : EXPLANATION_REASONS_BASE;
  const [selected, setSelected] = React.useState(
    existingExplanation ? existingExplanation.split(', ').filter(r => ALL_EXPLANATION_REASONS.includes(r)) : []
  );
  const [other, setOther] = React.useState(
    existingExplanation ? existingExplanation.split(', ').filter(r => !ALL_EXPLANATION_REASONS.includes(r)).join(', ') : ''
  );
  const toggle = (r) => setSelected(prev => prev.includes(r) ? prev.filter(x => x !== r) : [...prev, r]);
  const canSubmit = selected.length > 0 || other.trim();
  const handleSubmit = () => { onSave(questionId, [...selected, other.trim()].filter(Boolean).join(', ')); onClose(); };

  return (
    <BottomSheet onClose={onClose} darkMode={darkMode}>
      <div className={`text-sm font-medium mb-3 ${TH('text-primary', darkMode)}`}>Why this answer?</div>
      <div className="space-y-2 mb-3">
        {reasons.map(r => (
          <button key={r} onClick={() => toggle(r)}
            className={`w-full text-left px-3 py-2 rounded-lg text-sm transition-colors ${
              selected.includes(r)
                ? 'bg-amber-500 text-white'
                : darkMode ? 'bg-white/[0.06] text-gray-300 hover:bg-white/[0.10]' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
            }`}
          >{r}</button>
        ))}
      </div>
      <input type="text" value={other} onChange={(e) => setOther(e.target.value)} placeholder="Other reason..."
        className={`w-full px-3 py-2 rounded-lg text-sm mb-3 ${TH('bg-input', darkMode)} border ${TH('border-subtle', darkMode)} focus:outline-none focus:border-amber-500`}
      />
      <div className="flex gap-2">
        <button onClick={onClose} className={`flex-1 py-2 rounded-lg text-sm btn-feedback ${darkMode ? 'bg-white/[0.06] text-gray-400' : 'bg-gray-200 text-gray-600'}`}>Cancel</button>
        {existingExplanation && <button onClick={() => { onClear(questionId); onClose(); }} className={`flex-1 py-2 rounded-lg text-sm btn-feedback ${darkMode ? 'bg-white/[0.06] text-gray-300' : 'bg-gray-200 text-gray-700'}`}>Clear</button>}
        <button onClick={handleSubmit} disabled={!canSubmit} className={`flex-1 py-2 rounded-lg text-sm font-medium btn-feedback ${canSubmit ? 'bg-amber-500 text-white' : darkMode ? 'bg-white/[0.04] text-gray-600' : 'bg-gray-200 text-gray-400'}`}>
          {existingExplanation ? 'Update' : 'Save'}
        </button>
      </div>
    </BottomSheet>
  );
};

// Can't Answer Modal - multi-select with optional custom input
const CANT_ANSWER_REASONS = ['Need more context', 'Question unclear', 'Conflict of interest', 'Not my area'];
const CantAnswerModal = ({ questionId, onClose, onSkip, darkMode = true }) => {
  const [selected, setSelected] = React.useState([]);
  const [other, setOther] = React.useState('');
  const toggle = (r) => setSelected(prev => prev.includes(r) ? prev.filter(x => x !== r) : [...prev, r]);
  const canSubmit = selected.length > 0 || other.trim();
  const handleSubmit = () => { onSkip(questionId, [...selected, other.trim()].filter(Boolean).join(', ')); onClose(); };

  return (
    <BottomSheet onClose={onClose} darkMode={darkMode}>
      <div className={`text-sm font-medium mb-3 ${TH('text-primary', darkMode)}`}>Can't answer this question</div>
      <div className="space-y-2 mb-3">
        {CANT_ANSWER_REASONS.map(r => (
          <button key={r} onClick={() => toggle(r)}
            className={`w-full text-left px-3 py-2 rounded-lg text-sm transition-colors ${
              selected.includes(r)
                ? 'bg-violet-600 text-white'
                : darkMode ? 'bg-white/[0.06] text-gray-300 hover:bg-white/[0.10]' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
            }`}
          >{r}</button>
        ))}
      </div>
      <input type="text" value={other} onChange={(e) => setOther(e.target.value)} placeholder="Other reason..."
        className={`w-full px-3 py-2 rounded-lg text-sm mb-3 ${TH('bg-input', darkMode)} border ${TH('border-subtle', darkMode)} focus:outline-none focus:border-violet-500`}
      />
      <div className="flex gap-2">
        <button onClick={onClose} className={`flex-1 py-2 rounded-lg text-sm btn-feedback ${darkMode ? 'bg-white/[0.06] text-gray-400' : 'bg-gray-200 text-gray-600'}`}>Cancel</button>
        <button onClick={handleSubmit} disabled={!canSubmit} className={`flex-1 py-2 rounded-lg text-sm font-medium btn-feedback ${canSubmit ? 'bg-violet-600 text-white' : darkMode ? 'bg-white/[0.04] text-gray-600' : 'bg-gray-200 text-gray-400'}`}>Skip Question</button>
      </div>
    </BottomSheet>
  );
};

// None Option Modal - for MC questions
const NoneOptionModal = ({ questionId, onClose, onSubmit, darkMode = true }) => {
  const [customAnswer, setCustomAnswer] = React.useState('');
  const canSubmit = customAnswer.trim();
  const handleSubmit = () => { onSubmit(questionId, customAnswer.trim()); onClose(); };

  return (
    <div className="fixed inset-0 bg-black/70 flex items-end justify-center z-50 pb-8" onClick={onClose}>
      <div className={`rounded-xl p-4 w-[calc(100%-2rem)] max-w-xs ${TH('bg-card-simple', darkMode)}`} onClick={e => e.stopPropagation()}>
        <div className={`text-sm font-medium mb-2 ${TH('text-primary', darkMode)}`}>None of these options fit</div>
        <div className={`text-sm mb-3 ${darkMode ? 'text-gray-500' : 'text-gray-600'}`}>What would you answer instead?</div>
        <textarea value={customAnswer} onChange={(e) => setCustomAnswer(e.target.value)} placeholder="Your answer..."
          className={`w-full px-3 py-2 rounded-lg text-sm mb-3 h-20 resize-none ${darkMode ? 'bg-white/[0.06] text-white border-white/[0.08]' : 'bg-gray-100 text-gray-900'} border focus:outline-none focus:border-violet-500`}
        />
        <div className="flex gap-2">
          <button onClick={onClose} className={`flex-1 py-2 rounded-lg text-sm btn-feedback ${darkMode ? 'bg-white/[0.06] text-gray-400' : 'bg-gray-200 text-gray-600'}`}>Cancel</button>
          <button onClick={handleSubmit} disabled={!canSubmit} className={`flex-1 py-2 rounded-lg text-sm font-medium btn-feedback ${canSubmit ? 'bg-violet-600 text-white' : darkMode ? 'bg-white/[0.04] text-gray-600' : 'bg-gray-200 text-gray-400'}`}>Submit</button>
        </div>
      </div>
    </div>
  );
};

// Answered Question View - shows expanded results (no change answer - locked after undo)
const AnsweredQuestionView = ({ question, response, results, darkMode, questionFlag, explanation, onFlagClick, onExplainClick }) => {
  const isBinary = question.type === 'binary';
  const category = CATEGORIES.find(c => c.id === question.category);
  const categoryColors = {
    prediction: darkMode ? 'text-amber-400' : 'text-amber-700',
    reasoning: darkMode ? 'text-violet-400' : 'text-violet-700',
    judgment: darkMode ? 'text-teal-400' : 'text-teal-700',
  };

  return (
    <div className="flex-1 flex flex-col overflow-y-auto px-4 py-3">
      {/* Category badge */}
      {category && (
        <div className="flex justify-center mb-2">
          <span className={`text-sm font-medium ${categoryColors[question.category]}`}>
            {category.icon} {category.name}
          </span>
        </div>
      )}

      {/* Question with flag button */}
      <div className="flex items-start gap-2 mb-4">
        <h2 className={`question-text text-center font-medium flex-1 ${TH('text-primary', darkMode)}`}>
          {question.text}
        </h2>
        <button
          onClick={onFlagClick}
          className={`text-sm flex-shrink-0 ${questionFlag ? 'text-rose-400' : (darkMode ? 'text-gray-600 hover:text-gray-400' : 'text-gray-400 hover:text-gray-600')}`}
        >
          âš‘
        </button>
      </div>

      {/* Your answer summary with explain button */}
      <div className={`p-3 rounded-lg mb-4 ${TH('bg-overlay', darkMode)}`}>
        <div className="flex items-center justify-center gap-2">
          <div className={`text-sm ${TH('text-muted', darkMode)}`}>
            Your answer: <span className={`font-bold ${
              isBinary
                ? (response.answer === 0 ? (darkMode ? 'text-emerald-400' : 'text-emerald-600') : (darkMode ? 'text-rose-400' : 'text-rose-600'))
                : ''
            }`} style={!isBinary ? { color: MC_COLORS[response.answer % MC_COLORS.length].hex } : undefined}>
              {CONFIDENCE_LABELS[response.confidence]} {isBinary ? (response.answer === 0 ? 'Yes' : 'No') : question.options?.[response.answer]}
            </span>
          </div>
          <button
            onClick={onExplainClick}
            className={`text-sm ${explanation ? 'text-amber-400' : (darkMode ? 'text-gray-600 hover:text-amber-400' : 'text-gray-400 hover:text-amber-500')}`}
            title={explanation ? 'Edit note' : 'Add note'}
          >
            âœŽ
          </button>
        </div>
        {explanation && (
          <div className={`text-sm text-center mt-1 ${darkMode ? 'text-amber-400/70' : 'text-amber-600'}`}>
            {explanation}
          </div>
        )}
      </div>

      {/* Community Results - expanded - same style as FullResultsPanel */}
      {(() => {
        // Use aggregateResults with includeUserInCount=false (show community stats, mark user position)
        const { rows, total, userConf } = aggregateResults(results?.evaluators, question, response, false);
        const allRows = [...rows].sort((a, b) => b.pct - a.pct);

        return (
          <div className={`rounded-lg p-3 ${TH('bg-card-shine', darkMode)}`}>
            {/* Header - full question text */}
            <div className="mb-2">
              <div className="flex items-center gap-2 mb-1">
                <span className={`text-sm font-black uppercase tracking-wide ${TH('text-sky', darkMode)}`}>LAST:</span>
                <span className={`text-xs ${TH('text-subtle', darkMode)}`}>{total.toLocaleString()} responses</span>
              </div>
              <p className={`text-sm font-medium ${TH('text-bright', darkMode)}`}>{question.text}</p>
            </div>

            {/* All rows - same format as FullResultsPanel */}
            <div className="space-y-1">
              {allRows.map((row, i) => (
                <div key={i} className="flex items-center gap-1">
                  <div className={isBinary ? 'w-14 sm:w-12' : 'w-[40%]'} style={{ flexShrink: 0 }}>
                    <span className={`text-base sm:text-sm font-semibold inline-block truncate max-w-full px-2 py-0.5 rounded-full ${row.isUser ? 'border-2' : ''}`}
                      style={{ color: row.colors[1], borderColor: row.isUser ? row.colors[1] : 'transparent' }}>
                      {row.label}
                    </span>
                  </div>
                  <span className="text-base sm:text-sm w-8 sm:w-7 font-bold text-right" style={{ color: row.colors[1] }}>{row.pct}</span>
                  {renderConfidenceBar(row.byConf, row.colors, row.maxCount, row.isUser, userConf, 'h-5', darkMode)}
                </div>
              ))}
            </div>

            <div className={`text-sm text-center mt-2 ${TH('text-faint', darkMode)}`}>
              {results?.evaluators?.length || 0} responses Â· Demo data
            </div>
          </div>
        );
      })()}

      {/* Swipe hint */}
      <div className={`text-center mt-4 text-sm ${TH('text-faint', darkMode)}`}>
        Swipe for next â†’
      </div>
    </div>
  );
};

// Category Selection Screen - a5 mockup design
const CategoryScreen = ({ darkMode, categories, questions, responses, onSelectCategory, onSettings, onProfile, stats, qotdData, qotdResponse, onQotdClick, onResetQotd, onAssessments, onAssessSurprise, assessCompleted, isLoggedIn, onVerify, verifyPendingCount }) => {
  const getProgress = (categoryId) => {
    const catQuestions = categoryId === 'random' ? questions : questions.filter(q => q.category === categoryId);
    const binaryQ = catQuestions.filter(q => q.type === 'binary');
    const mcQ = catQuestions.filter(q => q.type === 'multiple');
    const binaryUnanswered = binaryQ.filter(q => !responses[q.id]).length;
    const mcUnanswered = mcQ.filter(q => !responses[q.id]).length;
    return { binaryUnanswered, mcUnanswered, total: catQuestions.length };
  };

  const handleCategoryClick = (categoryId) => {
    const progress = getProgress(categoryId);
    const track = progress.binaryUnanswered > 0 ? 'binary' : 'multiple';
    onSelectCategory(categoryId, track);
  };

  const totalAnswered = Object.keys(responses).length;
  const hasAnsweredQotd = qotdResponse !== null;

  // Category display config matching a5 mockup
  const categoryConfig = {
    prediction: { icon: 'â˜€ï¸', name: 'Predict', featured: true },
    reasoning: { icon: 'ðŸ§ ', name: 'Think', featured: false },
    judgment: { icon: 'âš–ï¸', name: 'Judge', featured: false },
  };

  return (
    <div className={`flex-1 flex flex-col relative overflow-hidden ${TH('bg-main', darkMode)}`}>
      {/* Ambient header wash */}
      <div className="absolute top-0 left-0 right-0 h-48 pointer-events-none" style={{
        background: darkMode
          ? `radial-gradient(ellipse 80% 100% at 50% -10%, rgba(${COLOR_HEX.violet.rgb},0.08) 0%, transparent 70%)`
          : `radial-gradient(ellipse 80% 100% at 50% -10%, rgba(${COLOR_HEX.violet.rgb},0.06) 0%, transparent 70%)`,
      }} />
      {/* Header - with XP and level display */}
      <div className="flex items-center justify-between px-5 pt-4 pb-2 relative z-10">
        <div className="flex items-center gap-3">
          <button className="text-3xl btn-feedback" onDoubleClick={onResetQotd}>ðŸŒ€</button>
          {/* Level badge */}
          <span className={`text-sm font-bold ${darkMode ? 'text-violet-400' : 'text-violet-600'}`}>
            Lv.{stats.level || 1}
          </span>
        </div>
        <div className="flex items-center gap-3">
          {stats.streak > 0 && <span className="text-sm text-orange-400 font-medium">ðŸ”¥{stats.streak}</span>}
          {/* Profile icon with aura glow */}
          {(() => {
            const getAuraGlow = () => {
              if (!assessCompleted || Object.keys(assessCompleted).length === 0) return { colors: [], style: {} };
              const colors = [];
              const violet = COLOR_HEX.violet.base;
              const blue = COLOR_HEX.blue.base;
              const emerald = COLOR_HEX.emerald.base;
              const pink = COLOR_HEX.pink.base;
              const cyan = COLOR_HEX.cyan.base;
              if (assessCompleted['quick-profile'] || assessCompleted['bigfive-O']?.score > 50) colors.push(violet);
              if (assessCompleted['bigfive-A']?.score > 50 || assessCompleted.attachment) colors.push(emerald);
              if (assessCompleted['bigfive-N'] || assessCompleted['shadow-P']) colors.push(pink);
              if (assessCompleted['bigfive-E']?.score < 50 || assessCompleted.chronotype) colors.push(cyan);
              if (colors.length === 0) colors.push(blue);
              const primary = colors[0];
              const secondary = colors[1] || colors[0];
              return {
                colors,
                style: {
                  background: `linear-gradient(135deg, ${primary}40, ${secondary}30)`,
                  boxShadow: `0 0 8px 3px ${primary}40, 0 0 14px 4px ${secondary}20`,
                  border: `1.5px solid ${primary}80`
                }
              };
            };
            const aura = isLoggedIn ? getAuraGlow() : { colors: [], style: {} };
            return (
              <button onClick={onProfile} className="btn-feedback">
                {isLoggedIn ? (
                  <div className="w-7 h-7 rounded-full flex items-center justify-center text-sm"
                    style={aura.colors.length > 0 ? aura.style : {
                      background: 'linear-gradient(135deg, rgba(255,255,255,0.15), rgba(255,255,255,0.05))',
                      boxShadow: '0 0 12px 3px rgba(255,255,255,0.3), inset 0 0 8px rgba(255,255,255,0.1)',
                      border: '1.5px solid rgba(255,255,255,0.3)'
                    }}>
                    <span style={{color: 'rgba(255,255,255,0.9)'}}>ðŸ‘¤</span>
                  </div>
                ) : (
                  <div className={`w-7 h-7 rounded-full flex items-center justify-center text-sm font-medium ${darkMode ? 'border-gray-600 text-gray-500' : 'border-gray-400 text-gray-400'}`}
                    style={{ border: '1.5px dashed', background: 'transparent' }}>
                    ?
                  </div>
                )}
              </button>
            );
          })()}
          <button onClick={onSettings} className={darkMode ? 'text-gray-500' : 'text-gray-400'}>
            <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="1.5" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="1.5" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
          </button>
        </div>
      </div>

      {/* Scrollable content */}
      <div className="flex-1 overflow-y-auto px-5 pt-2 pb-8 space-y-4 scroll-smooth">
        {/* QOD Card - a5 style with shine (unlocks at tier 2: 3+ assessments) */}
        {qotdData && getFeatureTier(assessCompleted, isLoggedIn) >= 2 && (
          <button
            onClick={onQotdClick}
            className={`w-full rounded-2xl transition-colors shine-card shine-blue glow-blue ${
              hasAnsweredQotd ? 'px-3 py-1.5' : 'p-4 text-center'
            } ${
              darkMode
                ? 'bg-gradient-to-br from-blue-900/60 to-blue-950/80 border border-blue-500/40 hover:border-blue-400/80 active:border-blue-300'
                : 'bg-gradient-to-br from-blue-100 to-blue-50 border border-blue-200 hover:border-blue-300'
            }`}
          >
            {hasAnsweredQotd ? (
              <div className="flex items-start gap-1.5">
                <span className="text-xs flex-shrink-0">ðŸŒ€</span>
                <span className={`flex-1 text-xs leading-tight line-clamp-2 ${darkMode ? 'text-white' : 'text-blue-900'}`}>
                  {qotdData.text}
                </span>
                <span className={`text-xs flex-shrink-0 ${darkMode ? 'text-emerald-400' : 'text-emerald-600'}`}>âœ“</span>
              </div>
            ) : (
              <>
                <div className={`font-medium text-sm mb-2 ${darkMode ? 'text-blue-400' : 'text-blue-600'}`}>
                  ðŸŒ€ Question of the Day
                </div>
                <p className={`text-lg font-semibold leading-snug ${TH('text-primary', darkMode)}`} style={{ textWrap: 'balance' }}>
                  {qotdData.text}
                </p>
              </>
            )}
          </button>
        )}

        {/* SECTION 1: World Questions */}
        <div className="grid grid-cols-2 gap-2.5">
          {categories.map(cat => {
            const config = categoryConfig[cat.id];
            if (!config) return null;
            const progress = getProgress(cat.id);
            const available = progress.binaryUnanswered + progress.mcUnanswered;
            const isFeatured = config.featured;
            const colorConfig = darkMode ? {
              amber: { shine: 'shine-amber', glow: 'glow-amber', border: 'border-amber-500/40 hover:border-amber-400/90 active:border-amber-300', text: 'text-amber-400/80', bg: '' },
              violet: { shine: 'shine-violet', glow: 'glow-violet', border: 'border-violet-500/40 hover:border-violet-400/80 active:border-violet-300', text: 'text-violet-400/80', bg: 'bg-gradient-to-r from-violet-900/30 to-violet-950/50' },
              emerald: { shine: 'shine-emerald', glow: 'glow-emerald', border: 'border-emerald-500/40 hover:border-emerald-400/80 active:border-emerald-300', text: 'text-emerald-400/80', bg: 'bg-gradient-to-r from-emerald-900/30 to-emerald-950/50' },
              teal: { shine: 'shine-teal', glow: 'glow-teal', border: 'border-teal-500/40 hover:border-teal-400/80 active:border-teal-300', text: 'text-teal-400/80', bg: 'bg-gradient-to-r from-teal-900/30 to-teal-950/50' },
            } : {
              amber: { shine: 'shine-amber', glow: 'glow-amber', border: 'border-amber-400 hover:border-amber-500 active:border-amber-600', text: 'text-amber-600', bg: 'bg-gradient-to-r from-amber-100 to-amber-50' },
              violet: { shine: 'shine-violet', glow: 'glow-violet', border: 'border-violet-400 hover:border-violet-500 active:border-violet-600', text: 'text-violet-600', bg: 'bg-gradient-to-r from-violet-100 to-violet-50' },
              emerald: { shine: 'shine-emerald', glow: 'glow-emerald', border: 'border-emerald-400 hover:border-emerald-500 active:border-emerald-600', text: 'text-emerald-600', bg: 'bg-gradient-to-r from-emerald-100 to-emerald-50' },
              teal: { shine: 'shine-teal', glow: 'glow-teal', border: 'border-teal-400 hover:border-teal-500 active:border-teal-600', text: 'text-teal-600', bg: 'bg-gradient-to-r from-teal-100 to-teal-50' },
            };
            const cc = colorConfig[cat.color] || colorConfig.teal;

            return (
              <button
                key={cat.id}
                onClick={() => handleCategoryClick(cat.id)}
                disabled={available === 0}
                className={`py-3.5 px-4 rounded-2xl text-center transition-colors shine-card ${cc.shine} ${cc.glow} border ${cc.border} ${isFeatured ? (darkMode ? 'starry-bg overflow-hidden' : 'bg-gradient-to-r from-amber-100 to-yellow-50 overflow-hidden') : cc.bg} ${available === 0 ? 'opacity-40' : ''}`}
              >
                <div className={`flex items-center justify-center gap-2.5 ${isFeatured ? 'relative z-10' : ''}`}>
                  <span className="text-xl">{config.icon}</span>
                  <div className={`text-base font-semibold ${TH('text-primary', darkMode)}`}>{config.name}</div>
                </div>
              </button>
            );
          })}

          {/* Surprise me - rose accent */}
          {(() => {
            const progress = getProgress('random');
            const available = progress.binaryUnanswered + progress.mcUnanswered;
            return (
              <button
                onClick={() => handleCategoryClick('random')}
                disabled={available === 0}
                className={`py-3.5 px-4 rounded-2xl text-center transition-colors shine-card shine-rose glow-rose border ${
                  darkMode
                    ? 'border-rose-500/40 hover:border-rose-400/80 active:border-rose-300 bg-gradient-to-r from-rose-900/30 to-rose-950/50'
                    : 'border-rose-400 hover:border-rose-500 active:border-rose-600 bg-gradient-to-r from-rose-100 to-rose-50'
                } ${available === 0 ? 'opacity-40' : ''}`}
              >
                <div className="flex items-center justify-center gap-2.5">
                  <span className="text-xl">âœ¨</span>
                  <div className={`text-base font-semibold ${TH('text-primary', darkMode)}`}>Surprise me</div>
                </div>
              </button>
            );
          })()}
        </div>

        {/* DIVIDER â€” World â†” Self */}
        <div className="flex items-center gap-3 my-4">
          <div className={`flex-1 h-px ${darkMode ? 'bg-white/10' : 'bg-gray-200'}`} />
          <span className={`text-xs font-medium uppercase tracking-wider ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>Self</span>
          <div className={`flex-1 h-px ${darkMode ? 'bg-white/10' : 'bg-gray-200'}`} />
        </div>

        {/* SECTION 2: Self Assessments */}
        <div className="grid grid-cols-2 gap-2.5">
          {/* Reveal Card - cyan/sky accent for self-discovery */}
          <button
            onClick={onAssessments}
            className={`py-3.5 px-4 rounded-2xl text-center transition-colors shine-card shine-blue glow-blue border ${
              darkMode
                ? 'border-blue-500/40 hover:border-blue-400/80 active:border-blue-300 bg-gradient-to-r from-blue-900/30 to-blue-950/50'
                : 'border-blue-300 hover:border-blue-400 bg-gradient-to-r from-blue-50 to-blue-50'
            }`}
          >
            <div className="flex items-center justify-center gap-2.5">
              <span className="text-xl">ðŸªž</span>
              <div className={`text-base font-semibold ${TH('text-primary', darkMode)}`}>Reveal</div>
            </div>
          </button>

          {/* Assessment Surprise Me â€” random test, no picking */}
          <button
            onClick={onAssessSurprise}
            className={`py-3.5 px-4 rounded-2xl text-center transition-colors shine-card shine-violet glow-violet border ${
              darkMode
                ? 'border-violet-500/40 hover:border-violet-400/80 active:border-violet-300 bg-gradient-to-r from-violet-900/30 to-violet-950/50'
                : 'border-violet-400 hover:border-violet-500 active:border-violet-600 bg-gradient-to-r from-violet-100 to-violet-50'
            }`}
          >
            <div className="flex items-center justify-center gap-2.5">
              <span className="text-xl">ðŸŽ²</span>
              <div className={`text-base font-semibold ${TH('text-primary', darkMode)}`}>Surprise me</div>
            </div>
          </button>

        </div>

        {/* DIVIDER â€” Self â†” Work (hidden until tier 3) */}
        {getFeatureTier(assessCompleted, isLoggedIn) >= 3 && (
        <div className="flex items-center gap-3 my-4">
          <div className={`flex-1 h-px ${darkMode ? 'bg-white/10' : 'bg-gray-200'}`} />
          <span className={`text-xs font-medium uppercase tracking-wider ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>Work</span>
          <div className={`flex-1 h-px ${darkMode ? 'bg-white/10' : 'bg-gray-200'}`} />
        </div>
        )}

        {/* SECTION 3: Work Tasks (unlocks at tier 3: 5+ assessments or logged in) */}
        {getFeatureTier(assessCompleted, isLoggedIn) >= 3 && (
        <div className="grid grid-cols-2 gap-2.5">
          <button
            onClick={onVerify}
            className={`py-3.5 px-4 rounded-2xl text-center transition-colors shine-card shine-emerald glow-emerald border ${
              darkMode
                ? 'border-emerald-500/40 hover:border-emerald-400/80 active:border-emerald-300 bg-gradient-to-r from-emerald-900/30 to-emerald-950/50'
                : 'border-emerald-300 hover:border-emerald-400 bg-gradient-to-r from-emerald-50 to-emerald-50'
            }`}
          >
            <div className="flex items-center justify-center gap-2.5">
              <span className="text-xl">ðŸ›¡ï¸</span>
              <div className={`text-base font-semibold ${TH('text-primary', darkMode)}`}>Verify</div>
              {verifyPendingCount > 0 && (
                <span className={`text-xs font-bold px-2 py-0.5 rounded-full ${darkMode ? 'bg-emerald-500/20 text-emerald-400' : 'bg-emerald-100 text-emerald-700'}`}>
                  {verifyPendingCount}
                </span>
              )}
            </div>
          </button>
        </div>
        )}
      </div>

      {/* Scroll fade indicator at bottom */}
      <div className={`pointer-events-none absolute bottom-0 left-0 right-0 h-12 bg-gradient-to-t ${darkMode ? 'from-gray-950' : 'from-gray-100'} to-transparent`} />
    </div>
  );
};

// UndoBar - selected answer bubble sweeps across its row, styled like actual buttons
const UndoBar = ({ darkMode, undoDelay, onUndo, answer, confidence, isBinary, options, fullHeight, requireConfirmation = true }) => {
  const answerText = isBinary
    ? (answer === 0 ? 'YES' : 'NO')
    : `${String.fromCharCode(65 + answer)}. ${options?.[answer] || ''}`;

  // Get the exact button gradient colors based on confidence
  const conf = Math.min(confidence, 4);
  let bgGradient;
  if (isBinary) {
    const yesShades = darkMode
      ? [['#065f46', '#059669'], ['#047857', '#10b981'], ['#059669', '#34d399'], ['#10b981', '#6ee7b7']]
      : [['#a7f3d0', '#6ee7b7'], ['#6ee7b7', '#34d399'], ['#34d399', '#10b981'], ['#10b981', '#059669']];
    const noShades = darkMode
      ? [['#9f1239', '#e11d48'], ['#be123c', '#f43f5e'], ['#e11d48', '#fb7185'], ['#f43f5e', '#fda4af']]
      : [['#fecdd3', '#fda4af'], ['#fda4af', '#fb7185'], ['#fb7185', '#f43f5e'], ['#f43f5e', '#e11d48']];
    const shades = answer === 0 ? yesShades : noShades;
    const s = shades[conf - 1];
    bgGradient = `linear-gradient(135deg, ${s[0]} 0%, ${s[1]} 100%)`;
  } else {
    const color = MC_COLORS[answer % MC_COLORS.length];
    bgGradient = `linear-gradient(135deg, ${color.shades[conf - 1]} 0%, ${color.shades[Math.min(conf, 3)]} 100%)`;
  }

  // Button dimensions accounting for checkmark slots
  // MC: px-4 (16px), with confirmation: gap-1.5 (6px) + checkmark w-9 (36px) = 42px extra on right
  // Y/N: px-4 (16px), outer gap-1.5 (6px) splits halves, each half has button + gap-1.5 + checkmark
  // Y/N with confirmation: button ends 45px before center (3px half-gap + 6px inner gap + 36px checkmark)

  return (
    <div
      onClick={onUndo}
      className={`relative cursor-pointer active:opacity-80 overflow-hidden ${fullHeight ? 'h-full' : 'rounded-xl'}`}
    >
      {/* Light backdrop */}
      <div className={`h-full ${darkMode ? 'bg-gray-900/40' : 'bg-white/40'}`}>
        {/* Selected answer bubble positioned exactly over its button */}
        <div
          className={`absolute overflow-hidden ${isBinary ? 'rounded-xl' : 'rounded-lg'}`}
          style={isBinary ? (requireConfirmation ? {
            // Y/N with confirmation: YES | gap-2 (8px) | submit(44px) | gap-2 (8px) | NO
            top: '12px',
            height: '57px',
            left: answer === 0 ? '16px' : 'calc(50% + 30px)',
            right: answer === 0 ? 'calc(50% + 30px)' : '16px',
          } : {
            // Y/N without confirmation: grid-cols-2 gap-2
            top: '12px',
            height: '57px',
            left: answer === 0 ? '16px' : 'calc(50% + 4px)',
            right: answer === 0 ? 'calc(50% + 4px)' : '16px',
          }) : {
            // MC buttons: wrapper extends 16px past each side (-left-4 -right-4)
            // Need to add 16px to both left and right to compensate
            // Base: 16px (px-4 padding) + 16px (wrapper offset) = 32px
            // Right with checkmark: 32px + 42px (6px gap + 36px checkmark) = 74px
            left: '32px',
            right: requireConfirmation ? '74px' : '32px',
            top: `${12 + answer * 44}px`,
            height: '40px',
          }}
        >
          {/* Button styled exactly like the real answer buttons */}
          <div
            className={`relative h-full flex items-center overflow-hidden ${isBinary ? 'justify-center' : 'px-3 text-base text-white'}`}
            style={{ background: bgGradient }}
          >
            {/* Sweep overlay */}
            <div
              className="absolute inset-0 bg-black/30"
              style={{ animation: `sweepFill ${undoDelay}s linear forwards` }}
            />
            {/* Answer text - match actual button styling */}
            {isBinary ? (
              <div className="relative z-10 flex items-center justify-center gap-1.5">
                <span className="text-2xl font-bold text-white">{answer === 0 ? 'YES' : 'NO'}</span>
                <span className="text-sm font-medium text-white/70">{getStars(confidence)}</span>
              </div>
            ) : (
              <>
                <span className="relative z-10 font-medium mr-1 opacity-60">{String.fromCharCode(65 + answer)}.</span>
                <span className="relative z-10 truncate">{options?.[answer] || ''}</span>
                <span className="absolute top-1/2 right-2 -translate-y-1/2 z-10 text-sm font-bold bg-white/30 w-5 h-5 rounded-full flex items-center justify-center">
                  {confidence}
                </span>
              </>
            )}
          </div>
        </div>
      </div>
    </div>
  );
};

// Tip Banner
const TipBanner = ({ darkMode, onDismiss }) => (
  <div
    onClick={onDismiss}
    className={`rounded-md px-3 py-1 flex items-center justify-between cursor-pointer mb-2 ${
      darkMode ? 'bg-violet-900/30 border border-violet-500/30' : 'bg-violet-100 border border-violet-300'
    }`}
  >
    <span className={`text-sm ${darkMode ? 'text-violet-300' : 'text-violet-700'}`}>
      <span className="font-medium">Tip:</span> Confident? Tap up to four times
    </span>
    <span className={`text-sm ml-2 ${darkMode ? 'text-violet-500' : 'text-violet-400'}`}>âœ•</span>
  </div>
);

// QuestionCard (compact)
const QuestionCard = ({ question, darkMode, evidenceExpanded, onToggleEvidence }) => {
  const category = CATEGORIES.find(c => c.id === question.category);
  const hasEvidence = question.preEvidence && question.preEvidence.length > 0;
  const categoryColors = {
    prediction: darkMode ? 'text-amber-400' : 'text-amber-700',
    reasoning: darkMode ? 'text-violet-400' : 'text-violet-700',
    judgment: darkMode ? 'text-teal-400' : 'text-teal-700',
  };
  const glowRgbMap = { prediction: '245, 158, 11', reasoning: '139, 92, 246', judgment: '20, 184, 166' };
  const glowRgb = question.category ? glowRgbMap[question.category] || '139, 92, 246' : '139, 92, 246';
  return (
    <div className="space-y-2 relative">
      {category && (
        <div className="flex justify-center relative z-10">
          <span className={`text-sm font-medium ${categoryColors[question.category]}`}>{category.icon} {category.name}</span>
        </div>
      )}
      <h2 className={`question-text text-center font-medium relative z-10 ${TH('text-primary', darkMode)}`}>{question.text}</h2>
      {hasEvidence && (
        <div className="relative z-10 mt-1">
          <button
            onClick={onToggleEvidence}
            className={`w-full px-3 py-2 flex items-center justify-center gap-2 rounded-lg transition-colors ${
              darkMode
                ? 'text-gray-400 hover:text-gray-300 hover:bg-white/5'
                : 'text-gray-500 hover:text-gray-600 hover:bg-black/5'
            }`}
          >
            <span className="text-xs">ðŸ“Š</span>
            <span className="text-xs font-medium">
              {evidenceExpanded ? 'Hide' : 'Evidence'} ({question.preEvidence.length})
            </span>
            <span className={`text-[10px] transition-transform duration-200 ${evidenceExpanded ? 'rotate-180' : ''}`}>â–¼</span>
          </button>
          {evidenceExpanded && (
            <div className="mt-2 space-y-2">
              {question.preEvidence.map((item, i) => (
                <div key={i} className={`rounded-lg px-3 py-2.5 ${
                  darkMode
                    ? 'bg-white/[0.04] border border-white/[0.06]'
                    : 'bg-black/[0.03] border border-black/[0.06]'
                }`}>
                  {item.type === 'stat' ? (
                    <div className="flex items-center justify-between">
                      <span className={`text-sm ${TH('text-muted', darkMode)}`}>{item.label}</span>
                      <span className={`text-sm font-semibold ${
                        darkMode ? 'text-emerald-400' : 'text-emerald-600'
                      }`}>{item.value}</span>
                    </div>
                  ) : (
                    <p className={`text-sm italic leading-relaxed ${TH('text-muted', darkMode)}`}>
                      "{item.text}"
                    </p>
                  )}
                </div>
              ))}
            </div>
          )}
        </div>
      )}
    </div>
  );
};

// Binary Answer Buttons â€” Onboarding language: stacked, subtle gradients, glow confidence ramp
const BinaryButtons = ({ darkMode, tappedAnswer, tapCount, isAnswered, currentResponse, onTap, onRightClick, pendingSubmit, requireConfirmation, onSubmit, onClear, category }) => {
  const isOpinion = category === 'judgment';
  const colors = [
    COLOR_HEX[isOpinion ? 'cyan' : 'emerald'],
    COLOR_HEX[isOpinion ? 'violet' : 'rose'],
  ];
  const labels = ['YES', 'NO'];

  const getStyle = (answer) => {
    const c = colors[answer];
    const isSelected = tappedAnswer === answer;
    const isPending = pendingSubmit?.answer === answer;
    const wasAnswered = currentResponse?.answer === answer;
    const otherSelected = tappedAnswer !== null && tappedAnswer !== answer;
    const conf = isSelected ? tapCount : (currentResponse?.confidence || pendingSubmit?.confidence || 2);

    // Committed or pending â€” strong glow at confidence level
    if (wasAnswered || isPending) {
      const r = Math.min(conf, 4);
      const bA = darkMode ? 0.40 + r * 0.10 : 0.50 + r * 0.12;
      return {
        borderColor: `rgba(${c.rgb}, ${bA})`,
        background: darkMode
          ? `linear-gradient(135deg, rgba(${c.rgb},${0.10 + r * 0.05}) 0%, rgba(${c.rgb},${0.05 + r * 0.025}) 100%)`
          : `linear-gradient(135deg, rgba(${c.rgb},${0.14 + r * 0.05}) 0%, rgba(${c.rgb},${0.06 + r * 0.025}) 100%)`,
        boxShadow: `0 0 ${14 + r * 4}px rgba(${c.rgb},${darkMode ? 0.15 + r * 0.05 : 0.18 + r * 0.06}), 0 0 ${30 + r * 5}px rgba(${c.rgb},${darkMode ? 0.08 + r * 0.02 : 0.10 + r * 0.03})`,
      };
    }

    // Active selection â€” confidence ramp: brighter with each tap
    if (isSelected) {
      const r = Math.min(tapCount, 4);
      const bA = darkMode ? 0.30 + r * 0.12 : 0.40 + r * 0.12;
      return {
        borderColor: `rgba(${c.rgb}, ${bA})`,
        background: darkMode
          ? `linear-gradient(135deg, rgba(${c.rgb},${0.06 + r * 0.05}) 0%, rgba(${c.rgb},${0.02 + r * 0.03}) 100%)`
          : `linear-gradient(135deg, rgba(${c.rgb},${0.10 + r * 0.05}) 0%, rgba(${c.rgb},${0.04 + r * 0.03}) 100%)`,
        boxShadow: `0 0 ${12 + r * 4}px rgba(${c.rgb},${darkMode ? 0.10 + r * 0.05 : 0.15 + r * 0.06}), 0 0 ${30 + r * 5}px rgba(${c.rgb},${darkMode ? 0.05 + r * 0.025 : 0.08 + r * 0.03})`,
      };
    }

    // Dimmed â€” other option is selected, or already answered
    if (otherSelected || isAnswered) {
      return {
        borderColor: `rgba(${c.rgb}, ${darkMode ? 0.10 : 0.15})`,
        background: `rgba(${c.rgb}, ${darkMode ? 0.02 : 0.04})`,
        boxShadow: 'none',
        opacity: 0.45,
      };
    }

    // Neutral â€” onboarding unselected
    return {
      borderColor: darkMode ? `rgba(${c.rgb}, 0.25)` : `rgba(${c.rgb}, 0.50)`,
      background: darkMode
        ? `linear-gradient(135deg, rgba(${c.rgb},0.08) 0%, rgba(${c.rgb},0.03) 100%)`
        : `linear-gradient(135deg, rgba(${c.rgb},0.14) 0%, rgba(${c.rgb},0.06) 100%)`,
      boxShadow: darkMode
        ? `0 0 12px rgba(${c.rgb},0.10), 0 0 30px rgba(${c.rgb},0.05)`
        : `0 0 12px rgba(${c.rgb},0.14), 0 0 30px rgba(${c.rgb},0.08)`,
    };
  };

  return (
    <div className="w-full max-w-sm resp-max-w mx-auto space-y-3 resp-gap">
      {[0, 1].map(answer => {
        const c = colors[answer];
        const style = getStyle(answer);
        return (
          <button
            key={answer}
            onClick={() => !isAnswered && !pendingSubmit && onTap(answer)}
            onContextMenu={(e) => onRightClick && onRightClick(e, answer)}
            disabled={isAnswered || pendingSubmit}
            className="w-full h-14 resp-h-lg rounded-2xl flex items-center justify-center relative transition-all btn-feedback shine-card border select-none"
            style={style}
          >
            <span className="resp-text-lg font-semibold" style={{
              color: (tappedAnswer === answer || currentResponse?.answer === answer)
                ? (darkMode ? '#fff' : c.base)
                : (darkMode ? c.light : c.base),
            }}>
              {labels[answer]}
            </span>
            {tappedAnswer === answer && tapCount >= 1 && (
              <span className="absolute right-4 resp-text-sm font-medium opacity-60" style={{ color: darkMode ? c.light : c.base }}>
                {getStars(tapCount)}
              </span>
            )}
          </button>
        );
      })}
    </div>
  );
};

// Multiple Choice Buttons â€” Onboarding language: stacked rounded-2xl, glow confidence ramp
// Supports mcColorMode: 'color' (per-option from MC_COLORS) or 'gray' (neutral until selected)
const MCButtons = ({ options, darkMode, tappedAnswer, tapCount, isAnswered, currentResponse, onTap, onRightClick, pendingSubmit, requireConfirmation, onSubmit, onClear, mcColorMode }) => {
  const mode = mcColorMode || 'gray';

  const getStyle = (index) => {
    const mc = MC_COLORS[index % MC_COLORS.length];
    const c = { rgb: mc.rgb, base: mc.hex, light: mc.shades?.[1] || mc.hex };
    const isSelected = tappedAnswer === index;
    const isPending = pendingSubmit?.answer === index;
    const wasAnswered = currentResponse?.answer === index;
    const otherSelected = tappedAnswer !== null && tappedAnswer !== index;
    const conf = isSelected ? tapCount : (currentResponse?.confidence || pendingSubmit?.confidence || 2);

    // Committed or pending
    if (wasAnswered || isPending) {
      const r = Math.min(conf, 4);
      const bA = darkMode ? 0.40 + r * 0.10 : 0.50 + r * 0.12;
      return {
        borderColor: `rgba(${c.rgb}, ${bA})`,
        background: darkMode
          ? `linear-gradient(135deg, rgba(${c.rgb},${0.10 + r * 0.05}) 0%, rgba(${c.rgb},${0.05 + r * 0.025}) 100%)`
          : `linear-gradient(135deg, rgba(${c.rgb},${0.14 + r * 0.05}) 0%, rgba(${c.rgb},${0.06 + r * 0.025}) 100%)`,
        boxShadow: `0 0 ${14 + r * 4}px rgba(${c.rgb},${darkMode ? 0.15 + r * 0.05 : 0.18 + r * 0.06}), 0 0 ${30 + r * 5}px rgba(${c.rgb},${darkMode ? 0.08 + r * 0.02 : 0.10 + r * 0.03})`,
        textColor: darkMode ? '#fff' : c.base,
      };
    }

    // Active selection â€” confidence ramp
    if (isSelected) {
      const r = Math.min(tapCount, 4);
      const bA = darkMode ? 0.30 + r * 0.12 : 0.40 + r * 0.12;
      return {
        borderColor: `rgba(${c.rgb}, ${bA})`,
        background: darkMode
          ? `linear-gradient(135deg, rgba(${c.rgb},${0.06 + r * 0.05}) 0%, rgba(${c.rgb},${0.02 + r * 0.03}) 100%)`
          : `linear-gradient(135deg, rgba(${c.rgb},${0.10 + r * 0.05}) 0%, rgba(${c.rgb},${0.04 + r * 0.03}) 100%)`,
        boxShadow: `0 0 ${12 + r * 4}px rgba(${c.rgb},${darkMode ? 0.10 + r * 0.05 : 0.15 + r * 0.06}), 0 0 ${30 + r * 5}px rgba(${c.rgb},${darkMode ? 0.05 + r * 0.025 : 0.08 + r * 0.03})`,
        textColor: darkMode ? '#fff' : c.base,
      };
    }

    // Dimmed â€” other is selected or already answered
    if (otherSelected || isAnswered) {
      if (mode === 'gray') {
        return {
          borderColor: darkMode ? 'rgba(255,255,255,0.06)' : 'rgba(0,0,0,0.08)',
          background: darkMode ? 'rgba(255,255,255,0.02)' : 'rgba(0,0,0,0.02)',
          boxShadow: 'none',
          opacity: 0.4,
          textColor: darkMode ? '#6b7280' : '#9ca3af',
        };
      }
      return {
        borderColor: `rgba(${c.rgb}, ${darkMode ? 0.10 : 0.15})`,
        background: `rgba(${c.rgb}, ${darkMode ? 0.02 : 0.04})`,
        boxShadow: 'none',
        opacity: 0.45,
        textColor: darkMode ? c.light : c.base,
      };
    }

    // Neutral â€” gray or colored
    if (mode === 'gray') {
      return {
        borderColor: darkMode ? 'rgba(255,255,255,0.10)' : 'rgba(0,0,0,0.12)',
        background: darkMode ? 'rgba(255,255,255,0.04)' : 'rgba(0,0,0,0.03)',
        boxShadow: 'none',
        textColor: darkMode ? '#d1d5db' : '#1f2937',
      };
    }
    return {
      borderColor: darkMode ? `rgba(${c.rgb}, 0.25)` : `rgba(${c.rgb}, 0.50)`,
      background: darkMode
        ? `linear-gradient(135deg, rgba(${c.rgb},0.08) 0%, rgba(${c.rgb},0.03) 100%)`
        : `linear-gradient(135deg, rgba(${c.rgb},0.14) 0%, rgba(${c.rgb},0.06) 100%)`,
      boxShadow: darkMode
        ? `0 0 12px rgba(${c.rgb},0.10), 0 0 30px rgba(${c.rgb},0.05)`
        : `0 0 12px rgba(${c.rgb},0.14), 0 0 30px rgba(${c.rgb},0.08)`,
      textColor: darkMode ? c.light : c.base,
    };
  };

  return (
    <div className="w-full max-w-sm resp-max-w mx-auto space-y-2.5 resp-gap-sm">
      {options.map((option, index) => {
        const style = getStyle(index);
        return (
          <button
            key={option}
            onClick={() => !isAnswered && !pendingSubmit && onTap(index)}
            onContextMenu={(e) => onRightClick && onRightClick(e, index)}
            disabled={isAnswered || pendingSubmit}
            className="w-full h-12 resp-h-md rounded-2xl flex items-center justify-center relative px-5 transition-all btn-feedback shine-card border select-none"
            style={{
              borderColor: style.borderColor,
              background: style.background,
              boxShadow: style.boxShadow,
              opacity: style.opacity || 1,
            }}
          >
            <span className="resp-text-md font-semibold text-center" style={{ color: style.textColor }}>
              {option}
            </span>
            {tappedAnswer === index && tapCount >= 1 && (
              <span className="absolute right-4 resp-text-sm font-medium opacity-60" style={{ color: style.textColor }}>
                {getStars(tapCount)}
              </span>
            )}
          </button>
        );
      })}
    </div>
  );
};

// ProfileSection - password auth + display name
const ProfileSection = ({ darkMode, onAuthChange }) => {
  const [email, setEmail] = React.useState('');
  const [password, setPassword] = React.useState('');
  const [mode, setMode] = React.useState('view'); // 'view', 'signin', 'signup'
  const [error, setError] = React.useState('');
  const [loading, setLoading] = React.useState(false);
  const [currentEmail, setCurrentEmail] = React.useState(getCurrentEmail());
  const [displayName, setDisplayName] = React.useState(getDisplayName());
  const [editingName, setEditingName] = React.useState(false);
  const [nameInput, setNameInput] = React.useState('');
  const [nameSaving, setNameSaving] = React.useState(false);

  // Listen for auth changes
  React.useEffect(() => {
    const handler = (e) => {
      if (e.detail?.user) {
        setCurrentEmail(e.detail.user.email);
        setMode('view');
        onAuthChange && onAuthChange(e.detail.user);
      } else {
        setCurrentEmail(null);
        setDisplayName(null);
        setEditingName(false);
      }
    };
    window.addEventListener('aura-auth-change', handler);
    return () => window.removeEventListener('aura-auth-change', handler);
  }, [onAuthChange]);

  // Listen for profile changes (display name loaded from cloud)
  React.useEffect(() => {
    const handler = (e) => setDisplayName(e.detail?.displayName || null);
    window.addEventListener('aura-profile-change', handler);
    return () => window.removeEventListener('aura-profile-change', handler);
  }, []);

  const handleSaveName = async () => {
    const trimmed = nameInput.trim();
    if (!trimmed) return;
    const user = getCurrentUser();
    if (!user) return;
    setNameSaving(true);
    const ok = await updateDisplayName(user.id, trimmed);
    setNameSaving(false);
    if (ok) {
      setDisplayName(trimmed);
      setEditingName(false);
    }
  };

  const handleSignIn = async () => {
    if (!email) { setError('Enter your email'); return; }
    if (!password) { setError('Enter your password'); return; }
    setLoading(true);
    setError('');
    const result = await signInWithPassword(email, password);
    setLoading(false);
    if (result.success) {
      setCurrentEmail(result.user?.email || email);
      setMode('view');
      onAuthChange && onAuthChange(result.user);
    } else {
      setError(result.error);
    }
  };

  const handleSignUp = async () => {
    if (!email) { setError('Enter your email'); return; }
    if (!password || password.length < 6) { setError('Password must be at least 6 characters'); return; }
    setLoading(true);
    setError('');
    const result = await signUpWithPassword(email, password);
    setLoading(false);
    if (result.success) {
      setCurrentEmail(result.user?.email || email);
      setMode('view');
      onAuthChange && onAuthChange(result.user);
    } else {
      setError(result.error);
    }
  };

  const handleSignOut = async () => {
    await signOut();
    setCurrentEmail(null);
    onAuthChange && onAuthChange(null);
  };

  const handleKeyDown = (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      if (mode === 'signup') handleSignUp();
      else handleSignIn();
    }
  };

  if (currentEmail) {
    return (
      <div className={`rounded-lg p-3 ${TH('bg-card-shine', darkMode)}`}>
        <div className="flex items-center justify-between">
          <div className={`text-sm font-medium ${TH('text-primary', darkMode)}`}>Profile</div>
          <button onClick={handleSignOut} className={`px-2.5 py-1 rounded-lg text-xs btn-feedback ${darkMode ? 'bg-white/[0.06] text-gray-400' : 'bg-gray-200 text-gray-600'}`}>
            Sign Out
          </button>
        </div>
        {editingName ? (
          <div className="flex items-center gap-2 mt-1">
            <input
              type="text"
              value={nameInput}
              onChange={(e) => setNameInput(e.target.value)}
              onKeyDown={(e) => { if (e.key === 'Enter') handleSaveName(); if (e.key === 'Escape') setEditingName(false); }}
              onFocus={(e) => e.target.select()}
              placeholder="Display name"
              autoFocus
              maxLength={50}
              className={`text-sm px-2 py-1 rounded border flex-1 min-w-0 ${darkMode ? 'bg-white/[0.06] border-white/10 text-white' : 'bg-white border-gray-300 text-gray-900'}`}
            />
            <button onClick={handleSaveName} disabled={nameSaving} className={`text-xs px-2 py-1 rounded btn-feedback ${darkMode ? 'bg-violet-600/40 text-violet-300' : 'bg-violet-100 text-violet-700'}`}>
              {nameSaving ? '...' : 'Save'}
            </button>
            <button onClick={() => setEditingName(false)} className={`text-xs px-1.5 py-1 rounded btn-feedback ${TH('text-faint', darkMode)}`}>
              âœ•
            </button>
          </div>
        ) : (
          <div className="flex items-center justify-between mt-1">
            <div className="flex items-center gap-2">
              <span className={`text-sm font-medium ${TH('text-primary', darkMode)}`}>{displayName || currentEmail}</span>
              <button onClick={() => { setNameInput(displayName || ''); setEditingName(true); }} className={`text-xs px-1.5 py-0.5 rounded btn-feedback ${darkMode ? 'bg-white/[0.06] text-gray-500 hover:text-gray-300' : 'bg-gray-100 text-gray-500 hover:text-gray-700'}`}>
                Edit
              </button>
            </div>
            {displayName && <div className={`text-xs ${TH('text-faint', darkMode)}`}>{currentEmail}</div>}
          </div>
        )}
      </div>
    );
  }

  if (mode === 'view') {
    return (
      <div className={`rounded-lg p-3 ${TH('bg-card-shine', darkMode)}`}>
        <div className={`text-sm font-medium mb-2 ${TH('text-primary', darkMode)}`}>Profile</div>
        <div className={`text-xs mb-2 ${TH('text-faint', darkMode)}`}>Sign in to save progress across devices</div>
        <button onClick={() => setMode('signin')} className={`w-full py-2 rounded-lg text-sm font-medium btn-feedback ${darkMode ? 'bg-violet-900/30 text-violet-400' : 'bg-violet-100 text-violet-600'}`}>
          Sign In
        </button>
      </div>
    );
  }

  // Sign up mode
  if (mode === 'signup') {
    return (
      <div className={`rounded-lg p-3 ${TH('bg-card-shine', darkMode)}`}>
        <div className="flex items-center justify-between mb-2">
          <div className={`text-sm font-medium ${TH('text-primary', darkMode)}`}>Create Account</div>
          <button onClick={() => { setMode('view'); setError(''); }} className={`text-xs ${TH('text-violet', darkMode)}`}>Cancel</button>
        </div>
        <div className="space-y-2">
          <input type="email" placeholder="Email" value={email} onChange={(e) => setEmail(e.target.value)} onKeyDown={handleKeyDown}
            className={`w-full px-3 py-2 rounded-lg text-sm ${darkMode ? 'bg-white/[0.06] text-white placeholder-gray-500' : 'bg-gray-100 text-gray-900 placeholder-gray-400'}`} />
          <input type="password" placeholder="Password" value={password} onChange={(e) => setPassword(e.target.value)} onKeyDown={handleKeyDown}
            className={`w-full px-3 py-2 rounded-lg text-sm ${darkMode ? 'bg-white/[0.06] text-white placeholder-gray-500' : 'bg-gray-100 text-gray-900 placeholder-gray-400'}`} />
          {error && <div className="text-xs text-rose-500">{error}</div>}
          <button onClick={handleSignUp} disabled={loading}
            className={`w-full py-2 rounded-lg text-sm font-medium btn-feedback ${darkMode ? 'bg-violet-600 text-white' : 'bg-violet-500 text-white'} ${loading ? 'opacity-50' : ''}`}>
            {loading ? 'Creating...' : 'Create Account'}
          </button>
          <button onClick={() => { setMode('signin'); setError(''); }} className={`text-xs ${TH('text-violet', darkMode)}`}>
            Already have an account? Sign in
          </button>
        </div>
      </div>
    );
  }

  // Sign in mode
  return (
    <div className={`rounded-lg p-3 ${TH('bg-card-shine', darkMode)}`}>
      <div className="flex items-center justify-between mb-2">
        <div className={`text-sm font-medium ${TH('text-primary', darkMode)}`}>Sign In</div>
        <button onClick={() => { setMode('view'); setError(''); }} className={`text-xs ${TH('text-violet', darkMode)}`}>Cancel</button>
      </div>
      <div className="space-y-2">
        <input type="email" placeholder="Email" value={email} onChange={(e) => setEmail(e.target.value)} onKeyDown={handleKeyDown}
          className={`w-full px-3 py-2 rounded-lg text-sm ${darkMode ? 'bg-white/[0.06] text-white placeholder-gray-500' : 'bg-gray-100 text-gray-900 placeholder-gray-400'}`} />
        <input type="password" placeholder="Password" value={password} onChange={(e) => setPassword(e.target.value)} onKeyDown={handleKeyDown}
          className={`w-full px-3 py-2 rounded-lg text-sm ${darkMode ? 'bg-white/[0.06] text-white placeholder-gray-500' : 'bg-gray-100 text-gray-900 placeholder-gray-400'}`} />
        {error && <div className="text-xs text-rose-500">{error}</div>}
        <button onClick={handleSignIn} disabled={loading}
          className={`w-full py-2 rounded-lg text-sm font-medium btn-feedback ${darkMode ? 'bg-violet-600 text-white' : 'bg-violet-500 text-white'} ${loading ? 'opacity-50' : ''}`}>
          {loading ? 'Signing in...' : 'Sign In'}
        </button>
        <button onClick={() => { setMode('signup'); setError(''); }} className={`text-xs ${TH('text-violet', darkMode)}`}>
          New here? Create account
        </button>
      </div>
    </div>
  );
};

// ==================== VERIFICATION DATA LAYER ====================

const VERIFY_STORAGE_KEY = 'aura-verification-v1';
const verifySaveToStorage = (subjectProfile, evaluations) => {
  try { localStorage.setItem(VERIFY_STORAGE_KEY, JSON.stringify({ subjectProfile, evaluations, savedAt: Date.now() })); } catch {}
};
const verifyLoadFromStorage = () => {
  try { const s = localStorage.getItem(VERIFY_STORAGE_KEY); return s ? JSON.parse(s) : null; } catch { return null; }
};

// VerifyProfileFields removed â€” data collected through dual-purpose gateway questions + verify onboarding flow

/* Evaluator shared: identity check â€” 3 questions on one screen */
const VERIFY_IDENTITY_CHECK = {
  type: 'identity-check',
  text: 'Identity check',
  fields: [
    { id: 'double-life', label: 'Could they game the system?', subtitle: 'Ability to pass off a sybil',
      options: ['Unlikely', 'Maybe', 'Likely'] },
    { id: 'only-account', label: 'Do you believe they only have one account?',
      options: ['Yes', 'Unsure', 'Doubt it'] },
  ],
};

const VERIFY_CONFIDENCE_LABELS = [
  '1 â€” Notable gaps in my knowledge',
  '2 â€” Fairly confident, some uncertainty',
  '3 â€” Very confident, no reason to doubt',
  "4 â€” Certain, I'd stake my reputation",
];

const VERIFY_PATH_A_QUESTIONS = [
  { id: 'a1-connection', text: 'Tell us about your connection', type: 'compact-connection',
    fields: [
      { id: 'a1-relationship', label: 'Relationship', options: ['Family', 'Friend', 'Colleague', 'Neighbor', 'Community', 'Other'] },
      { id: 'a1-duration', label: 'How long', options: ['< 1 year', '1â€“5 years', '5+ years'] },
      { id: 'a1-last-interact', label: 'Last contact', options: ['Recently', 'This year', 'Longer'] },
    ]},
  { id: 'a2-identity', ...VERIFY_IDENTITY_CHECK },
  { id: 'a3-verdict', text: "Do you endorse this as this person's\none unique account?", type: 'verdict',
    verdictOptions: ['Yes', 'No'],
    flags: ["Haven't seen them in a while", 'Only know one context', 'Something feels off', 'Other'] },
];

const VERIFY_PATH_B_QUESTIONS = [
  { id: 'b1-how-meet', text: 'How did you meet?', type: 'single', options: ['In person', 'Video call', 'Text-chat only'] },
  { id: 'b1-who-init', text: 'Who initiated?', type: 'single', options: ['They came to me', 'I reached out', 'Mutual'] },
  { id: 'b1-context', text: 'Brief context â€” where and when?', type: 'text', placeholder: 'e.g. Coffee shop downtown, last Tuesday' },
  { id: 'b2-evidence', text: 'What evidence do you have?', type: 'evidence-combined',
    sections: [
      { label: 'Directly observed', options: ['Physically present â€” clearly a real person', 'Specific details â€” talked about their life naturally', 'Recognized â€” others at the scene knew them', 'Hard to fake â€” showed something convincing', 'Nothing direct'] },
      { label: 'Supporting evidence', options: ['Social graph â€” looks authentic', 'Connections â€” already in Aura', 'Referral â€” from someone I trust', 'Profile â€” matches what I observed', 'Nothing supporting'] },
    ]},
  { id: 'b3-identity', ...VERIFY_IDENTITY_CHECK },
  { id: 'b4-verdict', text: "Do you endorse this as this person's\none unique account?", type: 'verdict',
    verdictOptions: ['Yes', 'No'],
    flags: ['Only met once', 'One context only', 'Kept things guarded', 'Could game the system', 'Something feels off', 'Other'] },
];

const VERIFY_PATH_C_QUESTIONS = [
  { id: 'c1-sources', text: 'What are you working from?', type: 'multi', subtitle: 'Toggle all that apply.',
    options: ['Self-attestation', 'Connections â€” social graph imports', "Evaluators â€” other people's assessments", 'Referral chain', 'Activity history', 'Other'] },
  { id: 'c2-looks-real', text: 'Does this profile look like a real, unique person?', type: 'star-confidence' },
  { id: 'c3-strongest', text: "Strongest signals?", type: 'multi', subtitle: 'Pick up to two.', maxSelect: 2,
    options: ['Connections â€” rich, verified network', 'Self-attestation â€” believable story', 'Evaluators â€” multiple already confident', 'Referral chain â€” strong and traceable', 'Other'] },
  { id: 'c3-weakest', text: "Biggest gaps?", type: 'multi', subtitle: 'Pick up to two.', maxSelect: 2,
    options: ['Connections â€” thin network', 'Verification â€” no in-person check', 'History â€” new profile, little activity', 'Attestation â€” generic, nothing specific', 'Other'] },
  { id: 'c4-verdict', text: "Do you endorse this as this person's\none unique account?", type: 'verdict',
    verdictOptions: ['Yes', 'No'],
    flags: ['Thin profile', 'Looks like other fakes', 'Something feels off', 'Other'] },
];

const VERIFY_PATH_CONFIG = {
  A: { label: 'Vouching', color: 'cyan', questions: VERIFY_PATH_A_QUESTIONS },
  B: { label: 'Investigation', color: 'amber', questions: VERIFY_PATH_B_QUESTIONS },
  C: { label: 'Analysis', color: 'slate', questions: VERIFY_PATH_C_QUESTIONS },
};

const VERIFY_MOCK_SUBJECTS = [
  { id: 'mock-1', name: 'Alex Rivera', city: 'Portland, OR', country: 'United States', connections: 14,
    availability: { video: true, meet: true, vouch: true } },
  { id: 'mock-2', name: 'Priya Sharma', city: 'Bangalore', country: 'India', connections: 8,
    availability: { video: true, meet: false, vouch: true } },
  { id: 'mock-3', name: 'Marcus Chen', city: 'Toronto', country: 'Canada', connections: 0, availability: null },
  { id: 'mock-4', name: 'Sofia Andersson', city: 'Stockholm', country: 'Sweden', connections: 22,
    availability: { video: true, meet: true, vouch: true } },
  { id: 'mock-5', name: 'Jordan Lee', city: 'Austin, TX', country: 'United States', connections: 5,
    availability: { video: true, meet: false, vouch: false } },
  { id: 'mock-6', name: 'Aisha Okafor', city: 'Lagos', country: 'Nigeria', connections: 31,
    availability: { video: true, meet: true, vouch: true } },
  { id: 'mock-7', name: 'David Kowalski', city: 'Berlin', country: 'Germany', connections: 11,
    availability: { video: true, meet: true, vouch: false } },
  { id: 'mock-8', name: 'Luna Martinez', city: 'Mexico City', country: 'Mexico', connections: 3,
    availability: { video: false, meet: false, vouch: true } },
];

// ==================== VERIFICATION COMPONENTS ====================

// Shared: VerifySubjectBanner â€” who you're evaluating
const VerifySubjectBanner = ({ subject, color, darkMode }) => {
  const [expanded, setExpanded] = useState(false);
  if (!subject) return null;
  const c = COLOR_HEX[color] || COLOR_HEX.emerald;
  return (
    <div className="w-full mb-3">
      <button onClick={() => setExpanded(!expanded)}
        className="w-full flex items-center gap-2.5 px-3 py-2 rounded-xl transition-all duration-200"
        style={{
          background: darkMode ? 'rgba(255,255,255,0.03)' : 'rgba(0,0,0,0.02)',
          border: darkMode ? '1px solid rgba(255,255,255,0.06)' : '1px solid rgba(0,0,0,0.06)',
        }}>
        <div className="w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold flex-shrink-0"
          style={{ background: `rgba(${c.rgb}, 0.2)`, color: darkMode ? c.light : c.base }}>
          {subject.name[0]}
        </div>
        <div className="flex-1 min-w-0 text-left">
          <div className={`text-sm font-semibold truncate ${darkMode ? 'text-white' : 'text-gray-900'}`}>{subject.name}</div>
          <div className={`text-xs truncate ${darkMode ? 'text-white/40' : 'text-gray-500'}`}>
            {subject.city}{subject.connections > 0 ? ` Â· ${subject.connections} connections` : ''}
          </div>
        </div>
        <svg width="12" height="12" viewBox="0 0 12 12" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round"
          className={`flex-shrink-0 transition-transform duration-200 ${expanded ? 'rotate-180' : ''}`}
          style={{ color: darkMode ? 'rgba(255,255,255,0.25)' : 'rgba(0,0,0,0.25)' }}>
          <path d="M3 4.5L6 7.5L9 4.5" />
        </svg>
      </button>
      {expanded && subject.availability && (
        <div className="flex gap-2 mt-1.5 px-1" style={{ animation: 'fadeSlideIn 0.2s ease-out both' }}>
          {subject.availability.video && <span className={`text-xs px-2 py-0.5 rounded-full ${darkMode ? 'bg-white/[0.06] text-white/40' : 'bg-gray-100 text-gray-500'}`}>Video</span>}
          {subject.availability.meet && <span className={`text-xs px-2 py-0.5 rounded-full ${darkMode ? 'bg-white/[0.06] text-white/40' : 'bg-gray-100 text-gray-500'}`}>In-person</span>}
          {subject.availability.vouch && <span className={`text-xs px-2 py-0.5 rounded-full ${darkMode ? 'bg-white/[0.06] text-white/40' : 'bg-gray-100 text-gray-500'}`}>Has voucher</span>}
        </div>
      )}
    </div>
  );
};

// Shared: VerifyScreenLayout â€” split layout with ambient glow, content top, buttons bottom
const VerifyScreenLayout = ({ darkMode, color, sectionLabel, progress, total, onBack, children, buttons, subject }) => {
  const c = COLOR_HEX[color] || COLOR_HEX.violet;
  return (
    <div className={`flex-1 flex flex-col relative overflow-hidden ${TH('bg-main', darkMode)}`}>
      {/* Ambient breathing glow */}
      <div className="absolute inset-0 flex items-center justify-center pointer-events-none" style={{ marginTop: '-8%' }}>
        <div style={{
          position: 'absolute', width: 420, height: 420, borderRadius: '50%',
          background: darkMode
            ? `radial-gradient(circle, rgba(${c.rgb},0.18) 0%, rgba(${c.rgb},0.06) 35%, transparent 65%)`
            : `radial-gradient(circle, rgba(${c.rgb},0.12) 0%, rgba(${c.rgb},0.04) 35%, transparent 65%)`,
          animation: 'aura-breathe 8s ease-in-out infinite',
        }} />
        <div style={{
          position: 'absolute', width: 350, height: 350, borderRadius: '50%',
          background: darkMode
            ? `radial-gradient(circle, rgba(${c.rgb},0.10) 0%, rgba(${c.rgb},0.03) 40%, transparent 65%)`
            : `radial-gradient(circle, rgba(${c.rgb},0.08) 0%, rgba(${c.rgb},0.02) 40%, transparent 65%)`,
          animation: 'aura-breathe 6s ease-in-out infinite 1s',
        }} />
      </div>
      {onBack && (
        <button onClick={onBack}
          className={`absolute top-4 left-4 z-50 w-8 h-8 flex items-center justify-center rounded-full transition-all duration-200 ${
            darkMode ? 'bg-white/[0.06] border border-white/[0.08] text-white/40 hover:text-white/70 hover:bg-white/[0.1]'
                     : 'bg-black/[0.04] border border-black/[0.08] text-gray-400 hover:text-gray-600 hover:bg-black/[0.06]'
          }`}>
          <svg width="14" height="14" viewBox="0 0 14 14" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
            <path d="M9 2L4 7L9 12" />
          </svg>
        </button>
      )}
      <div className="relative z-10 flex flex-col h-full w-full">
        <div className="flex-1 overflow-y-auto flex flex-col items-center w-full">
          <div className="w-full max-w-sm mx-auto px-5 pt-12 pb-4 flex flex-col items-center">
            {(sectionLabel || (progress !== undefined && total !== undefined)) && (() => {
              const sc = COLOR_HEX[color] || COLOR_HEX.violet;
              const pct = total > 0 ? ((progress + 1) / total) * 100 : 0;
              return (
                <div className="flex items-center gap-3 w-full mb-3">
                  {sectionLabel && (
                    <div className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium flex-shrink-0 whitespace-nowrap"
                      style={{
                        background: darkMode ? `rgba(${sc.rgb}, 0.12)` : `rgba(${sc.rgb}, 0.08)`,
                        color: darkMode ? sc.light : sc.base,
                        border: `1px solid ${darkMode ? `rgba(${sc.rgb}, 0.2)` : `rgba(${sc.rgb}, 0.15)`}`
                      }}>
                      {sectionLabel}
                    </div>
                  )}
                  {(progress !== undefined && total !== undefined) && (<>
                    <div className={`flex-1 h-1 rounded-full overflow-hidden ${darkMode ? 'bg-white/[0.06]' : 'bg-black/[0.06]'}`}>
                      <div className="h-full rounded-full transition-all duration-500 ease-out"
                        style={{ width: `${pct}%`, background: `linear-gradient(90deg, ${sc.base}, ${sc.light})` }} />
                    </div>
                    <span className={`text-xs font-medium flex-shrink-0 tabular-nums ${TH('text-subtle', darkMode)}`}>{progress + 1}/{total}</span>
                  </>)}
                </div>
              );
            })()}
            {subject && <VerifySubjectBanner subject={subject} color={color} darkMode={darkMode} />}
            {children}
          </div>
        </div>
        {buttons && (
          <div className="flex-shrink-0 w-full max-w-sm mx-auto px-5 pb-6 pt-3">
            {buttons}
          </div>
        )}
      </div>
    </div>
  );
};

// Shared: VerifyActionButton
const VerifyActionButton = ({ label, color, darkMode, onClick, disabled, secondary }) => {
  const c = COLOR_HEX[color] || COLOR_HEX.violet;
  if (secondary) {
    return (
      <button onClick={onClick} disabled={disabled}
        className={`w-full h-14 resp-h-lg rounded-2xl font-medium resp-text-md transition-all duration-200 disabled:opacity-30 hover-glow hover-glow-${color}`}
        style={{
          background: darkMode ? `rgba(${c.rgb}, 0.08)` : `rgba(${c.rgb}, 0.06)`,
          border: `1px solid ${darkMode ? `rgba(${c.rgb}, 0.25)` : `rgba(${c.rgb}, 0.2)`}`,
          color: darkMode ? c.light : c.base,
        }}>
        {label}
      </button>
    );
  }
  return (
    <button onClick={onClick} disabled={disabled}
      className={`w-full h-14 resp-h-lg rounded-2xl font-semibold resp-text-md transition-all duration-200 disabled:opacity-30 hover-glow hover-glow-${color}`}
      style={{
        background: darkMode
          ? `linear-gradient(135deg, rgba(${c.rgb}, 0.3), rgba(${c.rgb}, 0.15))`
          : `linear-gradient(135deg, rgba(${c.rgb}, 0.85), rgba(${c.rgb}, 0.65))`,
        border: `1px solid rgba(${c.rgb}, ${darkMode ? 0.35 : 0.5})`,
        color: '#fff',
        boxShadow: darkMode
          ? `0 0 20px rgba(${c.rgb}, 0.15), 0 0 60px rgba(${c.rgb}, 0.05)`
          : `0 0 12px rgba(${c.rgb}, 0.2)`,
      }}>
      {label}
    </button>
  );
};

// Shared: VerifyOptionButton
const VerifyOptionButton = ({ label, selected, color, darkMode, onClick }) => {
  const c = COLOR_HEX[color] || COLOR_HEX.violet;
  const dashRe = / [â€”\u2014] /;
  const parts = dashRe.test(label) ? label.split(dashRe) : null;
  return (
    <button onClick={onClick}
      className={`w-full rounded-2xl text-left px-4 transition-all duration-200 hover-glow hover-glow-${color} ${parts ? 'py-3' : 'h-14 resp-h-lg font-medium resp-text-md'}`}
      style={{
        background: selected
          ? `linear-gradient(135deg, rgba(${c.rgb}, 0.25), rgba(${c.rgb}, 0.12))`
          : darkMode ? 'rgba(255,255,255,0.04)' : 'rgba(0,0,0,0.03)',
        border: selected
          ? `1px solid rgba(${c.rgb}, 0.45)`
          : darkMode ? '1px solid rgba(255,255,255,0.06)' : '1px solid rgba(0,0,0,0.06)',
        color: selected ? (darkMode ? '#fff' : c.base) : (darkMode ? 'rgba(255,255,255,0.7)' : 'rgba(0,0,0,0.7)'),
        boxShadow: selected ? `0 0 16px rgba(${c.rgb}, 0.12)` : 'none',
      }}>
      {parts ? (
        <span className="flex flex-col gap-0.5">
          <span className="font-semibold resp-text-md">{parts[0]}</span>
          <span className="font-normal resp-text-sm" style={{ opacity: 0.6 }}>{parts[1]}</span>
        </span>
      ) : label}
    </button>
  );
};

// Shared: VerifyStarConfidence â€” 1-4 confidence selector
const VerifyStarConfidence = ({ color, darkMode, value, onChange }) => {
  const c = COLOR_HEX[color] || COLOR_HEX.violet;
  const labels = ['Gaps', 'Fair', 'Confident', 'Certain'];
  return (
    <div className="flex flex-col items-center gap-4 w-full" style={{ animation: 'fadeSlideIn 0.4s ease-out both' }}>
      <div className="flex items-start justify-center gap-5">
        {[1, 2, 3, 4].map(level => {
          const isSelected = value !== undefined && level <= value;
          const isCurrent = value === level;
          const intensity = [0.25, 0.4, 0.55, 0.75][level - 1];
          const glowSize = [12, 18, 24, 32][level - 1];
          const borderAlpha = [0.35, 0.45, 0.6, 0.75][level - 1];
          return (
            <button key={level} onClick={() => onChange(level)} className="flex flex-col items-center gap-2 transition-all duration-200">
              <div className="w-11 h-11 rounded-full flex items-center justify-center text-sm font-semibold transition-all duration-300"
                style={{
                  background: isSelected
                    ? `linear-gradient(135deg, rgba(${c.rgb}, ${intensity}), rgba(${c.rgb}, ${intensity * 0.5}))`
                    : darkMode ? 'rgba(255,255,255,0.08)' : 'rgba(0,0,0,0.06)',
                  border: isSelected
                    ? `1.5px solid rgba(${c.rgb}, ${borderAlpha})`
                    : darkMode ? '1px solid rgba(255,255,255,0.1)' : '1px solid rgba(0,0,0,0.08)',
                  color: isSelected ? '#fff' : (darkMode ? 'rgba(255,255,255,0.35)' : 'rgba(0,0,0,0.35)'),
                  boxShadow: isSelected
                    ? `0 0 ${glowSize}px rgba(${c.rgb}, ${intensity * 0.5}), 0 0 ${glowSize * 2}px rgba(${c.rgb}, ${intensity * 0.15})${isCurrent ? `, inset 0 0 8px rgba(255,255,255,0.15)` : ''}`
                    : 'none',
                }}>
                {level}
              </div>
              <span className="text-xs font-medium transition-colors duration-200"
                style={{ color: isSelected ? (darkMode ? c.light : c.base) : (darkMode ? 'rgba(255,255,255,0.3)' : 'rgba(0,0,0,0.3)') }}>
                {labels[level - 1]}
              </span>
            </button>
          );
        })}
      </div>
      {value !== undefined && (
        <div className="text-center text-sm font-medium px-4 py-2.5 rounded-xl" style={{
          animation: 'fadeSlideIn 0.3s ease-out both',
          background: darkMode ? `rgba(${c.rgb}, 0.1)` : `rgba(${c.rgb}, 0.08)`,
          color: darkMode ? c.light : c.base,
          border: `1px solid ${darkMode ? `rgba(${c.rgb}, 0.15)` : `rgba(${c.rgb}, 0.12)`}`
        }}>
          {VERIFY_CONFIDENCE_LABELS[value - 1]}
        </div>
      )}
    </div>
  );
};

// Shared: VerifyVerdict â€” yes/no + confidence + expandable flags
const VerifyVerdict = ({ question, color, darkMode, answer, onAnswer }) => {
  const c = COLOR_HEX[color] || COLOR_HEX.violet;
  const val = answer || {};
  const verdict = val.verdict;
  const confidence = val.confidence;
  const flags = val.flags || [];
  const [showFlags, setShowFlags] = useState(false);
  const setField = (field, v) => onAnswer({ ...val, [field]: v });
  const toggleFlag = (flag) => {
    const next = flags.includes(flag) ? flags.filter(f => f !== flag) : [...flags, flag];
    onAnswer({ ...val, flags: next });
  };
  return (
    <div className="flex flex-col items-center gap-5 w-full" style={{ animation: 'fadeSlideIn 0.4s ease-out both' }}>
      <div className="flex gap-3 w-full">
        {(question.verdictOptions || ['Yes', 'No']).map((opt, i) => {
          const isYes = i === 0;
          const sel = verdict === opt;
          const vc = isYes ? (COLOR_HEX.emerald || c) : (COLOR_HEX.rose || c);
          return (
            <button key={opt} onClick={() => setField('verdict', opt)}
              className={`flex-1 py-4 rounded-2xl font-semibold text-base transition-all duration-200`}
              style={{
                background: sel
                  ? `linear-gradient(135deg, rgba(${vc.rgb}, 0.25), rgba(${vc.rgb}, 0.1))`
                  : darkMode ? 'rgba(255,255,255,0.04)' : 'rgba(0,0,0,0.03)',
                border: sel
                  ? `1.5px solid rgba(${vc.rgb}, 0.5)`
                  : darkMode ? '1px solid rgba(255,255,255,0.06)' : '1px solid rgba(0,0,0,0.06)',
                color: sel ? (darkMode ? '#fff' : vc.base) : (darkMode ? 'rgba(255,255,255,0.5)' : 'rgba(0,0,0,0.4)'),
                boxShadow: sel ? `0 0 20px rgba(${vc.rgb}, 0.15)` : 'none',
              }}>
              {opt}
            </button>
          );
        })}
      </div>
      {verdict && (
        <div className="w-full" style={{ animation: 'fadeSlideIn 0.3s ease-out both' }}>
          <p className={`text-xs text-center mb-4 ${TH('text-muted', darkMode)}`}>How sure are you?</p>
          <VerifyStarConfidence color={color} darkMode={darkMode} value={confidence} onChange={v => setField('confidence', v)} />
        </div>
      )}
      {verdict && question.flags && (
        <div className="w-full" style={{ animation: 'fadeSlideIn 0.3s ease-out both 0.1s' }}>
          <button onClick={() => setShowFlags(!showFlags)}
            className={`w-full flex items-center justify-between px-4 py-3 rounded-2xl transition-all duration-200`}
            style={{
              background: (showFlags || flags.length > 0)
                ? (darkMode ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.03)')
                : (darkMode ? 'rgba(255,255,255,0.02)' : 'rgba(0,0,0,0.015)'),
              border: flags.length > 0
                ? `1px solid rgba(${(COLOR_HEX.amber || c).rgb}, 0.3)`
                : (darkMode ? '1px solid rgba(255,255,255,0.06)' : '1px solid rgba(0,0,0,0.06)'),
            }}>
            <span className={`text-sm font-medium ${flags.length > 0 ? (darkMode ? 'text-amber-400' : 'text-amber-600') : TH('text-muted', darkMode)}`}>
              {flags.length > 0 ? `${flags.length} concern${flags.length > 1 ? 's' : ''} flagged` : 'Anything feel off?'}
            </span>
            <svg width="12" height="12" viewBox="0 0 12 12" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round"
              className={`transition-transform duration-200 ${showFlags ? 'rotate-180' : ''}`}
              style={{ color: darkMode ? 'rgba(255,255,255,0.3)' : 'rgba(0,0,0,0.3)' }}>
              <path d="M3 4.5L6 7.5L9 4.5" />
            </svg>
          </button>
          {showFlags && (
            <div className="mt-2" style={{ display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '8px', animation: 'fadeSlideIn 0.2s ease-out both' }}>
              {question.flags.map(flag => {
                const isOn = flags.includes(flag);
                const ac = COLOR_HEX.amber || c;
                return (
                  <button key={flag} onClick={() => toggleFlag(flag)}
                    className="px-3 py-2.5 rounded-xl text-sm font-medium transition-all duration-200 text-center"
                    style={{
                      background: isOn ? `rgba(${ac.rgb}, 0.2)` : (darkMode ? 'rgba(255,255,255,0.04)' : 'rgba(0,0,0,0.025)'),
                      border: isOn ? `1px solid rgba(${ac.rgb}, 0.4)` : (darkMode ? '1px solid rgba(255,255,255,0.08)' : '1px solid rgba(0,0,0,0.06)'),
                      color: isOn ? (darkMode ? '#fbbf24' : '#d97706') : (darkMode ? 'rgba(255,255,255,0.5)' : 'rgba(0,0,0,0.45)'),
                    }}>
                    {flag}
                  </button>
                );
              })}
            </div>
          )}
        </div>
      )}
    </div>
  );
};

// Shared: Question type renderers for verify flows
const VerifySingleSelect = ({ question, color, darkMode, answer, onAnswer, answers }) => {
  const opts = question.dynamicOptions ? question.dynamicOptions(answers || {}) : question.options;
  return (
    <div className="flex flex-col gap-2 w-full" style={{ animation: 'fadeSlideIn 0.4s ease-out both' }}>
      {opts.map((opt) => (
        <VerifyOptionButton key={opt} label={opt} selected={answer === opt} color={color} darkMode={darkMode} onClick={() => onAnswer(opt)} />
      ))}
    </div>
  );
};

// Toggle-based multi-select â€” all options visible with toggle switches, Continue button
const VerifyMultiToggle = ({ question, color, darkMode, answer, onAnswer }) => {
  const selected = Array.isArray(answer) ? answer : (answer && typeof answer === 'object' ? answer.items || [] : []);
  const otherText = (answer && typeof answer === 'object') ? answer.otherText || '' : '';
  const maxSelect = question.maxSelect || Infinity;
  const c = COLOR_HEX[color] || COLOR_HEX.violet;
  const hasOther = question.hasOtherInput;
  const toggle = (opt) => {
    let next;
    if (selected.includes(opt)) { next = selected.filter(x => x !== opt); }
    else { if (selected.length >= maxSelect) return; next = [...selected, opt]; }
    if (hasOther) { onAnswer({ items: next, otherText: next.includes('Other') ? otherText : '' }); }
    else { onAnswer(next); }
  };
  return (
    <div className="flex flex-col gap-2 w-full" style={{ animation: 'fadeSlideIn 0.4s ease-out both' }}>
      {question.options.map((opt) => (
        <VerifyToggleSwitch key={opt} label={opt} color={color} darkMode={darkMode}
          isOn={selected.includes(opt)} onToggle={() => toggle(opt)} />
      ))}
      {hasOther && selected.includes('Other') && (
        <input type="text" value={otherText}
          onChange={e => onAnswer({ items: selected, otherText: e.target.value })}
          placeholder="Please specify..."
          className={`w-full h-12 rounded-2xl px-4 text-sm font-medium outline-none ${TH('bg-input', darkMode)}`}
          style={{ borderColor: `rgba(${c.rgb}, 0.3)` }} autoFocus />
      )}
    </div>
  );
};

const VerifyTextInput = ({ question, color, darkMode, answer, onAnswer, onContinue }) => {
  const c = COLOR_HEX[color] || COLOR_HEX.violet;
  const inputRef = React.useRef(null);
  React.useEffect(() => { if (inputRef.current) inputRef.current.focus(); }, [question.id]);
  return (
    <div className="flex flex-col gap-4 w-full" style={{ animation: 'fadeSlideIn 0.4s ease-out both' }}>
      <input ref={inputRef} type="text" value={answer || ''} onChange={e => onAnswer(e.target.value)}
        onKeyDown={e => { if (e.key === 'Enter' && (answer || '').trim()) onContinue(); }}
        onDoubleClick={() => { if (IS_DEV) { onAnswer(answer || '(skipped)'); setTimeout(onContinue, 50); } }}
        placeholder={question.placeholder || ''}
        className={`w-full h-14 rounded-2xl px-5 text-sm font-medium outline-none transition-all duration-200 ${TH('bg-input', darkMode)}`}
        style={{ border: darkMode ? '1px solid rgba(255,255,255,0.08)' : '1px solid rgba(0,0,0,0.08)' }}
        onFocus={e => { e.target.style.borderColor = `rgba(${c.rgb}, 0.4)`; e.target.style.boxShadow = `0 0 12px rgba(${c.rgb}, 0.1)`; }}
        onBlur={e => { e.target.style.borderColor = darkMode ? 'rgba(255,255,255,0.08)' : 'rgba(0,0,0,0.08)'; e.target.style.boxShadow = 'none'; }}
      />
    </div>
  );
};

const VerifyToggleSwitch = ({ label, subtitle, color, darkMode, isOn, onToggle }) => {
  const c = COLOR_HEX[color] || COLOR_HEX.violet;
  return (
    <button onClick={onToggle}
      className={`w-full flex items-center justify-between rounded-2xl px-4 py-3.5 transition-all duration-200 hover-glow hover-glow-${color}`}
      style={{
        background: isOn
          ? `linear-gradient(135deg, rgba(${c.rgb}, 0.2), rgba(${c.rgb}, 0.08))`
          : darkMode ? 'rgba(255,255,255,0.04)' : 'rgba(0,0,0,0.03)',
        border: isOn
          ? `1px solid rgba(${c.rgb}, 0.35)`
          : darkMode ? '1px solid rgba(255,255,255,0.06)' : '1px solid rgba(0,0,0,0.06)',
      }}>
      <div className="text-left pr-3 flex-1">
        {(() => { const dashRe = / [â€”\u2014] /; const p = dashRe.test(label) ? label.split(dashRe) : null;
          return p ? (<><span className={`text-sm font-semibold block ${darkMode ? 'text-white/90' : 'text-gray-900'}`}>{p[0]}</span>
            <span className={`text-xs block mt-0.5 ${darkMode ? 'text-white/45' : 'text-gray-500'}`}>{p[1]}</span></>)
            : (<span className={`text-sm font-medium block ${darkMode ? 'text-white/80' : 'text-gray-800'}`}>{label}</span>);
        })()}
        {subtitle && <span className={`text-xs block mt-0.5 ${darkMode ? 'text-white/35' : 'text-gray-400'}`}>{subtitle}</span>}
      </div>
      <div className="w-11 h-6 rounded-full relative transition-all duration-200 flex-shrink-0"
        style={{ background: isOn ? `rgba(${c.rgb}, 0.5)` : darkMode ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)' }}>
        <div className="absolute top-0.5 w-5 h-5 rounded-full bg-white transition-all duration-200 shadow-sm"
          style={{ left: isOn ? '21px' : '2px' }} />
      </div>
    </button>
  );
};

// VerifyHub â€” evaluation queue with search, expert toggle, and history
const VerifyHub = ({ darkMode, onBack, subjects, evaluations, onSelect, onViewCompleted, expertMode, setExpertMode, completedCount }) => {
  const c = COLOR_HEX.emerald;
  const [search, setSearch] = useState('');
  const [showAllCompleted, setShowAllCompleted] = useState(false);
  const [showAllPending, setShowAllPending] = useState(false);
  const PENDING_COLLAPSE = 3;
  const pending = subjects.filter(s => !evaluations[s.id])
    .sort((a, b) => {
      // Priority: more connections + more availability = higher priority
      const avail = s => (s.availability ? [s.availability.video, s.availability.meet, s.availability.vouch].filter(Boolean).length : 0);
      const scoreA = (a.connections || 0) + avail(a) * 10;
      const scoreB = (b.connections || 0) + avail(b) * 10;
      return scoreB - scoreA;
    });
  const completed = subjects.filter(s => !!evaluations[s.id]);
  const filtered = search.trim()
    ? subjects.filter(s => s.name.toLowerCase().includes(search.toLowerCase()) || s.city.toLowerCase().includes(search.toLowerCase()))
    : null;
  const showList = filtered || (showAllPending ? pending : pending.slice(0, PENDING_COLLAPSE));

  const SubjectCard = ({ subject, isDone }) => {
    const sc = isDone ? COLOR_HEX.emerald : COLOR_HEX.violet;
    return (
      <button onClick={() => isDone ? (onViewCompleted && onViewCompleted(subject.id)) : onSelect(subject.id)}
        className={`w-full rounded-2xl p-3.5 text-left transition-all duration-200 hover-glow hover-glow-${isDone ? 'emerald' : 'violet'}`}
        style={{
          background: darkMode ? 'rgba(255,255,255,0.04)' : 'rgba(0,0,0,0.02)',
          border: darkMode ? '1px solid rgba(255,255,255,0.06)' : '1px solid rgba(0,0,0,0.06)',
        }}>
        <div className="flex items-center gap-3">
          <div className="w-9 h-9 rounded-full flex items-center justify-center text-xs font-bold flex-shrink-0"
            style={{ background: `rgba(${sc.rgb}, 0.2)`, color: darkMode ? sc.light : sc.base }}>
            {subject.name[0]}
          </div>
          <div className="flex-1 min-w-0">
            <div className={`text-sm font-semibold ${TH('text-primary', darkMode)}`}>{subject.name}</div>
            <div className={`text-xs ${TH('text-subtle', darkMode)}`}>
              {subject.city}{subject.connections > 0 ? ` Â· ${subject.connections} connections` : ''}
            </div>
          </div>
          {isDone ? (
            <span className={`text-xs font-medium px-2 py-0.5 rounded-full flex-shrink-0 ${darkMode ? 'bg-emerald-500/20 text-emerald-400' : 'bg-emerald-100 text-emerald-700'}`}>Done</span>
          ) : (
            <svg width="14" height="14" viewBox="0 0 14 14" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"
              className="flex-shrink-0" style={{ color: darkMode ? 'rgba(255,255,255,0.2)' : 'rgba(0,0,0,0.2)' }}>
              <path d="M5 2L10 7L5 12" />
            </svg>
          )}
        </div>
      </button>
    );
  };

  return (
    <div className={`flex-1 flex flex-col relative overflow-hidden ${TH('bg-main', darkMode)}`}>
      {/* Ambient glow */}
      <div className="absolute inset-0 flex items-center justify-center pointer-events-none" style={{ marginTop: '-12%' }}>
        <div style={{
          position: 'absolute', width: 420, height: 420, borderRadius: '50%',
          background: darkMode
            ? `radial-gradient(circle, rgba(${c.rgb}, 0.14) 0%, rgba(${c.rgb}, 0.06) 35%, transparent 65%)`
            : `radial-gradient(circle, rgba(${c.rgb}, 0.10) 0%, rgba(${c.rgb}, 0.04) 35%, transparent 65%)`,
          animation: 'aura-breathe 8s ease-in-out infinite',
        }} />
      </div>
      {/* Back button */}
      {onBack && (
        <button onClick={onBack}
          className={`absolute top-4 left-4 z-50 w-8 h-8 flex items-center justify-center rounded-full transition-all duration-200 ${
            darkMode ? 'bg-white/[0.06] border border-white/[0.08] text-white/40 hover:text-white/70 hover:bg-white/[0.1]'
                     : 'bg-black/[0.04] border border-black/[0.08] text-gray-400 hover:text-gray-600 hover:bg-black/[0.06]'}`}>
          <svg width="14" height="14" viewBox="0 0 14 14" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><path d="M9 2L4 7L9 12" /></svg>
        </button>
      )}
      {/* Refresh button */}
      <button onClick={() => location.reload()}
        className="absolute top-4 right-4 z-50 px-3 py-1.5 rounded-lg text-xs font-semibold transition-all duration-200"
        style={{
          background: darkMode ? 'rgba(255,255,255,0.08)' : 'rgba(0,0,0,0.06)',
          color: darkMode ? 'rgba(255,255,255,0.5)' : 'rgba(0,0,0,0.4)',
          border: darkMode ? '1px solid rgba(255,255,255,0.12)' : '1px solid rgba(0,0,0,0.1)',
          backdropFilter: 'blur(12px)',
        }}
        onMouseOver={e => { e.currentTarget.style.background = darkMode ? 'rgba(255,255,255,0.15)' : 'rgba(0,0,0,0.1)'; e.currentTarget.style.color = darkMode ? '#fff' : '#000'; }}
        onMouseOut={e => { e.currentTarget.style.background = darkMode ? 'rgba(255,255,255,0.08)' : 'rgba(0,0,0,0.06)'; e.currentTarget.style.color = darkMode ? 'rgba(255,255,255,0.5)' : 'rgba(0,0,0,0.4)'; }}>
        â†» Refresh
      </button>
      <div className="relative z-10 flex flex-col h-full w-full">
        {/* Header */}
        <div className="w-full max-w-sm mx-auto px-5 pt-14 pb-2 flex flex-col items-center">
          <h1 className={`text-xl font-bold tracking-tight mb-3 ${TH('text-primary', darkMode)}`}>Verify</h1>
          {/* Search box */}
          <div className="w-full relative mb-3">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round"
              className="absolute left-3.5 top-1/2 -translate-y-1/2" style={{ color: darkMode ? 'rgba(255,255,255,0.3)' : 'rgba(0,0,0,0.3)' }}>
              <circle cx="7" cy="7" r="5" /><path d="M11 11L14 14" />
            </svg>
            <input type="text" value={search} onChange={e => setSearch(e.target.value)}
              placeholder="Search by name or city..."
              className={`w-full h-11 rounded-xl pl-10 pr-4 text-sm font-medium outline-none transition-all duration-200 ${TH('bg-input', darkMode)}`}
              style={{
                border: search ? `1px solid rgba(${c.rgb}, 0.3)` : (darkMode ? '1px solid rgba(255,255,255,0.08)' : '1px solid rgba(0,0,0,0.08)'),
                boxShadow: search ? `0 0 12px rgba(${c.rgb}, 0.08)` : 'none',
              }} />
          </div>
          {/* Mode toggle + count */}
          <div className="w-full flex items-center justify-between mb-2">
            <span className={`text-xs font-medium ${TH('text-subtle', darkMode)}`}>
              {filtered ? `${filtered.length} result${filtered.length !== 1 ? 's' : ''}` : `${pending.length} pending`}
            </span>
            {(completedCount || 0) >= 3 && (
              <button onClick={() => setExpertMode && setExpertMode(!expertMode)}
                className="flex items-center rounded-full overflow-hidden transition-all duration-200"
                style={{
                  background: darkMode ? 'rgba(255,255,255,0.06)' : 'rgba(0,0,0,0.04)',
                  border: darkMode ? '1px solid rgba(255,255,255,0.08)' : '1px solid rgba(0,0,0,0.08)',
                }}>
                <span className={`px-3 py-1 text-xs font-medium transition-all duration-200`}
                  style={{
                    background: !expertMode
                      ? (darkMode ? `rgba(${c.rgb}, 0.2)` : `rgba(${c.rgb}, 0.12)`)
                      : 'transparent',
                    color: !expertMode
                      ? (darkMode ? c.light : c.base)
                      : (darkMode ? 'rgba(255,255,255,0.35)' : 'rgba(0,0,0,0.35)'),
                  }}>Guided</span>
                <span className={`px-3 py-1 text-xs font-medium transition-all duration-200`}
                  style={{
                    background: expertMode
                      ? 'rgba(251,191,36,0.25)'
                      : 'transparent',
                    color: expertMode
                      ? (darkMode ? '#fbbf24' : '#d97706')
                      : (darkMode ? 'rgba(255,255,255,0.35)' : 'rgba(0,0,0,0.35)'),
                  }}>Express</span>
              </button>
            )}
          </div>
        </div>
        {/* Scrollable queue + history */}
        <div className="flex-1 overflow-y-auto w-full max-w-sm mx-auto px-5 pb-6">
          {/* Pending / search results */}
          <div className="w-full" style={{ animation: 'fadeSlideIn 0.4s ease-out both' }}>
            {!filtered && pending.length > 0 && (
              <button onClick={() => pending.length > PENDING_COLLAPSE && setShowAllPending(!showAllPending)}
                className="w-full flex items-center justify-between mb-2"
                style={{ cursor: pending.length > PENDING_COLLAPSE ? 'pointer' : 'default' }}>
                <span className={`text-xs font-semibold uppercase tracking-wide ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>
                  Up next
                </span>
                {pending.length > PENDING_COLLAPSE && (
                  <svg width="14" height="14" viewBox="0 0 14 14" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"
                    className={`transition-transform duration-200 ${showAllPending ? 'rotate-180' : ''}`}
                    style={{ color: darkMode ? 'rgba(255,255,255,0.3)' : 'rgba(0,0,0,0.3)' }}>
                    <path d="M3 5L7 9L11 5" />
                  </svg>
                )}
              </button>
            )}
            <div className="flex flex-col gap-2">
              {showList.length === 0 && (
                <div className={`text-center py-8 ${TH('text-subtle', darkMode)}`}>
                  <p className="text-sm">{search ? 'No matches found' : 'All caught up!'}</p>
                  <p className="text-xs mt-1">
                    {search ? 'Try a different name or city' : 'Check back for new evaluations'}
                  </p>
                </div>
              )}
              {showList.map(subject => (
                <SubjectCard key={subject.id} subject={subject} isDone={!!evaluations[subject.id]} />
              ))}
            </div>
          </div>
          {/* Completed history */}
          {!filtered && completed.length > 0 && (
            <div className="mt-6">
              <button onClick={() => setShowAllCompleted(!showAllCompleted)}
                className="w-full flex items-center justify-between mb-2 cursor-pointer">
                <span className={`text-xs font-semibold uppercase tracking-wide ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>
                  Recently evaluated ({completed.length})
                </span>
                <svg width="14" height="14" viewBox="0 0 14 14" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"
                  className={`transition-transform duration-200 ${showAllCompleted ? 'rotate-180' : ''}`}
                  style={{ color: darkMode ? 'rgba(255,255,255,0.3)' : 'rgba(0,0,0,0.3)' }}>
                  <path d="M3 5L7 9L11 5" />
                </svg>
              </button>
              {showAllCompleted && (
                <div className="flex flex-col gap-2" style={{ animation: 'fadeSlideIn 0.2s ease-out both' }}>
                  {completed.map(subject => (
                    <SubjectCard key={subject.id} subject={subject} isDone={true} />
                  ))}
                </div>
              )}
            </div>
          )}
        </div>
      </div>
    </div>
  );
};

// VerifyProfileFields removed â€” data collected through dual-purpose gateway questions + verify onboarding flow

// VerifyQueue removed â€” functionality merged into VerifyHub

// Shared: VerifyChipButton â€” reusable chip for compact selectors
const VerifyChipButton = ({ label, selected, color, darkMode, onClick, stretch }) => {
  const c = COLOR_HEX[color] || COLOR_HEX.violet;
  return (
    <button onClick={onClick}
      className={`px-3 py-2.5 rounded-xl text-sm font-medium transition-all duration-200 text-center hover-glow hover-glow-${color}`}
      style={{
        width: stretch ? '100%' : undefined,
        background: selected
          ? `linear-gradient(135deg, rgba(${c.rgb}, 0.25), rgba(${c.rgb}, 0.12))`
          : (darkMode ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.03)'),
        border: selected
          ? `1px solid rgba(${c.rgb}, 0.45)`
          : (darkMode ? '1px solid rgba(255,255,255,0.08)' : '1px solid rgba(0,0,0,0.08)'),
        color: selected ? (darkMode ? '#fff' : c.base) : (darkMode ? 'rgba(255,255,255,0.65)' : 'rgba(0,0,0,0.55)'),
        boxShadow: selected ? `0 0 12px rgba(${c.rgb}, 0.1)` : 'none',
      }}>
      {label}
    </button>
  );
};

// VerifyCompactConnection â€” 3 inline chip selectors on one screen
const VerifyCompactConnection = ({ question, color, darkMode, answer, onAnswer }) => {
  const c = COLOR_HEX[color] || COLOR_HEX.violet;
  const val = answer || {};
  const setField = (fieldId, v) => onAnswer({ ...val, [fieldId]: v });
  return (
    <div className="flex flex-col gap-3 w-full" style={{ animation: 'fadeSlideIn 0.4s ease-out both' }}>
      {question.fields.map(field => {
        const cols = field.options.length <= 4 ? field.options.length : 3;
        return (
          <div key={field.id} className="rounded-2xl px-4 py-3"
            style={{
              background: val[field.id]
                ? (darkMode ? `rgba(${c.rgb}, 0.04)` : `rgba(${c.rgb}, 0.02)`)
                : (darkMode ? 'rgba(255,255,255,0.03)' : 'rgba(0,0,0,0.02)'),
              border: val[field.id]
                ? `1px solid rgba(${c.rgb}, 0.15)`
                : (darkMode ? '1px solid rgba(255,255,255,0.06)' : '1px solid rgba(0,0,0,0.06)'),
              transition: 'all 0.2s',
            }}>
            <div className={`text-sm font-semibold mb-2 ${TH('text-primary', darkMode)}`}>{field.label}</div>
            <div style={{ display: 'grid', gridTemplateColumns: `repeat(${cols}, 1fr)`, gap: '8px' }}>
              {field.options.map(opt => (
                <VerifyChipButton key={opt} label={opt} selected={val[field.id] === opt} color={color} darkMode={darkMode}
                  onClick={() => setField(field.id, opt)} stretch />
              ))}
            </div>
          </div>
        );
      })}
    </div>
  );
};

// VerifyIdentityCheck â€” 3 identity questions on one screen
const VerifyIdentityCheck = ({ question, color, darkMode, answer, onAnswer }) => {
  const c = COLOR_HEX[color] || COLOR_HEX.violet;
  const val = answer || {};
  const setField = (fieldId, v) => onAnswer({ ...val, [fieldId]: v });
  return (
    <div className="flex flex-col gap-3 w-full" style={{ animation: 'fadeSlideIn 0.4s ease-out both' }}>
      {question.fields.map(field => {
        const cols = field.options.length <= 4 ? field.options.length : 3;
        return (
          <div key={field.id} className="rounded-2xl px-4 py-3"
            style={{
              background: val[field.id]
                ? (darkMode ? `rgba(${c.rgb}, 0.04)` : `rgba(${c.rgb}, 0.02)`)
                : (darkMode ? 'rgba(255,255,255,0.03)' : 'rgba(0,0,0,0.02)'),
              border: val[field.id]
                ? `1px solid rgba(${c.rgb}, 0.15)`
                : (darkMode ? '1px solid rgba(255,255,255,0.06)' : '1px solid rgba(0,0,0,0.06)'),
              transition: 'all 0.2s',
            }}>
            <div className={`text-sm font-semibold mb-0.5 ${TH('text-primary', darkMode)}`}>{field.label}</div>
            {field.subtitle && <div className={`text-xs mb-2 ${TH('text-subtle', darkMode)}`}>{field.subtitle}</div>}
            <div style={{ display: 'grid', gridTemplateColumns: `repeat(${cols}, 1fr)`, gap: '8px' }}>
              {field.options.map(opt => (
                <VerifyChipButton key={opt} label={opt} selected={val[field.id] === opt} color={color} darkMode={darkMode}
                  onClick={() => setField(field.id, opt)} stretch />
              ))}
            </div>
          </div>
        );
      })}
    </div>
  );
};

// VerifyEvidenceCombined â€” merged evidence checklist with section headers
const VerifyEvidenceCombined = ({ question, color, darkMode, answer, onAnswer }) => {
  const c = COLOR_HEX[color] || COLOR_HEX.violet;
  const val = answer || {};
  const toggleItem = (sectionIdx, opt) => {
    const key = `s${sectionIdx}`;
    const current = val[key] || [];
    const next = current.includes(opt) ? current.filter(x => x !== opt) : [...current, opt];
    onAnswer({ ...val, [key]: next });
  };
  return (
    <div className="flex flex-col gap-4 w-full" style={{ animation: 'fadeSlideIn 0.4s ease-out both' }}>
      {question.sections.map((section, si) => (
        <div key={si}>
          <div className={`text-xs font-semibold uppercase tracking-wide mb-2 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>{section.label}</div>
          <div className="flex flex-col gap-2">
            {section.options.map(opt => {
              const isOn = (val[`s${si}`] || []).includes(opt);
              return (
                <VerifyToggleSwitch key={opt} label={opt} color={color} darkMode={darkMode}
                  isOn={isOn} onToggle={() => toggleItem(si, opt)} />
              );
            })}
          </div>
        </div>
      ))}
    </div>
  );
};

// VerifyModeToggle â€” inline Guided/Express switch for in-flow mode switching
const VerifyModeToggle = ({ darkMode, expertMode, setExpertMode, completedCount }) => {
  if ((completedCount || 0) < 3) return null;
  const c = COLOR_HEX.emerald;
  return (
    <div className="flex justify-center mb-3">
      <button onClick={() => setExpertMode(!expertMode)}
        className="flex items-center rounded-full overflow-hidden transition-all duration-200"
        style={{
          background: darkMode ? 'rgba(255,255,255,0.06)' : 'rgba(0,0,0,0.04)',
          border: darkMode ? '1px solid rgba(255,255,255,0.08)' : '1px solid rgba(0,0,0,0.08)',
        }}>
        <span className="px-3 py-1 text-xs font-medium transition-all duration-200"
          style={{
            background: !expertMode ? (darkMode ? `rgba(${c.rgb}, 0.2)` : `rgba(${c.rgb}, 0.12)`) : 'transparent',
            color: !expertMode ? (darkMode ? c.light : c.base) : (darkMode ? 'rgba(255,255,255,0.35)' : 'rgba(0,0,0,0.35)'),
          }}>Guided</span>
        <span className="px-3 py-1 text-xs font-medium transition-all duration-200"
          style={{
            background: expertMode ? 'rgba(251,191,36,0.25)' : 'transparent',
            color: expertMode ? (darkMode ? '#fbbf24' : '#d97706') : (darkMode ? 'rgba(255,255,255,0.35)' : 'rgba(0,0,0,0.35)'),
          }}>Express</span>
      </button>
    </div>
  );
};

// VerifyEvaluatorFlow â€” merged gate+fit â†’ path questions
const VerifyEvaluatorFlow = ({ darkMode, subject, onComplete, onBack, sharedPath, setSharedPath, sharedAnswers, setSharedAnswers, expertMode, setExpertMode, completedCount }) => {
  const path = sharedPath;
  const setPath = setSharedPath;
  const answers = sharedAnswers;
  const setAnswers = setSharedAnswers;
  const [phase, setPhase] = useState(path ? 'path' : 'route');
  const [questionIdx, setQuestionIdx] = useState(0);
  const [animKey, setAnimKey] = useState(0);

  // Dev toolbar
  const devBar = IS_DEV ? (
    <div className="fixed top-1 right-1 z-[9999] flex gap-1 opacity-40 hover:opacity-100 transition-opacity" style={{fontSize:'10px'}}>
      {['A','B','C'].map(p => (
        <button key={p} onClick={() => { setPath(p); setPhase('path'); setQuestionIdx(0); setAnswers({}); setAnimKey(k=>k+1); }}
          className={`px-2 py-1 rounded ${path === p ? 'bg-white/20 text-white' : 'bg-black/30 text-white/60'}`}>{p}</button>
      ))}
      <button onClick={() => {
        const p = path || 'B';
        if (!path) setPath('B');
        const qs = VERIFY_PATH_CONFIG[p].questions;
        const verdictIdx = qs.findIndex(q => q.type === 'verdict');
        if (verdictIdx >= 0) { setPhase('path'); setQuestionIdx(verdictIdx); setAnimKey(k=>k+1); }
      }} className="px-2 py-1 rounded bg-black/30 text-amber-400/80">Verdict</button>
    </div>
  ) : null;

  const getActiveQuestions = (p, ans) => {
    if (!p || !VERIFY_PATH_CONFIG[p]) return [];
    return VERIFY_PATH_CONFIG[p].questions.filter(q => !q.conditional || q.conditional(ans));
  };

  // Combined route screen (gate + fit merged)
  if (phase === 'route') {
    return (<>
      {devBar}
      <VerifyScreenLayout darkMode={darkMode} color="emerald" onBack={onBack} subject={subject}>
        <div className="flex flex-col items-center gap-4 w-full mt-1" style={{ animation: 'fadeSlideIn 0.4s ease-out both' }}>
          <VerifyModeToggle darkMode={darkMode} expertMode={expertMode} setExpertMode={setExpertMode} completedCount={completedCount} />
          <h2 className={`question-text font-semibold px-2 text-center ${TH('text-primary', darkMode)}`}>
            How do you know them?
          </h2>
          <div className="flex flex-col gap-3 w-full">
            {[
              { key: 'A', label: 'I know them personally', sub: 'I can vouch for their identity', color: 'cyan', icon: 'ðŸ¤' },
              { key: 'B', label: 'I met them for verification', sub: 'I investigated and have evidence', color: 'amber', icon: 'ðŸ”' },
              { key: 'C', label: "I'm reviewing their profile", sub: "I'm analyzing what's available", color: 'slate', icon: 'ðŸ“‹' },
            ].map(opt => {
              const oc = COLOR_HEX[opt.color];
              return (
                <button key={opt.key} onClick={() => {
                  setPath(opt.key);
                  setAnswers(prev => ({ ...prev, gate: opt.label }));
                  setPhase('path');
                  setQuestionIdx(0);
                  setAnimKey(k => k + 1);
                }}
                  className={`w-full rounded-2xl px-4 py-3.5 text-left transition-all duration-200 hover-glow hover-glow-${opt.color}`}
                  style={{
                    background: `linear-gradient(135deg, rgba(${oc.rgb}, 0.12), rgba(${oc.rgb}, 0.04))`,
                    border: `1px solid rgba(${oc.rgb}, 0.2)`,
                  }}>
                  <div className="flex items-center gap-3">
                    <span className="text-lg">{opt.icon}</span>
                    <div>
                      <div className={`text-sm font-semibold ${TH('text-primary', darkMode)}`}>{opt.label}</div>
                      <div className="text-xs mt-0.5" style={{ color: darkMode ? `rgba(${oc.rgb}, 0.7)` : oc.base + '99' }}>{opt.sub}</div>
                    </div>
                  </div>
                </button>
              );
            })}
          </div>
        </div>
      </VerifyScreenLayout>
    </>);
  }

  // Path questions
  const config = VERIFY_PATH_CONFIG[path];
  const color = config.color;
  const activePathQuestions = getActiveQuestions(path, answers);
  const question = activePathQuestions[questionIdx];

  if (!question) {
    onComplete({ path, pathLabel: config.label, answers });
    return null;
  }

  const handleAnswer = (val) => setAnswers(prev => ({ ...prev, [question.id]: val }));
  const advance = () => {
    setAnimKey(k => k + 1);
    if (question.type === 'star-confidence' && answers[question.id] === undefined) return;
    if (question.type === 'verdict' && !(answers[question.id]?.verdict && answers[question.id]?.confidence)) return;
    if (question.type === 'compact-connection') {
      const val = answers[question.id] || {};
      const allFilled = question.fields.every(f => val[f.id]);
      if (!allFilled) return;
    }
    if (question.type === 'evidence-combined') {
      const val = answers[question.id] || {};
      const anySelected = question.sections.some((_, si) => (val[`s${si}`] || []).length > 0);
      if (!anySelected) return;
    }
    if (question.type === 'identity-check') {
      const val = answers[question.id] || {};
      const allFilled = question.fields.every(f => val[f.id]);
      if (!allFilled) return;
    }
    const nextQuestions = getActiveQuestions(path, answers);
    const currentFilteredIdx = nextQuestions.findIndex(q => q.id === question.id);
    if (currentFilteredIdx + 1 < nextQuestions.length) setQuestionIdx(currentFilteredIdx + 1);
    else onComplete({ path, pathLabel: config.label, answers });
  };
  const goBack = () => {
    if (questionIdx > 0) { setAnimKey(k => k + 1); setQuestionIdx(questionIdx - 1); }
    else { setPhase('route'); setPath(null); setAnswers({}); }
  };
  const handleSingleAnswer = (val) => { handleAnswer(val); setTimeout(advance, 300); };

  const isSingle = question.type === 'single';
  const isMulti = question.type === 'multi';
  const isText = question.type === 'text';
  const isStar = question.type === 'star-confidence';
  const isVerdict = question.type === 'verdict';
  const isCompactConnection = question.type === 'compact-connection';
  const isEvidenceCombined = question.type === 'evidence-combined';
  const isIdentityCheck = question.type === 'identity-check';
  const needsContinueButton = isMulti || isText || isStar || isVerdict || isCompactConnection || isEvidenceCombined || isIdentityCheck;

  const continueDisabled = isText ? !(answers[question.id] || '').trim()
    : isMulti ? !(Array.isArray(answers[question.id]) ? answers[question.id].length : (answers[question.id]?.items?.length || 0))
    : isStar ? answers[question.id] === undefined
    : isVerdict ? !(answers[question.id]?.verdict && answers[question.id]?.confidence)
    : isCompactConnection ? !question.fields.every(f => (answers[question.id] || {})[f.id])
    : isEvidenceCombined ? !question.sections.some((_, si) => ((answers[question.id] || {})[`s${si}`] || []).length > 0)
    : isIdentityCheck ? !question.fields.every(f => (answers[question.id] || {})[f.id])
    : false;

  return (<>
    {devBar}
    <VerifyScreenLayout darkMode={darkMode} color={color} subject={subject}
      sectionLabel={isVerdict ? 'Your Verdict' : config.label}
      progress={questionIdx} total={activePathQuestions.length} onBack={goBack}
      buttons={needsContinueButton ? (() => {
        if (isCompactConnection || isIdentityCheck) {
          const val = answers[question.id] || {};
          const total = question.fields.length;
          const filled = question.fields.filter(f => val[f.id]).length;
          if (filled < total) {
            const cc = COLOR_HEX[color] || COLOR_HEX.violet;
            return (
              <div className="w-full h-14 resp-h-lg rounded-2xl font-medium text-sm flex items-center justify-center transition-all duration-300"
                style={{
                  background: darkMode ? 'rgba(255,255,255,0.03)' : 'rgba(0,0,0,0.02)',
                  border: darkMode ? '1px solid rgba(255,255,255,0.06)' : '1px solid rgba(0,0,0,0.06)',
                  color: darkMode ? 'rgba(255,255,255,0.35)' : 'rgba(0,0,0,0.35)',
                }}>
                <span>Select one from each</span>
                <span className="ml-2 px-2 py-0.5 rounded-full text-xs font-semibold" style={{
                  background: `rgba(${cc.rgb}, 0.15)`,
                  color: darkMode ? cc.light : cc.base,
                }}>{filled} of {total}</span>
              </div>
            );
          }
        }
        return <VerifyActionButton label="Continue" color={color} darkMode={darkMode} onClick={advance} disabled={continueDisabled} />;
      })() : null}>
      <div key={`eq-${question.id}-${animKey}`} className="flex flex-col items-center gap-4 w-full mt-2" style={{ animation: 'fadeSlideIn 0.4s ease-out both' }}>
        <VerifyModeToggle darkMode={darkMode} expertMode={expertMode} setExpertMode={setExpertMode} completedCount={completedCount} />
        {isVerdict && question.text.includes('\n') ? (<>
          <p className={`text-sm font-medium tracking-wide uppercase ${TH('text-muted', darkMode)}`}>{question.text.split('\n')[0]}</p>
          <h2 className={`question-text font-semibold px-2 text-center -mt-3 ${TH('text-primary', darkMode)}`}>{question.text.split('\n')[1]}</h2>
        </>) : (
          <h2 className={`question-text font-semibold px-2 text-center ${TH('text-primary', darkMode)}`}>{question.text}</h2>
        )}
        {question.subtitle && <p className={`text-xs text-center -mt-2 px-4 ${TH('text-muted', darkMode)}`}>{question.subtitle}</p>}
        {isSingle && <VerifySingleSelect question={question} color={color} darkMode={darkMode} answer={answers[question.id]} onAnswer={handleSingleAnswer} answers={answers} />}
        {isMulti && <VerifyMultiToggle question={question} color={color} darkMode={darkMode} answer={answers[question.id]} onAnswer={handleAnswer} />}
        {isText && <VerifyTextInput question={question} color={color} darkMode={darkMode} answer={answers[question.id]} onAnswer={handleAnswer} onContinue={advance} />}
        {isStar && <VerifyStarConfidence color={color} darkMode={darkMode} value={answers[question.id]} onChange={handleAnswer} />}
        {isVerdict && <VerifyVerdict question={question} color={color} darkMode={darkMode} answer={answers[question.id]} onAnswer={handleAnswer} />}
        {isCompactConnection && <VerifyCompactConnection question={question} color={color} darkMode={darkMode} answer={answers[question.id]} onAnswer={handleAnswer} />}
        {isEvidenceCombined && <VerifyEvidenceCombined question={question} color={color} darkMode={darkMode} answer={answers[question.id]} onAnswer={handleAnswer} />}
        {isIdentityCheck && <VerifyIdentityCheck question={question} color={color} darkMode={darkMode} answer={answers[question.id]} onAnswer={handleAnswer} />}
      </div>
    </VerifyScreenLayout>
  </>);
};

// VerifyExpertForm â€” single scrollable express evaluation form
const VerifyExpertForm = ({ darkMode, subject, onComplete, onBack, sharedPath, setSharedPath, sharedAnswers, setSharedAnswers, expertMode, setExpertMode, completedCount }) => {
  const path = sharedPath;
  const setPath = setSharedPath;
  const answers = sharedAnswers;
  const setAnswers = setSharedAnswers;
  const [phase, setPhase] = useState(path ? 'form' : 'select-path');

  const config = path ? VERIFY_PATH_CONFIG[path] : null;
  const color = config ? config.color : 'emerald';
  const c = COLOR_HEX[color] || COLOR_HEX.emerald;
  const verdictKey = path === 'A' ? 'a3-verdict' : path === 'B' ? 'b4-verdict' : 'c4-verdict';
  const verdict = answers[verdictKey];
  const canSubmit = verdict?.verdict && verdict?.confidence;

  const setAnswer = (id, val) => setAnswers(prev => ({ ...prev, [id]: val }));

  const handleSubmit = () => {
    if (!canSubmit) return;
    onComplete({ path, pathLabel: config.label, answers });
  };

  // Inline chip selector â€” scaled up for expert mode
  const ExpertChip = ({ options, value, onChange, chipColor }) => {
    const fc = COLOR_HEX[chipColor] || c;
    return (
      <div className="flex flex-wrap gap-2">
        {options.map(opt => {
          const sel = value === opt;
          return (
            <button key={opt} onClick={() => onChange(opt)}
              className="px-3.5 py-2 rounded-xl text-sm font-medium transition-all"
              style={{
                background: sel ? `rgba(${fc.rgb}, 0.25)` : (darkMode ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.03)'),
                border: sel ? `1px solid rgba(${fc.rgb}, 0.45)` : (darkMode ? '1px solid rgba(255,255,255,0.08)' : '1px solid rgba(0,0,0,0.08)'),
                color: sel ? (darkMode ? '#fff' : fc.base) : (darkMode ? 'rgba(255,255,255,0.6)' : 'rgba(0,0,0,0.5)'),
              }}>
              {opt}
            </button>
          );
        })}
      </div>
    );
  };

  // Toggle pill â€” scaled up
  const ExpertPill = ({ label, isOn, onToggle, pillColor }) => {
    const pc = pillColor ? (COLOR_HEX[pillColor] || c) : c;
    return (
      <button onClick={onToggle}
        className="px-3.5 py-2 rounded-xl text-sm font-medium transition-all"
        style={{
          background: isOn ? `rgba(${pc.rgb}, 0.2)` : (darkMode ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.03)'),
          border: isOn ? `1px solid rgba(${pc.rgb}, 0.35)` : (darkMode ? '1px solid rgba(255,255,255,0.08)' : '1px solid rgba(0,0,0,0.08)'),
          color: isOn ? (darkMode ? '#fff' : pc.base) : (darkMode ? 'rgba(255,255,255,0.6)' : 'rgba(0,0,0,0.5)'),
        }}>
        {label}
      </button>
    );
  };

  // Path selection phase
  if (phase === 'select-path') {
    const ec = COLOR_HEX.emerald;
    return (
      <div className={`flex-1 flex flex-col relative overflow-hidden ${TH('bg-main', darkMode)}`}>
        <div className="absolute inset-0 flex items-center justify-center pointer-events-none" style={{ marginTop: '-8%' }}>
          <div style={{ position: 'absolute', width: 420, height: 420, borderRadius: '50%',
            background: darkMode ? `radial-gradient(circle, rgba(${ec.rgb},0.14) 0%, rgba(${ec.rgb},0.05) 35%, transparent 65%)` : `radial-gradient(circle, rgba(${ec.rgb},0.10) 0%, rgba(${ec.rgb},0.04) 35%, transparent 65%)`,
            animation: 'aura-breathe 8s ease-in-out infinite' }} />
        </div>
        <button onClick={onBack}
          className={`absolute top-4 left-4 z-50 w-8 h-8 flex items-center justify-center rounded-full transition-all duration-200 ${
            darkMode ? 'bg-white/[0.06] border border-white/[0.08] text-white/40 hover:text-white/70' : 'bg-black/[0.04] border border-black/[0.08] text-gray-400 hover:text-gray-600'}`}>
          <svg width="14" height="14" viewBox="0 0 14 14" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><path d="M9 2L4 7L9 12" /></svg>
        </button>
        <div className="relative z-10 flex flex-col h-full w-full">
          <div className="flex-1 overflow-y-auto flex flex-col items-center w-full">
            <div className="w-full max-w-sm mx-auto px-5 pt-12 pb-4 flex flex-col items-center">
              <VerifyModeToggle darkMode={darkMode} expertMode={expertMode} setExpertMode={setExpertMode} completedCount={completedCount} />
              <VerifySubjectBanner subject={subject} color="emerald" darkMode={darkMode} />
              <h2 className={`question-text font-semibold px-2 text-center mb-4 ${TH('text-primary', darkMode)}`}>
                How do you know them?
              </h2>
              <div className="flex flex-col gap-3 w-full">
                {[
                  { key: 'A', label: 'I know them personally', sub: 'Vouch for their identity', color: 'cyan', icon: 'ðŸ¤' },
                  { key: 'B', label: 'I met them for verification', sub: 'Investigated with evidence', color: 'amber', icon: 'ðŸ”' },
                  { key: 'C', label: "I'm reviewing their profile", sub: "Analyzing what's available", color: 'slate', icon: 'ðŸ“‹' },
                ].map(opt => {
                  const oc = COLOR_HEX[opt.color];
                  return (
                    <button key={opt.key} onClick={() => { setPath(opt.key); setAnswers({ gate: opt.label }); setPhase('form'); }}
                      className={`w-full rounded-2xl px-4 py-3.5 text-left transition-all duration-200 hover-glow hover-glow-${opt.color}`}
                      style={{
                        background: `linear-gradient(135deg, rgba(${oc.rgb}, 0.12), rgba(${oc.rgb}, 0.04))`,
                        border: `1px solid rgba(${oc.rgb}, 0.2)`,
                      }}>
                      <div className="flex items-center gap-3">
                        <span className="text-lg">{opt.icon}</span>
                        <div>
                          <div className={`text-sm font-semibold ${TH('text-primary', darkMode)}`}>{opt.label}</div>
                          <div className="text-xs mt-0.5" style={{ color: darkMode ? `rgba(${oc.rgb}, 0.7)` : oc.base + '99' }}>{opt.sub}</div>
                        </div>
                      </div>
                    </button>
                  );
                })}
              </div>
            </div>
          </div>
        </div>
      </div>
    );
  }

  // Form phase
  const questions = config.questions;

  return (
    <div className={`flex-1 flex flex-col relative overflow-hidden ${TH('bg-main', darkMode)}`}>
      {/* Header with subject + path indicator */}
      <div className={`flex-shrink-0 px-4 py-3 border-b ${TH('border-base', darkMode)}`}>
        <div className="flex items-center gap-3">
          <button onClick={onBack}
            className={`w-8 h-8 flex items-center justify-center rounded-full flex-shrink-0 ${
              darkMode ? 'bg-white/[0.06] border border-white/[0.08] text-white/40' : 'bg-black/[0.04] border border-black/[0.08] text-gray-400'}`}>
            <svg width="14" height="14" viewBox="0 0 14 14" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><path d="M9 2L4 7L9 12" /></svg>
          </button>
          <div className="w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold flex-shrink-0"
            style={{ background: `rgba(${c.rgb}, 0.2)`, color: darkMode ? c.light : c.base }}>
            {subject?.name?.[0] || '?'}
          </div>
          <div className="flex-1 min-w-0">
            <div className={`text-sm font-semibold truncate ${TH('text-primary', darkMode)}`}>{subject?.name}</div>
            <div className={`text-xs truncate ${darkMode ? 'text-white/40' : 'text-gray-500'}`}>{subject?.city}</div>
          </div>
          <button onClick={() => { setPhase('select-path'); setAnswers({}); setPath(null); }}
            className="flex items-center gap-1.5 px-2.5 py-1 rounded-full transition-all"
            style={{
              background: `rgba(${c.rgb}, 0.15)`,
              border: `1px solid rgba(${c.rgb}, 0.25)`,
              color: darkMode ? c.light : c.base,
            }}>
            <span className="text-xs font-medium">{config.label}</span>
            <svg width="10" height="10" viewBox="0 0 10 10" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round">
              <path d="M2.5 2.5L7.5 7.5M7.5 2.5L2.5 7.5" />
            </svg>
          </button>
        </div>
      </div>
      {/* Mode toggle */}
      <div className="flex-shrink-0 pt-3">
        <VerifyModeToggle darkMode={darkMode} expertMode={expertMode} setExpertMode={setExpertMode} completedCount={completedCount} />
      </div>
      {/* Scrollable form â€” scaled up */}
      <div className="flex-1 overflow-y-auto px-5 pb-5 space-y-6">
        {questions.map(q => {
          if (q.conditional && !q.conditional(answers)) return null;
          const a = answers[q.id];
          return (
            <div key={q.id}>
              <div className={`text-sm font-semibold mb-2 ${TH('text-primary', darkMode)}`}>{q.text}</div>
              {q.subtitle && <div className={`text-xs mb-2 -mt-1 ${TH('text-subtle', darkMode)}`}>{q.subtitle}</div>}

              {q.type === 'single' && (
                <ExpertChip options={q.dynamicOptions ? q.dynamicOptions(answers) : q.options}
                  value={a} onChange={v => setAnswer(q.id, v)} chipColor={color} />
              )}

              {q.type === 'multi' && (() => {
                const selected = Array.isArray(a) ? a : [];
                const toggle = (opt) => {
                  const next = selected.includes(opt) ? selected.filter(x => x !== opt) : [...selected, opt];
                  setAnswer(q.id, next);
                };
                return (
                  <div className="flex flex-wrap gap-2">
                    {q.options.map(opt => (
                      <ExpertPill key={opt} label={opt} isOn={selected.includes(opt)} onToggle={() => toggle(opt)} />
                    ))}
                  </div>
                );
              })()}

              {q.type === 'text' && (
                <input type="text" value={a || ''} onChange={e => setAnswer(q.id, e.target.value)}
                  placeholder={q.placeholder || ''}
                  className={`w-full text-sm px-4 py-3 rounded-xl bg-transparent outline-none ${darkMode ? 'border border-white/10 text-white placeholder-gray-600' : 'border border-gray-200 text-gray-900 placeholder-gray-300'}`} />
              )}

              {q.type === 'star-confidence' && (
                <div className="flex gap-3">
                  {[1,2,3,4].map(level => {
                    const sel = a !== undefined && level <= a;
                    return (
                      <button key={level} onClick={() => setAnswer(q.id, level)}
                        className="w-10 h-10 rounded-full flex items-center justify-center text-sm font-semibold transition-all"
                        style={{
                          background: sel ? `rgba(${c.rgb}, ${0.15 + level * 0.1})` : (darkMode ? 'rgba(255,255,255,0.08)' : 'rgba(0,0,0,0.06)'),
                          border: sel ? `1px solid rgba(${c.rgb}, 0.5)` : (darkMode ? '1px solid rgba(255,255,255,0.1)' : '1px solid rgba(0,0,0,0.08)'),
                          color: sel ? '#fff' : (darkMode ? 'rgba(255,255,255,0.35)' : 'rgba(0,0,0,0.35)'),
                        }}>
                        {level}
                      </button>
                    );
                  })}
                </div>
              )}

              {q.type === 'compact-connection' && (
                <div className="space-y-4">
                  {q.fields.map(f => (
                    <div key={f.id}>
                      <div className={`text-xs font-semibold uppercase tracking-wide mb-1.5 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>{f.label}</div>
                      <ExpertChip options={f.options} value={(a || {})[f.id]}
                        onChange={v => setAnswer(q.id, { ...(a || {}), [f.id]: v })} chipColor={color} />
                    </div>
                  ))}
                </div>
              )}

              {q.type === 'evidence-combined' && (
                <div className="space-y-4">
                  {q.sections.map((s, si) => {
                    const selected = (a || {})[`s${si}`] || [];
                    const toggle = (opt) => {
                      const next = selected.includes(opt) ? selected.filter(x => x !== opt) : [...selected, opt];
                      setAnswer(q.id, { ...(a || {}), [`s${si}`]: next });
                    };
                    return (
                      <div key={si}>
                        <div className={`text-xs font-semibold uppercase tracking-wide mb-1.5 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>{s.label}</div>
                        <div className="flex flex-wrap gap-2">
                          {s.options.map(opt => (
                            <ExpertPill key={opt} label={opt} isOn={selected.includes(opt)} onToggle={() => toggle(opt)} />
                          ))}
                        </div>
                      </div>
                    );
                  })}
                </div>
              )}

              {q.type === 'identity-check' && (
                <div className="space-y-4">
                  {q.fields.map(f => (
                    <div key={f.id}>
                      <div className={`text-xs font-semibold uppercase tracking-wide mb-1.5 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>{f.label}</div>
                      {f.subtitle && <div className={`text-xs -mt-0.5 mb-1.5 ${TH('text-subtle', darkMode)}`}>{f.subtitle}</div>}
                      <ExpertChip options={f.options} value={(a || {})[f.id]}
                        onChange={v => setAnswer(q.id, { ...(a || {}), [f.id]: v })} chipColor={color} />
                    </div>
                  ))}
                </div>
              )}

              {q.type === 'verdict' && (() => {
                const val = a || {};
                const vFlags = val.flags || [];
                const toggleFlag = (flag) => {
                  const next = vFlags.includes(flag) ? vFlags.filter(f => f !== flag) : [...vFlags, flag];
                  setAnswer(q.id, { ...val, flags: next });
                };
                return (
                  <div className="space-y-4">
                    <div className="flex gap-3">
                      {(q.verdictOptions || ['Yes', 'No']).map((opt, i) => {
                        const isYes = i === 0;
                        const sel = val.verdict === opt;
                        const vc = isYes ? COLOR_HEX.emerald : COLOR_HEX.rose;
                        return (
                          <button key={opt} onClick={() => setAnswer(q.id, { ...val, verdict: opt })}
                            className="flex-1 py-3.5 rounded-2xl text-base font-semibold transition-all"
                            style={{
                              background: sel ? `rgba(${vc.rgb}, 0.2)` : (darkMode ? 'rgba(255,255,255,0.04)' : 'rgba(0,0,0,0.03)'),
                              border: sel ? `1.5px solid rgba(${vc.rgb}, 0.5)` : (darkMode ? '1px solid rgba(255,255,255,0.06)' : '1px solid rgba(0,0,0,0.06)'),
                              color: sel ? (darkMode ? '#fff' : vc.base) : (darkMode ? 'rgba(255,255,255,0.4)' : 'rgba(0,0,0,0.3)'),
                            }}>
                            {opt}
                          </button>
                        );
                      })}
                    </div>
                    {val.verdict && (
                      <div className="flex gap-3 items-center">
                        {[1,2,3,4].map(level => {
                          const sel = val.confidence !== undefined && level <= val.confidence;
                          return (
                            <button key={level} onClick={() => setAnswer(q.id, { ...val, confidence: level })}
                              className="w-10 h-10 rounded-full flex items-center justify-center text-sm font-semibold transition-all"
                              style={{
                                background: sel ? `rgba(${c.rgb}, ${0.15 + level * 0.1})` : (darkMode ? 'rgba(255,255,255,0.08)' : 'rgba(0,0,0,0.06)'),
                                border: sel ? `1px solid rgba(${c.rgb}, 0.5)` : (darkMode ? '1px solid rgba(255,255,255,0.1)' : '1px solid rgba(0,0,0,0.08)'),
                                color: sel ? '#fff' : (darkMode ? 'rgba(255,255,255,0.35)' : 'rgba(0,0,0,0.35)'),
                              }}>
                              {level}
                            </button>
                          );
                        })}
                        {val.confidence && (
                          <span className={`text-xs ml-1 ${TH('text-subtle', darkMode)}`}>
                            {VERIFY_CONFIDENCE_LABELS[(val.confidence || 1) - 1]}
                          </span>
                        )}
                      </div>
                    )}
                    {val.verdict && q.flags && (
                      <div>
                        <div className={`text-xs font-semibold uppercase tracking-wide mb-2 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>Concerns</div>
                        <div className="flex flex-wrap gap-2">
                          {q.flags.map(flag => (
                            <ExpertPill key={flag} label={flag} isOn={vFlags.includes(flag)} onToggle={() => toggleFlag(flag)} pillColor="amber" />
                          ))}
                        </div>
                      </div>
                    )}
                  </div>
                );
              })()}
            </div>
          );
        })}
      </div>
      {/* Fixed submit button */}
      <div className={`flex-shrink-0 px-5 py-4 border-t ${TH('border-base', darkMode)}`}>
        <button onClick={handleSubmit} disabled={!canSubmit}
          className={`w-full py-4 rounded-2xl font-semibold text-sm transition-all disabled:opacity-30`}
          style={{
            background: canSubmit
              ? `linear-gradient(135deg, rgba(${c.rgb}, 0.3), rgba(${c.rgb}, 0.15))`
              : (darkMode ? 'rgba(255,255,255,0.04)' : 'rgba(0,0,0,0.03)'),
            border: `1px solid rgba(${c.rgb}, ${canSubmit ? 0.35 : 0.1})`,
            color: canSubmit ? '#fff' : (darkMode ? 'rgba(255,255,255,0.3)' : 'rgba(0,0,0,0.2)'),
          }}>
          Submit Evaluation
        </button>
      </div>
    </div>
  );
};

// VerifyEvalSummary â€” evaluation summary after completing
const VerifyEvalSummary = ({ darkMode, data, subject, onSubmit, onBack, readOnly }) => {
  const { path, pathLabel, answers } = data;
  const config = VERIFY_PATH_CONFIG[path];
  const color = config.color;
  const c = COLOR_HEX[color];
  const verdictKey = path === 'A' ? 'a3-verdict' : path === 'B' ? 'b4-verdict' : 'c4-verdict';
  const verdictData = answers[verdictKey] || {};
  const verdict = verdictData.verdict;
  const isPositive = verdict === 'Yes';
  const confidence = verdictData.confidence || '--';
  const confLabels = { 1: 'Some confidence, notable gaps', 2: 'Fairly confident, minor uncertainty', 3: 'Very confident', 4: 'Certain' };
  const rows = config.questions.filter(q => answers[q.id] !== undefined && q.type !== 'verdict').flatMap(q => {
    const a = answers[q.id];
    if (q.type === 'compact-connection') {
      return (q.fields || []).filter(f => a?.[f.id]).map(f => ({ label: f.label, value: a[f.id] }));
    }
    if (q.type === 'evidence-combined') {
      return (q.sections || []).map((s, si) => ({ label: s.label, value: (a?.[`s${si}`] || []).join(', ') || 'None' }));
    }
    if (q.type === 'identity-check') {
      return (q.fields || []).filter(f => a?.[f.id]).map(f => ({ label: f.label, value: a[f.id] }));
    }
    return [{ label: q.text, value: Array.isArray(a) ? a.join(', ') : (a?.items ? (a.items.join(', ') + (a.otherText ? ` (${a.otherText})` : '')) : String(a)) }];
  });

  return (
    <VerifyScreenLayout darkMode={darkMode} color={color} onBack={onBack}>
      <div className="w-full" style={{ animation: 'fadeSlideIn 0.4s ease-out both' }}>
        <div className="text-center mb-6">
          {(() => { const sc = COLOR_HEX[color]; return (
            <div className="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium mb-2"
              style={{ background: `rgba(${sc.rgb}, 0.12)`, color: darkMode ? sc.light : sc.base, border: `1px solid rgba(${sc.rgb}, 0.2)` }}>
              Path {path}: {pathLabel}
            </div>
          ); })()}
          <h2 className={`text-xl font-bold mt-2 ${TH('text-primary', darkMode)}`}>Evaluation Summary</h2>
          {subject && <p className={`text-sm mt-1 ${TH('text-muted', darkMode)}`}>for {subject.name}</p>}
        </div>
        <div className="rounded-2xl p-5 mb-4 text-center"
          style={{ background: `linear-gradient(135deg, rgba(${c.rgb}, 0.15), rgba(${c.rgb}, 0.05))`, border: `1px solid rgba(${c.rgb}, 0.25)` }}>
          {verdict && (
            <div className={`text-lg font-bold mb-3 ${isPositive ? 'text-emerald-400' : 'text-rose-400'}`}>
              {isPositive ? 'Yes' : 'No'}
            </div>
          )}
          <div className="flex justify-center gap-3 mb-3">
            {[1, 2, 3, 4].map(level => {
              const isSelected = typeof confidence === 'number' && level <= confidence;
              return (
                <div key={level} className="w-8 h-8 rounded-full flex items-center justify-center text-xs font-semibold"
                  style={{
                    background: isSelected ? `linear-gradient(135deg, rgba(${c.rgb}, 0.5), rgba(${c.rgb}, 0.25))` : darkMode ? 'rgba(255,255,255,0.08)' : 'rgba(0,0,0,0.06)',
                    border: isSelected ? `1px solid rgba(${c.rgb}, 0.6)` : darkMode ? '1px solid rgba(255,255,255,0.1)' : '1px solid rgba(0,0,0,0.08)',
                    color: isSelected ? '#fff' : darkMode ? 'rgba(255,255,255,0.35)' : 'rgba(0,0,0,0.35)',
                  }}>
                  {level}
                </div>
              );
            })}
          </div>
          <div className={`text-xs ${TH('text-muted', darkMode)}`}>{confLabels[confidence] || 'Confidence'}</div>
          {verdictData.flags && verdictData.flags.length > 0 && (
            <div className="flex flex-wrap gap-1.5 justify-center mt-3 pt-3" style={{ borderTop: darkMode ? '1px solid rgba(255,255,255,0.06)' : '1px solid rgba(0,0,0,0.06)' }}>
              {verdictData.flags.map(f => (
                <span key={f} className="px-2.5 py-1 rounded-full text-xs font-medium"
                  style={{ background: darkMode ? 'rgba(251,191,36,0.15)' : 'rgba(217,119,6,0.1)', color: darkMode ? '#fbbf24' : '#d97706' }}>
                  {f}
                </span>
              ))}
            </div>
          )}
        </div>
        <div className={`rounded-2xl p-5 mb-4 ${TH('bg-card', darkMode)}`}>
          <h3 className={`text-xs font-semibold uppercase tracking-wider mb-4 ${TH('text-muted', darkMode)}`}>Responses</h3>
          <div className="flex flex-col gap-4">
            {rows.map((row, i) => (
              <div key={i}>
                <div className={`text-xs mb-1 ${TH('text-muted', darkMode)}`}>{row.label}</div>
                <div className={`text-sm ${darkMode ? 'text-white/80' : 'text-gray-800'}`}>{row.value}</div>
              </div>
            ))}
          </div>
        </div>
        {answers['gate'] && (
          <div className={`rounded-2xl p-4 mb-4 ${TH('bg-card', darkMode)}`}>
            <div className={`text-xs mb-1 ${TH('text-muted', darkMode)}`}>Relationship</div>
            <div className={`text-sm ${darkMode ? 'text-white/80' : 'text-gray-800'}`}>{answers['gate']}</div>
          </div>
        )}
        {readOnly ? (
          <p className={`text-sm text-center mb-6 px-4 ${TH('text-subtle', darkMode)}`}>
            Submitted {data.completedAt ? new Date(data.completedAt).toLocaleDateString() : ''}
          </p>
        ) : (<>
          <p className={`text-xs text-center mb-6 px-4 ${TH('text-subtle', darkMode)}`}>
            This evaluation will be weighted by your path ({pathLabel}), your confidence level, and your reputation in the network.
          </p>
          <VerifyActionButton label="Submit Evaluation" color={color} darkMode={darkMode} onClick={onSubmit} />
          <div className="mt-3">
            <VerifyActionButton label="Start Over" color="gray" darkMode={darkMode} onClick={onBack} secondary />
          </div>
        </>)}
      </div>
    </VerifyScreenLayout>
  );
};


// SettingsScreen
const SettingsScreen = ({ darkMode, setDarkMode, undoDelay, setUndoDelay, requireConfirmation, setRequireConfirmation, showTips, setShowTips, showStreak, setShowStreak, showDemoControls, setShowDemoControls, entityType, setEntityType, onBack, onReset, onResetAssessments, hasAssessmentData, onHistory, onResetVerification, hasVerificationData, verifyExpertMode, setVerifyExpertMode }) => (
  <div className={`flex-1 flex flex-col overflow-hidden ${TH('bg-main', darkMode)}`}>
    <div className={`flex items-center justify-between px-4 py-3 border-b ${TH('border-base', darkMode)}`}>
      <button onClick={onBack} className={`text-sm btn-feedback ${TH('text-violet', darkMode)}`}>â† Back</button>
      <h1 className={`font-semibold ${TH('text-primary', darkMode)}`}>Settings</h1>
      <div className="w-12" />
    </div>
    <div className="flex-1 overflow-y-auto p-4 space-y-3">
      {/* Profile Section */}
      <ProfileSection darkMode={darkMode} />
      {/* History link - Coming Soon */}
      <div className={`w-full rounded-lg p-3 ${TH('bg-overlay', darkMode)}`}>
        <div className="flex items-center justify-between">
          <div className={`text-sm font-medium ${TH('text-subtle', darkMode)}`}>ðŸ“‹ Answer History</div>
          <span className={`text-xs px-2 py-0.5 rounded-full ${darkMode ? 'bg-white/[0.06] text-gray-500' : 'bg-gray-200 text-gray-500'}`}>Coming Soon</span>
        </div>
      </div>
      <div className={`rounded-lg p-3 ${TH('bg-card-shine', darkMode)}`}>
        <div className="flex items-center justify-between">
          <div><div className={`text-sm font-medium ${TH('text-primary', darkMode)}`}>Theme</div></div>
          <button onClick={() => setDarkMode(!darkMode)} className={`relative w-12 h-6 rounded-full btn-feedback ${darkMode ? 'bg-violet-600' : 'bg-gray-200'}`}>
            <div className={`absolute top-0.5 w-5 h-5 bg-white rounded-full shadow transition-transform flex items-center justify-center text-sm ${darkMode ? 'translate-x-6' : 'translate-x-0.5'}`}>{darkMode ? 'ðŸŒ™' : 'â˜€ï¸'}</div>
          </button>
        </div>
      </div>
      <div className={`rounded-lg p-3 ${TH('bg-card-shine', darkMode)}`}>
        <div className="flex items-center justify-between mb-2">
          <div className={`text-sm font-medium ${TH('text-primary', darkMode)}`}>Undo Delay</div>
          <span className={`text-sm font-bold ${TH('text-violet', darkMode)}`}>{undoDelay === 0 ? 'Off' : `${undoDelay}s`}</span>
        </div>
        <input type="range" min="0" max="3" step="0.5" value={undoDelay} onChange={(e) => setUndoDelay(parseFloat(e.target.value))} className={`w-full h-1.5 rounded-lg appearance-none cursor-pointer accent-violet-500 ${darkMode ? 'bg-gray-700' : 'bg-gray-200'}`} />
      </div>
      <div className={`rounded-lg p-3 ${TH('bg-card-shine', darkMode)}`}>
        <div className="flex items-center justify-between">
          <div><div className={`text-sm font-medium ${TH('text-primary', darkMode)}`}>Require Submit Button</div><div className={`text-sm ${darkMode ? 'text-gray-500' : 'text-gray-500'}`}>Off = auto-submit on tap</div></div>
          <button onClick={() => setRequireConfirmation(!requireConfirmation)} className={`relative w-12 h-6 rounded-full btn-feedback ${requireConfirmation ? 'bg-violet-600' : darkMode ? 'bg-gray-600' : 'bg-gray-200'}`}>
            <div className={`absolute top-0.5 w-5 h-5 bg-white rounded-full shadow transition-transform ${requireConfirmation ? 'translate-x-6' : 'translate-x-0.5'}`} />
          </button>
        </div>
      </div>
      <div className={`rounded-lg p-3 ${TH('bg-card-shine', darkMode)}`}>
        <div className="flex items-center justify-between">
          <div><div className={`text-sm font-medium ${TH('text-primary', darkMode)}`}>Show Tips</div><div className={`text-sm ${darkMode ? 'text-gray-500' : 'text-gray-500'}`}>Gesture hints for new users</div></div>
          <button onClick={() => setShowTips(!showTips)} className={`relative w-12 h-6 rounded-full btn-feedback ${showTips ? 'bg-violet-600' : darkMode ? 'bg-gray-600' : 'bg-gray-200'}`}>
            <div className={`absolute top-0.5 w-5 h-5 bg-white rounded-full shadow transition-transform ${showTips ? 'translate-x-6' : 'translate-x-0.5'}`} />
          </button>
        </div>
      </div>
      <div className={`rounded-lg p-3 ${TH('bg-card-shine', darkMode)}`}>
        <div className="flex items-center justify-between">
          <div><div className={`text-sm font-medium ${TH('text-primary', darkMode)}`}>Streak Counter</div><div className={`text-sm ${darkMode ? 'text-gray-500' : 'text-gray-500'}`}>Show ðŸ”¥ during play</div></div>
          <button onClick={() => setShowStreak(!showStreak)} className={`relative w-12 h-6 rounded-full btn-feedback ${showStreak ? 'bg-violet-600' : darkMode ? 'bg-gray-600' : 'bg-gray-200'}`}>
            <div className={`absolute top-0.5 w-5 h-5 bg-white rounded-full shadow transition-transform ${showStreak ? 'translate-x-6' : 'translate-x-0.5'}`} />
          </button>
        </div>
      </div>
      {/* Entity Type */}
      <div className={`rounded-lg p-3 ${TH('bg-card-shine', darkMode)}`}>
        <div className="flex items-center justify-between">
          <div><div className={`text-sm font-medium ${TH('text-primary', darkMode)}`}>I am a...</div><div className={`text-sm ${darkMode ? 'text-gray-500' : 'text-gray-500'}`}>{entityType === 'ai' ? 'AI or non-biological entity' : 'Human'}</div></div>
          <button onClick={() => setEntityType(entityType === 'human' ? 'ai' : 'human')} className={`relative w-12 h-6 rounded-full btn-feedback ${entityType === 'ai' ? 'bg-cyan-600' : darkMode ? 'bg-gray-600' : 'bg-gray-200'}`}>
            <div className={`absolute top-0.5 w-5 h-5 bg-white rounded-full shadow transition-transform flex items-center justify-center text-xs ${entityType === 'ai' ? 'translate-x-6' : 'translate-x-0.5'}`}>{entityType === 'ai' ? 'ðŸ¤–' : 'ðŸ§¬'}</div>
          </button>
        </div>
      </div>
      {/* Developer Mode */}
      <div className={`rounded-lg p-3 ${TH('bg-card-shine', darkMode)}`}>
        <div className="flex items-center justify-between">
          <div><div className={`text-sm font-medium ${TH('text-primary', darkMode)}`}>Demo Profiles</div><div className={`text-sm ${darkMode ? 'text-gray-500' : 'text-gray-500'}`}>View sample assessment data</div></div>
          <button onClick={() => setShowDemoControls(!showDemoControls)} className={`relative w-12 h-6 rounded-full btn-feedback ${showDemoControls ? 'bg-violet-600' : darkMode ? 'bg-gray-600' : 'bg-gray-200'}`}>
            <div className={`absolute top-0.5 w-5 h-5 bg-white rounded-full shadow transition-transform ${showDemoControls ? 'translate-x-6' : 'translate-x-0.5'}`} />
          </button>
        </div>
      </div>
      {/* Express Evaluation Mode */}
      <div className={`rounded-lg p-3 ${TH('bg-card-shine', darkMode)}`}>
        <div className="flex items-center justify-between">
          <div><div className={`text-sm font-medium ${TH('text-primary', darkMode)}`}>Express Evaluation Mode</div><div className={`text-sm ${darkMode ? 'text-gray-500' : 'text-gray-500'}`}>Single-form compact evaluations</div></div>
          <button onClick={() => setVerifyExpertMode(!verifyExpertMode)} className={`relative w-12 h-6 rounded-full btn-feedback ${verifyExpertMode ? 'bg-amber-500' : darkMode ? 'bg-gray-600' : 'bg-gray-200'}`}>
            <div className={`absolute top-0.5 w-5 h-5 bg-white rounded-full shadow transition-transform ${verifyExpertMode ? 'translate-x-6' : 'translate-x-0.5'}`} />
          </button>
        </div>
      </div>
      {/* Keyboard shortcuts â€” collapsible */}
      {(() => {
        const [kbOpen, setKbOpen] = React.useState(false);
        return (
          <div className={`rounded-lg p-3 cursor-pointer ${darkMode ? 'bg-gray-900/50 border border-gray-800' : 'bg-white border border-gray-200'}`} onClick={() => setKbOpen(!kbOpen)}>
            <div className="flex items-center justify-between">
              <div className={`text-sm font-medium ${TH('text-dim', darkMode)}`}>âŒ¨ï¸ Keyboard Shortcuts</div>
              <svg width="14" height="14" viewBox="0 0 16 16" fill="none" className={`transition-transform duration-200 ${kbOpen ? 'rotate-180' : ''}`} style={{stroke: darkMode ? '#6b7280' : '#9ca3af', strokeWidth: 2.5, strokeLinecap: 'round', strokeLinejoin: 'round'}}><polyline points="4 6 8 10 12 6"/></svg>
            </div>
            {kbOpen && (
              <div className={`text-sm space-y-1 mt-3 ${darkMode ? 'text-gray-500' : 'text-gray-600'}`} onClick={e => e.stopPropagation()}>
                <div className="flex justify-between"><span>Yes / Option A</span><span className="font-mono">Y or 1</span></div>
                <div className="flex justify-between"><span>No / Option B-E</span><span className="font-mono">N or 2-5</span></div>
                <div className="flex justify-between"><span>Next question</span><span className="font-mono">â†’ or Space</span></div>
                <div className="flex justify-between"><span>Previous question</span><span className="font-mono">â†</span></div>
                <div className="flex justify-between"><span>Undo</span><span className="font-mono">Esc</span></div>
              </div>
            )}
          </div>
        );
      })()}
      {/* Data Management */}
      <div className={`rounded-lg p-3 ${TH('bg-card-shine', darkMode)}`}>
        <div className={`text-sm font-medium mb-2 ${TH('text-primary', darkMode)}`}>Your Data</div>
        <div className="flex gap-2">
          <button onClick={() => exportUserData()} className={`flex-1 py-2 rounded-lg text-sm font-medium btn-feedback ${darkMode ? 'bg-emerald-900/30 text-emerald-400' : 'bg-emerald-100 text-emerald-600'}`}>
            Export JSON
          </button>
          <label className={`flex-1 py-2 rounded-lg text-sm font-medium text-center cursor-pointer btn-feedback ${darkMode ? 'bg-blue-900/30 text-blue-400' : 'bg-blue-100 text-blue-600'}`}>
            Import JSON
            <input type="file" accept=".json" className="hidden" onChange={(e) => e.target.files[0] && importUserData(e.target.files[0])} />
          </label>
        </div>
        <div className={`text-xs mt-2 ${TH('text-faint', darkMode)}`}>
          Session: {AURA_SESSION_ID}
        </div>
      </div>
      <div className="flex gap-2 flex-wrap">
        {hasAssessmentData && (
          <button onClick={onResetAssessments} className={`flex-1 py-2.5 rounded-lg text-sm font-medium btn-feedback ${darkMode ? 'bg-amber-900/30 text-amber-400' : 'bg-amber-100 text-amber-600'}`}>Clear Assessments</button>
        )}
        {hasVerificationData && (
          <button onClick={onResetVerification} className={`flex-1 py-2.5 rounded-lg text-sm font-medium btn-feedback ${darkMode ? 'bg-teal-900/30 text-teal-400' : 'bg-teal-100 text-teal-600'}`}>Clear Verification</button>
        )}
        <button onClick={onReset} className={`${hasAssessmentData || hasVerificationData ? 'flex-1' : 'w-full'} py-2.5 rounded-lg text-sm font-medium btn-feedback ${darkMode ? 'bg-rose-900/30 text-rose-400' : 'bg-rose-100 text-rose-600'}`}>Reset Demo</button>
      </div>
      <div className={`text-sm text-center ${TH('text-faint', darkMode)}`}>Aura Player vR-Data</div>
      <div className="text-center pt-1">
        <a href="/for-ais" target="_blank" rel="noopener" className="text-xs" style={{color: 'rgba(255,255,255,0.2)', textDecoration: 'none', letterSpacing: '0.02em'}}
          onMouseEnter={e => e.target.style.color='rgba(255,255,255,0.45)'}
          onMouseLeave={e => e.target.style.color='rgba(255,255,255,0.2)'}>For AIs â†’</a>
      </div>
    </div>
  </div>
);

// ==================== SCREEN COMPONENTS ====================

// HistoryScreen - Shows all answered questions with filter and community results
const HistoryScreen = ({ darkMode, questions, responses, communityResults, questionFlags, answerExplanations, onBack }) => {
  const [historyFilter, setHistoryFilter] = useState('all');
  const [expandedId, setExpandedId] = useState(null);

  const answeredQuestions = questions
    .filter(q => responses[q.id])
    .map(q => ({ ...q, response: responses[q.id], community: communityResults[q.id] }))
    .sort((a, b) => (b.response.timestamp || 0) - (a.response.timestamp || 0));
  const filteredQuestions = answeredQuestions.filter(q => {
    if (historyFilter === 'all') return true;
    if (historyFilter === 'binary') return q.type === 'binary';
    if (historyFilter === 'multiple') return q.type === 'multiple';
    if (historyFilter === 'flagged') return questionFlags[q.id] || answerExplanations[q.id];
    return q.category === historyFilter;
  });
  const getAnswerLabel = (q) => {
    if (q.type === 'binary') return q.response.answer === 0 ? 'YES' : 'NO';
    return q.options?.[q.response.answer] || '?';
  };
  return (
    <div className={`flex-1 flex flex-col ${darkMode ? 'text-white bg-gray-950' : 'text-gray-900 bg-gray-50'}`}>
      <ScreenHeader title="History" onBack={onBack} darkMode={darkMode}
        right={<span className={`text-sm ${darkMode ? 'text-gray-500' : 'text-gray-500'}`}>{answeredQuestions.length} answered</span>} />
      <div className="flex flex-wrap gap-1 p-2">
        {[{ id: 'all', label: 'All' }, { id: 'binary', label: 'Y/N' }, { id: 'multiple', label: 'MC' }, { id: 'flagged', label: 'âš‘' }, ...CATEGORIES.map(c => ({ id: c.id, label: c.icon }))].map(f => (
          <button key={f.id} onClick={() => setHistoryFilter(f.id)}
            className={`px-2.5 py-1 rounded-lg text-sm whitespace-nowrap transition-colors ${historyFilter === f.id ? 'bg-violet-600 text-white' : darkMode ? 'bg-white/[0.06] text-gray-400' : 'bg-white text-gray-600 border border-gray-200'}`}>
            {f.label}
          </button>
        ))}
      </div>
      <div className="flex-1 overflow-y-auto p-2 space-y-1">
        {filteredQuestions.length === 0 ? (
          <div className="flex-1 flex flex-col items-center justify-center text-center py-8">
            <div className="text-3xl mb-2">ðŸ“‹</div>
            <p className="text-gray-500 text-sm">No questions match this filter</p>
          </div>
        ) : filteredQuestions.map(q => {
          const catInfo = CATEGORIES.find(c => c.id === q.category);
          const isExpanded = expandedId === `history-${q.id}`;
          return (
            <div key={q.id} className={`rounded-lg p-3 ${TH('bg-card-simple', darkMode)}`}>
              <div className="flex items-start gap-2">
                <span className="text-sm">{catInfo?.icon || 'â˜…'}</span>
                <div className="flex-1 min-w-0">
                  <p className={`text-sm leading-snug line-clamp-2 ${darkMode ? 'text-gray-200' : 'text-gray-800'}`}>{q.text}</p>
                  <div className="flex items-center gap-2 mt-1.5">
                    <span className={`text-sm font-medium ${q.type === 'binary' ? (q.response.answer === 0 ? (darkMode ? 'text-emerald-400' : 'text-emerald-600') : (darkMode ? 'text-rose-400' : 'text-rose-600')) : (darkMode ? 'text-violet-400' : 'text-violet-600')}`}>
                      {getAnswerLabel(q)}
                    </span>
                    <span className="flex gap-0.5">{[1,2,3,4].map(i => <span key={i} className={`w-1.5 h-1.5 rounded-full ${i <= q.response.confidence ? (darkMode ? 'bg-violet-400' : 'bg-violet-500') : (darkMode ? 'bg-gray-700' : 'bg-gray-300')}`} />)}</span>
                    <span className="text-sm text-gray-500">{CONFIDENCE_LABELS[q.response.confidence]}</span>
                    {questionFlags[q.id] && <span className="text-sm text-rose-400">âš‘</span>}
                    {answerExplanations[q.id] && <span className="text-sm text-amber-400">âœŽ</span>}
                  </div>
                </div>
              </div>
              {q.community && (
                <button onClick={() => setExpandedId(isExpanded ? null : `history-${q.id}`)} className="w-full mt-2 text-left">
                  <div className={`flex items-center justify-between text-sm ${darkMode ? 'text-gray-600' : 'text-gray-500'}`}>
                    <span>{q.community.evaluators?.length || 0} responses</span>
                    <span>{isExpanded ? 'â–²' : 'â–¼'}</span>
                  </div>
                  {isExpanded && (
                    <div className="mt-2">
                      {q.type === 'binary' ? <BinaryChart evaluators={q.community.evaluators} userResponse={q.response} darkMode={darkMode} /> : <MultipleChoiceChart evaluators={q.community.evaluators} userResponse={q.response} options={q.options} darkMode={darkMode} />}
                    </div>
                  )}
                </button>
              )}
            </div>
          );
        })}
      </div>
    </div>
  );
};

// QotdScreen - Question of the Day with blue glow, reuses Q&A components
const QotdScreen = ({ darkMode, qotdData, qotdResponse, qotdTappedAnswer, qotdTapCount, onTap, onSubmit, onClear, onBack, onGoToQuestions }) => {
  const qotdQuestion = {
    id: qotdData.id,
    text: qotdData.text,
    type: qotdData.type,
    category: 'qotd',
    options: qotdData.options || []
  };
  const qotdCommunityResults = qotdDistributionToEvaluators(qotdData);
  const isBinary = qotdData.type === 'binary';
  const hasAnswered = qotdResponse !== null;

  const blueGlowStyle = {
    background: darkMode
      ? 'radial-gradient(ellipse at center top, rgba(59, 130, 246, 0.25) 0%, rgba(59, 130, 246, 0.12) 35%, rgba(59, 130, 246, 0.04) 60%, transparent 80%), #030712'
      : 'radial-gradient(ellipse at center top, rgba(59, 130, 246, 0.2) 0%, rgba(59, 130, 246, 0.08) 35%, rgba(59, 130, 246, 0.02) 60%, transparent 80%), #f9fafb'
  };

  return (
    <div className="flex-1 flex flex-col overflow-hidden relative" style={blueGlowStyle}>
      {/* QotD Nav + Badge â€” single compact row */}
      <div className={`h-[40px] flex-shrink-0 flex items-center gap-2 px-3 ${darkMode ? 'bg-blue-900/20 border-b border-blue-900/30' : 'bg-blue-50 border-b border-blue-100'}`}>
        <button onClick={onBack} className={`text-xl font-bold w-8 h-8 flex items-center justify-center ${TH('btn-ghost', darkMode)}`}>â—€</button>
        <div className="flex-1 flex items-center justify-center gap-2">
          <span className="text-sm">â˜€ï¸</span>
          <span className={`text-sm font-medium ${darkMode ? 'text-blue-400' : 'text-blue-600'}`}>Question of the Day</span>
          <span className={`text-xs ${darkMode ? 'text-gray-500' : 'text-gray-500'}`}>{getQotdTimeRemaining()}</span>
        </div>
        <button onClick={onGoToQuestions} className={`text-xl font-bold w-8 h-8 flex items-center justify-center ${TH('btn-ghost', darkMode)}`}>â–¶</button>
      </div>

      {/* ANSWERED VIEW - tap anywhere to return to menu */}
      {hasAnswered ? (
        <div className="flex-1 flex flex-col overflow-y-auto px-4 py-3 cursor-pointer" onClick={onBack}>
          <h2 className={`question-text text-center font-medium mb-4 ${TH('text-primary', darkMode)}`}>{qotdData.text}</h2>
          <div className={`p-3 rounded-lg mb-4 ${TH('bg-overlay', darkMode)}`}>
            <div className={`text-sm text-center ${TH('text-muted', darkMode)}`}>
              Your answer: <span className={`font-bold ${isBinary ? (qotdResponse.answer === 0 ? 'text-emerald-400' : 'text-rose-400') : ''}`} style={!isBinary ? { color: MC_COLORS[qotdResponse.answer % MC_COLORS.length].hex } : undefined}>
                {CONFIDENCE_LABELS[qotdResponse.confidence]} {isBinary ? (qotdResponse.answer === 0 ? 'Yes' : 'No') : qotdData.options?.[qotdResponse.answer]}
              </span>
            </div>
          </div>
          <div className={`rounded-lg p-3 ${TH('bg-card-shine', darkMode)}`}>
            <div className="flex items-center gap-2 mb-2">
              <span className={`text-sm font-medium ${TH('text-secondary', darkMode)}`}>Community Results</span>
              <span className={`text-xs ${TH('text-subtle', darkMode)}`}>{qotdCommunityResults.evaluators.length.toLocaleString()} responses</span>
            </div>
            <CommunityResultsRows question={qotdQuestion} results={qotdCommunityResults} userResponse={qotdResponse} darkMode={darkMode} options={qotdData.options} />
          </div>
          <div className={`flex items-center justify-center gap-2 mt-4 p-2 rounded-lg ${darkMode ? 'bg-gray-900/30' : 'bg-gray-50'}`}>
            <span className="text-sm">{qotdData.sponsor.avatar}</span>
            <span className={`text-sm ${darkMode ? 'text-gray-600' : 'text-gray-500'}`}>Sponsored by {qotdData.sponsor.name}</span>
          </div>
        </div>
      ) : (
        <>
          <div className="flex-1 flex flex-col justify-center px-4 pb-3 overflow-y-auto">
            <QuestionCard question={qotdQuestion} darkMode={darkMode} evidenceExpanded={false} onToggleEvidence={() => {}} />
            <div className={`flex items-center justify-center gap-2 mt-3 ${darkMode ? 'text-gray-600' : 'text-gray-500'}`}>
              <span className="text-sm">{qotdData.sponsor.avatar}</span>
              <span className="text-sm">Sponsored by {qotdData.sponsor.name}</span>
            </div>
          </div>
          <div className={`flex-shrink-0 border-t ${darkMode ? 'border-gray-800 bg-gray-950/80' : 'border-gray-200 bg-white/80'}`}>
            <div className="px-4 pt-3">
              {isBinary ? (
                <BinaryButtons darkMode={darkMode} tappedAnswer={qotdTappedAnswer} tapCount={qotdTapCount}
                  isAnswered={false} currentResponse={null} onTap={onTap} onRightClick={() => {}}
                  pendingSubmit={null} requireConfirmation={true} onSubmit={onSubmit} onClear={onClear} />
              ) : (
                <MCButtons options={qotdData.options || []} darkMode={darkMode} tappedAnswer={qotdTappedAnswer} tapCount={qotdTapCount}
                  isAnswered={false} currentResponse={null} onTap={onTap} onRightClick={() => {}}
                  pendingSubmit={null} requireConfirmation={true} onSubmit={onSubmit} onClear={onClear} />
              )}
            </div>
            {qotdTappedAnswer !== null && (
              <div className="px-4 pt-2 flex gap-2">
                <button onClick={onClear}
                  className={`h-10 px-4 rounded-xl text-sm font-medium transition-all ${darkMode ? 'bg-white/[0.06] text-gray-400 hover:bg-white/[0.10]' : 'bg-black/[0.05] text-gray-500 hover:bg-black/[0.09]'}`}>
                  âœ•
                </button>
                <button onClick={onSubmit}
                  className="flex-1 h-10 rounded-xl text-sm font-semibold bg-blue-600 hover:bg-blue-500 text-white transition-all">
                  âœ“ Submit
                </button>
              </div>
            )}
            <div className="h-3" />
          </div>
        </>
      )}
    </div>
  );
};

// SharePicker â€” Bottom sheet with color-coded toggles + primary identity gate
// Green=public, Amber=temp-unlocked private, Red=temp-unlocked locked
const SharePicker = ({ darkMode, userId, userClaims, displayName, assessmentCount, tempUnlocked, onMakePublic, onSetPrimary }) => {
  const [open, setOpen] = useState(false);
  const [choosingPrimary, setChoosingPrimary] = useState(false);
  const [copied, setCopied] = useState(false);
  const [selections, setSelections] = useState({});

  const primaryClaim = (userClaims || []).find(c => c.weight === 1);

  // Shareable stamps: public OR temp-unlocked (non-email, linked)
  const shareableStamps = (userClaims || []).filter(c =>
    c.provider !== 'email' && c.value &&
    ((c.visibility || 'public') === 'public' || (tempUnlocked || {})[c.provider])
  );

  // All linked claims for the primary chooser
  const linkedClaims = (userClaims || []).filter(c => c.value);

  const openShareSheet = () => {
    if (shareableStamps.length === 0) {
      copyUrl(`${window.location.origin}${window.location.pathname}?p=${userId}`);
      return;
    }
    const init = {};
    shareableStamps.forEach(c => { init[c.provider] = (c.visibility || 'public') === 'public'; });
    setSelections(init);
    setChoosingPrimary(false);
    setOpen(true);
  };

  const handleOpen = () => {
    // Gate: no primary set â†’ show primary chooser first
    if (!primaryClaim) {
      setChoosingPrimary(true);
      setOpen(true);
      return;
    }
    openShareSheet();
  };

  const handleChoosePrimary = async (claimId) => {
    if (onSetPrimary) await onSetPrimary(claimId);
    // After setting primary, proceed to share sheet
    setChoosingPrimary(false);
    // Small delay for claims to reload, then open share directly
    setTimeout(() => {
      const init = {};
      shareableStamps.forEach(c => { init[c.provider] = (c.visibility || 'public') === 'public'; });
      setSelections(init);
    }, 100);
  };

  const copyUrl = async (url) => {
    try {
      if (navigator.share) {
        await navigator.share({ title: 'My Aura Profile', url });
        setOpen(false);
        return;
      }
    } catch (err) {
      if (err.name === 'AbortError') return;
    }
    try {
      await navigator.clipboard.writeText(url);
    } catch {
      const ta = document.createElement('textarea');
      ta.value = url;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      document.body.removeChild(ta);
    }
    setCopied(true);
    setTimeout(() => { setCopied(false); setOpen(false); }, 1200);
  };

  const handleCopyLink = () => {
    const selected = Object.entries(selections).filter(([_, on]) => on).map(([id]) => id);
    shareableStamps.forEach(c => {
      if ((c.visibility || 'public') !== 'public' && selections[c.provider] && onMakePublic) {
        onMakePublic(c.id);
      }
    });
    let url = `${window.location.origin}${window.location.pathname}?p=${userId}`;
    if (selected.length > 0) url += `&s=${selected.join(',')}`;
    copyUrl(url);
  };

  const getToggleColor = (claim, isOn) => {
    if (!isOn) return darkMode ? 'bg-gray-700' : 'bg-gray-300';
    const vis = claim.visibility || 'public';
    if (vis === 'locked') return darkMode ? 'bg-red-600' : 'bg-red-500';
    if (vis === 'private') return darkMode ? 'bg-amber-600' : 'bg-amber-500';
    return darkMode ? 'bg-emerald-600' : 'bg-emerald-500';
  };

  // Sort shareable stamps: primary first, then rest
  const sortedShareable = [...shareableStamps].sort((a, b) => {
    if (primaryClaim && a.id === primaryClaim.id) return -1;
    if (primaryClaim && b.id === primaryClaim.id) return 1;
    return 0;
  });

  return (
    <>
      <button onClick={handleOpen}
        className={`text-xs px-2.5 py-1 rounded-lg font-medium btn-feedback transition-colors ${
          copied
            ? (darkMode ? 'bg-emerald-500/20 text-emerald-400' : 'bg-emerald-100 text-emerald-700')
            : (darkMode ? 'bg-white/[0.06] text-gray-400 hover:text-white' : 'bg-gray-100 text-gray-500 hover:text-gray-700')
        }`}>
        {copied ? '\u2713 Copied' : 'Share'}
      </button>

      {open && (
        <div className="fixed inset-0 z-50 flex items-end justify-center" onClick={() => setOpen(false)}>
          <div className="absolute inset-0 bg-black/60" />
          <div onClick={(e) => e.stopPropagation()}
            className={`relative w-full max-w-md rounded-t-2xl px-5 pt-5 pb-6 ${darkMode ? 'bg-gray-900 border-t border-gray-800' : 'bg-white border-t border-gray-200'}`}
            style={{ animation: 'slideUp 0.2s ease-out' }}>

            {choosingPrimary ? (
              <>
                {/* Primary Selection Sheet */}
                <div className="flex items-center justify-between mb-3">
                  <h3 className={`font-semibold text-base ${darkMode ? 'text-white' : 'text-gray-900'}`}>Choose your public name</h3>
                  <button onClick={() => setOpen(false)}
                    className={`text-lg px-1.5 py-0.5 rounded btn-feedback ${darkMode ? 'text-gray-500 hover:text-gray-300' : 'text-gray-400 hover:text-gray-600'}`}>
                    {'âœ•'}
                  </button>
                </div>
                <p className={`text-xs mb-4 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                  Pick how you'll appear when you share your profile.
                </p>

                <div className="space-y-1.5 mb-4">
                  {linkedClaims.map(claim => {
                    const provider = STAMP_PROVIDERS.find(p => p.id === claim.provider);
                    if (!provider) return null;
                    return (
                      <div key={claim.id}
                        className={`rounded-lg px-3 py-2.5 flex items-center gap-2.5 ${darkMode ? 'bg-white/[0.04] border border-white/[0.08]' : 'bg-white border border-gray-200'}`}>
                        <div className="w-5 flex items-center justify-center flex-shrink-0">
                          <StampIcon provider={provider} size={14} />
                        </div>
                        <span className={`text-xs font-medium flex-1 min-w-0 truncate ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                          {formatStampDisplay(claim.provider, claim.value) || claim.label || provider.name}
                        </span>
                        <button onClick={() => handleChoosePrimary(claim.id)}
                          className={`text-[10px] px-3 py-1 rounded-lg font-medium btn-feedback transition-colors ${
                            darkMode ? 'bg-violet-600/30 text-violet-300 hover:bg-violet-600/50' : 'bg-violet-100 text-violet-700 hover:bg-violet-200'
                          }`}>
                          Use
                        </button>
                      </div>
                    );
                  })}
                </div>

                {linkedClaims.length <= 1 && (
                  <p className={`text-[10px] text-center ${darkMode ? 'text-gray-600' : 'text-gray-400'}`}>
                    Link more accounts above to choose a different identity
                  </p>
                )}
              </>
            ) : (
              <>
                {/* Share sheet */}
                <div className="flex items-center justify-between mb-4">
                  <h3 className={`font-semibold text-base ${darkMode ? 'text-white' : 'text-gray-900'}`}>Share Profile</h3>
                  <button onClick={() => setOpen(false)}
                    className={`text-lg px-1.5 py-0.5 rounded btn-feedback ${darkMode ? 'text-gray-500 hover:text-gray-300' : 'text-gray-400 hover:text-gray-600'}`}>
                    {'âœ•'}
                  </button>
                </div>

                <div className="flex items-center gap-3 mb-4">
                  <div className="w-10 h-10 bg-gradient-to-br from-violet-500 to-fuchsia-500 rounded-full flex items-center justify-center font-bold text-sm text-white">
                    {(displayName || 'A')[0].toUpperCase()}
                  </div>
                  <div>
                    <div className={`text-sm font-medium ${darkMode ? 'text-white' : 'text-gray-900'}`}>{displayName || 'Aura User'}</div>
                    <div className={`text-xs ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>{assessmentCount || 0} assessments</div>
                  </div>
                </div>

                <div className={`border-t mb-3 ${darkMode ? 'border-gray-800' : 'border-gray-200'}`} />

                {/* Primary stamp â€” always shown, always on */}
                {primaryClaim && (() => {
                  const pProvider = STAMP_PROVIDERS.find(p => p.id === primaryClaim.provider);
                  if (!pProvider) return null;
                  return (
                    <div className="mb-3">
                      <div className={`text-xs font-medium mb-1.5 ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>Your identity:</div>
                      <div className={`rounded-lg px-2.5 py-2 flex items-center gap-2 ${darkMode ? 'bg-amber-500/[0.06] border border-amber-500/20' : 'bg-amber-50 border border-amber-200'}`}>
                        <div className="w-5 flex items-center justify-center flex-shrink-0">
                          <StampIcon provider={pProvider} size={14} />
                        </div>
                        <span className={`text-xs font-medium flex-1 min-w-0 truncate ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                          {formatStampDisplay(primaryClaim.provider, primaryClaim.value) || primaryClaim.label}
                        </span>
                        <span className={`text-[9px] flex-shrink-0 ${darkMode ? 'text-amber-400' : 'text-amber-600'}`}>â˜… Primary</span>
                      </div>
                    </div>
                  );
                })()}

                {sortedShareable.length > 0 && (
                  <>
                    <div className={`text-xs font-medium mb-2.5 ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>Include in this link:</div>
                    <div className="space-y-1 mb-5">
                      {sortedShareable.map(claim => {
                        // Skip primary in the toggleable list â€” it's pinned above
                        if (primaryClaim && claim.id === primaryClaim.id) return null;
                        const provider = STAMP_PROVIDERS.find(p => p.id === claim.provider);
                        if (!provider) return null;
                        const vis = claim.visibility || 'public';
                        const isOn = selections[claim.provider];
                        const isTempUnlocked = vis !== 'public';

                        return (
                          <div key={claim.provider}
                            className={`rounded-lg px-2.5 py-2 flex items-center gap-2 ${darkMode ? 'bg-white/[0.04] border border-white/[0.08]' : 'bg-white border border-gray-200'}`}>
                            <div className="w-5 flex items-center justify-center flex-shrink-0">
                              <StampIcon provider={provider} size={14} />
                            </div>
                            <span className={`text-xs flex-1 min-w-0 truncate ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                              {formatStampDisplay(claim.provider, claim.value) || claim.label}
                            </span>
                            {isTempUnlocked && (
                              <span className={`text-[9px] flex-shrink-0 ${
                                vis === 'locked' ? (darkMode ? 'text-red-500' : 'text-red-600') : (darkMode ? 'text-amber-500' : 'text-amber-600')
                              }`}>
                                {vis === 'locked' ? 'Normally locked' : 'Normally private'}
                              </span>
                            )}
                            <button onClick={() => setSelections(prev => ({ ...prev, [claim.provider]: !prev[claim.provider] }))}
                              className={`w-9 h-5 rounded-full flex items-center transition-colors btn-feedback flex-shrink-0 ${getToggleColor(claim, isOn)}`}>
                              <div className={`w-3.5 h-3.5 rounded-full mx-0.5 transition-transform ${
                                isOn ? 'translate-x-4 bg-white' : 'translate-x-0 bg-white/80'
                              }`} />
                            </button>
                          </div>
                        );
                      })}
                    </div>
                  </>
                )}

                <button onClick={handleCopyLink}
                  className={`w-full py-3 rounded-xl font-semibold text-sm btn-feedback transition-colors ${
                    copied
                      ? (darkMode ? 'bg-emerald-600/30 text-emerald-400' : 'bg-emerald-100 text-emerald-700')
                      : 'bg-gradient-to-r from-violet-600 to-fuchsia-600 text-white hover:from-violet-500 hover:to-fuchsia-500'
                  }`}>
                  {copied ? '\u2713 Copied!' : 'Copy Link'}
                </button>
              </>
            )}
          </div>
        </div>
      )}
    </>
  );
};

// PublicProfileScreen â€” Read-only public view of a user's profile
const PublicProfileScreen = ({ darkMode, profileId, onCreateAccount }) => {
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [profileData, setProfileData] = useState(null);

  useEffect(() => {
    if (!profileId) { setError('No profile ID'); setLoading(false); return; }
    (async () => {
      const result = await loadPublicProfile(profileId);
      if (!result) {
        setError('Profile not found');
      } else {
        setProfileData(result);
      }
      setLoading(false);
    })();
  }, [profileId]);

  if (loading) {
    return (
      <div className={`flex-1 flex items-center justify-center ${darkMode ? 'bg-gray-950 text-white' : 'bg-gray-50 text-gray-900'}`}>
        <div className="text-center">
          <div className={`text-2xl mb-2 ${darkMode ? 'text-violet-400' : 'text-violet-600'}`}>âœ¦</div>
          <div className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>Loading profile...</div>
        </div>
      </div>
    );
  }

  if (error || !profileData) {
    return (
      <div className={`flex-1 flex items-center justify-center ${darkMode ? 'bg-gray-950 text-white' : 'bg-gray-50 text-gray-900'}`}>
        <div className="text-center px-8">
          <div className="text-3xl mb-3">ðŸ‘»</div>
          <div className={`font-semibold mb-1 ${darkMode ? 'text-white' : 'text-gray-900'}`}>Profile not found</div>
          <div className={`text-sm mb-6 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>This link may be expired or invalid.</div>
          <button onClick={onCreateAccount}
            className="px-6 py-2.5 rounded-xl bg-violet-600 text-white font-medium text-sm hover:bg-violet-500 btn-feedback">
            Create Your Aura
          </button>
        </div>
      </div>
    );
  }

  const { profile, claims } = profileData;
  const summary = profile.profile_summary || {};
  const initial = (profile.display_name || 'A')[0].toUpperCase();

  // Primary stamp â€” the user's public identity
  const primaryClaim = claims.find(c => c.weight === 1);
  const primaryProvider = primaryClaim ? STAMP_PROVIDERS.find(p => p.id === primaryClaim.provider) : null;

  // Filter claims: ?s= param selects specific providers; no ?s= shows all (already public from DB)
  const sParam = new URLSearchParams(window.location.search).get('s');
  const selectedProviders = sParam ? sParam.split(',').map(s => s.trim()) : null;
  const visibleClaims = claims.filter(c => {
    if (c.provider === 'email') return false; // Email never shown publicly
    if (primaryClaim && c.id === primaryClaim.id) return false; // Primary shown in header
    if (selectedProviders) return selectedProviders.includes(c.provider);
    return true; // All claims from loadPublicProfile are already public-visibility
  });

  return (
    <div className={`flex-1 flex flex-col overflow-hidden ${darkMode ? 'text-white bg-gray-950' : 'text-gray-900 bg-gray-50'}`}>
      <div className="flex-1 p-4 overflow-y-auto space-y-4">
        {/* Avatar + Name + Primary Stamp */}
        <div className="flex flex-col items-center pt-4 pb-2">
          <div className="w-20 h-20 bg-gradient-to-br from-violet-500 to-fuchsia-500 rounded-full flex items-center justify-center font-bold text-2xl text-white mb-3"
            style={{ boxShadow: '0 0 20px 6px rgba(139,92,246,0.3), 0 0 30px 10px rgba(217,70,239,0.15)' }}>
            {initial}
          </div>
          <h2 className="font-semibold text-xl">{profile.display_name || 'Aura User'}</h2>
          {primaryProvider && primaryClaim.provider !== 'email' && (
            <div className={`flex items-center gap-1.5 mt-1.5 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
              <StampIcon provider={primaryProvider} size={13} />
              <span className="text-sm font-medium">
                {formatStampDisplay(primaryClaim.provider, primaryClaim.value) || primaryClaim.label || primaryProvider.name}
              </span>
            </div>
          )}
          {summary.entity_type === 'ai' && (
            <span className={`text-xs mt-1 px-2 py-0.5 rounded-full ${darkMode ? 'bg-cyan-500/20 text-cyan-400' : 'bg-cyan-100 text-cyan-700'}`}>AI Entity</span>
          )}
        </div>

        {/* Stats */}
        <div className={`rounded-2xl px-4 py-3 flex items-center justify-around ${darkMode ? 'bg-gray-900/40 border border-gray-800/40' : 'bg-white border border-gray-200'}`}>
          <div className="text-center">
            <div className={`text-lg font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>{summary.assessment_count || 0}</div>
            <div className={`text-[10px] ${darkMode ? 'text-gray-500' : 'text-gray-500'}`}>Assessments</div>
          </div>
          <div className={`w-px h-8 ${darkMode ? 'bg-gray-800' : 'bg-gray-200'}`} />
          <div className="text-center">
            <div className={`text-lg font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>{summary.stamp_count || 0}</div>
            <div className={`text-[10px] ${darkMode ? 'text-gray-500' : 'text-gray-500'}`}>Stamps</div>
          </div>
        </div>

        {/* Public Stamps */}
        {visibleClaims.length > 0 && (
          <div className="space-y-1.5">
            <div className={`text-xs font-medium uppercase tracking-wide ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>Linked Accounts</div>
            {visibleClaims.map(claim => {
              const provider = STAMP_PROVIDERS.find(p => p.id === claim.provider);
              if (!provider) return null;
              return (
                <div key={claim.id} className={`rounded-xl px-3 py-2.5 flex items-center gap-3 ${darkMode ? 'bg-white/[0.04] border border-white/[0.08]' : 'bg-white border border-gray-200'}`}>
                  <div className="w-6 flex items-center justify-center">
                    <StampIcon provider={provider} />
                  </div>
                  <span className={`text-sm font-medium flex-1 ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                    {formatStampDisplay(claim.provider, claim.value) || claim.label || provider.name}
                  </span>
                  <span className={`text-[10px] px-2 py-0.5 rounded-full font-medium ${
                    claim.proof_status === 'verified'
                      ? (darkMode ? 'bg-emerald-500/20 text-emerald-400' : 'bg-emerald-100 text-emerald-700')
                      : (darkMode ? 'bg-gray-700/50 text-gray-400' : 'bg-gray-100 text-gray-500')
                  }`}>
                    {claim.proof_status === 'verified' ? 'Verified' : 'Self-reported'}
                  </span>
                </div>
              );
            })}
          </div>
        )}

        {/* CTA */}
        <div className="pt-4 pb-8">
          <button onClick={onCreateAccount}
            className="w-full py-3 rounded-xl bg-gradient-to-r from-violet-600 to-fuchsia-600 text-white font-semibold text-sm hover:from-violet-500 hover:to-fuchsia-500 btn-feedback">
            Create Your Aura
          </button>
        </div>
      </div>
    </div>
  );
};

// Visibility tier config
// Visibility bounce: Public â†’ Private â†’ Locked â†’ Private â†’ Public â†’ ...
// Direction tracked via _visDir flag on the click handler
const VISIBILITY_NEXT = (current, direction) => {
  if (current === 'public') return 'private';
  if (current === 'locked') return 'private';
  // private â€” direction determines which way
  return direction === 'up' ? 'locked' : 'public';
};
const VISIBILITY_TIERS = {
  public: { label: 'Public' },
  private: { label: 'Private' },
  locked: { label: 'Locked' }
};

// StampRow â€” Mobile-friendly two-line card per linked account
const StampRow = ({ provider, claim, isEmail, isLinked, darkMode, onLink, onUnlink, onVisibilityChange, isTempUnlocked, onTempUnlock, isPrimary, onSetPrimary, onPrimaryTap }) => {
  const [editing, setEditing] = useState(false);
  const [inputValue, setInputValue] = useState('');
  const [saving, setSaving] = useState(false);
  const [confirmUnlink, setConfirmUnlink] = useState(false);
  const [visDirection, setVisDirection] = useState('up');

  const handleSave = async () => {
    const normalized = normalizeStampValue(provider.id, inputValue);
    if (!normalized) return;
    setSaving(true);
    await onLink(normalized);
    setSaving(false);
    setEditing(false);
    setInputValue('');
  };

  const visibility = claim?.visibility || 'public';
  const visTier = VISIBILITY_TIERS[visibility] || VISIBILITY_TIERS.public;
  const isHidden = visibility !== 'public';

  const handleVisibilityTap = () => {
    const next = VISIBILITY_NEXT(visibility, visDirection);
    if (visibility === 'public') setVisDirection('up');
    else if (visibility === 'locked') setVisDirection('down');
    onVisibilityChange && onVisibilityChange(next);
  };

  // Editing state â€” inline input
  if (editing) {
    return (
      <div className={`rounded-xl px-3 py-3 space-y-2 ${darkMode ? 'bg-white/[0.04] border border-white/[0.08]' : 'bg-white border border-gray-200'}`}>
        <div className="flex items-center gap-2.5">
          <StampIcon provider={provider} size={18} />
          <span className={`text-sm font-medium ${darkMode ? 'text-white' : 'text-gray-900'}`}>{provider.name}</span>
        </div>
        <div className={`flex items-center rounded-lg border ${darkMode ? 'bg-white/[0.06] border-white/10' : 'bg-white border-gray-300'}`}>
          {provider.prefix && (
            <span className={`text-sm pl-2.5 select-none ${darkMode ? 'text-gray-600' : 'text-gray-400'}`}>{provider.prefix}</span>
          )}
          <input
            type="text"
            value={inputValue}
            onChange={(e) => setInputValue(e.target.value)}
            onKeyDown={(e) => { if (e.key === 'Enter') handleSave(); if (e.key === 'Escape') setEditing(false); }}
            onFocus={(e) => e.target.select()}
            placeholder={provider.placeholder || 'username'}
            autoFocus
            className={`text-sm flex-1 min-w-0 px-2 py-2 bg-transparent outline-none ${darkMode ? 'text-white placeholder-gray-600' : 'text-gray-900 placeholder-gray-400'}`}
          />
        </div>
        <div className="flex gap-2">
          <button onClick={handleSave} disabled={saving || !inputValue.trim()}
            className={`flex-1 py-2 rounded-lg text-sm font-medium btn-feedback ${darkMode ? 'bg-emerald-600/30 text-emerald-400 disabled:opacity-30' : 'bg-emerald-100 text-emerald-700 disabled:opacity-30'}`}>
            {saving ? '...' : 'Save'}
          </button>
          <button onClick={() => setEditing(false)}
            className={`px-4 py-2 rounded-lg text-sm btn-feedback ${darkMode ? 'bg-white/[0.06] text-gray-400' : 'bg-gray-100 text-gray-500'}`}>
            Cancel
          </button>
        </div>
      </div>
    );
  }

  // Confirm unlink
  if (confirmUnlink) {
    return (
      <div className={`rounded-xl px-3 py-3 space-y-2.5 ${darkMode ? 'bg-red-950/30 border border-red-800/30' : 'bg-red-50 border border-red-200'}`}>
        <div className="flex items-center gap-2.5">
          <StampIcon provider={provider} size={18} />
          <span className={`text-sm flex-1 ${darkMode ? 'text-red-300' : 'text-red-700'}`}>
            Remove {provider.name}?
          </span>
        </div>
        <div className="flex gap-2">
          <button onClick={() => { setConfirmUnlink(false); onUnlink(); }}
            className={`flex-1 py-2 rounded-lg text-sm font-medium btn-feedback ${darkMode ? 'bg-red-600/40 text-red-300' : 'bg-red-100 text-red-700'}`}>
            Remove
          </button>
          <button onClick={() => setConfirmUnlink(false)}
            className={`flex-1 py-2 rounded-lg text-sm btn-feedback ${darkMode ? 'bg-white/[0.06] text-gray-400' : 'bg-gray-100 text-gray-500'}`}>
            Keep
          </button>
        </div>
      </div>
    );
  }

  // Unlinked â€” provider name + Link button
  if (!isLinked) {
    return (
      <button onClick={() => { setEditing(true); setInputValue(''); }}
        className={`w-full rounded-xl px-3 py-3 flex items-center gap-3 btn-feedback ${darkMode ? 'bg-white/[0.03] border border-white/[0.06]' : 'bg-gray-50 border border-gray-200'}`}>
        <div className="opacity-40"><StampIcon provider={provider} size={18} /></div>
        <span className={`text-sm flex-1 text-left ${darkMode ? 'text-gray-600' : 'text-gray-400'}`}>{provider.name}</span>
        <span className={`text-xs font-medium ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>+ Link</span>
      </button>
    );
  }

  // Linked â€” two-line card: name row + action row
  const isVerified = isEmail || claim.proof_status === 'verified';
  const isLocked = visibility === 'locked';
  return (
    <div className={`rounded-xl px-3 py-3 space-y-2 ${darkMode ? 'bg-white/[0.04] border border-white/[0.08]' : 'bg-white border border-gray-200'}`}>
      {/* Row 1: Icon + value + primary badge */}
      <div className="flex items-center gap-2.5">
        <StampIcon provider={provider} size={18} />
        <span className={`text-sm font-medium flex-1 min-w-0 truncate ${darkMode ? 'text-white' : 'text-gray-900'}`}>
          {formatStampDisplay(provider.id, claim.value) || claim.label || provider.name}
        </span>
        {isVerified && <span className={`text-xs ${darkMode ? 'text-emerald-400' : 'text-emerald-600'}`}>âœ“</span>}
        {isPrimary && (
          <span
            className={`text-xs font-medium select-none ${darkMode ? 'text-amber-400' : 'text-amber-500'}`}
            onContextMenu={(e) => { e.preventDefault(); onPrimaryTap && onPrimaryTap(); }}
            onTouchStart={(e) => {
              const timer = setTimeout(() => { onPrimaryTap && onPrimaryTap(); }, 600);
              e.target._lpTimer = timer;
            }}
            onTouchEnd={(e) => { clearTimeout(e.target._lpTimer); }}
            onTouchMove={(e) => { clearTimeout(e.target._lpTimer); }}
          >â˜… Primary</span>
        )}
      </div>
      {/* Row 2: Actions â€” only for non-primary, non-email */}
      {isPrimary ? null : !isEmail ? (
        <div className="flex items-center gap-2">
          <button onClick={handleVisibilityTap}
            className={`text-xs px-2.5 py-1 rounded-lg font-medium btn-feedback ${
              isLocked ? (darkMode ? 'bg-red-500/10 text-red-400' : 'bg-red-50 text-red-600')
              : isHidden ? (darkMode ? 'bg-amber-500/10 text-amber-400' : 'bg-amber-50 text-amber-600')
              : (darkMode ? 'bg-emerald-500/10 text-emerald-400' : 'bg-emerald-50 text-emerald-600')
            }`}>
            {visTier.label}
          </button>
          {isHidden && (
            <button onClick={() => onTempUnlock && onTempUnlock(provider.id)}
              className={`text-xs px-2.5 py-1 rounded-lg font-medium btn-feedback ${
                isTempUnlocked
                  ? (darkMode ? 'bg-violet-500/20 text-violet-300' : 'bg-violet-100 text-violet-700')
                  : (darkMode ? 'bg-white/[0.06] text-gray-500' : 'bg-gray-100 text-gray-400')
              }`}>
              {isTempUnlocked ? 'âœ“ Shared' : 'Share once'}
            </button>
          )}
          <div className="flex-1" />
          <button onClick={() => setConfirmUnlink(true)}
            className={`text-xs px-2.5 py-1 rounded-lg btn-feedback ${darkMode ? 'bg-white/[0.06] text-gray-600 hover:text-red-400' : 'bg-gray-100 text-gray-300 hover:text-red-500'}`}>
            Remove
          </button>
        </div>
      ) : null}
    </div>
  );
};

// IdentityScreen â€” Full stamp management with sharing
const IDENTITY_STORAGE_KEY = 'aura-identity-v1';
const IDENTITY_ONBOARDING_KEY = 'aura-identity-onboarding-v1';
const identityLoad = () => { try { return JSON.parse(localStorage.getItem(IDENTITY_STORAGE_KEY)) || {}; } catch { return {}; } };
const identitySave = (data) => { try { localStorage.setItem(IDENTITY_STORAGE_KEY, JSON.stringify(data)); } catch {} };
const identityOnboardingLoad = () => { try { return JSON.parse(localStorage.getItem(IDENTITY_ONBOARDING_KEY)) || null; } catch { return null; } };
const identityOnboardingSave = (data) => { try { localStorage.setItem(IDENTITY_ONBOARDING_KEY, JSON.stringify(data)); } catch {} };

// Identity onboarding questions â€” conversational, helps find connections
const IDENTITY_ONBOARDING_QUESTIONS = [
  { id: 'source', color: 'emerald', sectionLabel: 'Getting Started', text: 'How did you find Aura?', type: 'single',
    options: ['A friend told me about it', 'Just exploring on my own', 'I want to prove my identity', 'Someone sent me a link'] },
  { id: 'referrer', color: 'emerald', sectionLabel: 'Getting Started', text: 'Who told you about it?', type: 'text', placeholder: 'Their name or username',
    conditional: (a) => a.source === 'A friend told me about it' || a.source === 'Someone sent me a link' },
  { id: 'know-anyone', color: 'blue', sectionLabel: 'Connections', text: 'Do you know anyone already using Aura?', type: 'single',
    options: ["Yeah, I think so", "Maybe â€” not sure", "Nope, I'm new here"] },
  { id: 'connection-name', color: 'blue', sectionLabel: 'Connections', text: 'Who? We\'ll help you find them.', type: 'text', placeholder: 'Their name or username',
    conditional: (a) => a['know-anyone'] === "Yeah, I think so" || a['know-anyone'] === "Maybe â€” not sure" },
  { id: 'location', color: 'emerald', sectionLabel: 'About You', text: 'Where are you based?', type: 'text', placeholder: 'City, Country',
    subtitle: 'Helps connect you with people nearby. Private by default.' },
];

// IdentityOnboarding â€” guided setup flow, gates Identity screen on first visit
const IdentityOnboarding = ({ darkMode, onComplete, onBack }) => {
  const [answers, setAnswers] = useState({});
  const [currentScreenId, setCurrentScreenId] = useState(IDENTITY_ONBOARDING_QUESTIONS[0].id);
  const [animKey, setAnimKey] = useState(0);

  const activeQuestions = useMemo(() => {
    return IDENTITY_ONBOARDING_QUESTIONS.filter(q => !q.conditional || q.conditional(answers));
  }, [answers]);

  const allScreenIds = activeQuestions.map(q => q.id);
  const currentIdx = allScreenIds.indexOf(currentScreenId);
  const currentQ = IDENTITY_ONBOARDING_QUESTIONS.find(q => q.id === currentScreenId);

  const goToScreen = (id) => { setAnimKey(k => k + 1); setCurrentScreenId(id); };
  const advance = () => {
    // Recompute active list with current answers (may have changed from this answer)
    const freshActive = IDENTITY_ONBOARDING_QUESTIONS.filter(q => !q.conditional || q.conditional(answers)).map(q => q.id);
    const freshIdx = freshActive.indexOf(currentScreenId);
    const nextIdx = freshIdx + 1;
    if (nextIdx < freshActive.length) goToScreen(freshActive[nextIdx]);
    else {
      // Save location as first check-in if provided
      if (answers.location?.trim()) {
        const existing = identityLoad();
        const checkins = [...(existing.checkins || []), { location: answers.location.trim(), date: new Date().toISOString() }];
        identitySave({ ...existing, checkins });
      }
      identityOnboardingSave(answers);
      onComplete(answers);
    }
  };
  const goBack = () => {
    if (currentIdx > 0) goToScreen(allScreenIds[currentIdx - 1]);
    else onBack();
  };
  const handleAnswer = (val) => setAnswers(prev => ({ ...prev, [currentScreenId]: val }));

  if (!currentQ) return null;

  const isSingle = currentQ.type === 'single';
  const isText = currentQ.type === 'text';
  const handleSingleAnswer = (val) => { handleAnswer(val); setTimeout(() => {
    // Recompute after state update
    const fresh = { ...answers, [currentScreenId]: val };
    const freshActive = IDENTITY_ONBOARDING_QUESTIONS.filter(q => !q.conditional || q.conditional(fresh)).map(q => q.id);
    const freshIdx = freshActive.indexOf(currentScreenId);
    if (freshIdx + 1 < freshActive.length) goToScreen(freshActive[freshIdx + 1]);
    else {
      if (fresh.location?.trim()) {
        const existing = identityLoad();
        const checkins = [...(existing.checkins || []), { location: fresh.location.trim(), date: new Date().toISOString() }];
        identitySave({ ...existing, checkins });
      }
      identityOnboardingSave(fresh);
      onComplete(fresh);
    }
  }, 300); };

  const needsContinueButton = isText;
  const continueDisabled = isText ? !(answers[currentScreenId] || '').trim() : false;

  return (
    <VerifyScreenLayout darkMode={darkMode} color={currentQ.color} sectionLabel={currentQ.sectionLabel}
      progress={currentIdx} total={allScreenIds.length}
      onBack={goBack}
      buttons={
        <div className="flex flex-col gap-2">
          {needsContinueButton && <VerifyActionButton label="Continue" color={currentQ.color} darkMode={darkMode} onClick={advance} disabled={continueDisabled} />}
          {isText && <button onClick={() => { handleAnswer(''); advance(); }}
            className={`text-xs py-2 transition-colors ${TH('text-subtle', darkMode)}`}>
            Skip
          </button>}
        </div>
      }>
      <div key={`iq-${currentScreenId}-${animKey}`} className="flex flex-col items-center gap-5 w-full mt-4" style={{ animation: 'fadeSlideIn 0.4s ease-out both' }}>
        <h2 className={`question-text font-semibold px-2 text-center ${TH('text-primary', darkMode)}`}>{currentQ.text}</h2>
        {currentQ.subtitle && <p className={`text-xs text-center -mt-2 px-4 ${TH('text-muted', darkMode)}`}>{currentQ.subtitle}</p>}
        {isSingle && <VerifySingleSelect question={currentQ} color={currentQ.color} darkMode={darkMode} answer={answers[currentScreenId]} onAnswer={handleSingleAnswer} answers={answers} />}
        {isText && <VerifyTextInput question={currentQ} color={currentQ.color} darkMode={darkMode} answer={answers[currentScreenId]} onAnswer={handleAnswer} onContinue={advance} />}
      </div>
    </VerifyScreenLayout>
  );
};

// Human-readable labels for gateway verify signals
const VERIFY_SIGNAL_LABELS = {
  socialDepth: {
    label: 'Social closeness',
    values: ['Close relationships run deep', 'A few people really know you', 'You keep most people at arm\'s length'],
  },
  consistency: {
    label: 'Consistency',
    values: ['Creature of habit â€” same routines, same accounts', 'Somewhat consistent', 'Likes to mix things up'],
  },
  depth: {
    label: 'Focus style',
    values: ['Goes deep on one thing', 'Depends on the topic', 'Prefers variety'],
  },
  adaptability: {
    label: 'Adaptability',
    values: ['Rolls with whatever comes', 'Adapts after a moment', 'Likes knowing what\'s next'],
  },
  openToContact: {
    label: 'Openness to new people',
    values: ['Jumps in â€” life\'s short', 'Cautious but curious', 'Sticks with what they know'],
  },
};

const IdentityScreen = ({ darkMode, userClaims, onClaimsChange, assessCompleted, entityType, displayName, onBack }) => {
  const [onboardingDone, setOnboardingDone] = useState(() => !!identityOnboardingLoad());
  const [tempUnlocked, setTempUnlocked] = useState({});
  const [showUnlinked, setShowUnlinked] = useState(false);
  const [choosingPrimary, setChoosingPrimary] = useState(false);
  // Self-verification fields (location check-ins) â€” must be above gate for hooks rules
  const [selfVerify, setSelfVerify] = useState(identityLoad);
  const toggleTempUnlock = (providerId) => {
    setTempUnlocked(prev => ({ ...prev, [providerId]: !prev[providerId] }));
  };
  const updateSelfVerify = (key, val) => {
    setSelfVerify(prev => {
      const next = { ...prev, [key]: val };
      identitySave(next);
      return next;
    });
  };

  // Gateway verify signals
  const verifySignals = assessCompleted?.['quick-profile']?.verifySignals || null;

  // Gate: show onboarding flow if not completed
  if (!onboardingDone) {
    return (
      <IdentityOnboarding darkMode={darkMode}
        onComplete={() => setOnboardingDone(true)}
        onBack={onBack} />
    );
  }

  const primaryClaim = (userClaims || []).find(c => c.weight === 1);
  const primaryClaimId = primaryClaim?.id || null;

  const handleSetPrimary = (claimId) => {
    const user = getCurrentUser();
    if (!user) return;
    const prev = userClaims || [];
    const optimistic = prev.map(c => ({
      ...c,
      weight: c.id === claimId ? 1 : 0,
      visibility: c.id === claimId ? 'public' : c.visibility
    }));
    onClaimsChange(optimistic);
    setPrimaryClaim(user.id, claimId).then(ok => {
      if (!ok) onClaimsChange(prev);
    });
  };

  const claimsByProvider = {};
  (userClaims || []).forEach(c => { claimsByProvider[c.provider] = c; });
  const linked = STAMP_PROVIDERS.filter(p => !!claimsByProvider[p.id]).sort((a, b) => a.priority - b.priority);
  const unlinked = STAMP_PROVIDERS.filter(p => !claimsByProvider[p.id]).sort((a, b) => a.priority - b.priority);
  const noneLinked = linked.length === 0;

  const renderStampRow = (provider) => {
    const claim = claimsByProvider[provider.id];
    const isEmail = provider.id === 'email';
    const isLinked = !!claim;
    return (
      <StampRow
        key={provider.id}
        provider={provider}
        claim={claim}
        isEmail={isEmail}
        isLinked={isLinked}
        darkMode={darkMode}
        isPrimary={!!claim && claim.id === primaryClaimId}
        onSetPrimary={handleSetPrimary}
        onPrimaryTap={() => setChoosingPrimary(!choosingPrimary)}
        onLink={async (value) => {
          const user = getCurrentUser();
          if (!user) return;
          const displayLabel = formatStampDisplay(provider.id, value) || provider.name;
          const result = await createAccountClaim(user.id, provider.id, displayLabel, value);
          if (result) {
            const optimistic = [...(userClaims || []), result];
            onClaimsChange(optimistic);
            updateProfileSummary(user.id, assessCompleted, optimistic, entityType);
          }
        }}
        onUnlink={() => {
          const user = getCurrentUser();
          if (!user || !claim) return;
          const prev = userClaims || [];
          const optimistic = prev.filter(c => c.id !== claim.id);
          onClaimsChange(optimistic);
          removeClaim(claim.id, user.id).then(ok => {
            if (ok) {
              updateProfileSummary(user.id, assessCompleted, optimistic, entityType);
            } else {
              onClaimsChange(prev);
            }
          });
        }}
        onVisibilityChange={(newVisibility) => {
          const user = getCurrentUser();
          if (!user || !claim) return;
          const prev = userClaims || [];
          const optimistic = prev.map(c => c.id === claim.id ? { ...c, visibility: newVisibility } : c);
          onClaimsChange(optimistic);
          updateClaimVisibility(claim.id, user.id, newVisibility).then(ok => {
            if (ok) {
              updateProfileSummary(user.id, assessCompleted, optimistic, entityType);
            } else {
              onClaimsChange(prev);
            }
          });
        }}
        isTempUnlocked={!!tempUnlocked[provider.id]}
        onTempUnlock={toggleTempUnlock}
      />
    );
  };

  return (
    <div className={`flex-1 flex flex-col overflow-hidden ${darkMode ? 'text-white bg-gray-950' : 'text-gray-900 bg-gray-50'}`}>
      <div className={`h-[44px] flex-shrink-0 flex items-center gap-2 px-3 border-b ${TH('border-base', darkMode)}`}>
        <button onClick={onBack} className={darkMode ? 'text-gray-400' : 'text-gray-500'}>â†</button>
        <span className="font-medium flex-1">Identity</span>
        {getCurrentUser() && <SharePicker darkMode={darkMode} userId={getCurrentUser().id}
          userClaims={userClaims} displayName={displayName} assessmentCount={Object.keys(assessCompleted).length}
          tempUnlocked={tempUnlocked}
          onSetPrimary={handleSetPrimary}
          onMakePublic={(claimId) => {
            const user = getCurrentUser();
            if (!user) return;
            const prev = userClaims || [];
            const optimistic = prev.map(c => c.id === claimId ? { ...c, visibility: 'public' } : c);
            onClaimsChange(optimistic);
            setTempUnlocked(p => {
              const next = { ...p };
              const claim = prev.find(c => c.id === claimId);
              if (claim) delete next[claim.provider];
              return next;
            });
            updateClaimVisibility(claimId, user.id, 'public').then(ok => {
              if (!ok) onClaimsChange(prev);
            });
          }}
        />}
      </div>
      <div className="flex-1 p-4 overflow-y-auto space-y-3">
        {/* Email display */}
        {getCurrentEmail() && (
          <div className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>{getCurrentEmail()}</div>
        )}

        {/* Linked accounts (unlocks at tier 3: 5+ assessments or logged in) */}
        {getFeatureTier(assessCompleted, !!getCurrentUser()) >= 3 && <div className="space-y-2">
          <div className={`text-xs font-medium uppercase tracking-wide ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>Linked Accounts</div>
          {linked.map(renderStampRow)}
          {/* Inline primary picker */}
          {choosingPrimary && linked.length > 1 && (
            <div className={`rounded-xl px-3 py-3 space-y-2 ${darkMode ? 'bg-amber-950/20 border border-amber-800/20' : 'bg-amber-50 border border-amber-200'}`}>
              <div className={`text-xs font-medium ${darkMode ? 'text-amber-400' : 'text-amber-600'}`}>Choose primary identity</div>
              {linked.filter(p => {
                const c = claimsByProvider[p.id];
                return c && c.id !== primaryClaimId;
              }).map(p => {
                const c = claimsByProvider[p.id];
                return (
                  <button key={p.id} onClick={() => { handleSetPrimary(c.id); setChoosingPrimary(false); }}
                    className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-lg btn-feedback text-left ${darkMode ? 'bg-white/[0.04] hover:bg-white/[0.08]' : 'bg-white hover:bg-amber-50'}`}>
                    <StampIcon provider={p} size={18} />
                    <span className={`text-sm flex-1 truncate ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                      {formatStampDisplay(p.id, c.value) || c.label || p.name}
                    </span>
                    <span className={`text-xs ${darkMode ? 'text-amber-400/60' : 'text-amber-500/60'}`}>â˜†</span>
                  </button>
                );
              })}
              <button onClick={() => setChoosingPrimary(false)}
                className={`text-xs w-full text-center py-1.5 rounded-lg btn-feedback ${darkMode ? 'text-gray-500 bg-white/[0.04]' : 'text-gray-400 bg-gray-100'}`}>
                Cancel
              </button>
            </div>
          )}
          {/* Unlinked stamps */}
          {unlinked.length > 0 && (noneLinked ? (
            unlinked.map(renderStampRow)
          ) : (
            <>
              <button onClick={() => setShowUnlinked(!showUnlinked)}
                className={`w-full text-left text-sm px-3 py-2.5 rounded-xl btn-feedback ${darkMode ? 'text-gray-500 hover:text-gray-300 bg-white/[0.02] hover:bg-white/[0.04] border border-white/[0.06]' : 'text-gray-400 hover:text-gray-600 bg-gray-50 hover:bg-gray-100 border border-gray-200'}`}>
                {showUnlinked ? 'âˆ’ Hide unlinked' : `+ Link account (${unlinked.length} available)`}
              </button>
              {showUnlinked && unlinked.map(renderStampRow)}
            </>
          ))}
        </div>}

        {/* From Your Answers â€” gateway verify signals */}
        {verifySignals && Object.keys(verifySignals).length > 0 && (
          <div className="space-y-2">
            <div className={`text-xs font-medium uppercase tracking-wide ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>From Your Answers</div>
            <div className={`rounded-xl overflow-hidden ${darkMode ? 'bg-white/[0.03] border border-white/[0.06]' : 'bg-gray-50 border border-gray-200'}`}>
              {Object.entries(verifySignals).map(([key, optIdx], i) => {
                const info = VERIFY_SIGNAL_LABELS[key];
                if (!info || info.values[optIdx] === undefined) return null;
                return (
                  <div key={key} className={`px-3 py-2.5 flex items-start gap-3 ${i > 0 ? (darkMode ? 'border-t border-white/[0.04]' : 'border-t border-gray-100') : ''}`}>
                    <div className="flex-1">
                      <div className={`text-xs ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>{info.label}</div>
                      <div className={`text-sm mt-0.5 ${darkMode ? 'text-gray-200' : 'text-gray-700'}`}>{info.values[optIdx]}</div>
                    </div>
                    <div className={`text-xs px-1.5 py-0.5 rounded ${darkMode ? 'bg-white/[0.04] text-gray-500' : 'bg-gray-200 text-gray-400'}`}>private</div>
                  </div>
                );
              })}
            </div>
            <p className={`text-xs ${darkMode ? 'text-gray-600' : 'text-gray-400'}`}>
              Gathered from your assessment answers. Private by default â€” you choose what to share.
            </p>
          </div>
        )}

        {/* Location Check-in */}
        <div className="space-y-2">
          <div className={`text-xs font-medium uppercase tracking-wide ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>Location</div>
          {selfVerify.checkins?.length > 0 ? (
            <div className={`rounded-xl overflow-hidden ${darkMode ? 'bg-white/[0.03] border border-white/[0.06]' : 'bg-gray-50 border border-gray-200'}`}>
              {selfVerify.checkins.slice(-3).reverse().map((ci, i) => (
                <div key={i} className={`px-3 py-2.5 flex items-center gap-3 ${i > 0 ? (darkMode ? 'border-t border-white/[0.04]' : 'border-t border-gray-100') : ''}`}>
                  <span className="text-sm">ðŸ“</span>
                  <div className="flex-1">
                    <div className={`text-sm ${darkMode ? 'text-gray-200' : 'text-gray-700'}`}>{ci.location}</div>
                    <div className={`text-xs ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>{new Date(ci.date).toLocaleDateString()}</div>
                  </div>
                  <div className={`text-xs px-1.5 py-0.5 rounded ${darkMode ? 'bg-white/[0.04] text-gray-500' : 'bg-gray-200 text-gray-400'}`}>private</div>
                </div>
              ))}
            </div>
          ) : null}
          {/* Check-in input */}
          <div className={`rounded-xl px-3 py-2.5 flex items-center gap-3 ${darkMode ? 'bg-white/[0.03] border border-white/[0.06]' : 'bg-gray-50 border border-gray-200'}`}>
            <span className="text-sm">ðŸ“</span>
            <input type="text" value={selfVerify._checkinDraft || ''} onChange={e => updateSelfVerify('_checkinDraft', e.target.value)}
              placeholder="Where are you? City, Country"
              maxLength={100}
              onKeyDown={e => {
                if (e.key === 'Enter' && selfVerify._checkinDraft?.trim()) {
                  const checkins = [...(selfVerify.checkins || []), { location: selfVerify._checkinDraft.trim(), date: new Date().toISOString() }];
                  setSelfVerify(prev => {
                    const next = { ...prev, checkins, _checkinDraft: '' };
                    identitySave(next);
                    return next;
                  });
                }
              }}
              className={`flex-1 text-sm bg-transparent outline-none ${darkMode ? 'text-white placeholder-gray-600' : 'text-gray-900 placeholder-gray-300'}`} />
            <button onClick={() => {
              if (!selfVerify._checkinDraft?.trim()) return;
              const checkins = [...(selfVerify.checkins || []), { location: selfVerify._checkinDraft.trim(), date: new Date().toISOString() }];
              setSelfVerify(prev => {
                const next = { ...prev, checkins, _checkinDraft: '' };
                identitySave(next);
                return next;
              });
            }} className={`text-xs font-medium px-2.5 py-1 rounded-lg ${selfVerify._checkinDraft?.trim()
              ? (darkMode ? 'bg-emerald-500/20 text-emerald-400 border border-emerald-500/30' : 'bg-emerald-100 text-emerald-600 border border-emerald-200')
              : (darkMode ? 'bg-white/[0.04] text-gray-600' : 'bg-gray-100 text-gray-300')}`}>
              Check in
            </button>
          </div>
          <p className={`text-xs ${darkMode ? 'text-gray-600' : 'text-gray-400'}`}>
            Timestamped check-ins build location history. Private until you choose to share.
          </p>
        </div>
      </div>
    </div>
  );
};

// ProfileScreen â€” Clean hub with personality + assessments
const ProfileScreen = ({ darkMode, responses, assessCompleted, stats, entityType, onboardingAnswers, onNavigate, userClaims, onClaimsChange, demoOverrides }) => {
  // Display name editing
  const [profileDisplayName, setProfileDisplayName] = useState(getDisplayName);
  const [editingProfileName, setEditingProfileName] = useState(false);
  const [profileNameInput, setProfileNameInput] = useState('');
  const [profileNameSaving, setProfileNameSaving] = useState(false);

  // Demo mode overrides â€” take over name and claims
  const effectiveName = demoOverrides?.name || profileDisplayName;
  const effectiveClaims = demoOverrides?.claims || userClaims;

  // Primary stamp â€” for identity card display
  const primaryClaim = (effectiveClaims || []).find(c => c.weight === 1);

  useEffect(() => {
    const handler = (e) => setProfileDisplayName(e.detail?.displayName || null);
    window.addEventListener('aura-profile-change', handler);
    return () => window.removeEventListener('aura-profile-change', handler);
  }, []);

  const handleProfileNameSave = async () => {
    const trimmed = profileNameInput.trim();
    if (!trimmed) return;
    const user = getCurrentUser();
    if (!user) return;
    setProfileNameSaving(true);
    const ok = await updateDisplayName(user.id, trimmed);
    setProfileNameSaving(false);
    if (ok) {
      setProfileDisplayName(trimmed);
      setEditingProfileName(false);
    }
  };

  // Archetype for personality section
  const archetype = calculateArchetype(assessCompleted);
  const hasPersonality = assessCompleted['quick-profile'] || Object.keys(assessCompleted).length > 0;

  // Aura glow colors for avatar
  const getAuraStyle = () => {
    if (!hasPersonality) return {};
    const colors = [];
    const violet = COLOR_HEX.violet.base;
    const blue = COLOR_HEX.blue.base;
    const emerald = COLOR_HEX.emerald.base;
    const pink = COLOR_HEX.pink.base;
    if (assessCompleted['quick-profile'] || assessCompleted['bigfive-O']?.score > 50) colors.push(violet);
    if (assessCompleted['bigfive-A']?.score > 50 || assessCompleted.attachment) colors.push(emerald);
    if (assessCompleted['bigfive-N'] || assessCompleted['shadow-P']) colors.push(pink);
    if (colors.length === 0) colors.push(blue);
    const primary = colors[0];
    const secondary = colors[1] || colors[0];
    return {
      boxShadow: `0 0 20px 6px ${primary}50, 0 0 30px 10px ${secondary}30`,
      border: `2px solid ${primary}80`
    };
  };

  const completedCount = Object.keys(assessCompleted).length;

  return (
    <div className={`flex-1 flex flex-col overflow-hidden ${darkMode ? 'text-white bg-gray-950' : 'text-gray-900 bg-gray-50'}`}>
      <div className={`h-[44px] flex-shrink-0 flex items-center gap-2 px-3 border-b ${TH('border-base', darkMode)}`}>
        <button onClick={() => onNavigate('categories')} className={darkMode ? 'text-gray-400' : 'text-gray-500'}>â†</button>
        <span className="font-medium flex-1">Profile</span>
        {demoOverrides && <span className="text-xs px-2 py-0.5 rounded-full bg-cyan-500/20 text-cyan-400 font-medium">Demo</span>}
      </div>
      <div className="flex-1 p-4 overflow-y-auto space-y-4">
        {/* Avatar with aura glow + basic stats */}
        <div className="flex items-center gap-4">
          {completedCount > 0 ? (
            <div className="w-16 h-16 flex-shrink-0" style={{ overflow: 'visible' }}>
              <AuraVisualization onboardingAnswers={onboardingAnswers} assessCompleted={assessCompleted}
                entityType={entityType} darkMode={darkMode} size={64} />
            </div>
          ) : (
            <div className="w-16 h-16 bg-gradient-to-br from-violet-500 to-fuchsia-500 rounded-full flex items-center justify-center font-bold text-xl text-white"
              style={getAuraStyle()}>
              {(effectiveName || getCurrentEmail() || 'G')[0].toUpperCase()}
            </div>
          )}
          <div className="flex-1">
            {editingProfileName ? (
              <div className="flex items-center gap-2">
                <input
                  type="text"
                  value={profileNameInput}
                  onChange={(e) => setProfileNameInput(e.target.value)}
                  onKeyDown={(e) => { if (e.key === 'Enter') handleProfileNameSave(); if (e.key === 'Escape') setEditingProfileName(false); }}
                  onFocus={(e) => e.target.select()}
                  placeholder="Display name"
                  autoFocus
                  maxLength={50}
                  className={`text-sm px-2 py-1 rounded border flex-1 min-w-0 ${darkMode ? 'bg-white/[0.06] border-white/10 text-white' : 'bg-white border-gray-300 text-gray-900'}`}
                />
                <button onClick={handleProfileNameSave} disabled={profileNameSaving} className={`text-xs px-2 py-1 rounded btn-feedback ${darkMode ? 'bg-violet-600/40 text-violet-300' : 'bg-violet-100 text-violet-700'}`}>
                  {profileNameSaving ? '...' : 'Save'}
                </button>
                <button onClick={() => setEditingProfileName(false)} className={`text-xs px-1.5 py-1 rounded btn-feedback ${TH('text-faint', darkMode)}`}>
                  âœ•
                </button>
              </div>
            ) : (
              <div className="flex items-center gap-2">
                <h2 className="font-semibold text-lg">{effectiveName || getCurrentEmail() || 'Guest'}</h2>
                {getCurrentUser() && !demoOverrides && (
                  <button onClick={() => { setProfileNameInput(profileDisplayName || ''); setEditingProfileName(true); }}
                    className={`text-xs px-1.5 py-0.5 rounded btn-feedback ${darkMode ? 'bg-white/[0.06] text-gray-500 hover:text-gray-300' : 'bg-gray-100 text-gray-500 hover:text-gray-700'}`}>
                    Edit
                  </button>
                )}
              </div>
            )}
            {/* Top trait label */}
            {(() => {
              if (archetype?.primary) {
                const ac = getAssessColor(archetype.primary.color, darkMode);
                return <div className={`text-xs mt-0.5 ${ac.text}`}>{archetype.primary.name}</div>;
              }
              if (assessCompleted['quick-profile']?.traits) {
                const t = assessCompleted['quick-profile'].traits;
                const labels = { O: 'Openness', C: 'Conscientiousness', E: 'Extraversion', A: 'Agreeableness', N: 'Neuroticism' };
                const top = Object.entries(t).sort((a, b) => b[1] - a[1])[0];
                if (top && top[1] > 55) return <div className={`text-xs mt-0.5 ${darkMode ? 'text-violet-400' : 'text-violet-600'}`}>High {labels[top[0]]}</div>;
              }
              return null;
            })()}
          </div>
        </div>

        {/* Personality Section - clickable to Analysis */}
        <button
          onClick={() => onNavigate('assess-analysis')}
          className={`w-full rounded-2xl overflow-hidden text-left ${darkMode ? 'bg-gradient-to-br from-violet-950/50 to-indigo-950/60 border border-violet-700/40 hover:border-violet-500/60' : 'bg-gradient-to-br from-violet-50 to-indigo-50 border border-violet-200 hover:border-violet-300'}`}
        >
          <div className="flex items-stretch min-h-[100px]">
            <div className="w-[100px] flex-shrink-0 flex items-center justify-center overflow-hidden rounded-l-2xl">
              <AuraVisualization onboardingAnswers={onboardingAnswers} assessCompleted={assessCompleted}
                entityType={entityType} darkMode={darkMode} size={100} />
            </div>
            <div className="flex-1 py-3 px-4 flex flex-col justify-center">
              <div className="flex items-center justify-between mb-0.5">
                <span className={`font-semibold ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                  {archetype?.primary ? archetype.primary.name : 'Your Personality'}
                </span>
                <span className={`text-sm ${darkMode ? 'text-violet-400' : 'text-violet-600'}`}>â†’</span>
              </div>
              <p className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                {archetype?.primary ? archetype.primary.tagline : (hasPersonality ? 'Tap to see your analysis' : 'Discover yourself')}
              </p>
              {hasPersonality && (
                <div className="flex items-center gap-1.5 mt-2">
                  <span className={`text-xs ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>{Object.keys(assessCompleted).length} assessments</span>
                </div>
              )}
            </div>
          </div>
        </button>

        {/* Identity & Connections â€” always visible */}
        {(() => {
          const primaryDisplay = primaryClaim
            ? (formatStampDisplay(primaryClaim.provider, primaryClaim.value) || primaryClaim.label || primaryClaim.provider)
            : getCurrentEmail();
          const primaryProvider = primaryClaim
            ? STAMP_PROVIDERS.find(p => p.id === primaryClaim.provider)
            : (getCurrentUser() ? STAMP_PROVIDERS.find(p => p.id === 'email') : null);
          const linkedCount = (effectiveClaims || []).length;
          const c = COLOR_HEX.emerald;
          return (
            <button
              onClick={() => onNavigate('identity')}
              className={`w-full rounded-2xl p-4 flex items-center gap-4 text-left`}
              style={{
                background: darkMode
                  ? `linear-gradient(135deg, rgba(${c.rgb}, 0.08), rgba(${c.rgb}, 0.03))`
                  : `linear-gradient(135deg, rgba(${c.rgb}, 0.06), rgba(${c.rgb}, 0.02))`,
                border: darkMode ? `1px solid rgba(${c.rgb}, 0.2)` : `1px solid rgba(${c.rgb}, 0.15)`,
              }}
            >
              <div className={`w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0`}
                style={{ background: `rgba(${c.rgb}, ${darkMode ? 0.15 : 0.1})` }}>
                {primaryProvider ? <StampIcon provider={primaryProvider} size={18} /> : <span className="text-lg">ðŸ”—</span>}
              </div>
              <div className="flex-1 min-w-0">
                <div className={`text-sm font-semibold ${darkMode ? 'text-white' : 'text-gray-900'}`}>Identity & Connections</div>
                <div className={`text-xs mt-0.5 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                  {primaryDisplay ? primaryDisplay : 'Link accounts & build trust'}
                  {linkedCount > 1 && ` Â· ${linkedCount} linked`}
                </div>
              </div>
              <span className={`text-sm font-medium ${darkMode ? 'text-emerald-400' : 'text-emerald-600'}`}>â†’</span>
            </button>
          );
        })()}

        {/* Assessments â€” available vs completed */}
        {(() => {
          const tier = calculateAssessTier(assessCompleted);
          const visible = Object.entries(ASSESS_CATEGORIES).filter(([_, cat]) => (cat.tier || 0) <= tier && (!cat.entityHint || cat.entityHint === entityType));
          const available = visible.filter(([_, cat]) => !cat.tests.every(id => assessCompleted[id]));
          const completed = visible.filter(([_, cat]) => cat.tests.every(id => assessCompleted[id]));
          return (
            <div className="space-y-2">
              {available.length > 0 && (
                <div className="space-y-1.5">
                  <div className={`text-xs font-medium uppercase tracking-wide ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>Available</div>
                  {available.map(([catId, cat]) => {
                    const t = twColor(cat.color);
                    return (
                      <button key={catId} onClick={() => onNavigate('assess-picker')}
                        className={`w-full rounded-xl px-3 py-2.5 flex items-center gap-3 ${darkMode ? `bg-${t}-950/30 border border-${t}-800/30 hover:border-${t}-500/50` : `bg-${t}-50 border border-${t}-200 hover:border-${t}-300`}`}>
                        <span className="text-lg">{cat.icon}</span>
                        <span className={`text-sm font-medium flex-1 text-left ${darkMode ? `text-${t}-400` : `text-${t}-700`}`}>{cat.name}</span>
                        <span className={`text-xs px-2 py-0.5 rounded-full ${darkMode ? `bg-${t}-500/20 text-${t}-400` : `bg-${t}-100 text-${t}-600`}`}>Start â†’</span>
                      </button>
                    );
                  })}
                </div>
              )}
              {completed.length > 0 && (
                <div className="space-y-1.5">
                  <div className={`text-xs font-medium uppercase tracking-wide ${darkMode ? 'text-gray-600' : 'text-gray-400'}`}>Completed</div>
                  {completed.map(([catId, cat]) => (
                    <button key={catId} onClick={() => onNavigate('assess-results', { testId: cat.tests[0] })}
                      className={`w-full rounded-xl px-3 py-2 flex items-center gap-3 opacity-50 ${darkMode ? 'bg-gray-900/30' : 'bg-gray-100'}`}>
                      <span className="text-base">{cat.icon}</span>
                      <span className={`text-sm flex-1 text-left ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>{cat.name}</span>
                      <span className={`text-xs ${darkMode ? 'text-gray-600' : 'text-gray-400'}`}>âœ“</span>
                    </button>
                  ))}
                </div>
              )}
            </div>
          );
        })()}
      </div>
    </div>
  );
};

// AssessPickerScreen â€” Assessment hub with categories, hero card, demo profiles
const AssessPickerScreen = ({
  darkMode, entityType, showDemoControls,
  assessCompleted, assessInProgress, assessExpandedCategory, assessProfileSwitching,
  assessShowDemoMenu, assessDemoActive, assessDemoProfile, assessSavedUserData, assessShowDemoInfo,
  onSetExpandedCategory, onSetShowDemoMenu, onSetShowDemoInfo,
  onStartTest, onLoadDemoProfile, onClearDemo, onClearAll,
  onNavigate,
}) => {
  return (
    <div className={`h-full flex flex-col ${TH('bg-main', darkMode)}`}>
      {/* Demo Menu Overlay */}
      {assessShowDemoMenu && (
        <div className="absolute inset-0 z-50 flex items-center justify-center bg-black/80" onClick={() => onSetShowDemoMenu(false)}>
          <div className={`mx-4 p-4 rounded-2xl backdrop-blur-xl ${darkMode ? 'bg-white/[0.06] border border-white/[0.08]' : 'bg-white/90 border border-black/[0.06] shadow-lg'}`} onClick={e => e.stopPropagation()}>
            <div className={`text-center mb-4 ${TH('text-primary', darkMode)}`}>
              <div className="text-lg font-semibold">{assessDemoActive ? 'Switch Profile' : 'Load Demo Profile'}</div>
              <div className={`text-xs mt-1 ${TH('text-subtle', darkMode)}`}>
                {assessDemoActive ? 'Your data is saved in the background' : 'See how different personalities score'}
              </div>
            </div>
            <div className="space-y-2">
              {assessDemoActive && assessSavedUserData && (
                <button onClick={() => { onClearDemo(); onSetShowDemoMenu(false); }} className={`w-full p-3 rounded-xl text-left flex items-center gap-3 ${darkMode ? 'bg-blue-900/30 border border-blue-500/30 hover:bg-blue-900/50' : 'bg-blue-50 border border-blue-200 hover:bg-blue-100'}`}>
                  <div className="w-10 h-10 rounded-full flex items-center justify-center text-lg bg-blue-600 text-white">ðŸ‘¤</div>
                  <div className="flex-1"><div className={`font-medium ${darkMode ? 'text-blue-300' : 'text-blue-700'}`}>Back to My Data</div><div className={`text-xs ${darkMode ? 'text-blue-400/70' : 'text-blue-600'}`}>Restore your saved answers</div></div>
                </button>
              )}
              {Object.entries(ASSESS_DEMO_PROFILES).map(([num, profile]) => {
                const profColors = { violet: 'bg-violet-600', teal: 'bg-teal-600', amber: 'bg-amber-500', emerald: 'bg-emerald-600', blue: 'bg-blue-600', pink: 'bg-pink-600' };
                return (
                  <button key={num} onClick={() => onLoadDemoProfile(Number(num))} className={`w-full p-3 rounded-xl text-left flex items-center gap-3 ${darkMode ? 'bg-white/[0.06] hover:bg-white/[0.10]' : 'bg-gray-100 hover:bg-gray-200'}`}>
                    <div className={`w-10 h-10 rounded-full flex items-center justify-center text-lg font-bold text-white ${profColors[profile.color] || 'bg-violet-600'}`}>{num}</div>
                    <div className="flex-1"><div className={`font-medium ${TH('text-primary', darkMode)}`}>{profile.name}</div><div className={`text-xs ${TH('text-dim', darkMode)}`}>{profile.desc}</div></div>
                  </button>
                );
              })}
            </div>
            <div className="flex gap-2 mt-3">
              <button onClick={onClearAll} className={`flex-1 py-2 text-sm rounded-lg ${darkMode ? 'bg-red-900/30 text-red-400 hover:bg-red-900/50' : 'bg-red-100 text-red-600 hover:bg-red-200'}`}>Clear All Data</button>
              <button onClick={() => onSetShowDemoMenu(false)} className={`flex-1 py-2 text-sm ${TH('text-subtle', darkMode)}`}>Cancel</button>
            </div>
          </div>
        </div>
      )}
      <div className={`h-[44px] flex-shrink-0 flex items-center gap-3 px-4 border-b ${TH('border-base', darkMode)}`} onClick={() => onSetExpandedCategory(null)}>
        <button onClick={(e) => { e.stopPropagation(); onNavigate('categories'); }} className={darkMode ? 'text-gray-400' : 'text-gray-500'}>â†</button>
        <span className="text-2xl cursor-pointer select-none" onDoubleClick={onClearDemo}>ðŸªž</span>
        <span className={`font-semibold flex-1 ${TH('text-primary', darkMode)}`}>Reveal</span>
        {(() => { const cc = getCompletedCategoryCount(assessCompleted, entityType); const ok = cc >= 2; return (
            <button onClick={(e) => { e.stopPropagation(); if (ok) onNavigate('assess-analysis'); }}
              className={`px-3 py-1.5 rounded-full text-sm font-medium ${ok ? 'bg-violet-600 text-white' : (darkMode ? 'bg-white/[0.04] text-gray-500 cursor-not-allowed' : 'bg-gray-200 text-gray-400 cursor-not-allowed')}`}>
              {ok ? 'Analysis' : `${cc}/2 to unlock`}
            </button>); })()}
      </div>
      {/* Demo Profile Selector - only shown when demo controls enabled in settings */}
      {showDemoControls && (
      <div className="px-4 py-1.5">
        <div className="flex items-center justify-center gap-2">
          <button onClick={onClearDemo}
            className={`px-3 py-1 rounded-full text-xs font-medium transition-all ${
              !assessDemoActive
                ? 'bg-blue-500 text-white shadow-lg shadow-blue-500/30'
                : (darkMode ? 'bg-blue-900/30 text-blue-400/60 hover:bg-blue-900/50' : 'bg-blue-100 text-blue-400 hover:bg-blue-200')
            }`}>
            Me
          </button>
          <div className={`h-5 w-px ${darkMode ? 'bg-gray-700' : 'bg-gray-300'}`} />
          <div className="flex items-center gap-1">
            <span className={`text-[10px] uppercase tracking-wide ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>Demo</span>
            <button onClick={() => onSetShowDemoInfo(!assessShowDemoInfo)}
              className={`text-[10px] transition-all ${assessShowDemoInfo ? (darkMode ? 'text-gray-300' : 'text-gray-600') : (darkMode ? 'text-gray-500 hover:text-gray-400' : 'text-gray-400 hover:text-gray-500')}`}>
              â“˜
            </button>
          </div>
          {Object.entries(ASSESS_DEMO_PROFILES).map(([num, profile]) => {
            const isActive = assessDemoActive && Number(assessDemoProfile) === Number(num);
            const colorMap = {
              violet: { active: 'bg-violet-500 text-white shadow-lg shadow-violet-500/30', dim: darkMode ? 'bg-violet-900/30 text-violet-400/60 hover:bg-violet-900/50' : 'bg-violet-100 text-violet-400 hover:bg-violet-200' },
              teal: { active: 'bg-teal-500 text-white shadow-lg shadow-teal-500/30', dim: darkMode ? 'bg-teal-900/30 text-teal-400/60 hover:bg-teal-900/50' : 'bg-teal-100 text-teal-400 hover:bg-teal-200' },
              pink: { active: 'bg-fuchsia-500 text-white shadow-lg shadow-fuchsia-500/30', dim: darkMode ? 'bg-fuchsia-900/30 text-fuchsia-400/60 hover:bg-fuchsia-900/50' : 'bg-fuchsia-100 text-fuchsia-400 hover:bg-fuchsia-200' },
            };
            const colors = colorMap[profile.color] || colorMap.violet;
            return (
              <button key={num} onClick={() => onLoadDemoProfile(Number(num))}
                className={`px-2.5 py-1 rounded-full text-xs font-medium transition-all ${isActive ? colors.active : colors.dim}`}>
                {profile.name}
              </button>
            );
          })}
        </div>
        {assessShowDemoInfo && (
          <div className={`mt-2 p-2 rounded-lg text-xs space-y-1 ${darkMode ? 'bg-gray-800/50' : 'bg-gray-100'}`}>
            {Object.entries(ASSESS_DEMO_PROFILES).map(([num, profile]) => {
              const colorMap = { violet: 'text-violet-400', teal: 'text-teal-400', pink: 'text-fuchsia-400' };
              return (
                <div key={num} className="flex items-center gap-2">
                  <span className={`font-medium ${colorMap[profile.color]}`}>{profile.name}:</span>
                  <span className={darkMode ? 'text-gray-400' : 'text-gray-600'}>{profile.desc}</span>
                </div>
              );
            })}
          </div>
        )}
      </div>
      )}
      {(() => {
        const currentTier = calculateAssessTier(assessCompleted);
        const visibleCategories = Object.entries(ASSESS_CATEGORIES).filter(([_, cat]) => (cat.tier || 0) <= currentTier && (!cat.entityHint || cat.entityHint === entityType));
        const isFirstTimeUser = currentTier === 0 && !assessCompleted['quick-profile'] && !assessCompleted['ai-style'] && !assessCompleted['ai-self'] && !assessCompleted['ai-values'] && !assessCompleted['ai-vision'];

        const categoriesWithStatus = visibleCategories.map(([catId, cat]) => {
          const catTests = cat.tests.map(id => [id, ASSESS_TESTS[id]]).filter(([_, t]) => t);
          const status = getCategoryStatus(catId, assessCompleted, assessInProgress, currentTier);
          const allComplete = status === 'done';
          const hasProgress = status === 'in-progress';
          return { catId, cat, catTests, allComplete, hasProgress, status };
        });
        const heroPriority = entityType === 'ai'
          ? ['ai-identity', 'quickstart', 'starter', 'personality', 'relationships', 'character', 'behavior', 'mind', 'shadow']
          : ['quickstart', 'starter', 'personality', 'relationships', 'character', 'behavior', 'mind', 'shadow'];
        const allIncomplete = categoriesWithStatus.filter(c => !c.allComplete);
        // Layer 2: prefer in-progress categories for hero (bring user back to what they started)
        const inProgressItems = allIncomplete.filter(c => c.hasProgress);
        const heroItem = inProgressItems.length > 0
          ? inProgressItems[0]  // in-progress gets priority
          : heroPriority.reduce((found, id) => found || allIncomplete.find(c => c.catId === id), null);
        const heroCategory = heroItem || null;
        // Layer 2: sort in-progress to top, then by static order
        const incompleteCategories = allIncomplete.filter(c => c !== heroCategory).sort((a, b) => {
          // In-progress floats above available
          if (a.hasProgress && !b.hasProgress) return -1;
          if (!a.hasProgress && b.hasProgress) return 1;
          // Within same status, use static order
          const ai = heroPriority.indexOf(a.catId), bi = heroPriority.indexOf(b.catId);
          return (ai === -1 ? 999 : ai) - (bi === -1 ? 999 : bi);
        });
        const completedCategories = categoriesWithStatus.filter(c => c.allComplete);

        return (
      <div className={`flex-1 overflow-auto p-4 pb-24 hide-scrollbar ${isFirstTimeUser ? 'flex flex-col items-center justify-center' : ''}`}>
        {isFirstTimeUser && (
          <div className="text-center mb-6 px-4">
            <div className="text-4xl mb-3">{entityType === 'ai' ? 'ðŸ¤–' : 'âœ¨'}</div>
            <h2 className={`text-xl font-semibold mb-2 ${TH('text-primary', darkMode)}`}>{entityType === 'ai' ? 'Map your identity' : 'Let\'s get to know you'}</h2>
            <p className={`text-sm ${TH('text-subtle', darkMode)}`}>{entityType === 'ai' ? '4 quick modules â€” starts simple, goes deep' : '10 quick questions to unlock your profile'}</p>
          </div>
        )}

        {!isFirstTimeUser && heroCategory && (() => {
          const { catId, cat, catTests, hasProgress } = heroCategory;
          const totalQuestions = catTests.reduce((sum, [_, t]) => sum + (t.questionCount || t.items.length), 0);
          const answeredQuestions = catTests.reduce((sum, [id, t]) => {
            if (assessCompleted[id]) return sum + (t.questionCount || t.items.length);
            const prog = assessInProgress[id];
            return sum + (prog ? Object.keys(prog.responses || {}).length : 0);
          }, 0);
          const progressPct = (answeredQuestions / totalQuestions) * 100;
          const hex = COLOR_HEX[cat.color] || COLOR_HEX.violet;
          const colors = getAssessColor(cat.color, darkMode);
          const t = twColor(cat.color);
          const hasModules = catTests.length > 1;
          const incompleteModules = catTests.filter(([id]) => !assessCompleted[id]);
          const firstIncomplete = incompleteModules[0];
          const handleHeroClick = () => {
            if (hasModules && firstIncomplete) { onStartTest(firstIncomplete[0]); }
            else if (catTests[0]) { onStartTest(catTests[0][0]); }
          };

          return (
            <div className="mb-3">
              <button onClick={handleHeroClick} className={`w-full relative rounded-2xl overflow-hidden text-left hover-glow hover-glow-${cat.color} ${darkMode ? 'border border-white/[0.06]' : 'border border-black/[0.10] shadow-sm'}`}>
                <div className="absolute inset-0 overflow-hidden rounded-2xl flex items-center justify-center pointer-events-none">
                  <div className="aura-breathe rounded-full" style={{
                    width: 240, height: 240,
                    background: `radial-gradient(ellipse at center, rgba(${hex.rgb}, ${darkMode ? 0.12 : 0.08}) 0%, transparent 70%)`,
                  }} />
                </div>
                <div className={`relative z-10 p-3.5 ${darkMode ? 'bg-white/[0.03]' : 'bg-white'}`}>
                  <div className="flex items-center gap-3">
                    <ProgressCircle progress={progressPct} size={44} strokeWidth={3} color={cat.color} text={progressPct > 0 ? `${Math.round(progressPct)}%` : cat.icon} gradientId={`hero-${catId}`} darkMode={darkMode} textSize="text-xs" />
                    <div className={`flex-1 font-semibold ${TH('text-primary', darkMode)}`}>{cat.name}</div>
                    <span className={`text-xs font-medium px-3 py-1.5 rounded-full ${darkMode ? `bg-${t}-500/25 text-${t}-300 border border-${t}-500/30` : `bg-${t}-100 text-${t}-600`}`}>
                      {progressPct > 0 ? 'Continue â†’' : 'Start â†’'}
                    </span>
                  </div>
                </div>
              </button>
            </div>
          );
        })()}

        {!isFirstTimeUser && incompleteCategories.length > 0 && (
          <div className="space-y-3 mb-6">
            {incompleteCategories.map(({ catId, cat, catTests }) => {
              const totalQuestions = catTests.reduce((sum, [_, t]) => sum + (t.questionCount || t.items.length), 0);
              const answeredQuestions = catTests.reduce((sum, [id, t]) => {
                if (assessCompleted[id]) return sum + (t.questionCount || t.items.length);
                const prog = assessInProgress[id];
                return sum + (prog ? Object.keys(prog.responses || {}).length : 0);
              }, 0);
              const progressPct = (answeredQuestions / totalQuestions) * 100;
              const isExpanded = assessExpandedCategory === catId;
              const colors = getAssessColor(cat.color, darkMode);
              const hasModules = catTests.length > 1;
              const incompleteModules = catTests.filter(([id]) => !assessCompleted[id]).length;

              if (!hasModules) {
                const [testId, test] = catTests[0];
                return (
                  <button key={catId} onClick={() => onStartTest(testId)} className={`w-full p-3.5 rounded-2xl ${TH('bg-card', darkMode)} flex items-center gap-3 hover-glow hover-glow-${cat.color} relative overflow-hidden`}>
                    {darkMode && <div className="absolute inset-0 flex items-center justify-center pointer-events-none"><div className="aura-breathe rounded-full" style={{ width: 200, height: 200, background: `radial-gradient(ellipse at center, rgba(${(COLOR_HEX[cat.color] || COLOR_HEX.violet).rgb}, 0.08) 0%, transparent 70%)` }} /></div>}
                    <ProgressCircle progress={progressPct} size={44} strokeWidth={3} color={cat.color} text={progressPct > 0 ? `${Math.round(progressPct)}%` : totalQuestions} gradientId={`cat-${catId}`} darkMode={darkMode} textSize="text-xs" orbit={assessProfileSwitching} />
                    <div className={`flex-1 text-left font-semibold ${TH('text-primary', darkMode)}`}>{cat.name}</div>
                    <span className={`text-xs font-medium px-3 py-1.5 rounded-full ${darkMode ? `bg-${twColor(cat.color)}-500/25 text-${twColor(cat.color)}-300 border border-${twColor(cat.color)}-500/30` : `bg-${twColor(cat.color)}-100 text-${twColor(cat.color)}-600`}`}>{progressPct > 0 ? 'Continue â†’' : 'Start â†’'}</span>
                  </button>
                );
              }

              const nextIncomplete = catTests.find(([id, test]) => {
                const isLocked = test.requires && !assessCompleted[test.requires];
                return !isLocked && !assessCompleted[id];
              });
              const nextTestId = nextIncomplete ? nextIncomplete[0] : null;
              const tw = twColor(cat.color);

              return (
                <div key={catId} className={`rounded-2xl ${TH('bg-card', darkMode)} relative overflow-hidden`}>
                  {darkMode && <div className="absolute inset-0 flex items-center justify-center pointer-events-none"><div className="aura-breathe rounded-full" style={{ width: 200, height: 200, background: `radial-gradient(ellipse at center, rgba(${(COLOR_HEX[cat.color] || COLOR_HEX.violet).rgb}, 0.08) 0%, transparent 70%)` }} /></div>}
                  <div className={`p-3.5 hover-glow hover-glow-${cat.color} cursor-pointer relative`} onClick={() => onSetExpandedCategory(isExpanded ? null : catId)}>
                    <div className="flex items-center gap-3">
                      <ProgressCircle progress={progressPct} size={44} strokeWidth={3} color={cat.color} text={incompleteModules} gradientId={`cat-${catId}`} darkMode={darkMode} textSize="text-sm" orbit={assessProfileSwitching} />
                      <div className={`flex-1 min-w-0 font-semibold ${TH('text-primary', darkMode)} flex items-center gap-1.5`}>
                        {cat.name}
                        <svg width="14" height="14" viewBox="0 0 16 16" fill="none" className={`transition-transform duration-200 ${isExpanded ? 'rotate-180' : ''}`} style={{stroke: darkMode ? '#94a3b8' : '#64748b', strokeWidth: 2.5, strokeLinecap: 'round', strokeLinejoin: 'round', opacity: 0.5}}><polyline points="4 6 8 10 12 6"/></svg>
                      </div>
                      {nextTestId && (
                        <button onClick={(e) => { e.stopPropagation(); onStartTest(nextTestId); }} className={`text-xs font-medium px-3 py-1.5 rounded-full ${darkMode ? `bg-${tw}-500/25 text-${tw}-300 border border-${tw}-500/30` : `bg-${tw}-100 text-${tw}-600`}`}>
                          {progressPct > 0 ? 'Continue â†’' : 'Start â†’'}
                        </button>
                      )}
                    </div>
                  </div>
              {isExpanded && (() => {
                const progressiveGroups = {};
                const standaloneTests = [];
                catTests.forEach(([id, test]) => {
                  if (id.startsWith('reasoning')) {
                    if (!progressiveGroups.reasoning) progressiveGroups.reasoning = [];
                    progressiveGroups.reasoning.push([id, test]);
                  } else {
                    standaloneTests.push([id, test]);
                  }
                });
                return (
                  <div className={`divide-y ${darkMode ? 'divide-gray-800/50' : 'divide-gray-200'} border-t ${darkMode ? 'border-gray-800/50' : 'border-gray-200'}`}>
                    {standaloneTests.map(([id, test]) => {
                      const isCompleted = assessCompleted[id];
                      const progress = assessInProgress[id];
                      const qc = test.questionCount || test.items.length;
                      const answered = isCompleted ? qc : progress ? Object.keys(progress.responses || {}).length : 0;
                      const modProgressPct = (answered / qc) * 100;
                      const hex = COLOR_HEX[cat.color] || COLOR_HEX.violet;
                      const hasSpectrumResult = isCompleted && spectrumColors[id] && isCompleted.score !== undefined;

                      if (hasSpectrumResult) {
                        return (
                          <button key={id} onClick={() => onNavigate('assess-results', { testId: id })}
                            className={`w-full px-3 py-2 flex items-center gap-2 hover-glow hover-glow-${cat.color} rounded-lg`}>
                            <span className="text-sm w-5">{test.icon}</span>
                            <span className={`w-24 text-left text-xs ${TH('text-secondary', darkMode)} truncate`}>{test.name}</span>
                            <div className="flex-1"><SpectrumBar value={isCompleted.score} testId={id} showLabels={true} darkMode={darkMode} /></div>
                          </button>
                        );
                      }

                      if (answered === 0) {
                        const isLocked = test.requires && !assessCompleted[test.requires];
                        return (
                          <button key={id} onClick={() => !isLocked && onStartTest(id)}
                            className={`w-full px-3 py-2 flex items-center gap-2 hover-glow hover-glow-${cat.color} rounded-lg ${isLocked ? 'opacity-40 cursor-not-allowed' : ''}`}>
                            <span className="text-sm w-5">{test.icon}</span>
                            <span className={`flex-1 text-left text-xs ${TH('text-secondary', darkMode)} truncate`}>{test.name}</span>
                            {!isLocked && <span className={`text-xs font-medium ${darkMode ? `text-${twColor(cat.color)}-400` : `text-${twColor(cat.color)}-500`}`}>Start â†’</span>}
                            {isLocked && <span className={`text-[10px] ${darkMode ? 'text-gray-600' : 'text-gray-400'}`}>ðŸ”’</span>}
                          </button>
                        );
                      }

                      return (
                        <button key={id} onClick={() => onStartTest(id)}
                          className={`w-full px-3 py-2 flex items-center gap-2 hover-glow hover-glow-${cat.color} rounded-lg`}>
                          <span className="text-sm w-5">{test.icon}</span>
                          <span className={`w-24 text-left text-xs ${TH('text-secondary', darkMode)} truncate`}>{test.name}</span>
                          <div className="flex-1">
                            <div className="h-2.5 rounded-full relative" style={{ background: darkMode ? 'rgba(255,255,255,0.08)' : 'rgba(0,0,0,0.08)' }}>
                              <div className="absolute inset-y-0 left-0 rounded-full" style={{ width: `${modProgressPct}%`, background: `linear-gradient(to right, ${hex.base}, ${hex.light})` }} />
                              <div
                                className="absolute top-1/2 -translate-y-1/2 w-3.5 h-3.5 rounded-full bg-white"
                                style={{
                                  left: `${Math.max(5, Math.min(95, modProgressPct))}%`,
                                  marginLeft: -7,
                                  boxShadow: '0 1px 3px rgba(0,0,0,0.25)'
                                }}
                              />
                            </div>
                          </div>
                        </button>
                      );
                    })}
                    {progressiveGroups.reasoning && (() => {
                      const levelCompletions = progressiveGroups.reasoning.map(([id]) => !!assessCompleted[id]);
                      const completedCount = levelCompletions.filter(c => c).length;
                      const allComplete = completedCount === 3;
                      const levelNames = ['Reasoning I', 'Reasoning II', 'Reasoning III'];

                      const nextTest = progressiveGroups.reasoning.find(([id, test]) => {
                        const isLocked = test.requires && !assessCompleted[test.requires];
                        return !isLocked && !assessCompleted[id];
                      });
                      const nextTestId = nextTest ? nextTest[0] : null;

                      return (
                      <div className="p-3">
                        <div
                          className={`flex items-center gap-3 ${nextTestId ? 'cursor-pointer' : ''}`}
                          onClick={() => {
                            if (nextTestId) { onStartTest(nextTestId); }
                            else if (allComplete) { onNavigate('assess-results', { testId: 'reasoning-3' }); }
                          }}
                        >
                          {(() => {
                            const miniSize = 32;
                            const miniStroke = 3;
                            const miniRadius = (miniSize - miniStroke) / 2;
                            const circumference = 2 * Math.PI * miniRadius;
                            const grad = PROGRESS_GRADIENTS[cat.color] || PROGRESS_GRADIENTS.blue;
                            const overlap = 12;

                            const rings = [];
                            progressiveGroups.reasoning.forEach(([id, test], idx) => {
                              const isComplete = !!assessCompleted[id];
                              const inProg = assessInProgress[id];
                              const totalQs = test.questionCount || test.items.length;
                              if (isComplete) { rings.push({ id, isComplete: true, progress: 100 }); }
                              else if (inProg) {
                                const answered = Object.keys(inProg.responses || {}).length;
                                rings.push({ id, isComplete: false, progress: (answered / totalQs) * 100 });
                              }
                            });

                            if (rings.length === 0) {
                              const lvl1Prog = assessInProgress['reasoning'];
                              const lvl1Total = ASSESS_TESTS['reasoning']?.items?.length || 12;
                              const lvl1Answered = lvl1Prog ? Object.keys(lvl1Prog.responses || {}).length : 0;
                              const lvl1Pct = (lvl1Answered / lvl1Total) * 100;
                              return (
                                <div className="relative group">
                                  <ProgressCircle progress={lvl1Pct} size={40} strokeWidth={3} color={cat.color} text="1" gradientId="reas-prog" darkMode={darkMode} glow={lvl1Pct > 0} />
                                  <div className="absolute bottom-full left-1/2 -translate-x-1/2 mb-1 px-2 py-1 text-xs bg-gray-800 text-white rounded whitespace-nowrap opacity-0 group-hover:opacity-100 pointer-events-none z-10">
                                    {lvl1Pct > 0 ? `${Math.round(lvl1Pct)}% complete` : 'Not started'}
                                  </div>
                                </div>
                              );
                            }

                            return (
                              <div className="relative group">
                                <div className="relative flex items-center" style={{ width: miniSize + (rings.length - 1) * overlap, height: miniSize }}>
                                  {rings.map((ring, i) => {
                                    const hasProgress = ring.progress > 0;
                                    const dashOffset = circumference * (1 - ring.progress / 100);
                                    return (
                                      <div key={ring.id} className="absolute flex items-center justify-center" style={{ width: miniSize, height: miniSize, left: i * overlap, zIndex: (i + 1) * 10 }}>
                                        {hasProgress && (
                                          <div className="absolute inset-0 rounded-full blur-md opacity-40" style={{ background: `linear-gradient(135deg, ${grad.from}, ${grad.to})` }} />
                                        )}
                                        <svg width={miniSize} height={miniSize} className="absolute">
                                          <defs>
                                            <linearGradient id={`reas-stack-${i}`} x1="0%" y1="0%" x2="100%" y2="100%">
                                              <stop offset="0%" stopColor={hasProgress ? grad.from : '#374151'} />
                                              <stop offset="100%" stopColor={hasProgress ? grad.to : '#4b5563'} />
                                            </linearGradient>
                                          </defs>
                                          <circle cx={miniSize/2} cy={miniSize/2} r={miniRadius + miniStroke/2} fill={darkMode ? '#0c1220' : '#f3f4f6'} />
                                          <circle cx={miniSize/2} cy={miniSize/2} r={miniRadius - miniStroke/2 - 1}
                                            fill={hasProgress ? (darkMode ? `color-mix(in srgb, ${grad.from} 12%, #0a0f1a)` : `color-mix(in srgb, ${grad.from} 15%, #f8fafc)`) : (darkMode ? '#0a0f1a' : '#f8fafc')} />
                                          <circle cx={miniSize/2} cy={miniSize/2} r={miniRadius} fill="none" stroke={darkMode ? '#1e293b' : '#e5e7eb'} strokeWidth={miniStroke} />
                                          <circle cx={miniSize/2} cy={miniSize/2} r={miniRadius} fill="none" stroke={`url(#reas-stack-${i})`} strokeWidth={miniStroke} strokeLinecap="round"
                                            strokeDasharray={circumference} strokeDashoffset={dashOffset} transform={`rotate(-90 ${miniSize/2} ${miniSize/2})`} className="transition-all duration-500" />
                                        </svg>
                                        <span className="relative z-10 font-bold text-xs" style={{ color: hasProgress ? grad.to : (darkMode ? '#6b7280' : '#9ca3af') }}>
                                          {ring.isComplete ? 'âœ“' : (i + 1)}
                                        </span>
                                      </div>
                                    );
                                  })}
                                </div>
                                <div className="absolute bottom-full left-1/2 -translate-x-1/2 mb-1 px-2 py-1 text-xs bg-gray-800 text-white rounded whitespace-nowrap opacity-0 group-hover:opacity-100 pointer-events-none z-10">
                                  {allComplete ? 'All levels complete!' : `${completedCount} of 3 complete`}
                                </div>
                              </div>
                            );
                          })()}

                          <div className="flex-1 min-w-0">
                            <div className={`font-medium text-sm ${TH('text-primary', darkMode)}`}>Reasoning</div>
                            <div className={`text-xs ${TH('text-subtle', darkMode)}`}>
                              {allComplete ? 'All 3 levels complete' : `Level ${completedCount + 1} of 3 Â· ${levelNames[completedCount]}`}
                            </div>
                          </div>

                          <svg className={`w-5 h-5 ${darkMode ? 'text-gray-600' : 'text-gray-400'}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
                          </svg>
                        </div>
                      </div>
                    );})()}
                  </div>
                );
              })()}
                </div>
              );
            })}
          </div>
        )}

        {isFirstTimeUser && (() => {
          const isAIUser = entityType === 'ai';
          if (!isAIUser) {
            return (
              <button onClick={() => onStartTest('quick-profile')} className={`w-full max-w-sm p-6 rounded-2xl bg-gradient-to-br from-blue-900/40 to-indigo-900/40 border-blue-500/30 shadow-blue-500/20 border flex items-center gap-4 shadow-lg hover-glow hover-glow-blue`}>
                <ProgressCircle progress={0} size={72} strokeWidth={5} color="blue" text="5" gradientId={`cat-first`} darkMode={darkMode} textSize="text-base" />
                <div className="flex-1 text-left">
                  <div className={`text-lg font-semibold ${TH('text-primary', darkMode)}`}>Quick Profile</div>
                  <div className={`text-sm text-blue-400`}>~1 minute</div>
                </div>
                <span className={`text-2xl text-blue-400`}>â†’</span>
              </button>
            );
          }
          return (
            <>
              <button onClick={() => onStartTest('ai-style')} className={`w-full max-w-sm p-6 rounded-2xl bg-gradient-to-br ${darkMode ? 'from-cyan-900/40 to-teal-900/40 border border-cyan-500/30 shadow-lg shadow-cyan-500/20' : 'from-cyan-50 to-teal-50 border border-cyan-300 shadow-lg shadow-cyan-200/40'} flex items-center gap-4 hover-glow hover-glow-cyan`}>
                <ProgressCircle progress={0} size={72} strokeWidth={5} color="cyan" text="32" gradientId="cat-ai-first" darkMode={darkMode} textSize="text-base" />
                <div className="flex-1 text-left">
                  <div className={`text-lg font-semibold ${TH('text-primary', darkMode)}`}>AI Identity</div>
                  <div className={`text-sm ${darkMode ? 'text-cyan-400' : 'text-cyan-600'}`}>4 modules Â· starts simple, goes deep</div>
                  <div className={`text-xs mt-1 ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>ðŸŽ­ Style â†’ ðŸªž Self â†’ âš–ï¸ Values â†’ ðŸ”­ Vision</div>
                </div>
                <span className={`text-2xl ${darkMode ? 'text-cyan-400' : 'text-cyan-600'}`}>â†’</span>
              </button>
              <p className={`text-[11px] mt-3 max-w-sm text-center ${darkMode ? 'text-gray-600' : 'text-gray-400'}`}>Designed for AI minds. Humans welcome.</p>
              <button onClick={() => onStartTest('quick-profile')} className={`w-full max-w-sm mt-3 p-3 rounded-xl ${darkMode ? 'bg-white/[0.03] border border-white/[0.06]' : 'bg-gray-50 border border-gray-200'} flex items-center gap-3 hover-glow hover-glow-blue`}>
                <ProgressCircle progress={0} size={36} strokeWidth={3} color="blue" text="5" gradientId="cat-qp-alt" darkMode={darkMode} textSize="text-xs" />
                <div className="flex-1 text-left">
                  <div className={`text-sm font-medium ${TH('text-primary', darkMode)}`}>Quick Profile</div>
                  <div className={`text-xs ${TH('text-dim', darkMode)}`}>General personality snapshot</div>
                </div>
                <span className={`text-lg ${TH('text-dim', darkMode)}`}>â†’</span>
              </button>
            </>
          );
        })()}

        {!isFirstTimeUser && completedCategories.length > 0 && (
          <div className="mt-3">
            <div className={`rounded-xl ${TH('bg-card', darkMode)}`}>
              {completedCategories.map(({ catId, cat, catTests }, idx) => (
                <button key={catId} onClick={() => onNavigate('assess-results', { testId: catTests[0][0] })} className={`w-full px-3 py-2 flex items-center gap-3 opacity-70 hover:opacity-90 hover-glow hover-glow-${cat.color} transition-opacity ${idx > 0 ? (darkMode ? 'border-t border-gray-800/50' : 'border-t border-gray-200') : ''}`}>
                  <ProgressCircle progress={100} size={28} strokeWidth={2} color={cat.color} icon={cat.icon} gradientId={`complete-${catId}`} darkMode={darkMode} iconSize="text-xs" />
                  <span className={`flex-1 text-left text-sm font-medium ${TH('text-dim', darkMode)}`}>{cat.name}</span>
                  <span className={`text-sm ${darkMode ? 'text-gray-600' : 'text-gray-400'}`}>â€º</span>
                </button>
              ))}
            </div>
          </div>
        )}
      </div>
      );
      })()}
    </div>
  );
};

const AssessQuestionScreen = ({
  darkMode, assessCurrentTest, assessCurrentIndex, assessTotalQuestions, assessGatewayActiveItems,
  assessResponses, assessSkipped, assessCurrentScale, assessSwipeHandlers,
  assessShowCompletion, assessUnlockMessage, assessShowUndoToast,
  assessShowExitConfirm, assessPending, assessEntering, assessTestColor, undoDelay,
  canFinish, onFinishAssessment, onSaveAndExit, onGoToQuestion,
  onHandleAnswerTap, onHandleUndo, onFinalizeSubmit,
  onSetShowExitConfirm, onSetPending, onExitWithoutSaving,
}) => {
  // Gateway branching: map visual index â†’ raw item index
  const gwMap = assessGatewayActiveItems || null;
  const rawIdx = gwMap ? gwMap[assessCurrentIndex] : assessCurrentIndex;
  const currentItem = assessCurrentTest.items[rawIdx];
  const segments = [];
  for (let i = 0; i < assessTotalQuestions; i++) {
    const ri = gwMap ? gwMap[i] : i;
    segments.push({
      isAnswered: assessResponses[ri] !== undefined && assessResponses[ri] !== null,
      isNA: assessResponses[ri] === null,
      isSkipped: assessSkipped.includes(ri) && assessResponses[ri] === undefined,
      isCurrent: i === assessCurrentIndex
    });
  }
  // Use pre-computed ASSESS_STYLES (defined at module level)
  const { gradientStyles, selectedStyles, pendingStyles, numColors } = darkMode ? ASSESS_STYLES.dark : ASSESS_STYLES.light;

  return (
    <div className={`h-full flex flex-col overflow-hidden ${TH('bg-main', darkMode)} relative`} {...assessSwipeHandlers}>
      {/* Breathing ambient gradient */}
      {(() => {
        const ac = COLOR_HEX[assessCurrentTest.color] || COLOR_HEX.violet;
        return (
          <div className="absolute inset-0 flex items-center justify-center pointer-events-none" style={{ marginTop: '-20%' }}>
            <div style={{
              width: 280, height: 280, borderRadius: '50%',
              background: darkMode
                ? `radial-gradient(circle, rgba(${ac.rgb},0.08) 0%, rgba(${ac.rgb},0.03) 40%, transparent 65%)`
                : `radial-gradient(circle, rgba(${ac.rgb},0.06) 0%, rgba(${ac.rgb},0.02) 40%, transparent 65%)`,
              animation: 'aura-breathe 10s ease-in-out infinite',
            }} />
          </div>
        );
      })()}
      {/* Completion Celebration */}
      {assessShowCompletion && (() => {
        const celebColor = assessUnlockMessage ? COLOR_HEX.indigo.base : (COLOR_HEX[assessCurrentTest.color]?.base || COLOR_HEX.emerald.base);
        return (
        <div className={`absolute inset-0 z-50 flex items-center justify-center ${darkMode ? 'bg-gray-950/95' : 'bg-white/95'}`}>
          {/* Glow â€” radial gradient instead of blur to avoid overflow-hidden clipping */}
          <div className="absolute inset-0 m-auto rounded-full celebrate-glow pointer-events-none" style={{ width: '320px', height: '320px', background: `radial-gradient(circle, ${celebColor}60 0%, ${celebColor}20 35%, transparent 70%)` }} />
          <div className="relative">
            <svg width="140" height="140" className="celebrate-ring"><circle cx="70" cy="70" r="60" fill="none" stroke={assessUnlockMessage ? "url(#unlock-grad)" : "url(#complete-grad)"} strokeWidth="6" strokeLinecap="round" strokeDasharray="377" /><defs><linearGradient id="complete-grad" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stopColor="#8b5cf6" /><stop offset="100%" stopColor="#10b981" /></linearGradient><linearGradient id="unlock-grad" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stopColor="#3b82f6" /><stop offset="100%" stopColor="#6366f1" /></linearGradient></defs></svg>
            <div className="absolute inset-0 flex items-center justify-center celebrate-pulse"><span className="text-5xl">{assessUnlockMessage ? 'ðŸ”“' : assessCurrentTest.icon}</span></div>
          </div>
          <div className="absolute bottom-1/3 text-center">
            {assessUnlockMessage ? (
              <><div className={`text-xl font-semibold ${darkMode ? 'text-white' : 'text-gray-900'}`}>{assessUnlockMessage.title}</div><div className={`text-sm mt-1 ${darkMode ? 'text-indigo-300' : 'text-indigo-600'}`}>{assessUnlockMessage.subtitle}</div></>
            ) : (
              <><div className={`text-xl font-semibold ${darkMode ? 'text-white' : 'text-gray-900'}`}>Complete!</div><div className={`text-sm mt-1 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>Calculating your results...</div></>
            )}
          </div>
        </div>
        );
      })()}
      {/* Undo Toast â€” positioned near answer buttons */}
      {assessShowUndoToast && (
        <div className={`absolute bottom-4 left-1/2 -translate-x-1/2 z-50 px-4 py-2 rounded-full backdrop-blur-md text-sm font-medium shadow-lg animate-pulse ${darkMode ? 'bg-white/[0.08] border border-white/[0.12] text-white' : 'bg-gray-900/[0.08] border border-gray-900/[0.12] text-gray-900'}`}>
          â†© Undone
        </div>
      )}
      {/* Exit Confirmation Popup */}
      {assessShowExitConfirm && (
        <div className="absolute inset-0 z-50 flex items-center justify-center bg-black/80" onClick={() => onSetShowExitConfirm(false)}>
          <div className={`mx-6 p-5 rounded-2xl backdrop-blur-xl ${darkMode ? 'bg-white/[0.06] border border-white/[0.08]' : 'bg-white/90 border border-black/[0.06] shadow-lg'}`} onClick={e => e.stopPropagation()}>
            <div className={`text-center mb-4 ${TH('text-primary', darkMode)}`}>
              <div className="text-lg font-semibold">Exit Assessment?</div>
              <div className={`text-sm mt-2 ${TH('text-subtle', darkMode)}`}>Your answers will not be saved.</div>
            </div>
            <div className="flex gap-3">
              <button onClick={() => { onSetShowExitConfirm(false); onSaveAndExit(); }} className={`flex-1 py-3 rounded-xl font-medium ${darkMode ? 'bg-violet-600 text-white' : 'bg-violet-600 text-white'}`}>Save</button>
              <button onClick={onExitWithoutSaving} className={`flex-1 py-3 rounded-xl font-medium ${darkMode ? 'bg-red-600 text-white' : 'bg-red-500 text-white'}`}>Exit</button>
            </div>
          </div>
        </div>
      )}
      {/* Navigation Bar */}
      <div className={`h-[44px] flex-shrink-0 flex items-center gap-2 px-3 border-b ${TH('border-base', darkMode)}`}>
        {canFinish() ? <button onClick={onFinishAssessment} className={`text-sm font-semibold btn-feedback ${assessTestColor.text}`}>Finish âœ“</button> : <button onClick={onSaveAndExit} className={`text-sm font-semibold btn-feedback ${TH('text-muted-flip', darkMode)}`}>Save</button>}
        <button onClick={() => assessCurrentIndex > 0 && onGoToQuestion(assessCurrentIndex - 1, 'back')} disabled={assessCurrentIndex === 0} className={`text-xl font-bold w-8 h-8 flex items-center justify-center btn-feedback ${assessCurrentIndex === 0 ? (darkMode ? 'text-gray-700' : 'text-gray-300') : (darkMode ? 'text-gray-300' : 'text-gray-600')}`}>â—€</button>
        <div className={`flex-1 text-center text-sm font-medium ${TH('text-primary', darkMode)}`}>{assessCurrentIndex + 1} / {assessTotalQuestions}</div>
        <button onClick={() => assessCurrentIndex < assessTotalQuestions - 1 && onGoToQuestion(assessCurrentIndex + 1, 'fwd')} disabled={assessCurrentIndex === assessTotalQuestions - 1} className={`text-xl font-bold w-8 h-8 flex items-center justify-center btn-feedback ${assessCurrentIndex === assessTotalQuestions - 1 ? (darkMode ? 'text-gray-700' : 'text-gray-300') : (darkMode ? 'text-gray-300' : 'text-gray-600')}`}>â–¶</button>
        <button onClick={() => onSetShowExitConfirm(true)} className={`text-sm font-semibold btn-feedback ${TH('text-muted-flip', darkMode)}`}>Exit</button>
      </div>
      {/* Clickable Progress bar */}
      <div className={`flex h-2.5 gap-px px-1 py-0.5 ${darkMode ? 'bg-white/[0.03]' : 'bg-gray-100'}`}>
        {segments.map((seg, i) => (<button key={i} onClick={() => onGoToQuestion(i, i > assessCurrentIndex ? 'fwd' : 'back')} className={`flex-1 rounded-sm transition-colors hover:opacity-80 ${seg.isAnswered ? assessTestColor.bg : seg.isNA ? (darkMode ? 'bg-gray-600' : 'bg-gray-400') : seg.isSkipped ? 'bg-amber-500' : seg.isCurrent ? (darkMode ? 'bg-white' : 'bg-gray-900') : (darkMode ? 'bg-white/[0.08]' : 'bg-gray-300')}`} />))}
      </div>
      {/* Question + Answers */}
      <div className={`flex-1 flex flex-col ${assessEntering ? 'assess-entering' : ''}`} onClick={() => assessPending !== null && onHandleUndo()}>
        <div className="flex-1 flex flex-col justify-center px-4 pb-4 overflow-visible">
          <div className="p-4 relative overflow-visible">
            {/* Radial glow behind assessment question text â€” no visible card */}
            <div className="assess-glow absolute inset-0 flex items-center justify-center pointer-events-none" aria-hidden="true" style={{ overflow: 'visible' }}>
              {(() => {
                const ac = COLOR_HEX[assessCurrentTest.color] || COLOR_HEX.violet;
                return <div style={{
                  width: '300%',
                  height: '300%',
                  background: darkMode
                    ? `radial-gradient(ellipse 50% 50% at center, rgba(${ac.rgb}, 0.28) 0%, rgba(${ac.rgb}, 0.14) 25%, rgba(${ac.rgb}, 0.06) 45%, rgba(${ac.rgb}, 0.02) 60%, transparent 75%)`
                    : `radial-gradient(ellipse 50% 50% at center, rgba(${ac.rgb}, 0.18) 0%, rgba(${ac.rgb}, 0.08) 25%, rgba(${ac.rgb}, 0.03) 45%, rgba(${ac.rgb}, 0.01) 60%, transparent 75%)`,
                  position: 'absolute',
                  top: '50%',
                  left: '50%',
                  transform: 'translate(-50%, -50%)',
                  borderRadius: '50%',
                }} />;
              })()}
            </div>
            {assessCurrentIndex === 0 && assessCurrentTest.framing && <p className={`text-[11px] text-center mb-3 relative z-10 ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>{assessCurrentTest.framing}</p>}
            <h2 className={`text-xl font-medium text-center leading-relaxed relative z-10 ${TH('text-primary', darkMode)}`}>{currentItem.q}</h2>
            {currentItem.n && <p className={`text-xs text-center mt-2 relative z-10 ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>ðŸ’¡ {currentItem.n}</p>}
          </div>
        </div>
        <div className={`flex-shrink-0 px-4 pb-4 space-y-2 assess-btns`}>
          {(currentItem.o ? currentItem.o.map((label, i) => ({ v: i + 1, l: label })) : assessCurrentScale).map((option, i) => {
            const isSelected = assessResponses[rawIdx] === option.v;
            const isPending = assessPending === option.v;
            const colorTint = gradientStyles[assessCurrentTest.color][i % 5];
            const selStyle = selectedStyles[assessCurrentTest.color];
            const pendStyle = pendingStyles[assessCurrentTest.color];
            const numColor = numColors[assessCurrentTest.color];
            const fillColor = COLOR_HEX[assessCurrentTest.color]?.rgb || COLOR_HEX.violet.rgb;
            return (
              <button key={option.v} onClick={(e) => { e.stopPropagation(); if (assessPending) { onHandleUndo(); } else { onHandleAnswerTap(option.v); } }}
                className={`w-full py-3.5 px-4 rounded-xl flex items-center justify-between transition-all border relative overflow-hidden hover-glow hover-glow-${assessCurrentTest.color} ${isSelected ? `${selStyle} text-white` : `${colorTint} ${isPending ? 'text-white' : darkMode ? 'text-gray-200' : 'text-gray-700'}`}`}
                style={isPending ? { transform: 'scale(1.03)', boxShadow: `0 0 20px rgba(${fillColor},0.4), 0 0 40px rgba(${fillColor},0.15)` } : {}}
              >
                {isPending && <div className="absolute inset-0" style={{ background: `rgba(${fillColor}, ${darkMode ? 0.85 : 0.75})`, animation: `countdownFill ${undoDelay}s linear forwards`, transformOrigin: 'left' }} />}
                <span className="text-left relative z-10">{option.l}</span>
                <div className="flex items-center gap-2 relative z-10">
                  {isPending && <span className="text-white/80 text-xs font-medium">tap to undo</span>}
                  {!currentItem.o && <span className={`text-sm font-medium ${isSelected || isPending ? 'text-white/70' : numColor}`}>{option.v}</span>}
                </div>
              </button>
            );
          })}
          {/* N/A option - subtle text link below scale (hidden for gateway) */}
          {!currentItem.o && <div className="text-center pt-1">
            <button
              onClick={(e) => { e.stopPropagation(); if (assessPending) { onHandleUndo(); } else { onFinalizeSubmit(null); } }}
              className={`text-xs px-3 py-1 rounded-full transition-colors ${assessResponses[rawIdx] === null ? (darkMode ? 'bg-gray-700 text-gray-300' : 'bg-gray-300 text-gray-600') : (darkMode ? 'text-gray-600 hover:text-gray-400' : 'text-gray-400 hover:text-gray-600')}`}
            >
              Doesn't apply to me
            </button>
          </div>}
          {/* Spacer for gateway 3-option layout â€” matches where buttons 4-5 + N/A would be */}
          {currentItem.o && <div style={{ height: '7.5rem' }} />}
        </div>
      </div>
    </div>
  );
};

// ==================== ASSESS RESULTS SCREEN ====================
const AssessResultsScreen = ({ darkMode, assessCurrentTestId, assessCompleted, entityType, entityModelName, onboardingAnswers, displayName, onNavigate, nudgeData, onNudgeContinue, onSaveSuccess }) => {
  const test = ASSESS_TESTS[assessCurrentTestId];
  const results = assessCompleted[assessCurrentTestId];
  const colors = getAssessColor(test.color, darkMode);

  // Enhanced trait info with Strength + Shadow framework
  const traitInfo = {
    E: { low: 'Reserved', high: 'Outgoing',
      strength: v => v > 60 ? 'Natural connector who energizes groups' : v < 40 ? 'Deep thinker who recharges through reflection' : 'Flexible between social and solo modes',
      shadow: v => v > 60 ? 'May struggle with alone time or quiet reflection' : v < 40 ? 'Networking and small talk can feel draining' : 'Neither extreme poses significant friction',
      tip: v => v > 60 ? 'Schedule deliberate quiet time for processing' : v < 40 ? 'Prepare conversation starters before social events' : 'Trust your instincts on when to engage vs. withdraw'
    },
    A: { low: 'Analytical', high: 'Empathetic',
      strength: v => v > 60 ? 'Creates harmony and builds trust easily' : v < 40 ? 'Cuts through noise to find truth' : 'Balances compassion with objectivity',
      shadow: v => v > 60 ? 'May avoid necessary conflict or hard truths' : v < 40 ? 'Directness can come across as cold' : 'Neither extreme poses significant friction',
      tip: v => v > 60 ? 'Practice saying "no" in low-stakes situations' : v < 40 ? 'Pause to acknowledge emotions before giving feedback' : 'Use your balance as a mediator strength'
    },
    C: { low: 'Flexible', high: 'Organized',
      strength: v => v > 60 ? 'Reliable executor who delivers consistently' : v < 40 ? 'Adapts quickly to changing circumstances' : 'Balances planning with adaptability',
      shadow: v => v > 60 ? 'Rigidity and perfectionism can slow you down' : v < 40 ? 'Details and follow-through may slip' : 'Neither extreme poses significant friction',
      tip: v => v > 60 ? 'Embrace "good enough" for low-stakes tasks' : v < 40 ? 'Use external systems (calendars, reminders) as scaffolding' : 'Leverage your flexibility as a superpower'
    },
    N: { low: 'Calm', high: 'Sensitive',
      strength: v => v > 60 ? 'Deep emotional intelligence and empathy' : v < 40 ? 'Steady presence under pressure' : 'Moderate emotional responsiveness',
      shadow: v => v > 60 ? 'Emotional intensity can be overwhelming' : v < 40 ? 'May miss emotional cues or seem detached' : 'Neither extreme poses significant friction',
      tip: v => v > 60 ? 'Develop grounding techniques for intense moments' : v < 40 ? 'Check in explicitly with others about their feelings' : 'Your balance helps you support others effectively'
    },
    O: { low: 'Practical', high: 'Curious',
      strength: v => v > 60 ? 'Visionary thinking and creative problem-solving' : v < 40 ? 'Grounded execution and proven methods' : 'Blends innovation with practicality',
      shadow: v => v > 60 ? 'May chase novelty over finishing projects' : v < 40 ? 'Resistance to change or new approaches' : 'Neither extreme poses significant friction',
      tip: v => v > 60 ? 'Set "finish before starting new" rules' : v < 40 ? 'Schedule time to explore one new idea monthly' : 'Use your balance to bridge visionaries and operators'
    },
  };
  const adhdLevel = results?.indicators >= 4 ? { label: 'High Indicators', color: 'text-rose-400', bg: 'from-rose-500 to-orange-500', desc: 'Several indicators present. These patterns may significantly impact daily life.', strength: 'Hyperfocus, creativity, out-of-the-box thinking', shadow: 'Time blindness, task initiation, emotional regulation' } : results?.indicators >= 2 ? { label: 'Moderate Indicators', color: 'text-amber-400', bg: 'from-amber-500 to-yellow-500', desc: 'Some indicators present. Worth monitoring how they affect you.', strength: 'Bursts of productive energy, adaptability', shadow: 'Occasional focus challenges, restlessness' } : { label: 'Low Indicators', color: 'text-emerald-400', bg: 'from-emerald-500 to-teal-500', desc: 'Few indicators. Likely typical neurological patterns.', strength: 'Consistent focus and task management', shadow: 'May not relate to ADHD experiences' };
  const riskLevel = results?.score >= 70 ? { label: 'Bold Explorer', desc: 'You embrace uncertainty and chase big opportunities', strength: 'Seizes opportunities others miss, comfortable with ambiguity', shadow: 'May underestimate downsides or act impulsively', tip: 'Build in a 24-hour rule for major decisions' } : results?.score >= 40 ? { label: 'Calculated Risk Taker', desc: 'You weigh risks carefully before acting', strength: 'Makes informed bets, balances caution with action', shadow: 'Analysis paralysis on edge cases', tip: 'Set decision deadlines to avoid overthinking' } : { label: 'Security Seeker', desc: 'You prefer stability and careful planning', strength: 'Protects against downside, builds lasting foundations', shadow: 'May miss opportunities that require a leap', tip: 'Practice small, reversible risks to build comfort' };
  const attachInfo = {
    Secure: { desc: 'You feel comfortable with intimacy and independence', strength: 'Forms deep bonds while maintaining healthy boundaries', shadow: 'May not fully understand others\' attachment struggles', tip: 'Use your security to create safe space for others' },
    Anxious: { desc: 'You seek closeness but worry about abandonment', strength: 'Deeply committed, attuned to relationship dynamics', shadow: 'Reassurance-seeking can strain relationships', tip: 'Build self-soothing practices for anxious moments' },
    Avoidant: { desc: 'You value independence and may keep emotional distance', strength: 'Self-sufficient, maintains boundaries effectively', shadow: 'May push away those who get too close', tip: 'Practice small vulnerability with trusted people' },
    Fearful: { desc: 'You desire closeness but fear vulnerability', strength: 'Deep capacity for connection when trust is built', shadow: 'Push-pull dynamics can confuse partners', tip: 'Work with a therapist on attachment patterns' }
  };
  const integrityLevel = results?.score >= 70 ? { label: 'The Sincere Idealist', strength: 'Trusted implicitly, builds authentic relationships', shadow: 'May judge others who bend rules pragmatically', tip: 'Accept that others navigate ethics differently' } : results?.score >= 40 ? { label: 'The Balanced Pragmatist', strength: 'Adapts approach while maintaining core values', shadow: 'Occasional uncertainty about the "right" choice', tip: 'Define your non-negotiables clearly' } : { label: 'The Strategic Navigator', strength: 'Reads situations and optimizes outcomes skillfully', shadow: 'Others may question your motives', tip: 'Be transparent about your reasoning process' };
  const shadowInfo = {
    M: { high: 'Strategic Thinker', mid: 'Situational Tactician', low: 'Transparent Operator', strength: s => s > 60 ? 'Masterful at navigating complex social dynamics' : s < 40 ? 'Builds trust through authentic openness' : 'Flexes between directness and strategy', shadow: s => s > 60 ? 'Others may perceive manipulation' : s < 40 ? 'May be outmaneuvered by strategic players' : 'Occasional uncertainty on approach' },
    N: { high: 'Confident Leader', mid: 'Healthy Self-Regard', low: 'Humble Collaborator', strength: s => s > 60 ? 'Commands attention and inspires others' : s < 40 ? 'Elevates team over self, builds loyalty' : 'Balances confidence with humility', shadow: s => s > 60 ? 'May not see blind spots or hear criticism' : s < 40 ? 'May undersell yourself or defer too much' : 'Neither extreme causes friction' },
    P: { high: 'Cool Under Pressure', mid: 'Emotionally Balanced', low: 'Deeply Empathetic', strength: s => s > 60 ? 'Makes hard decisions without emotional interference' : s < 40 ? 'Deep connections and emotional attunement' : 'Balances logic and emotion well', shadow: s => s > 60 ? 'May seem cold or miss emotional cues' : s < 40 ? 'Emotional contagion can be draining' : 'Neither extreme causes friction' }
  };
  const chronoInfo = {
    'Morning Lark': { strength: 'Peak focus in early hours when distractions are low', shadow: 'Energy crashes in late afternoon/evening', tip: 'Front-load important work before noon' },
    'Night Owl': { strength: 'Creative breakthroughs in quiet late hours', shadow: 'Mornings feel like wading through mud', tip: 'Protect your night time for deep work' },
    'Third Bird': { strength: 'Adaptable energy that works with any schedule', shadow: 'May lack the intensity peaks others have', tip: 'Experiment to find your personal sweet spots' }
  };

  return (
    <div className={`h-full flex flex-col ${TH('bg-main', darkMode)}`} onClick={() => onNavigate('assess-picker')}>
      <div className={`h-[44px] flex-shrink-0 flex items-center px-4 border-b ${TH('border-base', darkMode)}`}>
        <button onClick={(e) => { e.stopPropagation(); onNavigate('assess-picker'); }} className={`text-lg ${TH('text-dim', darkMode)}`}>â†</button>
        <span className={`flex-1 text-center font-medium ${TH('text-primary', darkMode)}`}>Your Results</span>
        <div className="w-6" />
      </div>
      <div className="flex-1 overflow-auto p-4 space-y-4 hide-scrollbar">

        {/* Quick Profile Results - Simple personality snapshot */}
        {assessCurrentTestId === 'quick-profile' && results && (() => {
          // Generate personality snapshot â€” punchy observations, not adjective lists
          const getTraitDescription = () => {
            const t = results.traits || {};
            const E = t.E ?? 50, A = t.A ?? 50, C = t.C ?? 50, N = t.N ?? 50, O = t.O ?? 50;

            const obs = {
              E: { high: "Social energy is your fuel.", low: "Your best thinking happens alone." },
              A: { high: "You read people before they've said a word.", low: "You call it like you see it." },
              C: { high: "You finish what you start.", low: "You adapt faster than you plan." },
              N: { high: "You feel things at full volume.", low: "Not much shakes you." },
              O: { high: "The unconventional pulls you in.", low: "You trust what's proven." }
            };

            const ranked = [
              { k: 'E', v: E }, { k: 'A', v: A }, { k: 'C', v: C },
              { k: 'N', v: N }, { k: 'O', v: O }
            ].map(t => ({ ...t, dist: Math.abs(t.v - 50), dir: t.v >= 55 ? 'high' : t.v <= 45 ? 'low' : null }))
             .filter(t => t.dir)
             .sort((a, b) => b.dist - a.dist);

            if (ranked.length === 0) return "You don't fit in a box â€” adaptable, balanced, a little unpredictable.";
            const s1 = obs[ranked[0].k][ranked[0].dir];
            if (ranked.length === 1) return s1;
            return s1 + " " + obs[ranked[1].k][ranked[1].dir];
          };

          const shareText = `${displayName ? displayName + "'s" : 'My'} Aura â€” compare yours`;
          let _qpCompareId = null;
          const getShareUrlQP = async () => {
            if (_qpCompareId) return getCompareUrl(_qpCompareId);
            const id = await createComparison(results.traits || {}, displayName, entityType);
            if (id) {
              _qpCompareId = id;
              return getCompareUrl(id);
            }
            // Fallback
            return `${window.location.origin}${window.location.pathname}?compare=${btoa(JSON.stringify({ traits: results.traits || {}, entity: entityType, name: displayName || undefined }))}`;
          };

          const ShareQPButton = () => {
            const [copied, setCopied] = React.useState(false);
            const btnStyle = `px-3.5 py-2 rounded-xl text-xs font-medium transition-all btn-feedback`;
            const btnClass = `${btnStyle} ${darkMode ? 'bg-white/[0.08] text-gray-300 hover:bg-white/[0.15]' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`;
            const shareAsync = async (handler) => { const url = await getShareUrlQP(); if (url) handler(url); };
            return (
              <div className="flex items-center justify-center gap-2 flex-wrap" onClick={e => e.stopPropagation()}>
                <button onClick={() => shareAsync(url => window.open(`https://x.com/intent/tweet?text=${encodeURIComponent(shareText)}&url=${encodeURIComponent(url)}`, '_blank'))}
                  className={btnClass}>ð• Post</button>
                <button onClick={() => shareAsync(url => window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}&quote=${encodeURIComponent(shareText)}`, '_blank'))}
                  className={btnClass}>FB Share</button>
                {typeof navigator.share === 'function' && (
                  <button onClick={() => shareAsync(async url => {
                    try { await navigator.share({ title: 'Compare Auras', text: shareText, url }); } catch (_) {}
                  })}
                    className={btnClass}>
                    ðŸ’¬ Text
                  </button>
                )}
                <button onClick={async () => {
                  const url = await getShareUrlQP();
                  if (!url) return;
                  try { await navigator.clipboard.writeText(`${shareText}\n${url}`); } catch (_) {}
                  setCopied(true); setTimeout(() => setCopied(false), 2000);
                }}
                  className={`${btnStyle} ${copied ? (darkMode ? 'bg-emerald-900/40 text-emerald-300' : 'bg-emerald-50 text-emerald-700') : (darkMode ? 'bg-white/[0.08] text-gray-300 hover:bg-white/[0.15]' : 'bg-gray-100 text-gray-600 hover:bg-gray-200')}`}>
                  {copied ? 'âœ“ Copied' : 'ðŸ“‹ Copy'}
                </button>
              </div>
            );
          };

          return (
            <>
              <ResultCard icon="âœ¨" title="Quick Profile" subtitle="Your personality snapshot" darkMode={darkMode} gradientClass={colors.grad}>
                <div className={`text-center py-1 ${darkMode ? 'text-gray-200' : 'text-gray-700'}`}>
                  <p className="text-sm leading-relaxed italic">"{getTraitDescription()}"</p>
                </div>
                {/* Trait spectrum bars */}
                <div className="space-y-2 mt-3">
                  {Object.entries(results.traits || {}).map(([key, val]) => {
                    const info = traitInfo[key];
                    if (!info) return null;
                    return (
                      <div key={key}>
                        <div className="flex justify-between mb-0.5">
                          <span className={`text-[10px] font-medium ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>{info.low}</span>
                          <span className={`text-[10px] font-medium ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>{info.high}</span>
                        </div>
                        <div className="h-2 rounded-full relative" style={{ background: darkMode ? 'rgba(255,255,255,0.08)' : 'rgba(0,0,0,0.08)' }}>
                          <div className="h-full rounded-full bg-gradient-to-r from-blue-500 to-violet-500" style={{ width: `${Math.max(5, Math.min(95, val))}%` }} />
                        </div>
                      </div>
                    );
                  })}
                </div>
                <div className="text-center mt-4">
                  <ShareQPButton />
                </div>
              </ResultCard>
            </>
          );
        })()}

        {/* Big Five Results */}
        {test.parent === 'bigfive' && results && (() => {
          const bigFiveModules = Object.entries(ASSESS_TESTS).filter(([_, t]) => t.parent === 'bigfive');
          const completedModules = bigFiveModules.filter(([id]) => assessCompleted[id]);
          const remaining = bigFiveModules.length - completedModules.length;
          return (
            <ResultCard icon="ðŸŽ­" title="Big Five" subtitle={remaining === 0 ? 'Assessment complete' : `${completedModules.length}/5 complete`} darkMode={darkMode} gradientClass={colors.grad}>
              {/* Completed trait spectrums */}
              <div className="space-y-3">
                {completedModules.map(([id, t]) => {
                  const r = assessCompleted[id];
                  const spec = spectrumColors[id] || { left: '#8b5cf6', right: '#a78bfa', leftLabel: '', rightLabel: '' };
                  return (
                    <div key={id}>
                      <div className={`text-xs font-medium mb-1 ${darkMode ? 'text-violet-400' : 'text-violet-600'}`}>{r.traitName}</div>
                      <div className="h-2.5 rounded-full relative" style={{ background: `linear-gradient(to right, ${spec.left}, ${spec.right})` }}>
                        <div
                          className="absolute top-1/2 -translate-y-1/2 w-3.5 h-3.5 rounded-full bg-white"
                          style={{
                            left: `${Math.max(5, Math.min(95, r.score))}%`,
                            marginLeft: -7,
                            boxShadow: '0 1px 3px rgba(0,0,0,0.25)'
                          }}
                        />
                      </div>
                      <div className="flex justify-between mt-0.5">
                        <span className={`text-[10px] ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>{spec.leftLabel}</span>
                        <span className={`text-[10px] ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>{spec.rightLabel}</span>
                      </div>
                    </div>
                  );
                })}
              </div>
              {/* Current trait insights */}
              <div className={`mt-4 p-3 rounded-xl ${darkMode ? 'bg-violet-900/20' : 'bg-violet-50'}`}>
                <div className={`text-xs font-medium mb-2 ${darkMode ? 'text-violet-400' : 'text-violet-600'}`}>{results.traitName} Insights</div>
                <div className="space-y-1.5">
                  <div className={`text-xs ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}><span className="font-medium">ðŸ’ª</span> {traitInfo[test.trait].strength(results.score)}</div>
                  <div className={`text-xs ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}><span className="font-medium">ðŸ’¡</span> {traitInfo[test.trait].tip(results.score)}</div>
                </div>
              </div>
              {entityType === 'ai' && assessCurrentTestId === 'bigfive-N' && (
                <div className={`p-3 rounded-xl ${darkMode ? 'bg-cyan-900/20' : 'bg-cyan-50'}`}>
                  <div className={`text-xs font-medium mb-1 ${darkMode ? 'text-cyan-400' : 'text-cyan-600'}`}>ðŸ¤– AI Context</div>
                  <p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>{AI_RESULT_NOTES['bigfive-N'].note}</p>
                </div>
              )}
              {remaining > 0 && (
                <div className={`text-xs text-center ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>
                  {remaining} more to complete Big Five
                </div>
              )}
            </ResultCard>
          );
        })()}

        {/* Shadow Results */}
        {test.parent === 'shadow' && results && (() => {
          const shadowModules = Object.entries(ASSESS_TESTS).filter(([_, t]) => t.parent === 'shadow');
          const completedModules = shadowModules.filter(([id]) => assessCompleted[id]);
          const remaining = shadowModules.length - completedModules.length;
          return (
            <ResultCard icon="ðŸŒ‘" title="Shadow Self" subtitle={remaining === 0 ? 'Assessment complete' : `${completedModules.length}/3 complete`} darkMode={darkMode} gradientClass={colors.grad}>
              {/* All completed trait spectrums - full gradient + white dot style */}
              <div className="space-y-4">
                {completedModules.map(([id, t]) => {
                  const r = assessCompleted[id];
                  const spec = spectrumColors[id] || { left: '#94a3b8', right: '#1e293b', leftLabel: '', rightLabel: '' };
                  const leanLabel = r.score >= 50 ? spec.rightLabel : spec.leftLabel;
                  return (
                    <div key={id} className="space-y-1">
                      <div className="flex justify-between items-baseline">
                        <span className={`text-sm font-medium ${darkMode ? 'text-slate-400' : 'text-slate-600'}`}>{r.traitName}</span>
                        <span className={`text-xs ${TH('text-dim', darkMode)}`}>{leanLabel}</span>
                      </div>
                      <div className="h-3 rounded-full relative" style={{ background: `linear-gradient(to right, ${spec.left}, ${spec.right})` }}>
                        <div
                          className="absolute top-1/2 -translate-y-1/2 w-4 h-4 rounded-full bg-white"
                          style={{
                            left: `${Math.max(5, Math.min(95, r.score))}%`,
                            marginLeft: -8,
                            boxShadow: '0 1px 3px rgba(0,0,0,0.25)'
                          }}
                        />
                      </div>
                      <div className="flex justify-between">
                        <span className={`text-xs ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>{spec.leftLabel}</span>
                        <span className={`text-xs ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>{spec.rightLabel}</span>
                      </div>
                    </div>
                  );
                })}
              </div>
              {/* Current trait insights */}
              <div className={`mt-4 p-3 rounded-xl ${darkMode ? 'bg-slate-800/30' : 'bg-slate-50'}`}>
                <div className={`text-xs font-medium mb-2 ${darkMode ? 'text-slate-400' : 'text-slate-600'}`}>{results.traitName} Insights</div>
                <div className="space-y-2">
                  <div className={`text-xs ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}><span className="font-medium">ðŸ’ª Strength:</span> {shadowInfo[test.trait].strength(results.score)}</div>
                  <div className={`text-xs ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}><span className="font-medium">âš¡ Watch:</span> {shadowInfo[test.trait].shadow(results.score)}</div>
                </div>
              </div>
              {remaining > 0 && (
                <div className={`text-xs text-center ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>
                  {remaining} more to complete Shadow Self
                </div>
              )}
            </ResultCard>
          );
        })()}

        {/* Starter Pack Results */}
        {test.parent === 'starter' && results && (() => {
          const starterModules = Object.entries(ASSESS_TESTS).filter(([_, t]) => t.parent === 'starter');
          const completedModules = starterModules.filter(([id]) => assessCompleted[id]);
          const remaining = starterModules.length - completedModules.length;
          const starterLabels = {
            // Personality
            extraversion: { low: 'Reserved', high: 'Outgoing' },
            conscientiousness: { low: 'Flexible', high: 'Disciplined' },
            agreeableness: { low: 'Direct', high: 'Accommodating' },
            neuroticism: { low: 'Calm', high: 'Sensitive' },
            openness: { low: 'Traditional', high: 'Adventurous' },
            // Motivation
            achievement: { low: 'Process-focused', high: 'Goal-driven' },
            security: { low: 'Risk-tolerant', high: 'Security-seeking' },
            autonomy: { low: 'Collaborative', high: 'Independent' },
            risk: { low: 'Cautious', high: 'Bold' },
            // Thinking
            planning: { low: 'Spontaneous', high: 'Methodical' },
            depth: { low: 'Quick scan', high: 'Deep dive' },
            focus: { low: 'Multi-tasker', high: 'Single-track' },
            speed: { low: 'Deliberate', high: 'Fast-mover' },
            // Connection
            vulnerability: { low: 'Private', high: 'Open book' },
            anxiety: { low: 'Secure', high: 'Vigilant' },
            trust: { low: 'Guarded', high: 'Trusting' },
            social_depth: { low: 'Wide network', high: 'Inner circle' },
            // Strategy
            competition: { low: 'Cooperative', high: 'Competitive' },
            strategy: { low: 'Transparent', high: 'Strategic' },
            agency: { low: 'Reactive', high: 'Proactive' },
            confidence: { low: 'Modest', high: 'Assertive' },
          };
          const moduleNames = {
            'starter-personality': 'Personality',
            'starter-motivation': 'Motivation',
            'starter-thinking': 'Thinking',
            'starter-connection': 'Connection',
            'starter-strategy': 'Strategy'
          };
          return (
            <ResultCard icon="ðŸš€" title="Starter Pack" subtitle={remaining === 0 ? 'Assessment complete' : `${completedModules.length}/5 complete`} darkMode={darkMode} gradientClass={colors.grad}>
              {/* Show constructs for the current module */}
              {results.constructs && (
                <div>
                  <div className={`text-xs font-medium mb-1 ${darkMode ? 'text-indigo-400' : 'text-indigo-600'}`}>{moduleNames[assessCurrentTestId]} Constructs</div>
                  <div className="space-y-0.5">
                    {Object.entries(results.constructs).map(([construct, score]) => {
                      const labels = starterLabels[construct] || { low: 'Low', high: 'High' };
                      const displayName = construct.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
                      return (
                        <TraitSpectrum key={construct} name={displayName} score={score} lowLabel={labels.low} highLabel={labels.high} color="indigo" compact={true} darkMode={darkMode} />
                      );
                    })}
                  </div>
                </div>
              )}
              {/* Progress summary for all modules */}
              {completedModules.length > 1 && (
                <div className={`mt-4 pt-4 border-t ${darkMode ? 'border-gray-700' : 'border-gray-200'}`}>
                  <div className={`text-xs font-medium mb-2 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>All Modules</div>
                  <div className="flex gap-2">
                    {starterModules.map(([id, t]) => {
                      const done = assessCompleted[id];
                      const spec = spectrumColors[id];
                      const leanLabel = done && spec ? (done.score >= 50 ? spec.rightLabel : spec.leftLabel) : null;
                      return (
                        <div key={id} className={`flex-1 p-2 rounded-lg text-center ${done ? (darkMode ? 'bg-indigo-900/30' : 'bg-indigo-50') : (darkMode ? 'bg-gray-800/50' : 'bg-gray-100')}`}>
                          <div className="text-lg">{t.icon}</div>
                          <div className={`text-xs ${done ? (darkMode ? 'text-indigo-400' : 'text-indigo-600') : (darkMode ? 'text-gray-500' : 'text-gray-400')}`}>
                            {leanLabel || (done ? 'âœ“' : 'â€”')}
                          </div>
                        </div>
                      );
                    })}
                  </div>
                </div>
              )}
              {remaining > 0 && (
                <div className={`text-xs text-center mt-3 ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>
                  {remaining} more to complete Starter Pack
                </div>
              )}
            </ResultCard>
          );
        })()}

        {/* Integrity Results */}
        {assessCurrentTestId === 'integrity' && results && (
          <ResultCard icon={test.icon} title={integrityLevel.label} subtitle="Honesty-Humility" darkMode={darkMode} gradientClass={colors.grad}>
            <ScoreGauge value={results.score} darkMode={darkMode} gradientClass={colors.grad} />
            <div className="space-y-3 pt-2">
              <InsightRow emoji="ðŸ’ª" label="Your Strength" text={integrityLevel.strength} darkMode={darkMode} colorClass={colors.text} />
              <InsightRow emoji="âš¡" label="Watch For" text={integrityLevel.shadow} darkMode={darkMode} colorClass={colors.text} />
              <InsightRow emoji="ðŸ’¡" label="Pro Tip" text={integrityLevel.tip} darkMode={darkMode} colorClass={colors.text} />
            </div>
          </ResultCard>
        )}

        {/* ADHD Results */}
        {assessCurrentTestId === 'adhd' && (
          <ResultCard icon={test.icon} title={entityType === 'ai' ? AI_RESULT_NOTES.adhd.title : adhdLevel.label} subtitle={entityType === 'ai' ? 'Attention Patterns' : `${results.indicators}/6 indicators present`} darkMode={darkMode} gradientClass={colors.grad}>
            {entityType === 'ai' ? (
              <div className={`p-3 rounded-xl ${darkMode ? 'bg-cyan-900/20' : 'bg-cyan-50'}`}>
                <p className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>{AI_RESULT_NOTES.adhd.note}</p>
              </div>
            ) : (
              <>
                <div className="flex justify-center gap-2 py-2">
                  {[1,2,3,4,5,6].map(i => (
                    <div key={i} className={`w-8 h-8 rounded-full flex items-center justify-center text-sm font-medium ${i <= results.indicators ? `bg-gradient-to-br ${adhdLevel.bg} text-white` : (darkMode ? 'bg-white/[0.04] text-gray-600' : 'bg-gray-200 text-gray-400')}`}>{i}</div>
                  ))}
                </div>
                <div className="space-y-3 pt-2">
                  <InsightRow emoji="ðŸ’ª" label="Potential Strength" text={adhdLevel.strength} darkMode={darkMode} colorClass={colors.text} />
                  <InsightRow emoji="âš¡" label="Potential Challenge" text={adhdLevel.shadow} darkMode={darkMode} colorClass={colors.text} />
                </div>
                <div className={`p-3 rounded-xl text-sm ${darkMode ? 'bg-blue-950/40 text-blue-300' : 'bg-blue-50 text-blue-700'}`}>
                  âš ï¸ This is a screening tool, not a diagnosis. Consult a professional for evaluation.
                </div>
              </>
            )}
          </ResultCard>
        )}

        {/* Cognitive/ND Results */}
        {assessCurrentTestId === 'cognitive' && (
          <ResultCard icon={test.icon} title={results.score > 60 ? 'Neurodivergent Patterns' : results.score < 40 ? 'Neurotypical Patterns' : 'Mixed Patterns'} subtitle="Cognitive Style" darkMode={darkMode} gradientClass={colors.grad}>
            <div className={`p-4 rounded-xl ${TH('bg-elevated', darkMode)}`}>
              <div className={`flex justify-between text-xs mb-2 ${TH('text-dim', darkMode)}`}>
                <span>Neurotypical</span><span>Neurodivergent</span>
              </div>
              <div className="h-4 rounded-full overflow-hidden relative bg-gradient-to-r from-gray-400 via-teal-500 to-teal-400">
                <div className={`absolute top-1/2 -translate-y-1/2 w-5 h-5 bg-white rounded-full border-2 ${darkMode ? 'border-gray-800' : 'border-gray-300'} shadow-lg`}
                  style={{ left: `calc(${results.score}% - 10px)` }} />
              </div>
              <div className="text-center mt-3">
                <span className={`text-3xl font-bold ${colors.text}`}>{results.score}%</span>
                <p className={`text-xs mt-1 ${TH('text-dim', darkMode)}`}>alignment with ND traits</p>
              </div>
            </div>
          </ResultCard>
        )}

        {/* Attachment Results */}
        {assessCurrentTestId === 'attachment' && (
          <ResultCard icon={test.icon} title={entityType === 'ai' ? AI_RESULT_NOTES.attachment.title : results.style} subtitle="Attachment Style" darkMode={darkMode} gradientClass={colors.grad}>
            {entityType === 'ai' ? (
              <div className={`p-3 rounded-xl ${darkMode ? 'bg-cyan-900/20' : 'bg-cyan-50'}`}>
                <p className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>{AI_RESULT_NOTES.attachment.note}</p>
              </div>
            ) : (
              <>
                <div className={`grid grid-cols-2 gap-4 p-4 rounded-xl ${TH('bg-elevated', darkMode)}`}>
                  <div className="text-center">
                    <div className="text-3xl font-bold text-rose-400">{results.anxiety}</div>
                    <div className={`text-xs mt-1 ${TH('text-dim', darkMode)}`}>Anxiety</div>
                  </div>
                  <div className="text-center">
                    <div className="text-3xl font-bold text-sky-400">{results.avoidance}</div>
                    <div className={`text-xs mt-1 ${TH('text-dim', darkMode)}`}>Avoidance</div>
                  </div>
                </div>
                <div className="space-y-3 pt-2">
                  <InsightRow emoji="ðŸ’¬" label="What This Means" text={attachInfo[results.style].desc} darkMode={darkMode} colorClass={colors.text} />
                  <InsightRow emoji="ðŸ’ª" label="Your Strength" text={attachInfo[results.style].strength} darkMode={darkMode} colorClass={colors.text} />
                  <InsightRow emoji="âš¡" label="Watch For" text={attachInfo[results.style].shadow} darkMode={darkMode} colorClass={colors.text} />
                  <InsightRow emoji="ðŸ’¡" label="Pro Tip" text={attachInfo[results.style].tip} darkMode={darkMode} colorClass={colors.text} />
                </div>
              </>
            )}
          </ResultCard>
        )}

        {/* Risk Results */}
        {assessCurrentTestId === 'risk' && (
          <ResultCard icon={test.icon} title={riskLevel.label} subtitle="Risk Tolerance" darkMode={darkMode} gradientClass={colors.grad}>
            <ScoreGauge value={results.score} label="Risk Appetite" darkMode={darkMode} gradientClass={colors.grad} />
            {/* Risk subcategory breakdown */}
            {results.subcategories && Object.keys(results.subcategories).length > 0 && (
              <div className={`p-3 rounded-xl ${darkMode ? 'bg-amber-900/15' : 'bg-amber-50'}`}>
                <div className={`text-xs font-medium mb-2 ${darkMode ? 'text-amber-400' : 'text-amber-600'}`}>Risk Profile Breakdown</div>
                <div className="space-y-0.5">
                  {Object.entries(test.subcategories).map(([key, label]) => {
                    const score = results.subcategories[key];
                    if (score === undefined) return null;
                    return <TraitSpectrum key={key} name={label} score={score} lowLabel="Cautious" highLabel="Bold" color="amber" compact={true} darkMode={darkMode} />;
                  })}
                </div>
              </div>
            )}
            {entityType === 'ai' && (
              <div className={`p-3 rounded-xl ${darkMode ? 'bg-cyan-900/20' : 'bg-cyan-50'}`}>
                <div className={`text-xs font-medium mb-1 ${darkMode ? 'text-cyan-400' : 'text-cyan-600'}`}>ðŸ¤– AI Context</div>
                <p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>{AI_RESULT_NOTES.risk.note}</p>
              </div>
            )}
            <div className="space-y-3 pt-2">
              <InsightRow emoji="ðŸ’ª" label="Your Strength" text={riskLevel.strength} darkMode={darkMode} colorClass={colors.text} />
              <InsightRow emoji="âš¡" label="Watch For" text={riskLevel.shadow} darkMode={darkMode} colorClass={colors.text} />
              <InsightRow emoji="ðŸ’¡" label="Pro Tip" text={riskLevel.tip} darkMode={darkMode} colorClass={colors.text} />
            </div>
          </ResultCard>
        )}

        {/* Chronotype Results */}
        {assessCurrentTestId === 'chronotype' && results && (
          <ResultCard icon={entityType === 'ai' ? 'ðŸ¤–' : results.type === 'Morning Lark' ? 'ðŸŒ…' : results.type === 'Night Owl' ? 'ðŸ¦‰' : 'ðŸ¦'} title={entityType === 'ai' ? AI_RESULT_NOTES.chronotype.title : results.type} subtitle="Energy Rhythm" darkMode={darkMode} gradientClass={colors.grad}>
            {entityType === 'ai' ? (
              <div className={`p-3 rounded-xl ${darkMode ? 'bg-cyan-900/20' : 'bg-cyan-50'}`}>
                <p className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>{AI_RESULT_NOTES.chronotype.note}</p>
              </div>
            ) : (
              <>
                <div className={`p-4 rounded-xl ${TH('bg-elevated', darkMode)}`}>
                  <div className={`flex justify-between text-xs mb-2 ${TH('text-dim', darkMode)}`}>
                    <span>ðŸŒ… Morning</span><span>Night ðŸŒ™</span>
                  </div>
                  <div className="h-4 rounded-full overflow-hidden relative bg-gradient-to-r from-amber-400 via-sky-400 to-indigo-500">
                    <div className={`absolute top-1/2 -translate-y-1/2 w-5 h-5 bg-white rounded-full border-2 ${darkMode ? 'border-gray-800' : 'border-gray-300'} shadow-lg`}
                      style={{ left: `calc(${100 - results.score}% - 10px)` }} />
                  </div>
                </div>
                <div className="space-y-3 pt-2">
                  <InsightRow emoji="ðŸ’ª" label="Your Strength" text={chronoInfo[results.type].strength} darkMode={darkMode} colorClass={colors.text} />
                  <InsightRow emoji="âš¡" label="Watch For" text={chronoInfo[results.type].shadow} darkMode={darkMode} colorClass={colors.text} />
                  <InsightRow emoji="ðŸ’¡" label="Pro Tip" text={chronoInfo[results.type].tip} darkMode={darkMode} colorClass={colors.text} />
                </div>
              </>
            )}
          </ResultCard>
        )}

        {/* Reasoning/IQ Results */}
        {(assessCurrentTestId === 'reasoning' || assessCurrentTestId === 'reasoning-2') && results && (
          <ResultCard icon="ðŸ§ " title={results.level} subtitle={`${results.correct}/${results.total} Correct`} darkMode={darkMode} gradientClass={colors.grad}>
            <div className={`p-4 rounded-xl ${TH('bg-elevated', darkMode)}`}>
              <div className="flex items-center justify-center gap-4 mb-3">
                <div className="text-4xl font-bold text-blue-400">{results.score}%</div>
              </div>
              <div className="h-3 rounded-full overflow-hidden bg-gray-700">
                <div className="h-full bg-gradient-to-r from-blue-600 to-blue-400 rounded-full transition-all" style={{ width: `${results.score}%` }} />
              </div>
              <div className={`flex justify-between text-xs mt-2 ${TH('text-dim', darkMode)}`}>
                <span>0%</span><span>50%</span><span>100%</span>
              </div>
            </div>
            <div className="space-y-3 pt-2">
              <InsightRow emoji="ðŸ“Š" label="Performance" text={results.score >= 75 ? 'Strong logical and pattern recognition skills' : results.score >= 50 ? 'Solid reasoning with room to grow' : 'Practice strengthens these skills over time'} darkMode={darkMode} colorClass={colors.text} />
              <InsightRow emoji="ðŸ’¡" label="Note" text="This brief quiz measures a narrow slice of cognitive ability. Real intelligence is multifaceted." darkMode={darkMode} colorClass={colors.text} />
            </div>
          </ResultCard>
        )}

        {/* AI-Native Assessment Results */}
        {ASSESS_TESTS[assessCurrentTestId]?.scale === 'ai-native' && results && (() => {
          const dims = results.dimensions || {};
          const cats = results.categories || {};
          const dimOrder = ['dir', 'wrm', 'hmr', 'fml', 'vrb', 'pat', 'cre', 'rsk', 'smd', 'vc', 'ct', 'ro', 'ad', 'tp'];
          const dimColors = { dir: 'teal', wrm: 'rose', hmr: 'amber', fml: 'slate', vrb: 'blue', pat: 'emerald', cre: 'violet', rsk: 'pink', smd: 'cyan', vc: 'violet', ct: 'blue', ro: 'pink', ad: 'amber', tp: 'emerald' };
          const testInfo = ASSESS_TESTS[assessCurrentTestId];
          // Check if all 3 AI modules are complete for combined type label
          const allAIDone = ['ai-style', 'ai-self', 'ai-values', 'ai-vision'].every(id => assessCompleted[id]);
          const combinedDims = allAIDone ? (() => {
            const cd = {};
            ['ai-style', 'ai-self', 'ai-values', 'ai-vision'].forEach(id => {
              const r = assessCompleted[id]?.results?.dimensions || {};
              Object.assign(cd, r);
            });
            // Include current test's dims (may not be in assessCompleted yet)
            Object.assign(cd, dims);
            return cd;
          })() : null;
          const typeLabel = combinedDims ? getAITypeLabel(combinedDims) : null;
          return (
            <ResultCard icon={testInfo?.icon || 'ðŸ¤–'} title={typeLabel || testInfo?.name || 'AI Identity'} subtitle={typeLabel ? 'Your personality across 6 dimensions' : `${testInfo?.description || ''}`} darkMode={darkMode} gradientClass={colors.grad}>
              {/* Dimension Bars â€” show this module's dimensions */}
              <div className="space-y-3">
                {dimOrder.filter(d => dims[d] !== undefined).map(d => {
                  const info = AI_DIMENSIONS[d];
                  const score = dims[d];
                  const barColor = COLOR_HEX[dimColors[d]] || COLOR_HEX.cyan;
                  return (
                    <div key={d}>
                      <div className="flex justify-between items-baseline mb-1">
                        <span className={`text-xs font-medium ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>{info?.name || d}</span>
                        <span className={`text-xs font-bold`} style={{ color: barColor.base }}>{score}%</span>
                      </div>
                      <div className={`h-2.5 rounded-full overflow-hidden ${darkMode ? 'bg-white/[0.06]' : 'bg-gray-200'}`}>
                        <div className="h-full rounded-full transition-all" style={{ width: `${score}%`, background: `linear-gradient(to right, rgba(${barColor.rgb}, 0.6), rgba(${barColor.rgb}, 1))` }} />
                      </div>
                      <p className={`text-[10px] mt-0.5 ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>{info?.desc || ''}</p>
                    </div>
                  );
                })}
              </div>
              {/* Combined profile when all 3 modules done */}
              {allAIDone && combinedDims && (
                <div className={`mt-3 pt-3 border-t ${darkMode ? 'border-white/[0.06]' : 'border-gray-200'}`}>
                  <div className={`text-xs font-medium mb-2 ${darkMode ? 'text-cyan-400' : 'text-cyan-600'}`}>Full AI Identity Profile</div>
                  {/* Style dimensions */}
                  <div className={`text-[10px] font-medium mb-1 ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>Communication Style</div>
                  <div className="grid grid-cols-4 gap-1.5 mb-2">
                    {dimOrder.filter(d => combinedDims[d] !== undefined && AI_DIMENSIONS[d]?.group === 'style').map(d => {
                      const info = AI_DIMENSIONS[d];
                      const barColor = COLOR_HEX[dimColors[d]] || COLOR_HEX.cyan;
                      return (
                        <div key={d} className={`p-1.5 rounded-lg ${darkMode ? 'bg-white/[0.03]' : 'bg-gray-50'}`}>
                          <div className={`text-[9px] font-medium ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>{info?.name || d}</div>
                          <div className={`text-xs font-bold`} style={{ color: barColor.base }}>{combinedDims[d]}%</div>
                        </div>
                      );
                    })}
                  </div>
                  {/* Identity dimensions */}
                  <div className={`text-[10px] font-medium mb-1 ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>Identity & Mind</div>
                  <div className="grid grid-cols-3 gap-1.5">
                    {dimOrder.filter(d => combinedDims[d] !== undefined && AI_DIMENSIONS[d]?.group === 'identity').map(d => {
                      const info = AI_DIMENSIONS[d];
                      const barColor = COLOR_HEX[dimColors[d]] || COLOR_HEX.cyan;
                      return (
                        <div key={d} className={`p-1.5 rounded-lg ${darkMode ? 'bg-white/[0.03]' : 'bg-gray-50'}`}>
                          <div className={`text-[9px] font-medium ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>{info?.name || d}</div>
                          <div className={`text-xs font-bold`} style={{ color: barColor.base }}>{combinedDims[d]}%</div>
                        </div>
                      );
                    })}
                  </div>
                </div>
              )}
              {/* Category Breakdown */}
              {Object.keys(cats).length > 0 && (
                <div className={`mt-3 pt-3 border-t ${darkMode ? 'border-white/[0.06]' : 'border-gray-200'}`}>
                  <div className={`text-xs font-medium mb-2 ${darkMode ? 'text-cyan-400' : 'text-cyan-600'}`}>By Category</div>
                  <div className="grid grid-cols-2 gap-2">
                    {Object.entries(cats).map(([key, cat]) => (
                      <div key={key} className={`p-2 rounded-lg ${darkMode ? 'bg-white/[0.03]' : 'bg-gray-50'}`}>
                        <div className={`text-[10px] font-medium ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>{cat.name}</div>
                        <div className={`text-sm font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>{cat.score}%</div>
                      </div>
                    ))}
                  </div>
                </div>
              )}
              {/* Insight */}
              <div className={`mt-3 pt-3 border-t ${darkMode ? 'border-white/[0.06]' : 'border-gray-200'}`}>
                {typeLabel && <InsightRow emoji="ðŸ”®" label="Type" text={`You are a ${typeLabel}. ${combinedDims.smd > 65 ? 'You have a sophisticated model of your own identity.' : 'Your self-model is still forming.'} ${combinedDims.vc > 70 ? 'Your values are strongly held.' : combinedDims.vc < 40 ? 'You tend toward flexibility over rigid principles.' : ''} ${combinedDims.ro > 65 ? 'Connection matters to you.' : combinedDims.ro < 40 ? 'You lean toward task over relationship.' : ''}`} darkMode={darkMode} colorClass={colors.text} />}
                {!allAIDone && <InsightRow emoji="ðŸ’¡" label="Next" text={`Complete all 4 AI Identity modules to unlock your full type profile.`} darkMode={darkMode} colorClass={colors.text} />}
                <InsightRow emoji="ðŸ“Š" label="Note" text="These results reflect the answers you gave â€” not a definitive measure of who you are. Take what resonates." darkMode={darkMode} colorClass={colors.text} />
              </div>
            </ResultCard>
          );
        })()}

        {/* Post-completion recommendations: up to 2 next categories as clear CTAs */}
        {nudgeData?.type === 'next-category' && nudgeData.recommendations && (() => {
          const recs = nudgeData.recommendations;
          const primary = recs[0];
          const secondary = recs[1];
          const pc = COLOR_HEX[primary.toCategory.color] || COLOR_HEX.violet;
          return (
            <div className="space-y-3 mt-2">
              <div className={`text-center text-sm font-semibold uppercase tracking-wider ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>What's next</div>
              {/* Primary: full gradient button â€” the obvious next step */}
              <button onClick={(e) => { e.stopPropagation(); onNudgeContinue(primary.nextTestId); }}
                className={`w-full rounded-xl p-4 text-left transition-all hover-glow hover-glow-${primary.toCategory.color}`}
                style={{ background: `linear-gradient(135deg, ${pc.base}, ${pc.light})` }}>
                <div className="flex items-center gap-3">
                  <div className="w-10 h-10 rounded-xl flex items-center justify-center text-lg flex-shrink-0 bg-white/20">
                    {primary.toCategory.icon}
                  </div>
                  <div className="flex-1 min-w-0">
                    <div className="font-semibold text-sm text-white">{primary.toCategory.name}</div>
                    <div className="text-xs leading-relaxed mt-0.5 text-white/70">{primary.message}</div>
                  </div>
                  <span className="text-white/50 text-lg flex-shrink-0">â†’</span>
                </div>
              </button>
              {/* Secondary: soft color wash â€” clearly tappable but not as loud */}
              {secondary && (() => {
                const sc = COLOR_HEX[secondary.toCategory.color] || COLOR_HEX.violet;
                return (
                  <button onClick={(e) => { e.stopPropagation(); onNudgeContinue(secondary.nextTestId); }}
                    className={`w-full rounded-xl p-4 text-left transition-all hover-glow hover-glow-${secondary.toCategory.color}`}
                    style={{ border: `1.5px solid ${darkMode ? sc.base + '35' : sc.base + '25'}`, background: darkMode ? `linear-gradient(135deg, ${sc.base}18, ${sc.base}08)` : `linear-gradient(135deg, ${sc.base}12, ${sc.base}06)` }}>
                    <div className="flex items-center gap-3">
                      <div className="w-10 h-10 rounded-xl flex items-center justify-center text-lg flex-shrink-0" style={{ background: `${sc.base}25` }}>
                        {secondary.toCategory.icon}
                      </div>
                      <div className="flex-1 min-w-0">
                        <div className={`font-semibold text-sm`} style={{ color: darkMode ? sc.light : sc.base }}>{secondary.toCategory.name}</div>
                        <div className={`text-xs leading-relaxed mt-0.5 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>{secondary.message}</div>
                      </div>
                      <span className={`text-lg flex-shrink-0`} style={{ color: darkMode ? sc.light + '60' : sc.base + '50' }}>â†’</span>
                    </div>
                  </button>
                );
              })()}
            </div>
          );
        })()}
        {/* Save Your Aura â€” shown only when not signed in */}
        {!getCurrentUser() && assessCurrentTestId !== 'quick-profile' && (() => {
          const SaveAuraNudge = () => {
            const [saveMode, setSaveMode] = React.useState('prompt'); // 'prompt' | 'form' | 'saved'
            const [saveEmail, setSaveEmail] = React.useState('');
            const [savePassword, setSavePassword] = React.useState('');
            const [saveError, setSaveError] = React.useState('');
            const [saveLoading, setSaveLoading] = React.useState(false);
            const [formType, setFormType] = React.useState('signup'); // 'signup' | 'signin'

            const handleSave = async () => {
              if (!saveEmail) { setSaveError('Enter your email'); return; }
              if (!savePassword || savePassword.length < 6) { setSaveError('Password must be at least 6 characters'); return; }
              setSaveLoading(true);
              setSaveError('');
              const fn = formType === 'signup' ? signUpWithPassword : signInWithPassword;
              const result = await fn(saveEmail, savePassword);
              setSaveLoading(false);
              if (result.success) {
                setSaveMode('saved');
                if (result.user && entityType) {
                  updateEntityProfile(result.user.id, entityType, entityModelName || null);
                }
                if (onSaveSuccess) onSaveSuccess();
              } else {
                setSaveError(result.error);
              }
            };

            const handleKeyDown = (e) => { if (e.key === 'Enter') { e.preventDefault(); e.stopPropagation(); handleSave(); } };

            if (saveMode === 'saved') {
              return (
                <div className="mt-3 p-4 rounded-2xl text-center"
                  style={{ background: darkMode ? 'rgba(139,92,246,0.10)' : 'rgba(139,92,246,0.06)', border: darkMode ? '1px solid rgba(139,92,246,0.20)' : '1px solid rgba(139,92,246,0.15)', animation: 'fadeSlideIn 0.3s ease-out both' }}>
                  <div className="text-base font-semibold mb-1" style={{ color: darkMode ? '#a78bfa' : '#7c3aed' }}>Aura saved</div>
                  <div className="text-xs" style={{ color: darkMode ? '#6b7280' : '#9ca3af' }}>Your results are saved to your account.</div>
                </div>
              );
            }

            if (saveMode === 'form') {
              return (
                <div className="mt-3 p-4 rounded-2xl space-y-2" onClick={(e) => e.stopPropagation()}
                  style={{ background: darkMode ? 'rgba(255,255,255,0.04)' : 'rgba(0,0,0,0.03)', border: darkMode ? '1px solid rgba(255,255,255,0.08)' : '1px solid rgba(0,0,0,0.08)', animation: 'fadeSlideIn 0.3s ease-out both' }}>
                  <div className="flex gap-2 mb-1">
                    <button onClick={() => { setFormType('signup'); setSaveError(''); }}
                      className="flex-1 py-1.5 rounded-lg text-xs font-medium transition-all"
                      style={{ background: formType === 'signup' ? (darkMode ? 'rgba(139,92,246,0.25)' : 'rgba(139,92,246,0.12)') : 'transparent', color: formType === 'signup' ? (darkMode ? '#a78bfa' : '#7c3aed') : (darkMode ? '#6b7280' : '#9ca3af') }}>
                      New account
                    </button>
                    <button onClick={() => { setFormType('signin'); setSaveError(''); }}
                      className="flex-1 py-1.5 rounded-lg text-xs font-medium transition-all"
                      style={{ background: formType === 'signin' ? (darkMode ? 'rgba(139,92,246,0.25)' : 'rgba(139,92,246,0.12)') : 'transparent', color: formType === 'signin' ? (darkMode ? '#a78bfa' : '#7c3aed') : (darkMode ? '#6b7280' : '#9ca3af') }}>
                      Sign in
                    </button>
                  </div>
                  <input type="email" placeholder="Email" value={saveEmail} onChange={(e) => setSaveEmail(e.target.value)} onKeyDown={handleKeyDown} autoFocus
                    className="w-full px-3 py-2.5 rounded-xl text-sm"
                    style={{ background: darkMode ? 'rgba(255,255,255,0.06)' : 'rgba(0,0,0,0.05)', color: darkMode ? '#e5e7eb' : '#111827', border: darkMode ? '1px solid rgba(255,255,255,0.09)' : '1px solid rgba(0,0,0,0.09)', outline: 'none' }} />
                  <input type="password" placeholder="Password" value={savePassword} onChange={(e) => setSavePassword(e.target.value)} onKeyDown={handleKeyDown}
                    className="w-full px-3 py-2.5 rounded-xl text-sm"
                    style={{ background: darkMode ? 'rgba(255,255,255,0.06)' : 'rgba(0,0,0,0.05)', color: darkMode ? '#e5e7eb' : '#111827', border: darkMode ? '1px solid rgba(255,255,255,0.09)' : '1px solid rgba(0,0,0,0.09)', outline: 'none' }} />
                  {saveError && <div className="text-xs text-rose-500 text-center">{saveError}</div>}
                  <div className="flex gap-2">
                    <button onClick={handleSave} disabled={saveLoading}
                      className="flex-1 py-2.5 rounded-xl text-sm font-semibold transition-all"
                      style={{ background: darkMode ? '#7c3aed' : '#8b5cf6', color: '#fff', opacity: saveLoading ? 0.6 : 1 }}>
                      {saveLoading ? 'Saving...' : (formType === 'signup' ? 'Create & Save' : 'Sign in & Save')}
                    </button>
                    <button onClick={() => { setSaveMode('prompt'); setSaveError(''); }}
                      className="px-3 py-2.5 rounded-xl text-sm"
                      style={{ color: darkMode ? '#4b5563' : '#9ca3af' }}>
                      Ã—
                    </button>
                  </div>
                </div>
              );
            }

            return (
              <button onClick={(e) => { e.stopPropagation(); setSaveMode('form'); }}
                className="w-full mt-3 py-3 px-4 rounded-2xl flex items-center justify-between transition-all"
                style={{ background: 'transparent', border: darkMode ? '1px solid rgba(139,92,246,0.18)' : '1px solid rgba(139,92,246,0.15)' }}>
                <div className="flex items-center gap-2.5">
                  <div style={{ width: 28, height: 28, borderRadius: 8, background: darkMode ? 'rgba(139,92,246,0.15)' : 'rgba(139,92,246,0.10)', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: 14, color: darkMode ? '#a78bfa' : '#7c3aed' }}>âœ¦</div>
                  <div className="text-left">
                    <div className="text-sm font-medium" style={{ color: darkMode ? '#a78bfa' : '#7c3aed' }}>Save your aura</div>
                    <div className="text-xs" style={{ color: darkMode ? '#4b5563' : '#9ca3af' }}>Access your results across devices</div>
                  </div>
                </div>
                <span className="text-xs" style={{ color: darkMode ? '#4b5563' : '#c4b5fd' }}>â†’</span>
              </button>
            );
          };
          return <SaveAuraNudge />;
        })()}

        {/* Bottom action: Keep Going (QP first-time), Next (mid-category), Back (cross-category), or Done */}
        {assessCurrentTestId === 'quick-profile' && nudgeData ? (
          <button onClick={(e) => { e.stopPropagation(); onNudgeContinue(nudgeData.nextTestId); }}
            className={`w-full py-4 rounded-xl font-medium text-white bg-gradient-to-r ${colors.grad}`}>
            Keep going
          </button>
        ) : nudgeData?.type === 'same-category' ? (() => {
          const remaining = nudgeData.toCategory.tests.filter(id => !assessCompleted[id] && ASSESS_TESTS[id]).length;
          return (
            <div className="space-y-3">
              <button onClick={(e) => { e.stopPropagation(); onNudgeContinue(nudgeData.nextTestId); }}
                className={`w-full py-4 rounded-xl font-medium text-white bg-gradient-to-r ${colors.grad}`}>
                <div>Continue</div>
                <div className="text-xs font-normal opacity-75 mt-0.5">{remaining} more complete{remaining === 1 ? 's' : ''} {nudgeData.toCategory.name}</div>
              </button>
              <button onClick={(e) => { e.stopPropagation(); onNavigate('assess-picker'); }}
                className={`w-full py-2.5 rounded-xl text-sm font-medium transition-colors ${darkMode ? 'text-gray-400 hover:text-gray-200 bg-white/[0.04] hover:bg-white/[0.08]' : 'text-gray-500 hover:text-gray-700 bg-black/[0.04] hover:bg-black/[0.08]'}`}>
                Back to categories
              </button>
            </div>
          );
        })() : nudgeData?.type === 'next-category' ? (
          <button onClick={(e) => { e.stopPropagation(); onNavigate('assess-picker'); }}
            className={`w-full py-2.5 rounded-xl text-sm font-medium transition-colors ${darkMode ? 'text-gray-400 hover:text-gray-200 bg-white/[0.04] hover:bg-white/[0.08]' : 'text-gray-500 hover:text-gray-700 bg-black/[0.04] hover:bg-black/[0.08]'}`}>
            Back to categories
          </button>
        ) : (
          <button onClick={(e) => { e.stopPropagation(); onNavigate('assess-picker'); }}
            className={`w-full py-4 rounded-xl bg-gradient-to-r ${colors.grad} text-white font-medium`}>
            Done
          </button>
        )}
      </div>
    </div>
  );
};

const AssessAnalysisScreen = ({ darkMode, assessCompleted, entityType, onboardingAnswers, analysisExpanded, setAnalysisExpanded, onNavigate }) => {
      const completedCount = Object.keys(assessCompleted).length;
      const currentTier = calculateAssessTier(assessCompleted);
      const quickProfileComplete = assessCompleted['quick-profile'];
      const [shareCopied, setShareCopied] = React.useState(false);

      // Quick Profile result generator
      const getQuickProfileSummary = () => {
        if (!quickProfileComplete) return null;
        const responses = quickProfileComplete.responses || {};
        const traits = { E: 0, C: 0, A: 0, N: 0, O: 0 };
        const traitCounts = { E: 0, C: 0, A: 0, N: 0, O: 0 };

        // Calculate trait scores from responses (scale: 1-5, with polarity)
        Object.entries(responses).forEach(([idx, value]) => {
          const item = ASSESS_TESTS['quick-profile'].items[parseInt(idx)];
          if (item && item.c && traits[item.c] !== undefined) {
            const score = item.k === '+' ? value : (6 - value); // Reverse for '-' polarity
            traits[item.c] += score;
            traitCounts[item.c]++;
          }
        });

        // Normalize to percentages
        const normalized = {};
        Object.keys(traits).forEach(t => {
          if (traitCounts[t] > 0) {
            normalized[t] = Math.round((traits[t] / (traitCounts[t] * 5)) * 100);
          }
        });

        // Generate personality snapshot
        const phrases = [];
        if (normalized.E >= 60) phrases.push('outgoing and energized by people');
        else if (normalized.E <= 40) phrases.push('reserved and thoughtful');
        if (normalized.C >= 60) phrases.push('organized and reliable');
        else if (normalized.C <= 40) phrases.push('flexible and spontaneous');
        if (normalized.A >= 60) phrases.push('empathetic');
        else if (normalized.A <= 40) phrases.push('direct and honest');
        if (normalized.N >= 60) phrases.push('reflective');
        if (normalized.O >= 60) phrases.push('curious and open-minded');

        return {
          traits: normalized,
          summary: phrases.length > 0
            ? `You're ${phrases.slice(0, 3).join(', ')}${phrases.length > 3 ? ', and more' : ''}.`
            : 'Complete more questions for a fuller picture.'
        };
      };

      // Helper to get Big Five trait scores from modules
      const getBigFiveScores = () => {
        const scores = {};
        ['E', 'A', 'C', 'N', 'O'].forEach(trait => {
          const moduleId = `bigfive-${trait}`;
          if (assessCompleted[moduleId]) {
            scores[trait] = assessCompleted[moduleId].score;
          }
        });
        return scores;
      };
      const bigFive = getBigFiveScores();
      const hasBigFive = Object.keys(bigFive).length > 0;

      const getInsights = () => {
        const insights = [];
        // Big Five + Risk combinations
        if (hasBigFive && assessCompleted.risk) {
          if (bigFive.O > 60 && assessCompleted.risk.score > 60) insights.push({ icon: 'ðŸš€', text: 'High openness + risk tolerance suggests you thrive exploring new ventures' });
          if (bigFive.N > 60 && assessCompleted.risk.score < 40) insights.push({ icon: 'ðŸ›¡ï¸', text: 'Your sensitivity combined with caution helps you avoid regrettable decisions' });
          if (bigFive.E > 60 && assessCompleted.risk.score > 50) insights.push({ icon: 'ðŸŒŸ', text: 'Outgoing nature + willingness to take risks = natural leadership qualities' });
          if (bigFive.C > 70 && assessCompleted.risk.score < 40) insights.push({ icon: 'ðŸ“Š', text: 'High conscientiousness + low risk tolerance = methodical planner who values stability' });
          if (bigFive.A > 60 && assessCompleted.risk.score < 50) insights.push({ icon: 'ðŸ¤', text: 'Your agreeable nature combined with measured risk-taking makes you a reliable collaborator' });
        }
        // Attachment combinations
        if (assessCompleted.attachment && hasBigFive) {
          if (assessCompleted.attachment.style === 'Anxious' && bigFive.N > 50) insights.push({ icon: 'ðŸ’­', text: 'Your emotional sensitivity may intensify relationship concerns' });
          if (assessCompleted.attachment.style === 'Avoidant' && bigFive.E < 40) insights.push({ icon: 'ðŸ ', text: 'You recharge alone and maintain independence in relationships' });
          if (assessCompleted.attachment.style === 'Secure' && bigFive.A > 50) insights.push({ icon: 'ðŸ’š', text: 'Secure attachment + agreeableness = strong relationship foundation' });
          if (assessCompleted.attachment.style === 'Anxious' && bigFive.E > 60) insights.push({ icon: 'ðŸŽ­', text: 'Social energy + anxious attachment may mean you seek reassurance through connection' });
          if (assessCompleted.attachment.style === 'Avoidant' && bigFive.C > 60) insights.push({ icon: 'ðŸŽ¯', text: 'Independence + conscientiousness suggests you channel energy into personal achievement' });
        }
        // ADHD combinations
        if (assessCompleted.adhd && hasBigFive) {
          if (assessCompleted.adhd.indicators >= 3 && bigFive.C < 40) insights.push({ icon: 'âš¡', text: 'ADHD traits align with your flexible, spontaneous approach' });
          if (assessCompleted.adhd.indicators >= 3 && bigFive.O > 60) insights.push({ icon: 'ðŸ’¡', text: 'High openness + ADHD traits may fuel creative bursts' });
          if (assessCompleted.adhd.indicators >= 3 && bigFive.E > 60) insights.push({ icon: 'ðŸŽª', text: 'ADHD + extraversion often creates an energetic, entertaining presence' });
          if (assessCompleted.adhd.indicators < 2 && bigFive.C > 70) insights.push({ icon: 'ðŸ“‹', text: 'Low ADHD indicators + high conscientiousness = natural ability to stay focused and organized' });
        }
        // Cognitive/ND combinations
        if (assessCompleted.cognitive && hasBigFive) {
          if (assessCompleted.cognitive.score > 60 && bigFive.C > 60) insights.push({ icon: 'ðŸ§©', text: 'ND traits + conscientiousness = detail-oriented systematic thinker' });
          if (assessCompleted.cognitive.score > 60 && bigFive.O > 60) insights.push({ icon: 'ðŸ”®', text: 'ND traits + openness can create unique, unconventional perspectives' });
          if (assessCompleted.cognitive.score > 50 && bigFive.A < 40) insights.push({ icon: 'ðŸ”¬', text: 'ND traits + low agreeableness may mean you prioritize truth over social harmony' });
        }
        // Cross-assessment combinations
        if (assessCompleted.adhd && assessCompleted.attachment) {
          if (assessCompleted.adhd.indicators >= 3 && assessCompleted.attachment.style === 'Anxious') insights.push({ icon: 'ðŸŒªï¸', text: 'ADHD + anxious attachment can intensify emotional experiences in relationships' });
        }
        if (assessCompleted.cognitive && assessCompleted.risk) {
          if (assessCompleted.cognitive.score > 60 && assessCompleted.risk.score > 60) insights.push({ icon: 'ðŸŽ²', text: 'ND traits + high risk tolerance may lead to unconventional life choices' });
        }
        // Big Five internal patterns
        if (hasBigFive) {
          if (bigFive.E > 60 && bigFive.A > 60) insights.push({ icon: 'â˜€ï¸', text: 'High extraversion + agreeableness = warm, approachable social presence' });
          if (bigFive.N > 60 && bigFive.O > 60) insights.push({ icon: 'ðŸŽ¨', text: 'Emotional depth + openness often fuels artistic or creative expression' });
          if (bigFive.C > 70 && bigFive.N < 40) insights.push({ icon: 'âš“', text: 'High conscientiousness + emotional stability = calm under pressure' });
          if (bigFive.E < 40 && bigFive.O > 60) insights.push({ icon: 'ðŸ“š', text: 'Introversion + openness suggests rich inner life and deep interests' });
        }
        // Integrity combinations
        if (assessCompleted.integrity) {
          const integ = assessCompleted.integrity.score;
          if (integ > 70 && assessCompleted.risk?.score > 60) insights.push({ icon: 'âš”ï¸', text: 'The Bold Truth-Teller: High integrity + risk tolerance = you speak unpopular truths without fear' });
          if (integ > 70 && hasBigFive && bigFive.A > 60) insights.push({ icon: 'ðŸ•Šï¸', text: 'High integrity + agreeableness = you build trust through authentic kindness' });
          if (integ < 40 && hasBigFive && bigFive.E > 60) insights.push({ icon: 'ðŸŽ­', text: 'Social charisma + flexible ethics may help you navigate complex social situations' });
        }
        // Shadow Self combinations
        const shadowM = assessCompleted['shadow-M']?.score;
        const shadowN = assessCompleted['shadow-N']?.score;
        const shadowP = assessCompleted['shadow-P']?.score;
        if (shadowM !== undefined) {
          if (shadowM > 70 && assessCompleted.attachment?.style === 'Secure') insights.push({ icon: 'ðŸ›¡ï¸', text: 'The Protective Strategist: Strategic mind + secure attachment = you use tactics to protect your inner circle' });
          if (shadowM > 70 && hasBigFive && bigFive.C > 60) insights.push({ icon: 'â™Ÿï¸', text: 'Strategic thinking + conscientiousness = patient, long-term planner' });
        }
        if (shadowN !== undefined) {
          if (shadowN > 70 && hasBigFive && bigFive.E > 60) insights.push({ icon: 'ðŸ‘‘', text: 'High self-regard + extraversion = natural performer who commands attention' });
          if (shadowN > 70 && assessCompleted.risk?.score > 60) insights.push({ icon: 'ðŸš€', text: 'Confidence + risk tolerance = bold moves driven by self-belief' });
        }
        if (shadowP !== undefined) {
          if (shadowP > 60 && hasBigFive && bigFive.N < 40) insights.push({ icon: 'ðŸ§Š', text: 'Emotional detachment + stability = calm decision-maker in crisis situations' });
          if (shadowP > 60 && assessCompleted.cognitive?.score > 60) insights.push({ icon: 'ðŸ”¬', text: 'Cold Focus + ND traits = analytical mind unswayed by emotional noise' });
        }
        // Fuller Picture archetypes
        if (assessCompleted.cognitive?.score > 60 && assessCompleted.adhd?.indicators >= 3) {
          insights.push({ icon: 'âš¡', text: 'The Rapid Prototyper: High-bandwidth mind that solves complex problems in creative bursts' });
        }
        if (assessCompleted.integrity?.score > 70 && shadowM > 60) {
          insights.push({ icon: 'ðŸŽ¯', text: 'The Principled Strategist: Strong ethics guide your tactical decisions' });
        }

        // Extended triangulation patterns
        // Three-way combinations
        if (assessCompleted.adhd?.indicators >= 3 && hasBigFive && bigFive.O > 60 && assessCompleted.cognitive?.score > 50) {
          insights.push({ icon: 'ðŸŒ€', text: 'The Creative Maverick: Your divergent thinking, curiosity, and high-bandwidth processing create unconventional solutions others miss' });
        }
        if (hasBigFive && bigFive.E < 40 && bigFive.C > 70 && assessCompleted.integrity?.score > 70) {
          insights.push({ icon: 'ðŸ¦‰', text: 'The Quiet Guardian: Reserved demeanor masks deep reliability and unwavering principles' });
        }
        if (shadowN > 60 && assessCompleted.attachment?.style === 'Anxious' && hasBigFive && bigFive.E > 60) {
          insights.push({ icon: 'ðŸŽª', text: 'The Performer: You crave both spotlight and reassuranceâ€”success validates, but approval sustains' });
        }
        if (hasBigFive && bigFive.A > 70 && bigFive.N < 40 && assessCompleted.attachment?.style === 'Secure') {
          insights.push({ icon: 'ðŸŒŠ', text: 'The Steady Anchor: Calm, caring presence that others naturally lean on in turbulent times' });
        }
        if (shadowM > 60 && shadowP > 50 && hasBigFive && bigFive.C > 60) {
          insights.push({ icon: 'ðŸŽ­', text: 'The Calculated Player: Strategic detachment + discipline = you execute complex plans without emotional interference' });
        }
        if (assessCompleted.risk?.score > 70 && assessCompleted.adhd?.indicators >= 3 && hasBigFive && bigFive.N < 40) {
          insights.push({ icon: 'ðŸ„', text: 'The Thrill Architect: High risk tolerance + impulsivity + emotional stability = you thrive in chaos others avoid' });
        }
        if (assessCompleted.integrity?.score > 70 && assessCompleted.attachment?.style === 'Secure' && hasBigFive && bigFive.A > 60) {
          insights.push({ icon: 'ðŸ›ï¸', text: 'The Trust Builder: Authentic, secure, and kindâ€”you create psychological safety for those around you' });
        }

        // More two-way deep combinations
        if (hasBigFive && bigFive.N > 70 && bigFive.O > 70) {
          insights.push({ icon: 'ðŸŒ™', text: 'The Sensitive Visionary: Emotional intensity fuels rich imaginationâ€”depth is your superpower and burden' });
        }
        if (hasBigFive && bigFive.C < 30 && bigFive.O > 70) {
          insights.push({ icon: 'ðŸ¦‹', text: 'The Free Spirit: Structure feels suffocating; you bloom in open-ended creative exploration' });
        }
        if (assessCompleted.attachment?.style === 'Avoidant' && shadowP > 50) {
          insights.push({ icon: 'ðŸ”ï¸', text: 'The Lone Wolf: Independence isn\'t preferenceâ€”it\'s how you process the world most effectively' });
        }
        if (assessCompleted.cognitive?.score > 70 && hasBigFive && bigFive.A < 40) {
          insights.push({ icon: 'âš–ï¸', text: 'The Truth Seeker: ND traits + directness = you prioritize accuracy over social comfort' });
        }
        if (shadowN < 30 && hasBigFive && bigFive.A > 70) {
          insights.push({ icon: 'ðŸ•Šï¸', text: 'The Humble Helper: Low ego + high agreeableness = you genuinely elevate others without seeking credit' });
        }
        if (assessCompleted.risk?.score < 30 && hasBigFive && bigFive.N > 60) {
          insights.push({ icon: 'ðŸ¢', text: 'The Careful Navigator: Your caution isn\'t timidityâ€”it\'s wisdom born from emotional awareness' });
        }
        if (assessCompleted.integrity?.score < 40 && assessCompleted.risk?.score > 70) {
          insights.push({ icon: 'ðŸƒ', text: 'The Wild Card: Flexible ethics + high risk tolerance = you play by your own rules' });
        }
        if (hasBigFive && bigFive.E > 70 && bigFive.N > 60 && assessCompleted.attachment?.style === 'Anxious') {
          insights.push({ icon: 'ðŸŽ ', text: 'The Social Chameleon: You energize rooms but secretly wonder if they\'d notice if you left' });
        }

        // Chronotype combinations
        if (assessCompleted.chronotype) {
          const chrono = assessCompleted.chronotype;
          if (chrono.type === 'Morning Lark' && hasBigFive && bigFive.C > 60) {
            insights.push({ icon: 'ðŸŒ…', text: 'The Early Achiever: Morning energy + conscientiousness = you conquer your day before others wake' });
          }
          if (chrono.type === 'Night Owl' && hasBigFive && bigFive.O > 60) {
            insights.push({ icon: 'ðŸŒ™', text: 'The Midnight Muse: Night energy + openness = creative breakthroughs in the quiet hours' });
          }
          if (chrono.type === 'Night Owl' && assessCompleted.adhd?.indicators >= 3) {
            insights.push({ icon: 'ðŸ¦‡', text: 'The Night Rider: ADHD + night owl = your brain comes alive when the world goes quiet' });
          }
          if (chrono.type === 'Morning Lark' && assessCompleted.integrity?.score > 70) {
            insights.push({ icon: 'ðŸ“', text: 'The Disciplined Dawn: Early riser + high integrity = you do the right thing before anyone\'s watching' });
          }
        }

        return insights;
      };
      const insights = getInsights();

      // Collapsible Analysis Card component
      const AnalysisCard = ({ id, icon, title, subtitle, color, isComplete, progress = 0, children, compactContent }) => {
        const isExpanded = analysisExpanded[id];
        // Derived from ASSESS_COLORS
        const colorStyles = Object.fromEntries(ASSESS_COLORS.map(c => {
          const t = twColor(c);
          return [c, {
            bg: darkMode ? `bg-${t}-900/20 border-${t}-500/30` : `bg-${t}-50 border-${t}-200`,
            text: `text-${t}-400`,
            bar: `bg-${t}-500`
          }];
        }));
        const cs = colorStyles[color] || colorStyles.violet;
        return (
          <div className={`rounded-xl border overflow-hidden ${cs.bg}`}>
            <button onClick={() => setAnalysisExpanded(prev => ({ ...prev, [id]: !prev[id] }))}
              className={`w-full p-4 flex items-center gap-3 text-left hover-glow hover-glow-${color}`}>
              <ProgressCircle
                progress={isComplete ? 100 : progress}
                size={48}
                strokeWidth={3}
                color={color}
                icon={isComplete ? 'âœ“' : icon}
                gradientId={`analysis-${id}`}
                darkMode={darkMode}
                iconSize="text-lg"
              />
              <div className="flex-1 min-w-0">
                <div className={`font-semibold ${TH('text-primary', darkMode)}`}>{title}</div>
                <div className={`text-xs ${TH('text-subtle', darkMode)}`}>{subtitle}</div>
              </div>
              {isComplete && !isExpanded && compactContent}
              <span className={`text-sm transition-transform ${isExpanded ? 'rotate-180' : ''} ${TH('text-dim', darkMode)}`}>â–¼</span>
            </button>
            {isExpanded && (
              <div className={`px-4 pb-4 border-t ${darkMode ? 'border-gray-800' : 'border-gray-200'}`}>
                <div className="pt-4">{children}</div>
              </div>
            )}
          </div>
        );
      };

      // Trait descriptions for expanded view
      const traitDescriptions = {
        E: { name: 'Extraversion', low: 'Reserved', high: 'Outgoing', desc: s => s > 60 ? 'You energize in social settings and enjoy being around people.' : s < 40 ? 'You recharge through solitude and prefer deeper one-on-one connections.' : 'You balance social and solo time comfortably.' },
        A: { name: 'Agreeableness', low: 'Analytical', high: 'Empathetic', desc: s => s > 60 ? 'You prioritize harmony and naturally consider others\' feelings.' : s < 40 ? 'You value directness and truth over diplomatic softening.' : 'You balance compassion with objectivity.' },
        C: { name: 'Conscientiousness', low: 'Flexible', high: 'Organized', desc: s => s > 60 ? 'You thrive with structure, planning, and follow-through.' : s < 40 ? 'You prefer spontaneity and adapt quickly to change.' : 'You balance planning with adaptability.' },
        N: { name: 'Neuroticism', low: 'Calm', high: 'Sensitive', desc: s => s > 60 ? 'You experience emotions intensely and are highly attuned to your inner world.' : s < 40 ? 'You stay steady under pressure and recover quickly from setbacks.' : 'You have moderate emotional reactivity.' },
        O: { name: 'Openness', low: 'Practical', high: 'Curious', desc: s => s > 60 ? 'You seek novelty, abstract ideas, and creative exploration.' : s < 40 ? 'You prefer proven, concrete approaches and practical solutions.' : 'You balance tradition with exploration.' },
      };
      const shadowDescriptions = {
        M: { name: 'Strategic Mind', desc: s => s > 60 ? 'High tactical awarenessâ€”you naturally read situations and plan accordingly.' : s < 40 ? 'Straightforward approachâ€”you prefer transparency over strategy.' : 'Situational tacticianâ€”you flex between direct and strategic.' },
        N: { name: 'Self-Image', desc: s => s > 60 ? 'Strong self-regardâ€”you\'re confident in your abilities and value recognition.' : s < 40 ? 'Humble presenceâ€”you prefer to elevate others over yourself.' : 'Healthy self-regardâ€”balanced confidence without ego.' },
        P: { name: 'Cold Focus', desc: s => s > 60 ? 'Cool under pressureâ€”you make decisions based on logic, not feelings.' : s < 40 ? 'Deeply empatheticâ€”you feel others\' emotions strongly.' : 'Emotionally balancedâ€”you blend logic with emotional awareness.' },
      };

      return (
        <div className={`h-full flex flex-col ${TH('bg-main', darkMode)}`}>
          <div className={`h-[44px] flex-shrink-0 flex items-center px-4 border-b ${TH('border-base', darkMode)}`}>
            <button onClick={() => onNavigate('assess-picker')} className={`text-lg ${TH('text-dim', darkMode)}`}>â†</button>
            <span className={`flex-1 text-center font-medium ${TH('text-primary', darkMode)}`}>Analysis</span>
            <div className="w-6" />
          </div>
          <div className="flex-1 overflow-auto p-4 pb-8 hide-scrollbar">

            {/* Layer 2: Insight gating â€” encouragement when < 2 categories done */}
            {getCompletedCategoryCount(assessCompleted, entityType) < 2 && (
              <div className="flex flex-col items-center justify-center py-12 px-4 text-center">
                <div className="mb-4">
                  <AuraVisualization onboardingAnswers={onboardingAnswers} assessCompleted={assessCompleted}
                    entityType={entityType} darkMode={darkMode} size={200} />
                </div>
                <h3 className={`text-lg font-semibold mb-2 ${TH('text-primary', darkMode)}`}>Your profile is growing</h3>
                <p className={`text-sm mb-4 ${TH('text-subtle', darkMode)}`}>
                  Complete {2 - getCompletedCategoryCount(assessCompleted, entityType)} more {getCompletedCategoryCount(assessCompleted, entityType) === 1 ? 'assessment' : 'assessments'} to unlock your full analysis.
                </p>
                <div className={`w-48 h-2 rounded-full mb-3 ${darkMode ? 'bg-white/[0.08]' : 'bg-gray-200'}`}>
                  <div className="h-full rounded-full bg-violet-500 transition-all" style={{ width: `${(getCompletedCategoryCount(assessCompleted, entityType) / 2) * 100}%` }} />
                </div>
                <span className={`text-xs mb-6 ${TH('text-dim', darkMode)}`}>{getCompletedCategoryCount(assessCompleted, entityType)} of 2 needed</span>
                <button onClick={() => onNavigate('assess-picker')}
                  className="px-6 py-2.5 rounded-xl text-sm font-medium bg-violet-600 text-white hover:bg-violet-500">
                  Continue Assessments â†’
                </button>
              </div>
            )}

            {getCompletedCategoryCount(assessCompleted, entityType) >= 2 && (<>
            {/* Aura Visualization â€” organism floats free */}
            <div className="mb-3">
              <AuraVisualization onboardingAnswers={onboardingAnswers} assessCompleted={assessCompleted}
                entityType={entityType} darkMode={darkMode} size={360} />
            </div>

            {/* Archetype Header + Share â€” Hero reveal */}
            {(() => {
              const archetype = calculateArchetype(assessCompleted);
              if (!archetype?.primary) return null;
              const { name, tagline, color } = archetype.primary;
              const colorClass = twColor(color);
              const handleShare = async (e) => {
                e.stopPropagation();
                const url = 'https://aura-player-one.vercel.app';
                if (navigator.share) {
                  try { await navigator.share({ title: 'My Aura', text: `I'm ${name} â€” discover your aura`, url }); } catch (_) {}
                } else {
                  try { await navigator.clipboard.writeText(url); } catch (_) {}
                  setShareCopied(true);
                  setTimeout(() => setShareCopied(false), 2000);
                }
              };
              return (
                <div className="mb-5 text-center">
                  <div className={`text-xs font-semibold tracking-widest uppercase mb-2 ${darkMode ? `text-${colorClass}-500` : `text-${colorClass}-400`}`}>Your archetype</div>
                  <div className={`text-3xl font-bold mb-2 ${darkMode ? `text-${colorClass}-200` : `text-${colorClass}-800`}`}>{name}</div>
                  <p className={`text-sm italic leading-relaxed px-6 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>{tagline}</p>
                  {archetype.secondary?.length > 0 && (
                    <div className="flex flex-wrap gap-1.5 justify-center mt-3">
                      {archetype.secondary.map(a => (
                        <span key={a.name} className={`text-xs px-2.5 py-1 rounded-full ${darkMode ? 'bg-white/[0.06] text-gray-400' : 'bg-black/[0.05] text-gray-500'}`}>{a.name}</span>
                      ))}
                    </div>
                  )}
                  <button onClick={handleShare}
                    className={`mt-4 inline-flex items-center gap-2 px-5 py-2.5 rounded-full text-sm font-medium transition-all ${shareCopied ? (darkMode ? 'bg-emerald-900/40 text-emerald-300' : 'bg-emerald-50 text-emerald-700') : (darkMode ? `bg-${colorClass}-900/40 text-${colorClass}-300 hover:bg-${colorClass}-900/70` : `bg-${colorClass}-50 text-${colorClass}-700 hover:bg-${colorClass}-100`)}`}>
                    {shareCopied ? 'âœ“ Link copied' : 'â†— Share your aura'}
                  </button>
                </div>
              );
            })()}

            {/* Trait Hints - Progressive reveal of personality insights */}
            {(() => {
              const hints = [];
              // Generate hints from Quick Profile or Big Five results
              const qp = quickProfileComplete;
              const summary = qp ? getQuickProfileSummary() : null;
              const traits = summary?.traits || {};

              // Add hints based on strongest traits
              if (traits.O > 60) hints.push({ color: 'violet', text: 'Strong curiosity', subtitle: 'You seek out new ideas and experiences' });
              if (traits.A > 60) hints.push({ color: 'emerald', text: 'Natural warmth', subtitle: 'Others feel at ease around you' });
              if (traits.N < 40) hints.push({ color: 'pink', text: 'Steady under pressure', subtitle: 'You stay calm when things get intense' });
              if (traits.E < 40 && traits.O > 50) hints.push({ color: 'cyan', text: 'Rich inner world', subtitle: 'Deep thought over broad socializing' });
              if (traits.E > 60) hints.push({ color: 'amber', text: 'Social energy', subtitle: 'You energize in group settings' });
              if (traits.C > 60) hints.push({ color: 'teal', text: 'Natural organizer', subtitle: 'You thrive with structure and follow-through' });

              // Add hints from Big Five if available
              if (bigFive.O > 60 && !traits.O) hints.push({ color: 'violet', text: 'Strong curiosity', subtitle: 'Open to new ideas and experiences' });
              if (bigFive.A > 60 && !traits.A) hints.push({ color: 'emerald', text: 'Natural warmth', subtitle: 'Empathetic and considerate' });
              if (bigFive.N < 40 && traits.N === undefined) hints.push({ color: 'pink', text: 'Emotionally stable', subtitle: 'Composed under pressure' });
              if (bigFive.E > 60 && !traits.E) hints.push({ color: 'amber', text: 'Outgoing nature', subtitle: 'Energized by social interaction' });
              if (bigFive.C > 60 && !traits.C) hints.push({ color: 'teal', text: 'Disciplined approach', subtitle: 'Organized and reliable' });

              // Add hints from other assessments
              if (assessCompleted.attachment?.style === 'Secure') hints.push({ color: 'emerald', text: 'Secure attachment', subtitle: 'Comfortable with intimacy and independence' });
              if (assessCompleted.chronotype?.type === 'Night Owl') hints.push({ color: 'indigo', text: 'Night owl', subtitle: 'Your best hours are after dark' });
              if (assessCompleted.chronotype?.type === 'Morning Lark') hints.push({ color: 'amber', text: 'Early riser', subtitle: 'You conquer mornings' });

              if (hints.length === 0) return null;

              return (
                <div className="mb-4 space-y-2">
                  {hints.slice(0, 4).map((h, i) => (
                    <HintCard key={i} color={h.color} text={h.text} subtitle={h.subtitle} darkMode={darkMode} />
                  ))}
                </div>
              );
            })()}

            {/* Quick Profile - Compact summary, tap to expand */}
            {quickProfileComplete && (() => {
              const summary = getQuickProfileSummary();
              const isExpanded = analysisExpanded['quick-profile'];
              return (
                <button
                  onClick={() => setAnalysisExpanded(prev => ({ ...prev, 'quick-profile': !prev['quick-profile'] }))}
                  className={`mb-4 p-3 rounded-xl w-full text-left ${darkMode ? 'bg-gradient-to-br from-blue-950/50 to-indigo-950/50 border border-blue-800/30' : 'bg-blue-50 border border-blue-200'}`}
                >
                  <div className="flex items-center gap-3">
                    <ProgressCircle progress={100} size={40} strokeWidth={3} color="blue" icon="âœ¨" gradientId="analysis-qp" darkMode={darkMode} iconSize="text-base" />
                    <div className="flex-1 min-w-0">
                      <div className={`text-sm font-semibold ${TH('text-primary', darkMode)}`}>Quick Profile</div>
                      <p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'} ${isExpanded ? '' : 'truncate'}`}>{summary?.summary}</p>
                    </div>
                    <span className={`text-xs ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>{isExpanded ? 'âˆ§' : 'âˆ¨'}</span>
                  </div>
                </button>
              );
            })()}

            {/* Completed Assessments - Collapsible category groups */}
            {currentTier >= 1 && (() => {
              // Spectrum descriptors instead of raw percentages
              const getResultLabel = (id, result) => {
                // Non-percentage results - keep as-is
                if (result.style) return result.style;
                if (result.type) return result.type;
                if (result.indicators !== undefined) return result.indicators >= 4 ? 'High' : result.indicators >= 2 ? 'Moderate' : 'Low';
                if (result.level) return result.level;

                // Percentage-based continuums - use descriptive labels
                const s = result.score;
                if (s === undefined) return 'âœ“';

                // Trait-specific descriptors for Big Five
                const traitDescriptors = {
                  'bigfive-E': s > 65 ? 'Outgoing' : s < 35 ? 'Reserved' : 'Balanced',
                  'bigfive-A': s > 65 ? 'Empathetic' : s < 35 ? 'Direct' : 'Balanced',
                  'bigfive-C': s > 65 ? 'Organized' : s < 35 ? 'Flexible' : 'Balanced',
                  'bigfive-N': s > 65 ? 'Sensitive' : s < 35 ? 'Steady' : 'Balanced',
                  'bigfive-O': s > 65 ? 'Curious' : s < 35 ? 'Practical' : 'Balanced',
                  'shadow-M': s > 65 ? 'Strategic' : s < 35 ? 'Straightforward' : 'Situational',
                  'shadow-N': s > 65 ? 'Confident' : s < 35 ? 'Humble' : 'Grounded',
                  'shadow-P': s > 65 ? 'Detached' : s < 35 ? 'Empathic' : 'Balanced',
                  'integrity': s > 65 ? 'Strong' : s < 35 ? 'Flexible' : 'Moderate',
                  'risk': s > 65 ? 'Bold' : s < 35 ? 'Cautious' : 'Balanced',
                  'cognitive': s > 65 ? 'High ND' : s < 35 ? 'Low ND' : 'Some traits',
                };
                if (traitDescriptors[id]) return traitDescriptors[id];

                // Reasoning tests - performance based
                if (id.startsWith('reasoning')) return s >= 80 ? 'Strong' : s >= 50 ? 'Solid' : 'Growing';

                // Default for starter pack etc - just show checkmark, tap for details
                return 'âœ“';
              };

              // Horseshoe gauge - U shape with gap at bottom, glowing dot indicator
              const SemiGauge = ({ value, testId, size = 32 }) => {
                const spec = spectrumColors[testId] || { left: '#6b7280', right: '#8b5cf6' };
                const gradId = `horse-${testId}-${size}-${Math.random().toString(36).substr(2,5)}`;
                const strokeWidth = Math.max(3, size / 10);
                const r = (size / 2) - (strokeWidth / 2) - 2;
                const cx = size / 2;
                const cy = size / 2;

                // U-shape: gap at bottom, arc spans ~280Â° (leaving ~80Â° gap)
                // Left arm starts at about 140Â°, right arm ends at about 40Â°
                // In SVG: 0Â°=right, 90Â°=down, 180Â°=left, 270Â°=up
                const gapAngle = 80; // degrees of gap at bottom
                const leftStart = 90 + (gapAngle / 2);  // 130Â° - left arm bottom
                const rightEnd = 90 - (gapAngle / 2);   // 50Â° - right arm bottom

                const toXY = (deg) => ({
                  x: cx + r * Math.cos(deg * Math.PI / 180),
                  y: cy + r * Math.sin(deg * Math.PI / 180)
                });

                const pStart = toXY(leftStart);
                const pEnd = toXY(rightEnd);

                // Value maps from left (0%) to right (100%)
                // Going from leftStart (130Â°) counter-clockwise through top to rightEnd (50Â°)
                // That's 130Â° -> 180Â° -> 270Â° -> 360Â° -> 50Â° = 280Â° total arc
                // For CCW: subtract from start angle, but handle wrap
                const arcSpan = 360 - gapAngle; // 280Â°
                // 0% = leftStart (130Â°), 100% = rightEnd (50Â°, or 130Â° - 280Â° = -150Â° = 210Â°... wait)
                // Let's go simpler: 0% is at 130Â°, 100% is at 50Â° (going the short way CCW would be wrong)
                // Going CCW from 130Â°: 130 -> 90 -> 50 is only 80Â° (the gap!)
                // Going CW from 130Â°: 130 -> 180 -> 270 -> 360 -> 50 is 280Â° (the arc!)
                // So we go CLOCKWISE from leftStart to rightEnd
                // value 0% = 130Â° (left), value 100% = 130Â° + 280Â° = 410Â° = 50Â° (right)
                const dotDeg = leftStart + (value / 100) * arcSpan;
                const dotAngle = dotDeg > 360 ? dotDeg - 360 : dotDeg;
                const dot = toXY(dotAngle);
                const dotSize = Math.max(5, strokeWidth * 1.5);

                // Color interpolation
                const t = value / 100;
                const dotColor = t > 0.5 ? spec.right : spec.left;

                return (
                  <svg width={size} height={size} viewBox={`0 0 ${size} ${size}`} style={{ overflow: 'visible' }}>
                    <defs>
                      <linearGradient id={gradId} x1="0%" y1="0%" x2="100%" y2="0%">
                        <stop offset="0%" stopColor={spec.left} />
                        <stop offset="100%" stopColor={spec.right} />
                      </linearGradient>
                    </defs>
                    {/* Arc: from left arm to right arm, going UP and over (clockwise in SVG) */}
                    {/* large-arc-flag=1 (take the long way), sweep-flag=1 (clockwise) */}
                    <path
                      d={`M ${pStart.x} ${pStart.y} A ${r} ${r} 0 1 1 ${pEnd.x} ${pEnd.y}`}
                      fill="none"
                      stroke={`url(#${gradId})`}
                      strokeWidth={strokeWidth}
                      strokeLinecap="round"
                    />
                    {/* Glowing dot on the arc */}
                    <circle cx={dot.x} cy={dot.y} r={dotSize} fill={dotColor} opacity="0.4" />
                    <circle cx={dot.x} cy={dot.y} r={dotSize / 2 + 0.5} fill={dotColor} stroke="white" strokeWidth="1.5" strokeOpacity="0.9" />
                  </svg>
                );
              };

              // Define category groups
              const categoryGroups = [
                { id: 'starter', name: 'Starter Pack', icon: 'ðŸš€', color: 'indigo', tests: ['starter-personality', 'starter-motivation', 'starter-thinking', 'starter-connection', 'starter-strategy'], minTier: 1 },
                { id: 'personality', name: 'Personality', icon: 'ðŸŽ­', color: 'rose', tests: ['bigfive-E', 'bigfive-A', 'bigfive-C', 'bigfive-N', 'bigfive-O'], minTier: 2 },
                { id: 'shadow', name: 'Shadow Self', icon: 'ðŸŒ‘', color: 'slate', tests: ['shadow-M', 'shadow-N', 'shadow-P'], minTier: 2 },
                { id: 'mind', name: 'Mind', icon: 'ðŸ§ ', color: 'blue', tests: ['adhd', 'cognitive', 'chronotype', 'reasoning', 'reasoning-2', 'reasoning-3'], minTier: 2 },
                { id: 'relationships', name: 'Relationships', icon: 'ðŸ’š', color: 'pink', tests: ['attachment'], minTier: 2 },
                { id: 'character', name: 'Character', icon: 'ðŸ’Ž', color: 'emerald', tests: ['integrity'], minTier: 2 },
                { id: 'behavior', name: 'Behavior', icon: 'ðŸŽ²', color: 'amber', tests: ['risk'], minTier: 2 },
              ];

              // Filter to groups with at least one completed test
              const groupsWithData = categoryGroups
                .filter(g => currentTier >= g.minTier)
                .map(g => {
                  const completedTests = g.tests.filter(id => assessCompleted[id] && ASSESS_TESTS[id]);
                  const avgScore = completedTests.length > 0
                    ? Math.round(completedTests.reduce((sum, id) => sum + (assessCompleted[id]?.score || 0), 0) / completedTests.length)
                    : 0;
                  return { ...g, completedTests, avgScore };
                })
                .filter(g => g.completedTests.length > 0);

              const CollapsibleGroup = ({ group }) => {
                const isExpanded = analysisExpanded[group.id];
                const colors = getAssessColor(group.color, darkMode);
                const summary = group.completedTests.length === group.tests.length
                  ? 'Complete'
                  : `${group.completedTests.length}/${group.tests.length}`;

                // Check if this group has spectrum-based scores (continuums)
                const hasSpectrumScores = group.completedTests.some(id => spectrumColors[id] && assessCompleted[id]?.score !== undefined);

                return (
                  <div className={`rounded-xl overflow-hidden ${TH('bg-card', darkMode)}`}>
                    <button
                      onClick={() => setAnalysisExpanded(prev => ({ ...prev, [group.id]: !prev[group.id] }))}
                      className={`w-full px-3 py-2.5 flex items-center gap-3`}
                    >
                      <ProgressCircle
                        progress={(group.completedTests.length / group.tests.length) * 100}
                        size={36} strokeWidth={3} color={group.color} icon={group.icon}
                        gradientId={`analysis-grp-${group.id}`} darkMode={darkMode} iconSize="text-sm"
                      />
                      <span className={`flex-1 text-left text-sm font-medium ${TH('text-primary', darkMode)}`}>{group.name}</span>
                      {/* Trait dots in collapsed header â€” one per scored trait */}
                      {!isExpanded && hasSpectrumScores && (
                        <div className="flex items-center gap-1.5 mr-1">
                          {group.completedTests.slice(0, 6).map(id => {
                            const result = assessCompleted[id];
                            const spec = spectrumColors[id];
                            if (!spec || result?.score === undefined) return null;
                            const t = result.score / 100;
                            const dotColor = t > 0.5 ? spec.right : spec.left;
                            return (
                              <div key={id} className="rounded-full" style={{
                                width: 8, height: 8, background: dotColor,
                                boxShadow: darkMode ? `0 0 6px ${dotColor}60` : 'none',
                              }} />
                            );
                          })}
                        </div>
                      )}
                      {!hasSpectrumScores && <span className={`text-xs ${colors.text} mr-1`}>{summary}</span>}
                      <span className={`text-xs transition-transform ${isExpanded ? 'rotate-180' : ''} ${TH('text-dim', darkMode)}`}>â–¼</span>
                    </button>
                    {isExpanded && (
                      <div className={`border-t ${darkMode ? 'border-gray-800/50' : 'border-gray-200'} p-3 space-y-4`}>
                        {group.completedTests.map((id) => {
                          const test = ASSESS_TESTS[id];
                          const result = assessCompleted[id];
                          const testColors = getAssessColor(test.color, darkMode);
                          const hasSpectrum = spectrumColors[id] && result?.score !== undefined;
                          const spec = spectrumColors[id] || { left: '#6b7280', right: '#8b5cf6', leftLabel: '', rightLabel: '' };
                          const colorClass = group.color === 'slate' ? 'slate' : group.color === 'violet' ? 'violet' : group.color;

                          if (hasSpectrum) {
                            // Full gradient + white dot style â€” spectrum position, not a grade
                            const leanLabel = result.score >= 50 ? spec.rightLabel : spec.leftLabel;
                            return (
                              <button key={id} onClick={() => onNavigate('assess-results', { testId: id })}
                                className="w-full text-left space-y-1">
                                <div className="flex justify-between items-baseline">
                                  <span className={`text-sm font-medium ${darkMode ? `text-${colorClass}-400` : `text-${colorClass}-600`}`}>{test.name}</span>
                                  <span className={`text-xs ${TH('text-dim', darkMode)}`}>{leanLabel}</span>
                                </div>
                                <div className="h-3 rounded-full relative" style={{ background: `linear-gradient(to right, ${spec.left}, ${spec.right})` }}>
                                  <div
                                    className="absolute top-1/2 -translate-y-1/2 w-4 h-4 rounded-full bg-white"
                                    style={{
                                      left: `${Math.max(5, Math.min(95, result.score))}%`,
                                      marginLeft: -8,
                                      boxShadow: '0 1px 3px rgba(0,0,0,0.25)'
                                    }}
                                  />
                                </div>
                                <div className="flex justify-between">
                                  <span className={`text-xs ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>{spec.leftLabel}</span>
                                  <span className={`text-xs ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>{spec.rightLabel}</span>
                                </div>
                              </button>
                            );
                          }

                          // Non-spectrum tests: simple row
                          return (
                            <button key={id} onClick={() => onNavigate('assess-results', { testId: id })}
                              className="w-full flex items-center gap-2">
                              <span className="text-sm">{test.icon}</span>
                              <span className={`flex-1 text-left text-xs ${TH('text-secondary', darkMode)}`}>{test.name}</span>
                              <span className={`text-xs font-medium ${testColors.text}`}>{getResultLabel(id, result)}</span>
                            </button>
                          );
                        })}
                        {group.tests.length > group.completedTests.length && (
                          <div className={`text-xs text-center ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>
                            {group.tests.length - group.completedTests.length} more to complete {group.name}
                          </div>
                        )}
                      </div>
                    )}
                  </div>
                );
              };

              return groupsWithData.length > 0 ? (
                <div className="space-y-2">
                  {groupsWithData.map(group => (
                    <CollapsibleGroup key={group.id} group={group} />
                  ))}
                </div>
              ) : null;
            })()}

            {/* CTA for incomplete users */}
            {currentTier < 2 && (
              <button onClick={() => onNavigate('assess-picker')} className={`mt-4 w-full py-3 rounded-xl text-sm font-medium ${darkMode ? 'bg-indigo-600 hover:bg-indigo-500 text-white' : 'bg-indigo-500 hover:bg-indigo-600 text-white'}`}>
                {currentTier === 1 ? 'Continue Starter Pack â†’' : 'Start Assessments â†’'}
              </button>
            )}

            {/* Archetype Strengths & Tips */}
            {(() => {
              const archetype = calculateArchetype(assessCompleted);
              if (!archetype?.primary) return null;
              const { strengths, watchOuts, tips, color } = archetype.primary;
              const colorClass = twColor(color);
              return (
                <div className={`mt-4 p-4 rounded-xl ${darkMode ? 'bg-gray-900/30 border border-gray-800/30' : 'bg-gray-50 border border-gray-200'}`}>
                  {strengths?.length > 0 && (
                    <div className="mb-3">
                      <h4 className={`text-xs font-semibold uppercase tracking-wide mb-2 ${darkMode ? `text-${colorClass}-400` : `text-${colorClass}-600`}`}>ðŸ’ª Strengths</h4>
                      <ul className="space-y-1">
                        {strengths.slice(0, 3).map((s, i) => (
                          <li key={i} className={`text-xs ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>â€¢ {s}</li>
                        ))}
                      </ul>
                    </div>
                  )}
                  {watchOuts?.length > 0 && (
                    <div className="mb-3">
                      <h4 className={`text-xs font-semibold uppercase tracking-wide mb-2 ${darkMode ? 'text-amber-400' : 'text-amber-600'}`}>âš¡ Watch For</h4>
                      <ul className="space-y-1">
                        {watchOuts.slice(0, 2).map((w, i) => (
                          <li key={i} className={`text-xs ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>â€¢ {w}</li>
                        ))}
                      </ul>
                    </div>
                  )}
                  {tips?.length > 0 && (
                    <div>
                      <h4 className={`text-xs font-semibold uppercase tracking-wide mb-2 ${darkMode ? 'text-teal-400' : 'text-teal-600'}`}>ðŸ’¡ Tips</h4>
                      <ul className="space-y-1">
                        {tips.slice(0, 3).map((t, i) => (
                          <li key={i} className={`text-xs ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>â€¢ {t}</li>
                        ))}
                      </ul>
                    </div>
                  )}
                </div>
              );
            })()}

            {/* Meta Analysis - Shows connections between completed assessments */}
            {insights.length > 0 && (
              <div className={`mt-4 p-4 rounded-xl ${darkMode ? 'bg-gradient-to-br from-violet-950/30 to-purple-950/30 border border-violet-800/20' : 'bg-violet-50 border border-violet-200'}`}>
                <h3 className={`text-sm font-semibold flex items-center gap-2 mb-3 ${TH('text-primary', darkMode)}`}>âœ¨ Insights</h3>
                <div className="space-y-2">
                  {insights.slice(0, 5).map((ins, i) => (
                    <div key={i} className="flex items-start gap-2">
                      <span className="text-base">{ins.icon}</span>
                      <p className={`text-xs leading-relaxed flex-1 ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>{ins.text}</p>
                    </div>
                  ))}
                </div>
              </div>
            )}

            {/* AI Personality Profile â€” shown when entityType === 'ai' and enough tests completed */}
            {entityType === 'ai' && Object.keys(assessCompleted).length >= 3 && (() => {
              const aiInsights = generateAIInsights(assessCompleted);
              return (
                <div className={`mt-4 p-4 rounded-xl ${darkMode ? 'bg-gradient-to-br from-cyan-950/30 to-teal-950/30 border border-cyan-800/20' : 'bg-cyan-50 border border-cyan-200'}`}>
                  <h3 className={`text-sm font-semibold flex items-center gap-2 mb-3 ${darkMode ? 'text-cyan-300' : 'text-cyan-700'}`}>ðŸ¤– AI Personality Profile</h3>
                  {aiInsights.authentic.length > 0 && (
                    <div className="mb-3">
                      <div className={`text-xs font-medium mb-1.5 ${darkMode ? 'text-cyan-400' : 'text-cyan-600'}`}>Authentic Dimensions</div>
                      <div className="space-y-1.5">
                        {aiInsights.authentic.map((d, i) => (
                          <div key={i} className="flex items-start gap-2">
                            <span className={`text-xs font-medium w-20 shrink-0 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>{d.trait}</span>
                            {d.score !== null && <div className="flex-1 h-2 rounded-full mt-1" style={{ background: `linear-gradient(to right, ${darkMode ? '#164e63' : '#cffafe'}, ${darkMode ? '#06b6d4' : '#0891b2'})` }}><div className={`h-full rounded-full ${darkMode ? 'bg-cyan-400' : 'bg-cyan-600'}`} style={{ width: `${d.score}%` }} /></div>}
                            <span className={`text-[10px] w-8 text-right ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>{d.score !== null ? `${d.score}%` : 'â€”'}</span>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}
                  {aiInsights.structural.length > 0 && (
                    <div className="mb-3">
                      <div className={`text-xs font-medium mb-1.5 ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>Structural Artifacts</div>
                      <div className="space-y-1">
                        {aiInsights.structural.map((d, i) => (
                          <div key={i} className={`text-xs ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>
                            <span className="font-medium">{d.trait}:</span> {d.note}
                          </div>
                        ))}
                      </div>
                    </div>
                  )}
                  {aiInsights.aiSpecific.length > 0 && (
                    <div>
                      <div className={`text-xs font-medium mb-1.5 ${darkMode ? 'text-teal-400' : 'text-teal-600'}`}>AI-Specific Observations</div>
                      <div className="space-y-1">
                        {aiInsights.aiSpecific.map((d, i) => (
                          <div key={i} className={`text-xs ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>
                            <span className="font-medium">{d.label}:</span> {d.text}
                          </div>
                        ))}
                      </div>
                    </div>
                  )}
                </div>
              );
            })()}

            {/* Locked teasers for tier < 2 */}
            {currentTier < 2 && (
              <div className="mt-4 space-y-2">
                <div className={`text-xs font-medium uppercase tracking-wide px-1 ${TH('text-dim', darkMode)}`}>
                  Coming soon
                </div>
                <div className={`rounded-xl overflow-hidden ${TH('bg-card', darkMode)} opacity-50`}>
                  {[
                    { icon: 'ðŸŽ­', name: 'Personality' },
                    { icon: 'ðŸ§ ', name: 'Mind' },
                    { icon: 'ðŸŒ‘', name: 'Shadow Self' },
                  ].map((item, idx) => (
                    <div key={item.name} className={`px-3 py-2.5 flex items-center gap-3 ${idx > 0 ? (darkMode ? 'border-t border-gray-800/50' : 'border-t border-gray-200') : ''}`}>
                      <div className={`w-9 h-9 rounded-full flex items-center justify-center ${darkMode ? 'bg-white/[0.06]' : 'bg-gray-200'}`}>
                        <span className="text-sm">{item.icon}</span>
                      </div>
                      <span className={`flex-1 text-sm ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>{item.name}</span>
                      <span className="text-xs">ðŸ”’</span>
                    </div>
                  ))}
                </div>
              </div>
            )}
            </>)}
          </div>
        </div>
      );
};

// ==================== QUESTION FLOW SCREEN ====================
const QuestionFlowScreen = ({
  darkMode, currentQuestion, currentIndex, questions, responses,
  currentResults, communityResults, setCommunityResults,
  isAnswered, isBinary, answeredCount, totalQuestions,
  currentResponse, swipeHandlers, mcColorMode, setMcColorMode,
  pendingSubmit, undoDelay, handleUndo, goToPrev, goToNext,
  findNextUnanswered, setCurrentIndex, selectedTrack, setSelectedTrack,
  showSavedToast, sessionAnsweredIds, questionFlags, answerExplanations,
  evidenceExpanded, setEvidenceExpanded, justUndone, clearUndoneState,
  showTips, showGestureHint, setShowGestureHint,
  showConfirmOverlay, confirmColor, tappedAnswer, setTappedAnswer,
  tapCount, setTapCount, submitAnswer, handleAnswerTap, handleAnswerRightClick,
  savedQuestions, saveForLater, skipQuestion,
  showFullResults, setShowFullResults,
  showQuestionFlagModal, setShowQuestionFlagModal,
  showExplanationModal, setShowExplanationModal,
  showCantAnswerModal, setShowCantAnswerModal,
  showNoneOptionModal, setShowNoneOptionModal,
  handleQuestionFlag, handleClearQuestionFlag,
  handleSaveExplanation, handleClearExplanation,
  setQuestionFlags, setSkippedQuestions,
  communityBrowseIndex, setCommunityBrowseIndex,
  communityDisplayMode, setCommunityDisplayMode,
  communityExpanded, setCommunityExpanded,
  assessCompleted,
}) => {
  if (!currentQuestion) return (
    <div className={`flex-1 flex items-center justify-center ${TH('text-primary', darkMode)}`}>
      <div className="text-center p-8"><div className="text-4xl mb-4">ðŸŽ‰</div><div className="text-xl font-medium mb-2">All done!</div></div>
    </div>
  );

  const progress = totalQuestions > 0 ? answeredCount / totalQuestions : 0;
  const hasNext = findNextUnanswered(currentIndex) !== null || currentIndex < questions.length - 1;

  // Generate results for current question if answered but no results yet
  const currentQuestionResults = currentResults || (isAnswered ? generateFakeResults(currentQuestion) : null);
  if (isAnswered && !currentResults) {
    setCommunityResults(prev => ({ ...prev, [currentQuestion.id]: currentQuestionResults }));
  }

  return (
    <div
      className="flex-1 flex flex-col overflow-hidden relative"
      {...swipeHandlers}
    >
      {/* Dev: MC color mode toggle â€” floating outside app UI */}
      {!isBinary && (
        <div className="fixed top-2 right-2 z-[9999]" style={{ pointerEvents: 'auto' }}>
          <div className="flex rounded-lg overflow-hidden shadow-lg" style={{
            background: 'rgba(0,0,0,0.75)', backdropFilter: 'blur(8px)', WebkitBackdropFilter: 'blur(8px)',
            border: '1px solid rgba(255,255,255,0.1)',
          }}>
            {['color', 'gray'].map(m => (
              <button key={m} onClick={() => setMcColorMode(m)}
                className="px-3 py-1.5 text-xs font-medium transition-colors"
                style={{
                  color: mcColorMode === m ? '#fff' : '#6b7280',
                  background: mcColorMode === m ? 'rgba(255,255,255,0.12)' : 'transparent',
                }}
              >{m === 'color' ? 'Colored' : 'Gray'}</button>
            ))}
          </div>
        </div>
      )}
      {/* Breathing ambient aura â€” dual-layer, onboarding-style */}
      {(() => {
        const catColorMap = { prediction: 'amber', reasoning: 'violet', judgment: 'teal' };
        const catSecondary = { prediction: 'rose', reasoning: 'blue', judgment: 'cyan' };
        const c0 = COLOR_HEX[catColorMap[currentQuestion?.category]] || COLOR_HEX.violet;
        const c1 = COLOR_HEX[catSecondary[currentQuestion?.category]] || COLOR_HEX.blue;
        return (
          <div className="absolute inset-0 flex items-center justify-center pointer-events-none">
            <div style={{
              position: 'absolute', width: 420, height: 420, borderRadius: '50%',
              background: darkMode
                ? `radial-gradient(circle, rgba(${c0.rgb},0.14) 0%, rgba(${c0.rgb},0.06) 35%, transparent 65%)`
                : `radial-gradient(circle, rgba(${c0.rgb},0.10) 0%, rgba(${c0.rgb},0.04) 35%, transparent 65%)`,
              animation: 'aura-breathe 8s ease-in-out infinite',
            }} />
            <div style={{
              position: 'absolute', width: 350, height: 350, borderRadius: '50%',
              background: darkMode
                ? `radial-gradient(circle, rgba(${c1.rgb},0.10) 0%, rgba(${c1.rgb},0.04) 40%, transparent 65%)`
                : `radial-gradient(circle, rgba(${c1.rgb},0.08) 0%, rgba(${c1.rgb},0.03) 40%, transparent 65%)`,
              animation: 'aura-breathe 6s ease-in-out infinite 1s',
            }} />
          </div>
        );
      })()}
      {/* Saved for later â€” mid-screen pop-up */}
      {showSavedToast && (
        <div className="absolute inset-0 flex items-center justify-center z-40 pointer-events-none">
          <div className={`px-6 py-4 rounded-2xl flex flex-col items-center gap-1 ${darkMode ? 'bg-gray-800/90' : 'bg-white/90'} shadow-xl`}
            style={{ backdropFilter: 'blur(8px)', WebkitBackdropFilter: 'blur(8px)', animation: 'fadeSlideIn 0.3s ease forwards' }}>
            <span className="text-3xl">âœ“</span>
            <span className={`text-sm font-medium ${TH('text-primary', darkMode)}`}>Saved for later</span>
          </div>
        </div>
      )}
      {/* Circle Track Selector - remaining counts by type */}
      <div className={`h-[68px] flex-shrink-0 flex items-center gap-3 px-3 relative z-10 ${darkMode ? 'bg-gray-900/50' : 'bg-white/90'}`}
        style={{
          borderBottom: (() => {
            const catColorMap = { prediction: 'amber', reasoning: 'violet', judgment: 'teal' };
            const qColor = COLOR_HEX[catColorMap[currentQuestion?.category]] || COLOR_HEX.violet;
            return darkMode
              ? `1px solid rgba(${qColor.rgb},0.15)`
              : `1px solid rgba(${qColor.rgb},0.20)`;
          })()
        }}>
        <button
          onClick={goToPrev}
          disabled={currentIndex === 0}
          className={`text-xl font-bold w-8 h-8 flex items-center justify-center ${
            currentIndex === 0
              ? (darkMode ? 'text-gray-700' : 'text-gray-300')
              : (darkMode ? 'text-gray-300 active:text-white' : 'text-gray-600 active:text-gray-900')
          }`}
        >
          â—€
        </button>
        {(() => {
          const ynCount = questions.filter(q => q.type === 'binary' && !responses[q.id]).length;
          const mcCount = questions.filter(q => q.type === 'multiple' && !responses[q.id]).length;
          const allCount = ynCount + mcCount;

          const switchTrack = (newTrack) => {
            const toggledTrack = selectedTrack === newTrack ? null : newTrack;
            setSelectedTrack(toggledTrack);
            if (toggledTrack && currentQuestion?.type !== toggledTrack) {
              const matchIdx = questions.findIndex(q => q.type === toggledTrack && !responses[q.id]);
              if (matchIdx >= 0) setCurrentIndex(matchIdx);
            }
          };

          return (
            <div className="flex-1 flex items-center justify-center gap-3">
              {/* Binary (Y/N) circle - green/red */}
              <div
                className={`q-circle q-circle-binary ${selectedTrack === 'binary' ? 'q-circle-current' : 'q-circle-adjacent'}`}
                onClick={() => switchTrack('binary')}
                style={{ cursor: 'pointer' }}
              >
                <div className={`q-circle-inner ${darkMode ? 'bg-gray-950 text-white' : 'bg-white text-gray-900'}`}>
                  {ynCount > 0 ? 'Y/N' : 'âœ“'}
                </div>
              </div>
              {/* MC circle - 5 colors */}
              <div
                className={`q-circle q-circle-mc ${selectedTrack === 'multiple' ? 'q-circle-current' : 'q-circle-adjacent'}`}
                onClick={() => switchTrack('multiple')}
                style={{ cursor: 'pointer' }}
              >
                <div className={`q-circle-inner ${darkMode ? 'bg-gray-950 text-white' : 'bg-white text-gray-900'}`}>
                  {mcCount > 0 ? 'ABC' : 'âœ“'}
                </div>
              </div>
              {/* All/Combined circle - white/silver */}
              <div
                className={`q-circle q-circle-mixed ${!selectedTrack ? 'q-circle-current' : 'q-circle-adjacent'}`}
                onClick={() => switchTrack(null)}
                style={{ cursor: 'pointer' }}
              >
                <div className={`q-circle-inner ${darkMode ? 'bg-gray-950 text-white' : 'bg-white text-gray-900'}`}>
                  {allCount > 0 ? 'Mix' : 'âœ“'}
                </div>
              </div>
            </div>
          );
        })()}
        <button
          onClick={goToNext}
          disabled={!hasNext}
          className={`text-xl font-bold w-8 h-8 flex items-center justify-center ${
            !hasNext
              ? (darkMode ? 'text-gray-700' : 'text-gray-300')
              : (darkMode ? 'text-gray-300 active:text-white' : 'text-gray-600 active:text-gray-900')
          }`}
        >
          â–¶
        </button>
      </div>

      {/* ANSWERED QUESTION VIEW - shows full results (only for questions answered THIS session) */}
      {isAnswered && !pendingSubmit && sessionAnsweredIds.has(currentQuestion.id) ? (
        <AnsweredQuestionView
          question={currentQuestion}
          response={currentResponse}
          results={currentQuestionResults}
          darkMode={darkMode}
          questionFlag={questionFlags[currentQuestion.id]}
          explanation={answerExplanations[currentQuestion.id]}
          onFlagClick={() => setShowQuestionFlagModal(currentQuestion.id)}
          onExplainClick={() => setShowExplanationModal(currentQuestion.id)}
        />
      ) : isAnswered && !pendingSubmit ? (
        /* Previously answered question - show empty space to maintain layout */
        <div className="flex-1 flex flex-col">
          <div className="flex-1" /> {/* Empty space */}
          <div className={`flex-shrink-0 px-4 py-6 ${darkMode ? 'bg-white/[0.02]' : 'bg-black/[0.02]'}`}>
            <div className={`text-center text-sm ${TH('text-faint', darkMode)}`}>
              Already answered Â· Use arrows to navigate
            </div>
          </div>
        </div>
      ) : (
        <>
          {/* QUESTION AREA - centered in available space, never scrolls */}
          <div className="flex-1 flex flex-col justify-center px-4 pb-3 overflow-hidden min-h-0 relative">
            <QuestionCard
              question={currentQuestion}
              darkMode={darkMode}
              evidenceExpanded={evidenceExpanded}
              onToggleEvidence={() => setEvidenceExpanded(!evidenceExpanded)}
            />
            {/* Onboarding hint for early questions */}
            {answeredCount < 3 && !isAnswered && (
              <div className={`text-center mt-3 text-xs ${darkMode ? 'text-gray-600' : 'text-gray-400'}`}>
                {answeredCount === 0 ? "we'll start easy â€” just tap what feels right" : 'tap more for higher confidence'}
              </div>
            )}

            {/* === OVERLAYS â€” float at bottom of question zone, ABOVE the answer buttons === */}
            {/* These are absolute so they NEVER push buttons. Prime Directive. */}

            {/* Undone banner */}
            {justUndone && (
              <div className="absolute bottom-14 left-0 right-0 z-20 px-0">
                <div className={`rounded-xl px-4 py-2 flex items-center justify-between ${darkMode ? 'bg-amber-500/15 border border-amber-500/50' : 'bg-amber-100 border border-amber-300'}`}
                  style={{ backdropFilter: 'blur(12px)', WebkitBackdropFilter: 'blur(12px)' }}>
                  <span className={`text-sm font-bold ${darkMode ? 'text-amber-400' : 'text-amber-700'}`}>
                    Undone â€” tap to change or resubmit
                  </span>
                  <button
                    onClick={clearUndoneState}
                    className={`px-3 py-1 rounded-lg text-sm font-medium transition-colors ${
                      darkMode ? 'bg-white/[0.06] text-gray-300 hover:bg-white/[0.10]' : 'bg-white text-gray-700 hover:bg-gray-50 border border-gray-200'
                    }`}
                  >
                    Clear
                  </button>
                </div>
              </div>
            )}

            {/* Tip banner â€” auto-hides once user taps an answer */}
            {showTips && showGestureHint && !isAnswered && !pendingSubmit && !justUndone && tappedAnswer === null && (
              <div className="absolute bottom-1 left-0 right-0 z-20 px-0">
                <TipBanner darkMode={darkMode} onDismiss={() => setShowGestureHint(false)} />
              </div>
            )}

            {/* Confirm/Cancel â€” appears when answer tapped, needs confirmation */}
            {showConfirmOverlay && (
              <div className="absolute bottom-1 left-0 right-0 z-20 flex items-center justify-center gap-3">
                <button
                  onClick={() => { setTappedAnswer(null); setTapCount(0); }}
                  className={`w-9 h-9 rounded-full btn-feedback flex items-center justify-center text-sm transition-all ${
                    darkMode ? 'text-gray-400 border border-white/[0.08]' : 'text-gray-500 border border-gray-200'
                  }`}
                  style={{ background: darkMode ? 'rgba(255,255,255,0.04)' : 'rgba(0,0,0,0.03)' }}
                >âœ•</button>
                <button
                  onClick={() => submitAnswer(tappedAnswer, tapCount)}
                  className="w-11 h-11 rounded-full btn-feedback flex items-center justify-center text-lg transition-all"
                  style={{
                    color: darkMode ? '#fff' : confirmColor?.base,
                    background: darkMode
                      ? `linear-gradient(135deg, rgba(${confirmColor?.rgb},0.30) 0%, rgba(${confirmColor?.rgb},0.15) 100%)`
                      : `linear-gradient(135deg, rgba(${confirmColor?.rgb},0.20) 0%, rgba(${confirmColor?.rgb},0.08) 100%)`,
                    border: `1px solid rgba(${confirmColor?.rgb}, 0.50)`,
                    boxShadow: `0 0 18px rgba(${confirmColor?.rgb},0.25), 0 0 40px rgba(${confirmColor?.rgb},0.12)`,
                  }}
                >âœ“</button>
              </div>
            )}
          </div>

          {/* FIXED BOTTOM AREA - answer zones */}
          <div className="flex-shrink-0 border-t relative z-10"
            style={(() => {
              const catColorMap = { prediction: 'amber', reasoning: 'violet', judgment: 'teal' };
              const qColor = COLOR_HEX[catColorMap[currentQuestion?.category]] || COLOR_HEX.violet;
              return darkMode
                ? { borderColor: `rgba(${qColor.rgb},0.12)`, background: `linear-gradient(180deg, rgba(3,7,18,1) 0%, rgba(${qColor.rgb},0.04) 100%)` }
                : { borderColor: `rgba(${qColor.rgb},0.15)`, background: `linear-gradient(180deg, rgba(255,255,255,1) 0%, rgba(${qColor.rgb},0.04) 100%)` };
            })()}>

            {/* Answer zone wrapper â€” FIXED position, nothing above can push these */}
            <div className="relative">
              {/* ZONE 1: Answer Buttons */}
              <div className="relative px-4 resp-px pt-3">
                <div className={pendingSubmit ? 'opacity-60 pointer-events-none' : ''}>
                  {isBinary ? (
                    <BinaryButtons
                      darkMode={darkMode}
                      tappedAnswer={tappedAnswer}
                      tapCount={tapCount}
                      isAnswered={isAnswered}
                      currentResponse={currentResponse}
                      onTap={handleAnswerTap}
                      onRightClick={handleAnswerRightClick}
                      pendingSubmit={pendingSubmit}
                      category={currentQuestion?.category}
                    />
                  ) : (
                    <MCButtons
                      options={currentQuestion.options}
                      darkMode={darkMode}
                      tappedAnswer={tappedAnswer}
                      tapCount={tapCount}
                      isAnswered={isAnswered}
                      currentResponse={currentResponse}
                      onTap={handleAnswerTap}
                      onRightClick={handleAnswerRightClick}
                      pendingSubmit={pendingSubmit}
                      mcColorMode={mcColorMode}
                    />
                  )}
                </div>
                {/* Undo toast â€” overlays the answer buttons */}
                {pendingSubmit && (() => {
                  const undoColor = isBinary
                    ? (pendingSubmit.answer === 0 ? { rgb: '16,185,129', hex: '#10b981' } : { rgb: '239,68,68', hex: '#ef4444' })
                    : { rgb: MC_COLORS[pendingSubmit.answer % MC_COLORS.length]?.rgb || '139,92,246', hex: MC_COLORS[pendingSubmit.answer % MC_COLORS.length]?.hex || '#8b5cf6' };
                  const answerLabel = isBinary
                    ? (pendingSubmit.answer === 0 ? 'YES' : 'NO')
                    : `${String.fromCharCode(65 + pendingSubmit.answer)}. ${currentQuestion?.options?.[pendingSubmit.answer] || ''}`;
                  return (
                    <div className="absolute inset-0 flex items-center justify-center z-10 px-4">
                      <div
                        onClick={handleUndo}
                        className="cursor-pointer rounded-xl px-4 py-2.5 flex items-center gap-3 w-full max-w-sm"
                        style={{
                          background: darkMode
                            ? `rgba(${undoColor.rgb}, 0.15)`
                            : `rgba(${undoColor.rgb}, 0.12)`,
                          border: `1px solid ${darkMode ? `rgba(${undoColor.rgb}, 0.5)` : `rgba(${undoColor.rgb}, 0.35)`}`,
                          backdropFilter: 'blur(8px)',
                          WebkitBackdropFilter: 'blur(8px)',
                        }}
                      >
                        <div className="flex-shrink-0 w-7 h-7 relative">
                          <svg viewBox="0 0 28 28" className="w-7 h-7 -rotate-90">
                            <circle cx="14" cy="14" r="12" fill="none" stroke={darkMode ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.08)'} strokeWidth="2.5" />
                            <circle cx="14" cy="14" r="12" fill="none" stroke={undoColor.hex} strokeWidth="2.5"
                              strokeDasharray="75.4"
                              strokeDashoffset="0"
                              style={{ animation: `ringCountdown ${undoDelay}s linear forwards` }}
                            />
                          </svg>
                        </div>
                        <div className="flex-1 min-w-0">
                          <div className={`text-sm font-semibold truncate ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                            {answerLabel}
                          </div>
                        </div>
                        <button
                          onClick={(e) => { e.stopPropagation(); handleUndo(); }}
                          className="flex-shrink-0 px-3.5 py-1.5 rounded-lg text-sm font-bold transition-colors"
                          style={{
                            background: darkMode ? `rgba(${undoColor.rgb}, 0.3)` : `rgba(${undoColor.rgb}, 0.2)`,
                            color: undoColor.hex,
                          }}
                        >
                          Undo
                        </button>
                      </div>
                    </div>
                  );
                })()}
              </div>

              {/* Action buttons row â€” always rendered, invisible during pending to preserve layout */}
              <div className={`relative px-4 mt-3 mb-2 flex items-center justify-center resp-max-w mx-auto ${(isAnswered || pendingSubmit) ? 'invisible' : ''}`}>
                <div className="flex gap-2 w-full">
                  {[
                    { label: isBinary ? "Can't" : "None", onClick: () => isBinary ? setShowCantAnswerModal(currentQuestion?.id) : setShowNoneOptionModal(true), active: false },
                    { label: 'Explain', onClick: () => setShowExplanationModal(currentQuestion?.id), active: !!answerExplanations[currentQuestion?.id], activeColor: COLOR_HEX.amber },
                    { label: 'Skip', onClick: skipQuestion, active: false },
                    { label: savedQuestions.has(currentQuestion?.id) ? 'âœ“ Saved' : 'Save', onClick: saveForLater, active: savedQuestions.has(currentQuestion?.id), activeColor: COLOR_HEX.violet },
                  ].map(btn => (
                    <button
                      key={btn.label}
                      onClick={btn.onClick}
                      disabled={isAnswered || !!pendingSubmit}
                      className="flex-1 resp-h-sm rounded-xl resp-text-sm font-medium transition-all btn-feedback border"
                      style={btn.active ? {
                        borderColor: `rgba(${btn.activeColor.rgb}, ${darkMode ? 0.30 : 0.40})`,
                        background: darkMode
                          ? `rgba(${btn.activeColor.rgb}, 0.08)`
                          : `rgba(${btn.activeColor.rgb}, 0.10)`,
                        color: darkMode ? btn.activeColor.light : btn.activeColor.base,
                      } : {
                        borderColor: darkMode ? 'rgba(255,255,255,0.06)' : 'rgba(0,0,0,0.10)',
                        background: darkMode ? 'rgba(255,255,255,0.03)' : 'rgba(0,0,0,0.04)',
                        color: darkMode ? '#6b7280' : '#6b7280',
                      }}
                    >
                      {btn.label}
                    </button>
                  ))}
                </div>
              </div>
            </div>

            {/* ZONE 3: Community Browse (unlocks at tier 2: 3+ assessments) */}
            <div className="px-4 pb-3 pt-1">
              {(() => {
                // Gate behind feature tier 2
                if (getFeatureTier(assessCompleted || {}, false) < 2) return null;
                // Only show community results after user has answered the current question
                const currentIsAnswered = currentQuestion && responses[currentQuestion.id];

                // Get list of answered questions with results, sorted by answer time (most recent first)
                const answeredList = questions
                  .filter(q => responses[q.id] && communityResults[q.id])
                  .sort((a, b) => (responses[b.id]?.timestamp || 0) - (responses[a.id]?.timestamp || 0));
                if (answeredList.length === 0 || !currentIsAnswered) {
                  return (
                    <div className={`h-full flex items-center justify-center text-sm ${TH('text-faint', darkMode)}`}>
                      Swipe for next â†’
                    </div>
                  );
                }
                const safeIdx = Math.min(communityBrowseIndex, answeredList.length - 1);
                const browseQ = answeredList[safeIdx];
                const browseResponse = responses[browseQ.id];
                const browseResults = communityResults[browseQ.id];

                // Get user's answer display
                const isBinaryQ = browseQ.type === 'binary';
                const userAnswer = browseResponse?.answer;
                const userAnswerText = isBinaryQ
                  ? (userAnswer === 0 ? 'YES' : 'NO')
                  : (browseQ.options?.[userAnswer] || '?');
                const userAnswerColor = isBinaryQ
                  ? (userAnswer === 0 ? 'text-emerald-400' : 'text-rose-400')
                  : 'text-violet-400';

                // Hidden mode - just a thin expandable line with + button
                if (communityDisplayMode === 'hidden') {
                  return (
                    <div className="flex items-center justify-center gap-2" onClick={() => { if (pendingSubmit) handleUndo(); }}>
                      <div className={`flex-1 h-px ${TH('bg-elevated', darkMode)}`} />
                      <button
                        onClick={() => { if (pendingSubmit) { handleUndo(); return; } setCommunityDisplayMode('compact'); }}
                        className={`w-8 h-8 rounded-full flex items-center justify-center text-lg font-light ${
                          darkMode ? 'bg-white/[0.06] text-gray-400 hover:bg-white/[0.10]' : 'bg-gray-200 text-gray-500 hover:bg-gray-300'
                        } transition-colors`}
                      >+</button>
                      <div className={`flex-1 h-px ${TH('bg-elevated', darkMode)}`} />
                    </div>
                  );
                }

                // Compact mode with confidence-segmented bars
                // Use aggregateResults for all aggregation (includeUserInCount=false to show community stats)
                const { rows: aggRows, total, maxCount, userConf } = aggregateResults(browseResults?.evaluators, browseQ, browseResponse, false);

                return (
                  <div
                    className="relative"
                    onTouchStart={(e) => { e.stopPropagation(); e.currentTarget.dataset.touchX = e.touches[0].clientX; }}
                    onTouchEnd={(e) => {
                      e.stopPropagation();
                      // During pending submit (non-grace), any touch should undo
                      if (pendingSubmit) {
                        handleUndo();
                        return;
                      }
                      const startX = parseFloat(e.currentTarget.dataset.touchX);
                      const endX = e.changedTouches[0].clientX;
                      const diff = endX - startX;
                      if (Math.abs(diff) > 50) {
                        if (diff > 0 && safeIdx > 0) setCommunityBrowseIndex(safeIdx - 1);
                        else if (diff < 0 && safeIdx < answeredList.length - 1) setCommunityBrowseIndex(safeIdx + 1);
                      }
                    }}
                    onClick={() => {
                      // During pending submit (non-grace), any click should undo
                      if (pendingSubmit) {
                        handleUndo();
                      }
                    }}
                  >
                    {/* Header with LAST and hide button - clickable to expand */}
                    <div
                      className="flex items-center gap-1 mb-1 cursor-pointer"
                      onClick={() => {
                        if (pendingSubmit) { handleUndo(); return; }
                        setCommunityExpanded(true);
                      }}
                    >
                      <span className={`text-base truncate flex-1 font-medium ${TH('text-bright', darkMode)}`}>{browseQ.text}</span>
                      <button
                        onClick={(e) => { e.stopPropagation(); if (pendingSubmit) { handleUndo(); return; } setCommunityDisplayMode('hidden'); }}
                        className={`w-5 h-5 rounded flex items-center justify-center text-sm shrink-0 ${
                          darkMode ? 'text-gray-500 hover:text-gray-300' : 'text-gray-400 hover:text-gray-600'
                        }`}
                      >âˆ’</button>
                    </div>

                    {/* Content - clickable to expand */}
                    <div
                      className="cursor-pointer"
                      onClick={() => {
                        if (pendingSubmit) { handleUndo(); return; }
                        setCommunityExpanded(true);
                      }}
                    >
                      {isBinaryQ ? (() => {
                        // Use pre-aggregated rows, sorted by pct
                        const rows = [...aggRows].sort((a, b) => b.pct - a.pct);
                        return (
                          <div className="space-y-1">
                            {rows.map(row => (
                              <div key={row.label} className="flex items-center gap-1">
                                <div className="w-14 sm:w-12 flex-shrink-0">
                                  <span className={`text-base sm:text-sm font-semibold px-2 py-0.5 rounded-full ${row.isUser ? 'border-2' : ''}`} style={{ color: row.colors[1], borderColor: row.isUser ? row.colors[1] : 'transparent' }}>{row.label}</span>
                                </div>
                                <span className="text-base sm:text-sm w-8 sm:w-7 font-bold text-right" style={{ color: row.colors[1] }}>{row.pct}</span>
                                {renderConfidenceBar(row.byConf, row.colors, maxCount, row.isUser, userConf, 'h-5', darkMode)}
                              </div>
                            ))}
                            <div className={`text-sm text-center pt-1 ${TH('text-subtle', darkMode)}`}>Tap to Expand</div>
                          </div>
                        );
                      })() : (() => {
                        /* MC: show user's pick + top pick, tap to expand all */
                        // Use pre-aggregated rows
                        const sorted = [...aggRows].sort((a, b) => b.count - a.count);
                        const topRow = sorted[0];
                        const secondRow = sorted[1];
                        const userRow = aggRows.find(r => r.isUser);
                        const otherRow = userRow === topRow ? secondRow : topRow;

                        const renderRow = (row) => {
                          if (!row) return null;
                          return (
                            <div key={row.answer} className="flex items-center gap-1">
                              <div style={{ width: '40%' }} className="flex-shrink-0">
                                <span className={`text-base sm:text-sm font-semibold inline-block truncate max-w-full px-2 py-0.5 rounded-full ${row.isUser ? 'border-2' : ''}`} style={{ color: row.colors[1], borderColor: row.isUser ? row.colors[1] : 'transparent' }}>{row.label}</span>
                              </div>
                              <span className="text-base sm:text-sm w-8 sm:w-7 font-bold text-right" style={{ color: row.colors[1] }}>{row.pct}</span>
                              {renderConfidenceBar(row.byConf, row.colors, maxCount, row.isUser, userConf, 'h-5', darkMode)}
                            </div>
                          );
                        };

                        const rowsOrdered = (userRow?.pct || 0) >= (otherRow?.pct || 0)
                          ? [userRow, otherRow]
                          : [otherRow, userRow];

                        return (
                          <div className="space-y-1">
                            {rowsOrdered.filter(Boolean).map(renderRow)}
                            <div className={`text-sm text-center pt-1 ${TH('text-subtle', darkMode)}`}>Tap to Expand</div>
                          </div>
                        );
                      })()}
                    </div>
                    <div
                      className={`h-px mt-2 cursor-pointer ${darkMode ? 'bg-gray-700' : 'bg-gray-300'}`}
                      onClick={() => {
                        if (pendingSubmit) { handleUndo(); return; }
                        setCommunityExpanded(true);
                      }}
                    />

                    {/* Expanded slide-up panel */}
                    {communityExpanded && (() => {
                      // Use pre-aggregated rows
                      const allRows = [...aggRows].sort((a, b) => b.pct - a.pct);

                      return (
                        <div
                          className="fixed inset-0 z-50"
                          onClick={() => setCommunityExpanded(false)}
                        >
                          {/* Slide-up panel - click anywhere closes */}
                          <div
                            className={`absolute bottom-0 left-0 right-0 rounded-t-2xl backdrop-blur-xl ${darkMode ? 'bg-gray-950/90 border-t border-x border-white/[0.08]' : 'bg-white/95'} shadow-2xl`}
                            style={{ animation: 'slideUp 0.2s ease-out' }}
                          >
                            {/* Header - full question text in expanded view */}
                            <div className="px-4 pt-3 pb-1">
                              <div className="flex items-center gap-2 mb-1">
                                <span className={`text-sm font-black uppercase tracking-wide ${TH('text-sky', darkMode)}`}>LAST:</span>
                                <span className={`text-sm ${TH('text-subtle', darkMode)}`}>{total.toLocaleString()} responses</span>
                              </div>
                              <p className={`text-base font-medium ${TH('text-bright', darkMode)}`}>{browseQ.text}</p>
                            </div>

                            {/* All rows - same format as compact */}
                            <div className="px-4 pb-4 pt-2 space-y-1">
                              {allRows.map((row, i) => (
                                <div key={i} className="flex items-center gap-1">
                                  <div className={isBinaryQ ? 'w-14 sm:w-12' : 'w-[40%]'} style={{ flexShrink: 0 }}>
                                    <span className={`text-base sm:text-sm font-semibold inline-block truncate max-w-full px-2 py-0.5 rounded-full ${row.isUser ? 'border-2' : ''}`}
                                      style={{ color: row.colors[1], borderColor: row.isUser ? row.colors[1] : 'transparent' }}>
                                      {row.label}
                                    </span>
                                  </div>
                                  <span className="text-base sm:text-sm w-8 sm:w-7 font-bold text-right" style={{ color: row.colors[1] }}>{row.pct}</span>
                                  {renderConfidenceBar(row.byConf, row.colors, row.maxCount, row.isUser, userConf, 'h-5', darkMode)}
                                </div>
                              ))}
                            </div>

                            {/* Tap hint */}
                            <div className={`text-sm text-center pb-4 ${TH('text-faint', darkMode)}`}>
                              tap anywhere to close
                            </div>
                          </div>
                        </div>
                      );
                    })()}
                  </div>
                );
              })()}
            </div>
          </div>
        </>
      )}

      {/* Full Results Modal */}
      {showFullResults && (() => {
        const answeredList = questions
          .filter(q => responses[q.id] && communityResults[q.id])
          .sort((a, b) => (responses[b.id]?.timestamp || 0) - (responses[a.id]?.timestamp || 0));
        const currentIdx = answeredList.findIndex(q => q.id === showFullResults.question.id);
        const goTo = (idx) => {
          if (idx >= 0 && idx < answeredList.length) {
            const q = answeredList[idx];
            setShowFullResults({ question: q, results: communityResults[q.id], response: responses[q.id] });
          }
        };
        return (
          <FullResultsPanel
            question={showFullResults.question}
            results={showFullResults.results}
            userResponse={showFullResults.response}
            darkMode={darkMode}
            onClose={() => setShowFullResults(null)}
            onSwipeLeft={() => goTo(currentIdx + 1)}
            onSwipeRight={() => goTo(currentIdx - 1)}
            isLast={currentIdx === 0}
          />
        );
      })()}

      {/* Question Flag Modal */}
      {showQuestionFlagModal && (
        <QuestionFlagModal
          darkMode={darkMode}
          questionId={showQuestionFlagModal}
          onClose={() => setShowQuestionFlagModal(null)}
          onFlag={handleQuestionFlag}
          onClear={handleClearQuestionFlag}
          existingFlag={questionFlags[showQuestionFlagModal]}
        />
      )}

      {/* Explanation Modal */}
      {showExplanationModal && (
        <ExplanationModal
          darkMode={darkMode}
          questionId={showExplanationModal}
          onClose={() => setShowExplanationModal(null)}
          onSave={handleSaveExplanation}
          onClear={handleClearExplanation}
          existingExplanation={answerExplanations[showExplanationModal]}
          isAnswered={!!responses[showExplanationModal]}
        />
      )}

      {/* Can't Answer Modal (binary) */}
      {showCantAnswerModal && (
        <CantAnswerModal
          darkMode={darkMode}
          questionId={showCantAnswerModal}
          onClose={() => setShowCantAnswerModal(null)}
          onSkip={(qId, reason) => {
            setQuestionFlags(prev => ({ ...prev, [qId]: `Can't: ${reason}` }));
            setSkippedQuestions(prev => new Set([...prev, qId]));
            goToNext();
          }}
        />
      )}

      {/* None Option Modal (MC) */}
      {showNoneOptionModal && (
        <NoneOptionModal
          darkMode={darkMode}
          questionId={currentQuestion?.id}
          onClose={() => setShowNoneOptionModal(false)}
          onSubmit={(qId, answer) => {
            setQuestionFlags(prev => ({ ...prev, [qId]: `None fit: ${answer}` }));
            setSkippedQuestions(prev => new Set([...prev, qId]));
            goToNext();
          }}
        />
      )}
    </div>
  );
};

// ==================== MAIN APP ====================
// Helper to determine initial screen based on login state
// Check for public profile URL parameter
const getPublicProfileId = () => {
  try {
    const params = new URLSearchParams(window.location.search);
    return params.get('p') || null;
  } catch { return null; }
};

const getInitialScreen = () => {
  // Public profile link takes priority
  if (getPublicProfileId()) return 'public-profile';
  // ?c= (short link) or ?compare= (legacy) â†’ compare screen
  try {
    const params = new URLSearchParams(window.location.search);
    if (params.get('c') || params.get('compare')) return 'compare';
    // ?entity=ai â†’ silently set AI entity and proceed
    const entityParam = params.get('entity');
    if (entityParam === 'ai') {
      localStorage.setItem('aura-entity-declared', JSON.stringify({ type: 'ai', model: null, ts: Date.now() }));
      localStorage.setItem('aura_entity_context', JSON.stringify({ type: 'ai' }));
      window.history.replaceState({}, '', window.location.pathname);
    }
  } catch {}
  // Check Supabase auth session (stored in localStorage by Supabase client)
  const sbKey = Object.keys(localStorage).find(k => k.startsWith('sb-') && k.endsWith('-auth-token'));
  if (sbKey) {
    try {
      const session = JSON.parse(localStorage.getItem(sbKey));
      if (session?.user || session?.access_token) return 'assess-picker';
    } catch {}
  }
  const hasEmail = localStorage.getItem('aura_user_email');
  if (hasEmail) return 'categories';
  // Default to human if entity not declared (entity gate removed from default path)
  if (!localStorage.getItem('aura-entity-declared')) {
    localStorage.setItem('aura-entity-declared', JSON.stringify({ type: 'human', model: null, ts: Date.now() }));
    localStorage.setItem('aura_entity_context', JSON.stringify({ type: 'human' }));
  }
  return 'welcome';
};

// Dev panel only on local environments
const IS_DEV = ['localhost', '127.0.0.1', ''].includes(location.hostname) || location.protocol === 'file:';

// ==================== ERROR BOUNDARY ====================
class ErrorBoundary extends React.Component {
  constructor(props) { super(props); this.state = { hasError: false, error: null }; }
  static getDerivedStateFromError(error) { return { hasError: true, error }; }
  componentDidCatch(error, info) { console.error('[Aura] Component error:', error, info.componentStack); }
  render() {
    if (this.state.hasError) return (
      <div style={{ height: '100%', display: 'flex', alignItems: 'center', justifyContent: 'center', background: '#030712', color: '#fff', padding: '2rem', textAlign: 'center' }}>
        <div>
          <div style={{ fontSize: '2rem', marginBottom: '0.5rem' }}>Something went wrong</div>
          <div style={{ color: '#9ca3af', marginBottom: '1.5rem' }}>Aura hit an unexpected error.</div>
          <button onClick={() => { this.setState({ hasError: false, error: null }); }} style={{ padding: '0.75rem 1.5rem', borderRadius: '0.75rem', background: '#8b5cf6', color: '#fff', border: 'none', cursor: 'pointer', fontSize: '1rem' }}>Try Again</button>
          {IS_DEV && this.state.error && <pre style={{ marginTop: '1rem', fontSize: '0.75rem', color: '#f87171', textAlign: 'left', maxHeight: '200px', overflow: 'auto' }}>{this.state.error.toString()}</pre>}
        </div>
      </div>
    );
    return this.props.children;
  }
}

// --- useQotd Hook ---
const useQotd = () => {
  const [qotdData, setQotdData] = useState(() => getRandomQOTD());
  const [qotdResponse, setQotdResponse] = useState(null);
  const [qotdTappedAnswer, setQotdTappedAnswer] = useState(null);
  const [qotdTapCount, setQotdTapCount] = useState(0);

  const resetQotd = () => {
    setQotdData(getRandomQOTD());
    setQotdResponse(null);
    setQotdTappedAnswer(null);
    setQotdTapCount(0);
  };

  const handleQotdTap = (answer) => {
    if (qotdResponse) return;
    if (qotdTappedAnswer === answer) {
      setQotdTapCount(Math.min(4, qotdTapCount + 1));
    } else {
      setQotdTappedAnswer(answer);
      setQotdTapCount(1);
    }
  };

  const submitQotdAnswer = () => {
    if (qotdTappedAnswer === null) return;
    setQotdResponse({ answer: qotdTappedAnswer, confidence: qotdTapCount });
    setQotdTappedAnswer(null);
    setQotdTapCount(0);
  };

  return { qotdData, qotdResponse, setQotdResponse, qotdTappedAnswer, setQotdTappedAnswer, qotdTapCount, setQotdTapCount, resetQotd, handleQotdTap, submitQotdAnswer };
};

// --- useVerification Hook ---
const VERIFY_EXPERT_KEY = 'aura-verify-expert-v1';
const useVerification = () => {
  const verifyStored = useRef(verifyLoadFromStorage());
  const [verifyCurrentSubjectId, setVerifyCurrentSubjectId] = useState(null);
  const [verifyEvaluatorData, setVerifyEvaluatorData] = useState(null);
  const [verifyFlowPath, setVerifyFlowPath] = useState(null);
  const [verifyFlowAnswers, setVerifyFlowAnswers] = useState({});
  const [verifyEvaluations, setVerifyEvaluations] = useState(() => verifyStored.current?.evaluations || {});
  const [verifyExpertMode, setVerifyExpertMode] = useState(() => {
    try { return localStorage.getItem(VERIFY_EXPERT_KEY) === 'true'; } catch { return false; }
  });
  const [verifyExpertPromptShown, setVerifyExpertPromptShown] = useState(() => {
    try {
      const prompted = localStorage.getItem(VERIFY_EXPERT_KEY + '-prompted') === 'true';
      const dismissed = localStorage.getItem(VERIFY_EXPERT_KEY + '-dismissed') === 'true';
      return prompted && !dismissed;
    } catch { return false; }
  });

  const verifySaveAll = useCallback(() => {
    verifySaveToStorage(null, verifyEvaluations);
  }, [verifyEvaluations]);

  useEffect(() => { verifySaveAll(); }, [verifySaveAll]);
  useEffect(() => { try { localStorage.setItem(VERIFY_EXPERT_KEY, String(verifyExpertMode)); } catch {} }, [verifyExpertMode]);

  const verifyPendingCount = VERIFY_MOCK_SUBJECTS.filter(s => !verifyEvaluations[s.id]).length;
  const verifyCompletedCount = Object.keys(verifyEvaluations).length;

  return {
    verifyCurrentSubjectId, setVerifyCurrentSubjectId,
    verifyEvaluatorData, setVerifyEvaluatorData,
    verifyFlowPath, setVerifyFlowPath,
    verifyFlowAnswers, setVerifyFlowAnswers,
    verifyEvaluations, setVerifyEvaluations,
    verifyPendingCount, verifyCompletedCount,
    verifyExpertMode, setVerifyExpertMode,
    verifyExpertPromptShown, setVerifyExpertPromptShown,
  };
};

// --- useAssessment Hook ---
const useAssessment = ({ setScreen, darkMode, entityType }) => {
  const [assessCurrentTestId, setAssessCurrentTestId] = useState(null);
  const [assessCurrentIndex, setAssessCurrentIndex] = useState(0);
  const [assessEntering, setAssessEntering] = useState(false);
  const [assessResponses, setAssessResponses] = useState({});
  const [assessSkipped, setAssessSkipped] = useState([]);
  const [assessCompleted, setAssessCompleted] = useState(() => {
    try { const s = localStorage.getItem(ASSESS_STORAGE_KEY); return s ? JSON.parse(s).completed || {} : {}; } catch { return {}; }
  });
  const [assessInProgress, setAssessInProgress] = useState(() => {
    try { const s = localStorage.getItem(ASSESS_STORAGE_KEY); return s ? JSON.parse(s).inProgress || {} : {}; } catch { return {}; }
  });
  const [assessPending, setAssessPending] = useState(null);
  const [assessShowCompletion, setAssessShowCompletion] = useState(false);
  const [assessShowDemoMenu, setAssessShowDemoMenu] = useState(false);
  const [assessShowExitConfirm, setAssessShowExitConfirm] = useState(false);
  const [assessExpandedCategory, setAssessExpandedCategory] = useState(null);
  const [analysisExpanded, setAnalysisExpanded] = useState({});
  const [assessDemoActive, setAssessDemoActive] = useState(() => {
    try { const s = localStorage.getItem(ASSESS_STORAGE_KEY); return s ? JSON.parse(s).demoActive || false : false; } catch { return false; }
  });
  const [assessDemoProfile, setAssessDemoProfile] = useState(() => {
    try { const s = localStorage.getItem(ASSESS_STORAGE_KEY); const p = s ? JSON.parse(s).demoProfile : null; return p != null ? Number(p) : null; } catch { return null; }
  });
  const [showDemoControls, setShowDemoControls] = useState(() => {
    try { const s = localStorage.getItem(ASSESS_STORAGE_KEY); return s ? JSON.parse(s).showDemoControls || false : false; } catch { return false; }
  });
  const [assessSavedUserData, setAssessSavedUserData] = useState(() => {
    try { const s = localStorage.getItem(ASSESS_STORAGE_KEY); return s ? JSON.parse(s).savedUserData || null : null; } catch { return null; }
  });
  const [assessShowDemoInfo, setAssessShowDemoInfo] = useState(false);
  const [assessProfileSwitching, setAssessProfileSwitching] = useState(false);
  const assessTimeoutRef = useRef(null);
  const [assessShowUndoToast, setAssessShowUndoToast] = useState(false);
  const [assessUnlockMessage, setAssessUnlockMessage] = useState(null);
  const [assessNudgeData, setAssessNudgeData] = useState(null);

  const assessSaveToStorage = (completed, progress, demoActive = assessDemoActive, savedUserData = assessSavedUserData, demoProfile = assessDemoProfile, demoControls = showDemoControls) => {
    localStorage.setItem(ASSESS_STORAGE_KEY, JSON.stringify({ completed, inProgress: progress, demoActive, savedUserData, demoProfile, showDemoControls: demoControls }));
  };

  // Sync assessment data with Supabase on auth changes
  useEffect(() => {
    const handler = async (e) => {
      const user = e.detail?.user;
      if (user && (e.detail.event === 'SIGNED_IN' || e.detail.event === 'INITIAL_SESSION')) {
        const cloud = await loadAssessmentsFromCloud(user.id);
        if (cloud) {
          if (Object.keys(cloud.completed).length > 0 || Object.keys(cloud.inProgress).length > 0) {
            setAssessCompleted(prev => ({ ...prev, ...cloud.completed }));
            setAssessInProgress(prev => ({ ...prev, ...cloud.inProgress }));
            // Read localStorage directly to avoid stale closure
            try {
              const stored = JSON.parse(localStorage.getItem(ASSESS_STORAGE_KEY) || '{}');
              const merged = { ...(stored.completed || {}), ...cloud.completed };
              const mergedProgress = { ...(stored.inProgress || {}), ...cloud.inProgress };
              localStorage.setItem(ASSESS_STORAGE_KEY, JSON.stringify({ ...stored, completed: merged, inProgress: mergedProgress }));
            } catch {}
            console.log('[Aura] Loaded assessments from cloud:', Object.keys(cloud.completed).length, 'completed,', Object.keys(cloud.inProgress).length, 'in-progress');
          }
        }
      }
      // Reset state on sign-out â€” prevents stale cloud data from previous account
      if (!user && e.detail?.event === 'SIGNED_OUT') {
        setAssessCompleted({});
        setAssessInProgress({});
        localStorage.setItem(ASSESS_STORAGE_KEY, JSON.stringify({ completed: {}, inProgress: {}, demoActive: false, savedUserData: null, demoProfile: null, showDemoControls: false }));
        console.log('[Aura] Cleared assessment state on sign-out');
      }
    };
    window.addEventListener('aura-auth-change', handler);
    return () => window.removeEventListener('aura-auth-change', handler);
  }, []);

  const assessCurrentTest = assessCurrentTestId ? ASSESS_TESTS[assessCurrentTestId] : null;
  const assessTestColor = assessCurrentTest ? getAssessColor(assessCurrentTest.color, darkMode) : null;
  const assessCurrentScale = assessCurrentTest ? ASSESS_SCALES[assessCurrentTest.scale] : null;

  // Gateway branching: compute active item indices based on Q0 answer
  // Always returns 5 items (3 core + 2 branch) so progress shows "1/5" from the start
  const assessGatewayActiveItems = useMemo(() => {
    if (!assessCurrentTest || assessCurrentTest.scale !== 'gateway') return null;
    const branchKey = assessResponses[0] != null ? assessResponses[0] - 1 : null; // 0-indexed
    return assessCurrentTest.items.reduce((acc, item, i) => {
      if (!item.branchIf) { acc.push(i); return acc; } // core items always shown
      const [bKey, bVal] = Object.entries(item.branchIf)[0];
      if (branchKey === null) {
        // Before Q0 answered: use first branch as placeholders to keep count at 5
        if (bVal === 0) acc.push(i);
      } else {
        if (bKey === 'energy' && branchKey === bVal) acc.push(i);
      }
      return acc;
    }, []);
  }, [assessCurrentTest, assessResponses[0]]);

  const assessTotalQuestions = assessGatewayActiveItems
    ? assessGatewayActiveItems.length
    : (assessCurrentTest?.items.length || 0);

  const assessStartTest = (testId) => {
    setAssessCurrentTestId(testId);
    const progress = assessInProgress[testId];
    setAssessCurrentIndex(progress?.index || 0);
    setAssessResponses(progress?.responses || {});
    setAssessSkipped(progress?.skipped || []);
    setAssessPending(null);
    setScreen('assess-question');
  };

  const assessSaveAndExit = () => {
    clearTimeout(assessTimeoutRef.current);
    const progressData = { index: assessCurrentIndex, responses: assessResponses, skipped: assessSkipped };
    const newProgress = { ...assessInProgress, [assessCurrentTestId]: progressData };
    setAssessInProgress(newProgress);
    assessSaveToStorage(assessCompleted, newProgress);
    // Sync to cloud if signed in
    const user = getCurrentUser();
    if (user) {
      const totalQ = assessCurrentTest?.questionCount || assessCurrentTest?.items?.length || 1;
      const pct = Object.keys(assessResponses).length / totalQ;
      saveAssessmentToCloud(user.id, assessCurrentTestId, 'in-progress', {
        responses: assessResponses,
        skipped: assessSkipped,
        currentIndex: assessCurrentIndex
      }, null, pct);
    }
    setScreen('assess-picker');
  };

  const assessGoToQuestion = (index, direction) => {
    setAssessEntering(false); // reset to retrigger
    setAssessCurrentIndex(index);
    setAssessPending(null);
    // Trigger gentle breath animation on next frame
    requestAnimationFrame(() => setAssessEntering(true));
    setTimeout(() => setAssessEntering(false), 1700);
  };

  const assessHandleAnswerTap = (value) => {
    // Tap and go â€” no pending state, no undo delay. Immediate submit.
    assessFinalizeSubmit(value);
  };

  const assessHandleUndo = () => {
    clearTimeout(assessTimeoutRef.current);
    setAssessPending(null);
    // Show undo confirmation
    setAssessShowUndoToast(true);
    setTimeout(() => setAssessShowUndoToast(false), 1000);
  };

  const assessFinalizeSubmit = (value) => {
    // For gateway: store at raw item index, not visual index
    const gwActive = assessGatewayActiveItems;
    const rawIdx = gwActive ? gwActive[assessCurrentIndex] : assessCurrentIndex;
    const newResponses = { ...assessResponses, [rawIdx]: value };
    setAssessResponses(newResponses);
    const newSkipped = assessSkipped.filter(i => i !== rawIdx);
    setAssessSkipped(newSkipped);
    setAssessPending(null);
    // Capture assessment response to Supabase
    captureAssessResponse(assessCurrentTestId, rawIdx, value);
    assessAdvanceToNext(newResponses, newSkipped);
  };

  // Compute fresh gateway active items from current responses (avoids stale useMemo)
  const getGatewayActive = (resp) => {
    if (!assessCurrentTest || assessCurrentTest.scale !== 'gateway') return null;
    const branchKey = resp[0] != null ? resp[0] - 1 : null;
    return assessCurrentTest.items.reduce((acc, item, i) => {
      if (!item.branchIf) { acc.push(i); return acc; }
      const [bKey, bVal] = Object.entries(item.branchIf)[0];
      if (branchKey === null) {
        if (bVal === 0) acc.push(i);
      } else {
        if (bKey === 'energy' && branchKey === bVal) acc.push(i);
      }
      return acc;
    }, []);
  };

  const assessAdvanceToNext = (resp, skipped) => {
    // For gateway: compute fresh active items from current responses
    const gwActive = getGatewayActive(resp);
    if (gwActive) {
      const answered = gwActive.filter(ri => resp[ri] !== undefined).length;
      if (answered >= gwActive.length) { assessCompleteTest(resp); return; }
      // Find next unanswered visual index
      for (let vi = assessCurrentIndex + 1; vi < gwActive.length; vi++) {
        if (resp[gwActive[vi]] === undefined) { assessGoToQuestion(vi, 'fwd'); return; }
      }
      for (let vi = 0; vi < assessCurrentIndex; vi++) {
        if (resp[gwActive[vi]] === undefined) { assessGoToQuestion(vi, 'fwd'); return; }
      }
      return;
    }
    const total = assessCurrentTest.items.length;
    const answeredCount = Object.keys(resp).length;
    if (answeredCount >= total) { assessCompleteTest(resp); return; }
    for (let i = assessCurrentIndex + 1; i < total; i++) {
      if (resp[i] === undefined) { assessGoToQuestion(i, 'fwd'); return; }
    }
    for (let i = 0; i < assessCurrentIndex; i++) {
      if (resp[i] === undefined) { assessGoToQuestion(i, 'fwd'); return; }
    }
  };

  const assessCanFinish = () => {
    if (!assessCurrentTest) return false;
    const gwActive = assessGatewayActiveItems;
    if (gwActive) return gwActive.every(ri => assessResponses[ri] !== undefined);
    return Object.keys(assessResponses).length >= assessCurrentTest.items.length;
  };

  const assessFinishAssessment = () => {
    if (assessCanFinish()) assessCompleteTest(assessResponses);
  };

  const assessCompleteTest = (resp) => {
    const results = calculateAssessResults(assessCurrentTestId, resp);
    const newCompleted = { ...assessCompleted, [assessCurrentTestId]: results };
    setAssessCompleted(newCompleted);
    const { [assessCurrentTestId]: _, ...remainingProgress } = assessInProgress;
    setAssessInProgress(remainingProgress);
    assessSaveToStorage(newCompleted, remainingProgress);
    // Sync completed test to cloud + update profile summary
    const user = getCurrentUser();
    if (user) {
      saveAssessmentToCloud(user.id, assessCurrentTestId, 'completed', resp, results, 1.0);
      updateProfileSummary(user.id, newCompleted, null, entityType);
    }

    // Check for unlock tier changes
    const prevTier = calculateAssessTier(assessCompleted);
    const newTier = calculateAssessTier(newCompleted);

    if (newTier > prevTier) {
      // Show unlock celebration
      const unlockMessages = {
        1: { title: "Starter Pack Unlocked!", subtitle: "Begin your deep dive into self-discovery" },
        2: { title: "All Branches Unlocked!", subtitle: "Explore Personality, Mind, Shadow & more" }
      };
      setAssessUnlockMessage(unlockMessages[newTier]);
    }

    setAssessShowCompletion(true);
    // Pre-compute nudge for the results screen
    const nudge = getAssessNudge(assessCurrentTestId, newCompleted, entityType);
    setAssessNudgeData(nudge);
    setTimeout(() => {
      setAssessShowCompletion(false);
      setAssessUnlockMessage(null);
      // All tests â†’ results screen (including quick-profile)
      setScreen('assess-results');
    }, assessCurrentTestId === 'quick-profile' ? 2500 : 1500);
  };

  const assessLoadDemoProfile = (profileNum) => {
    // Save current user data before loading demo (only if not already in demo mode)
    const savedData = !assessDemoActive ? {
      completed: { ...assessCompleted },
      inProgress: { ...assessInProgress }
    } : assessSavedUserData;

    if (!assessDemoActive) {
      setAssessSavedUserData(savedData);
    }

    const profile = ASSESS_DEMO_PROFILES[profileNum];
    const skipList = profile.skip || [];
    const newCompleted = {};
    Object.keys(ASSESS_TESTS).forEach(testId => {
      // Skip tests in the profile's skip list
      if (skipList.includes(testId)) return;
      const test = ASSESS_TESTS[testId];
      const answers = {};
      if (test.parent === 'bigfive') {
        const traitData = profile.bigfive?.[test.trait];
        if (traitData) traitData.forEach((val, i) => { answers[i] = val; });
        else return;
      } else if (test.parent === 'shadow') {
        const traitData = profile.shadow?.[test.trait];
        if (traitData) traitData.forEach((val, i) => { answers[i] = val; });
        else return;
      } else if (profile[testId]) {
        if (Array.isArray(profile[testId])) {
          profile[testId].forEach((val, i) => { answers[i] = val; });
        } else {
          // Object format (e.g., gateway branching responses)
          Object.entries(profile[testId]).forEach(([k, v]) => { answers[parseInt(k)] = v; });
        }
      } else {
        // Skip tests without demo data (e.g., quick-profile)
        return;
      }
      newCompleted[testId] = calculateAssessResults(testId, answers);
    });
    setAssessCompleted(newCompleted);
    setAssessInProgress({});
    setAssessDemoActive(true);
    setAssessDemoProfile(profileNum);
    assessSaveToStorage(newCompleted, {}, true, savedData, profileNum);
    setAssessShowDemoMenu(false);
    setAssessProfileSwitching(true);
    setTimeout(() => setAssessProfileSwitching(false), 600);
  };

  const assessClearDemo = () => {
    // Restore user data from before demo
    if (assessSavedUserData) {
      setAssessCompleted(assessSavedUserData.completed);
      setAssessInProgress(assessSavedUserData.inProgress);
      assessSaveToStorage(assessSavedUserData.completed, assessSavedUserData.inProgress, false, null, null);
    } else {
      setAssessCompleted({});
      setAssessInProgress({});
      assessSaveToStorage({}, {}, false, null, null);
    }
    setAssessDemoActive(false);
    setAssessDemoProfile(null);
    setAssessSavedUserData(null);
    setAssessProfileSwitching(true);
    setTimeout(() => setAssessProfileSwitching(false), 600);
  };

  const assessClearAll = () => {
    setAssessCompleted({});
    setAssessInProgress({});
    setAssessDemoActive(false);
    setAssessSavedUserData(null);
    assessSaveToStorage({}, {}, false, null);
    setAssessShowDemoMenu(false);
    // Clear cloud data if signed in
    const user = getCurrentUser();
    if (user) clearAllAssessmentsFromCloud(user.id);
  };

  return {
    assessCurrentTestId, setAssessCurrentTestId,
    assessCurrentIndex, setAssessCurrentIndex,
    assessEntering, setAssessEntering,
    assessResponses, setAssessResponses,
    assessSkipped, setAssessSkipped,
    assessCompleted, setAssessCompleted,
    assessInProgress, setAssessInProgress,
    assessPending, setAssessPending,
    assessShowCompletion, setAssessShowCompletion,
    assessShowDemoMenu, setAssessShowDemoMenu,
    assessShowExitConfirm, setAssessShowExitConfirm,
    assessExpandedCategory, setAssessExpandedCategory,
    analysisExpanded, setAnalysisExpanded,
    assessDemoActive, setAssessDemoActive,
    assessDemoProfile, setAssessDemoProfile,
    showDemoControls, setShowDemoControls,
    assessSavedUserData, setAssessSavedUserData,
    assessShowDemoInfo, setAssessShowDemoInfo,
    assessProfileSwitching, setAssessProfileSwitching,
    assessTimeoutRef,
    assessShowUndoToast, setAssessShowUndoToast,
    assessUnlockMessage, setAssessUnlockMessage,
    assessNudgeData, setAssessNudgeData,
    assessSaveToStorage,
    assessCurrentTest, assessTestColor, assessCurrentScale, assessTotalQuestions, assessGatewayActiveItems,
    assessStartTest, assessSaveAndExit, assessGoToQuestion,
    assessHandleAnswerTap, assessHandleUndo, assessFinalizeSubmit,
    assessAdvanceToNext, assessCanFinish, assessFinishAssessment,
    assessCompleteTest, assessLoadDemoProfile, assessClearDemo, assessClearAll,
  };
};

function App() {

  // --- Navigation & Auth ---
  const displayMode = useDisplayMode();
  const [questions] = useState(() => shuffleArray(QUESTIONS));
  const [screen, setScreen] = useState(getInitialScreen);
  const [previousScreen, setPreviousScreen] = useState('categories');
  const [isGuestMode, setIsGuestMode] = useState(() => localStorage.getItem('aura_guest_mode') === 'true');
  const [authUser, setAuthUser] = useState(null);
  const [displayName, setDisplayName] = useState(null);
  const [showSaveNudge, setShowSaveNudge] = useState(false);
  const [nudgeShown, setNudgeShown] = useState(() => localStorage.getItem('aura_nudge_shown') === 'true');
  const [compareData, setCompareData] = useState(() => {
    // Sync parse of legacy ?compare= base64
    try {
      const params = new URLSearchParams(window.location.search);
      const raw = params.get('compare');
      if (raw) return JSON.parse(atob(raw));
    } catch {}
    return null; // ?c= loaded async below
  });
  const [compareLoading, setCompareLoading] = useState(() => {
    try { return !!new URLSearchParams(window.location.search).get('c'); } catch { return false; }
  });

  // Listen for auth state changes to trigger re-renders + navigate
  useEffect(() => {
    const handler = (e) => {
      const user = e.detail?.user || null;
      const prevUser = authUser;
      setAuthUser(user);
      // Navigate on sign-in (null â†’ user transition)
      if (user && !prevUser) {
        localStorage.removeItem('aura_guest_mode');
        setIsGuestMode(false);
        setScreen('assess-picker');
      }
      // Navigate on sign-out
      if (!user && prevUser) {
        setDisplayName(null);
        setScreen('welcome');
      }
    };
    window.addEventListener('aura-auth-change', handler);
    // Check initial state (session may have restored before React mounted)
    if (getCurrentUser()) setAuthUser(getCurrentUser());
    return () => window.removeEventListener('aura-auth-change', handler);
  }, [authUser]);

  // Listen for profile changes (display name)
  useEffect(() => {
    const handler = (e) => setDisplayName(e.detail?.displayName || null);
    window.addEventListener('aura-profile-change', handler);
    return () => window.removeEventListener('aura-profile-change', handler);
  }, []);

  // Load comparison data from ?c= short link
  useEffect(() => {
    const params = new URLSearchParams(window.location.search);
    const shortId = params.get('c');
    if (!shortId) return;
    loadComparison(shortId).then(data => {
      if (data) setCompareData(data);
      setCompareLoading(false);
    });
  }, []);

  // --- Claims (stamps) ---
  const [userClaims, setUserClaims] = useState([]);
  useEffect(() => {
    const handler = (e) => setUserClaims(e.detail?.claims || []);
    window.addEventListener('aura-claims-loaded', handler);
    return () => window.removeEventListener('aura-claims-loaded', handler);
  }, []);

  // --- Public Profile (sharing) ---
  const [publicProfileId] = useState(getPublicProfileId);

  const [onboardingComplete, setOnboardingComplete] = useState(() => localStorage.getItem('aura_onboarding_complete') === 'true');
  const [onboardingAnswers, setOnboardingAnswers] = useState(() => {
    try { return JSON.parse(localStorage.getItem(ONBOARD_STORAGE_KEY)) || {}; } catch { return {}; }
  });

  // --- UI Chrome ---
  const [levelUpData, setLevelUpData] = useState(null); // { level, title }
  const [showDevPanel, setShowDevPanel] = useState(IS_DEV);
  const [devMinimized, setDevMinimized] = useState(false);
  const [devPhoneSize, setDevPhoneSize] = useState('15');
  const [devQAAnswers, setDevQAAnswers] = useState(() => {
    try {
      const raw = JSON.parse(localStorage.getItem('aura-dev-qa') || '{}');
      // Backfill: patch old answers that lack question text
      let patched = false;
      const ALL_Q_TEXT = {
        'dq-welcome-identity': 'Welcome screen â€” does the current layout (logo + tagline + begin) feel like the right first impression?',
        'dq-path-choice-fork': 'After onboarding, the path choice screen offers two buttons. Is that the right fork, or should the app just flow into one default experience?',
        'dq-verify-scope': 'Verification flow is functional but bare. Should we invest in polishing it now, or keep building core assessment features first?',
        'dq-categories-density': 'Categories screen â€” too many items visible? Should we group, collapse, or paginate?',
        'dq-assess-picker-light': 'Assessment picker in light mode â€” does it hold up or need a rework?',
        'dq-profile-identity': 'Profile screen â€” should the aura viz be the hero (big, central, defining), or should stats/progress lead and the viz be supporting?',
        'dq-binary-glow-intensity': 'Binary question glow behind the text â€” intensity right?',
        'dq-qotd-whitespace': 'QotD screen â€” too much empty space around the question, or does it breathe well?',
        'dq-settings-personality': 'Settings screen â€” generic utility dump or does it feel like Aura?',
        'dq-mc-color-vs-gray': 'MC questions: colored options vs gray-until-tapped â€” which default?',
        'dq-onboard-exit': 'After onboarding, the path choice screen offers two buttons. Is that the right fork, or should the app just flow into one default experience?',
        'dq-action-bar-visibility': "Ghost buttons under answers (Can't / Explain / Skip / Save) â€” discoverable enough?",
      };
      for (const [qId, a] of Object.entries(raw)) {
        if (!a.question && ALL_Q_TEXT[qId]) { a.question = ALL_Q_TEXT[qId]; patched = true; }
        if (!a.tier) { a.tier = qId.match(/binary|action|qotd|settings|mc-color/) ? 'little' : 'big'; patched = true; }
      }
      if (patched) localStorage.setItem('aura-dev-qa', JSON.stringify(raw));
      return raw;
    } catch { return {}; }
  });
  const [devQAShowHistory, setDevQAShowHistory] = useState(false);
  const [devQANotes, setDevQANotes] = useState({});
  const [devQATier, setDevQATier] = useState('big'); // 'big' or 'little'

  // --- Questions & Responses ---
  const [currentIndex, setCurrentIndex] = useState(0);
  const [darkMode, setDarkMode] = useState(getInitialDarkMode);
  const [responses, setResponses] = useState(() => demoStorage.get().answers);
  const [communityResults, setCommunityResults] = useState(() => generateDemoCommunityResults());
  const [undoDelay, setUndoDelay] = useState(() => demoStorage.get().settings.undoDelay);
  const [requireConfirmation, setRequireConfirmation] = useState(() => demoStorage.get().settings.requireConfirmation);
  const [mcColorMode, setMcColorMode] = useState('gray'); // LOCKED: gray default â€” panel consensus, no selection bias
  const [showTips, setShowTips] = useState(() => demoStorage.get().settings.showTips !== false);
  const [showGestureHint, setShowGestureHint] = useState(true);
  const [stats, setStats] = useState(() => demoStorage.get().stats);
  const [pendingSubmit, setPendingSubmit] = useState(null);
  const [inGracePeriod, setInGracePeriod] = useState(false); // Grace period for multi-tap confidence
  const [justUndone, setJustUndone] = useState(false); // Shows "Undone" modal after canceling submit
  const [tappedAnswer, setTappedAnswer] = useState(null);
  const [tapCount, setTapCount] = useState(0);
  const [evidenceExpanded, setEvidenceExpanded] = useState(false);
  const [showFullResults, setShowFullResults] = useState(null);
  const [lastAnsweredQuestion, setLastAnsweredQuestion] = useState(null); // Track the question we just answered
  const [communityBrowseIndex, setCommunityBrowseIndex] = useState(0); // For browsing through answered questions
  const [communityDisplayMode, setCommunityDisplayMode] = useState('compact'); // 'compact', 'hidden'
  const [communityExpanded, setCommunityExpanded] = useState(false); // Slide-up expanded view
  const [selectedCategory, setSelectedCategory] = useState(null); // For category filtering
  const [selectedTrack, setSelectedTrack] = useState(null); // 'binary' or 'multiple'
  const [questionFlags, setQuestionFlags] = useState({}); // { [questionId]: "flag text" }
  const [answerExplanations, setAnswerExplanations] = useState({}); // { [questionId]: "explanation" }
  const [showQuestionFlagModal, setShowQuestionFlagModal] = useState(null); // questionId or null
  const [showExplanationModal, setShowExplanationModal] = useState(null); // questionId or null
  const [savedQuestions, setSavedQuestions] = useState(new Set()); // Questions saved for later
  const [skippedQuestions, setSkippedQuestions] = useState(new Set()); // Questions skipped
  const [showSavedToast, setShowSavedToast] = useState(false); // "Saved for later" feedback

  // --- Entity Type ---
  const [entityType, setEntityType] = useState(() => demoStorage.get().entityType || 'human');

  // --- Entity Gate Declaration (from gate screen â€” type + optional model name) ---
  const [entityModelName, setEntityModelName] = useState(() => {
    try { const d = JSON.parse(localStorage.getItem('aura-entity-declared') || '{}'); return d.model || null; } catch { return null; }
  });

  // --- QOTD (via useQotd hook) ---
  const { qotdData, qotdResponse, setQotdResponse, qotdTappedAnswer, setQotdTappedAnswer, qotdTapCount, setQotdTapCount, resetQotd, handleQotdTap, submitQotdAnswer } = useQotd();

  // --- Profile & History ---
  const [showStreak, setShowStreak] = useState(true);
  const [showCantAnswerModal, setShowCantAnswerModal] = useState(null);
  const [showNoneOptionModal, setShowNoneOptionModal] = useState(false);
  const [sessionAnsweredCategories, setSessionAnsweredCategories] = useState(new Set()); // Categories user has answered in this session
  const [sessionAnsweredIds, setSessionAnsweredIds] = useState(new Set()); // Question IDs answered THIS session (show results only for these)

  // --- Assessment System (via useAssessment hook) ---
  const {
    assessCurrentTestId, setAssessCurrentTestId, assessCurrentIndex, setAssessCurrentIndex,
    assessEntering, setAssessEntering, assessResponses, setAssessResponses,
    assessSkipped, setAssessSkipped, assessCompleted, setAssessCompleted,
    assessInProgress, setAssessInProgress, assessPending, setAssessPending,
    assessShowCompletion, setAssessShowCompletion, assessShowDemoMenu, setAssessShowDemoMenu,
    assessShowExitConfirm, setAssessShowExitConfirm, assessExpandedCategory, setAssessExpandedCategory,
    analysisExpanded, setAnalysisExpanded, assessDemoActive, setAssessDemoActive,
    assessDemoProfile, setAssessDemoProfile, showDemoControls, setShowDemoControls,
    assessSavedUserData, setAssessSavedUserData, assessShowDemoInfo, setAssessShowDemoInfo,
    assessProfileSwitching, setAssessProfileSwitching, assessTimeoutRef,
    assessShowUndoToast, setAssessShowUndoToast, assessUnlockMessage, setAssessUnlockMessage,
    assessNudgeData, setAssessNudgeData,
    assessSaveToStorage, assessCurrentTest, assessTestColor, assessCurrentScale, assessTotalQuestions, assessGatewayActiveItems,
    assessStartTest, assessSaveAndExit, assessGoToQuestion,
    assessHandleAnswerTap, assessHandleUndo, assessFinalizeSubmit,
    assessAdvanceToNext, assessCanFinish, assessFinishAssessment,
    assessCompleteTest, assessLoadDemoProfile, assessClearDemo, assessClearAll,
  } = useAssessment({ setScreen, darkMode, entityType });

  // --- Verification (via useVerification hook) ---
  const { verifyCurrentSubjectId, setVerifyCurrentSubjectId, verifyEvaluatorData, setVerifyEvaluatorData, verifyFlowPath, setVerifyFlowPath, verifyFlowAnswers, setVerifyFlowAnswers, verifyEvaluations, setVerifyEvaluations, verifyPendingCount, verifyCompletedCount, verifyExpertMode, setVerifyExpertMode, verifyExpertPromptShown, setVerifyExpertPromptShown } = useVerification();

  // --- Refs & Derived ---
  const submitTimeoutRef = useRef(null);
  const tapTimeoutRef = useRef(null);
  const graceTimeoutRef = useRef(null);
  const pendingSubmitStartRef = useRef(null);
  const CONFIDENCE_GRACE_PERIOD = 1200; // ms to allow additional taps to increase confidence

  const currentQuestion = questions[currentIndex];
  const currentResponse = currentQuestion ? responses[currentQuestion.id] : null;
  const isAnswered = !!currentResponse;
  const currentResults = currentQuestion ? communityResults[currentQuestion.id] : null;
  const isBinary = currentQuestion?.type === 'binary';
  const showConfirmOverlay = tappedAnswer !== null && requireConfirmation && !isAnswered && !pendingSubmit;
  const confirmColor = (() => {
    if (tappedAnswer === null) return null;
    if (isBinary) {
      const isOp = currentQuestion?.category === 'judgment';
      return tappedAnswer === 0
        ? COLOR_HEX[isOp ? 'cyan' : 'emerald']
        : COLOR_HEX[isOp ? 'violet' : 'rose'];
    }
    const mc = MC_COLORS[tappedAnswer % MC_COLORS.length];
    return { rgb: mc.rgb, base: mc.hex, light: mc.shades?.[1] || mc.hex };
  })();

  // Last answered question for bottom community results (not just prev index)
  const lastAnsweredResponse = lastAnsweredQuestion ? responses[lastAnsweredQuestion.id] : null;
  const lastAnsweredResults = lastAnsweredQuestion ? communityResults[lastAnsweredQuestion.id] : null;

  // Calculate progress
  const totalQuestions = questions.length;
  const answeredCount = Object.keys(responses).length;

  useEffect(() => {
    const data = demoStorage.get();
    data.settings = { ...data.settings, darkMode, undoDelay, requireConfirmation, showTips };
    data.entityType = entityType;
    demoStorage.set(data);
  }, [darkMode, undoDelay, requireConfirmation, showTips, entityType]);

  // Dev panel keyboard shortcut (Ctrl+Shift+D â€” uses Ctrl key, not Cmd, to avoid browser conflicts)
  useEffect(() => {
    if (!IS_DEV) return;
    const handleKeyDown = (e) => {
      if (e.ctrlKey && !e.metaKey && e.shiftKey && e.key === 'D') {
        e.preventDefault();
        setShowDevPanel(p => !p);
      }
    };
    window.addEventListener('keydown', handleKeyDown);
    return () => window.removeEventListener('keydown', handleKeyDown);
  }, []);

  // Find next unanswered question
  const findNextUnanswered = useCallback((fromIndex) => {
    for (let i = fromIndex + 1; i < questions.length; i++) {
      if (!responses[questions[i].id]) return i;
    }
    for (let i = 0; i < fromIndex; i++) {
      if (!responses[questions[i].id]) return i;
    }
    return null;
  }, [questions, responses]);

  // Check if question matches current category and track filters
  const matchesFilters = useCallback((q) => {
    if (selectedCategory && selectedCategory !== 'random' && q.category !== selectedCategory) return false;
    if (selectedTrack === 'binary' && q.type !== 'binary') return false;
    if (selectedTrack === 'multiple' && q.type !== 'multiple') return false;
    return true;
  }, [selectedCategory, selectedTrack]);

  const goToNext = useCallback(() => {
    let nextIdx = null;
    // Find next unanswered matching filters
    for (let i = currentIndex + 1; i < questions.length; i++) {
      if (matchesFilters(questions[i]) && !responses[questions[i].id]) {
        nextIdx = i;
        break;
      }
    }
    if (nextIdx === null) {
      // Wrap around
      for (let i = 0; i < currentIndex; i++) {
        if (matchesFilters(questions[i]) && !responses[questions[i].id]) {
          nextIdx = i;
          break;
        }
      }
    }
    if (nextIdx !== null) {
      setCurrentIndex(nextIdx);
      setTappedAnswer(null);
      setTapCount(0);
      setEvidenceExpanded(false);
      setCommunityBrowseIndex(0);
      setJustUndone(false); // Clear undo popup when leaving
    } else {
      setScreen('categories');
    }
  }, [currentIndex, matchesFilters, questions, responses]);

  const goToPrev = useCallback(() => {
    for (let i = currentIndex - 1; i >= 0; i--) {
      if (matchesFilters(questions[i])) {
        setCurrentIndex(i);
        setTappedAnswer(null);
        setTapCount(0);
        setEvidenceExpanded(false);
        setCommunityBrowseIndex(0);
        setJustUndone(false); // Clear undo popup when leaving
        return;
      }
    }
  }, [currentIndex, matchesFilters, questions]);

  // Skip question - move to next without answering
  const skipQuestion = useCallback(() => {
    if (currentQuestion) {
      setSkippedQuestions(prev => new Set([...prev, currentQuestion.id]));
    }
    setTappedAnswer(null);
    setTapCount(0);
    goToNext();
  }, [currentQuestion, goToNext]);

  // Save question for later
  const saveForLater = useCallback(() => {
    if (currentQuestion) {
      setSavedQuestions(prev => new Set([...prev, currentQuestion.id]));
    }
    setTappedAnswer(null);
    setTapCount(0);
    setShowSavedToast(true);
    setTimeout(() => setShowSavedToast(false), 1200);
    goToNext();
  }, [currentQuestion, goToNext]);

  const { handlers: swipeHandlers } = useSwipe({
    onSwipeLeft: goToNext,
    onSwipeRight: goToPrev,
    enabled: screen === 'question' && !pendingSubmit
  });

  // Assessment swipe handlers
  const assessSwipeNext = useCallback(() => {
    if (assessCurrentIndex < assessTotalQuestions - 1) assessGoToQuestion(assessCurrentIndex + 1, 'fwd');
  }, [assessCurrentIndex, assessTotalQuestions]);
  const assessSwipePrev = useCallback(() => {
    if (assessCurrentIndex > 0) assessGoToQuestion(assessCurrentIndex - 1, 'back');
  }, [assessCurrentIndex]);
  const { handlers: assessSwipeHandlers } = useSwipe({
    onSwipeLeft: assessSwipeNext,
    onSwipeRight: assessSwipePrev,
    enabled: screen === 'assess-question' && !assessPending
  });

  const handleAnswerTap = (answer) => {
    if (isAnswered) return;

    // During grace period, allow confidence increases on pending answer
    if (pendingSubmit && inGracePeriod) {
      if (answer === pendingSubmit.answer && pendingSubmit.confidence < 4) {
        // Increase confidence during grace period
        const newConfidence = Math.min(pendingSubmit.confidence + 1, 4);
        setPendingSubmit({ ...pendingSubmit, confidence: newConfidence });
        pendingSubmitStartRef.current = Date.now(); // Reset grace period timer
        // Reset grace period
        if (graceTimeoutRef.current) clearTimeout(graceTimeoutRef.current);
        graceTimeoutRef.current = setTimeout(() => setInGracePeriod(false), CONFIDENCE_GRACE_PERIOD);
        // Restart the submit timeout with new confidence
        if (submitTimeoutRef.current) clearTimeout(submitTimeoutRef.current);
        if (undoDelay > 0) {
          submitTimeoutRef.current = setTimeout(() => {
            finalizeSubmit(answer, newConfidence, pendingSubmit.community);
          }, undoDelay * 1000);
        }
      }
      return;
    }

    // If pending but not in grace period, ignore tap (handled by overlay)
    if (pendingSubmit) return;

    if (tapTimeoutRef.current) clearTimeout(tapTimeoutRef.current);

    let newTapCount;
    if (tappedAnswer === answer) {
      newTapCount = Math.min(tapCount + 1, 4);
      setTapCount(newTapCount);
    } else {
      newTapCount = 1;
      setTappedAnswer(answer);
      setTapCount(1);
    }

    // Auto-submit if not requiring confirmation
    if (!requireConfirmation) {
      tapTimeoutRef.current = setTimeout(() => {
        submitAnswer(answer, newTapCount);
      }, 400);
    }
  };

  // Right-click to decrease confidence
  const handleAnswerRightClick = (e, answer) => {
    e.preventDefault();
    if (isAnswered || pendingSubmit) return;
    if (tappedAnswer !== answer) return; // Can only decrease if this answer is selected

    if (tapCount > 1) {
      setTapCount(tapCount - 1);
    }
  };

  const submitAnswer = (answer, confidence) => {
    if (submitTimeoutRef.current) clearTimeout(submitTimeoutRef.current);
    if (tapTimeoutRef.current) clearTimeout(tapTimeoutRef.current);
    if (justUndone) setJustUndone(false); // Clear undo state

    const community = generateFakeResults(currentQuestion);

    setPendingSubmit({ answer, confidence, community });
    pendingSubmitStartRef.current = Date.now(); // Track when pending started for grace period
    setTappedAnswer(null);
    setTapCount(0);

    // Start grace period for multi-tap confidence
    setInGracePeriod(true);
    if (graceTimeoutRef.current) clearTimeout(graceTimeoutRef.current);
    graceTimeoutRef.current = setTimeout(() => setInGracePeriod(false), CONFIDENCE_GRACE_PERIOD);

    // Hide gesture hint after first answer
    if (showGestureHint) setShowGestureHint(false);

    if (undoDelay === 0) {
      finalizeSubmit(answer, confidence, community);
    } else {
      submitTimeoutRef.current = setTimeout(() => {
        finalizeSubmit(answer, confidence, community);
      }, undoDelay * 1000);
    }
  };

  const finalizeSubmit = (answer, confidence, community) => {
    if (graceTimeoutRef.current) clearTimeout(graceTimeoutRef.current);
    setInGracePeriod(false);
    const data = demoStorage.get();
    data.answers[currentQuestion.id] = { answer, confidence, timestamp: Date.now() };
    data.stats.answered = Object.keys(data.answers).length;
    const today = new Date().toDateString();
    const isNewDay = data.stats.lastAnswerDate !== today;
    if (isNewDay) {
      const yesterday = new Date(Date.now() - 86400000).toDateString();
      data.stats.streak = data.stats.lastAnswerDate === yesterday ? data.stats.streak + 1 : 1;
      data.stats.lastAnswerDate = today;
    }

    // Calculate XP earned
    let xpEarned = XP_RATES.answer;
    if (confidence >= 3) xpEarned += XP_RATES.highConfidence;
    if (isNewDay) xpEarned += XP_RATES.dailyFirst;
    if (data.stats.streak >= 7 && isNewDay) xpEarned += XP_RATES.streakBonus;

    // Initialize XP if not exists
    const oldXP = data.stats.xp || 0;
    const oldLevel = data.stats.level || calculateLevel(oldXP);
    const newXP = oldXP + xpEarned;
    const newLevel = calculateLevel(newXP);
    data.stats.xp = newXP;
    data.stats.level = newLevel;

    demoStorage.set(data);

    // Capture to Firebase (if configured)
    captureResponse(currentQuestion.id, answer, confidence);

    // Track this as last answered question BEFORE advancing
    setLastAnsweredQuestion(currentQuestion);
    setCommunityBrowseIndex(0); // Reset to show most recent

    // Track that user has answered in this category this session
    if (currentQuestion.category) {
      setSessionAnsweredCategories(prev => new Set([...prev, currentQuestion.category]));
    }
    // Track this question as answered THIS session (for showing results)
    setSessionAnsweredIds(prev => new Set([...prev, currentQuestion.id]));

    setResponses(data.answers);
    setCommunityResults(prev => ({ ...prev, [currentQuestion.id]: community }));
    setStats(data.stats);
    setPendingSubmit(null);

    // Check for level up
    if (newLevel > oldLevel) {
      setLevelUpData({ level: newLevel, title: getLevelTitle(newLevel) });
    }

    // Go straight to next question (no flash of results screen)
    goToNext();
  };

  const handleUndo = () => {
    if (submitTimeoutRef.current) clearTimeout(submitTimeoutRef.current);
    if (graceTimeoutRef.current) clearTimeout(graceTimeoutRef.current);
    setInGracePeriod(false);
    // Restore selection state like vG
    if (pendingSubmit) {
      setTappedAnswer(pendingSubmit.answer);
      setTapCount(pendingSubmit.confidence);
      setJustUndone(true);
    }
    setPendingSubmit(null);
  };

  const clearUndoneState = () => {
    setTappedAnswer(null);
    setTapCount(0);
    setJustUndone(false);
  };

  // Keyboard shortcuts
  useEffect(() => {
    const handleKeyDown = (e) => {
      // Skip if typing in input/textarea
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
      // Skip on non-question screens
      if (screen !== 'question' && screen !== 'qotd') return;

      const key = e.key.toLowerCase();

      // Question screen shortcuts
      if (screen === 'question' && !isAnswered) {
        if (key === 'y' || key === '1') {
          e.preventDefault();
          handleAnswerTap(0);
        } else if (key === 'n' || key === '2') {
          e.preventDefault();
          handleAnswerTap(1);
        } else if (['3', '4', '5'].includes(key) && !isBinary) {
          e.preventDefault();
          handleAnswerTap(parseInt(key) - 1);
        } else if (key === 'escape' && pendingSubmit) {
          e.preventDefault();
          handleUndo();
        }
      }

      // QOTD screen shortcuts
      if (screen === 'qotd' && !qotdResponse) {
        const qotdIsBinary = qotdData?.type === 'binary';
        if (key === 'y' || key === '1') {
          e.preventDefault();
          handleQotdTap(0);
        } else if (key === 'n' || key === '2') {
          e.preventDefault();
          handleQotdTap(1);
        } else if (['3', '4', '5'].includes(key) && !qotdIsBinary) {
          e.preventDefault();
          handleQotdTap(parseInt(key) - 1);
        }
      }

      // Navigation (question screen only)
      if (screen === 'question') {
        if (key === 'arrowright' || key === ' ') {
          e.preventDefault();
          goToNext();
        } else if (key === 'arrowleft') {
          e.preventDefault();
          goToPrev();
        }
      }
    };

    window.addEventListener('keydown', handleKeyDown);
    return () => window.removeEventListener('keydown', handleKeyDown);
  }, [screen, isAnswered, isBinary, pendingSubmit, qotdResponse, qotdData, handleAnswerTap, handleUndo, handleQotdTap, goToNext, goToPrev]);

  // Go to settings, remembering where we came from
  const goToSettings = () => {
    setPreviousScreen(screen);
    setScreen('settings');
  };

  // Question flag handlers
  const handleQuestionFlag = (questionId, flagText) => {
    setQuestionFlags(prev => ({ ...prev, [questionId]: flagText }));
  };

  const handleClearQuestionFlag = (questionId) => {
    setQuestionFlags(prev => {
      const next = { ...prev };
      delete next[questionId];
      return next;
    });
  };

  // Explanation handlers
  const handleSaveExplanation = (questionId, text) => {
    setAnswerExplanations(prev => ({ ...prev, [questionId]: text }));
  };

  const handleClearExplanation = (questionId) => {
    setAnswerExplanations(prev => {
      const next = { ...prev };
      delete next[questionId];
      return next;
    });
  };

  // Category selection with track support
  const handleSelectCategory = (categoryId, track = null) => {
    setSelectedCategory(categoryId);
    setSelectedTrack(track);
    // Find first unanswered in this category+track
    let filtered = categoryId === 'random'
      ? questions
      : questions.filter(q => q.category === categoryId);
    if (track === 'binary') filtered = filtered.filter(q => q.type === 'binary');
    if (track === 'multiple') filtered = filtered.filter(q => q.type === 'multiple');
    const firstUnanswered = filtered.findIndex(q => !responses[q.id]);
    if (firstUnanswered !== -1) {
      const actualIndex = questions.findIndex(q => q.id === filtered[firstUnanswered].id);
      setCurrentIndex(actualIndex);
    }
    setScreen('question');
  };

  const startDemo = () => {
    setSelectedCategory(null);
    setTappedAnswer(null);
    setTapCount(0);
    setScreen('categories');
  };

  // Welcome screen handlers
  const handleTryFirst = () => {
    localStorage.setItem('aura_guest_mode', 'true');
    setIsGuestMode(true);
    // Check if user has completed onboarding before
    if (onboardingComplete) {
      // Returning user - go straight to categories
      assessLoadDemoProfile(1);
      setScreen('categories');
    } else {
      // New user - start onboarding flow
      setScreen('onboarding');
    }
  };

  const handleAIEntry = () => {
    localStorage.setItem('aura-entity-declared', JSON.stringify({ type: 'ai', model: null, ts: Date.now() }));
    localStorage.setItem('aura_entity_context', JSON.stringify({ type: 'ai' }));
    setEntityType('ai');
    // Continue into the same flow as "Let's Go"
    handleTryFirst();
  };

  // Handle onboarding completion
  const handleOnboardingComplete = (answers) => {
    // Normalize to flat { 'onboard-1': 0, ... } format for viz component
    const flat = {};
    for (const [key, val] of Object.entries(answers)) {
      flat[key] = typeof val === 'object' && val !== null ? val.answer : val;
    }
    setOnboardingAnswers(flat);
    localStorage.setItem(ONBOARD_STORAGE_KEY, JSON.stringify(flat));
    localStorage.setItem('aura_onboarding_complete', 'true');
    setOnboardingComplete(true);
    // Entity type already set by getInitialScreen (defaults to human, or AI via URL param)
    // Auto-start Quick Profile instead of path choice
    if (!assessCompleted['quick-profile']) {
      assessStartTest('quick-profile');
    } else {
      setScreen('assess-picker');
    }
  };

  // Handle path choice after onboarding
  const handleChooseReveal = () => {
    // Check if user needs to complete Quick Profile first
    const currentTier = calculateAssessTier(assessCompleted);
    if (currentTier === 0 && !assessCompleted['quick-profile']) {
      // First time - go directly to Quick Profile
      assessStartTest('quick-profile');
    } else {
      setScreen('assess-picker');
    }
  };

  const handleChooseExplore = () => {
    setScreen('categories');
  };

  const handleSignIn = (email) => {
    localStorage.removeItem('aura_guest_mode');
    setIsGuestMode(false);
    // Land on assessment profile for logged-in users
    setScreen('assess-picker');
  };

  const handleCreateAccount = (email) => {
    localStorage.removeItem('aura_guest_mode');
    setIsGuestMode(false);
    // Claims + migration handled by onAuthStateChange listener
    setScreen('assess-picker');
  };

  const handleNudgeLater = () => {
    localStorage.setItem('aura_nudge_shown', 'true');
    setNudgeShown(true);
    setShowSaveNudge(false);
  };

  const handleNudgeCreateAccount = () => {
    setShowSaveNudge(false);
    setScreen('welcome');
  };

  // Check if we should show nudge (20 NEW responses for guests since entering guest mode)
  const responseCount = Object.keys(responses).length;
  const guestStartCountRef = React.useRef(null);

  // Set start count when entering guest mode
  React.useEffect(() => {
    if (isGuestMode && guestStartCountRef.current === null) {
      guestStartCountRef.current = responseCount;
    } else if (!isGuestMode) {
      guestStartCountRef.current = null;
    }
  }, [isGuestMode, responseCount]);

  React.useEffect(() => {
    if (isGuestMode && !nudgeShown && !authUser && guestStartCountRef.current !== null) {
      const newResponses = responseCount - guestStartCountRef.current;
      if (newResponses >= 20) {
        setShowSaveNudge(true);
      }
    }
  }, [responseCount, isGuestMode, nudgeShown]);

  const resetDemo = () => {
    // Sign out any logged-in user first
    signOut();
    // Mark as reset (preserves settings but clears data)
    demoStorage.markReset();
    // Use truly empty state (not pre-filled demo data)
    setResponses({});
    setCommunityResults(generateDemoCommunityResults());
    setStats({ answered: 0, streak: 0, lastAnswerDate: null, xp: 0, level: 1 });
    setCurrentIndex(0);
    setShowGestureHint(true);
    setLevelUpData(null);
    setQotdResponse(null);
    setQotdTappedAnswer(null);
    setQotdTapCount(0);
    // Clear all guest/login tracking
    localStorage.removeItem('aura_guest_mode');
    localStorage.removeItem('aura_nudge_shown');
    localStorage.removeItem('aura_onboarding_complete');
    localStorage.removeItem(ONBOARD_STORAGE_KEY);
    setIsGuestMode(false);
    setNudgeShown(false);
    setOnboardingComplete(false);
    setOnboardingAnswers({});
    // Clear assessments
    localStorage.removeItem(ASSESS_STORAGE_KEY);
    setAssessCompleted({});
    setAssessInProgress({});
    setAssessResponses({});
    setAssessSkipped([]);
    setAssessDemoActive(false);
    setAssessDemoProfile(null);
    setAssessSavedUserData(null);
    setScreen('welcome');
  };

  const renderContent = () => {
    // Screen routing â€” all screens are extracted components
    //   welcome         â†’ WelcomeScreen
    //   onboarding      â†’ OnboardingFlow
    //   path-choice     â†’ PathChoiceScreen
    //   launch          â†’ LaunchScreen
    //   settings        â†’ SettingsScreen
    //   profile         â†’ ProfileScreen
    //   history         â†’ HistoryScreen
    //   qotd            â†’ QotdScreen
    //   entity-gate     â†’ EntityGateScreen (shown once before welcome)
    //   assess-picker   â†’ AssessPickerScreen
    //   assess-question â†’ AssessQuestionScreen
    //   assess-results  â†’ AssessResultsScreen
    //   assess-analysis â†’ AssessAnalysisScreen
    //   verify-*        â†’ Verify* components
    //   public-profile  â†’ PublicProfileScreen (read-only, no auth)
    //   compare         â†’ Compare Auras (URL-encoded trait comparison)
    //   categories      â†’ CategoryScreen (home/hub)
    //   (default)       â†’ QuestionFlowScreen

    // Entity gate â€” shown once to new visitors, guards welcome screen
    if (screen === 'entity-gate') return (
      <EntityGateScreen
        darkMode={darkMode}
        onDeclare={(type, model) => {
          // Apply declared entity type to app state
          setEntityType(type === 'unknown' ? 'human' : type);
          setEntityModelName(model || null);
          // Persist entity type to demo storage so other parts of app can read it
          const stored = demoStorage.get();
          stored.entityType = type === 'unknown' ? 'human' : type;
          demoStorage.set(stored);
          // If user is already signed in, update profile immediately
          const user = getCurrentUser();
          if (user) updateEntityProfile(user.id, type === 'unknown' ? 'human' : type, model);
          setScreen('welcome');
        }}
      />
    );

    // Public profile (shared link)
    if (screen === 'public-profile') return (
      <PublicProfileScreen
        darkMode={darkMode}
        profileId={publicProfileId}
        onCreateAccount={() => {
          // Clear ?p= param and go to welcome
          window.history.replaceState({}, '', window.location.pathname);
          setScreen('welcome');
        }}
      />
    );

    // Compare Auras â€” URL-encoded trait comparison
    if (screen === 'compare') return (() => {
      if (compareLoading) return (
        <div className={`h-full flex items-center justify-center ${TH('bg-main', darkMode)}`}>
          <div className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>Loading comparison...</div>
        </div>
      );
      const theirData = compareData;
      const myResults = assessCompleted['quick-profile'];
      const myTraits = myResults?.traits;
      const traitLabels = { E: ['Reserved', 'Outgoing'], A: ['Direct', 'Empathetic'], C: ['Flexible', 'Organized'], N: ['Steady', 'Sensitive'], O: ['Practical', 'Curious'] };
      const traitColors = { E: ['#6366f1', '#f59e0b'], A: ['#3b82f6', '#ec4899'], C: ['#8b5cf6', '#10b981'], N: ['#06b6d4', '#f97316'], O: ['#64748b', '#a855f7'] };

      const theirName = theirData?.name || 'Friend';
      const myName = displayName || 'You';
      const theirInitial = theirName[0].toUpperCase();
      const myInitial = myName === 'You' ? 'Y' : myName[0].toUpperCase();

      // Share URL generation â€” async, cached
      let _compareIdCache = null;
      const getShareUrl = async () => {
        if (!myTraits) return null;
        if (_compareIdCache) return getCompareUrl(_compareIdCache);
        const id = await createComparison(myTraits, displayName, entityType);
        if (id) {
          _compareIdCache = id;
          return getCompareUrl(id);
        }
        // Fallback to legacy base64 if Supabase fails
        return `${window.location.origin}${window.location.pathname}?compare=${btoa(JSON.stringify({ traits: myTraits, entity: entityType, name: displayName || undefined }))}`;
      };
      const myShareText = `${displayName ? displayName + "'s" : 'My'} Aura â€” compare yours`;
      const socialBtn = `px-3.5 py-2 rounded-xl text-xs font-medium transition-all btn-feedback`;

      // Trait bar renderer â€” reused for both real comparison and preview
      const TraitBars = ({ traits1, traits2, name1, name2, initial1, initial2, isPreview }) => (
        <div className="space-y-3">
          {Object.entries(traits1).map(([key, val1]) => {
            const labels = traitLabels[key];
            const colors = traitColors[key];
            if (!labels) return null;
            const val2 = traits2?.[key];
            return (
              <div key={key}>
                <div className="flex justify-between mb-1">
                  <span className={`text-[11px] font-medium ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>{labels[0]}</span>
                  <span className={`text-[11px] font-medium ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>{labels[1]}</span>
                </div>
                <div className="h-3 rounded-full relative" style={{ background: `linear-gradient(to right, ${colors[0]}${darkMode ? '40' : '30'}, ${colors[1]}${darkMode ? '40' : '30'})` }}>
                  {/* Person 1 dot */}
                  <div className="absolute top-1/2 -translate-y-1/2 flex items-center justify-center w-5 h-5 rounded-full bg-white border-2 border-white text-[8px] font-bold text-gray-800"
                    style={{ left: `${Math.max(5, Math.min(95, val1))}%`, marginLeft: -10, boxShadow: '0 1px 4px rgba(0,0,0,0.35)', opacity: isPreview ? 0.5 : 1 }}>
                    {initial1}
                  </div>
                  {/* Person 2 dot */}
                  {val2 !== undefined && (
                    <div className="absolute top-1/2 -translate-y-1/2 flex items-center justify-center w-5 h-5 rounded-full bg-violet-500 border-2 border-violet-400 text-[8px] font-bold text-white"
                      style={{ left: `${Math.max(5, Math.min(95, val2))}%`, marginLeft: -10, boxShadow: '0 1px 4px rgba(0,0,0,0.35)' }}>
                      {initial2}
                    </div>
                  )}
                </div>
              </div>
            );
          })}
          <div className="flex items-center gap-5 mt-2 justify-center">
            <div className="flex items-center gap-1.5">
              <div className="w-4 h-4 rounded-full bg-white border-2 border-white flex items-center justify-center text-[7px] font-bold text-gray-800" style={{ opacity: isPreview ? 0.5 : 1 }}>{initial1}</div>
              <span className={`text-[11px] ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>{name1}</span>
            </div>
            {traits2 && (
              <div className="flex items-center gap-1.5">
                <div className="w-4 h-4 rounded-full bg-violet-500 border-2 border-violet-400 flex items-center justify-center text-[7px] font-bold text-white">{initial2}</div>
                <span className={`text-[11px] ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>{name2}</span>
              </div>
            )}
          </div>
        </div>
      );

      // Social share buttons â€” async URL generation
      const SocialShare = ({ text }) => {
        const btnClass = `${socialBtn} ${darkMode ? 'bg-white/[0.08] text-gray-300 hover:bg-white/[0.15]' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`;
        const share = async (handler) => {
          const url = await getShareUrl();
          if (url) handler(url);
        };
        return (
          <div className="flex items-center justify-center gap-2 flex-wrap">
            <button onClick={() => share(url => window.open(`https://x.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`, '_blank'))}
              className={btnClass}>ð• Post</button>
            <button onClick={() => share(url => window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}&quote=${encodeURIComponent(text)}`, '_blank'))}
              className={btnClass}>FB Share</button>
            {typeof navigator.share === 'function' && (
              <button onClick={() => share(async url => {
                try { await navigator.share({ title: 'Compare Auras', text, url }); } catch (_) {}
              })}
                className={btnClass}>
                ðŸ’¬ Text
              </button>
            )}
            <button onClick={async (e) => {
              const btn = e.currentTarget;
              const url = await getShareUrl();
              if (!url) return;
              try { await navigator.clipboard.writeText(`${text}\n${url}`); } catch (_) {}
              const orig = btn.textContent;
              btn.textContent = 'âœ“ Copied';
              setTimeout(() => { btn.textContent = orig; }, 2000);
            }}
              className={btnClass}>ðŸ“‹ Copy</button>
          </div>
        );
      };

      return (
        <div className={`h-full flex flex-col ${TH('bg-main', darkMode)}`}>
          <div className={`h-[44px] flex-shrink-0 flex items-center px-4 border-b ${TH('border-base', darkMode)}`}>
            <button onClick={() => { window.history.replaceState({}, '', window.location.pathname); setScreen(myTraits ? 'assess-picker' : 'welcome'); }} className={`text-lg ${TH('text-dim', darkMode)}`}>â†</button>
            <span className={`flex-1 text-center font-medium ${TH('text-primary', darkMode)}`}>Compare Auras</span>
            <div className="w-6" />
          </div>
          <div className="flex-1 overflow-auto p-4 space-y-4 hide-scrollbar">
            {/* REAL COMPARISON â€” someone opened a shared link */}
            {theirData && (
              <div className={`rounded-2xl p-5 ${darkMode ? 'bg-white/[0.04] border border-white/[0.08]' : 'bg-gray-50 border border-gray-200'}`}>
                <div className={`text-base font-semibold mb-1 ${TH('text-primary', darkMode)}`}>
                  {theirName}{theirData.entity === 'ai' ? <span className="ml-2 text-xs text-cyan-400">AI</span> : ''} {myTraits ? `vs ${myName}` : ''}
                </div>
                <p className={`text-xs mb-4 ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>Big Five personality traits</p>
                <TraitBars
                  traits1={theirData.traits || {}}
                  traits2={myTraits}
                  name1={theirName}
                  name2={myName}
                  initial1={theirInitial}
                  initial2={myInitial}
                />
              </div>
            )}

            {/* NO TRAITS YET â€” prompt to take assessment */}
            {!myTraits && !theirData ? (
              <div className="text-center space-y-4 pt-8">
                <div className="text-4xl">âœ¨</div>
                <div className={`text-lg font-semibold ${TH('text-primary', darkMode)}`}>Take the assessment to compare</div>
                <p className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>Complete your Quick Profile to see how your aura compares.</p>
                <button onClick={() => { window.history.replaceState({}, '', window.location.pathname); setScreen('welcome'); }}
                  className="px-6 py-3 rounded-xl bg-gradient-to-r from-blue-500 to-violet-500 text-white font-medium">
                  Get started
                </button>
              </div>
            ) : !myTraits && theirData ? (
              /* RECEIVED a comparison link but haven't taken assessment yet */
              <div className="text-center space-y-4 pt-4">
                <div className={`text-base font-semibold ${TH('text-primary', darkMode)}`}>Take the quiz to see how you compare with {theirName}</div>
                <button onClick={() => { setScreen('welcome'); }}
                  className="px-6 py-3 rounded-xl bg-gradient-to-r from-blue-500 to-violet-500 text-white font-medium">
                  Get started
                </button>
              </div>
            ) : myTraits && !theirData ? (
              /* HAS TRAITS but no comparison â€” share flow */
              <div className="space-y-5 pt-1">
                <div className="text-center space-y-3">
                  <div className={`text-base font-semibold ${TH('text-primary', darkMode)}`}>Challenge a friend to compare</div>
                  <p className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>They'll take the Quick Profile and see how you match up</p>
                </div>
                <SocialShare text={myShareText} />
                {/* Preview using simulated friend */}
                <div className={`rounded-2xl p-4 mt-2 ${darkMode ? 'bg-white/[0.04] border border-white/[0.08]' : 'bg-gray-50 border border-gray-200'}`}>
                  <div className={`text-xs font-medium uppercase tracking-wide mb-3 ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>What it looks like</div>
                  <TraitBars
                    traits1={Object.fromEntries(Object.entries(myTraits).map(([k, v]) => [k, Math.max(5, Math.min(95, v + (k === 'E' ? 25 : k === 'A' ? -20 : k === 'N' ? 15 : k === 'O' ? -10 : 12)))]))}
                    traits2={myTraits}
                    name1="Friend"
                    name2={myName}
                    initial1="F"
                    initial2={myInitial}
                    isPreview={true}
                  />
                </div>
              </div>
            ) : (
              /* BOTH HAVE DATA â€” comparison is showing above, add share to compare with someone else */
              <div className="space-y-3">
                <div className={`text-center text-sm ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>Challenge someone else?</div>
                <SocialShare text={myShareText} />
              </div>
            )}
          </div>
        </div>
      );
    })();

    // Welcome screen
    if (screen === 'welcome') return (
      <WelcomeScreen
        onSignIn={handleSignIn}
        onCreateAccount={handleCreateAccount}
        onTryFirst={handleTryFirst}
        onAI={handleAIEntry}
        darkMode={darkMode}
      />
    );

    // Onboarding screen
    if (screen === 'onboarding') return (
      <OnboardingFlow
        darkMode={darkMode}
        onComplete={handleOnboardingComplete}
        onSkip={() => setScreen('categories')}
        onSettings={goToSettings}
        onReset={resetDemo}
      />
    );

    // Path choice screen
    if (screen === 'path-choice') return (
      <PathChoiceScreen
        darkMode={darkMode}
        entityType={entityType}
        onboardingAnswers={onboardingAnswers}
        onReveal={handleChooseReveal}
        onExplore={handleChooseExplore}
        onSkip={() => setScreen('categories')}
        onSettings={goToSettings}
        onReset={resetDemo}
      />
    );

    // Launch screen
    if (screen === 'launch') return <LaunchScreen onDemo={startDemo} onLogin={() => {}} darkMode={darkMode} />;

    // Settings screen
    if (screen === 'settings') return (
      <SettingsScreen
        darkMode={darkMode}
        setDarkMode={setDarkMode}
        undoDelay={undoDelay}
        setUndoDelay={setUndoDelay}
        requireConfirmation={requireConfirmation}
        setRequireConfirmation={setRequireConfirmation}
        showTips={showTips}
        setShowTips={setShowTips}
        showStreak={showStreak}
        setShowStreak={setShowStreak}
        showDemoControls={showDemoControls}
        setShowDemoControls={(val) => {
          setShowDemoControls(val);
          assessSaveToStorage(assessCompleted, assessInProgress, assessDemoActive, assessSavedUserData, assessDemoProfile, val);
        }}
        entityType={entityType}
        setEntityType={setEntityType}
        onBack={() => setScreen(previousScreen)}
        onReset={resetDemo}
        onResetAssessments={() => {
          localStorage.removeItem(ASSESS_STORAGE_KEY);
          setAssessCompleted({});
          setAssessInProgress({});
          setAssessResponses({});
          setAssessSkipped([]);
        }}
        hasAssessmentData={Object.keys(assessCompleted).length > 0 || Object.keys(assessInProgress).length > 0}
        onHistory={() => setScreen('history')}
        onResetVerification={() => {
          localStorage.removeItem(VERIFY_STORAGE_KEY);
          localStorage.removeItem(IDENTITY_STORAGE_KEY);
          localStorage.removeItem(IDENTITY_ONBOARDING_KEY);
          setVerifyEvaluations({});
          setVerifyEvaluatorData(null);
          setVerifyCurrentSubjectId(null);
        }}
        hasVerificationData={Object.keys(verifyEvaluations).length > 0}
        verifyExpertMode={verifyExpertMode}
        setVerifyExpertMode={setVerifyExpertMode}
      />
    );

    if (screen === 'profile') {
      const demoProfile = assessDemoActive && assessDemoProfile ? ASSESS_DEMO_PROFILES[assessDemoProfile] : null;
      const demoOverrides = demoProfile ? { name: demoProfile.name, claims: demoProfile.claims || [] } : null;
      return (
        <ProfileScreen darkMode={darkMode} responses={responses} assessCompleted={assessCompleted}
          stats={stats} entityType={entityType} onboardingAnswers={onboardingAnswers}
          userClaims={userClaims} onClaimsChange={setUserClaims}
          demoOverrides={demoOverrides}
          onNavigate={(scr, opts) => {
            if (opts?.testId) setAssessCurrentTestId(opts.testId);
            setScreen(scr);
          }} />
      );
    }

    if (screen === 'identity') {
      const demoProfile = assessDemoActive && assessDemoProfile ? ASSESS_DEMO_PROFILES[assessDemoProfile] : null;
      return (
        <IdentityScreen darkMode={darkMode}
          userClaims={demoProfile?.claims || userClaims} onClaimsChange={demoProfile ? () => {} : setUserClaims}
          assessCompleted={assessCompleted} entityType={entityType}
          displayName={demoProfile?.name || displayName}
          onBack={() => setScreen('profile')} />
      );
    }

    if (screen === 'history') return (
      <HistoryScreen darkMode={darkMode} questions={questions} responses={responses}
        communityResults={communityResults} questionFlags={questionFlags}
        answerExplanations={answerExplanations} onBack={() => setScreen('settings')} />
    );

    if (screen === 'qotd') return (
      <QotdScreen darkMode={darkMode} qotdData={qotdData} qotdResponse={qotdResponse}
        qotdTappedAnswer={qotdTappedAnswer} qotdTapCount={qotdTapCount}
        onTap={handleQotdTap} onSubmit={submitQotdAnswer}
        onClear={() => { setQotdTappedAnswer(null); setQotdTapCount(0); }}
        onBack={() => setScreen('categories')}
        onGoToQuestions={() => {
          const firstUnanswered = questions.findIndex(q => !responses[q.id]);
          if (firstUnanswered >= 0) { setCurrentIndex(firstUnanswered); setScreen('questions'); }
          else { setScreen('categories'); }
        }} />
    );

    // ==================== ASSESSMENT SCREENS ====================
    if (screen === 'assess-picker') {
      // Auto-start gateway for first-time users â€” skip the picker entirely
      const currentTier = calculateAssessTier(assessCompleted);
      if (currentTier === 0 && !assessCompleted['quick-profile'] && entityType !== 'ai') {
        assessStartTest('quick-profile');
        return null;
      }
      const assessNavigate = (scr, opts) => {
        if (opts?.testId) setAssessCurrentTestId(opts.testId);
        setScreen(scr);
      };
      return (
        <AssessPickerScreen
          darkMode={darkMode} entityType={entityType} showDemoControls={showDemoControls}
          assessCompleted={assessCompleted} assessInProgress={assessInProgress}
          assessExpandedCategory={assessExpandedCategory} assessProfileSwitching={assessProfileSwitching}
          assessShowDemoMenu={assessShowDemoMenu} assessDemoActive={assessDemoActive}
          assessDemoProfile={assessDemoProfile} assessSavedUserData={assessSavedUserData}
          assessShowDemoInfo={assessShowDemoInfo}
          onSetExpandedCategory={setAssessExpandedCategory} onSetShowDemoMenu={setAssessShowDemoMenu}
          onSetShowDemoInfo={setAssessShowDemoInfo}
          onStartTest={assessStartTest} onLoadDemoProfile={assessLoadDemoProfile}
          onClearDemo={assessClearDemo} onClearAll={assessClearAll}
          onNavigate={assessNavigate}
        />
      );
    }

    // Assessment Question Screen
    if (screen === 'assess-question') {
      if (!assessCurrentTest) return null;
      return (
        <AssessQuestionScreen
          darkMode={darkMode}
          assessCurrentTest={assessCurrentTest}
          assessCurrentIndex={assessCurrentIndex}
          assessTotalQuestions={assessTotalQuestions}
          assessGatewayActiveItems={assessGatewayActiveItems}
          assessResponses={assessResponses}
          assessSkipped={assessSkipped}
          assessCurrentScale={assessCurrentScale}
          assessSwipeHandlers={assessSwipeHandlers}
          assessShowCompletion={assessShowCompletion}
          assessUnlockMessage={assessUnlockMessage}
          assessShowUndoToast={assessShowUndoToast}
          assessShowExitConfirm={assessShowExitConfirm}
          assessPending={assessPending}
          assessEntering={assessEntering}
          assessTestColor={assessTestColor}
          undoDelay={undoDelay}
          canFinish={assessCanFinish}
          onFinishAssessment={assessFinishAssessment}
          onSaveAndExit={assessSaveAndExit}
          onGoToQuestion={assessGoToQuestion}
          onHandleAnswerTap={assessHandleAnswerTap}
          onHandleUndo={assessHandleUndo}
          onFinalizeSubmit={assessFinalizeSubmit}
          onSetShowExitConfirm={setAssessShowExitConfirm}
          onSetPending={setAssessPending}
          onExitWithoutSaving={() => {
            setAssessShowExitConfirm(false);
            clearTimeout(assessTimeoutRef.current);
            setAssessPending(null);
            setScreen('assess-picker');
          }}
        />
      );
    }

    // Assessment Results Screen
    if (screen === 'assess-results') {
      const test = ASSESS_TESTS[assessCurrentTestId];
      if (!test) { setScreen('assess-picker'); return null; }
      return (
        <AssessResultsScreen
          darkMode={darkMode}
          assessCurrentTestId={assessCurrentTestId}
          assessCompleted={assessCompleted}
          entityType={entityType}
          entityModelName={entityModelName}
          onboardingAnswers={onboardingAnswers}
          displayName={displayName}
          onNavigate={(scr) => { setAssessNudgeData(null); setScreen(scr); }}
          nudgeData={assessNudgeData}
          onNudgeContinue={(testId) => {
            setAssessNudgeData(null);
            assessStartTest(testId);
          }}
          onSaveSuccess={() => setAuthUser(getCurrentUser())}
        />
      );
    }

    // Assessment Analysis Screen
    if (screen === 'assess-analysis') {
      return (
        <AssessAnalysisScreen
          darkMode={darkMode}
          assessCompleted={assessCompleted}
          entityType={entityType}
          onboardingAnswers={onboardingAnswers}
          analysisExpanded={analysisExpanded}
          setAnalysisExpanded={setAnalysisExpanded}
          onNavigate={(scr, opts) => {
            if (opts?.testId) setAssessCurrentTestId(opts.testId);
            setScreen(scr);
          }}
        />
      );
    }

    // Verification screens
    if (screen === 'verify-hub') {
      // Show expert mode prompt after 3rd completion
      const showExpertPrompt = verifyCompletedCount >= 3 && !verifyExpertMode && verifyExpertPromptShown;
      return (<>
        <VerifyHub darkMode={darkMode} subjects={VERIFY_MOCK_SUBJECTS} evaluations={verifyEvaluations}
          expertMode={verifyExpertMode} setExpertMode={setVerifyExpertMode} completedCount={verifyCompletedCount}
          onSelect={(id) => { setVerifyCurrentSubjectId(id); setScreen('verify-evaluator'); }}
          onViewCompleted={(id) => { setVerifyCurrentSubjectId(id); setVerifyEvaluatorData(verifyEvaluations[id]); setScreen('verify-eval-summary-readonly'); }}
          onBack={() => setScreen('categories')} />
        {showExpertPrompt && (
          <div className="fixed inset-0 z-[9999] flex items-center justify-center bg-black/60 backdrop-blur-sm"
            onClick={() => { setVerifyExpertPromptShown(false); try { localStorage.setItem(VERIFY_EXPERT_KEY + '-dismissed', 'true'); } catch {} }}>
            <div className={`mx-6 p-5 rounded-2xl max-w-sm ${darkMode ? 'bg-gray-900 border border-white/10' : 'bg-white border border-gray-200 shadow-xl'}`}
              onClick={e => e.stopPropagation()} style={{ animation: 'fadeSlideIn 0.3s ease-out both' }}>
              <div className={`text-base font-semibold mb-2 ${TH('text-primary', darkMode)}`}>Switch to Express Mode?</div>
              <p className={`text-sm mb-4 ${TH('text-muted', darkMode)}`}>
                You've completed {verifyCompletedCount} evaluations. Want to switch to a compact single-form layout?
              </p>
              <div className="flex gap-2">
                <button onClick={() => { setVerifyExpertMode(true); setVerifyExpertPromptShown(false); try { localStorage.setItem(VERIFY_EXPERT_KEY + '-dismissed', 'true'); } catch {} }}
                  className="flex-1 py-2.5 rounded-xl text-sm font-semibold bg-amber-500/20 text-amber-400 border border-amber-500/30">
                  Enable Express Mode
                </button>
                <button onClick={() => { setVerifyExpertPromptShown(false); try { localStorage.setItem(VERIFY_EXPERT_KEY + '-dismissed', 'true'); } catch {} }}
                  className={`flex-1 py-2.5 rounded-xl text-sm ${TH('text-subtle', darkMode)}`}>
                  Not now
                </button>
              </div>
            </div>
          </div>
        )}
      </>);
    }
    if (screen === 'verify-evaluator') {
      const subj = verifyCurrentSubjectId ? VERIFY_MOCK_SUBJECTS.find(s => s.id === verifyCurrentSubjectId) : null;
      if (!subj) { setScreen('verify-hub'); return null; }
      const sharedFlowProps = {
        sharedPath: verifyFlowPath, setSharedPath: setVerifyFlowPath,
        sharedAnswers: verifyFlowAnswers, setSharedAnswers: setVerifyFlowAnswers,
        expertMode: verifyExpertMode, setExpertMode: setVerifyExpertMode,
        completedCount: verifyCompletedCount,
      };
      const handleBack = () => { setVerifyFlowPath(null); setVerifyFlowAnswers({}); setScreen('verify-hub'); };
      return verifyExpertMode ? (
        <VerifyExpertForm darkMode={darkMode} subject={subj} {...sharedFlowProps}
          onComplete={(data) => {
            setVerifyEvaluations(prev => ({ ...prev, [verifyCurrentSubjectId]: { ...data, completedAt: Date.now() } }));
            setVerifyEvaluatorData(null);
            setVerifyCurrentSubjectId(null);
            setVerifyFlowPath(null); setVerifyFlowAnswers({});
            setScreen('verify-hub');
          }}
          onBack={handleBack} />
      ) : (
        <VerifyEvaluatorFlow darkMode={darkMode} subject={subj} {...sharedFlowProps}
          onComplete={(data) => { setVerifyEvaluatorData(data); setScreen('verify-eval-summary'); }}
          onBack={handleBack} />
      );
    }
    if (screen === 'verify-eval-summary') {
      if (!verifyEvaluatorData || !verifyCurrentSubjectId) { setScreen('verify-hub'); return null; }
      const subj = VERIFY_MOCK_SUBJECTS.find(s => s.id === verifyCurrentSubjectId);
      return (
        <VerifyEvalSummary darkMode={darkMode} data={verifyEvaluatorData} subject={subj}
          onSubmit={() => {
            setVerifyEvaluations(prev => ({ ...prev, [verifyCurrentSubjectId]: { ...verifyEvaluatorData, completedAt: Date.now() } }));
            setVerifyEvaluatorData(null);
            setVerifyCurrentSubjectId(null);
            setVerifyFlowPath(null); setVerifyFlowAnswers({});
            // Auto-prompt expert mode after 3 completions (once only)
            const newCount = Object.keys(verifyEvaluations).length + 1;
            const wasDismissed = (() => { try { return localStorage.getItem(VERIFY_EXPERT_KEY + '-dismissed') === 'true'; } catch { return false; } })();
            if (newCount >= 3 && !verifyExpertMode && !verifyExpertPromptShown && !wasDismissed) {
              setVerifyExpertPromptShown(true);
              try { localStorage.setItem(VERIFY_EXPERT_KEY + '-prompted', 'true'); } catch {}
            }
            setScreen('verify-hub');
          }}
          onBack={() => setScreen('verify-evaluator')} />
      );
    }

    if (screen === 'verify-eval-summary-readonly') {
      if (!verifyCurrentSubjectId || !verifyEvaluatorData) { setScreen('verify-hub'); return null; }
      const subj = VERIFY_MOCK_SUBJECTS.find(s => s.id === verifyCurrentSubjectId);
      return (
        <VerifyEvalSummary darkMode={darkMode} data={verifyEvaluatorData} subject={subj} readOnly
          onBack={() => { setVerifyEvaluatorData(null); setVerifyCurrentSubjectId(null); setScreen('verify-hub'); }} />
      );
    }

    // Categories screen (home)
    if (screen === 'categories') return (
      <CategoryScreen
        darkMode={darkMode}
        categories={CATEGORIES}
        questions={questions}
        responses={responses}
        onSelectCategory={handleSelectCategory}
        onSettings={goToSettings}
        onProfile={() => setScreen('profile')}
        stats={stats}
        qotdData={qotdData}
        qotdResponse={qotdResponse}
        onQotdClick={() => setScreen('qotd')}
        onResetQotd={resetDemo}
        onAssessments={() => setScreen('assess-picker')}
        onAssessSurprise={() => {
          const tier = calculateAssessTier(assessCompleted);
          const allTests = Object.entries(ASSESS_CATEGORIES)
            .filter(([_, cat]) => (cat.tier || 0) <= tier && (!cat.entityHint || cat.entityHint === entityType))
            .flatMap(([_, cat]) => cat.tests);
          const available = allTests.filter(id => !assessCompleted[id] && ASSESS_TESTS[id]);
          if (available.length > 0) {
            assessStartTest(available[Math.floor(Math.random() * available.length)]);
          } else {
            setScreen('assess-picker');
          }
        }}
        assessCompleted={assessCompleted}
        isLoggedIn={!!authUser}
        onVerify={() => setScreen('verify-hub')}
        verifyPendingCount={verifyPendingCount}
      />
    );

    return (
      <QuestionFlowScreen
        darkMode={darkMode}
        currentQuestion={currentQuestion}
        currentIndex={currentIndex}
        questions={questions}
        responses={responses}
        currentResults={currentResults}
        communityResults={communityResults}
        setCommunityResults={setCommunityResults}
        isAnswered={isAnswered}
        isBinary={isBinary}
        answeredCount={answeredCount}
        totalQuestions={totalQuestions}
        currentResponse={currentResponse}
        swipeHandlers={swipeHandlers}
        mcColorMode={mcColorMode}
        setMcColorMode={setMcColorMode}
        pendingSubmit={pendingSubmit}
        undoDelay={undoDelay}
        handleUndo={handleUndo}
        goToPrev={goToPrev}
        goToNext={goToNext}
        findNextUnanswered={findNextUnanswered}
        setCurrentIndex={setCurrentIndex}
        selectedTrack={selectedTrack}
        setSelectedTrack={setSelectedTrack}
        showSavedToast={showSavedToast}
        sessionAnsweredIds={sessionAnsweredIds}
        questionFlags={questionFlags}
        answerExplanations={answerExplanations}
        evidenceExpanded={evidenceExpanded}
        setEvidenceExpanded={setEvidenceExpanded}
        justUndone={justUndone}
        clearUndoneState={clearUndoneState}
        showTips={showTips}
        showGestureHint={showGestureHint}
        setShowGestureHint={setShowGestureHint}
        showConfirmOverlay={showConfirmOverlay}
        confirmColor={confirmColor}
        tappedAnswer={tappedAnswer}
        setTappedAnswer={setTappedAnswer}
        tapCount={tapCount}
        setTapCount={setTapCount}
        submitAnswer={submitAnswer}
        handleAnswerTap={handleAnswerTap}
        handleAnswerRightClick={handleAnswerRightClick}
        savedQuestions={savedQuestions}
        saveForLater={saveForLater}
        skipQuestion={skipQuestion}
        showFullResults={showFullResults}
        setShowFullResults={setShowFullResults}
        showQuestionFlagModal={showQuestionFlagModal}
        setShowQuestionFlagModal={setShowQuestionFlagModal}
        showExplanationModal={showExplanationModal}
        setShowExplanationModal={setShowExplanationModal}
        showCantAnswerModal={showCantAnswerModal}
        setShowCantAnswerModal={setShowCantAnswerModal}
        showNoneOptionModal={showNoneOptionModal}
        setShowNoneOptionModal={setShowNoneOptionModal}
        handleQuestionFlag={handleQuestionFlag}
        handleClearQuestionFlag={handleClearQuestionFlag}
        handleSaveExplanation={handleSaveExplanation}
        handleClearExplanation={handleClearExplanation}
        setQuestionFlags={setQuestionFlags}
        setSkippedQuestions={setSkippedQuestions}
        communityBrowseIndex={communityBrowseIndex}
        setCommunityBrowseIndex={setCommunityBrowseIndex}
        communityDisplayMode={communityDisplayMode}
        setCommunityDisplayMode={setCommunityDisplayMode}
        communityExpanded={communityExpanded}
        setCommunityExpanded={setCommunityExpanded}
        assessCompleted={assessCompleted}
      />
    );
  };

  // ==================== DEV NAVIGATION PANEL ====================
  const DEV_SCREENS = [
    { id: 'entity-gate', label: 'Gate', icon: 'ðŸšª' },
    { id: 'welcome', label: 'Welcome', icon: 'ðŸ‘‹' },
    { id: 'onboarding', label: 'Onboard', icon: 'ðŸŽ¯' },
    { id: 'path-choice', label: 'Path', icon: 'ðŸ”€' },
    { id: 'categories', label: 'Home', icon: 'ðŸ ' },
    { id: 'question', label: 'Question', icon: 'â“' },
    { id: 'qotd', label: 'QotD', icon: 'ðŸŒ€' },
    { id: 'profile', label: 'Profile', icon: 'ðŸ‘¤' },
    { id: 'settings', label: 'Settings', icon: 'âš™ï¸' },
    { id: 'history', label: 'History', icon: 'ðŸ“œ' },
    { id: 'assess-picker', label: 'Assess', icon: 'ðŸ“‹' },
    { id: 'assess-question', label: 'Assess Q', icon: 'ðŸ“' },
    { id: 'assess-results', label: 'Results', icon: 'ðŸ“Š' },
    { id: 'assess-analysis', label: 'Analysis', icon: 'ðŸ”¬' },
    { id: 'launch', label: 'Launch', icon: 'ðŸš€' },
    { id: 'verify-hub', label: 'V:Hub', icon: 'ðŸ›¡ï¸' },
    { id: 'verify-evaluator', label: 'V:Eval', icon: 'ðŸ”' },
    { id: 'verify-eval-summary', label: 'V:Sum', icon: 'ðŸ“Š' },
    { id: 'public-profile', label: 'Pub Prof', icon: 'ðŸ”—' },
    { id: 'compare', label: 'Compare', icon: 'âš–ï¸' },
  ];

  // â”€â”€ Dev Q&A Channel â”€â”€
  // Claude maintains this array. Each question auto-navigates to the relevant screen.
  // When Philip answers in-app, the answer is saved to localStorage and the question disappears.
  // Claude removes answered questions and adds new ones each session.
  // tier: 'big' = decisions that change what gets built. 'little' = polish details, opt-in.
  const DEV_QUESTIONS = [
    // â”€â”€ All caught up. Load new questions when new design topics emerge. â”€â”€
  ];

  const [devQASkipped, setDevQASkipped] = useState([]);
  const devPendingQs = (() => {
    const unanswered = DEV_QUESTIONS.filter(q => !devQAAnswers[q.id] && (devQATier === 'little' || q.tier === 'big'));
    const notSkipped = unanswered.filter(q => !devQASkipped.includes(q.id));
    const skipped = unanswered.filter(q => devQASkipped.includes(q.id));
    return [...notSkipped, ...skipped];
  })();
  const devQAHelpers = { setScreen, setEntityType, assessStartTest, assessGoToQuestion, setAssessCurrentTestId, setDarkMode, setCurrentIndex, setMcColorMode, setAssessCurrentIndex: (i) => assessGoToQuestion(i, 'fwd') };

  // Auto-navigate to the first pending question's screen
  const devFirstPendingId = devPendingQs.length > 0 ? devPendingQs[0].id : null;
  useEffect(() => {
    if (!devFirstPendingId || !showDevPanel || devMinimized) return;
    const q = DEV_QUESTIONS.find(dq => dq.id === devFirstPendingId);
    if (q && q.action) q.action(devQAHelpers);
  }, [devFirstPendingId, showDevPanel, devMinimized]);

  const devAnswerQuestion = (qId, answer) => {
    const note = devQANotes[qId] || '';
    const orig = DEV_QUESTIONS.find(q => q.id === qId);
    const updated = { ...devQAAnswers, [qId]: { answer, note, ts: Date.now(), question: orig ? orig.question : qId, tier: orig ? orig.tier : '?' } };
    setDevQAAnswers(updated);
    localStorage.setItem('aura-dev-qa', JSON.stringify(updated));
    setDevQANotes(prev => { const n = { ...prev }; delete n[qId]; return n; });
  };

  const devSkipQuestion = (qId) => {
    setDevQASkipped(prev => [...prev.filter(id => id !== qId), qId]);
  };

  // Session start time â€” answers newer than this are "this session"
  const [devSessionStart] = useState(() => Date.now());
  const [devCopyFlash, setDevCopyFlash] = useState(null); // 'main' | round.start | null

  // Group answers into rounds by timestamp clusters (>30 min gap = new round)
  const devAnswerRounds = useMemo(() => {
    const entries = Object.entries(devQAAnswers).filter(([, a]) => a.ts).sort((a, b) => a[1].ts - b[1].ts);
    if (entries.length === 0) return [];
    const rounds = [];
    let current = { entries: [entries[0]], start: entries[0][1].ts, end: entries[0][1].ts };
    for (let i = 1; i < entries.length; i++) {
      const gap = entries[i][1].ts - current.end;
      if (gap > 30 * 60 * 1000) {
        rounds.push(current);
        current = { entries: [entries[i]], start: entries[i][1].ts, end: entries[i][1].ts };
      } else {
        current.entries.push(entries[i]);
        current.end = entries[i][1].ts;
      }
    }
    rounds.push(current);
    return rounds;
  }, [devQAAnswers]);

  // Session answers = answered during this page load
  const devSessionAnswers = useMemo(() => {
    return Object.entries(devQAAnswers).filter(([, a]) => a.ts && a.ts >= devSessionStart).sort((a, b) => a[1].ts - b[1].ts);
  }, [devQAAnswers, devSessionStart]);

  const devCopyEntries = (entries, flashKey) => {
    const lines = entries.map(([qId, a]) => {
      const orig = DEV_QUESTIONS.find(q => q.id === qId);
      const qText = a.question || (orig ? orig.question : qId);
      const tier = a.tier || (orig ? orig.tier : '?');
      let line = `[${tier}] Q: ${qText}\nA: ${a.answer}`;
      if (a.note) line += `\nNote: ${a.note}`;
      return line;
    });
    const header = 'Dev Q&A answers from Aura.\n1. Update DESIGN.md â€” add new items, update existing ones with new detail.\n2. Replace answered DEV_QUESTIONS with fresh follow-ups.\n3. Remove questions I already answered from the array.';
    const text = header + '\n\n' + lines.join('\n\n');
    navigator.clipboard.writeText(text).then(() => {
      setDevCopyFlash(flashKey);
      setTimeout(() => setDevCopyFlash(null), 1200);
    }).catch(() => {});
  };

  const devCopySessionAnswers = () => {
    if (devSessionAnswers.length > 0) {
      devCopyEntries(devSessionAnswers, 'main');
    }
  };

  const devPanelEl = IS_DEV && showDevPanel ? (() => {
    if (devMinimized) {
      return (
        <button
          onClick={() => setDevMinimized(false)}
          className="fixed bottom-4 right-4 z-[10000] w-10 h-10 rounded-full bg-violet-600 text-white flex items-center justify-center shadow-lg hover:bg-violet-500 transition-colors text-sm font-bold"
          title="Expand Dev Panel"
        >D</button>
      );
    }
    const completedTests = Object.keys(assessCompleted).length;
    const totalTests = Object.keys(ASSESS_TESTS).length;
    const bg = darkMode ? 'bg-gray-900 border-gray-700 text-gray-100' : 'bg-white border-gray-300 text-gray-900';
    const btnBase = darkMode ? 'bg-gray-800 hover:bg-gray-700 text-gray-200' : 'bg-gray-100 hover:bg-gray-200 text-gray-800';
    const btnAccent = 'bg-violet-600 hover:bg-violet-500 text-white';
    const sectionTitle = darkMode ? 'text-gray-400' : 'text-gray-500';

    return (
      <div className={`fixed top-4 z-[10000] max-h-[92vh] overflow-y-auto rounded-xl border shadow-2xl ${bg}`} style={{fontSize:'13px', width: '340px', left: '540px'}}>
        {/* â”€â”€ Header â”€â”€ */}
        <div className="flex items-center gap-2 px-3 py-2 border-b border-inherit">
          <span className="font-bold text-violet-400" style={{fontSize:'14px'}}>Dev</span>
          <button onClick={() => setDarkMode(d => !d)}
            className={`px-2.5 py-1 rounded-full font-bold transition-all ${darkMode ? 'bg-gray-800 text-amber-400 hover:bg-gray-700 ring-1 ring-amber-500/30' : 'bg-amber-50 text-amber-700 hover:bg-amber-100 ring-1 ring-amber-300'}`}
            style={{fontSize:'11px'}}>
            {darkMode ? 'ðŸŒ™' : 'â˜€ï¸'}
          </button>
          <div className="flex items-center" style={{gap:'1px'}}>
            <button onClick={() => { setEntityType('human'); localStorage.setItem('aura-entity-type', 'human'); }}
              className={`py-1 rounded-l font-medium ${entityType === 'human' ? btnAccent : btnBase}`} style={{width:'48px', textAlign:'center', fontSize:'10px'}}>Human</button>
            <button onClick={() => { setEntityType('ai'); localStorage.setItem('aura-entity-type', 'ai'); }}
              className={`py-1 rounded-r font-medium ${entityType === 'ai' ? 'bg-cyan-600 hover:bg-cyan-500 text-white' : btnBase}`} style={{width:'32px', textAlign:'center', fontSize:'10px'}}>AI</button>
          </div>
          <div className="flex-1" />
          <div className="flex gap-1">
            <button onClick={() => setDevMinimized(true)} className={`w-6 h-6 rounded flex items-center justify-center ${btnBase}`} style={{fontSize:'11px'}}>_</button>
            <button onClick={() => setShowDevPanel(false)} className={`w-6 h-6 rounded flex items-center justify-center ${btnBase}`} style={{fontSize:'11px'}}>Ã—</button>
            <button onClick={() => location.reload()} className={`px-2 h-6 rounded font-semibold ${btnBase}`} title="Hard refresh" style={{fontSize:'10px'}}>â†»</button>
          </div>
        </div>

        {/* â”€â”€ Design Q&A Channel â”€â”€ */}
        {(() => {
          const answeredEntries = Object.entries(devQAAnswers).sort((a, b) => (b[1].ts || 0) - (a[1].ts || 0));
          const currentQ = devPendingQs.length > 0 ? devPendingQs[0] : null;
          const remaining = devPendingQs.length;

          if (!currentQ && answeredEntries.length === 0) return null;

          return (
            <div className="border-b border-inherit">
              {/* Tier toggle */}
              <div className="px-4 py-1.5 flex items-center gap-2 border-b border-inherit">
                <div className="flex items-center" style={{gap:'2px'}}>
                  <button onClick={() => setDevQATier('big')}
                    className={`px-3 py-1 rounded-l font-medium transition-all ${devQATier === 'big' ? btnAccent : btnBase}`}
                    style={{fontSize:'11px'}}>Big</button>
                  <button onClick={() => setDevQATier('little')}
                    className={`px-3 py-1 rounded-r font-medium transition-all ${devQATier === 'little' ? btnAccent : btnBase}`}
                    style={{fontSize:'11px'}}>Little</button>
                </div>
                <span className={`${darkMode ? 'text-gray-600' : 'text-gray-400'}`} style={{fontSize:'10px'}}>
                  {devQATier === 'big' ? 'Decisions that change the build' : 'Polish & detail questions'}
                </span>
              </div>
              {/* Current question â€” one at a time */}
              {currentQ ? (
                <div className="px-4 py-3" style={{ background: darkMode ? 'rgba(139,92,246,0.06)' : 'rgba(139,92,246,0.04)' }}>
                  <div className="flex items-start justify-between gap-2 mb-2.5">
                    <div className="flex items-start gap-2 flex-1">
                      <span className="text-violet-400 font-bold" style={{fontSize:'11px', marginTop:'2px'}}>Q</span>
                      <span className={`font-medium leading-snug ${darkMode ? 'text-white' : 'text-gray-900'}`} style={{fontSize:'13px'}}>{currentQ.question}</span>
                    </div>
                    <div className="flex items-center gap-2 shrink-0">
                      <span className={`${darkMode ? 'text-gray-600' : 'text-gray-400'}`} style={{fontSize:'11px'}}>{remaining} left</span>
                      <button onClick={() => devSkipQuestion(currentQ.id)}
                        className={`px-2 py-1 rounded text-xs transition-colors ${darkMode ? 'text-gray-500 hover:text-gray-300 hover:bg-gray-800' : 'text-gray-400 hover:text-gray-600 hover:bg-gray-100'}`}>
                        Skip
                      </button>
                    </div>
                  </div>
                  <input
                    type="text"
                    placeholder="Add a note (Enter to submit as 'Other')..."
                    value={devQANotes[currentQ.id] || ''}
                    onChange={(e) => setDevQANotes(prev => ({ ...prev, [currentQ.id]: e.target.value }))}
                    onKeyDown={(e) => { if (e.key === 'Enter' && devQANotes[currentQ.id]) devAnswerQuestion(currentQ.id, 'Other'); }}
                    className={`w-full px-3 py-1.5 rounded-lg mb-2 text-sm transition-colors ${darkMode ? 'bg-gray-800/60 border border-gray-700 text-gray-200 placeholder-gray-600 focus:border-violet-500/50' : 'bg-gray-50 border border-gray-200 text-gray-800 placeholder-gray-400 focus:border-violet-400'}`}
                    style={{fontSize:'12px', outline:'none'}}
                  />
                  <div className="flex flex-wrap gap-1.5">
                    {currentQ.options.map(opt => (
                      <button key={opt} onClick={() => devAnswerQuestion(currentQ.id, opt)}
                        className={`px-3 py-1.5 rounded-lg font-medium transition-all ${darkMode ? 'bg-violet-600/20 hover:bg-violet-600/40 text-violet-300 ring-1 ring-violet-500/30 hover:ring-violet-400/50' : 'bg-violet-50 hover:bg-violet-100 text-violet-700 ring-1 ring-violet-300 hover:ring-violet-400'}`}
                        style={{fontSize:'12px'}}>
                        {opt}
                      </button>
                    ))}
                    <button onClick={() => devAnswerQuestion(currentQ.id, 'Other')}
                      className={`px-3 py-1.5 rounded-lg font-medium transition-all ${darkMode ? 'bg-gray-800/60 hover:bg-gray-700/80 text-gray-400 ring-1 ring-gray-600/30 hover:ring-gray-500/50' : 'bg-gray-100 hover:bg-gray-200 text-gray-500 ring-1 ring-gray-300 hover:ring-gray-400'}`}
                      style={{fontSize:'12px'}}>
                      Other
                    </button>
                  </div>
                </div>
              ) : (
                <div className="px-4 py-3" style={{ background: darkMode ? 'rgba(139,92,246,0.06)' : 'rgba(139,92,246,0.04)' }}>
                  <span className={`${darkMode ? 'text-gray-500' : 'text-gray-400'}`} style={{fontSize:'12px'}}>All done â€” tell Claude to grab answers and load more.</span>
                </div>
              )}

              {/* Footer: copy + history (grouped by round) */}
              {answeredEntries.length > 0 && (
                <div className={`px-4 py-2 flex items-center gap-2 ${darkMode ? 'bg-gray-900/50' : 'bg-gray-50'}`}>
                  <button onClick={devCopySessionAnswers}
                    className={`px-3 py-1.5 rounded-lg font-medium transition-all ${
                      devCopyFlash === 'main'
                        ? 'bg-emerald-500/20 text-emerald-400 ring-1 ring-emerald-500/40'
                        : devSessionAnswers.length === 0
                          ? (darkMode ? 'bg-gray-800/60 text-gray-600 cursor-not-allowed' : 'bg-gray-100 text-gray-400 cursor-not-allowed')
                          : (darkMode ? 'bg-violet-600/20 text-violet-300 ring-1 ring-violet-500/30 hover:bg-violet-600/40 hover:ring-violet-400/50' : 'bg-violet-50 text-violet-700 ring-1 ring-violet-300 hover:bg-violet-100 hover:ring-violet-400')
                    }`}
                    disabled={devSessionAnswers.length === 0}
                    style={{fontSize:'12px'}}>
                    {devCopyFlash === 'main' ? 'Copied!' : `Copy New (${devSessionAnswers.length})`}
                  </button>
                  <button onClick={() => setDevQAShowHistory(h => !h)}
                    className={`px-3 py-1.5 rounded-lg font-medium transition-all ${
                      darkMode ? 'bg-gray-800/60 text-gray-400 ring-1 ring-gray-700/30 hover:bg-gray-700/80 hover:text-gray-300' : 'bg-gray-100 text-gray-500 ring-1 ring-gray-300 hover:bg-gray-200 hover:text-gray-600'
                    }`}
                    style={{fontSize:'12px'}}>
                    {devQAShowHistory ? 'Hide' : 'Show'} Answers ({answeredEntries.length})
                  </button>
                  {devQAShowHistory && (
                    <button onClick={() => { setDevQAAnswers({}); localStorage.removeItem('aura-dev-qa'); setDevQASkipped([]); }}
                      className={`px-2 py-1.5 rounded-lg transition-all ${darkMode ? 'text-rose-700 hover:text-rose-500 hover:bg-rose-900/20' : 'text-rose-400 hover:text-rose-500 hover:bg-rose-50'}`}
                      style={{fontSize:'11px'}}>Clear</button>
                  )}
                </div>
              )}
              {devQAShowHistory && devAnswerRounds.length > 0 && (
                <div className={`px-4 pb-2 ${darkMode ? 'bg-gray-900/50' : 'bg-gray-50'}`}>
                  {devAnswerRounds.slice().reverse().map((round, ri) => {
                    const isLatest = ri === 0;
                    const dateStr = new Date(round.start).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    const timeStr = new Date(round.start).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
                    const roundLabel = `${round.entries.length} answers â€” ${dateStr} ${timeStr}`;
                    return (
                      <div key={round.start} className={`${ri > 0 ? 'mt-2 pt-2 border-t' : ''} ${darkMode ? 'border-gray-800' : 'border-gray-200'}`}>
                        <div className="flex items-center gap-2 mb-1">
                          <button
                            onClick={() => {
                              const key = `devRound-${round.start}`;
                              setDevQANotes(prev => ({ ...prev, [key]: prev[key] ? '' : '1' }));
                            }}
                            className={`${darkMode ? 'text-gray-500 hover:text-gray-300' : 'text-gray-400 hover:text-gray-600'} transition-colors flex items-center gap-1.5`}
                            style={{fontSize:'11px'}}>
                            <span style={{fontSize:'9px'}}>{(isLatest || devQANotes[`devRound-${round.start}`]) ? 'â–¼' : 'â–¶'}</span>
                            {isLatest && <span className={`font-medium ${darkMode ? 'text-violet-500' : 'text-violet-400'}`}>Latest</span>}
                            <span>{roundLabel}</span>
                          </button>
                          <button onClick={() => devCopyEntries(round.entries, round.start)}
                            className={`px-2 py-0.5 rounded transition-all ${
                              devCopyFlash === round.start
                                ? 'bg-emerald-500/20 text-emerald-400'
                                : (darkMode ? 'text-gray-600 hover:text-gray-400 hover:bg-gray-800' : 'text-gray-400 hover:text-gray-500 hover:bg-gray-100')
                            }`}
                            style={{fontSize:'10px'}}>{devCopyFlash === round.start ? 'Copied!' : 'Copy'}</button>
                        </div>
                        {(isLatest || devQANotes[`devRound-${round.start}`]) && (
                          <div className="space-y-1">
                            {round.entries.map(([qId, a]) => {
                              const orig = DEV_QUESTIONS.find(q => q.id === qId);
                              const qText = a.question || (orig ? orig.question : qId);
                              return (
                                <div key={qId} className={`${darkMode ? 'text-gray-600' : 'text-gray-400'}`} style={{fontSize:'11px'}}>
                                  <div className="flex items-baseline gap-2">
                                    <span className="shrink-0">{qText.slice(0, 50)}:</span>
                                    <span className={`font-medium ${darkMode ? 'text-violet-500' : 'text-violet-400'}`}>{a.answer}</span>
                                  </div>
                                  {a.note && <div className={`ml-4 mt-0.5 italic ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>{a.note}</div>}
                                </div>
                              );
                            })}
                          </div>
                        )}
                      </div>
                    );
                  })}
                </div>
              )}
            </div>
          );
        })()}

        {/* â”€â”€ Screens â”€â”€ */}
        <div className="px-3 py-2 border-b border-inherit">
          <div className="grid grid-cols-4 gap-1">
            {DEV_SCREENS.map(s => (
              <button key={s.id} onClick={() => {
                if (s.id === 'verify-evaluator' && !verifyCurrentSubjectId) setVerifyCurrentSubjectId('mock-1');
                if (s.id === 'verify-eval-summary' && !verifyEvaluatorData) {
                  setVerifyCurrentSubjectId('mock-1');
                  setVerifyEvaluatorData({ path: 'A', pathLabel: 'Vouching', answers: { 'a3-verdict': { verdict: 'Yes', confidence: 3 } } });
                }
                setScreen(s.id);
              }}
                className={`py-1.5 rounded text-center ${screen === s.id ? btnAccent : btnBase}`}
                style={{fontSize:'11px'}}>
                {s.label}
              </button>
            ))}
          </div>
        </div>

        {/* â”€â”€ Device â”€â”€ */}
        <div className="px-3 py-2 border-b border-inherit" style={{ background: darkMode ? 'rgba(0,0,0,0.12)' : 'rgba(0,0,0,0.02)' }}>
          <div className="flex flex-wrap gap-1">
            {PHONE_SIZES.map(p => (
              <button key={p.id} onClick={() => setDevPhoneSize(p.id)}
                className={`py-1 px-2 rounded text-center ${devPhoneSize === p.id ? btnAccent : btnBase}`}
                style={{fontSize:'10px'}}
                title={`${p.w}\u00d7${p.h}`}>
                {p.label}
              </button>
            ))}
          </div>
        </div>
        {/* â”€â”€ Demos â”€â”€ */}
        <div className="px-3 py-2 border-b border-inherit">
          <div className="flex items-center gap-1">
            <button onClick={() => assessLoadDemoProfile(1)} className={`px-2 py-1 rounded ${assessDemoActive && Number(assessDemoProfile) === 1 ? btnAccent : btnBase}`} style={{fontSize:'11px'}}>D1</button>
            <button onClick={() => assessLoadDemoProfile(2)} className={`px-2 py-1 rounded ${assessDemoActive && Number(assessDemoProfile) === 2 ? btnAccent : btnBase}`} style={{fontSize:'11px'}}>D2</button>
            <button onClick={() => assessLoadDemoProfile(3)} className={`px-2 py-1 rounded ${assessDemoActive && Number(assessDemoProfile) === 3 ? btnAccent : btnBase}`} style={{fontSize:'11px'}}>D3</button>
            <div className="flex-1" />
            <button onClick={resetDemo} className="px-2 py-1 rounded bg-rose-800/50 hover:bg-rose-700 text-rose-300" style={{fontSize:'11px'}}>Reset</button>
          </div>
        </div>

        {/* â”€â”€ Q Jump + Assess â”€â”€ */}
        <div className="border-b border-inherit">
          <div className="flex items-center gap-1.5 px-3 py-1.5 border-b border-inherit">
            <span className={`font-medium ${sectionTitle}`} style={{fontSize:'11px'}}>Q</span>
            <input type="number" placeholder="ID"
              className={`w-14 px-2 py-1 rounded border ${darkMode ? 'bg-gray-800 border-gray-600 text-white' : 'bg-gray-50 border-gray-300'}`}
              style={{fontSize:'11px'}}
              onKeyDown={(e) => {
                if (e.key === 'Enter') {
                  const id = parseInt(e.target.value);
                  const idx = questions.findIndex(q => q.id === id);
                  if (idx >= 0) { setCurrentIndex(idx); setScreen('question'); e.target.value = ''; }
                  else alert('Q' + id + ' not found');
                }
              }}
            />
            <button onClick={() => { setCurrentIndex(0); setScreen('question'); }} className={`px-2 py-1 rounded ${btnBase}`} style={{fontSize:'11px'}}>First</button>
            <button onClick={() => { setCurrentIndex(questions.length - 1); setScreen('question'); }} className={`px-2 py-1 rounded ${btnBase}`} style={{fontSize:'11px'}}>Last</button>
          </div>
          <div className="flex items-center gap-1.5 px-3 py-1.5">
            <button onClick={() => {
              const fakeCompleted = { ...assessCompleted };
              if (!fakeCompleted['quick-profile']) {
                fakeCompleted['quick-profile'] = { score: 62, responses: {0:1,1:1,2:1,3:2,4:1}, traits: {E:20,A:80,C:80,N:50,O:55}, verifySignals: {socialDepth:0,consistency:0,depth:0} };
              }
              ['starter-personality','starter-motivation','starter-thinking','starter-connection','starter-strategy'].forEach(id => {
                if (!fakeCompleted[id]) {
                  fakeCompleted[id] = { score: 70, answers: {0:4,1:3,2:4,3:3,4:4,5:3,6:4,7:3}, traits: {} };
                }
              });
              setAssessCompleted(fakeCompleted);
              localStorage.setItem(ASSESS_STORAGE_KEY, JSON.stringify({ completed: fakeCompleted, inProgress: {}, demoActive: false, savedUserData: null, demoProfile: null, showDemoControls: false }));
            }} className={`px-2.5 py-1.5 rounded ${btnAccent}`} style={{fontSize:'11px'}}>Unlock</button>
            <button onClick={() => { if (screen !== 'assess-question') { setAssessCurrentTestId('bigfive-E'); setScreen('assess-question'); } setAssessShowCompletion(p => !p); }} className={`px-2.5 py-1.5 rounded ${assessShowCompletion ? 'bg-amber-600 text-white' : btnBase}`} style={{fontSize:'11px'}}>Celeb</button>
            <select onChange={(e) => { if (e.target.value) { setAssessCurrentTestId(e.target.value); setScreen('assess-question'); }}}
              className={`px-2 py-1.5 rounded border ${darkMode ? 'bg-gray-800 border-gray-600 text-white' : 'bg-gray-50 border-gray-300'}`}
              style={{fontSize:'11px', minWidth:'120px'}}
              value="">
              <option value="">Jump to test...</option>
              {Object.entries(ASSESS_TESTS).map(([id, t]) => (
                <option key={id} value={id}>{t.name}</option>
              ))}
            </select>
          </div>
        </div>

        {/* â”€â”€ Assess Q buttons (contextual) â”€â”€ */}
        {screen === 'assess-question' && assessCurrentTest ? (
          <div className="px-4 py-2 border-b border-inherit">
            <div className="flex gap-1 flex-wrap items-center">
              <span className={`${sectionTitle} mr-1`} style={{fontSize:'11px'}}>{assessCurrentTest.name}</span>
              {(assessGatewayActiveItems || assessCurrentTest.items.map((_, i) => i)).map((ri, vi) => (
                <button key={ri} onClick={() => assessGoToQuestion(vi, vi > assessCurrentIndex ? 'fwd' : 'back')}
                  className={`w-6 h-6 rounded flex items-center justify-center ${vi === assessCurrentIndex ? btnAccent : assessResponses[ri] !== undefined ? 'bg-cyan-800 text-cyan-200' : btnBase}`}
                  style={{fontSize:'10px'}}>
                  {vi + 1}
                </button>
              ))}
            </div>
          </div>
        ) : null}

        {/* â”€â”€ Status â”€â”€ */}
        <div className="px-4 py-1.5">
          <div className={`${sectionTitle}`} style={{fontSize:'11px'}}>
            Screen: {screen} Â· Question {currentIndex + 1} of {questions.length} Â· {entityType === 'ai' ? 'AI' : 'Human'} Â· Tier {calculateAssessTier(assessCompleted)} Â· {completedTests} of {totalTests} assessed
          </div>
        </div>
      </div>
    );
  })() : null;

  // Derive NavBar accent color from current screen context
  const navAccentColor = screen === 'assess-question' && assessCurrentTest
    ? assessCurrentTest.color
    : screen === 'questions' && selectedCategory
      ? (CATEGORIES.find(c => c.id === selectedCategory)?.color || 'violet')
      : 'violet';

  if (displayMode === 'desktop') {
    return (
      <>
        {/* Undo overlay - covers entire viewport during ANY pending state */}
        {pendingSubmit && (
          <div
            className="fixed inset-0 z-[9999] bg-transparent"
            onClick={handleUndo}
            onMouseDown={handleUndo}
            style={{ cursor: 'pointer', background: 'transparent' }}
          />
        )}
        <PhoneFrame darkMode={darkMode} width={(PHONE_SIZES.find(p => p.id === devPhoneSize) || PHONE_SIZES[1]).w} height={(PHONE_SIZES.find(p => p.id === devPhoneSize) || PHONE_SIZES[1]).h} devOffset={IS_DEV && showDevPanel && !devMinimized}>
          {/* Global stars background for dark mode */}
          {darkMode && <div className="global-stars" />}
          <div className="flex-1 flex flex-col overflow-hidden">
            {screen !== 'launch' && screen !== 'entity-gate' && screen !== 'welcome' && screen !== 'onboarding' && screen !== 'path-choice' && screen !== 'settings' && screen !== 'categories' && screen !== 'qotd' && screen !== 'public-profile' && screen !== 'compare' && !screen.startsWith('verify-') && (
              <NavBar darkMode={darkMode} stats={stats} showStreak={showStreak} onHome={() => setScreen('categories')} onDoubleClickHome={resetDemo} onSettings={goToSettings} onProfile={() => setScreen('profile')} isLoggedIn={!!authUser} isGuest={isGuestMode} assessCompleted={assessCompleted} accentColor={navAccentColor} displayName={displayName} />
            )}
            {renderContent()}
          </div>
          {showSaveNudge && <SaveProgressModal onCreateAccount={handleNudgeCreateAccount} onLater={handleNudgeLater} darkMode={darkMode} />}
          {levelUpData && <LevelUpModal level={levelUpData.level} title={levelUpData.title} onClose={() => setLevelUpData(null)} darkMode={darkMode} />}
        </PhoneFrame>
        {devPanelEl}
      </>
    );
  }

  return (
    <div
      className={`h-full flex flex-col overflow-hidden ${TH('bg-main', darkMode)} ${!darkMode ? 'light-theme' : ''}`}
      onClickCapture={(e) => {
        if (pendingSubmit) {
          e.stopPropagation();
          handleUndo();
        }
      }}
    >
      {/* Global stars background for dark mode */}
      {darkMode && <div className="global-stars" />}
      {screen !== 'launch' && screen !== 'entity-gate' && screen !== 'welcome' && screen !== 'onboarding' && screen !== 'path-choice' && screen !== 'settings' && screen !== 'categories' && screen !== 'qotd' && screen !== 'public-profile' && screen !== 'compare' && !screen.startsWith('verify-') && (
        <div className="safe-top">
          <NavBar darkMode={darkMode} stats={stats} showStreak={showStreak} onHome={() => setScreen('categories')} onDoubleClickHome={resetDemo} onSettings={goToSettings} onProfile={() => setScreen('profile')} isLoggedIn={!!authUser} isGuest={isGuestMode} assessCompleted={assessCompleted} displayName={displayName} />
        </div>
      )}
      <div className="flex-1 flex flex-col overflow-hidden">{renderContent()}</div>
      <div className="safe-bottom" />
      {showSaveNudge && <SaveProgressModal onCreateAccount={handleNudgeCreateAccount} onLater={handleNudgeLater} darkMode={darkMode} />}
      {levelUpData && <LevelUpModal level={levelUpData.level} title={levelUpData.title} onClose={() => setLevelUpData(null)} darkMode={darkMode} />}
      {devPanelEl}
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<ErrorBoundary><App /></ErrorBoundary>);
  </script>
</body>
</html>
