<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Aura X-Ray â€” Component Atlas</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html, body, #root { margin:0; padding:0; min-height:100vh; }
    * { box-sizing:border-box; }
    @keyframes fill { from { width: 100%; } to { width: 0%; } }
    @keyframes shrink { from { width: 100%; } to { width: 0%; } }
    @keyframes barGrow { from { transform: scaleX(0); } to { transform: scaleX(1); } }
    @keyframes bloom-in { from { opacity: 0; transform: scale(0.3); } to { opacity: 1; transform: scale(1); } }
    @keyframes fadeSlideIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    @keyframes sweepFill { from { width: 0%; } to { width: 100%; } }
    @keyframes shimmer-pulse { 0%, 100% { opacity: 0.4; } 50% { opacity: 0.8; } }
    @keyframes aura-breathe { 0%, 100% { transform: scale(0.94); opacity: 0.85; } 50% { transform: scale(1.06); opacity: 1; } }
    @keyframes celebrateGlow { 0% { transform: scale(0.8); opacity: 0; } 50% { transform: scale(1.2); opacity: 1; } 100% { transform: scale(1); opacity: 1; } }
    @keyframes cardFadeIn { from { opacity:0; transform:translateY(12px); } to { opacity:1; transform:translateY(0); } }
    .btn-feedback { transition: transform 0.1s ease, filter 0.1s ease !important; }
    .btn-feedback:hover { filter: brightness(1.15) !important; }
    .btn-feedback:active { transform: scale(0.96) !important; filter: brightness(0.92) !important; }
    .celebrate-glow { animation: celebrateGlow 0.6s ease-out forwards; }
    .question-text { font-size: clamp(20px, 6vw, 28px); line-height: 1.35; text-wrap: balance; }
    .shine-card { position: relative; }
    .hover-glow:not(.shine-card) { position: relative; isolation: isolate; }
    * { scrollbar-width: thin; scrollbar-color: rgba(255,255,255,0.08) transparent; }
    ::-webkit-scrollbar { width: 3px; height: 3px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.10); border-radius: 3px; }
    .xr-card { animation: cardFadeIn 0.4s ease-out both; transition: transform 0.2s ease, box-shadow 0.2s ease; }
    .xr-card:hover { transform: translateY(-4px); }
  </style>
</head>
<body>
  <div id="root"></div>
  <button onclick="location.reload()" style="position:fixed;top:12px;right:12px;z-index:99999;padding:8px 18px;font-size:15px;font-weight:600;background:rgba(255,255,255,0.12);color:rgba(255,255,255,0.7);border:1px solid rgba(255,255,255,0.2);border-radius:8px;cursor:pointer;backdrop-filter:blur(12px);transition:all 0.2s" onmouseover="this.style.background='rgba(255,255,255,0.22)';this.style.color='#fff'" onmouseout="this.style.background='rgba(255,255,255,0.12)';this.style.color='rgba(255,255,255,0.7)'">&#8635; Refresh</button>
  <script>tailwind.config={darkMode:'class'}</script>
  <script type="text/babel">
const { useState, useRef, useEffect, useCallback } = React;

// ===== FOUNDATION =====
const COLOR_HEX = {
  violet:  { base: '#8b5cf6', light: '#a78bfa', rgb: '139, 92, 246' },
  blue:    { base: '#3b82f6', light: '#60a5fa', rgb: '59, 130, 246' },
  teal:    { base: '#14b8a6', light: '#2dd4bf', rgb: '20, 184, 166' },
  rose:    { base: '#f43f5e', light: '#fb7185', rgb: '244, 63, 94' },
  pink:    { base: '#d946ef', light: '#e879f9', rgb: '217, 70, 239', tw: 'fuchsia' },
  emerald: { base: '#10b981', light: '#34d399', rgb: '16, 185, 129' },
  slate:   { base: '#7c85a6', light: '#a0a8c8', rgb: '124, 133, 166' },
  amber:   { base: '#f59e0b', light: '#fbbf24', rgb: '245, 158, 11' },
  indigo:  { base: '#6366f1', light: '#818cf8', rgb: '99, 102, 241' },
  cyan:    { base: '#06b6d4', light: '#67e8f9', rgb: '6, 182, 212' },
  gray:    { base: '#6b7280', light: '#9ca3af', rgb: '107, 114, 128' },
};
const twColor = (c) => COLOR_HEX[c]?.tw || c;
const BINARY_COLORS = {
  yes: ['#a7f3d0', '#6ee7b7', '#34d399', '#10b981'],
  no: ['#fecaca', '#fda4af', '#fb7185', '#f43f5e'],
};
const normalizeConf = (c) => Math.min(3, Math.max(0, (c || 1) - 1));
const TH = (token, dark) => { const val = {
  'text-primary': dark ? 'text-white' : 'text-gray-900',
  'text-secondary': dark ? 'text-gray-300' : 'text-gray-700',
  'text-muted': dark ? 'text-gray-400' : 'text-gray-600',
  'text-subtle': dark ? 'text-gray-500' : 'text-gray-400',
  'text-faint': dark ? 'text-gray-600' : 'text-gray-400',
  'text-inverted': dark ? 'text-gray-900' : 'text-white',
  'bg-main': dark ? 'bg-gray-950' : 'bg-gray-50',
  'bg-card': dark ? 'bg-white/[0.04] border border-white/[0.06]' : 'bg-white border border-black/[0.10] shadow-sm',
  'bg-elevated': dark ? 'bg-white/[0.06]' : 'bg-gray-200',
  'bg-input': dark ? 'bg-white/[0.06] text-white placeholder-gray-500' : 'bg-gray-100 text-gray-900 placeholder-gray-400',
  'bg-surface': dark ? 'bg-white/[0.03]' : 'bg-white/90',
  'bg-overlay': dark ? 'bg-white/[0.04]' : 'bg-gray-100',
  'border-base': dark ? 'border-white/[0.06]' : 'border-gray-200',
  'border-subtle': dark ? 'border-white/[0.08]' : 'border-gray-300',
  'btn-secondary': dark ? 'bg-white/[0.06] text-gray-500 hover:bg-white/[0.10]' : 'bg-gray-200 text-gray-500',
  'btn-ghost': dark ? 'text-gray-300 active:text-white' : 'text-gray-600 active:text-gray-900',
  'text-emerald': dark ? 'text-emerald-400' : 'text-emerald-600',
  'text-rose': dark ? 'text-rose-400' : 'text-rose-600',
  'text-violet': dark ? 'text-violet-400' : 'text-violet-600',
  'text-sky': dark ? 'text-sky-300' : 'text-sky-500',
  'text-blue': dark ? 'text-blue-400' : 'text-blue-600',
  'text-dim': dark ? 'text-gray-400' : 'text-gray-500',
  'text-bright': dark ? 'text-gray-100' : 'text-gray-900',
  'bg-card-simple': dark ? 'bg-white/[0.04]' : 'bg-white/80 border border-black/[0.06]',
  'bg-inverted': dark ? 'bg-white' : 'bg-gray-900',
  'bg-card-full': dark ? 'bg-white/[0.04] text-white' : 'bg-white/80 text-gray-900',
  'bg-disabled': dark ? 'bg-white/[0.04] text-gray-600' : 'bg-gray-200 text-gray-400',
  'bg-mid': dark ? 'bg-gray-600' : 'bg-gray-200',
  'text-bright-bg': dark ? 'text-white bg-gray-950' : 'text-gray-900 bg-gray-50',
  'chip-violet': dark ? 'bg-violet-900/30 text-violet-400' : 'bg-violet-100 text-violet-700',
}[token]; return val || ''; };
const hexToRgba = (hex, alpha) => {
  const r = parseInt(hex.slice(1,3), 16), g = parseInt(hex.slice(3,5), 16), b = parseInt(hex.slice(5,7), 16);
  return `rgba(${r},${g},${b},${alpha})`;
};
const PROGRESS_GRADIENTS = Object.fromEntries(
  Object.entries(COLOR_HEX).map(([c, hex]) => [c, { from: hex.base, to: hex.light }])
);
const spectrumColors = {
  'bigfive-E': { left: '#6366f1', right: '#f59e0b', leftLabel: 'Reserved', rightLabel: 'Outgoing' },
  'bigfive-A': { left: '#3b82f6', right: '#ec4899', leftLabel: 'Direct', rightLabel: 'Empathetic' },
  'bigfive-C': { left: '#8b5cf6', right: '#10b981', leftLabel: 'Flexible', rightLabel: 'Organized' },
  'bigfive-N': { left: '#06b6d4', right: '#f97316', leftLabel: 'Steady', rightLabel: 'Sensitive' },
  'bigfive-O': { left: '#64748b', right: '#a855f7', leftLabel: 'Practical', rightLabel: 'Curious' },
};
const ASSESS_COLORS = ['violet', 'blue', 'teal', 'rose', 'pink', 'emerald', 'slate', 'amber', 'indigo', 'cyan'];
const ASSESS_C = Object.fromEntries(ASSESS_COLORS.map(c => {
  const t = twColor(c);
  return [c, { bg: `bg-${t}-500`, text: `text-${t}-400`, textLight: `text-${t}-600`, light: `bg-${t}-500/20`, lightBg: `bg-${t}-100`, border: `border-${t}-500/30`, borderLight: `border-${t}-300`, grad: `from-${t}-600 to-${t}-500` }];
}));
const getAssessColor = (color, darkMode) => {
  const c = ASSESS_C[color];
  return { ...c, text: darkMode ? c.text : c.textLight, light: darkMode ? c.light : c.lightBg, border: darkMode ? c.border : c.borderLight };
};
const ASSESS_STYLES = (() => {
  const dark = {
    gradientStyles: Object.fromEntries(ASSESS_COLORS.map(c => { const t = twColor(c); return [c, [`bg-${t}-950/30 border-${t}-800/40`, `bg-${t}-950/50 border-${t}-700/50`, `bg-${t}-900/40 border-${t}-600/50`, `bg-${t}-900/60 border-${t}-500/60`, `bg-${t}-800/70 border-${t}-400/70`]]; })),
    selectedStyles: Object.fromEntries(ASSESS_COLORS.map(c => { const t = twColor(c); return [c, `bg-${t}-600 border-${t}-400`]; })),
    pendingStyles: Object.fromEntries(ASSESS_COLORS.map(c => { const t = twColor(c); return [c, `bg-${t}-600 border-${t}-400`]; })),
    numColors: Object.fromEntries(ASSESS_COLORS.map(c => { const t = twColor(c); return [c, `text-${t}-400/70`]; })),
  };
  const light = {
    gradientStyles: Object.fromEntries(ASSESS_COLORS.map(c => { const t = twColor(c); return [c, [`bg-${t}-50 border-${t}-200`, `bg-${t}-100 border-${t}-200`, `bg-${t}-100 border-${t}-300`, `bg-${t}-200 border-${t}-300`, `bg-${t}-200 border-${t}-400`]]; })),
    selectedStyles: Object.fromEntries(ASSESS_COLORS.map(c => { const t = twColor(c); return [c, `bg-${t}-600 border-${t}-400 text-white`]; })),
    pendingStyles: Object.fromEntries(ASSESS_COLORS.map(c => { const t = twColor(c); return [c, `bg-${t}-600 border-${t}-400`]; })),
    numColors: Object.fromEntries(ASSESS_COLORS.map(c => { const t = twColor(c); return [c, `text-${t}-500/70`]; })),
  };
  return { dark, light };
})();
const ASSESS_CATEGORIES = {
  'ai-identity': { name: 'AI Identity', icon: '\u{1F916}', color: 'cyan', tests: ['ai-style'], tier: 0 },
  quickstart: { name: 'Quick Profile', icon: '\u2728', color: 'blue', tests: ['quick-profile'], tier: 0 },
  starter: { name: 'Starter Pack', icon: '\u{1F680}', color: 'indigo', tests: ['starter-personality'], tier: 1 },
  personality: { name: 'Personality', icon: '\u{1F3AD}', color: 'rose', tests: ['bigfive-E'], tier: 2 },
  shadow: { name: 'Shadow Self', icon: '\u{1F311}', color: 'slate', tests: ['shadow-M'], tier: 2 },
};
const MC_COLORS = [
  { hex: COLOR_HEX.blue.base, name: 'blue', shades: ['#93c5fd', '#60a5fa', '#3b82f6', '#2563eb'], rgb: COLOR_HEX.blue.rgb },
  { hex: COLOR_HEX.violet.base, name: 'violet', shades: ['#c4b5fd', '#a78bfa', '#8b5cf6', '#7c3aed'], rgb: COLOR_HEX.violet.rgb },
  { hex: COLOR_HEX.teal.base, name: 'teal', shades: ['#5eead4', '#2dd4bf', '#14b8a6', '#0d9488'], rgb: COLOR_HEX.teal.rgb },
  { hex: COLOR_HEX.cyan.base, name: 'cyan', shades: ['#67e8f9', '#22d3ee', '#06b6d4', '#0891b2'], rgb: COLOR_HEX.cyan.rgb },
  { hex: '#ec4899', name: 'pink', shades: ['#f9a8d4', '#f472b6', '#ec4899', '#db2777'], rgb: '236, 72, 153' },
];
const CATEGORIES = [
  { id: 'prediction', name: 'Predictions', icon: '\u{1F52E}', color: 'amber' },
  { id: 'reasoning', name: 'Reasoning', icon: '\u{1F9E0}', color: 'violet' },
  { id: 'judgment', name: 'Judgment', icon: '\u2696\uFE0F', color: 'emerald' },
];
const getStars = (count) => '\u2605'.repeat(Math.min(Math.max(count, 1), 4));
const VERIFY_CONFIDENCE_LABELS = [
  '1 \u2014 Notable gaps in my knowledge',
  '2 \u2014 Fairly confident, some uncertainty',
  '3 \u2014 Very confident, no reason to doubt',
  '4 \u2014 Certain, I\'d stake my reputation',
];

// ===== MOCK DATA =====
const MOCK_QUESTIONS = [
  { id: 1, text: 'Will AI surpass human creativity by 2040?', category: 'prediction', type: 'binary', preEvidence: [{ type: 'stat', label: 'AI art adoption', value: '340%' }] },
  { id: 2, text: 'Is free will an illusion?', category: 'reasoning', type: 'binary', preEvidence: [] },
  { id: 3, text: 'What matters most in leadership?', category: 'judgment', type: 'multiple', options: ['Vision', 'Empathy', 'Decisiveness', 'Integrity'], preEvidence: [] },
  { id: 4, text: 'Should governments regulate AI development?', category: 'judgment', type: 'binary', preEvidence: [] },
  { id: 5, text: 'Best approach to learning:', category: 'reasoning', type: 'multiple', options: ['Deep focus', 'Broad exploration', 'Social learning', 'Trial and error'], preEvidence: [] },
];
const MOCK_STATS = { answered: 42, streak: 5 };
const MOCK_ASSESS_COMPLETED = { 'quick-profile': { score: 72 }, 'bigfive-E': { score: 65 } };
const noop = () => {};

// ===== PHASE 1 ADDITIONS =====
const IS_DEV = false;
const QUESTION_FLAG_REASONS = ['Unclear', 'Biased', 'Duplicate', 'Wrong'];
const EXPLANATION_REASONS_BASE = ['Gut feel', 'Research', 'Experience', 'Logic'];
const ALL_EXPLANATION_REASONS = [...EXPLANATION_REASONS_BASE, 'Clicked wrong button', 'Misunderstood'];
const CANT_ANSWER_REASONS = ['Need more context', 'Question unclear', 'Conflict of interest', 'Not my area'];
const CONFIDENCE_LABELS = ['\u2605', '\u2605\u2605', '\u2605\u2605\u2605', '\u2605\u2605\u2605\u2605'];
const MOCK_USER_RESPONSE = { answer: 0, confidence: 3 };

const aggregateResults = (evaluators, question, userResponse, includeUserInCount = true) => {
  if (question?.type === 'binary') {
    return { rows: [
      { label: 'YES', answer: 0, count: 45, pct: 60, byConf: [5,10,15,15], colors: ['#d1fae5','#6ee7b7','#34d399','#059669'], isUser: userResponse?.answer === 0, maxCount: 45 },
      { label: 'NO', answer: 1, count: 30, pct: 40, byConf: [8,10,7,5], colors: ['#fecdd3','#fda4af','#fb7185','#e11d48'], isUser: userResponse?.answer === 1, maxCount: 45 },
    ], total: 75, maxCount: 45, userConf: userResponse?.confidence ?? 2 };
  }
  const opts = question?.options || ['A','B','C','D'];
  return { rows: opts.map((opt, i) => ({
    label: opt, answer: i, count: [30,25,15,5][i]||10, pct: [40,33,20,7][i]||10,
    byConf: [3,7,10,Math.max(1,10-i*3)], colors: MC_COLORS[i%MC_COLORS.length].shades,
    isUser: userResponse?.answer === i, maxCount: 30
  })), total: 75, maxCount: 30, userConf: userResponse?.confidence ?? 2 };
};

const renderConfidenceBar = (byConf, colors, maxCount, isUser, userConf, height = 'h-5', darkMode = true) => {
  const total = byConf.reduce((a,b) => a+b, 0);
  return (
    <div className={`flex-1 ${height} rounded-full overflow-hidden`} style={{ background: darkMode ? 'black' : '#e5e7eb' }}>
      <div className="h-full flex" style={{ width: `${maxCount > 0 ? (total/maxCount)*100 : 0}%` }}>
        {[3,2,1,0].map(ci => byConf[ci] > 0 ? <div key={ci} className="h-full" style={{ width: `${(byConf[ci]/total)*100}%`, background: colors[ci] }} /> : null)}
      </div>
    </div>
  );
};

const MOCK_VERIFY_Q = {
  singleSelect: { id:'v1', options:['Daily','Weekly','Monthly','Rarely'] },
  multiToggle: { id:'v2', options:['Available weekends','Prefers text','Night owl','Remote'], maxSelect:3 },
  textInput: { id:'v3', placeholder:'Describe the relationship...' },
  verdict: { id:'v4', verdictOptions:['Yes','No'], flags:['Inconsistent','Evasive','Unreliable','Other concern'] },
  compact: { id:'v5', fields:[
    { id:'freq', label:'How often?', options:['Daily','Weekly','Monthly','Rarely'] },
    { id:'context', label:'Context', options:['Work','Social','Family'] },
  ]},
  identity: { id:'v6', fields:[
    { id:'rel', label:'Relationship', subtitle:'How do you know them?', options:['Close friend','Colleague','Family'] },
    { id:'years', label:'How long?', options:['<1yr','1-3yr','3-5yr','5+yr'] },
  ]},
  evidence: { id:'v7', sections:[
    { label:'Positive Signals', options:['Consistent','Reliable','Transparent'] },
    { label:'Red Flags', options:['Evasive','Inconsistent'] },
  ]},
};
const MOCK_SUBJECTS = [
  { id:'s1', name:'Sarah Chen', city:'San Francisco', connections:3 },
  { id:'s2', name:'Alex Rivera', city:'New York', connections:1 },
];
const STAMP_PROVIDERS = [
  { id:'github', name:'GitHub', color:'#fff', svg:'M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z' },
  { id:'twitter', name:'X / Twitter', color:'#1DA1F2', svg:'M12.6.75h2.454l-5.36 6.142L16 15.25h-4.937l-3.867-5.07-4.425 5.07H.316l5.733-6.57L0 .75h5.063l3.495 4.633L12.601.75Zm-.86 13.028h1.36L4.323 2.145H2.865l8.875 11.633Z' },
];

// ===== TIER 1 COMPONENTS =====
const ProgressCircle = ({ progress = 0, size = 48, strokeWidth = 3, color = 'violet', icon = null, text = null, gradientId = 'prog', darkMode = true, glow = true, iconSize = 'text-lg', textSize = 'text-sm', orbit = false, onClick = null }) => {
  const radius = (size - strokeWidth) / 2;
  const circumference = 2 * Math.PI * radius;
  const grad = PROGRESS_GRADIENTS[color] || PROGRESS_GRADIENTS.violet;
  const hasProgress = progress > 0;
  return (
    <div className={`relative flex items-center justify-center ${onClick ? 'cursor-pointer' : ''}`} style={{ width: size, height: size }} onClick={onClick}>
      {glow && hasProgress && <div className="absolute rounded-full pointer-events-none" style={{ inset: -Math.round(size * 0.25), background: `radial-gradient(circle, ${grad.from}40 0%, ${grad.from}15 45%, transparent 70%)` }} />}
      <svg width={size} height={size} className="absolute">
        <defs><linearGradient id={gradientId} x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stopColor={hasProgress ? grad.from : '#374151'} /><stop offset="100%" stopColor={hasProgress ? grad.to : '#4b5563'} /></linearGradient></defs>
        <circle cx={size/2} cy={size/2} r={radius} fill="none" stroke={darkMode ? '#1f2937' : '#e5e7eb'} strokeWidth={strokeWidth} />
        <circle cx={size/2} cy={size/2} r={radius} fill="none" stroke={`url(#${gradientId})`} strokeWidth={strokeWidth} strokeLinecap="round" strokeDasharray={circumference} strokeDashoffset={circumference * (1 - progress / 100)} transform={`rotate(-90 ${size/2} ${size/2})`} className="transition-all duration-500" />
      </svg>
      {icon && !text && <span className={`relative z-10 ${iconSize}`}>{icon}</span>}
      {text !== null && <span className={`relative z-10 font-bold ${textSize}`} style={{ color: hasProgress ? grad.to : (darkMode ? '#6b7280' : '#9ca3af') }}>{text}</span>}
    </div>
  );
};

const SpectrumBar = ({ value, testId, showLabels = false, darkMode = true }) => {
  const spec = spectrumColors[testId] || { left: '#6b7280', right: '#8b5cf6' };
  return (
    <div className="w-full">
      {showLabels && <div className="flex justify-between text-[10px] mb-1"><span className={darkMode ? 'text-gray-500' : 'text-gray-400'}>{spec.leftLabel}</span><span className={darkMode ? 'text-gray-500' : 'text-gray-400'}>{spec.rightLabel}</span></div>}
      <div className="h-3 rounded-full relative" style={{ background: `linear-gradient(to right, ${spec.left}, ${spec.right})` }}>
        <div className="absolute top-1/2 -translate-y-1/2 w-4 h-4 rounded-full bg-white" style={{ left: `${Math.max(5, Math.min(95, value))}%`, marginLeft: -8, boxShadow: '0 1px 3px rgba(0,0,0,0.25)' }} />
      </div>
    </div>
  );
};

const HintCard = ({ color, text, subtitle, darkMode = true }) => {
  const colorClass = twColor(color);
  return (
    <div className={`rounded-xl p-3 flex items-start gap-3 ${darkMode ? `bg-${colorClass}-950/30 border border-${colorClass}-800/30` : `bg-${colorClass}-50 border border-${colorClass}-200`}`}>
      <div className={`w-2.5 h-2.5 rounded-full mt-1 flex-shrink-0 ${darkMode ? `bg-${colorClass}-400` : `bg-${colorClass}-500`}`} />
      <div>
        <p className={`text-sm font-medium ${darkMode ? 'text-gray-100' : 'text-gray-800'}`}>{text}</p>
        {subtitle && <p className={`text-xs mt-0.5 text-gray-500`}>{subtitle}</p>}
      </div>
    </div>
  );
};

const ResultCard = ({ icon, title, subtitle, children, darkMode, gradientClass }) => (
  <div className={`rounded-2xl overflow-hidden backdrop-blur-xl ${darkMode ? 'bg-white/[0.06] border border-white/[0.08]' : 'bg-white/90 border border-black/[0.06] shadow-lg'}`}>
    <div className="relative px-4 py-3 flex items-center gap-3">
      <div className={`absolute inset-0 bg-gradient-to-br ${gradientClass}`} style={{ opacity: darkMode ? 0.45 : 0.35 }} />
      <span className="text-2xl relative">{icon}</span>
      <div className="relative"><h2 className="text-white text-lg font-bold">{title}</h2>{subtitle && <p className="text-white/70 text-xs">{subtitle}</p>}</div>
    </div>
    <div className="p-3 space-y-3">{children}</div>
  </div>
);

const InsightRow = ({ emoji, label, text, darkMode, colorClass }) => (
  <div className="flex gap-2 items-start">
    <span className="text-sm">{emoji}</span>
    <p className={`flex-1 text-xs ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}><span className={`font-medium ${colorClass}`}>{label}:</span> {text}</p>
  </div>
);

const ScoreGauge = ({ value, label, darkMode, gradientClass }) => {
  const gradColors = (() => {
    const map = { violet: ['#8b5cf6', '#a78bfa'], emerald: ['#10b981', '#34d399'], blue: ['#3b82f6', '#60a5fa'], amber: ['#f59e0b', '#fbbf24'], rose: ['#f43f5e', '#fb7185'], teal: ['#14b8a6', '#2dd4bf'], cyan: ['#06b6d4', '#22d3ee'] };
    for (const [key, colors] of Object.entries(map)) { if (gradientClass?.includes(key)) return colors; }
    return map.violet;
  })();
  const gId = 'sg-' + Math.random().toString(36).slice(2,8);
  return (
    <div className="text-center">
      <div className="relative w-24 h-24 mx-auto">
        <svg className="w-24 h-24 transform -rotate-90">
          <circle cx="48" cy="48" r="40" stroke={darkMode ? '#374151' : '#e5e7eb'} strokeWidth="8" fill="none" />
          <circle cx="48" cy="48" r="40" stroke={`url(#${gId})`} strokeWidth="8" fill="none" strokeLinecap="round" strokeDasharray={`${(value / 100) * 251.2} 251.2`} />
          <defs><linearGradient id={gId} x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" stopColor={gradColors[0]} /><stop offset="100%" stopColor={gradColors[1]} /></linearGradient></defs>
        </svg>
        <div className="absolute inset-0 flex items-center justify-center"><span className="text-2xl font-bold" style={{color: gradColors[1]}}>{value}%</span></div>
      </div>
      {label && <div className={`text-xs mt-2 ${TH('text-dim', darkMode)}`}>{label}</div>}
    </div>
  );
};

const TraitSpectrum = ({ name, score, lowLabel, highLabel, color = 'violet', compact = false, darkMode }) => {
  const grad = PROGRESS_GRADIENTS[color] || PROGRESS_GRADIENTS.violet;
  if (compact) {
    return (<div className="flex items-center gap-2 py-1"><span className={`text-xs font-medium w-20 truncate ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>{name}</span><span className={`text-[10px] w-14 text-right ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>{lowLabel}</span><div className="flex-1 h-2 rounded-full relative" style={{ background: `linear-gradient(to right, ${grad.from}, ${grad.to})` }}><div className="absolute top-1/2 -translate-y-1/2 w-3 h-3 rounded-full bg-white" style={{ left: `${Math.max(5, Math.min(95, score))}%`, marginLeft: -6, boxShadow: '0 1px 3px rgba(0,0,0,0.25)' }} /></div><span className={`text-[10px] w-14 ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>{highLabel}</span></div>);
  }
  return (<div className="py-1">{name && <div className={`text-xs font-medium mb-1 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>{name}</div>}<div className="flex justify-between text-[10px] mb-1"><span className={darkMode ? 'text-gray-500' : 'text-gray-400'}>{lowLabel}</span><span className={darkMode ? 'text-gray-500' : 'text-gray-400'}>{highLabel}</span></div><div className="h-3 rounded-full relative" style={{ background: `linear-gradient(to right, ${grad.from}, ${grad.to})` }}><div className="absolute top-1/2 -translate-y-1/2 w-4 h-4 rounded-full bg-white" style={{ left: `${Math.max(5, Math.min(95, score))}%`, marginLeft: -8, boxShadow: '0 1px 3px rgba(0,0,0,0.25)' }} /></div></div>);
};

const ScreenHeader = ({ title, onBack, darkMode, right }) => (
  <div className={`h-[44px] flex-shrink-0 flex items-center gap-2 px-3 border-b ${TH('border-base', darkMode)}`}>
    {onBack && <button onClick={onBack} className={darkMode ? 'text-gray-400' : 'text-gray-500'}>{'\u2190'}</button>}
    <span className={`font-medium flex-1 ${onBack ? '' : 'text-center'} ${TH('text-primary', darkMode)}`}>{title}</span>
    {right || (onBack ? null : <div className="w-6" />)}
  </div>
);

const ConfidenceBar = ({ label, pct, confCounts, colors, maxCount, isUserRow = false, userConf = -1, showEmpty = true, labelWidth = 'w-12', labelColor = null, darkMode = true }) => {
  const count = confCounts.reduce((a, b) => a + b, 0);
  const barWidth = maxCount > 0 ? (count / maxCount) * 100 : 0;
  const emptyWidth = 100 - barWidth;
  return (
    <div className="flex items-center gap-2">
      <span className={`text-sm truncate ${labelWidth} px-1.5 py-0.5 border ${isUserRow ? 'font-bold rounded-full' : ''}`} style={{ borderColor: isUserRow ? 'currentColor' : 'transparent', ...(labelColor ? { color: labelColor } : {}) }}>{label}</span>
      <span className="text-sm w-10" style={labelColor ? { color: labelColor } : undefined}>{pct}%</span>
      <div className="flex-1 h-4 rounded-full overflow-hidden" style={{ background: darkMode ? 'black' : undefined, border: !darkMode ? `1px solid ${colors[0]}` : undefined }}>
        <div className="h-full flex">
          {[3, 2, 1, 0].map(confIdx => { const segWidth = count > 0 ? (confCounts[confIdx] / maxCount) * 100 : 0; return segWidth > 0 ? <div key={confIdx} className="h-full" style={{ width: `${segWidth}%`, background: colors[confIdx] }} /> : null; })}
          {showEmpty && emptyWidth > 0 && <div className="h-full rounded-r-full" style={{ width: `${emptyWidth}%`, border: `1px solid ${colors[0]}`, borderLeft: 'none' }} />}
        </div>
      </div>
    </div>
  );
};

const ConfidenceSegments = ({ level, color = 'violet', active = false, darkMode = true }) => {
  const colors = { emerald: ['rgba(6,78,59,0.6)', 'rgba(4,120,87,0.7)', 'rgba(5,150,105,0.8)', 'rgba(16,185,129,0.9)'], rose: ['rgba(136,19,55,0.6)', 'rgba(190,18,60,0.7)', 'rgba(225,29,72,0.8)', 'rgba(244,63,94,0.9)'] };
  const shades = colors[color] || colors.emerald;
  if (!active || level === 0) return null;
  return (<div className="absolute bottom-0 left-0 right-0 h-2 flex">{[1,2,3,4].map(i => <div key={i} className={`flex-1 transition-all duration-150 ${i===1?'rounded-bl-xl':''} ${i===4?'rounded-br-xl':''}`} style={{ backgroundColor: level >= i ? shades[i-1] : 'rgba(0,0,0,0.2)', borderRight: i < 4 ? '1px solid rgba(0,0,0,0.3)' : 'none' }} />)}</div>);
};

const VortexButton = ({ onSingleTap, className = "text-xl btn-feedback" }) => {
  return <button onClick={onSingleTap} className={className}>{'\u{1F300}'}</button>;
};

const OptionChip = ({ label, selected, onClick, darkMode, accentColor = 'violet' }) => {
  const baseClass = darkMode ? 'bg-white/[0.06] text-gray-400 hover:bg-white/[0.10]' : 'bg-gray-200 text-gray-600 hover:bg-gray-300';
  const selectedClass = { violet: 'bg-violet-600 text-white', rose: 'bg-rose-500 text-white', amber: 'bg-amber-500 text-white' }[accentColor] || 'bg-violet-600 text-white';
  return <button onClick={onClick} className={`px-2.5 py-1 rounded-lg text-xs transition-colors ${selected ? selectedClass : baseClass}`}>{label}</button>;
};

const VerifyActionButton = ({ label, color, darkMode, onClick, disabled, secondary }) => {
  const c = COLOR_HEX[color] || COLOR_HEX.violet;
  if (secondary) return <button onClick={onClick} disabled={disabled} className="w-full h-14 rounded-2xl font-medium transition-all duration-200 disabled:opacity-30" style={{ background: darkMode ? `rgba(${c.rgb}, 0.08)` : `rgba(${c.rgb}, 0.06)`, border: `1px solid ${darkMode ? `rgba(${c.rgb}, 0.25)` : `rgba(${c.rgb}, 0.2)`}`, color: darkMode ? c.light : c.base }}>{label}</button>;
  return <button onClick={onClick} disabled={disabled} className="w-full h-14 rounded-2xl font-semibold transition-all duration-200 disabled:opacity-30" style={{ background: darkMode ? `linear-gradient(135deg, rgba(${c.rgb}, 0.3), rgba(${c.rgb}, 0.15))` : `linear-gradient(135deg, rgba(${c.rgb}, 0.85), rgba(${c.rgb}, 0.65))`, border: `1px solid rgba(${c.rgb}, ${darkMode ? 0.35 : 0.5})`, color: '#fff', boxShadow: darkMode ? `0 0 20px rgba(${c.rgb}, 0.15)` : `0 0 12px rgba(${c.rgb}, 0.2)` }}>{label}</button>;
};

const VerifyOptionButton = ({ label, selected, color, darkMode, onClick }) => {
  const c = COLOR_HEX[color] || COLOR_HEX.violet;
  return <button onClick={onClick} className="w-full rounded-2xl text-left px-4 h-14 font-medium transition-all duration-200" style={{ background: selected ? `linear-gradient(135deg, rgba(${c.rgb}, 0.25), rgba(${c.rgb}, 0.12))` : darkMode ? 'rgba(255,255,255,0.04)' : 'rgba(0,0,0,0.03)', border: selected ? `1px solid rgba(${c.rgb}, 0.45)` : darkMode ? '1px solid rgba(255,255,255,0.06)' : '1px solid rgba(0,0,0,0.06)', color: selected ? (darkMode ? '#fff' : c.base) : (darkMode ? 'rgba(255,255,255,0.7)' : 'rgba(0,0,0,0.7)'), boxShadow: selected ? `0 0 16px rgba(${c.rgb}, 0.12)` : 'none' }}>{label}</button>;
};

const VerifyStarConfidence = ({ color, darkMode, value, onChange }) => {
  const c = COLOR_HEX[color] || COLOR_HEX.violet;
  const labels = ['Gaps', 'Fair', 'Confident', 'Certain'];
  return (
    <div className="flex flex-col items-center gap-4 w-full">
      <div className="flex items-start justify-center gap-5">
        {[1,2,3,4].map(level => {
          const isSelected = value !== undefined && level <= value;
          const intensity = [0.25, 0.4, 0.55, 0.75][level - 1];
          return (
            <button key={level} onClick={() => onChange(level)} className="flex flex-col items-center gap-2 transition-all duration-200">
              <div className="w-11 h-11 rounded-full flex items-center justify-center text-sm font-semibold transition-all duration-300" style={{ background: isSelected ? `linear-gradient(135deg, rgba(${c.rgb}, ${intensity}), rgba(${c.rgb}, ${intensity * 0.5}))` : darkMode ? 'rgba(255,255,255,0.08)' : 'rgba(0,0,0,0.06)', border: isSelected ? `1.5px solid rgba(${c.rgb}, ${[0.35,0.45,0.6,0.75][level-1]})` : darkMode ? '1px solid rgba(255,255,255,0.1)' : '1px solid rgba(0,0,0,0.08)', color: isSelected ? '#fff' : (darkMode ? 'rgba(255,255,255,0.35)' : 'rgba(0,0,0,0.35)') }}>{level}</div>
              <span className="text-xs font-medium transition-colors duration-200" style={{ color: isSelected ? (darkMode ? c.light : c.base) : (darkMode ? 'rgba(255,255,255,0.3)' : 'rgba(0,0,0,0.3)') }}>{labels[level-1]}</span>
            </button>
          );
        })}
      </div>
    </div>
  );
};

const VerifyChipButton = ({ label, selected, color, darkMode, onClick, stretch }) => {
  const c = COLOR_HEX[color] || COLOR_HEX.violet;
  return <button onClick={onClick} className="px-3 rounded-xl text-xs font-medium transition-all duration-200 text-center overflow-hidden" style={{ width: stretch ? '100%' : undefined, height: 40, lineHeight: '1.2', display: 'flex', alignItems: 'center', justifyContent: 'center', background: selected ? `linear-gradient(135deg, rgba(${c.rgb}, 0.25), rgba(${c.rgb}, 0.12))` : (darkMode ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.03)'), border: selected ? `1px solid rgba(${c.rgb}, 0.45)` : (darkMode ? '1px solid rgba(255,255,255,0.08)' : '1px solid rgba(0,0,0,0.08)'), color: selected ? (darkMode ? '#fff' : c.base) : (darkMode ? 'rgba(255,255,255,0.65)' : 'rgba(0,0,0,0.55)') }}>{label}</button>;
};

const VerifyToggleSwitch = ({ label, color, darkMode, isOn, onToggle }) => {
  const c = COLOR_HEX[color] || COLOR_HEX.violet;
  return (
    <button onClick={onToggle} className="w-full flex items-center justify-between rounded-2xl px-4 py-3.5 transition-all duration-200" style={{ background: isOn ? `linear-gradient(135deg, rgba(${c.rgb}, 0.2), rgba(${c.rgb}, 0.08))` : darkMode ? 'rgba(255,255,255,0.04)' : 'rgba(0,0,0,0.03)', border: isOn ? `1px solid rgba(${c.rgb}, 0.35)` : darkMode ? '1px solid rgba(255,255,255,0.06)' : '1px solid rgba(0,0,0,0.06)' }}>
      <span className={`text-sm font-medium block ${darkMode ? 'text-white/80' : 'text-gray-800'}`}>{label}</span>
      <div className="w-11 h-6 rounded-full relative transition-all duration-200 flex-shrink-0" style={{ background: isOn ? `rgba(${c.rgb}, 0.5)` : darkMode ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)' }}>
        <div className="absolute top-0.5 w-5 h-5 rounded-full bg-white transition-all duration-200 shadow-sm" style={{ left: isOn ? '21px' : '2px' }} />
      </div>
    </button>
  );
};

// ===== TIER 2 COMPONENTS =====
const NavBar = ({ darkMode, stats, showStreak, onHome, onSettings, onProfile, isLoggedIn, assessCompleted, accentColor = 'violet', displayName }) => {
  const accent = COLOR_HEX[accentColor] || COLOR_HEX.violet;
  return (
    <div className="flex items-center justify-between px-4 py-2 backdrop-blur-md" style={{ background: darkMode ? `linear-gradient(135deg, rgba(${accent.rgb},0.06) 0%, rgba(3,7,18,0.85) 100%)` : `linear-gradient(135deg, rgba(${accent.rgb},0.04) 0%, rgba(255,255,255,0.85) 100%)`, borderBottom: darkMode ? `1px solid rgba(${accent.rgb},0.15)` : `1px solid rgba(${accent.rgb},0.18)` }}>
      <button onClick={onHome} className="text-xl btn-feedback">{'\u{1F300}'}</button>
      <button onClick={onProfile} className={`flex items-center gap-2 px-2 py-1 rounded-lg btn-feedback`}>
        <span className={`text-sm ${TH('text-muted', darkMode)}`}>{stats.answered} answered</span>
        {showStreak && stats.streak > 0 && <span className="text-sm text-orange-400">{'\u{1F525}'}{stats.streak}</span>}
      </button>
      <div className="flex items-center gap-2">
        <button onClick={onProfile} className="btn-feedback">
          <div className="w-7 h-7 rounded-full flex items-center justify-center text-sm font-semibold" style={{ background: darkMode ? 'rgba(255,255,255,0.15)' : 'rgba(139,92,246,0.15)', border: darkMode ? '1.5px solid rgba(255,255,255,0.3)' : '1.5px solid rgba(139,92,246,0.3)' }}>
            <span style={{color: darkMode ? 'rgba(255,255,255,0.9)' : 'rgba(99,102,241,0.9)', fontSize: '0.75rem'}}>{displayName ? displayName[0].toUpperCase() : '\u{1F464}'}</span>
          </div>
        </button>
        <button onClick={onSettings} className={`text-xl btn-feedback ${TH('text-muted', darkMode)}`}>{'\u2630'}</button>
      </div>
    </div>
  );
};

const QuestionCard = ({ question, darkMode }) => {
  const category = CATEGORIES.find(c => c.id === question.category);
  const categoryColors = { prediction: darkMode ? 'text-amber-400' : 'text-amber-700', reasoning: darkMode ? 'text-violet-400' : 'text-violet-700', judgment: darkMode ? 'text-teal-400' : 'text-teal-700' };
  return (
    <div className="space-y-2 relative">
      {category && <div className="flex justify-center relative z-10"><span className={`text-sm font-medium ${categoryColors[question.category]}`}>{category.icon} {category.name}</span></div>}
      <h2 className={`question-text text-center font-medium relative z-10 ${TH('text-primary', darkMode)}`}>{question.text}</h2>
    </div>
  );
};

const BinaryButtons = ({ darkMode, tappedAnswer = null, tapCount = 0, isAnswered = false, currentResponse = null, onTap = noop, category }) => {
  const isOpinion = category === 'judgment';
  const colors = [COLOR_HEX[isOpinion ? 'cyan' : 'emerald'], COLOR_HEX[isOpinion ? 'violet' : 'rose']];
  const labels = ['YES', 'NO'];
  return (
    <div className="w-full max-w-sm mx-auto space-y-3">
      {[0, 1].map(answer => {
        const c = colors[answer];
        return (
          <button key={answer} onClick={() => onTap(answer)} className="w-full h-14 rounded-2xl flex items-center justify-center relative transition-all btn-feedback border select-none" style={{ borderColor: darkMode ? `rgba(${c.rgb}, 0.25)` : `rgba(${c.rgb}, 0.50)`, background: darkMode ? `linear-gradient(135deg, rgba(${c.rgb},0.08) 0%, rgba(${c.rgb},0.03) 100%)` : `linear-gradient(135deg, rgba(${c.rgb},0.14) 0%, rgba(${c.rgb},0.06) 100%)`, boxShadow: `0 0 12px rgba(${c.rgb},0.10), 0 0 30px rgba(${c.rgb},0.05)` }}>
            <span className="font-semibold" style={{ color: darkMode ? c.light : c.base }}>{labels[answer]}</span>
          </button>
        );
      })}
    </div>
  );
};

const MCButtons = ({ options, darkMode, onTap = noop }) => {
  return (
    <div className="w-full max-w-sm mx-auto space-y-2.5">
      {options.map((option, index) => {
        const mc = MC_COLORS[index % MC_COLORS.length];
        return (
          <button key={option} onClick={() => onTap(index)} className="w-full h-12 rounded-2xl flex items-center justify-center relative px-5 transition-all btn-feedback border select-none" style={{ borderColor: darkMode ? 'rgba(255,255,255,0.10)' : 'rgba(0,0,0,0.12)', background: darkMode ? 'rgba(255,255,255,0.04)' : 'rgba(0,0,0,0.03)' }}>
            <span className="font-semibold text-center" style={{ color: darkMode ? '#d1d5db' : '#1f2937' }}>{option}</span>
          </button>
        );
      })}
    </div>
  );
};

const UndoBar = ({ darkMode, answer = 0, confidence = 2, isBinary = true, options = [] }) => {
  const conf = Math.min(confidence, 4);
  let bgGradient;
  if (isBinary) {
    const shades = answer === 0 ? (darkMode ? [['#065f46','#059669'],['#047857','#10b981'],['#059669','#34d399'],['#10b981','#6ee7b7']] : [['#a7f3d0','#6ee7b7'],['#6ee7b7','#34d399'],['#34d399','#10b981'],['#10b981','#059669']]) : (darkMode ? [['#9f1239','#e11d48'],['#be123c','#f43f5e'],['#e11d48','#fb7185'],['#f43f5e','#fda4af']] : [['#fecdd3','#fda4af'],['#fda4af','#fb7185'],['#fb7185','#f43f5e'],['#f43f5e','#e11d48']]);
    const s = shades[conf - 1];
    bgGradient = `linear-gradient(135deg, ${s[0]} 0%, ${s[1]} 100%)`;
  } else {
    const color = MC_COLORS[answer % MC_COLORS.length];
    bgGradient = `linear-gradient(135deg, ${color.shades[conf - 1]} 0%, ${color.shades[Math.min(conf, 3)]} 100%)`;
  }
  return (
    <div className="relative cursor-pointer rounded-xl overflow-hidden" style={{height: 80}}>
      <div className={`h-full ${darkMode ? 'bg-gray-900/40' : 'bg-white/40'}`}>
        <div className={`absolute overflow-hidden rounded-xl`} style={isBinary ? { top: 12, height: 57, left: answer === 0 ? 16 : '50%', right: answer === 0 ? '50%' : 16 } : { left: 32, right: 32, top: 12, height: 40 }}>
          <div className="relative h-full flex items-center overflow-hidden justify-center" style={{ background: bgGradient }}>
            <div className="absolute inset-0 bg-black/30" style={{ width: '40%' }} />
            <span className="relative z-10 text-lg font-bold text-white">{isBinary ? (answer === 0 ? 'YES' : 'NO') : options[answer]}</span>
          </div>
        </div>
      </div>
    </div>
  );
};

const TipBanner = ({ darkMode, onDismiss }) => (
  <div onClick={onDismiss} className={`rounded-md px-3 py-1 flex items-center justify-between cursor-pointer mb-2 ${darkMode ? 'bg-violet-900/30 border border-violet-500/30' : 'bg-violet-100 border border-violet-300'}`}>
    <span className={`text-sm ${darkMode ? 'text-violet-300' : 'text-violet-700'}`}><span className="font-medium">Tip:</span> Confident? Tap up to four times</span>
    <span className={`text-sm ml-2 ${darkMode ? 'text-violet-500' : 'text-violet-400'}`}>{'\u2715'}</span>
  </div>
);

const SaveProgressModal = ({ onCreateAccount, onLater, darkMode }) => (
  <div className="flex items-center justify-center p-4" style={{minHeight:280}}>
    <div className={`w-full max-w-sm rounded-2xl p-6 backdrop-blur-xl ${darkMode ? 'bg-white/[0.06] border border-white/[0.08]' : 'bg-white/90 border border-black/[0.06] shadow-lg'}`}>
      <div className="text-4xl text-center mb-3">{'\u{1F389}'}</div>
      <h2 className={`text-xl font-bold text-center mb-2 ${darkMode ? 'text-white' : 'text-gray-900'}`}>20 responses!</h2>
      <p className={`text-sm text-center mb-6 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Save your progress?</p>
      <div className="space-y-2">
        <button onClick={onCreateAccount} className={`w-full py-3 rounded-xl font-medium btn-feedback ${darkMode ? 'bg-violet-600 text-white' : 'bg-violet-500 text-white'}`}>Create Account</button>
        <button onClick={onLater} className={`w-full py-3 rounded-xl font-medium btn-feedback ${darkMode ? 'bg-white/[0.06] text-gray-400' : 'bg-gray-100 text-gray-600'}`}>Later</button>
      </div>
    </div>
  </div>
);

const LevelUpModal = ({ level, title, onClose, darkMode }) => (
  <div className="flex items-center justify-center p-4" style={{minHeight:320}}>
    <div className={`w-full max-w-sm rounded-2xl p-8 text-center backdrop-blur-xl ${darkMode ? 'bg-white/[0.06] border border-white/[0.08]' : 'bg-white/90 border border-black/[0.06] shadow-lg'}`}>
      <div className="relative"><div className="text-6xl mb-4 celebrate-glow">{'\u{1F389}'}</div></div>
      <h2 className={`text-2xl font-bold mb-2 ${darkMode ? 'text-white' : 'text-gray-900'}`}>Level Up!</h2>
      <div className={`text-5xl font-bold mb-2 ${darkMode ? 'text-violet-400' : 'text-violet-600'}`}>{level}</div>
      <p className={`text-lg font-medium mb-4 ${darkMode ? 'text-violet-300' : 'text-violet-500'}`}>{title}</p>
      <button onClick={onClose} className={`w-full py-3 rounded-xl font-medium btn-feedback ${darkMode ? 'bg-violet-600 text-white' : 'bg-violet-500 text-white'}`}>Continue</button>
    </div>
  </div>
);

const BottomSheet = ({ darkMode, children }) => (
  <div className="flex items-end justify-center pb-4" style={{minHeight:200}}>
    <div className={`rounded-xl p-4 w-full max-w-xs backdrop-blur-xl ${darkMode ? 'bg-white/[0.06] border border-white/[0.08]' : 'bg-white/90 shadow-xl border border-black/[0.06]'}`}>
      {children}
    </div>
  </div>
);

const VerifySubjectBanner = ({ subject, color, darkMode }) => {
  const c = COLOR_HEX[color] || COLOR_HEX.emerald;
  return (
    <div className="w-full mb-3">
      <div className="w-full flex items-center gap-2.5 px-3 py-2 rounded-xl" style={{ background: darkMode ? 'rgba(255,255,255,0.03)' : 'rgba(0,0,0,0.02)', border: darkMode ? '1px solid rgba(255,255,255,0.06)' : '1px solid rgba(0,0,0,0.06)' }}>
        <div className="w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold flex-shrink-0" style={{ background: `rgba(${c.rgb}, 0.2)`, color: darkMode ? c.light : c.base }}>{subject.name[0]}</div>
        <div className="flex-1 min-w-0 text-left">
          <div className={`text-sm font-semibold truncate ${darkMode ? 'text-white' : 'text-gray-900'}`}>{subject.name}</div>
          <div className={`text-xs truncate ${darkMode ? 'text-white/40' : 'text-gray-500'}`}>{subject.city}</div>
        </div>
      </div>
    </div>
  );
};

const VerifyScreenLayout = ({ darkMode, color, sectionLabel, children, buttons }) => {
  const c = COLOR_HEX[color] || COLOR_HEX.violet;
  return (
    <div className={`flex-1 flex flex-col relative overflow-hidden ${TH('bg-main', darkMode)}`} style={{minHeight:300}}>
      <div className="absolute inset-0 flex items-center justify-center pointer-events-none" style={{ marginTop: '-8%' }}>
        <div style={{ position: 'absolute', width: 200, height: 200, borderRadius: '50%', background: darkMode ? `radial-gradient(circle, rgba(${c.rgb},0.18) 0%, transparent 65%)` : `radial-gradient(circle, rgba(${c.rgb},0.12) 0%, transparent 65%)`, animation: 'aura-breathe 8s ease-in-out infinite' }} />
      </div>
      <div className="relative z-10 flex flex-col h-full w-full">
        <div className="flex-1 overflow-y-auto flex flex-col items-center w-full">
          <div className="w-full px-5 pt-6 pb-4 flex flex-col items-center">
            {sectionLabel && <div className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium mb-3" style={{ background: darkMode ? `rgba(${c.rgb}, 0.12)` : `rgba(${c.rgb}, 0.08)`, color: darkMode ? c.light : c.base, border: `1px solid ${darkMode ? `rgba(${c.rgb}, 0.2)` : `rgba(${c.rgb}, 0.15)`}` }}>{sectionLabel}</div>}
            {children}
          </div>
        </div>
        {buttons && <div className="flex-shrink-0 w-full px-5 pb-4 pt-2">{buttons}</div>}
      </div>
    </div>
  );
};

const VerifyModeToggle = ({ darkMode, expertMode, setExpertMode }) => {
  const c = COLOR_HEX.emerald;
  return (
    <div className="flex justify-center mb-3">
      <button onClick={() => setExpertMode(!expertMode)} className="flex items-center rounded-full overflow-hidden transition-all duration-200" style={{ background: darkMode ? 'rgba(255,255,255,0.06)' : 'rgba(0,0,0,0.04)', border: darkMode ? '1px solid rgba(255,255,255,0.08)' : '1px solid rgba(0,0,0,0.08)' }}>
        <span className="px-3 py-1 text-xs font-medium" style={{ background: !expertMode ? (darkMode ? `rgba(${c.rgb}, 0.2)` : `rgba(${c.rgb}, 0.12)`) : 'transparent', color: !expertMode ? (darkMode ? c.light : c.base) : (darkMode ? 'rgba(255,255,255,0.35)' : 'rgba(0,0,0,0.35)') }}>Guided</span>
        <span className="px-3 py-1 text-xs font-medium" style={{ background: expertMode ? 'rgba(251,191,36,0.25)' : 'transparent', color: expertMode ? (darkMode ? '#fbbf24' : '#d97706') : (darkMode ? 'rgba(255,255,255,0.35)' : 'rgba(0,0,0,0.35)') }}>Express</span>
      </button>
    </div>
  );
};

// ===== TIER 3 MOCK SHELLS =====
const WelcomeScreenPreview = ({ darkMode }) => (
  <div className={`flex flex-col items-center justify-center h-full p-6 ${darkMode ? 'bg-gray-950' : 'bg-gray-50'}`}>
    <div className="text-5xl mb-4">{'\u{1F300}'}</div>
    <h1 className={`text-2xl font-bold mb-2 ${TH('text-primary', darkMode)}`}>Aura</h1>
    <p className={`text-sm text-center mb-8 ${TH('text-muted', darkMode)}`}>Discover your personality</p>
    <div className="w-full space-y-3">
      <button className="w-full py-3 rounded-xl font-medium bg-violet-600 text-white">Get Started</button>
      <button className={`w-full py-3 rounded-xl font-medium ${darkMode ? 'bg-white/[0.06] text-gray-400' : 'bg-gray-200 text-gray-600'}`}>Sign In</button>
    </div>
  </div>
);

const OnboardingPreview = ({ darkMode }) => (
  <div className={`flex flex-col h-full ${darkMode ? 'bg-gray-950' : 'bg-gray-50'}`}>
    <div className="flex-1 flex flex-col items-center justify-center px-6">
      <span className={`text-sm font-medium mb-4 ${darkMode ? 'text-amber-400' : 'text-amber-700'}`}>{'\u{1F52E}'} Fun Warmup</span>
      <h2 className={`text-xl font-medium text-center mb-8 ${TH('text-primary', darkMode)}`}>Which came first?</h2>
      <div className="w-full space-y-3">
        {['The chicken \u{1F414}', 'The egg \u{1F95A}'].map((o,i) => <button key={i} className="w-full h-14 rounded-2xl border font-semibold" style={{borderColor: darkMode ? 'rgba(245,158,11,0.25)' : 'rgba(245,158,11,0.50)', background: darkMode ? 'rgba(245,158,11,0.06)' : 'rgba(245,158,11,0.10)', color: darkMode ? '#fbbf24' : '#d97706'}}>{o}</button>)}
      </div>
    </div>
    <div className="px-6 pb-4"><div className={`h-1 rounded-full ${darkMode ? 'bg-white/10' : 'bg-gray-200'}`}><div className="h-full w-1/4 rounded-full bg-amber-500"/></div></div>
  </div>
);

const PathChoicePreview = ({ darkMode }) => (
  <div className={`flex flex-col items-center justify-center h-full p-6 ${darkMode ? 'bg-gray-950' : 'bg-gray-50'}`}>
    <h2 className={`text-lg font-bold mb-2 ${TH('text-primary', darkMode)}`}>Who are you?</h2>
    <p className={`text-sm mb-6 ${TH('text-muted', darkMode)}`}>Choose your path</p>
    <div className="w-full space-y-3">
      {[{icon:'\u{1F9EC}',label:'Human',color:'emerald'},{icon:'\u{1F916}',label:'AI',color:'cyan'}].map(p => {
        const c = COLOR_HEX[p.color];
        return <button key={p.label} className="w-full h-16 rounded-2xl flex items-center justify-center gap-3 font-semibold border" style={{borderColor:`rgba(${c.rgb},0.3)`, background:`rgba(${c.rgb},0.08)`, color: darkMode ? c.light : c.base}}><span className="text-2xl">{p.icon}</span>{p.label}</button>;
      })}
    </div>
  </div>
);

const CategoryScreenPreview = ({ darkMode }) => (
  <div className={`flex flex-col h-full ${darkMode ? 'bg-gray-950' : 'bg-gray-50'}`}>
    <NavBar darkMode={darkMode} stats={MOCK_STATS} showStreak onHome={noop} onSettings={noop} onProfile={noop} isLoggedIn={true} assessCompleted={MOCK_ASSESS_COMPLETED} displayName="Demo" />
    <div className="flex-1 p-4 space-y-3 overflow-hidden">
      {CATEGORIES.map(cat => <div key={cat.id} className={`rounded-xl p-3 ${darkMode ? 'bg-white/[0.04] border border-white/[0.06]' : 'bg-white border border-gray-200'}`}><span className="text-lg mr-2">{cat.icon}</span><span className={`text-sm font-medium ${TH('text-primary', darkMode)}`}>{cat.name}</span></div>)}
    </div>
  </div>
);

const ProfileScreenPreview = ({ darkMode }) => (
  <div className={`flex flex-col h-full ${darkMode ? 'bg-gray-950' : 'bg-gray-50'}`}>
    <ScreenHeader title="Profile" onBack={noop} darkMode={darkMode} />
    <div className="flex-1 p-4 flex flex-col items-center">
      <div className="w-20 h-20 rounded-full mb-3 flex items-center justify-center text-3xl" style={{background:'linear-gradient(135deg, rgba(139,92,246,0.3), rgba(59,130,246,0.2))', border:'2px solid rgba(139,92,246,0.4)'}}>{'\u{1F464}'}</div>
      <h2 className={`text-lg font-bold ${TH('text-primary', darkMode)}`}>Demo User</h2>
      <p className={`text-sm ${TH('text-muted', darkMode)}`}>42 answered</p>
      <div className="w-full mt-4 space-y-2">
        <TraitSpectrum name="Openness" score={72} lowLabel="Practical" highLabel="Curious" color="violet" darkMode={darkMode} compact />
        <TraitSpectrum name="Extraversion" score={45} lowLabel="Reserved" highLabel="Outgoing" color="blue" darkMode={darkMode} compact />
      </div>
    </div>
  </div>
);

const QotdPreview = ({ darkMode }) => (
  <div className={`flex flex-col h-full ${darkMode ? 'bg-gray-950' : 'bg-gray-50'}`}>
    <div className="flex-1 flex flex-col items-center justify-center px-5">
      <span className={`text-xs font-medium px-2 py-0.5 rounded-full mb-3 ${darkMode ? 'bg-amber-900/30 text-amber-400' : 'bg-amber-100 text-amber-700'}`}>Question of the Day</span>
      <h2 className={`text-lg font-medium text-center mb-6 ${TH('text-primary', darkMode)}`}>Should AI systems identify themselves to humans?</h2>
      <BinaryButtons darkMode={darkMode} category="judgment" />
    </div>
  </div>
);

const QuestionFlowPreview = ({ darkMode }) => (
  <div className={`flex flex-col h-full ${darkMode ? 'bg-gray-950' : 'bg-gray-50'}`}>
    <NavBar darkMode={darkMode} stats={MOCK_STATS} showStreak onHome={noop} onSettings={noop} onProfile={noop} isLoggedIn={true} assessCompleted={{}} displayName="D" />
    <div className="flex-1 flex flex-col items-center justify-center px-5">
      <QuestionCard question={MOCK_QUESTIONS[0]} darkMode={darkMode} />
      <div className="mt-6 w-full"><BinaryButtons darkMode={darkMode} /></div>
    </div>
  </div>
);

const HistoryPreview = ({ darkMode }) => (
  <div className={`flex flex-col h-full ${darkMode ? 'bg-gray-950' : 'bg-gray-50'}`}>
    <ScreenHeader title="History" onBack={noop} darkMode={darkMode} />
    <div className="flex-1 p-3 space-y-2 overflow-hidden">
      {MOCK_QUESTIONS.slice(0,4).map(q => (
        <div key={q.id} className={`rounded-lg p-2.5 ${darkMode ? 'bg-white/[0.04] border border-white/[0.06]' : 'bg-white border border-gray-200'}`}>
          <p className={`text-xs truncate ${TH('text-primary', darkMode)}`}>{q.text}</p>
          <div className="flex items-center gap-2 mt-1">
            <span className={`text-[10px] px-1.5 py-0.5 rounded ${darkMode ? 'bg-emerald-900/30 text-emerald-400' : 'bg-emerald-100 text-emerald-700'}`}>YES {'\u2605\u2605\u2605'}</span>
          </div>
        </div>
      ))}
    </div>
  </div>
);

const SettingsPreview = ({ darkMode }) => (
  <div className={`flex flex-col h-full ${darkMode ? 'bg-gray-950' : 'bg-gray-50'}`}>
    <ScreenHeader title="Settings" onBack={noop} darkMode={darkMode} />
    <div className="flex-1 p-4 space-y-3">
      {['Account', 'Appearance', 'Notifications', 'About'].map(item => (
        <div key={item} className={`rounded-xl p-3 flex items-center justify-between ${darkMode ? 'bg-white/[0.04] border border-white/[0.06]' : 'bg-white border border-gray-200'}`}>
          <span className={`text-sm ${TH('text-primary', darkMode)}`}>{item}</span>
          <span className={TH('text-subtle', darkMode)}>{'\u203A'}</span>
        </div>
      ))}
    </div>
  </div>
);

const AssessPickerPreview = ({ darkMode }) => (
  <div className={`flex flex-col h-full ${darkMode ? 'bg-gray-950' : 'bg-gray-50'}`}>
    <ScreenHeader title="Assessments" onBack={noop} darkMode={darkMode} />
    <div className="flex-1 p-3 space-y-2 overflow-hidden">
      {Object.entries(ASSESS_CATEGORIES).slice(0,4).map(([id, cat]) => {
        const c = COLOR_HEX[cat.color] || COLOR_HEX.violet;
        return (
          <div key={id} className={`rounded-xl p-3 flex items-center gap-3 ${darkMode ? 'bg-white/[0.04] border border-white/[0.06]' : 'bg-white border border-gray-200'}`}>
            <div className="w-10 h-10 rounded-xl flex items-center justify-center text-lg" style={{background:`rgba(${c.rgb},0.15)`}}>{cat.icon}</div>
            <div className="flex-1"><div className={`text-sm font-medium ${TH('text-primary', darkMode)}`}>{cat.name}</div><div className={`text-xs ${TH('text-muted', darkMode)}`}>{cat.tests.length} test{cat.tests.length>1?'s':''}</div></div>
            <ProgressCircle progress={id === 'quickstart' ? 100 : 0} size={32} strokeWidth={2} color={cat.color} gradientId={`ap-${id}`} darkMode={darkMode} glow={false} />
          </div>
        );
      })}
    </div>
  </div>
);

const AssessQuestionPreview = ({ darkMode }) => {
  const c = COLOR_HEX.violet;
  return (
    <div className={`flex flex-col h-full relative ${darkMode ? 'bg-gray-950' : 'bg-gray-50'}`}>
      <div className="absolute inset-0 flex items-center justify-center pointer-events-none"><div style={{width:200,height:200,borderRadius:'50%',background:`radial-gradient(circle, rgba(${c.rgb},0.15) 0%, transparent 65%)`,animation:'aura-breathe 8s ease-in-out infinite'}}/></div>
      <div className="relative z-10 flex flex-col h-full">
        <div className="p-3 flex items-center gap-2"><div className={`h-1 flex-1 rounded-full ${darkMode?'bg-white/10':'bg-gray-200'}`}><div className="h-full w-3/5 rounded-full bg-violet-500"/></div><span className={`text-xs ${TH('text-subtle',darkMode)}`}>6/10</span></div>
        <div className="flex-1 flex items-center justify-center px-5"><p className={`text-lg text-center font-medium ${TH('text-primary',darkMode)}`}>I prefer deep conversations over small talk</p></div>
        <div className="p-4 space-y-2">
          {['Strongly Disagree','Disagree','Neutral','Agree','Strongly Agree'].map((l,i) => {
            const styles = (darkMode ? ASSESS_STYLES.dark : ASSESS_STYLES.light).gradientStyles.violet;
            return <button key={l} className={`w-full py-2.5 rounded-xl text-sm font-medium border ${styles[i]} ${TH('text-primary',darkMode)}`}>{l}</button>;
          })}
        </div>
      </div>
    </div>
  );
};

const AssessResultsPreview = ({ darkMode }) => (
  <div className={`flex flex-col h-full ${darkMode ? 'bg-gray-950' : 'bg-gray-50'}`}>
    <ScreenHeader title="Results" onBack={noop} darkMode={darkMode} />
    <div className="flex-1 p-4 overflow-hidden">
      <ResultCard icon="ðŸŽ­" title="Big Five" subtitle="Personality Profile" darkMode={darkMode} gradientClass="from-violet-600 to-violet-500">
        <ScoreGauge value={72} label="Openness" darkMode={darkMode} gradientClass="from-violet-600" />
      </ResultCard>
    </div>
  </div>
);

const AssessAnalysisPreview = ({ darkMode }) => (
  <div className={`flex flex-col h-full ${darkMode ? 'bg-gray-950' : 'bg-gray-50'}`}>
    <ScreenHeader title="Analysis" onBack={noop} darkMode={darkMode} />
    <div className="flex-1 p-4 space-y-3 overflow-hidden">
      <TraitSpectrum name="Extraversion" score={38} lowLabel="Reserved" highLabel="Outgoing" color="indigo" darkMode={darkMode} />
      <TraitSpectrum name="Agreeableness" score={72} lowLabel="Direct" highLabel="Empathetic" color="blue" darkMode={darkMode} />
      <TraitSpectrum name="Conscientiousness" score={65} lowLabel="Flexible" highLabel="Organized" color="violet" darkMode={darkMode} />
      <InsightRow emoji="ðŸ’¡" label="Key trait" text="High openness suggests creative thinking" darkMode={darkMode} colorClass={darkMode ? 'text-violet-400' : 'text-violet-600'} />
    </div>
  </div>
);

const VerifyHubPreview = ({ darkMode }) => (
  <div className={`flex flex-col h-full ${darkMode ? 'bg-gray-950' : 'bg-gray-50'}`}>
    <ScreenHeader title="Verify" onBack={noop} darkMode={darkMode} />
    <div className="flex-1 p-4 flex flex-col items-center justify-center">
      <div className="text-4xl mb-4">{'\u{1F50D}'}</div>
      <h2 className={`text-lg font-bold mb-2 ${TH('text-primary', darkMode)}`}>Verify Someone</h2>
      <p className={`text-sm text-center mb-6 ${TH('text-muted', darkMode)}`}>Rate people you know to build trust</p>
      <VerifyActionButton label="Start Verification" color="emerald" darkMode={darkMode} onClick={noop} />
    </div>
  </div>
);

const SharePickerPreview = ({ darkMode }) => (
  <div className={`flex flex-col h-full ${darkMode ? 'bg-gray-950' : 'bg-gray-50'}`}>
    <ScreenHeader title="Share" onBack={noop} darkMode={darkMode} />
    <div className="flex-1 p-4 space-y-3">
      <p className={`text-sm ${TH('text-muted', darkMode)}`}>Share your profile with:</p>
      {['Copy Link', 'Twitter/X', 'Message'].map(item => (
        <button key={item} className={`w-full py-3 rounded-xl text-sm font-medium ${darkMode ? 'bg-white/[0.06] text-gray-300 border border-white/[0.06]' : 'bg-white text-gray-700 border border-gray-200'}`}>{item}</button>
      ))}
    </div>
  </div>
);

const PublicProfilePreview = ({ darkMode }) => (
  <div className={`flex flex-col h-full ${darkMode ? 'bg-gray-950' : 'bg-gray-50'}`}>
    <div className="flex-1 p-4 flex flex-col items-center pt-8">
      <div className="w-16 h-16 rounded-full mb-3 flex items-center justify-center text-2xl" style={{background:'linear-gradient(135deg, rgba(139,92,246,0.3), rgba(59,130,246,0.2))', border:'2px solid rgba(139,92,246,0.4)'}}>{'\u{1F464}'}</div>
      <h2 className={`text-lg font-bold ${TH('text-primary', darkMode)}`}>Jane Doe</h2>
      <p className={`text-sm mb-4 ${TH('text-muted', darkMode)}`}>Explorer Level 3</p>
      <div className="w-full space-y-2">
        <TraitSpectrum name="Openness" score={82} lowLabel="Practical" highLabel="Curious" color="violet" darkMode={darkMode} compact />
        <TraitSpectrum name="Agreeableness" score={68} lowLabel="Direct" highLabel="Empathetic" color="blue" darkMode={darkMode} compact />
      </div>
    </div>
  </div>
);

const IdentityScreenPreview = ({ darkMode }) => (
  <VerifyScreenLayout darkMode={darkMode} color="emerald" sectionLabel="Identity Check">
    <h2 className={`text-lg font-medium text-center mb-4 ${TH('text-primary', darkMode)}`}>How well do you know this person?</h2>
    <div className="w-full space-y-3">
      <VerifyOptionButton label="Close friend" selected={true} color="emerald" darkMode={darkMode} onClick={noop} />
      <VerifyOptionButton label="Acquaintance" selected={false} color="emerald" darkMode={darkMode} onClick={noop} />
      <VerifyOptionButton label="Colleague" selected={false} color="emerald" darkMode={darkMode} onClick={noop} />
    </div>
  </VerifyScreenLayout>
);

// ===== TIER 4 =====
const AuraVizPlaceholder = ({ darkMode }) => (
  <div className="flex items-center justify-center" style={{width:200,height:200}}>
    <div style={{width:160,height:160,borderRadius:'50%',background:'radial-gradient(circle, rgba(139,92,246,0.4) 0%, rgba(59,130,246,0.2) 40%, rgba(6,182,212,0.1) 70%, transparent 100%)',animation:'aura-breathe 6s ease-in-out infinite',boxShadow:'0 0 40px rgba(139,92,246,0.3), 0 0 80px rgba(59,130,246,0.15)'}} />
  </div>
);

// ===== PHASE 1: NEW COMPONENTS =====

// --- Verify Input Components ---
const VerifySingleSelect = ({ question, color, darkMode, answer, onAnswer }) => {
  const opts = question.options || [];
  return (
    <div className="flex flex-col gap-2 w-full" style={{ animation: 'fadeSlideIn 0.4s ease-out both' }}>
      {opts.map(opt => <VerifyOptionButton key={opt} label={opt} selected={answer === opt} color={color} darkMode={darkMode} onClick={() => onAnswer(opt)} />)}
    </div>
  );
};

const VerifyTextInput = ({ question, color, darkMode, answer, onAnswer }) => {
  const c = COLOR_HEX[color] || COLOR_HEX.violet;
  return (
    <div className="flex flex-col gap-4 w-full" style={{ animation: 'fadeSlideIn 0.4s ease-out both' }}>
      <input type="text" value={answer || ''} onChange={e => onAnswer(e.target.value)}
        placeholder={question.placeholder || ''} className={`w-full h-14 rounded-2xl px-5 text-sm font-medium outline-none transition-all duration-200 ${TH('bg-input', darkMode)}`}
        style={{ border: darkMode ? '1px solid rgba(255,255,255,0.08)' : '1px solid rgba(0,0,0,0.08)' }} />
    </div>
  );
};

const VerifyMultiToggle = ({ question, color, darkMode, answer, onAnswer }) => {
  const selected = Array.isArray(answer) ? answer : [];
  const toggle = (opt) => {
    const next = selected.includes(opt) ? selected.filter(x => x !== opt) : [...selected, opt];
    onAnswer(next);
  };
  return (
    <div className="flex flex-col gap-2 w-full" style={{ animation: 'fadeSlideIn 0.4s ease-out both' }}>
      {(question.options || []).map(opt => <VerifyToggleSwitch key={opt} label={opt} color={color} darkMode={darkMode} isOn={selected.includes(opt)} onToggle={() => toggle(opt)} />)}
    </div>
  );
};

const VerifyVerdict = ({ question, color, darkMode, answer, onAnswer }) => {
  const c = COLOR_HEX[color] || COLOR_HEX.violet;
  const val = answer || {};
  const verdict = val.verdict;
  const confidence = val.confidence;
  const flags = val.flags || [];
  const [showFlags, setShowFlags] = useState(false);
  const setField = (field, v) => onAnswer({ ...val, [field]: v });
  const toggleFlag = (flag) => {
    const next = flags.includes(flag) ? flags.filter(f => f !== flag) : [...flags, flag];
    onAnswer({ ...val, flags: next });
  };
  return (
    <div className="flex flex-col items-center gap-5 w-full" style={{ animation: 'fadeSlideIn 0.4s ease-out both' }}>
      <div className="flex gap-3 w-full">
        {(question.verdictOptions || ['Yes','No']).map((opt, i) => {
          const isYes = i === 0;
          const sel = verdict === opt;
          const vc = isYes ? COLOR_HEX.emerald : COLOR_HEX.rose;
          return (
            <button key={opt} onClick={() => setField('verdict', opt)} className="flex-1 py-4 rounded-2xl font-semibold text-base transition-all duration-200"
              style={{ background: sel ? `linear-gradient(135deg, rgba(${vc.rgb}, 0.25), rgba(${vc.rgb}, 0.1))` : darkMode ? 'rgba(255,255,255,0.04)' : 'rgba(0,0,0,0.03)',
                border: sel ? `1.5px solid rgba(${vc.rgb}, 0.5)` : darkMode ? '1px solid rgba(255,255,255,0.06)' : '1px solid rgba(0,0,0,0.06)',
                color: sel ? (darkMode ? '#fff' : vc.base) : (darkMode ? 'rgba(255,255,255,0.5)' : 'rgba(0,0,0,0.4)'),
                boxShadow: sel ? `0 0 20px rgba(${vc.rgb}, 0.15)` : 'none' }}>{opt}</button>
          );
        })}
      </div>
      {verdict && (
        <div className="w-full" style={{ animation: 'fadeSlideIn 0.3s ease-out both' }}>
          <p className={`text-xs text-center mb-4 ${TH('text-muted', darkMode)}`}>How sure are you?</p>
          <VerifyStarConfidence color={color} darkMode={darkMode} value={confidence} onChange={v => setField('confidence', v)} />
        </div>
      )}
      {verdict && question.flags && (
        <div className="w-full" style={{ animation: 'fadeSlideIn 0.3s ease-out both 0.1s' }}>
          <button onClick={() => setShowFlags(!showFlags)} className="w-full flex items-center justify-between px-4 py-3 rounded-2xl transition-all duration-200"
            style={{ background: (showFlags || flags.length > 0) ? (darkMode ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.03)') : (darkMode ? 'rgba(255,255,255,0.02)' : 'rgba(0,0,0,0.015)'),
              border: flags.length > 0 ? `1px solid rgba(${COLOR_HEX.amber.rgb}, 0.3)` : (darkMode ? '1px solid rgba(255,255,255,0.06)' : '1px solid rgba(0,0,0,0.06)') }}>
            <span className={`text-sm font-medium ${flags.length > 0 ? (darkMode ? 'text-amber-400' : 'text-amber-600') : TH('text-muted', darkMode)}`}>
              {flags.length > 0 ? `${flags.length} flagged` : 'Anything feel off?'}</span>
            <span className={`text-xs transition-transform duration-200 ${showFlags ? 'rotate-180' : ''} ${TH('text-dim', darkMode)}`}>{'\u25BC'}</span>
          </button>
          {showFlags && (
            <div className="mt-2" style={{ display:'grid', gridTemplateColumns:'repeat(2, 1fr)', gap:8 }}>
              {question.flags.map(flag => {
                const isFlagged = flags.includes(flag);
                return (
                  <button key={flag} onClick={() => toggleFlag(flag)} className="px-3 py-2 rounded-xl text-sm font-medium transition-all duration-200 text-center"
                    style={{ background: isFlagged ? `linear-gradient(135deg, rgba(${COLOR_HEX.amber.rgb}, 0.2), rgba(${COLOR_HEX.amber.rgb}, 0.08))` : darkMode ? 'rgba(255,255,255,0.04)' : 'rgba(0,0,0,0.03)',
                      border: isFlagged ? `1px solid rgba(${COLOR_HEX.amber.rgb}, 0.4)` : darkMode ? '1px solid rgba(255,255,255,0.06)' : '1px solid rgba(0,0,0,0.06)',
                      color: isFlagged ? (darkMode ? '#fbbf24' : '#d97706') : darkMode ? 'rgba(255,255,255,0.5)' : 'rgba(0,0,0,0.4)' }}>{flag}</button>
                );
              })}
            </div>
          )}
        </div>
      )}
    </div>
  );
};

const VerifyCompactConnection = ({ question, color, darkMode, answer, onAnswer }) => {
  const c = COLOR_HEX[color] || COLOR_HEX.violet;
  const val = answer || {};
  const setField = (fieldId, v) => onAnswer({ ...val, [fieldId]: v });
  return (
    <div className="flex flex-col gap-3 w-full" style={{ animation: 'fadeSlideIn 0.4s ease-out both' }}>
      {question.fields.map(field => {
        const cols = field.options.length <= 4 ? field.options.length : 3;
        return (
          <div key={field.id} className="rounded-2xl px-4 py-3" style={{
            background: val[field.id] ? (darkMode ? `rgba(${c.rgb}, 0.04)` : `rgba(${c.rgb}, 0.02)`) : (darkMode ? 'rgba(255,255,255,0.03)' : 'rgba(0,0,0,0.02)'),
            border: val[field.id] ? `1px solid rgba(${c.rgb}, 0.15)` : (darkMode ? '1px solid rgba(255,255,255,0.06)' : '1px solid rgba(0,0,0,0.06)') }}>
            <div className={`text-sm font-semibold mb-2 ${TH('text-primary', darkMode)}`}>{field.label}</div>
            <div style={{ display:'grid', gridTemplateColumns:`repeat(${cols}, 1fr)`, gap:8 }}>
              {field.options.map(opt => <VerifyChipButton key={opt} label={opt} selected={val[field.id] === opt} color={color} darkMode={darkMode} onClick={() => setField(field.id, opt)} stretch />)}
            </div>
          </div>
        );
      })}
    </div>
  );
};

const VerifyIdentityCheck = ({ question, color, darkMode, answer, onAnswer }) => {
  const c = COLOR_HEX[color] || COLOR_HEX.violet;
  const val = answer || {};
  const setField = (fieldId, v) => onAnswer({ ...val, [fieldId]: v });
  return (
    <div className="flex flex-col gap-3 w-full" style={{ animation: 'fadeSlideIn 0.4s ease-out both' }}>
      {question.fields.map(field => {
        const cols = field.options.length <= 4 ? field.options.length : 3;
        return (
          <div key={field.id} className="rounded-2xl px-4 py-3" style={{
            background: val[field.id] ? (darkMode ? `rgba(${c.rgb}, 0.04)` : `rgba(${c.rgb}, 0.02)`) : (darkMode ? 'rgba(255,255,255,0.03)' : 'rgba(0,0,0,0.02)'),
            border: val[field.id] ? `1px solid rgba(${c.rgb}, 0.15)` : (darkMode ? '1px solid rgba(255,255,255,0.06)' : '1px solid rgba(0,0,0,0.06)') }}>
            <div className={`text-sm font-semibold mb-0.5 ${TH('text-primary', darkMode)}`}>{field.label}</div>
            {field.subtitle && <div className={`text-xs mb-2 ${TH('text-subtle', darkMode)}`}>{field.subtitle}</div>}
            <div style={{ display:'grid', gridTemplateColumns:`repeat(${cols}, 1fr)`, gap:8 }}>
              {field.options.map(opt => <VerifyChipButton key={opt} label={opt} selected={val[field.id] === opt} color={color} darkMode={darkMode} onClick={() => setField(field.id, opt)} stretch />)}
            </div>
          </div>
        );
      })}
    </div>
  );
};

const VerifyEvidenceCombined = ({ question, color, darkMode, answer, onAnswer }) => {
  const val = answer || {};
  const toggleItem = (si, opt) => {
    const key = `s${si}`;
    const cur = val[key] || [];
    onAnswer({ ...val, [key]: cur.includes(opt) ? cur.filter(x => x !== opt) : [...cur, opt] });
  };
  return (
    <div className="flex flex-col gap-4 w-full" style={{ animation: 'fadeSlideIn 0.4s ease-out both' }}>
      {question.sections.map((section, si) => (
        <div key={si}>
          <div className={`text-xs font-semibold uppercase tracking-wide mb-2 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>{section.label}</div>
          <div className="flex flex-col gap-2">
            {section.options.map(opt => <VerifyToggleSwitch key={opt} label={opt} color={color} darkMode={darkMode} isOn={(val[`s${si}`]||[]).includes(opt)} onToggle={() => toggleItem(si, opt)} />)}
          </div>
        </div>
      ))}
    </div>
  );
};

// --- Modal Preview Components ---
const NoneOptionModalPreview = ({ darkMode }) => (
  <div className={`rounded-xl p-4 ${TH('bg-card-simple', darkMode)}`}>
    <div className={`text-sm font-medium mb-2 ${TH('text-primary', darkMode)}`}>None of these options fit</div>
    <div className={`text-sm mb-3 ${darkMode ? 'text-gray-500' : 'text-gray-600'}`}>What would you answer instead?</div>
    <textarea placeholder="Your answer..." readOnly className={`w-full px-3 py-2 rounded-lg text-sm mb-3 h-16 resize-none ${darkMode ? 'bg-white/[0.06] text-white border-white/[0.08]' : 'bg-gray-100 text-gray-900'} border`} />
    <div className="flex gap-2">
      <button className={`flex-1 py-2 rounded-lg text-sm ${darkMode ? 'bg-white/[0.06] text-gray-400' : 'bg-gray-200 text-gray-600'}`}>Cancel</button>
      <button className="flex-1 py-2 rounded-lg text-sm font-medium bg-violet-600 text-white">Submit</button>
    </div>
  </div>
);

const QuestionFlagModalPreview = ({ darkMode }) => {
  const [selected, setSelected] = useState(['Biased']);
  const toggle = (r) => setSelected(prev => prev.includes(r) ? prev.filter(x => x !== r) : [...prev, r]);
  return (
    <BottomSheet darkMode={darkMode}>
      <div className="flex items-center gap-2 mb-3"><span className="text-rose-400">{'\u2691'}</span><span className={`text-sm font-medium ${TH('text-primary', darkMode)}`}>Flag question</span></div>
      <div className="flex gap-1.5 mb-3 flex-wrap">
        {QUESTION_FLAG_REASONS.map(r => <OptionChip key={r} label={r} selected={selected.includes(r)} onClick={() => toggle(r)} darkMode={darkMode} accentColor="rose" />)}
      </div>
      <input type="text" readOnly placeholder="Other..." className={`w-full px-3 py-2 rounded-lg text-sm mb-3 ${TH('bg-input', darkMode)} border ${TH('border-subtle', darkMode)}`} />
      <div className="flex gap-2">
        <button className={`py-2 px-4 rounded-lg text-sm ${darkMode ? 'bg-gray-800/50 text-gray-400' : 'bg-gray-200 text-gray-600'}`}>Cancel</button>
        <button className="flex-1 py-2 rounded-lg text-sm font-medium bg-rose-500 text-white">Flag</button>
      </div>
    </BottomSheet>
  );
};

const ExplanationModalPreview = ({ darkMode }) => {
  const [selected, setSelected] = useState(['Experience']);
  const toggle = (r) => setSelected(prev => prev.includes(r) ? prev.filter(x => x !== r) : [...prev, r]);
  return (
    <BottomSheet darkMode={darkMode}>
      <div className={`text-sm font-medium mb-3 ${TH('text-primary', darkMode)}`}>Why this answer?</div>
      <div className="space-y-2 mb-3">
        {EXPLANATION_REASONS_BASE.map(r => <button key={r} onClick={() => toggle(r)} className={`w-full text-left px-3 py-2 rounded-lg text-sm transition-colors ${selected.includes(r) ? 'bg-amber-500 text-white' : darkMode ? 'bg-white/[0.06] text-gray-300' : 'bg-gray-100 text-gray-700'}`}>{r}</button>)}
      </div>
      <div className="flex gap-2">
        <button className={`flex-1 py-2 rounded-lg text-sm ${darkMode ? 'bg-white/[0.06] text-gray-400' : 'bg-gray-200 text-gray-600'}`}>Cancel</button>
        <button className="flex-1 py-2 rounded-lg text-sm font-medium bg-amber-500 text-white">Save</button>
      </div>
    </BottomSheet>
  );
};

const CantAnswerModalPreview = ({ darkMode }) => {
  const [selected, setSelected] = useState(['Not my area']);
  const toggle = (r) => setSelected(prev => prev.includes(r) ? prev.filter(x => x !== r) : [...prev, r]);
  return (
    <BottomSheet darkMode={darkMode}>
      <div className={`text-sm font-medium mb-3 ${TH('text-primary', darkMode)}`}>Can't answer this question</div>
      <div className="space-y-2 mb-3">
        {CANT_ANSWER_REASONS.map(r => <button key={r} onClick={() => toggle(r)} className={`w-full text-left px-3 py-2 rounded-lg text-sm transition-colors ${selected.includes(r) ? 'bg-violet-600 text-white' : darkMode ? 'bg-white/[0.06] text-gray-300' : 'bg-gray-100 text-gray-700'}`}>{r}</button>)}
      </div>
      <div className="flex gap-2">
        <button className={`flex-1 py-2 rounded-lg text-sm ${darkMode ? 'bg-white/[0.06] text-gray-400' : 'bg-gray-200 text-gray-600'}`}>Cancel</button>
        <button className="flex-1 py-2 rounded-lg text-sm font-medium bg-violet-600 text-white">Skip</button>
      </div>
    </BottomSheet>
  );
};

// --- Chart Components ---
const ResultChart = ({ question, darkMode }) => {
  const userResp = { answer: 0, confidence: 3 };
  const { rows, maxCount } = aggregateResults(null, question, userResp);
  if (!rows.length) return null;
  const isBinary = question?.type === 'binary';
  const sorted = [...rows].sort((a, b) => b.count - a.count);
  return (
    <div className={isBinary ? "space-y-2" : "space-y-1"}>
      {sorted.map(row => {
        const labelColor = isBinary ? (row.answer === 0 ? (darkMode ? '#34d399' : '#059669') : (darkMode ? '#fb7185' : '#e11d48')) : MC_COLORS[row.answer % MC_COLORS.length].hex;
        return <ConfidenceBar key={row.answer} label={row.label} pct={row.pct} confCounts={row.byConf} colors={row.colors} maxCount={maxCount} isUserRow={row.isUser} showEmpty={isBinary} labelWidth={isBinary ? "w-12" : "w-24"} labelColor={labelColor} darkMode={darkMode} />;
      })}
    </div>
  );
};

const MiniCommunityResultsPreview = ({ darkMode }) => {
  const q = MOCK_QUESTIONS[0];
  const { rows, total, maxCount } = aggregateResults(null, q, MOCK_USER_RESPONSE);
  return (
    <div className={`w-full px-3 py-2 rounded-lg ${darkMode ? 'bg-white/[0.04]' : 'bg-gray-100'}`}>
      <div className={`text-sm font-medium mb-1.5 truncate ${TH('text-secondary', darkMode)}`}>{q.text}</div>
      <div className="space-y-1">
        {rows.map(row => (
          <div key={row.label} className="flex items-center gap-2">
            <span className={`text-sm w-8 ${row.isUser ? 'font-bold' : ''}`} style={{ color: row.colors[2] }}>{row.label}</span>
            <span className="text-sm w-6" style={{ color: row.colors[2] }}>{row.pct}%</span>
            <div className={`flex-1 h-2 rounded-full overflow-hidden ${darkMode ? 'bg-black' : 'bg-gray-300'}`}>
              <div className="h-full flex" style={{ width: `${(row.count/maxCount)*100}%` }}>
                {[3,2,1,0].map(ci => row.byConf[ci] > 0 ? <div key={ci} className="h-full" style={{ width: `${(row.byConf[ci]/row.count)*100}%`, background: row.colors[ci] }} /> : null)}
              </div>
            </div>
          </div>
        ))}
      </div>
      <div className={`text-xs text-right mt-1 ${TH('text-dim', darkMode)}`}>{total} responses {'\u2192'}</div>
    </div>
  );
};

const CommunityResultsRowsPreview = ({ darkMode }) => {
  const q = MOCK_QUESTIONS[0];
  const { rows, maxCount, userConf } = aggregateResults(null, q, MOCK_USER_RESPONSE, false);
  const allRows = [...rows].sort((a, b) => b.pct - a.pct);
  return (
    <div className="space-y-1">
      {allRows.map((row, i) => (
        <div key={i} className="flex items-center gap-2">
          <div className="w-12" style={{ flexShrink: 0 }}>
            <span className={`text-sm font-semibold px-2 py-0.5 border-2 ${row.isUser ? 'rounded-full' : ''}`}
              style={{ color: row.colors[1], borderColor: row.isUser ? row.colors[1] : 'transparent' }}>{row.label}</span>
          </div>
          <span className="text-sm w-9 font-bold text-right" style={{ color: row.colors[1] }}>{row.pct}%</span>
          {renderConfidenceBar(row.byConf, row.colors, maxCount, row.isUser, userConf, 'h-5', darkMode)}
        </div>
      ))}
    </div>
  );
};

const FullResultsPanelPreview = ({ darkMode }) => {
  const q = MOCK_QUESTIONS[0];
  const { rows, total, maxCount, userConf } = aggregateResults(null, q, MOCK_USER_RESPONSE, false);
  const allRows = [...rows].sort((a, b) => b.pct - a.pct);
  return (
    <div className={`w-full rounded-2xl backdrop-blur-xl ${darkMode ? 'bg-gray-950/90 border border-white/[0.08]' : 'bg-white/95 border border-gray-200'}`}>
      <div className="px-4 pt-3 pb-1">
        <div className="flex items-center gap-2 mb-1">
          <span className={`text-sm font-black uppercase tracking-wide ${TH('text-sky', darkMode)}`}>LAST:</span>
          <span className={`text-sm ${TH('text-subtle', darkMode)}`}>{total} responses</span>
        </div>
        <p className={`text-base font-medium ${TH('text-bright', darkMode)}`}>{q.text}</p>
      </div>
      <div className="px-4 pb-4 pt-2 space-y-1">
        {allRows.map((row, i) => (
          <div key={i} className="flex items-center gap-1">
            <div className="w-14" style={{ flexShrink: 0 }}>
              <span className={`text-base font-semibold inline-block px-2 py-0.5 rounded-full border-2`}
                style={{ color: row.colors[1], borderColor: row.isUser ? row.colors[1] : 'transparent' }}>{row.label}</span>
            </div>
            <span className="text-base w-8 font-bold text-right" style={{ color: row.colors[1] }}>{row.pct}</span>
            {renderConfidenceBar(row.byConf, row.colors, maxCount, row.isUser, userConf, 'h-5', darkMode)}
          </div>
        ))}
      </div>
      <div className={`text-sm text-center pb-3 ${TH('text-faint', darkMode)}`}>tap to close</div>
    </div>
  );
};

const AnsweredQuestionPreview = ({ darkMode }) => {
  const q = MOCK_QUESTIONS[0];
  const { rows, total, maxCount, userConf } = aggregateResults(null, q, MOCK_USER_RESPONSE, false);
  const allRows = [...rows].sort((a, b) => b.pct - a.pct);
  return (
    <div className="flex-1 flex flex-col overflow-y-auto px-4 py-3">
      <div className="flex justify-center mb-2">
        <span className={`text-sm font-medium ${darkMode ? 'text-amber-400' : 'text-amber-700'}`}>{'\u{1F52E}'} Predictions</span>
      </div>
      <h2 className={`question-text text-center font-medium mb-4 ${TH('text-primary', darkMode)}`} style={{fontSize:16}}>{q.text}</h2>
      <div className={`p-3 rounded-lg mb-4 ${TH('bg-overlay', darkMode)}`}>
        <div className={`text-sm text-center ${TH('text-muted', darkMode)}`}>Your answer: <span className={`font-bold ${darkMode ? 'text-emerald-400' : 'text-emerald-600'}`}>{'\u2605\u2605\u2605'} Yes</span></div>
      </div>
      <div className={`rounded-lg p-3 ${darkMode ? 'bg-white/[0.04]' : 'bg-gray-100'}`}>
        <div className="mb-2">
          <span className={`text-sm font-black uppercase tracking-wide ${TH('text-sky', darkMode)}`}>LAST:</span>
          <span className={`text-xs ml-2 ${TH('text-subtle', darkMode)}`}>{total} responses</span>
        </div>
        <div className="space-y-1">
          {allRows.map((row, i) => (
            <div key={i} className="flex items-center gap-1">
              <div className="w-14" style={{ flexShrink: 0 }}>
                <span className={`text-sm font-semibold px-2 py-0.5 border-2 ${row.isUser ? 'rounded-full' : ''}`}
                  style={{ color: row.colors[1], borderColor: row.isUser ? row.colors[1] : 'transparent' }}>{row.label}</span>
              </div>
              <span className="text-sm w-8 font-bold text-right" style={{ color: row.colors[1] }}>{row.pct}</span>
              {renderConfidenceBar(row.byConf, row.colors, maxCount, row.isUser, userConf, 'h-5', darkMode)}
            </div>
          ))}
        </div>
      </div>
    </div>
  );
};

// --- Analysis Components ---
const SemiGauge = ({ value, testId, size = 32 }) => {
  const spec = spectrumColors[testId] || { left: '#6b7280', right: '#8b5cf6' };
  const gradId = 'sg-' + Math.random().toString(36).slice(2,8);
  const sw = Math.max(3, size / 10);
  const r = (size/2) - (sw/2) - 2;
  const cx = size/2, cy = size/2;
  const gap = 80, leftStart = 90 + gap/2, arcSpan = 360 - gap;
  const toXY = (deg) => ({ x: cx + r * Math.cos(deg * Math.PI/180), y: cy + r * Math.sin(deg * Math.PI/180) });
  const pStart = toXY(leftStart), pEnd = toXY(90 - gap/2);
  const dotDeg = leftStart + (value/100) * arcSpan;
  const dot = toXY(dotDeg > 360 ? dotDeg - 360 : dotDeg);
  const ds = Math.max(5, sw * 1.5);
  const dotColor = (value/100) > 0.5 ? spec.right : spec.left;
  return (
    <svg width={size} height={size} viewBox={`0 0 ${size} ${size}`} style={{ overflow: 'visible' }}>
      <defs><linearGradient id={gradId} x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" stopColor={spec.left} /><stop offset="100%" stopColor={spec.right} /></linearGradient></defs>
      <path d={`M ${pStart.x} ${pStart.y} A ${r} ${r} 0 1 1 ${pEnd.x} ${pEnd.y}`} fill="none" stroke={`url(#${gradId})`} strokeWidth={sw} strokeLinecap="round" />
      <circle cx={dot.x} cy={dot.y} r={ds} fill={dotColor} opacity="0.4" />
      <circle cx={dot.x} cy={dot.y} r={ds/2+0.5} fill={dotColor} stroke="white" strokeWidth="1.5" strokeOpacity="0.9" />
    </svg>
  );
};

const AnalysisCardPreview = ({ id, icon, title, subtitle, color, progress, darkMode, children }) => {
  const [expanded, setExpanded] = useState(false);
  const t = twColor(color);
  return (
    <div className={`rounded-xl border overflow-hidden ${darkMode ? `bg-${t}-900/20 border-${t}-500/30` : `bg-${t}-50 border-${t}-200`}`}>
      <button onClick={() => setExpanded(!expanded)} className="w-full p-4 flex items-center gap-3 text-left">
        <ProgressCircle progress={progress || 65} size={48} strokeWidth={3} color={color} icon={icon} gradientId={`xr-ac-${id}`} darkMode={darkMode} />
        <div className="flex-1 min-w-0">
          <div className={`font-semibold ${TH('text-primary', darkMode)}`}>{title}</div>
          <div className={`text-xs ${TH('text-dim', darkMode)}`}>{subtitle}</div>
        </div>
        <span className={`text-sm transition-transform ${expanded ? 'rotate-180' : ''} ${TH('text-dim', darkMode)}`}>{'\u25BC'}</span>
      </button>
      {expanded && <div className={`px-4 pb-4 border-t ${darkMode ? 'border-gray-800' : 'border-gray-200'}`}><div className="pt-4">{children}</div></div>}
    </div>
  );
};

const CollapsibleGroupPreview = ({ darkMode }) => {
  const [expanded, setExpanded] = useState(false);
  return (
    <div className={`rounded-xl overflow-hidden ${darkMode ? 'bg-white/[0.04] border border-white/[0.06]' : 'bg-white border border-gray-200'}`}>
      <button onClick={() => setExpanded(!expanded)} className="w-full px-3 py-2.5 flex items-center gap-3">
        <ProgressCircle progress={60} size={36} strokeWidth={3} color="rose" icon={'\u{1F3AD}'} gradientId="xr-cg" darkMode={darkMode} iconSize="text-sm" />
        <span className={`flex-1 text-left text-sm font-medium ${TH('text-primary', darkMode)}`}>Personality</span>
        <span className={`text-xs ${darkMode ? 'text-rose-400' : 'text-rose-600'}`}>3/5</span>
        <span className={`text-xs transition-transform ${expanded ? 'rotate-180' : ''} ${TH('text-dim', darkMode)}`}>{'\u25BC'}</span>
      </button>
      {expanded && (
        <div className={`border-t ${darkMode ? 'border-gray-800/50' : 'border-gray-200'} p-3 space-y-3`}>
          <TraitSpectrum name="Extraversion" score={72} lowLabel="Reserved" highLabel="Outgoing" color="indigo" darkMode={darkMode} />
          <TraitSpectrum name="Agreeableness" score={58} lowLabel="Direct" highLabel="Empathetic" color="blue" darkMode={darkMode} />
        </div>
      )}
    </div>
  );
};

// --- Identity & Profile Components ---
const StampIcon = ({ provider, size = 16, className = '' }) => (
  <svg width={size} height={size} viewBox="0 0 16 16" fill={provider.color} className={className} style={{ flexShrink: 0 }}>
    <path d={provider.svg} fillRule="evenodd" clipRule="evenodd" />
  </svg>
);

const SubjectCardPreview = ({ subject, isDone, darkMode }) => {
  const sc = isDone ? COLOR_HEX.emerald : COLOR_HEX.violet;
  return (
    <div className="w-full rounded-2xl p-3.5 text-left" style={{ background: darkMode ? 'rgba(255,255,255,0.04)' : 'rgba(0,0,0,0.02)', border: darkMode ? '1px solid rgba(255,255,255,0.06)' : '1px solid rgba(0,0,0,0.06)' }}>
      <div className="flex items-center gap-3">
        <div className="w-9 h-9 rounded-full flex items-center justify-center text-xs font-bold flex-shrink-0"
          style={{ background: `rgba(${sc.rgb}, 0.2)`, color: darkMode ? sc.light : sc.base }}>{subject.name[0]}</div>
        <div className="flex-1 min-w-0">
          <div className={`text-sm font-semibold ${TH('text-primary', darkMode)}`}>{subject.name}</div>
          <div className={`text-xs ${TH('text-dim', darkMode)}`}>{subject.city}{subject.connections > 0 ? ` \u00B7 ${subject.connections}` : ''}</div>
        </div>
        {isDone ? <span className={`text-xs font-medium px-2 py-0.5 rounded-full ${darkMode ? 'bg-emerald-500/20 text-emerald-400' : 'bg-emerald-100 text-emerald-700'}`}>Done</span>
          : <span style={{ color: darkMode ? 'rgba(255,255,255,0.2)' : 'rgba(0,0,0,0.2)', fontSize: 14 }}>{'\u203A'}</span>}
      </div>
    </div>
  );
};

const StampRowPreview = ({ provider, isLinked, darkMode }) => (
  <div className={`rounded-xl px-3 py-3 flex items-center gap-2.5 ${darkMode ? 'bg-white/[0.04] border border-white/[0.08]' : 'bg-white border border-gray-200'}`}>
    <StampIcon provider={provider} size={18} />
    <div className="flex-1 min-w-0">
      <span className={`text-sm font-medium ${darkMode ? 'text-white' : 'text-gray-900'}`}>{provider.name}</span>
      {isLinked && <span className={`text-xs ml-2 ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>@username</span>}
    </div>
    {isLinked ? <span className={`text-xs px-2 py-0.5 rounded-full ${darkMode ? 'bg-emerald-500/20 text-emerald-400' : 'bg-emerald-100 text-emerald-700'}`}>Linked</span>
      : <button className={`text-xs px-3 py-1.5 rounded-lg ${darkMode ? 'bg-white/[0.06] text-gray-400' : 'bg-gray-100 text-gray-600'}`}>Link</button>}
  </div>
);

const AssessProgressCirclePreview = ({ darkMode }) => (
  <div className="flex items-center gap-4 justify-center">
    <ProgressCircle progress={72} size={48} strokeWidth={3} color="blue" icon={'\u2728'} gradientId="xr-apc1" darkMode={darkMode} />
    <ProgressCircle progress={35} size={48} strokeWidth={3} color="rose" icon={'\u{1F3AD}'} gradientId="xr-apc2" darkMode={darkMode} />
    <ProgressCircle progress={100} size={48} strokeWidth={3} color="emerald" gradientId="xr-apc3" darkMode={darkMode} text={'\u2713'} />
  </div>
);

// ===== ERROR BOUNDARY =====
class ErrorBoundary extends React.Component {
  constructor(props) { super(props); this.state = { hasError: false, error: null }; }
  static getDerivedStateFromError(error) { return { hasError: true, error }; }
  render() {
    if (this.state.hasError) return (
      <div className="p-3 rounded-lg bg-red-500/10 border border-red-500/30 text-center">
        <div className="text-red-400 text-xs font-medium mb-1">{this.props.name || 'Component'}</div>
        <div className="text-red-300/60 text-[10px] truncate">{this.state.error?.message}</div>
      </div>
    );
    return this.props.children;
  }
}

// ===== XRAY CATALOG =====
const XRAY_CATALOG = [
  {
    category: 'Primitives', color: 'violet',
    components: [
      { name: 'ProgressCircle', line: 5134, sizing: 'small', tier: 1, render: (dm) => <ProgressCircle progress={65} color="violet" size={48} darkMode={dm} gradientId="xr-pc1" /> },
      { name: 'ProgressCircle (text)', line: 5134, sizing: 'small', tier: 1, render: (dm) => <ProgressCircle progress={88} color="emerald" size={56} darkMode={dm} gradientId="xr-pc2" text="88" /> },
      { name: 'SpectrumBar', line: 5224, sizing: 'medium', tier: 1, render: (dm) => <SpectrumBar value={65} testId="bigfive-E" showLabels darkMode={dm} /> },
      { name: 'HintCard', line: 5251, sizing: 'medium', tier: 1, render: (dm) => <HintCard color="violet" text="You tend toward creative thinking" subtitle="Based on 12 responses" darkMode={dm} /> },
      { name: 'ScoreGauge', line: 5290, sizing: 'small', tier: 1, render: (dm) => <ScoreGauge value={72} label="Openness" darkMode={dm} gradientClass="from-violet-600 to-violet-500" /> },
      { name: 'TraitSpectrum', line: 5336, sizing: 'medium', tier: 1, render: (dm) => <TraitSpectrum name="Extraversion" score={38} lowLabel="Reserved" highLabel="Outgoing" color="indigo" darkMode={dm} /> },
      { name: 'TraitSpectrum (compact)', line: 5336, sizing: 'medium', tier: 1, render: (dm) => <TraitSpectrum name="Openness" score={72} lowLabel="Practical" highLabel="Curious" color="violet" darkMode={dm} compact /> },
      { name: 'ConfidenceBar', line: 5402, sizing: 'medium', tier: 1, render: (dm) => <ConfidenceBar label="YES" pct={62} confCounts={[50,120,200,180]} colors={BINARY_COLORS.yes} maxCount={600} darkMode={dm} /> },
      { name: 'ConfidenceSegments', line: 6107, sizing: 'small', tier: 1, render: (dm) => <div className="relative w-48 h-12 rounded-xl" style={{background: dm ? 'rgba(255,255,255,0.06)' : 'rgba(0,0,0,0.06)'}}><ConfidenceSegments level={3} color="emerald" active darkMode={dm} /></div> },
    ]
  },
  {
    category: 'Buttons & Controls', color: 'blue',
    components: [
      { name: 'VortexButton', line: 5540, sizing: 'small', tier: 1, render: (dm) => <VortexButton onSingleTap={noop} /> },
      { name: 'OptionChip', line: 6424, sizing: 'small', tier: 1, render: (dm) => <div className="flex gap-2"><OptionChip label="All" selected onClick={noop} darkMode={dm} /><OptionChip label="Binary" selected={false} onClick={noop} darkMode={dm} /><OptionChip label="MC" selected={false} onClick={noop} darkMode={dm} /></div> },
      { name: 'BinaryButtons', line: 7137, sizing: 'medium', tier: 2, render: (dm) => <BinaryButtons darkMode={dm} /> },
      { name: 'MCButtons', line: 7237, sizing: 'medium', tier: 2, render: (dm) => <MCButtons options={['Vision','Empathy','Decisiveness','Integrity']} darkMode={dm} /> },
      { name: 'VerifyActionButton', line: 7768, sizing: 'medium', tier: 1, render: (dm) => <div className="space-y-2 w-full"><VerifyActionButton label="Continue" color="emerald" darkMode={dm} onClick={noop} /><VerifyActionButton label="Skip" color="emerald" darkMode={dm} onClick={noop} secondary /></div> },
      { name: 'VerifyOptionButton', line: 7802, sizing: 'medium', tier: 1, render: (dm) => <div className="space-y-2 w-full"><VerifyOptionButton label="Close friend" selected color="emerald" darkMode={dm} onClick={noop} /><VerifyOptionButton label="Acquaintance" selected={false} color="emerald" darkMode={dm} onClick={noop} /></div> },
      { name: 'VerifyStarConfidence', line: 7830, sizing: 'medium', tier: 1, render: (dm) => <VerifyStarConfidence color="emerald" darkMode={dm} value={3} onChange={noop} /> },
      { name: 'VerifyChipButton', line: 8272, sizing: 'small', tier: 1, render: (dm) => <div className="flex gap-2"><VerifyChipButton label="Weekly" selected color="teal" darkMode={dm} onClick={noop} /><VerifyChipButton label="Monthly" selected={false} color="teal" darkMode={dm} onClick={noop} /></div> },
      { name: 'VerifyToggleSwitch', line: 8034, sizing: 'medium', tier: 1, render: (dm) => { const [on, setOn] = useState(true); return <div className="space-y-2 w-full"><VerifyToggleSwitch label="Available weekends" color="emerald" darkMode={dm} isOn={on} onToggle={() => setOn(!on)} /><VerifyToggleSwitch label="Prefers text" color="emerald" darkMode={dm} isOn={false} onToggle={noop} /></div>; } },
    ]
  },
  {
    category: 'Cards & Content', color: 'teal',
    components: [
      { name: 'QuestionCard', line: 7073, sizing: 'medium', tier: 2, render: (dm) => <QuestionCard question={MOCK_QUESTIONS[0]} darkMode={dm} /> },
      { name: 'ResultCard', line: 5267, sizing: 'medium', tier: 1, render: (dm) => <ResultCard icon="ðŸŽ­" title="Big Five" subtitle="Personality Profile" darkMode={dm} gradientClass="from-violet-600 to-violet-500"><InsightRow emoji="ðŸ’¡" label="Key" text="High openness to experience" darkMode={dm} colorClass={dm?'text-violet-400':'text-violet-600'} /></ResultCard> },
      { name: 'InsightRow', line: 5282, sizing: 'medium', tier: 1, render: (dm) => <InsightRow emoji="ðŸ’¡" label="Strength" text="Creative problem solving" darkMode={dm} colorClass={dm ? 'text-violet-400' : 'text-violet-600'} /> },
      { name: 'TipBanner', line: 7057, sizing: 'medium', tier: 2, render: (dm) => <TipBanner darkMode={dm} onDismiss={noop} /> },
      { name: 'UndoBar (binary)', line: 6964, sizing: 'medium', tier: 2, render: (dm) => <UndoBar darkMode={dm} answer={0} confidence={3} isBinary /> },
      { name: 'UndoBar (MC)', line: 6964, sizing: 'medium', tier: 2, render: (dm) => <UndoBar darkMode={dm} answer={1} confidence={2} isBinary={false} options={['Vision','Empathy','Decisiveness','Integrity']} /> },
      { name: 'VerifySubjectBanner', line: 7654, sizing: 'medium', tier: 2, render: (dm) => <VerifySubjectBanner subject={{name:'Sarah Chen',city:'San Francisco'}} color="emerald" darkMode={dm} /> },
    ]
  },
  {
    category: 'Navigation', color: 'indigo',
    components: [
      { name: 'NavBar', line: 5562, sizing: 'medium', tier: 2, render: (dm) => <NavBar darkMode={dm} stats={MOCK_STATS} showStreak onHome={noop} onSettings={noop} onProfile={noop} isLoggedIn assessCompleted={MOCK_ASSESS_COMPLETED} displayName="Demo" /> },
      { name: 'ScreenHeader', line: 5391, sizing: 'medium', tier: 1, render: (dm) => <ScreenHeader title="Assessment Results" onBack={noop} darkMode={dm} /> },
      { name: 'ScreenHeader (centered)', line: 5391, sizing: 'medium', tier: 1, render: (dm) => <ScreenHeader title="Aura" darkMode={dm} /> },
      { name: 'VerifyModeToggle', line: 8392, sizing: 'small', tier: 2, render: (dm) => { const [exp, setExp] = useState(false); return <VerifyModeToggle darkMode={dm} expertMode={exp} setExpertMode={setExp} />; } },
      { name: 'VerifyScreenLayout', line: 7693, sizing: 'screen', tier: 2, render: (dm) => <VerifyScreenLayout darkMode={dm} color="emerald" sectionLabel="Evaluation" buttons={<VerifyActionButton label="Next" color="emerald" darkMode={dm} onClick={noop} />}><p className={`text-center text-sm ${TH('text-primary',dm)}`}>How often do you interact?</p></VerifyScreenLayout> },
    ]
  },
  {
    category: 'Modals', color: 'rose',
    components: [
      { name: 'SaveProgressModal', line: 6049, sizing: 'medium', tier: 2, render: (dm) => <SaveProgressModal onCreateAccount={noop} onLater={noop} darkMode={dm} /> },
      { name: 'LevelUpModal', line: 6069, sizing: 'medium', tier: 2, render: (dm) => <LevelUpModal level={3} title="Explorer" onClose={noop} darkMode={dm} /> },
      { name: 'BottomSheet', line: 6410, sizing: 'medium', tier: 2, render: (dm) => <BottomSheet darkMode={dm}><div className="space-y-2"><button className={`w-full py-2 rounded-lg text-sm ${dm?'text-gray-300':'text-gray-700'}`}>Flag Question</button><button className={`w-full py-2 rounded-lg text-sm ${dm?'text-gray-300':'text-gray-700'}`}>Skip</button></div></BottomSheet> },
    ]
  },
  {
    category: 'Auth & Onboarding', color: 'emerald',
    components: [
      { name: 'WelcomeScreenPreview', line: 0, sizing: 'screen', tier: 3, render: (dm) => <WelcomeScreenPreview darkMode={dm} /> },
      { name: 'OnboardingPreview', line: 0, sizing: 'screen', tier: 3, render: (dm) => <OnboardingPreview darkMode={dm} /> },
      { name: 'PathChoicePreview', line: 0, sizing: 'screen', tier: 3, render: (dm) => <PathChoicePreview darkMode={dm} /> },
    ]
  },
  {
    category: 'Main Screens', color: 'amber',
    components: [
      { name: 'CategoryScreenPreview', line: 0, sizing: 'screen', tier: 3, render: (dm) => <CategoryScreenPreview darkMode={dm} /> },
      { name: 'ProfileScreenPreview', line: 0, sizing: 'screen', tier: 3, render: (dm) => <ProfileScreenPreview darkMode={dm} /> },
      { name: 'QotdPreview', line: 0, sizing: 'screen', tier: 3, render: (dm) => <QotdPreview darkMode={dm} /> },
      { name: 'QuestionFlowPreview', line: 0, sizing: 'screen', tier: 3, render: (dm) => <QuestionFlowPreview darkMode={dm} /> },
      { name: 'HistoryPreview', line: 0, sizing: 'screen', tier: 3, render: (dm) => <HistoryPreview darkMode={dm} /> },
      { name: 'SettingsPreview', line: 0, sizing: 'screen', tier: 3, render: (dm) => <SettingsPreview darkMode={dm} /> },
    ]
  },
  {
    category: 'Assessments', color: 'pink',
    components: [
      { name: 'AssessPickerPreview', line: 0, sizing: 'screen', tier: 3, render: (dm) => <AssessPickerPreview darkMode={dm} /> },
      { name: 'AssessQuestionPreview', line: 0, sizing: 'screen', tier: 3, render: (dm) => <AssessQuestionPreview darkMode={dm} /> },
      { name: 'AssessResultsPreview', line: 0, sizing: 'screen', tier: 3, render: (dm) => <AssessResultsPreview darkMode={dm} /> },
      { name: 'AssessAnalysisPreview', line: 0, sizing: 'screen', tier: 3, render: (dm) => <AssessAnalysisPreview darkMode={dm} /> },
    ]
  },
  {
    category: 'Verification', color: 'cyan',
    components: [
      { name: 'VerifyHubPreview', line: 0, sizing: 'screen', tier: 3, render: (dm) => <VerifyHubPreview darkMode={dm} /> },
      { name: 'SharePickerPreview', line: 0, sizing: 'screen', tier: 3, render: (dm) => <SharePickerPreview darkMode={dm} /> },
      { name: 'PublicProfilePreview', line: 0, sizing: 'screen', tier: 3, render: (dm) => <PublicProfilePreview darkMode={dm} /> },
      { name: 'IdentityScreenPreview', line: 0, sizing: 'screen', tier: 3, render: (dm) => <IdentityScreenPreview darkMode={dm} /> },
    ]
  },
  {
    category: 'Verify Inputs', color: 'emerald',
    components: [
      { name: 'VerifySingleSelect', line: 7973, sizing: 'medium', tier: 1, render: (dm) => { const [a, sA] = useState(null); return <VerifySingleSelect question={MOCK_VERIFY_Q.singleSelect} color="emerald" darkMode={dm} answer={a} onAnswer={sA} />; } },
      { name: 'VerifyTextInput', line: 8015, sizing: 'medium', tier: 1, render: (dm) => { const [a, sA] = useState(''); return <VerifyTextInput question={MOCK_VERIFY_Q.textInput} color="emerald" darkMode={dm} answer={a} onAnswer={sA} />; } },
      { name: 'VerifyMultiToggle', line: 7985, sizing: 'medium', tier: 1, render: (dm) => { const [a, sA] = useState([]); return <VerifyMultiToggle question={MOCK_VERIFY_Q.multiToggle} color="emerald" darkMode={dm} answer={a} onAnswer={sA} />; } },
      { name: 'VerifyVerdict', line: 7883, sizing: 'medium', tier: 1, render: (dm) => { const [a, sA] = useState({}); return <VerifyVerdict question={MOCK_VERIFY_Q.verdict} color="emerald" darkMode={dm} answer={a} onAnswer={sA} />; } },
      { name: 'VerifyCompactConnection', line: 8294, sizing: 'medium', tier: 1, render: (dm) => { const [a, sA] = useState({}); return <VerifyCompactConnection question={MOCK_VERIFY_Q.compact} color="teal" darkMode={dm} answer={a} onAnswer={sA} />; } },
      { name: 'VerifyIdentityCheck', line: 8328, sizing: 'medium', tier: 1, render: (dm) => { const [a, sA] = useState({}); return <VerifyIdentityCheck question={MOCK_VERIFY_Q.identity} color="teal" darkMode={dm} answer={a} onAnswer={sA} />; } },
      { name: 'VerifyEvidenceCombined', line: 8363, sizing: 'medium', tier: 1, render: (dm) => { const [a, sA] = useState({}); return <VerifyEvidenceCombined question={MOCK_VERIFY_Q.evidence} color="emerald" darkMode={dm} answer={a} onAnswer={sA} />; } },
      { name: 'SubjectCard', line: 8085, sizing: 'medium', tier: 2, render: (dm) => <div className="space-y-2 w-full"><SubjectCardPreview subject={MOCK_SUBJECTS[0]} isDone={false} darkMode={dm} /><SubjectCardPreview subject={MOCK_SUBJECTS[1]} isDone={true} darkMode={dm} /></div> },
    ]
  },
  {
    category: 'Additional Modals', color: 'rose',
    components: [
      { name: 'QuestionFlagModal', line: 6444, sizing: 'medium', tier: 2, render: (dm) => <QuestionFlagModalPreview darkMode={dm} /> },
      { name: 'ExplanationModal', line: 6484, sizing: 'medium', tier: 2, render: (dm) => <ExplanationModalPreview darkMode={dm} /> },
      { name: 'CantAnswerModal', line: 6526, sizing: 'medium', tier: 2, render: (dm) => <CantAnswerModalPreview darkMode={dm} /> },
      { name: 'NoneOptionModal', line: 6559, sizing: 'medium', tier: 2, render: (dm) => <NoneOptionModalPreview darkMode={dm} /> },
    ]
  },
  {
    category: 'Charts & Results', color: 'amber',
    components: [
      { name: 'ResultChart (binary)', line: 6131, sizing: 'medium', tier: 2, render: (dm) => <ResultChart question={MOCK_QUESTIONS[0]} darkMode={dm} /> },
      { name: 'ResultChart (MC)', line: 6131, sizing: 'medium', tier: 2, render: (dm) => <ResultChart question={MOCK_QUESTIONS[2]} darkMode={dm} /> },
      { name: 'MiniCommunityResults', line: 6175, sizing: 'medium', tier: 2, render: (dm) => <MiniCommunityResultsPreview darkMode={dm} /> },
      { name: 'CommunityResultsRows', line: 6321, sizing: 'medium', tier: 2, render: (dm) => <CommunityResultsRowsPreview darkMode={dm} /> },
      { name: 'FullResultsPanel', line: 6349, sizing: 'medium', tier: 3, render: (dm) => <FullResultsPanelPreview darkMode={dm} /> },
      { name: 'AnsweredQuestionView', line: 6582, sizing: 'screen', tier: 3, render: (dm) => <AnsweredQuestionPreview darkMode={dm} /> },
    ]
  },
  {
    category: 'Analysis & Identity', color: 'slate',
    components: [
      { name: 'SemiGauge', line: 12312, sizing: 'small', tier: 1, render: (dm) => <div className="flex items-center gap-3 justify-center"><SemiGauge value={72} testId="bigfive-E" size={64} /><SemiGauge value={38} testId="bigfive-A" size={64} /><SemiGauge value={55} testId="bigfive-O" size={64} /></div> },
      { name: 'AnalysisCard', line: 12101, sizing: 'medium', tier: 2, render: (dm) => <AnalysisCardPreview id="xr1" icon={'\u{1F3AD}'} title="Personality" subtitle="Big Five traits" color="rose" progress={65} darkMode={dm}><TraitSpectrum name="Extraversion" score={72} lowLabel="Reserved" highLabel="Outgoing" color="indigo" darkMode={dm} /></AnalysisCardPreview> },
      { name: 'CollapsibleGroup', line: 12402, sizing: 'medium', tier: 2, render: (dm) => <CollapsibleGroupPreview darkMode={dm} /> },
      { name: 'StampIcon', line: 4737, sizing: 'small', tier: 1, render: (dm) => <div className="flex items-center gap-4 justify-center">{STAMP_PROVIDERS.map(p => <div key={p.id} className="flex items-center gap-2"><StampIcon provider={p} size={24} /><span className={`text-xs ${TH('text-muted', dm)}`}>{p.name}</span></div>)}</div> },
      { name: 'StampRow', line: 9785, sizing: 'medium', tier: 2, render: (dm) => <div className="space-y-2 w-full"><StampRowPreview provider={STAMP_PROVIDERS[0]} isLinked={true} darkMode={dm} /><StampRowPreview provider={STAMP_PROVIDERS[1]} isLinked={false} darkMode={dm} /></div> },
      { name: 'AssessProgressCircle', line: 5370, sizing: 'small', tier: 1, render: (dm) => <AssessProgressCirclePreview darkMode={dm} /> },
    ]
  },
];

// ===== PHONE MODELS & CONTAINER =====
const PHONE_MODELS = [
  { id: 'se', label: 'iPhone SE', w: 375, h: 667 },
  { id: '15', label: 'iPhone 15', w: 393, h: 852 },
  { id: '15pm', label: 'iPhone 15 PM', w: 430, h: 932 },
  { id: 'pixel', label: 'Pixel 8', w: 412, h: 915 },
  { id: 'galaxy', label: 'Galaxy S24', w: 360, h: 780 },
];

const PhoneContext = React.createContext(PHONE_MODELS[1]);

const XRayPhone = ({ children, darkMode, isScreen = false }) => {
  const phone = React.useContext(PhoneContext);
  const h = isScreen ? phone.h : Math.min(400, phone.h * 0.47);
  return (
    <div className={darkMode ? '' : 'light-theme'} style={{
      width: phone.w, height: h, overflow: 'hidden', flexShrink: 0,
      borderRadius: 16,
      border: darkMode ? '1px solid rgba(255,255,255,0.08)' : '1px solid rgba(0,0,0,0.10)',
      background: darkMode ? '#030712' : '#f9fafb',
      display: 'flex', flexDirection: 'column',
      ...(!isScreen ? { alignItems: 'center', justifyContent: 'center', padding: 16 } : {}),
    }}>
      {children}
    </div>
  );
};

// ===== XRAY APP =====
const TIER_BADGES = { 1: { label: 'T1', color: '#10b981' }, 2: { label: 'T2', color: '#3b82f6' }, 3: { label: 'T3', color: '#f59e0b' }, 4: { label: 'T4', color: '#8b5cf6' } };

const SORT_OPTIONS = [
  { id: 'default', label: 'Default' },
  { id: 'alpha', label: 'A â†’ Z' },
  { id: 'tier', label: 'By Tier' },
  { id: 'line', label: 'By Line #' },
];

// Persist settings across reloads
const XR_KEY = 'xray-settings';
const loadSettings = () => { try { return JSON.parse(localStorage.getItem(XR_KEY)) || {}; } catch { return {}; } };
const saveSettings = (s) => localStorage.setItem(XR_KEY, JSON.stringify(s));

const XRayApp = () => {
  const saved = React.useMemo(loadSettings, []);
  const [darkMode, setDarkMode] = useState(saved.darkMode !== undefined ? saved.darkMode : true);
  const [zoom, setZoom] = useState(saved.zoom || 100);
  const [hiddenCats, setHiddenCats] = useState({});
  const [collapsedCats, setCollapsedCats] = useState(saved.collapsedCats || {});
  const [phoneId, setPhoneId] = useState(saved.phoneId || '15');
  const phone = PHONE_MODELS.find(p => p.id === phoneId) || PHONE_MODELS[1];
  const [modal, setModal] = useState(null);
  const [search, setSearch] = useState('');
  const [sortBy, setSortBy] = useState(saved.sortBy || 'default');
  const [compact, setCompact] = useState(saved.compact || false);
  const [compareList, setCompareList] = useState([]);
  const [tocOpen, setTocOpen] = useState(false);
  const [hiddenComps, setHiddenComps] = useState(saved.hiddenComps || {});

  // Persist settings on change
  useEffect(() => {
    saveSettings({ darkMode, zoom, collapsedCats, phoneId, sortBy, compact, hiddenComps });
  }, [darkMode, zoom, collapsedCats, phoneId, sortBy, compact, hiddenComps]);
  const toggleHideComp = (name) => setHiddenComps(p => ({ ...p, [name]: !p[name] }));
  const compId = (name) => 'xr-' + name.replace(/[^a-zA-Z0-9]/g, '-');
  const scrollToComp = (name) => {
    const el = document.getElementById(compId(name));
    if (el) {
      el.scrollIntoView({ behavior: 'smooth', block: 'center' });
      el.style.outline = '2px solid #8b5cf6';
      el.style.outlineOffset = '4px';
      setTimeout(() => { el.style.outline = 'none'; }, 1500);
    }
    setTocOpen(false);
  };

  useEffect(() => {
    const handler = (e) => { if (e.key === 'Escape') { setModal(null); setCompareList([]); } };
    window.addEventListener('keydown', handler);
    return () => window.removeEventListener('keydown', handler);
  }, []);

  const totalComponents = XRAY_CATALOG.reduce((sum, cat) => sum + cat.components.length, 0) + 1;
  const bg = darkMode ? '#030712' : '#f9fafb';
  const textPrimary = darkMode ? '#fff' : '#111827';
  const textMuted = darkMode ? '#9ca3af' : '#6b7280';
  const cardBg = darkMode ? 'rgba(255,255,255,0.03)' : 'rgba(255,255,255,0.9)';
  const cardBorder = darkMode ? 'rgba(255,255,255,0.06)' : 'rgba(0,0,0,0.10)';

  const toggleCat = (cat) => setHiddenCats(p => ({ ...p, [cat]: !p[cat] }));
  const toggleCollapse = (cat) => setCollapsedCats(p => ({ ...p, [cat]: !p[cat] }));
  const catSectionId = (cat) => 'xr-cat-' + cat.replace(/[^a-zA-Z0-9]/g, '-');
  const scrollToCat = (catName) => {
    // Uncollapse if collapsed
    if (collapsedCats[catName]) setCollapsedCats(p => ({ ...p, [catName]: false }));
    setTimeout(() => {
      const el = document.getElementById(catSectionId(catName));
      if (el) {
        el.scrollIntoView({ behavior: 'smooth', block: 'start' });
        el.querySelector('button').style.outline = '2px solid #8b5cf6';
        el.querySelector('button').style.outlineOffset = '2px';
        setTimeout(() => { const b = el.querySelector('button'); if (b) b.style.outline = 'none'; }, 1500);
      }
    }, 50);
  };

  // Search filter
  const searchLower = search.toLowerCase();
  const filterComp = (comp) => !search || comp.name.toLowerCase().includes(searchLower);

  // Sort
  const sortComps = (comps) => {
    if (sortBy === 'alpha') return [...comps].sort((a, b) => a.name.localeCompare(b.name));
    if (sortBy === 'tier') return [...comps].sort((a, b) => a.tier - b.tier);
    if (sortBy === 'line') return [...comps].sort((a, b) => a.line - b.line);
    return comps;
  };

  // Compare mode
  const toggleCompare = (comp, catColor) => {
    setCompareList(prev => {
      const exists = prev.find(c => c.comp.name === comp.name);
      if (exists) return prev.filter(c => c.comp.name !== comp.name);
      if (prev.length >= 4) return prev;
      return [...prev, { comp, catColor }];
    });
  };
  const isComparing = compareList.length > 0;

  return (
    <div style={{ background: bg, minHeight: '100vh', color: textPrimary }}>
      {/* Sticky Header */}
      <div style={{ position: 'sticky', top: 0, zIndex: 100, background: darkMode ? 'rgba(3,7,18,0.92)' : 'rgba(249,250,251,0.92)', backdropFilter: 'blur(12px)', borderBottom: `1px solid ${cardBorder}`, padding: '12px 20px' }}>
        {/* Row 1: Title + controls */}
        <div style={{ display: 'flex', alignItems: 'center', gap: 12, flexWrap: 'wrap' }}>
          <h1 style={{ fontSize: 20, fontWeight: 700, margin: 0 }}>Aura X-Ray</h1>
          <span style={{ fontSize: 12, color: textMuted }}>{totalComponents} components</span>
          <div style={{ flex: 1 }} />
          {/* Search */}
          <input value={search} onChange={e => setSearch(e.target.value)} placeholder="Search components..." style={{ width: 180, padding: '4px 10px', borderRadius: 8, fontSize: 12, background: darkMode ? 'rgba(255,255,255,0.06)' : 'rgba(0,0,0,0.04)', color: textPrimary, border: `1px solid ${cardBorder}`, outline: 'none' }} />
          {/* Sort */}
          <select value={sortBy} onChange={e => setSortBy(e.target.value)} style={{ padding: '4px 8px', borderRadius: 8, fontSize: 11, background: darkMode ? 'rgba(255,255,255,0.06)' : 'rgba(0,0,0,0.04)', color: textPrimary, border: `1px solid ${cardBorder}`, outline: 'none' }}>
            {SORT_OPTIONS.map(s => <option key={s.id} value={s.id}>{s.label}</option>)}
          </select>
          {/* Compact toggle */}
          <button onClick={() => setCompact(!compact)} style={{ padding: '4px 10px', borderRadius: 8, fontSize: 11, fontWeight: compact ? 700 : 500, background: compact ? 'rgba(139,92,246,0.2)' : 'transparent', color: compact ? '#a78bfa' : textMuted, border: `1px solid ${compact ? 'rgba(139,92,246,0.4)' : cardBorder}`, cursor: 'pointer' }}>
            {compact ? 'Compact' : 'Full'}
          </button>
          {/* Zoom */}
          <label style={{ fontSize: 11, color: textMuted, display: 'flex', alignItems: 'center', gap: 4 }}>
            <input type="range" min={30} max={200} value={zoom} onChange={e => setZoom(+e.target.value)} style={{ width: 80, accentColor: '#8b5cf6' }} />
            <span style={{ width: 28, textAlign: 'right' }}>{zoom}%</span>
          </label>
          {/* Dark/Light */}
          <button onClick={() => setDarkMode(!darkMode)} style={{ padding: '4px 10px', borderRadius: 8, fontSize: 11, fontWeight: 600, background: darkMode ? 'rgba(255,255,255,0.08)' : 'rgba(0,0,0,0.06)', color: textPrimary, border: `1px solid ${cardBorder}`, cursor: 'pointer' }}>
            {darkMode ? '\u2600\uFE0F' : '\u{1F319}'}
          </button>
          {/* Index drawer toggle */}
          <button onClick={() => setTocOpen(!tocOpen)} style={{ padding: '4px 10px', borderRadius: 8, fontSize: 11, fontWeight: tocOpen ? 700 : 500, background: tocOpen ? 'rgba(139,92,246,0.2)' : 'transparent', color: tocOpen ? '#a78bfa' : textMuted, border: `1px solid ${tocOpen ? 'rgba(139,92,246,0.4)' : cardBorder}`, cursor: 'pointer' }}>
            Index
          </button>
        </div>
        {/* Row 2: Phone models + category pills */}
        <div style={{ display: 'flex', gap: 6, marginTop: 8, flexWrap: 'wrap', alignItems: 'center' }}>
          {/* Phone pills */}
          {PHONE_MODELS.map(pm => (
            <button key={pm.id} onClick={() => setPhoneId(pm.id)} style={{ padding: '2px 7px', borderRadius: 6, fontSize: 10, fontWeight: phoneId === pm.id ? 700 : 500, cursor: 'pointer', background: phoneId === pm.id ? 'rgba(139,92,246,0.2)' : 'transparent', color: phoneId === pm.id ? '#a78bfa' : textMuted, border: `1px solid ${phoneId === pm.id ? 'rgba(139,92,246,0.4)' : cardBorder}`, transition: 'all 0.15s', whiteSpace: 'nowrap' }}>
              {pm.label} <span style={{ opacity: 0.5 }}>{pm.w}</span>
            </button>
          ))}
          <div style={{ width: 1, height: 16, background: cardBorder, margin: '0 4px' }} />
          {/* Category pills */}
          {[...XRAY_CATALOG, { category: 'Special', color: 'violet', components: [{}] }].map(cat => {
            const c = COLOR_HEX[cat.color] || COLOR_HEX.violet;
            return (
              <button key={cat.category} onClick={() => scrollToCat(cat.category)} style={{ display: 'flex', alignItems: 'center', gap: 4, padding: '2px 8px', borderRadius: 10, fontSize: 10, fontWeight: 500, cursor: 'pointer', background: `rgba(${c.rgb}, 0.15)`, border: `1px solid rgba(${c.rgb}, 0.35)`, color: darkMode ? c.light : c.base, transition: 'all 0.2s' }}>
                <div style={{ width: 5, height: 5, borderRadius: '50%', background: c.base }} />
                {cat.category}
                <span style={{ fontSize: 9, opacity: 0.6 }}>({cat.components.length})</span>
              </button>
            );
          })}
        </div>
      </div>

      {/* TOC Drawer */}
      {tocOpen && (
        <div style={{ position: 'fixed', top: 0, left: 0, bottom: 0, width: 280, zIndex: 250, background: darkMode ? 'rgba(3,7,18,0.97)' : 'rgba(249,250,251,0.97)', backdropFilter: 'blur(16px)', borderRight: `1px solid ${cardBorder}`, overflowY: 'auto', padding: '12px 0 20px 0' }}>
          <div style={{ padding: '0 16px 12px', display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>
            <span style={{ fontSize: 14, fontWeight: 700 }}>Component Index</span>
            <button onClick={() => setTocOpen(false)} style={{ fontSize: 14, color: textMuted, cursor: 'pointer', background: darkMode ? 'rgba(255,255,255,0.06)' : 'rgba(0,0,0,0.06)', border: 'none', borderRadius: 6, width: 24, height: 24, display: 'flex', alignItems: 'center', justifyContent: 'center' }}>{'\u2715'}</button>
          </div>
          {XRAY_CATALOG.map(cat => {
            const c = COLOR_HEX[cat.color] || COLOR_HEX.violet;
            const filtered = cat.components.filter(filterComp);
            if (filtered.length === 0 || hiddenCats[cat.category]) return null;
            return (
              <div key={cat.category} style={{ marginBottom: 8 }}>
                <div style={{ padding: '4px 16px', display: 'flex', alignItems: 'center', gap: 6 }}>
                  <div style={{ width: 6, height: 6, borderRadius: '50%', background: c.base, flexShrink: 0 }} />
                  <span style={{ fontSize: 11, fontWeight: 600, color: darkMode ? c.light : c.base }}>{cat.category}</span>
                  <span style={{ fontSize: 9, color: textMuted }}>({filtered.length})</span>
                </div>
                {filtered.map(comp => (
                  <button key={comp.name} onClick={() => scrollToComp(comp.name)} style={{ display: 'flex', alignItems: 'center', gap: 6, width: '100%', padding: '3px 16px 3px 28px', background: 'none', border: 'none', cursor: 'pointer', textAlign: 'left', color: hiddenComps[comp.name] ? textMuted : textPrimary, opacity: hiddenComps[comp.name] ? 0.4 : 1, fontSize: 11, transition: 'background 0.1s' }}
                    onMouseOver={e => e.currentTarget.style.background = darkMode ? 'rgba(255,255,255,0.06)' : 'rgba(0,0,0,0.04)'}
                    onMouseOut={e => e.currentTarget.style.background = 'none'}>
                    <span style={{ flex: 1, overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>{comp.name}</span>
                    {comp.line > 0 && <span style={{ fontSize: 9, color: textMuted, flexShrink: 0 }}>L{comp.line}</span>}
                  </button>
                ))}
              </div>
            );
          })}
        </div>
      )}
      {tocOpen && <div onClick={() => setTocOpen(false)} style={{ position: 'fixed', inset: 0, zIndex: 240, background: 'rgba(0,0,0,0.3)' }} />}

      {/* Grid */}
      <PhoneContext.Provider value={phone}>
      <div style={{ padding: compact ? 12 : 20, transform: `scale(${zoom/100})`, transformOrigin: 'top left', width: `${10000/zoom}%` }}>
        {XRAY_CATALOG.map(cat => {
          const c = COLOR_HEX[cat.color] || COLOR_HEX.violet;
          const collapsed = collapsedCats[cat.category];
          const filtered = sortComps(cat.components.filter(filterComp));
          if (filtered.length === 0) return null;
          return (
            <div key={cat.category} id={catSectionId(cat.category)} style={{ marginBottom: compact ? 16 : 32, scrollMarginTop: 120 }}>
              <button onClick={() => toggleCollapse(cat.category)} style={{ display: 'flex', alignItems: 'center', gap: 8, padding: compact ? '4px 10px' : '8px 14px', borderRadius: 10, background: `linear-gradient(135deg, rgba(${c.rgb}, 0.15), rgba(${c.rgb}, 0.05))`, border: `1px solid rgba(${c.rgb}, 0.25)`, cursor: 'pointer', marginBottom: collapsed ? 0 : (compact ? 8 : 16), width: '100%', textAlign: 'left' }}>
                <div style={{ width: 8, height: 8, borderRadius: '50%', background: c.base }} />
                <span style={{ fontSize: compact ? 12 : 14, fontWeight: 600, color: darkMode ? c.light : c.base }}>{cat.category}</span>
                <span style={{ fontSize: 11, color: textMuted }}>{filtered.length} components</span>
                <span style={{ marginLeft: 'auto', fontSize: 10, color: textMuted, transition: 'transform 0.2s', transform: collapsed ? 'rotate(-90deg)' : 'rotate(0deg)' }}>{'\u25BC'}</span>
              </button>
              {!collapsed && (
                <div style={{ display: 'flex', flexWrap: 'wrap', gap: compact ? 8 : 20 }}>
                  {filtered.map((comp, ci) => {
                    const tb = TIER_BADGES[comp.tier];
                    const isScreen = comp.sizing === 'screen';
                    const cardW = compact ? Math.round(phone.w * 0.6) : phone.w;
                    const cardH = compact ? (isScreen ? Math.round(phone.h * 0.5) : Math.min(220, phone.h * 0.28)) : (isScreen ? phone.h : Math.min(400, phone.h * 0.47));
                    const inCompare = compareList.some(c => c.comp.name === comp.name);
                    return (
                      <div key={comp.name} id={compId(comp.name)} className="xr-card" style={{ animationDelay: `${ci * 40}ms`, cursor: 'pointer', display: 'flex', flexDirection: 'column', width: hiddenComps[comp.name] ? undefined : cardW, position: 'relative', transition: 'all 0.2s' }}>
                        {!hiddenComps[comp.name] && <>
                        {/* Compare checkbox */}
                        <div onClick={e => { e.stopPropagation(); toggleCompare(comp, cat.color); }} style={{ position: 'absolute', top: 6, right: 6, zIndex: 10, width: 20, height: 20, borderRadius: 6, display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: 11, cursor: 'pointer', background: inCompare ? 'rgba(139,92,246,0.8)' : 'rgba(0,0,0,0.4)', border: inCompare ? '1.5px solid #a78bfa' : '1.5px solid rgba(255,255,255,0.2)', color: '#fff', transition: 'all 0.15s', backdropFilter: 'blur(4px)' }}>
                          {inCompare ? '\u2713' : ''}
                        </div>
                        {/* Phone frame */}
                        <div onClick={() => setModal({ comp, catColor: cat.color })} style={{ width: cardW, height: cardH, overflow: 'hidden', transform: compact ? `scale(${cardW / phone.w})` : undefined, transformOrigin: 'top left' }}>
                          <XRayPhone darkMode={darkMode} isScreen={isScreen}>
                            <ErrorBoundary name={comp.name}>
                              {comp.render(darkMode)}
                            </ErrorBoundary>
                          </XRayPhone>
                        </div>
                        </>}
                        {/* Label */}
                        <div style={{ padding: compact ? '3px 2px' : '6px 4px', display: 'flex', alignItems: 'center', gap: 4, width: hiddenComps[comp.name] ? undefined : (compact ? cardW : undefined) }}>
                          <button onClick={e => { e.stopPropagation(); toggleHideComp(comp.name); }} title={hiddenComps[comp.name] ? 'Show preview' : 'Hide preview'} style={{ fontSize: 9, color: textMuted, cursor: 'pointer', background: 'none', border: 'none', padding: '0 2px', opacity: 0.5, transition: 'opacity 0.15s', flexShrink: 0, lineHeight: 1 }}
                            onMouseOver={e => e.currentTarget.style.opacity = 1} onMouseOut={e => e.currentTarget.style.opacity = 0.5}>
                            {hiddenComps[comp.name] ? '\u25B6' : '\u25BC'}
                          </button>
                          <div style={{ minWidth: 0, flex: 1 }} onClick={hiddenComps[comp.name] ? (e => { e.stopPropagation(); toggleHideComp(comp.name); }) : (() => setModal({ comp, catColor: cat.color }))}>
                            <div style={{ fontSize: compact ? 9 : 11, fontWeight: 600, color: textPrimary, whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis' }}>{comp.name}</div>
                            {!compact && comp.line > 0 && <div style={{ fontSize: 9, color: textMuted }}>L{comp.line}</div>}
                          </div>
                          <div style={{ display: 'flex', gap: 3, flexShrink: 0 }}>
                            <span style={{ fontSize: 8, fontWeight: 700, padding: '1px 4px', borderRadius: 4, background: `${tb.color}22`, color: tb.color, border: `1px solid ${tb.color}44` }}>{tb.label}</span>
                            <span style={{ fontSize: 8, padding: '1px 4px', borderRadius: 4, background: darkMode ? 'rgba(255,255,255,0.06)' : 'rgba(0,0,0,0.04)', color: textMuted }}>{comp.sizing === 'screen' ? 'scr' : comp.sizing === 'medium' ? 'med' : 'sm'}</span>
                          </div>
                        </div>
                      </div>
                    );
                  })}
                </div>
              )}
            </div>
          );
        })}

        {/* Special category */}
        {(!search || 'auravizplaceholder'.includes(searchLower)) && (
          <div id={catSectionId('Special')} style={{ marginBottom: compact ? 16 : 32, scrollMarginTop: 120 }}>
            <div style={{ display: 'flex', alignItems: 'center', gap: 8, padding: compact ? '4px 10px' : '8px 14px', borderRadius: 10, background: 'linear-gradient(135deg, rgba(139,92,246,0.15), rgba(139,92,246,0.05))', border: '1px solid rgba(139,92,246,0.25)', marginBottom: compact ? 8 : 16 }}>
              <div style={{ width: 8, height: 8, borderRadius: '50%', background: '#8b5cf6' }} />
              <span style={{ fontSize: compact ? 12 : 14, fontWeight: 600, color: darkMode ? '#a78bfa' : '#8b5cf6' }}>Special</span>
              <span style={{ fontSize: 11, color: textMuted }}>1 component</span>
            </div>
            <div style={{ display: 'flex', flexWrap: 'wrap', gap: compact ? 8 : 20 }}>
              {(() => { const cardW = compact ? Math.round(phone.w * 0.6) : phone.w; const cardH = compact ? Math.min(220, phone.h * 0.28) : Math.min(400, phone.h * 0.47); return (
              <div className="xr-card" onClick={() => setModal({ comp: { name: 'AuraVizPlaceholder', line: 0, sizing: 'small', tier: 4, render: (dm) => <AuraVizPlaceholder darkMode={dm} /> }, catColor: 'violet' })} style={{ cursor: 'pointer', display: 'flex', flexDirection: 'column', width: cardW }}>
                <div style={{ width: cardW, height: cardH, overflow: 'hidden' }}>
                  <XRayPhone darkMode={darkMode}>
                    <ErrorBoundary name="AuraVizPlaceholder"><AuraVizPlaceholder darkMode={darkMode} /></ErrorBoundary>
                  </XRayPhone>
                </div>
                <div style={{ padding: compact ? '3px 2px' : '6px 4px', display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>
                  <div><div style={{ fontSize: compact ? 9 : 11, fontWeight: 600, color: textPrimary }}>AuraVizPlaceholder</div></div>
                  <span style={{ fontSize: 8, fontWeight: 700, padding: '1px 4px', borderRadius: 4, background: '#8b5cf622', color: '#8b5cf6', border: '1px solid #8b5cf644' }}>T4</span>
                </div>
              </div>
              ); })()}
            </div>
          </div>
        )}
      </div>
      </PhoneContext.Provider>

      {/* Compare panel */}
      {compareList.length > 0 && (
        <div style={{ position: 'fixed', bottom: 0, left: 0, right: 0, zIndex: 150, background: darkMode ? 'rgba(3,7,18,0.95)' : 'rgba(249,250,251,0.95)', backdropFilter: 'blur(16px)', borderTop: `1px solid ${cardBorder}`, padding: '12px 20px' }}>
          <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: 8 }}>
            <span style={{ fontSize: 13, fontWeight: 600 }}>Compare ({compareList.length}/4)</span>
            <button onClick={() => setCompareList([])} style={{ fontSize: 11, color: textMuted, cursor: 'pointer', background: 'none', border: 'none', padding: '2px 6px' }}>Clear</button>
          </div>
          <PhoneContext.Provider value={phone}>
          <div style={{ display: 'flex', gap: 16, overflowX: 'auto', paddingBottom: 8 }}>
            {compareList.map(({ comp, catColor }) => (
              <div key={comp.name} style={{ flexShrink: 0, display: 'flex', flexDirection: 'column', alignItems: 'center' }}>
                <div style={{ width: phone.w, height: comp.sizing === 'screen' ? phone.h : Math.min(400, phone.h * 0.47), overflow: 'hidden' }}>
                  <XRayPhone darkMode={darkMode} isScreen={comp.sizing === 'screen'}>
                    <ErrorBoundary name={comp.name}>{comp.render(darkMode)}</ErrorBoundary>
                  </XRayPhone>
                </div>
                <div style={{ fontSize: 11, fontWeight: 600, marginTop: 4 }}>{comp.name}</div>
                {comp.line > 0 && <div style={{ fontSize: 9, color: textMuted }}>L{comp.line}</div>}
              </div>
            ))}
          </div>
          </PhoneContext.Provider>
        </div>
      )}

      {/* Modal */}
      {modal && (() => {
        const { comp, catColor } = modal;
        const c = COLOR_HEX[catColor] || COLOR_HEX.violet;
        return (
          <div onClick={() => setModal(null)} style={{ position: 'fixed', inset: 0, zIndex: 200, background: 'rgba(0,0,0,0.8)', display: 'flex', alignItems: 'center', justifyContent: 'center', padding: 24 }}>
            <div onClick={e => e.stopPropagation()} style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', gap: 12 }}>
              {/* Label above phone */}
              <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>
                <span style={{ fontSize: 18, fontWeight: 700, color: '#fff' }}>{comp.name}</span>
                {comp.line > 0 && <span style={{ fontSize: 12, color: '#9ca3af' }}>Line {comp.line}</span>}
                <button onClick={() => setModal(null)} style={{ fontSize: 18, color: '#9ca3af', cursor: 'pointer', background: 'rgba(255,255,255,0.1)', border: 'none', borderRadius: '50%', width: 32, height: 32, display: 'flex', alignItems: 'center', justifyContent: 'center', marginLeft: 12 }}>{'\u2715'}</button>
              </div>
              {/* Full-size phone frame */}
              <div>
                <XRayPhone darkMode={darkMode} isScreen={comp.sizing === 'screen'}>
                  <ErrorBoundary name={comp.name}>
                    {comp.render(darkMode)}
                  </ErrorBoundary>
                </XRayPhone>
              </div>
            </div>
          </div>
        );
      })()}
    </div>
  );
};

const App = XRayApp;
ReactDOM.createRoot(document.getElementById('root')).render(<XRayApp />);
  </script>
</body>
</html>
