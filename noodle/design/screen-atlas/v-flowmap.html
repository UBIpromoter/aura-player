<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Aura â€” Screen Atlas</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { --sat: 0px; --sar: 0px; --sab: 0px; --sal: 0px; }
    html, body, #root { margin: 0; padding: 0; height: 100%; width: 100%; }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    .question-text { font-size: clamp(18px, 5vw, 24px); line-height: 1.35; text-wrap: balance; }
    @keyframes fadeSlideIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    @keyframes shimmer-pulse { 0%, 100% { opacity: 0.4; } 50% { opacity: 0.8; } }
    @keyframes celebrateGlow { 0% { transform: scale(0.8); opacity: 0; } 50% { transform: scale(1.2); opacity: 1; } 100% { transform: scale(1); opacity: 1; } }
    .celebrate-glow { animation: celebrateGlow 0.6s ease-out forwards; }
    .btn-feedback { transition: transform 0.1s ease, filter 0.1s ease !important; }
    .btn-feedback:hover { filter: brightness(1.15) !important; }
    .btn-feedback:active { transform: scale(0.96) !important; filter: brightness(0.92) !important; }
    .shine-card { position: relative; }
    .shine-card::before {
      content: ''; position: absolute; inset: -1px; border-radius: inherit;
      background: linear-gradient(180deg, var(--accent-bright, rgba(255,255,255,0.5)) 0%, var(--accent-color, rgba(255,255,255,0.2)) 5%, transparent 15%, transparent 100%);
      -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      -webkit-mask-composite: xor; mask-composite: exclude;
      padding: 2px; pointer-events: none; z-index: 20; opacity: 0; transition: opacity 0.3s ease;
    }
    .shine-card:hover::before { opacity: 1; animation: shimmer-pulse 3s ease-in-out infinite; }
    .shine-blue { --accent-color: rgba(59, 130, 246, 0.3); --accent-bright: rgba(147, 197, 253, 0.6); }
    .shine-amber { --accent-color: rgba(251, 191, 36, 0.2); --accent-bright: rgba(253, 224, 71, 0.45); }
    .shine-violet { --accent-color: rgba(139, 92, 246, 0.25); --accent-bright: rgba(196, 181, 253, 0.55); }
    .shine-teal { --accent-color: rgba(45, 212, 191, 0.2); --accent-bright: rgba(153, 246, 228, 0.5); }
    .shine-emerald { --accent-color: rgba(16, 185, 129, 0.25); --accent-bright: rgba(110, 231, 183, 0.55); }
    .shine-rose { --accent-color: rgba(244, 63, 94, 0.25); --accent-bright: rgba(251, 113, 133, 0.55); }
    .shine-gray { --accent-color: rgba(156, 163, 175, 0.2); --accent-bright: rgba(209, 213, 219, 0.45); }
    .glow-amber { box-shadow: 0 0 15px rgba(251, 191, 36, 0.12), 0 0 35px rgba(251, 191, 36, 0.08); }
    .glow-violet { box-shadow: 0 0 18px rgba(139, 92, 246, 0.2), 0 0 40px rgba(139, 92, 246, 0.12); }
    .glow-teal { box-shadow: 0 0 18px rgba(45, 212, 191, 0.16), 0 0 40px rgba(45, 212, 191, 0.1); }
    .glow-blue { box-shadow: 0 0 20px rgba(59, 130, 246, 0.2), 0 0 45px rgba(59, 130, 246, 0.12); }
    .glow-emerald { box-shadow: 0 0 18px rgba(16, 185, 129, 0.16), 0 0 40px rgba(16, 185, 129, 0.1); }
    .glow-rose { box-shadow: 0 0 18px rgba(244, 63, 94, 0.16), 0 0 40px rgba(244, 63, 94, 0.1); }
    .starry-bg { background: linear-gradient(135deg, rgba(30, 20, 10, 0.9) 0%, rgba(50, 30, 15, 0.8) 100%); position: relative; }
    .starry-bg::before {
      content: ''; position: absolute; inset: 0;
      background-image: radial-gradient(1px 1px at 20px 30px, white, transparent),
        radial-gradient(1px 1px at 40px 70px, rgba(255,255,255,0.8), transparent),
        radial-gradient(1px 1px at 90px 40px, rgba(255,255,255,0.7), transparent),
        radial-gradient(1px 1px at 130px 55px, white, transparent),
        radial-gradient(1.5px 1.5px at 200px 50px, rgba(255,255,255,0.9), transparent);
      opacity: 0.7; border-radius: inherit;
    }
    .hide-scrollbar::-webkit-scrollbar { display: none; }
    .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    @keyframes slideInRight { from { transform: translateX(100%); } to { transform: translateX(0); } }
  </style>
</head>
<body class="bg-gray-950">
  <div id="root"></div>
  <script>
const _warn = console.warn;
console.warn = (...args) => { if (typeof args[0] === 'string' && args[0].includes('cdn.tailwindcss.com')) return; _warn.apply(console, args); };
  </script>
  <script type="text/babel">
const { useState, useCallback, useEffect, useRef, useMemo } = React;

// ==================== SHARED TOKENS ====================
const COLOR_HEX = {
  violet:  { base: '#8b5cf6', light: '#a78bfa', rgb: '139, 92, 246' },
  blue:    { base: '#3b82f6', light: '#60a5fa', rgb: '59, 130, 246' },
  teal:    { base: '#14b8a6', light: '#2dd4bf', rgb: '20, 184, 166' },
  rose:    { base: '#f43f5e', light: '#fb7185', rgb: '244, 63, 94' },
  pink:    { base: '#d946ef', light: '#e879f9', rgb: '217, 70, 239' },
  emerald: { base: '#10b981', light: '#34d399', rgb: '16, 185, 129' },
  slate:   { base: '#64748b', light: '#94a3b8', rgb: '100, 116, 139' },
  amber:   { base: '#f59e0b', light: '#fbbf24', rgb: '245, 158, 11' },
  indigo:  { base: '#6366f1', light: '#818cf8', rgb: '99, 102, 241' },
  cyan:    { base: '#06b6d4', light: '#67e8f9', rgb: '6, 182, 212' },
  gray:    { base: '#6b7280', light: '#9ca3af', rgb: '107, 114, 128' },
};

const PROGRESS_GRADIENTS = Object.fromEntries(
  Object.entries(COLOR_HEX).map(([c, hex]) => [c, { from: hex.base, to: hex.light }])
);

const TH = (token, dark) => ({
  'text-primary': dark ? 'text-white' : 'text-gray-900',
  'text-secondary': dark ? 'text-gray-300' : 'text-gray-700',
  'text-muted': dark ? 'text-gray-400' : 'text-gray-600',
  'text-subtle': dark ? 'text-gray-500' : 'text-gray-400',
  'text-faint': dark ? 'text-gray-600' : 'text-gray-400',
  'bg-main': dark ? 'bg-gray-950' : 'bg-gray-50',
  'bg-card': dark ? 'bg-gray-900 border border-gray-800' : 'bg-white border border-gray-200',
  'bg-overlay': dark ? 'bg-gray-900/50' : 'bg-gray-100',
  'border-base': dark ? 'border-gray-800' : 'border-gray-200',
  'text-violet': dark ? 'text-violet-400' : 'text-violet-600',
  'text-emerald': dark ? 'text-emerald-400' : 'text-emerald-600',
  'text-rose': dark ? 'text-rose-400' : 'text-rose-600',
  'text-sky': dark ? 'text-sky-300' : 'text-sky-500',
  'text-dim': dark ? 'text-gray-400' : 'text-gray-500',
  'text-bright': dark ? 'text-gray-100' : 'text-gray-900',
  'bg-surface': dark ? 'bg-gray-900' : 'bg-white',
}[token] || '');

// ==================== DYNAMIC ISLAND PHONE FRAME ====================
// Smart Dynamic Island: the status bar area matches the screen bg, the pill itself is dark
const DynamicIslandFrame = ({ children, darkMode, screenBg, width = 393, height = 852 }) => {
  const br = Math.round(width * 0.112); // 44/393
  const islandW = Math.round(width * 0.32);
  const islandH = Math.round(height * 0.0434);
  const islandTop = Math.round(height * 0.014);
  const statusH = Math.round(height * 0.063);
  const homeBarW = Math.round(width * 0.341);
  const homeBarH = Math.max(3, Math.round(height * 0.006));
  const homeBarBottom = Math.round(height * 0.0094);
  const bgColor = screenBg || (darkMode ? '#030712' : '#f9fafb');

  return (
    <div style={{
      width, height, borderRadius: br, overflow: 'hidden', position: 'relative', flexShrink: 0,
      backgroundColor: bgColor,
    }}>
      {/* Status bar area - matches screen bg for seamless look */}
      <div style={{
        position: 'absolute', top: 0, left: 0, right: 0, height: statusH,
        zIndex: 25, display: 'flex', alignItems: 'flex-end', justifyContent: 'space-between',
        padding: `0 ${Math.round(width * 0.081)}px ${Math.round(height * 0.0094)}px`,
        fontSize: Math.round(width * 0.0356), fontWeight: 600,
        color: darkMode ? '#fff' : '#1f2937',
      }}>
        <span>9:41</span>
        <div style={{ display: 'flex', gap: Math.round(width * 0.015), alignItems: 'center' }}>
          <svg width={Math.round(width*0.043)} height={Math.round(width*0.03)} viewBox="0 0 17 12" fill="none">
            <rect x="0" y="8" width="3" height="4" rx="0.5" fill={darkMode ? '#fff' : '#1f2937'}/>
            <rect x="4.5" y="5" width="3" height="7" rx="0.5" fill={darkMode ? '#fff' : '#1f2937'}/>
            <rect x="9" y="2" width="3" height="10" rx="0.5" fill={darkMode ? '#fff' : '#1f2937'}/>
            <rect x="13.5" y="0" width="3" height="12" rx="0.5" fill={darkMode ? 'rgba(255,255,255,0.3)' : 'rgba(0,0,0,0.2)'}/>
          </svg>
          <svg width={Math.round(width*0.038)} height={Math.round(width*0.03)} viewBox="0 0 15 12" fill="none">
            <path d="M7.5 3C10 3 12 4.5 13.5 6.5L7.5 12L1.5 6.5C3 4.5 5 3 7.5 3Z" fill={darkMode ? '#fff' : '#1f2937'}/>
          </svg>
          <svg width={Math.round(width*0.06)} height={Math.round(width*0.03)} viewBox="0 0 25 12" fill="none">
            <rect x="0" y="1" width="22" height="10" rx="2" stroke={darkMode ? '#fff' : '#1f2937'} strokeWidth="1" fill="none"/>
            <rect x="1.5" y="2.5" width="15" height="7" rx="1" fill={darkMode ? '#fff' : '#1f2937'}/>
            <rect x="23" y="4" width="2" height="4" rx="1" fill={darkMode ? 'rgba(255,255,255,0.4)' : 'rgba(0,0,0,0.25)'}/>
          </svg>
        </div>
      </div>
      {/* Dynamic Island pill */}
      <div style={{
        position: 'absolute', top: islandTop, left: '50%', transform: 'translateX(-50%)',
        width: islandW, height: islandH, background: '#000', borderRadius: 9999, zIndex: 30,
      }} />
      {/* Content area */}
      <div style={{ position: 'absolute', top: statusH, left: 0, right: 0, bottom: 0, display: 'flex', flexDirection: 'column', overflow: 'hidden' }}>
        {children}
      </div>
      {/* Home indicator */}
      <div style={{
        position: 'absolute', bottom: homeBarBottom, left: '50%', transform: 'translateX(-50%)',
        width: homeBarW, height: homeBarH, borderRadius: 9999, zIndex: 20, opacity: 0.5,
        backgroundColor: darkMode ? '#fff' : '#1f2937',
      }} />
    </div>
  );
};

// ==================== SCREEN: Welcome ====================
const ScreenWelcome = ({ darkMode }) => (
  <div className="flex-1 flex flex-col items-center justify-center p-6" style={{ backgroundColor: darkMode ? '#030712' : '#f9fafb' }}>
    <div className="text-5xl mb-5">&#x1f300;</div>
    <h1 className="text-2xl font-bold mb-2" style={{ color: darkMode ? '#fff' : '#111' }}>Aura</h1>
    <p className="text-sm mb-10 text-center leading-snug" style={{ color: darkMode ? '#9ca3af' : '#6b7280', maxWidth: 220 }}>
      Discover yourself, one question at a time
    </p>
    <div className="w-full space-y-3" style={{ maxWidth: 260 }}>
      <div className={`w-full py-3.5 px-5 rounded-xl font-semibold text-base text-center ${darkMode ? 'bg-violet-600 text-white' : 'bg-violet-500 text-white'}`}>
        Let's Go
      </div>
    </div>
    <div className="mt-6 text-sm" style={{ color: darkMode ? '#6b7280' : '#9ca3af' }}>Sign In</div>
  </div>
);

// ==================== SCREEN: Sign In ====================
const ScreenSignIn = ({ darkMode }) => (
  <div className="flex-1 flex flex-col items-center justify-center p-6" style={{ backgroundColor: darkMode ? '#030712' : '#f9fafb' }}>
    <div className="text-4xl mb-3">&#x1f511;</div>
    <h1 className="text-xl font-bold mb-5" style={{ color: darkMode ? '#fff' : '#111' }}>Sign In</h1>
    <div className="w-full space-y-2.5" style={{ maxWidth: 260 }}>
      <div className={`w-full px-3.5 py-2.5 rounded-xl text-sm ${darkMode ? 'bg-gray-800 text-gray-500' : 'bg-gray-100 text-gray-400'}`}>
        Email
      </div>
      <div className={`w-full px-3.5 py-2.5 rounded-xl text-sm ${darkMode ? 'bg-gray-800 text-gray-500' : 'bg-gray-100 text-gray-400'}`}>
        PIN (4+ digits)
      </div>
      <div className={`w-full py-2.5 px-5 rounded-xl font-medium text-sm text-center ${darkMode ? 'bg-violet-600 text-white' : 'bg-violet-500 text-white'}`}>
        Sign In
      </div>
      <div className="text-center pt-1">
        <span className={`text-xs ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>&larr; Back</span>
      </div>
      <div className={`text-xs text-center pt-1 ${darkMode ? 'text-gray-600' : 'text-gray-400'}`}>
        No account? <span className={darkMode ? 'text-violet-400' : 'text-violet-500'}>Create one</span>
      </div>
    </div>
  </div>
);

// ==================== SCREEN: Onboarding ====================
const ScreenOnboarding = ({ darkMode }) => {
  const violetShade = darkMode ? ['#5b21b6', '#7c3aed'] : ['#ddd6fe', '#c4b5fd'];
  return (
    <div className={`flex-1 flex flex-col ${darkMode ? 'bg-gray-950' : 'bg-gray-50'}`}>
      <div className="flex items-center justify-between px-4 pt-3 pb-1">
        <span className="text-xl">&#x1f300;</span>
        <span className={`text-lg ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>&#x2630;</span>
      </div>
      <div className="flex-1 flex flex-col items-center justify-center px-5">
        <div className={`text-xs font-medium mb-5 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>3 of 10</div>
        <h2 className={`text-lg text-center font-medium mb-6 leading-snug ${TH('text-primary', darkMode)}`}>
          Is a hot dog a sandwich?
        </h2>
        <div className="w-full space-y-2.5" style={{ maxWidth: 260 }}>
          <div className="rounded-xl py-3 text-center font-bold text-white text-base"
               style={{ background: `linear-gradient(135deg, ${violetShade[0]} 0%, ${violetShade[1]} 100%)` }}>
            Yes, obviously
          </div>
          <div className={`rounded-xl py-3 text-center font-bold text-base ${darkMode ? 'bg-gray-800 text-gray-300' : 'bg-white text-gray-600 border-2 border-gray-200'}`}>
            No way
          </div>
        </div>
        <div className="flex gap-1.5 mt-6">
          {[...Array(10)].map((_, i) => (
            <div key={i} className={`w-1.5 h-1.5 rounded-full ${i < 3 ? 'bg-violet-500' : i === 3 ? 'bg-violet-400' : darkMode ? 'bg-gray-700' : 'bg-gray-300'}`} />
          ))}
        </div>
      </div>
    </div>
  );
};

// ==================== SCREEN: Path Choice ====================
const ScreenPathChoice = ({ darkMode }) => (
  <div className={`flex-1 flex flex-col ${darkMode ? 'bg-gray-950' : 'bg-gray-50'}`}>
    <div className="flex items-center justify-between px-4 pt-3 pb-1">
      <span className="text-xl">&#x1f300;</span>
      <span className={`text-lg ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>&#x2630;</span>
    </div>
    <div className="flex-1 flex flex-col items-center justify-center px-5">
      <div className="text-center mb-6">
        <div className="text-4xl mb-3">&#x1f389;</div>
        <h1 className={`text-xl font-bold mb-1.5 ${darkMode ? 'text-white' : 'text-gray-900'}`}>Nice! 10 down</h1>
        <p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>You're on a roll. What next?</p>
      </div>
      <div className="w-full space-y-3" style={{ maxWidth: 280 }}>
        <div className={`w-full p-4 rounded-2xl text-left border ${
          darkMode ? 'border-violet-500/40 bg-gradient-to-r from-violet-900/40 to-violet-950/60' : 'border-violet-300 bg-gradient-to-r from-violet-100 to-violet-50'
        }`}>
          <div className="flex items-center gap-3">
            <span className="text-2xl">&#x1fa9e;</span>
            <div className="flex-1 min-w-0">
              <div className={`text-sm font-semibold truncate ${darkMode ? 'text-white' : 'text-gray-900'}`}>Learn About Yourself</div>
              <div className={`text-xs truncate ${darkMode ? 'text-violet-400/80' : 'text-violet-600'}`}>Quick personality quiz</div>
            </div>
            <span className={`text-sm ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>&rarr;</span>
          </div>
        </div>
        <div className={`w-full p-4 rounded-2xl text-left border ${
          darkMode ? 'border-teal-500/40 bg-gradient-to-r from-teal-900/40 to-teal-950/60' : 'border-teal-300 bg-gradient-to-r from-teal-100 to-teal-50'
        }`}>
          <div className="flex items-center gap-3">
            <span className="text-2xl">&#x1f9ed;</span>
            <div className="flex-1 min-w-0">
              <div className={`text-sm font-semibold truncate ${darkMode ? 'text-white' : 'text-gray-900'}`}>Explore Topics</div>
              <div className={`text-xs truncate ${darkMode ? 'text-teal-400/80' : 'text-teal-600'}`}>Things you care about</div>
            </div>
            <span className={`text-sm ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>&rarr;</span>
          </div>
        </div>
      </div>
    </div>
  </div>
);

// ==================== SCREEN: Categories (Main Hub) ====================
const ScreenCategories = ({ darkMode }) => (
  <div className={`flex-1 flex flex-col relative ${TH('bg-main', darkMode)}`}>
    <div className="flex items-center justify-between px-4 pt-3 pb-1">
      <div className="flex items-center gap-2">
        <span className="text-2xl">&#x1f300;</span>
        <div className="flex items-center gap-1">
          <span className={`text-xs font-bold ${darkMode ? 'text-violet-400' : 'text-violet-600'}`}>Lv.3</span>
          <span className={`text-xs ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>145 XP</span>
        </div>
      </div>
      <div className="flex items-center gap-2.5">
        <span className="text-xs text-orange-400 font-medium">&#x1f525;5</span>
        <div className="w-6 h-6 rounded-full flex items-center justify-center text-xs"
          style={{ background: 'linear-gradient(135deg, rgba(255,255,255,0.15), rgba(255,255,255,0.05))',
                   border: '1.5px solid rgba(255,255,255,0.3)' }}>
          <span style={{ color: 'rgba(255,255,255,0.9)', fontSize: 10 }}>&#x1f464;</span>
        </div>
        <span className={`${darkMode ? 'text-gray-500' : 'text-gray-400'}`} style={{ fontSize: 16 }}>&#x2699;</span>
      </div>
    </div>
    <div className="flex-1 overflow-y-auto px-4 pt-1 pb-6 space-y-3 hide-scrollbar">
      <div className={`w-full rounded-xl p-3 text-center ${
        darkMode ? 'bg-gradient-to-br from-blue-900/60 to-blue-950/80 border border-blue-500/40' : 'bg-gradient-to-br from-blue-50 to-blue-100/80 border border-blue-200'
      }`}>
        <div className={`font-medium text-xs mb-1 ${darkMode ? 'text-blue-400' : 'text-blue-600'}`}>&#x1f300; Question of the Day</div>
        <p className={`text-sm font-semibold leading-snug ${TH('text-primary', darkMode)}`}>
          Should AI identify themselves?
        </p>
      </div>
      <h1 className={`text-xl font-bold text-center ${TH('text-primary', darkMode)}`}>What's on your mind?</h1>
      <div className="space-y-2.5">
        {[
          { icon: '\u2600\uFE0F', name: 'Predict', sub: 'What will happen?', shine: 'shine-amber glow-amber', dark: 'starry-bg border-amber-500/40', light: 'bg-gradient-to-r from-amber-50 to-yellow-50 border-amber-300', subDark: 'text-amber-400/80', subLight: 'text-amber-600' },
          { icon: '\uD83E\uDDE0', name: 'Think', sub: 'Logic & analysis', shine: 'shine-violet glow-violet', dark: 'border-violet-500/40 bg-gradient-to-r from-violet-900/30 to-violet-950/50', light: 'border-violet-300 bg-gradient-to-r from-violet-50 to-violet-100/60', subDark: 'text-violet-400/80', subLight: 'text-violet-600' },
          { icon: '\u2696\uFE0F', name: 'Judge', sub: 'Ethics & opinions', shine: 'shine-emerald glow-emerald', dark: 'border-emerald-500/40 bg-gradient-to-r from-emerald-900/30 to-emerald-950/50', light: 'border-emerald-300 bg-gradient-to-r from-emerald-50 to-emerald-100/60', subDark: 'text-emerald-400/80', subLight: 'text-emerald-600' },
          { icon: '\u2728', name: 'Surprise me', sub: 'Something unexpected', shine: 'shine-rose glow-rose', dark: 'border-rose-500/40 bg-gradient-to-r from-rose-900/30 to-rose-950/50', light: 'border-rose-300 bg-gradient-to-r from-rose-50 to-rose-100/60', subDark: 'text-rose-400/80', subLight: 'text-rose-500' },
          { icon: '\uD83E\uDE9E', name: 'Reveal', sub: 'Discover yourself', shine: 'shine-blue glow-blue', dark: 'border-sky-500/40 bg-gradient-to-r from-sky-900/30 to-cyan-950/50', light: 'border-sky-300 bg-gradient-to-r from-sky-50 to-cyan-50', subDark: 'text-sky-400/80', subLight: 'text-sky-600' },
        ].map((cat, i) => (
          <div key={i} className={`w-full py-3 px-4 rounded-xl text-left border ${cat.shine} ${darkMode ? cat.dark : cat.light}`}>
            <div className="flex items-center gap-3">
              <span className="text-xl">{cat.icon}</span>
              <div className="min-w-0 flex-1">
                <div className={`text-sm font-semibold truncate ${TH('text-primary', darkMode)}`}>{cat.name}</div>
                <div className={`text-xs truncate ${darkMode ? cat.subDark : cat.subLight}`}>{cat.sub}</div>
              </div>
            </div>
          </div>
        ))}
      </div>
    </div>
  </div>
);

// ==================== SCREEN: Binary Question ====================
const ScreenBinaryQuestion = ({ darkMode }) => (
  <div className={`flex-1 flex flex-col ${TH('bg-main', darkMode)}`}>
    <div className={`flex items-center justify-between px-3 py-1.5 ${darkMode ? 'bg-gray-950/70 border-b border-white/5' : 'bg-white/70 border-b border-gray-200/50'}`}>
      <span className="text-lg">&#x1f300;</span>
      <span className={`text-xs ${TH('text-muted', darkMode)}`}>42 answered</span>
      <span className={`text-lg ${TH('text-muted', darkMode)}`}>&#x2630;</span>
    </div>
    <div className="flex-1 flex flex-col justify-center px-3 space-y-3">
      <div className="space-y-1.5 glow-amber p-3 rounded-xl">
        <div className="flex justify-center">
          <span className={`px-2 py-0.5 rounded-full text-xs font-medium ${darkMode ? 'bg-amber-900/30 text-amber-400' : 'bg-amber-100 text-amber-700'}`}>
            &#x2600;&#xFE0F; Predictions
          </span>
        </div>
        <h2 className={`text-base text-center font-medium leading-snug ${TH('text-primary', darkMode)}`}>
          Will humans live on Mars by 2050?
        </h2>
      </div>
      <div className="flex items-center gap-1.5 px-2">
        <div className="flex-1 relative h-12 rounded-xl font-bold overflow-hidden flex items-center justify-center"
             style={{ background: 'linear-gradient(135deg, #047857 0%, #10b981 100%)', boxShadow: '0 0 16px rgba(16,185,129,0.35)', color: 'white' }}>
          <span className="text-lg font-bold">YES</span>
          <span className="text-xs font-medium opacity-70 ml-1">&#x2605;&#x2605;</span>
        </div>
        <div className="w-9 h-12 flex-shrink-0 flex flex-col items-center justify-center gap-0.5">
          <div className={`w-5 h-5 rounded-full flex items-center justify-center text-xs ${darkMode ? 'bg-gray-700 text-gray-400' : 'bg-gray-200 text-gray-500'}`}>&#x2715;</div>
          <div className="w-8 h-8 rounded-full text-white shadow-lg flex items-center justify-center text-sm bg-emerald-500">&#x2713;</div>
        </div>
        <div className={`flex-1 relative h-12 rounded-xl font-bold overflow-hidden flex items-center justify-center ${darkMode ? 'bg-gray-800 text-gray-300' : 'bg-white text-rose-600 border-2 border-rose-200'}`}>
          <span className="text-lg font-bold">NO</span>
        </div>
      </div>
    </div>
  </div>
);

// ==================== SCREEN: MC Question ====================
const ScreenMCQuestion = ({ darkMode }) => {
  const MC_COLORS = [
    { hex: '#3b82f6', shades: ['#93c5fd', '#60a5fa', '#3b82f6', '#2563eb'], rgb: '59, 130, 246' },
    { hex: '#8b5cf6', shades: ['#c4b5fd', '#a78bfa', '#8b5cf6', '#7c3aed'], rgb: '139, 92, 246' },
    { hex: '#14b8a6', shades: ['#5eead4', '#2dd4bf', '#14b8a6', '#0d9488'], rgb: '20, 184, 166' },
    { hex: '#06b6d4', shades: ['#67e8f9', '#22d3ee', '#06b6d4', '#0891b2'], rgb: '6, 182, 212' },
  ];
  const options = ['Utilitarianism vs duty', 'Action vs inaction', 'Individual vs collective', 'Moral intuition vs logic'];
  const selectedIdx = 1;
  const tapCount = 2;

  return (
    <div className={`flex-1 flex flex-col ${TH('bg-main', darkMode)}`}>
      <div className={`flex items-center justify-between px-3 py-1.5 ${darkMode ? 'bg-gray-950/70 border-b border-white/5' : 'bg-white/70 border-b border-gray-200/50'} backdrop-blur-md`}>
        <span className="text-lg">&#x1f300;</span>
        <span className={`text-xs ${TH('text-muted', darkMode)}`}>42 answered</span>
        <span className={`text-lg ${TH('text-muted', darkMode)}`}>&#x2630;</span>
      </div>
      <div className="flex-1 flex flex-col justify-center px-3 space-y-3">
        <div className="space-y-1.5 glow-violet p-3 rounded-xl">
          <div className="flex justify-center">
            <span className={`px-2 py-0.5 rounded-full text-xs font-medium ${darkMode ? 'bg-violet-900/30 text-violet-400' : 'bg-violet-100 text-violet-700'}`}>
              &#x1f9e0; Reasoning
            </span>
          </div>
          <h2 className={`text-sm text-center font-medium leading-snug ${TH('text-primary', darkMode)}`}>
            The trolley problem is fundamentally about...
          </h2>
        </div>
        <div className="px-2 space-y-1">
          {options.map((opt, i) => {
            const color = MC_COLORS[i % MC_COLORS.length];
            const isSelected = i === selectedIdx;
            const style = isSelected
              ? { background: `linear-gradient(135deg, ${color.shades[tapCount - 1]} 0%, ${color.shades[Math.min(tapCount, 3)]} 100%)`, boxShadow: `0 0 ${tapCount * 6}px rgba(${color.rgb}, ${0.2 + tapCount * 0.12})`, color: 'white', border: `2px solid ${color.hex}` }
              : { background: darkMode ? 'rgb(31,41,55)' : 'rgb(255,255,255)', color: darkMode ? 'rgb(209,213,219)' : 'rgb(55,65,81)', border: darkMode ? '2px solid transparent' : '2px solid rgb(229,231,235)' };
            return (
              <div key={i} className="flex items-center gap-1">
                <div className={`flex-1 h-9 px-2.5 rounded-lg text-left text-xs overflow-hidden relative flex items-center`} style={style}>
                  <span className="font-medium mr-1 opacity-60">{String.fromCharCode(65 + i)}.</span>
                  <span className="truncate">{opt}</span>
                  {isSelected && (
                    <span className="absolute top-1/2 right-1.5 -translate-y-1/2 text-xs font-bold bg-white/30 w-4 h-4 rounded-full flex items-center justify-center">
                      {tapCount}
                    </span>
                  )}
                </div>
                <div className="w-8 h-9 flex-shrink-0 flex flex-col items-center justify-center">
                  {isSelected && (
                    <>
                      <div className={`w-3.5 h-3.5 rounded-full flex items-center justify-center text-[8px] ${darkMode ? 'bg-gray-700 text-gray-400' : 'bg-gray-200 text-gray-500'}`}>&#x2715;</div>
                      <div className="w-6 h-6 rounded-full text-white shadow-lg flex items-center justify-center text-xs"
                           style={{ backgroundColor: color.hex }}>&#x2713;</div>
                    </>
                  )}
                </div>
              </div>
            );
          })}
        </div>
      </div>
    </div>
  );
};

// ==================== SCREEN: Results ====================
const ScreenResults = ({ darkMode }) => {
  const yesColors = ['#10b981', '#34d399', '#6ee7b7', '#a7f3d0'];
  const noColors = ['#f43f5e', '#fb7185', '#fda4af', '#fecaca'];
  const yesByConf = [38, 28, 18, 8];
  const noByConf = [15, 12, 8, 5];
  const maxCount = 38;

  const buildSegments = (byConf, colors) => {
    const segs = [];
    for (let i = 0; i < 4; i++) {
      if (byConf[i] > 0) segs.push({ width: (byConf[i] / maxCount) * 100, color: colors[i], conf: 3 - i });
    }
    return segs;
  };

  const rows = [
    { label: 'Yes', pct: '69%', byConf: yesByConf, colors: yesColors, isUser: true, userConf: 2 },
    { label: 'No', pct: '31%', byConf: noByConf, colors: noColors, isUser: false, userConf: null },
  ];

  return (
    <div className={`flex-1 flex flex-col ${TH('bg-main', darkMode)}`}>
      <div className={`flex items-center justify-between px-3 py-1.5 ${darkMode ? 'bg-gray-950/70 border-b border-white/5' : 'bg-white/70 border-b border-gray-200/50'}`}>
        <span className="text-lg">&#x1f300;</span>
        <span className={`text-xs ${TH('text-muted', darkMode)}`}>43 answered</span>
        <span className={`text-lg ${TH('text-muted', darkMode)}`}>&#x2630;</span>
      </div>
      <div className="flex-1 overflow-y-auto px-3 py-4 space-y-3">
        <div className={`w-full px-3 py-2 rounded-lg text-left ${darkMode ? 'bg-gray-900/80' : 'bg-gray-100'}`}>
          <div className={`text-xs font-medium mb-1 truncate ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
            Will humans live on Mars by 2050?
          </div>
          <div className="space-y-1">
            {rows.map((row, ri) => {
              const segments = buildSegments(row.byConf, row.colors);
              const totalWidth = segments.reduce((a, s) => a + s.width, 0);
              const emptyWidth = 100 - totalWidth;
              return (
                <div key={ri} className="flex items-center gap-1.5">
                  <span className="text-xs w-6" style={{ color: row.colors[0] }}>{row.label}</span>
                  <span className="text-xs w-6" style={{ color: row.colors[0] }}>{row.pct}</span>
                  <div className={`flex-1 h-2 rounded-full overflow-hidden ${darkMode ? 'bg-black' : 'bg-gray-300'}`}>
                    <div className="h-full flex">
                      {segments.map((s, i) => (
                        <div key={i} className={`h-full ${i === 0 ? 'rounded-l-full' : ''} ${i === segments.length - 1 && emptyWidth <= 0 ? 'rounded-r-full' : ''}`}
                          style={{ width: `${s.width}%`, backgroundColor: s.color }} />
                      ))}
                      {emptyWidth > 0 && <div className="h-full rounded-r-full" style={{ width: `${emptyWidth}%`, border: `1px solid ${row.colors[3]}`, borderLeft: 'none' }} />}
                    </div>
                  </div>
                </div>
              );
            })}
          </div>
          <div className={`text-xs text-right mt-1 ${TH('text-faint', darkMode)}`}>1,847 responses &rarr;</div>
        </div>
        <div className={`text-center text-xs ${TH('text-faint', darkMode)}`}>Swipe for next &rarr;</div>
      </div>
    </div>
  );
};

// ==================== SCREEN: Settings ====================
const ScreenSettings = ({ darkMode }) => (
  <div className={`flex-1 flex flex-col overflow-hidden ${TH('bg-main', darkMode)}`}>
    <div className={`flex items-center justify-between px-3 py-2 border-b ${TH('border-base', darkMode)}`}>
      <span className={`text-xs ${TH('text-violet', darkMode)}`}>&larr; Back</span>
      <h1 className={`text-sm font-semibold ${TH('text-primary', darkMode)}`}>Settings</h1>
      <div className="w-10" />
    </div>
    <div className="flex-1 overflow-y-auto p-3 space-y-2 hide-scrollbar">
      <div className={`rounded-lg p-2.5 ${darkMode ? 'bg-gray-900' : 'bg-white border border-gray-200'}`}>
        <div className="flex items-center justify-between">
          <div className={`text-xs font-medium ${TH('text-primary', darkMode)}`}>Theme</div>
          <div className={`relative w-10 h-5 rounded-full ${darkMode ? 'bg-violet-600' : 'bg-gray-200'}`}>
            <div className={`absolute top-0.5 w-4 h-4 bg-white rounded-full shadow flex items-center justify-center text-xs ${darkMode ? 'translate-x-5' : 'translate-x-0.5'}`}>
              {darkMode ? '\uD83C\uDF19' : '\u2600\uFE0F'}
            </div>
          </div>
        </div>
      </div>
      {[
        { label: 'Require Submit', on: true },
        { label: 'Show Tips', on: true },
        { label: 'Streak Counter', on: true },
      ].map((item, i) => (
        <div key={i} className={`rounded-lg p-2.5 ${darkMode ? 'bg-gray-900' : 'bg-white border border-gray-200'}`}>
          <div className="flex items-center justify-between">
            <div className={`text-xs font-medium truncate mr-2 ${TH('text-primary', darkMode)}`}>{item.label}</div>
            <div className={`relative w-10 h-5 rounded-full flex-shrink-0 ${item.on ? 'bg-violet-600' : darkMode ? 'bg-gray-600' : 'bg-gray-200'}`}>
              <div className={`absolute top-0.5 w-4 h-4 bg-white rounded-full shadow ${item.on ? 'translate-x-5' : 'translate-x-0.5'}`} />
            </div>
          </div>
        </div>
      ))}
      <div className={`rounded-lg p-2.5 ${darkMode ? 'bg-gray-900/50 border border-gray-800' : 'bg-white border border-gray-200'}`}>
        <div className={`text-xs font-medium mb-1.5 ${TH('text-dim', darkMode)}`}>Shortcuts</div>
        <div className={`text-xs space-y-0.5 ${darkMode ? 'text-gray-500' : 'text-gray-600'}`}>
          <div className="flex justify-between"><span>Yes</span><span className="font-mono">Y</span></div>
          <div className="flex justify-between"><span>No</span><span className="font-mono">N</span></div>
          <div className="flex justify-between"><span>Next</span><span className="font-mono">&rarr;</span></div>
        </div>
      </div>
      <div className={`rounded-lg p-2.5 ${darkMode ? 'bg-gray-900' : 'bg-white border border-gray-200'}`}>
        <div className={`text-xs font-medium mb-1.5 ${TH('text-primary', darkMode)}`}>Your Data</div>
        <div className="flex gap-1.5">
          <div className={`flex-1 py-1.5 rounded-lg text-xs font-medium text-center ${darkMode ? 'bg-emerald-900/30 text-emerald-400' : 'bg-emerald-100 text-emerald-600'}`}>Export</div>
          <div className={`flex-1 py-1.5 rounded-lg text-xs font-medium text-center ${darkMode ? 'bg-blue-900/30 text-blue-400' : 'bg-blue-100 text-blue-600'}`}>Import</div>
        </div>
      </div>
      <div className={`text-xs text-center ${TH('text-faint', darkMode)}`}>Aura vR-Data</div>
    </div>
  </div>
);

// ==================== SCREEN: Assessment Hub ====================
const ScreenAssessments = ({ darkMode }) => {
  const Circle = ({ progress, size, sw, color, children, id }) => {
    const r = (size - sw) / 2;
    const circ = 2 * Math.PI * r;
    const grad = PROGRESS_GRADIENTS[color] || PROGRESS_GRADIENTS.violet;
    const gId = id || `ac-${size}-${color}-${progress}`;
    return (
      <div className="relative flex items-center justify-center" style={{ width: size, height: size }}>
        <svg width={size} height={size} className="absolute">
          <defs>
            <linearGradient id={gId} x1="0%" y1="0%" x2="100%" y2="100%">
              <stop offset="0%" stopColor={progress > 0 ? grad.from : (darkMode ? '#374151' : '#9ca3af')} />
              <stop offset="100%" stopColor={progress > 0 ? grad.to : (darkMode ? '#4b5563' : '#d1d5db')} />
            </linearGradient>
          </defs>
          <circle cx={size/2} cy={size/2} r={r} fill="none" stroke={darkMode ? '#1f2937' : '#c7d0dc'} strokeWidth={sw} />
          <circle cx={size/2} cy={size/2} r={r} fill="none" stroke={`url(#${gId})`} strokeWidth={sw} strokeLinecap="round"
            strokeDasharray={circ} strokeDashoffset={circ * (1 - progress / 100)}
            transform={`rotate(-90 ${size/2} ${size/2})`} />
        </svg>
        <span className="relative z-10">{children}</span>
      </div>
    );
  };

  return (
    <div className={`flex-1 flex flex-col ${TH('bg-main', darkMode)}`}>
      <div className={`h-10 flex-shrink-0 flex items-center gap-2 px-3 border-b ${TH('border-base', darkMode)}`}>
        <span className={darkMode ? 'text-gray-400' : 'text-gray-500'}>&larr;</span>
        <span className="text-lg select-none">&#x1fa9e;</span>
        <span className={`text-sm font-semibold flex-1 truncate ${TH('text-primary', darkMode)}`}>Reveal</span>
        <span className="px-2 py-1 rounded-full text-xs font-medium bg-violet-600 text-white">Analysis</span>
      </div>
      <div className="flex-1 overflow-auto p-3 pb-16 hide-scrollbar space-y-2.5">
        <div className={`w-full p-3 rounded-xl ${TH('bg-card', darkMode)} flex items-center gap-3`}>
          <Circle progress={40} size={44} sw={3} color="blue" id="pick-qp">
            <span className="text-xs font-medium" style={{ color: PROGRESS_GRADIENTS.blue.to }}>10</span>
          </Circle>
          <div className="flex-1 min-w-0 text-left">
            <div className={`text-sm font-semibold truncate ${TH('text-primary', darkMode)}`}>Quick Profile</div>
            <div className={`text-xs ${darkMode ? 'text-blue-400' : 'text-blue-600'}`}>40% done</div>
          </div>
          <span className={`text-xs font-medium px-2 py-1 rounded-full flex-shrink-0 ${darkMode ? 'bg-blue-600/20 text-blue-400' : 'bg-blue-100 text-blue-600'}`}>Continue</span>
        </div>
        <div className={`rounded-xl overflow-hidden ${TH('bg-card', darkMode)}`}>
          <div className="w-full p-3 text-left flex items-center gap-2.5">
            <Circle progress={33} size={40} sw={3} color="indigo" id="pick-starter">
              <span className="text-xs font-medium" style={{ color: PROGRESS_GRADIENTS.indigo.to }}>2</span>
            </Circle>
            <div className="flex-1 min-w-0">
              <div className={`text-sm font-semibold truncate ${TH('text-primary', darkMode)}`}>Starter Pack</div>
              <div className={`text-xs ${darkMode ? 'text-indigo-400' : 'text-indigo-600'}`}>2 left</div>
            </div>
          </div>
        </div>
        <div className={`w-full p-3 rounded-xl ${TH('bg-card', darkMode)} flex items-center gap-3 opacity-70`}>
          <Circle progress={0} size={44} sw={3} color="violet" id="pick-deep">
            <span className="text-xs font-medium" style={{ color: darkMode ? '#6b7280' : '#9ca3af' }}>40</span>
          </Circle>
          <div className="flex-1 min-w-0 text-left">
            <div className={`text-sm font-semibold truncate ${TH('text-primary', darkMode)}`}>Personality Deep</div>
            <div className={`text-xs ${darkMode ? 'text-violet-400' : 'text-violet-600'}`}>40 questions</div>
          </div>
          <span className={`text-xs font-medium px-2 py-1 rounded-full flex-shrink-0 ${darkMode ? 'bg-violet-600/20 text-violet-400' : 'bg-violet-100 text-violet-600'}`}>Start</span>
        </div>
        <div className="mt-1">
          <div className={`text-xs font-medium uppercase tracking-wide mb-1.5 px-1 ${TH('text-dim', darkMode)}`}>Completed</div>
          <div className={`rounded-xl overflow-hidden ${TH('bg-card', darkMode)}`}>
            <div className="w-full px-3 py-2 flex items-center gap-2.5">
              <Circle progress={100} size={28} sw={2} color="emerald" id="pick-char">
                <span className="text-xs">&#x1f6e1;</span>
              </Circle>
              <span className={`flex-1 text-left text-xs font-medium truncate ${TH('text-primary', darkMode)}`}>Character</span>
              <span className={`text-xs ${darkMode ? 'text-emerald-400' : 'text-emerald-600'}`}>View &rarr;</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

// ==================== SCREEN: Assessment Taking ====================
const ScreenAssessmentTaking = ({ darkMode }) => {
  const scaleLabels = [
    { v: 1, l: 'Not like me' },
    { v: 2, l: 'A little unlike' },
    { v: 3, l: 'Neutral' },
    { v: 4, l: 'A little like me' },
    { v: 5, l: 'Very like me' },
  ];
  const totalQ = 10;
  const currentIdx = 3;
  const selectedAnswer = 4;

  const segments = Array.from({ length: totalQ }, (_, i) => ({
    isAnswered: i < currentIdx,
    isCurrent: i === currentIdx,
  }));

  return (
    <div className={`flex-1 flex flex-col ${TH('bg-main', darkMode)}`}>
      <div className={`h-9 flex-shrink-0 flex items-center gap-1.5 px-2.5 border-b ${TH('border-base', darkMode)}`}>
        <span className={`text-xs font-semibold ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>Save</span>
        <span className={`text-sm font-bold w-6 h-6 flex items-center justify-center ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>&#x25C0;</span>
        <div className="flex-1 text-center">
          <div className={`text-xs ${darkMode ? 'text-blue-400' : 'text-blue-600'}`}>Quick Profile</div>
          <div className={`text-xs font-medium ${TH('text-primary', darkMode)}`}>{currentIdx + 1} / {totalQ}</div>
        </div>
        <span className={`text-sm font-bold w-6 h-6 flex items-center justify-center ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>&#x25B6;</span>
        <span className={`text-xs font-semibold ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>Exit</span>
      </div>
      <div className={`flex h-2 gap-px px-1 py-0.5 ${darkMode ? 'bg-gray-900' : 'bg-gray-100'}`}>
        {segments.map((seg, i) => (
          <div key={i} className={`flex-1 rounded-sm ${seg.isAnswered ? 'bg-blue-500' : seg.isCurrent ? (darkMode ? 'bg-white' : 'bg-gray-900') : (darkMode ? 'bg-gray-800' : 'bg-gray-300')}`} />
        ))}
      </div>
      <div className="flex-1 flex flex-col">
        <div className="flex-1 flex flex-col justify-center px-3 pb-2">
          <div className={`p-4 rounded-xl ${darkMode ? 'bg-gray-900 border border-gray-800' : 'bg-white border border-gray-200'}`}>
            <h2 className={`text-base font-medium text-center leading-relaxed ${TH('text-primary', darkMode)}`}>
              I enjoy being the center of attention
            </h2>
          </div>
        </div>
        <div className="flex-shrink-0 px-3 pb-3 space-y-1.5">
          {scaleLabels.map((option) => {
            const isSelected = option.v === selectedAnswer;
            return (
              <div key={option.v} className={`w-full py-2.5 px-3 rounded-lg flex items-center justify-between border overflow-hidden text-xs ${
                isSelected
                  ? `bg-blue-600 border-blue-400 text-white ring-2 ring-blue-400 ring-offset-1 ${darkMode ? 'ring-offset-gray-950' : 'ring-offset-white'}`
                  : `${darkMode ? 'bg-gray-800/50 border-gray-700 text-gray-200' : 'bg-gray-50 border-gray-200 text-gray-700'}`
              }`}>
                <span className="truncate">{option.l}</span>
                <span className={`text-xs font-medium flex-shrink-0 ml-1 ${isSelected ? 'text-white/70' : (darkMode ? 'text-blue-400/70' : 'text-blue-500/70')}`}>{option.v}</span>
              </div>
            );
          })}
        </div>
      </div>
    </div>
  );
};

// ==================== SCREEN: Assessment Results ====================
const ScreenAssessmentResults = ({ darkMode }) => {
  const grad = PROGRESS_GRADIENTS.violet;
  const traits = [
    { name: 'Extraversion', low: 'Reserved', high: 'Outgoing', score: 35 },
    { name: 'Agreeableness', low: 'Analytical', high: 'Empathetic', score: 72 },
    { name: 'Conscientiousness', low: 'Flexible', high: 'Organized', score: 58 },
    { name: 'Neuroticism', low: 'Calm', high: 'Sensitive', score: 45 },
    { name: 'Openness', low: 'Practical', high: 'Curious', score: 81 },
  ];

  const TraitSpectrum = ({ name, score, low, high }) => (
    <div className="py-0.5">
      {name && <div className={`text-xs font-medium mb-0.5 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>{name}</div>}
      <div className="flex justify-between text-[9px] mb-0.5">
        <span className={darkMode ? 'text-gray-500' : 'text-gray-600'}>{low}</span>
        <span className={darkMode ? 'text-gray-500' : 'text-gray-600'}>{high}</span>
      </div>
      <div className="h-2 rounded-full relative" style={{ background: `linear-gradient(to right, ${grad.from}, ${grad.to})` }}>
        <div className="absolute top-1/2 -translate-y-1/2 w-3 h-3 rounded-full bg-white"
          style={{ left: `${Math.max(5, Math.min(95, score))}%`, marginLeft: -6, boxShadow: '0 1px 3px rgba(0,0,0,0.25)' }} />
      </div>
    </div>
  );

  return (
    <div className={`flex-1 flex flex-col ${TH('bg-main', darkMode)}`}>
      <div className={`h-9 flex-shrink-0 flex items-center gap-1.5 px-2.5 border-b ${TH('border-base', darkMode)}`}>
        <span className={darkMode ? 'text-gray-400' : 'text-gray-500'}>&larr;</span>
        <span className={`text-sm font-semibold flex-1 text-center truncate ${TH('text-primary', darkMode)}`}>Quick Profile</span>
        <div className="w-3" />
      </div>
      <div className="flex-1 overflow-y-auto p-3 space-y-3 hide-scrollbar">
        <div className={`rounded-xl overflow-hidden ${darkMode ? 'bg-gray-900/80 border border-gray-800' : 'bg-white border border-gray-200'}`}>
          <div className="p-4 bg-gradient-to-br from-violet-600 to-violet-400 text-center">
            <span className="text-3xl">&#x26A1;</span>
            <h2 className="text-white text-base font-bold mt-1">Profile Complete</h2>
            <p className="text-white/70 text-xs mt-0.5">Based on 10 responses</p>
          </div>
          <div className="p-3 space-y-2">
            {traits.map((t, i) => (
              <TraitSpectrum key={i} name={t.name} score={t.score} low={t.low} high={t.high} />
            ))}
            <div className="flex gap-2 pt-1">
              <span className="text-base">&#x1f4aa;</span>
              <div className="flex-1 min-w-0">
                <div className={`text-xs font-medium uppercase tracking-wide ${darkMode ? 'text-violet-400' : 'text-violet-600'}`}>Strength</div>
                <p className={`text-xs mt-0.5 truncate ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>Recharges through reflection</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

// ==================== MODAL: Save Progress ====================
const ScreenSaveModal = ({ darkMode }) => (
  <div className={`flex-1 flex flex-col ${TH('bg-main', darkMode)}`}>
    <div className="flex-1 flex items-center justify-center" style={{ backgroundColor: darkMode ? 'rgba(0,0,0,0.7)' : 'rgba(0,0,0,0.12)' }}>
      <div className={`w-full rounded-xl p-5 ${darkMode ? 'bg-gray-900' : 'bg-white shadow-2xl'}`} style={{ maxWidth: 260 }}>
        <div className="text-3xl text-center mb-2">&#x1f389;</div>
        <h2 className={`text-base font-bold text-center mb-1.5 ${darkMode ? 'text-white' : 'text-gray-900'}`}>20 responses!</h2>
        <p className={`text-xs text-center mb-4 leading-snug ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
          Save your progress?<br/>Sync across devices anytime.
        </p>
        <div className="space-y-1.5">
          <div className={`w-full py-2.5 rounded-lg font-medium text-xs text-center ${darkMode ? 'bg-violet-600 text-white' : 'bg-violet-500 text-white'}`}>Create Account</div>
          <div className={`w-full py-2.5 rounded-lg font-medium text-xs text-center ${darkMode ? 'bg-gray-800 text-gray-400' : 'bg-gray-100 text-gray-600'}`}>Later</div>
        </div>
      </div>
    </div>
  </div>
);

// ==================== MODAL: Level Up ====================
const ScreenLevelUp = ({ darkMode }) => (
  <div className={`flex-1 flex flex-col ${TH('bg-main', darkMode)}`}>
    <div className="flex-1 flex items-center justify-center" style={{ backgroundColor: darkMode ? 'rgba(0,0,0,0.85)' : 'rgba(0,0,0,0.12)' }}>
      <div className={`w-full rounded-xl p-6 text-center ${darkMode ? 'bg-gray-900' : 'bg-white shadow-2xl'}`} style={{ maxWidth: 260 }}>
        <div className="text-4xl mb-3 celebrate-glow">&#x1f389;</div>
        <h2 className={`text-lg font-bold mb-1.5 ${darkMode ? 'text-white' : 'text-gray-900'}`}>Level Up!</h2>
        <div className={`text-3xl font-bold mb-1 ${darkMode ? 'text-violet-400' : 'text-violet-600'}`}>5</div>
        <p className={`text-sm font-medium mb-4 ${darkMode ? 'text-violet-300' : 'text-violet-500'}`}>Thinker</p>
        <div className={`w-full py-2.5 rounded-lg font-medium text-sm ${darkMode ? 'bg-violet-600 text-white' : 'bg-violet-500 text-white'}`}>Continue</div>
      </div>
    </div>
  </div>
);

// ==================== SCREEN: Profile ====================
const ScreenProfile = ({ darkMode }) => {
  const auraStyle = {
    boxShadow: '0 0 20px 6px rgba(139,92,246,0.3), 0 0 30px 10px rgba(16,185,129,0.2)',
    border: '2px solid rgba(139,92,246,0.5)'
  };

  return (
    <div className={`flex-1 flex flex-col overflow-hidden ${darkMode ? 'text-white bg-gray-950' : 'text-gray-900 bg-gray-50'}`}>
      <div className={`h-9 flex-shrink-0 flex items-center gap-1.5 px-2.5 border-b ${TH('border-base', darkMode)}`}>
        <span className={darkMode ? 'text-gray-400' : 'text-gray-500'}>&larr;</span>
        <span className="font-medium text-sm flex-1 truncate">Profile</span>
      </div>
      <div className="flex-1 p-3 overflow-y-auto space-y-3 hide-scrollbar">
        <div className="flex items-center gap-3">
          <div className="w-12 h-12 bg-gradient-to-br from-violet-500 to-fuchsia-500 rounded-full flex items-center justify-center font-bold text-base text-white flex-shrink-0"
            style={auraStyle}>P</div>
          <div className="flex-1 min-w-0">
            <h2 className="font-semibold text-sm truncate">philip@aura.app</h2>
            <div className="flex items-center gap-2 mt-0.5">
              <span className={`text-xs ${darkMode ? 'text-violet-400' : 'text-violet-600'}`}>Lv.3</span>
              <span className="text-xs text-orange-400">&#x1f525;5</span>
              <span className={`text-xs ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>145 XP</span>
            </div>
          </div>
        </div>
        <div className={`w-full rounded-xl overflow-hidden text-left ${
          darkMode ? 'bg-gradient-to-br from-violet-950/50 to-indigo-950/60 border border-violet-700/40'
                   : 'bg-gradient-to-br from-violet-50 to-indigo-50 border border-violet-200'
        }`}>
          <div className="flex items-stretch" style={{ minHeight: 72 }}>
            <div className={`w-16 flex-shrink-0 flex items-center justify-center overflow-hidden ${darkMode ? 'bg-gray-950/40' : 'bg-white/50'}`}>
              <span className="text-2xl">&#x1f300;</span>
            </div>
            <div className="flex-1 min-w-0 py-2.5 px-3 flex flex-col justify-center">
              <div className={`text-sm font-semibold truncate ${darkMode ? 'text-white' : 'text-gray-900'}`}>The Quiet Strategist</div>
              <p className={`text-xs truncate ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Thoughtful planner, big picture</p>
              <div className="flex items-center gap-1 mt-1">
                {[1,2,3,4].map(s => (
                  <div key={s} className={`w-1.5 h-1.5 rounded-full ${s <= 2 ? (darkMode ? 'bg-violet-400' : 'bg-violet-500') : (darkMode ? 'bg-gray-700' : 'bg-gray-300')}`} />
                ))}
                <span className={`text-xs ml-0.5 ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>Stage 2</span>
              </div>
            </div>
          </div>
        </div>
        <div className={`rounded-xl p-3 ${darkMode ? 'bg-gray-900/40 border border-gray-800/40' : 'bg-white border border-gray-200'}`}>
          <div className={`text-xs font-semibold uppercase tracking-wide mb-2 ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>Activity</div>
          <div className="grid grid-cols-3 gap-3">
            <div className="text-center">
              <div className={`text-lg font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>42</div>
              <div className={`text-xs ${darkMode ? 'text-gray-500' : 'text-gray-500'}`}>Answered</div>
            </div>
            <div className="text-center">
              <div className={`text-lg font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>2.8</div>
              <div className={`text-xs ${darkMode ? 'text-gray-500' : 'text-gray-500'}`}>Avg Conf</div>
            </div>
            <div className="text-center">
              <div className={`text-lg font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>3</div>
              <div className={`text-xs ${darkMode ? 'text-gray-500' : 'text-gray-500'}`}>Assess.</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

// ==================== SCREEN: Question of the Day ====================
const ScreenQotD = ({ darkMode }) => {
  const blueGlowStyle = {
    background: darkMode
      ? 'radial-gradient(ellipse at center top, rgba(59, 130, 246, 0.25) 0%, rgba(59, 130, 246, 0.12) 35%, transparent 70%), #030712'
      : 'radial-gradient(ellipse at center top, rgba(59, 130, 246, 0.15) 0%, rgba(59, 130, 246, 0.06) 35%, transparent 70%), #f9fafb'
  };

  return (
    <div className="flex-1 flex flex-col overflow-hidden relative" style={blueGlowStyle}>
      <div className={`h-8 flex-shrink-0 flex items-center gap-1.5 px-2.5 ${darkMode ? 'bg-gray-900/50' : 'bg-white/80 border-b border-gray-200'}`}>
        <span className={`text-sm font-bold w-6 h-6 flex items-center justify-center ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>&#x25C0;</span>
        <div className={`flex-1 h-1.5 rounded-full overflow-hidden ${darkMode ? 'bg-gray-800' : 'bg-gray-300'}`}>
          <div className="h-full bg-blue-500" style={{ width: '0%' }} />
        </div>
        <span className={`text-sm font-bold w-6 h-6 flex items-center justify-center ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>&#x25B6;</span>
      </div>
      <div className={`h-6 flex-shrink-0 flex items-center justify-center gap-1.5 ${darkMode ? 'bg-blue-900/20' : 'bg-blue-50'}`}>
        <span className="text-xs">&#x2600;&#xFE0F;</span>
        <span className={`text-xs font-medium ${darkMode ? 'text-blue-400' : 'text-blue-600'}`}>QotD</span>
        <span className={`text-xs ${darkMode ? 'text-gray-500' : 'text-gray-500'}`}>Day 12</span>
        <span className="text-amber-500 text-xs font-medium">+25</span>
      </div>
      <div className="flex-1 flex flex-col justify-center px-3 pb-2 overflow-y-auto">
        <div className="space-y-1.5 glow-blue p-3 rounded-xl">
          <h2 className={`text-sm text-center font-medium leading-snug ${TH('text-primary', darkMode)}`}>
            Should AI systems be required to identify themselves?
          </h2>
        </div>
      </div>
      <div className={`flex-shrink-0 border-t ${darkMode ? 'border-gray-800 bg-gray-950/80' : 'border-gray-200 bg-white/80'}`}>
        <div className="px-3 pt-2 pb-1">
          <div className="flex items-center gap-1.5">
            <div className={`flex-1 h-11 rounded-lg font-bold overflow-hidden flex items-center justify-center ${
              darkMode ? 'bg-gray-800 text-gray-300' : 'bg-white text-emerald-600 border-2 border-emerald-200'
            }`}>
              <span className="text-base font-bold">YES</span>
            </div>
            <div className="w-8 h-11 flex-shrink-0" />
            <div className={`flex-1 h-11 rounded-lg font-bold overflow-hidden flex items-center justify-center ${
              darkMode ? 'bg-gray-800 text-gray-300' : 'bg-white text-rose-600 border-2 border-rose-200'
            }`}>
              <span className="text-base font-bold">NO</span>
            </div>
          </div>
        </div>
        <div className="h-6" />
      </div>
    </div>
  );
};

// ==================== FLOW MAP DATA ====================
const SCREENS = [
  { id: 'welcome', name: 'Welcome', component: ScreenWelcome, lane: 'auth', col: 0, row: 0 },
  { id: 'signin', name: 'Sign In', component: ScreenSignIn, lane: 'auth', col: 1, row: 1 },
  { id: 'onboarding', name: 'Onboarding', component: ScreenOnboarding, lane: 'auth', col: 1, row: 0 },
  { id: 'path-choice', name: 'Path Choice', component: ScreenPathChoice, lane: 'auth', col: 2, row: 0 },
  { id: 'categories', name: 'Categories', component: ScreenCategories, lane: 'main', col: 3, row: 0, featured: true },
  { id: 'profile', name: 'Profile', component: ScreenProfile, lane: 'main', col: 4, row: 1 },
  { id: 'qotd', name: 'Question of the Day', component: ScreenQotD, lane: 'main', col: 4, row: -1 },
  { id: 'settings', name: 'Settings', component: ScreenSettings, lane: 'main', col: 4, row: 2 },
  { id: 'binary-question', name: 'Binary Question', component: ScreenBinaryQuestion, lane: 'questions', col: 5, row: 0, featured: true },
  { id: 'mc-question', name: 'MC Question', component: ScreenMCQuestion, lane: 'questions', col: 5, row: 1 },
  { id: 'results', name: 'Results', component: ScreenResults, lane: 'questions', col: 6, row: 0 },
  { id: 'assessments', name: 'Assessment Hub', component: ScreenAssessments, lane: 'assessments', col: 5, row: 2 },
  { id: 'assess-taking', name: 'Taking Assessment', component: ScreenAssessmentTaking, lane: 'assessments', col: 6, row: 2 },
  { id: 'assess-results', name: 'Assessment Results', component: ScreenAssessmentResults, lane: 'assessments', col: 7, row: 2 },
  { id: 'save-modal', name: 'Save Progress', component: ScreenSaveModal, lane: 'modals', col: 6, row: 1, isModal: true },
  { id: 'level-up', name: 'Level Up', component: ScreenLevelUp, lane: 'modals', col: 7, row: 0, isModal: true },
];

const CONNECTIONS = [
  { from: 'welcome', to: 'signin', label: 'tap Sign In' },
  { from: 'welcome', to: 'onboarding', label: "tap Let's Go" },
  { from: 'onboarding', to: 'path-choice', label: 'complete 10 Qs' },
  { from: 'path-choice', to: 'categories', label: 'choose path' },
  { from: 'signin', to: 'categories', label: 'authenticated' },
  { from: 'categories', to: 'profile', label: 'tap avatar' },
  { from: 'categories', to: 'qotd', label: 'tap QotD card' },
  { from: 'categories', to: 'settings', label: 'tap gear' },
  { from: 'categories', to: 'binary-question', label: 'tap category' },
  { from: 'categories', to: 'mc-question', label: 'tap category' },
  { from: 'categories', to: 'assessments', label: 'tap Reveal' },
  { from: 'binary-question', to: 'results', label: 'submit answer' },
  { from: 'mc-question', to: 'results', label: 'submit answer' },
  { from: 'assessments', to: 'assess-taking', label: 'start/continue' },
  { from: 'assess-taking', to: 'assess-results', label: 'complete all Qs' },
  { from: 'binary-question', to: 'save-modal', label: 'after 20 responses', dashed: true },
  { from: 'results', to: 'level-up', label: 'on level up', dashed: true },
];

const LANE_META = {
  auth:        { name: 'Authentication', color: '#8b5cf6', lightBg: 'rgba(139,92,246,0.04)', lightBorder: 'rgba(139,92,246,0.12)', icon: '\uD83D\uDD11' },
  main:        { name: 'Main Hub',       color: '#3b82f6', lightBg: 'rgba(59,130,246,0.03)', lightBorder: 'rgba(59,130,246,0.10)', icon: '\uD83C\uDFE0' },
  questions:   { name: 'Questions',      color: '#f59e0b', lightBg: 'rgba(245,158,11,0.03)', lightBorder: 'rgba(245,158,11,0.10)', icon: '\u2753' },
  assessments: { name: 'Assessments',    color: '#14b8a6', lightBg: 'rgba(20,184,166,0.03)', lightBorder: 'rgba(20,184,166,0.10)', icon: '\uD83E\uDE9E' },
  modals:      { name: 'Modals',         color: '#f43f5e', lightBg: 'rgba(244,63,94,0.03)', lightBorder: 'rgba(244,63,94,0.10)', icon: '\uD83D\uDCAC' },
};

// Layout constants
const CARD_W = 200;
const CARD_H = 433;
const CARD_W_FEAT = 240;
const CARD_H_FEAT = 520;
const CARD_W_MODAL = 170;
const CARD_H_MODAL = 368;
const COL_GAP = 340;
const ROW_GAP = 500;
const CANVAS_PAD = 200;

const getScreenDims = (s) => {
  if (s.featured) return { w: CARD_W_FEAT, h: CARD_H_FEAT };
  if (s.isModal) return { w: CARD_W_MODAL, h: CARD_H_MODAL };
  return { w: CARD_W, h: CARD_H };
};

const getScreenPos = (s) => {
  const dims = getScreenDims(s);
  const x = CANVAS_PAD + s.col * COL_GAP;
  const y = CANVAS_PAD + 600 + s.row * ROW_GAP;
  return { x, y, ...dims };
};

// ==================== MINI PHONE ON CANVAS ====================
const MiniPhone = ({ screen, darkMode, onClick, isHovered, onHover, onLeave }) => {
  const dims = getScreenDims(screen);
  const phoneW = 393;
  const phoneH = 852;
  const sc = dims.w / phoneW;
  const Comp = screen.component;
  const lane = LANE_META[screen.lane];
  const bgColor = darkMode ? '#030712' : '#f9fafb';
  const br = Math.round(dims.w * 0.112);
  const islandW = Math.round(dims.w * 0.32);
  const islandH = Math.max(4, Math.round(dims.h * 0.019));
  const islandTop = Math.max(3, Math.round(dims.h * 0.008));

  return (
    <div
      onMouseEnter={onHover}
      onMouseLeave={onLeave}
      onClick={onClick}
      style={{ width: dims.w, height: dims.h + 36, cursor: 'pointer', position: 'relative' }}
    >
      {/* Label */}
      <div style={{ height: 32, display: 'flex', alignItems: 'center', justifyContent: 'center', gap: 6, marginBottom: 4 }}>
        <div style={{ width: 8, height: 8, borderRadius: 4, background: lane.color, flexShrink: 0 }} />
        <span style={{
          fontSize: 12, fontWeight: 600,
          color: isHovered ? (darkMode ? '#fff' : '#111') : (darkMode ? '#9ca3af' : '#6b7280'),
          transition: 'color 0.2s', whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis',
        }}>
          {screen.name}
        </span>
      </div>
      {/* Phone frame with Dynamic Island */}
      <div style={{
        width: dims.w, height: dims.h, borderRadius: br,
        overflow: 'hidden', position: 'relative',
        border: isHovered ? `2px solid ${lane.color}` : (darkMode ? '2px solid rgba(55,65,81,0.6)' : '2px solid rgba(209,213,219,0.8)'),
        boxShadow: isHovered
          ? `0 0 24px ${lane.color}33, 0 8px 32px rgba(0,0,0,${darkMode ? 0.4 : 0.15})`
          : (darkMode ? '0 4px 20px rgba(0,0,0,0.3)' : '0 4px 20px rgba(0,0,0,0.08), 0 1px 3px rgba(0,0,0,0.06)'),
        transition: 'border-color 0.25s, box-shadow 0.25s, transform 0.25s',
        transform: isHovered ? 'translateY(-4px)' : 'translateY(0)',
        backgroundColor: bgColor,
      }}>
        {/* Dynamic Island pill - minimal at canvas zoom */}
        <div style={{
          position: 'absolute', top: islandTop, left: '50%', transform: 'translateX(-50%)',
          width: islandW, height: islandH, background: '#000', borderRadius: 9999, zIndex: 30,
        }} />
        {/* Scaled screen content */}
        <div style={{ transform: `scale(${sc})`, transformOrigin: 'top left', width: phoneW, height: phoneH }}>
          <DynamicIslandFrame darkMode={darkMode} width={phoneW} height={phoneH} screenBg={bgColor}>
            <Comp darkMode={darkMode} />
          </DynamicIslandFrame>
        </div>
      </div>
    </div>
  );
};

// ==================== SVG CONNECTIONS ====================
const FlowConnections = ({ screens, connections, darkMode, hoveredScreen }) => {
  const posMap = {};
  screens.forEach(s => { posMap[s.id] = getScreenPos(s); });

  // Arrow colors per mode
  const lineColor = darkMode ? '#374151' : '#cbd5e1';
  const activeColor = darkMode ? '#a78bfa' : '#7c3aed';
  const labelBg = darkMode ? 'rgba(17,24,39,0.92)' : 'rgba(255,255,255,0.95)';
  const labelBorder = darkMode ? '#4b5563' : '#d1d5db';
  const labelText = darkMode ? '#d1d5db' : '#374151';

  return (
    <svg style={{ position: 'absolute', top: 0, left: 0, width: '100%', height: '100%', pointerEvents: 'none', overflow: 'visible' }}>
      <defs>
        <marker id="arrow" viewBox="0 0 10 7" refX="9" refY="3.5" markerWidth="8" markerHeight="6" orient="auto-start-reverse">
          <path d="M 0 0 L 10 3.5 L 0 7 z" fill={darkMode ? '#6b7280' : '#94a3b8'} />
        </marker>
        <marker id="arrow-active" viewBox="0 0 10 7" refX="9" refY="3.5" markerWidth="8" markerHeight="6" orient="auto-start-reverse">
          <path d="M 0 0 L 10 3.5 L 0 7 z" fill={activeColor} />
        </marker>
        {/* Subtle drop shadow for labels */}
        <filter id="labelShadow" x="-10%" y="-10%" width="120%" height="120%">
          <feDropShadow dx="0" dy="1" stdDeviation="2" floodOpacity={darkMode ? '0.4' : '0.12'} />
        </filter>
      </defs>
      {connections.map((conn, i) => {
        const from = posMap[conn.from];
        const to = posMap[conn.to];
        if (!from || !to) return null;

        const isActive = hoveredScreen === conn.from || hoveredScreen === conn.to;
        const fromCx = from.x + from.w / 2;
        const fromCy = from.y + 36 + from.h / 2;
        const toCx = to.x + to.w / 2;
        const toCy = to.y + 36 + to.h / 2;

        let x1 = from.x + from.w + 2;
        let y1 = fromCy;
        let x2 = to.x - 2;
        let y2 = toCy;

        if (Math.abs(to.col - from.col) < 0.5) {
          x1 = fromCx;
          x2 = toCx;
          if (to.row > from.row) {
            y1 = from.y + 36 + from.h + 2;
            y2 = to.y + 36 - 2;
          } else {
            y1 = from.y + 36 - 2;
            y2 = to.y + 36 + to.h + 2;
          }
        }

        const dx = x2 - x1;
        const dy = y2 - y1;
        const cx1 = x1 + dx * 0.4;
        const cy1 = y1 + dy * 0.05;
        const cx2 = x2 - dx * 0.4;
        const cy2 = y2 - dy * 0.05;

        const midX = (x1 + x2) / 2;
        const midY = (y1 + y2) / 2;

        return (
          <g key={i}>
            <path
              d={`M ${x1} ${y1} C ${cx1} ${cy1}, ${cx2} ${cy2}, ${x2} ${y2}`}
              fill="none"
              stroke={isActive ? activeColor : lineColor}
              strokeWidth={isActive ? 2.5 : 1.5}
              strokeDasharray={conn.dashed ? '8 4' : 'none'}
              markerEnd={isActive ? 'url(#arrow-active)' : 'url(#arrow)'}
              style={{ transition: 'stroke 0.25s, stroke-width 0.25s', opacity: isActive ? 1 : (darkMode ? 0.5 : 0.6) }}
            />
            {conn.label && (
              <g style={{ opacity: isActive ? 1 : 0, transition: 'opacity 0.25s' }} filter="url(#labelShadow)">
                <rect x={midX - conn.label.length * 3.2 - 8} y={midY - 11} width={conn.label.length * 6.4 + 16} height={22} rx={11}
                      fill={labelBg} stroke={labelBorder} strokeWidth="1" />
                <text x={midX} y={midY + 4} textAnchor="middle" fill={labelText} fontSize="11" fontWeight="500" fontFamily="system-ui, sans-serif">
                  {conn.label}
                </text>
              </g>
            )}
          </g>
        );
      })}
    </svg>
  );
};

// ==================== MINIMAP ====================
const MiniMap = ({ viewportX, viewportY, zoom, canvasW, canvasH, viewW, viewH, onJump, darkMode }) => {
  const mapW = 180;
  const mapH = 100;
  const scaleX = mapW / canvasW;
  const scaleY = mapH / canvasH;
  const sc = Math.min(scaleX, scaleY);

  const vpW = (viewW / zoom) * sc;
  const vpH = (viewH / zoom) * sc;
  const vpX = (-viewportX / zoom) * sc;
  const vpY = (-viewportY / zoom) * sc;

  const handleClick = (e) => {
    const rect = e.currentTarget.getBoundingClientRect();
    const mx = e.clientX - rect.left;
    const my = e.clientY - rect.top;
    const canvasX = mx / sc;
    const canvasY = my / sc;
    onJump(canvasX, canvasY);
  };

  return (
    <div onClick={handleClick}
      style={{
        position: 'fixed', bottom: 20, right: 20, width: mapW, height: mapH,
        background: darkMode ? 'rgba(17,24,39,0.85)' : 'rgba(255,255,255,0.92)',
        border: darkMode ? '1px solid #374151' : '1px solid #d1d5db',
        borderRadius: 8, zIndex: 60, cursor: 'crosshair',
        backdropFilter: 'blur(8px)', overflow: 'hidden',
        boxShadow: darkMode ? 'none' : '0 2px 8px rgba(0,0,0,0.08)',
      }}>
      {SCREENS.map(s => {
        const pos = getScreenPos(s);
        return (
          <div key={s.id} style={{
            position: 'absolute', left: pos.x * sc, top: pos.y * sc,
            width: Math.max(pos.w * sc, 4), height: Math.max(pos.h * sc, 3),
            background: LANE_META[s.lane].color, borderRadius: 1, opacity: 0.7,
          }} />
        );
      })}
      <div style={{
        position: 'absolute', left: Math.max(0, vpX), top: Math.max(0, vpY),
        width: Math.min(vpW, mapW), height: Math.min(vpH, mapH),
        border: darkMode ? '1.5px solid rgba(255,255,255,0.6)' : '1.5px solid rgba(0,0,0,0.4)',
        borderRadius: 3, background: darkMode ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.04)',
      }} />
    </div>
  );
};

// ==================== DETAIL PANEL ====================
const DetailPanel = ({ screen, darkMode, onClose }) => {
  if (!screen) return null;
  const Comp = screen.component;
  const lane = LANE_META[screen.lane];
  const connsFrom = CONNECTIONS.filter(c => c.from === screen.id);
  const connsTo = CONNECTIONS.filter(c => c.to === screen.id);

  const panelBg = darkMode ? 'rgba(3,7,18,0.97)' : 'rgba(255,255,255,0.98)';
  const panelBorder = darkMode ? '#1f2937' : '#e5e7eb';
  const textPrimary = darkMode ? '#fff' : '#111827';
  const textSecondary = darkMode ? '#d1d5db' : '#374151';
  const textMuted = darkMode ? '#6b7280' : '#9ca3af';
  const dividerColor = darkMode ? '#111827' : '#f3f4f6';
  const closeBg = darkMode ? '#1f2937' : '#f3f4f6';
  const closeColor = darkMode ? '#9ca3af' : '#6b7280';
  const screenBg = darkMode ? '#030712' : '#f9fafb';

  // Device frame styling
  const frameBg = darkMode ? '#1a1a1c' : '#e5e7eb';
  const frameShadow = darkMode ? '0 25px 50px rgba(0,0,0,0.4)' : '0 25px 50px rgba(0,0,0,0.12)';
  const btnColor = darkMode ? '#2a2a2c' : '#c7ccd4';

  return (
    <div style={{
      position: 'fixed', top: 0, right: 0, bottom: 0, width: 460, zIndex: 70,
      background: panelBg, borderLeft: `1px solid ${panelBorder}`,
      backdropFilter: 'blur(20px)', display: 'flex', flexDirection: 'column',
      animation: 'slideInRight 0.3s ease-out',
    }}>
      {/* Header */}
      <div style={{ padding: '16px 20px', borderBottom: `1px solid ${panelBorder}`, display: 'flex', alignItems: 'center', gap: 12, flexShrink: 0 }}>
        <div style={{ width: 10, height: 10, borderRadius: 5, background: lane.color }} />
        <div style={{ flex: 1 }}>
          <div style={{ fontSize: 11, color: lane.color, fontWeight: 600, textTransform: 'uppercase', letterSpacing: '0.05em' }}>{lane.name}</div>
          <div style={{ fontSize: 18, fontWeight: 700, color: textPrimary }}>{screen.name}</div>
        </div>
        <div onClick={onClose} style={{
          width: 32, height: 32, borderRadius: 8, background: closeBg, display: 'flex', alignItems: 'center', justifyContent: 'center',
          cursor: 'pointer', color: closeColor, fontSize: 16, fontWeight: 700,
        }}>&#x2715;</div>
      </div>
      {/* Phone preview - detailed with full device frame */}
      <div style={{ flex: 1, overflow: 'auto', padding: 20 }} className="hide-scrollbar">
        <div style={{ display: 'flex', justifyContent: 'center', marginBottom: 20 }}>
          <div style={{
            background: frameBg, padding: 12, borderRadius: 55, position: 'relative',
            filter: `drop-shadow(${frameShadow})`,
          }}>
            {/* Side buttons */}
            <div style={{ position: 'absolute', left: -3, top: 100, width: 3, height: 28, background: btnColor, borderRadius: '2px 0 0 2px' }} />
            <div style={{ position: 'absolute', left: -3, top: 145, width: 3, height: 50, background: btnColor, borderRadius: '2px 0 0 2px' }} />
            <div style={{ position: 'absolute', left: -3, top: 205, width: 3, height: 50, background: btnColor, borderRadius: '2px 0 0 2px' }} />
            <div style={{ position: 'absolute', right: -3, top: 160, width: 3, height: 65, background: btnColor, borderRadius: '0 2px 2px 0' }} />
            {/* Phone screen */}
            <DynamicIslandFrame darkMode={darkMode} width={393} height={852} screenBg={screenBg}>
              <Comp darkMode={darkMode} />
            </DynamicIslandFrame>
          </div>
        </div>
        {/* Connections info */}
        {connsFrom.length > 0 && (
          <div style={{ marginBottom: 16 }}>
            <div style={{ fontSize: 11, fontWeight: 600, color: textMuted, textTransform: 'uppercase', letterSpacing: '0.05em', marginBottom: 8 }}>Navigates to</div>
            {connsFrom.map((c, i) => (
              <div key={i} style={{ display: 'flex', alignItems: 'center', gap: 8, padding: '6px 0', borderBottom: `1px solid ${dividerColor}` }}>
                <span style={{ color: textMuted, fontSize: 14 }}>&rarr;</span>
                <span style={{ color: textSecondary, fontSize: 13, fontWeight: 500 }}>{SCREENS.find(s => s.id === c.to)?.name}</span>
                <span style={{ color: textMuted, fontSize: 11, fontStyle: 'italic', marginLeft: 'auto' }}>{c.label}</span>
              </div>
            ))}
          </div>
        )}
        {connsTo.length > 0 && (
          <div>
            <div style={{ fontSize: 11, fontWeight: 600, color: textMuted, textTransform: 'uppercase', letterSpacing: '0.05em', marginBottom: 8 }}>Reached from</div>
            {connsTo.map((c, i) => (
              <div key={i} style={{ display: 'flex', alignItems: 'center', gap: 8, padding: '6px 0', borderBottom: `1px solid ${dividerColor}` }}>
                <span style={{ color: textMuted, fontSize: 14 }}>&larr;</span>
                <span style={{ color: textSecondary, fontSize: 13, fontWeight: 500 }}>{SCREENS.find(s => s.id === c.from)?.name}</span>
                <span style={{ color: textMuted, fontSize: 11, fontStyle: 'italic', marginLeft: 'auto' }}>{c.label}</span>
              </div>
            ))}
          </div>
        )}
      </div>
    </div>
  );
};

// ==================== MAIN APP ====================
const App = () => {
  const [darkMode, setDarkMode] = useState(true);
  const [selectedScreen, setSelectedScreen] = useState(null);
  const [hoveredScreen, setHoveredScreen] = useState(null);
  const [zoom, setZoom] = useState(0.55);
  const [pan, setPan] = useState({ x: -100, y: -350 });
  const [isPanning, setIsPanning] = useState(false);
  const [panStart, setPanStart] = useState({ x: 0, y: 0 });
  const canvasRef = useRef(null);
  const [viewSize, setViewSize] = useState({ w: 1200, h: 800 });

  const allPos = SCREENS.map(getScreenPos);
  const canvasW = Math.max(...allPos.map(p => p.x + p.w)) + CANVAS_PAD * 2;
  const canvasH = Math.max(...allPos.map(p => p.y + p.h + 36)) + CANVAS_PAD * 2;

  useEffect(() => {
    const updateSize = () => setViewSize({ w: window.innerWidth, h: window.innerHeight });
    updateSize();
    window.addEventListener('resize', updateSize);
    return () => window.removeEventListener('resize', updateSize);
  }, []);

  const handleMouseDown = useCallback((e) => {
    if (e.target.closest('[data-screen-card]')) return;
    setIsPanning(true);
    setPanStart({ x: e.clientX - pan.x, y: e.clientY - pan.y });
  }, [pan]);

  const handleMouseMove = useCallback((e) => {
    if (!isPanning) return;
    setPan({ x: e.clientX - panStart.x, y: e.clientY - panStart.y });
  }, [isPanning, panStart]);

  const handleMouseUp = useCallback(() => setIsPanning(false), []);

  const handleWheel = useCallback((e) => {
    e.preventDefault();
    const delta = e.deltaY > 0 ? -0.05 : 0.05;
    setZoom(z => Math.max(0.15, Math.min(1.5, z + delta)));
  }, []);

  useEffect(() => {
    const handler = (e) => {
      if (e.key === 'Escape') setSelectedScreen(null);
      if (e.key === '+' || e.key === '=') setZoom(z => Math.min(1.5, z + 0.1));
      if (e.key === '-') setZoom(z => Math.max(0.15, z - 0.1));
      if (e.key === '0') { setZoom(0.55); setPan({ x: -100, y: -350 }); }
    };
    window.addEventListener('keydown', handler);
    return () => window.removeEventListener('keydown', handler);
  }, []);

  const handleMiniMapJump = (cx, cy) => {
    const newX = -(cx * zoom - viewSize.w / 2);
    const newY = -(cy * zoom - viewSize.h / 2);
    setPan({ x: newX, y: newY });
  };

  const laneOrder = ['auth', 'main', 'questions', 'assessments', 'modals'];

  // Mode-aware colors
  const canvasBg = darkMode ? '#0a0a0f' : '#f8fafc';
  const dotColor = darkMode ? '#1f2937' : '#d1d5db';
  const toolbarBg = darkMode ? 'rgba(3,7,18,0.85)' : 'rgba(255,255,255,0.92)';
  const toolbarBorder = darkMode ? '#1f2937' : '#e5e7eb';
  const toolbarTitle = darkMode ? '#fff' : '#111827';
  const toolbarSub = darkMode ? '#6b7280' : '#9ca3af';
  const controlBg = darkMode ? '#111827' : '#f3f4f6';
  const controlText = darkMode ? '#d1d5db' : '#374151';
  const controlBtn = darkMode ? '#9ca3af' : '#6b7280';
  const hintKeyBg = darkMode ? '#1f2937' : '#e5e7eb';
  const hintKeyText = darkMode ? '#d1d5db' : '#374151';
  const hintLabel = darkMode ? '#6b7280' : '#9ca3af';
  const overlayBg = darkMode ? 'rgba(0,0,0,0.3)' : 'rgba(0,0,0,0.15)';

  return (
    <div style={{ width: '100vw', height: '100vh', overflow: 'hidden', background: canvasBg, position: 'relative', fontFamily: 'system-ui, -apple-system, sans-serif' }}>
      {/* Dot grid background */}
      <div style={{
        position: 'absolute', inset: 0, zIndex: 0,
        backgroundImage: `radial-gradient(circle, ${dotColor} 1px, transparent 1px)`,
        backgroundSize: '24px 24px', opacity: darkMode ? 0.4 : 0.6,
      }} />

      {/* Top toolbar */}
      <div style={{
        position: 'fixed', top: 0, left: 0, right: 0, height: 56, zIndex: 50,
        background: toolbarBg, backdropFilter: 'blur(12px)',
        borderBottom: `1px solid ${toolbarBorder}`, display: 'flex', alignItems: 'center', padding: '0 20px', gap: 16,
        boxShadow: darkMode ? 'none' : '0 1px 3px rgba(0,0,0,0.06)',
      }}>
        <span style={{ fontSize: 22 }}>&#x1f300;</span>
        <span style={{ fontSize: 16, fontWeight: 700, color: toolbarTitle }}>Aura Flow Map</span>
        <span style={{ fontSize: 12, color: toolbarSub }}>{SCREENS.length} screens &middot; {CONNECTIONS.length} connections</span>
        <div style={{ flex: 1 }} />

        {/* Lane legend */}
        <div style={{ display: 'flex', gap: 12, alignItems: 'center', marginRight: 16 }}>
          {laneOrder.map(lid => {
            const lane = LANE_META[lid];
            return (
              <div key={lid} style={{ display: 'flex', alignItems: 'center', gap: 5 }}>
                <div style={{ width: 8, height: 8, borderRadius: 4, background: lane.color }} />
                <span style={{ fontSize: 11, color: darkMode ? '#9ca3af' : '#6b7280', fontWeight: 500 }}>{lane.name}</span>
              </div>
            );
          })}
        </div>

        {/* Zoom controls */}
        <div style={{ display: 'flex', alignItems: 'center', gap: 8, background: controlBg, borderRadius: 8, padding: '4px 10px' }}>
          <div onClick={() => setZoom(z => Math.max(0.15, z - 0.1))} style={{ cursor: 'pointer', color: controlBtn, fontSize: 16, fontWeight: 700, width: 20, textAlign: 'center' }}>&minus;</div>
          <span style={{ fontSize: 12, color: controlText, fontWeight: 600, minWidth: 40, textAlign: 'center' }}>{Math.round(zoom * 100)}%</span>
          <div onClick={() => setZoom(z => Math.min(1.5, z + 0.1))} style={{ cursor: 'pointer', color: controlBtn, fontSize: 16, fontWeight: 700, width: 20, textAlign: 'center' }}>+</div>
        </div>
        <div onClick={() => { setZoom(0.55); setPan({ x: -100, y: -350 }); }}
          style={{ cursor: 'pointer', background: controlBg, borderRadius: 8, padding: '6px 12px', fontSize: 12, color: controlBtn, fontWeight: 500 }}>
          Reset
        </div>

        {/* Theme toggle */}
        <div onClick={() => setDarkMode(!darkMode)}
          style={{
            cursor: 'pointer', width: 44, height: 24, borderRadius: 12,
            background: darkMode ? '#5b21b6' : '#d1d5db', position: 'relative', transition: 'background 0.2s',
          }}>
          <div style={{
            position: 'absolute', top: 2, width: 20, height: 20, borderRadius: 10, background: '#fff',
            transform: darkMode ? 'translateX(22px)' : 'translateX(2px)', transition: 'transform 0.2s',
            display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: 11,
            boxShadow: '0 1px 3px rgba(0,0,0,0.15)',
          }}>{darkMode ? '\uD83C\uDF19' : '\u2600\uFE0F'}</div>
        </div>
      </div>

      {/* Pannable/zoomable canvas */}
      <div
        ref={canvasRef}
        onMouseDown={handleMouseDown}
        onMouseMove={handleMouseMove}
        onMouseUp={handleMouseUp}
        onMouseLeave={handleMouseUp}
        onWheel={handleWheel}
        style={{
          position: 'absolute', inset: 0, paddingTop: 56,
          cursor: isPanning ? 'grabbing' : 'grab', zIndex: 1, overflow: 'hidden',
        }}
      >
        <div style={{
          transform: `translate(${pan.x}px, ${pan.y}px) scale(${zoom})`,
          transformOrigin: '0 0', position: 'relative', width: canvasW, height: canvasH,
        }}>
          {/* Swim lane bands */}
          {(() => {
            const laneGroups = {};
            SCREENS.forEach(s => {
              if (!laneGroups[s.lane]) laneGroups[s.lane] = [];
              laneGroups[s.lane].push(getScreenPos(s));
            });
            return laneOrder.map(lid => {
              const positions = laneGroups[lid];
              if (!positions) return null;
              const lane = LANE_META[lid];
              const minX = Math.min(...positions.map(p => p.x)) - 40;
              const minY = Math.min(...positions.map(p => p.y)) - 60;
              const maxX = Math.max(...positions.map(p => p.x + p.w)) + 40;
              const maxY = Math.max(...positions.map(p => p.y + p.h + 36)) + 40;

              const bandBg = darkMode ? `${lane.color}06` : lane.lightBg;
              const bandBorder = darkMode ? `${lane.color}15` : lane.lightBorder;
              const labelBg = darkMode ? '#0a0a0f' : '#f8fafc';
              const labelColor = darkMode ? `${lane.color}88` : lane.color;
              const labelBorder = darkMode ? `${lane.color}22` : lane.lightBorder;

              return (
                <div key={lid} style={{
                  position: 'absolute', left: minX, top: minY, width: maxX - minX, height: maxY - minY,
                  background: bandBg, border: `1px solid ${bandBorder}`,
                  borderRadius: 16, pointerEvents: 'none',
                }}>
                  <div style={{
                    position: 'absolute', top: -12, left: 16, background: labelBg, padding: '2px 12px',
                    fontSize: 11, fontWeight: 700, color: labelColor, textTransform: 'uppercase', letterSpacing: '0.08em',
                    borderRadius: 6, border: `1px solid ${labelBorder}`,
                  }}>
                    {lane.icon} {lane.name}
                  </div>
                </div>
              );
            });
          })()}

          {/* Connection lines */}
          <FlowConnections screens={SCREENS} connections={CONNECTIONS} darkMode={darkMode} hoveredScreen={hoveredScreen} />

          {/* Screen cards */}
          {SCREENS.map(screen => {
            const pos = getScreenPos(screen);
            return (
              <div key={screen.id} data-screen-card
                style={{ position: 'absolute', left: pos.x, top: pos.y }}>
                <MiniPhone
                  screen={screen}
                  darkMode={darkMode}
                  onClick={(e) => { e.stopPropagation(); setSelectedScreen(screen); }}
                  isHovered={hoveredScreen === screen.id}
                  onHover={() => setHoveredScreen(screen.id)}
                  onLeave={() => setHoveredScreen(null)}
                />
              </div>
            );
          })}
        </div>
      </div>

      {/* Minimap */}
      <MiniMap
        viewportX={pan.x}
        viewportY={pan.y - 56}
        zoom={zoom}
        canvasW={canvasW}
        canvasH={canvasH}
        viewW={viewSize.w}
        viewH={viewSize.h}
        onJump={handleMiniMapJump}
        darkMode={darkMode}
      />

      {/* Detail panel */}
      {selectedScreen && (
        <>
          <div onClick={() => setSelectedScreen(null)} style={{ position: 'fixed', inset: 0, zIndex: 65, background: overlayBg }} />
          <DetailPanel screen={selectedScreen} darkMode={darkMode} onClose={() => setSelectedScreen(null)} />
        </>
      )}

      {/* Keyboard hints */}
      <div style={{
        position: 'fixed', bottom: 20, left: 20, display: 'flex', gap: 8, zIndex: 60, opacity: 0.5,
      }}>
        {[
          { key: 'Scroll', label: 'Zoom' },
          { key: 'Drag', label: 'Pan' },
          { key: '0', label: 'Reset' },
          { key: 'Esc', label: 'Close' },
        ].map(h => (
          <div key={h.key} style={{ display: 'flex', alignItems: 'center', gap: 4 }}>
            <span style={{ fontSize: 10, color: hintKeyText, background: hintKeyBg, borderRadius: 4, padding: '2px 6px', fontWeight: 600 }}>{h.key}</span>
            <span style={{ fontSize: 10, color: hintLabel }}>{h.label}</span>
          </div>
        ))}
      </div>
    </div>
  );
};

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>