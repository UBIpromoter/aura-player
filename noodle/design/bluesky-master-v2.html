<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Aura Master — v2</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'Inter', sans-serif;
    overflow-x: hidden;
    transition: background 0.6s ease, color 0.6s ease;
  }

  body.dark { background: #030712; color: #f9fafb; }
  body.light { background: #f9fafb; color: #1f2937; }

  /* ================================================================
     PHONE FRAME
     ================================================================ */

  .phone-outer {
    width: calc(393px + 16px);
    height: calc(852px + 16px);
    border-radius: 55px;
    padding: 8px;
    background: linear-gradient(145deg, #2a2a2e, #1a1a1c);
    box-shadow:
      inset 0 1px 0 rgba(255,255,255,0.06),
      0 0 0 1px rgba(0,0,0,0.3),
      0 20px 60px rgba(0,0,0,0.5),
      0 0 120px rgba(139,92,246,0.04);
    flex-shrink: 0;
    transition: box-shadow 0.6s ease;
  }

  body.light .phone-outer {
    background: linear-gradient(145deg, #d4d4d8, #a1a1aa);
    box-shadow:
      inset 0 1px 0 rgba(255,255,255,0.4),
      0 0 0 1px rgba(0,0,0,0.1),
      0 20px 60px rgba(0,0,0,0.15);
  }

  .phone-inner {
    width: 393px;
    height: 852px;
    border-radius: 44px;
    overflow: hidden;
    position: relative;
    transition: background 0.6s ease;
  }

  body.dark .phone-inner { background: #030712; }
  body.light .phone-inner { background: #f9fafb; }

  .dynamic-island {
    position: absolute;
    top: 12px;
    left: 50%;
    transform: translateX(-50%);
    width: 126px;
    height: 37px;
    border-radius: 20px;
    z-index: 100;
    transition: background 0.6s ease;
  }

  body.dark .dynamic-island { background: #000000; }
  body.light .dynamic-island { background: #1a1a1c; }

  /* ================================================================
     STATUS BAR
     ================================================================ */

  .status-bar {
    position: relative;
    z-index: 90;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 28px 0;
    height: 54px;
    font-size: 14px;
    font-weight: 600;
    letter-spacing: -0.01em;
  }

  .status-icons {
    display: flex;
    align-items: center;
    gap: 5px;
  }

  /* ================================================================
     PHONE SCREEN CONTENT
     ================================================================ */

  .phone-scroll {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    overflow-y: auto;
    overflow-x: hidden;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
  }
  .phone-scroll::-webkit-scrollbar { display: none; }

  /* ================================================================
     NAV HEADER
     ================================================================ */

  .nav-header {
    display: flex;
    align-items: center;
    padding: 4px 20px 8px;
    font-size: 16px;
    font-weight: 500;
    gap: 6px;
    transition: color 0.6s ease;
  }

  .nav-header .back-arrow {
    font-size: 20px;
    opacity: 0.7;
  }

  /* ================================================================
     ORB CONTAINER — sized for phone
     ================================================================ */

  .orb-stage {
    position: relative;
    width: 340px;
    height: 340px;
    margin: 0 auto;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }

  /* ================================================================
     AMBIENT GLOW
     ================================================================ */

  .orb-ambient {
    position: absolute;
    width: 250%;
    height: 250%;
    border-radius: 50%;
    pointer-events: none;
    z-index: 0;
    animation: ambient-breathe 14s ease-in-out infinite;
    transition: background 1.2s ease;
  }

  @keyframes ambient-breathe {
    0%, 100% { transform: scale(0.85); opacity: 0.5; }
    50% { transform: scale(1.05); opacity: 0.8; }
  }

  /* ================================================================
     CORE GLOW — the main orb body
     ================================================================ */

  .orb-core {
    position: absolute;
    width: 300px;
    height: 300px;
    border-radius: 50%;
    z-index: 5;
    animation: core-breathe 10s ease-in-out infinite;
    transition: background 1.2s ease, filter 1.2s ease;
  }

  @keyframes core-breathe {
    0%, 100% { transform: scale(0.96); filter: blur(25px); }
    50% { transform: scale(1.04); filter: blur(28px); }
  }

  /* ================================================================
     INNER GLOW — trait-colored blobs (DISTINCT COLOR ZONES)
     ================================================================ */

  .orb-inner-glow {
    position: absolute;
    width: 300px;
    height: 300px;
    border-radius: 50%;
    z-index: 8;
    overflow: hidden;
    animation: inner-breathe 10s ease-in-out infinite;
  }

  @keyframes inner-breathe {
    0%, 100% { transform: scale(0.97); }
    50% { transform: scale(1.03); }
  }

  .glow-blob {
    position: absolute;
    border-radius: 50%;
    filter: blur(22px);
    pointer-events: none;
    transition: all 1.2s ease;
  }

  /* ================================================================
     CENTER BRIGHT POINT
     ================================================================ */

  .orb-center {
    position: absolute;
    width: 80px;
    height: 80px;
    border-radius: 50%;
    z-index: 12;
    animation: center-pulse 10s ease-in-out infinite;
    transition: background 1.2s ease, box-shadow 1.2s ease;
  }

  @keyframes center-pulse {
    0%, 100% { transform: scale(0.92); opacity: 0.85; }
    50% { transform: scale(1.08); opacity: 1; }
  }

  /* ================================================================
     NEURAL NODE CANVAS
     ================================================================ */

  .node-canvas {
    position: absolute;
    width: 280px;
    height: 280px;
    z-index: 15;
    pointer-events: none;
  }

  /* ================================================================
     ENERGY WAVES — soft organic rings
     ================================================================ */

  .energy-wave {
    position: absolute;
    border-radius: 50%;
    pointer-events: none;
    opacity: 0;
    z-index: 3;
  }

  @keyframes wave-radiate {
    0% { transform: translate(var(--tx-start), var(--ty-start)) scale(0.5); opacity: 0; }
    10% { opacity: var(--wave-peak, 0.25); }
    60% { opacity: calc(var(--wave-peak, 0.25) * 0.2); }
    100% { transform: translate(var(--tx-end), var(--ty-end)) scale(var(--wave-scale, 1.6)); opacity: 0; }
  }

  /* ================================================================
     BACKGROUND STARS
     ================================================================ */

  .star {
    position: absolute;
    border-radius: 50%;
    pointer-events: none;
    z-index: 1;
  }

  @keyframes twinkle1 {
    0%, 100% { opacity: 0.15; }
    50% { opacity: 0.6; }
  }

  @keyframes twinkle2 {
    0%, 100% { opacity: 0.1; }
    40% { opacity: 0.5; }
    80% { opacity: 0.2; }
  }

  @keyframes twinkle3 {
    0%, 100% { opacity: 0.2; }
    30% { opacity: 0.45; }
    70% { opacity: 0.65; }
  }

  /* ================================================================
     SPECTRUM BARS — compact
     ================================================================ */

  .spectrum-bar {
    position: relative;
    height: 3px;
    border-radius: 2px;
    overflow: visible;
  }

  .spectrum-fill {
    height: 100%;
    border-radius: 2px;
    position: relative;
    transition: width 0.8s ease;
  }

  .spectrum-dot {
    position: absolute;
    top: 50%;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    transform: translate(-50%, -50%);
    border: 2px solid;
    transition: left 0.8s ease, background 0.8s ease;
    z-index: 2;
  }

  /* ================================================================
     SUMMARY TEXT GRADIENT
     ================================================================ */

  .summary-gradient {
    background: linear-gradient(135deg, #8b5cf6, #d946ef, #06b6d4);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  body.light .summary-gradient {
    background: linear-gradient(135deg, #7c3aed, #c026d3, #0891b2);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  /* ================================================================
     CONTROLS
     ================================================================ */

  .ctrl-btn {
    padding: 10px 20px;
    border-radius: 12px;
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    border: none;
    letter-spacing: 0.01em;
  }

  .ctrl-btn:active { transform: scale(0.96); }

  .ctrl-primary {
    background: #8b5cf6;
    color: white;
  }
  .ctrl-primary:hover { background: #7c3aed; transform: translateY(-1px); }

  body.dark .ctrl-secondary {
    background: rgba(255,255,255,0.06);
    color: rgba(255,255,255,0.7);
    border: 1px solid rgba(255,255,255,0.08);
  }
  body.dark .ctrl-secondary:hover { background: rgba(255,255,255,0.1); color: white; }

  body.light .ctrl-secondary {
    background: rgba(0,0,0,0.04);
    color: rgba(0,0,0,0.6);
    border: 1px solid rgba(0,0,0,0.08);
  }
  body.light .ctrl-secondary:hover { background: rgba(0,0,0,0.08); color: rgba(0,0,0,0.9); }

  /* ================================================================
     SMOOTH THEME TRANSITIONS
     ================================================================ */

  .theme-transition {
    transition: background 0.6s ease, color 0.6s ease, border-color 0.6s ease, opacity 0.6s ease;
  }

  /* ================================================================
     BLOB DRIFT ANIMATIONS (organic motion)
     ================================================================ */

  @keyframes blobDrift0 {
    0%, 100% { transform: translate(0, 0) scale(1); }
    25% { transform: translate(8px, -6px) scale(1.03); }
    50% { transform: translate(-4px, 10px) scale(0.97); }
    75% { transform: translate(6px, 4px) scale(1.02); }
  }
  @keyframes blobDrift1 {
    0%, 100% { transform: translate(0, 0) scale(1); }
    25% { transform: translate(-10px, 5px) scale(0.98); }
    50% { transform: translate(6px, -8px) scale(1.04); }
    75% { transform: translate(-3px, 7px) scale(1.01); }
  }
  @keyframes blobDrift2 {
    0%, 100% { transform: translate(0, 0) scale(1); }
    25% { transform: translate(5px, 8px) scale(1.02); }
    50% { transform: translate(-7px, -4px) scale(0.96); }
    75% { transform: translate(9px, -6px) scale(1.03); }
  }
  @keyframes blobDrift3 {
    0%, 100% { transform: translate(0, 0) scale(1); }
    25% { transform: translate(-6px, -8px) scale(1.04); }
    50% { transform: translate(8px, 5px) scale(0.98); }
    75% { transform: translate(-5px, 9px) scale(1.01); }
  }
  @keyframes blobDrift4 {
    0%, 100% { transform: translate(0, 0) scale(1); }
    25% { transform: translate(7px, 6px) scale(0.97); }
    50% { transform: translate(-9px, -3px) scale(1.03); }
    75% { transform: translate(4px, -7px) scale(1.0); }
  }
</style>
</head>
<body class="dark min-h-screen flex flex-col items-center justify-center" style="min-height: 100vh;">

  <!-- PAGE LAYOUT: phone centered + controls below -->
  <div class="flex flex-col items-center gap-6 py-8">

    <!-- PHONE FRAME -->
    <div class="phone-outer">
      <div class="phone-inner" id="phone-inner">

        <!-- Dynamic Island -->
        <div class="dynamic-island"></div>

        <!-- Stars background layer -->
        <div id="stars-container" style="position:absolute;inset:0;z-index:1;pointer-events:none;border-radius:44px;overflow:hidden;"></div>

        <!-- Scrollable content -->
        <div class="phone-scroll" id="phone-scroll">

          <!-- Status Bar -->
          <div class="status-bar" id="status-bar">
            <span>9:41</span>
            <div class="status-icons">
              <!-- Signal bars -->
              <svg width="17" height="12" viewBox="0 0 17 12" fill="none">
                <rect x="0" y="9" width="3" height="3" rx="0.5" fill="currentColor" opacity="1"/>
                <rect x="4.5" y="6" width="3" height="6" rx="0.5" fill="currentColor" opacity="1"/>
                <rect x="9" y="3" width="3" height="9" rx="0.5" fill="currentColor" opacity="1"/>
                <rect x="13.5" y="0" width="3" height="12" rx="0.5" fill="currentColor" opacity="0.3"/>
              </svg>
              <!-- WiFi -->
              <svg width="16" height="12" viewBox="0 0 16 12" fill="none">
                <path d="M8 11.5a1.25 1.25 0 100-2.5 1.25 1.25 0 000 2.5z" fill="currentColor"/>
                <path d="M4.93 7.76a4.5 4.5 0 016.14 0" stroke="currentColor" stroke-width="1.2" stroke-linecap="round"/>
                <path d="M2.4 5.23a8 8 0 0111.2 0" stroke="currentColor" stroke-width="1.2" stroke-linecap="round"/>
              </svg>
              <!-- Battery -->
              <svg width="27" height="12" viewBox="0 0 27 12" fill="none">
                <rect x="0.5" y="0.5" width="22" height="11" rx="2.5" stroke="currentColor" opacity="0.35" stroke-width="1"/>
                <rect x="23.5" y="3.5" width="2" height="5" rx="1" fill="currentColor" opacity="0.35"/>
                <rect x="2" y="2" width="17" height="8" rx="1.5" fill="currentColor" opacity="0.9"/>
              </svg>
            </div>
          </div>

          <!-- Navigation header -->
          <div class="nav-header" id="nav-header">
            <span class="back-arrow">&larr;</span>
            <span>Analysis</span>
          </div>

          <!-- ORB VISUALIZATION -->
          <div class="orb-stage" id="orb-stage">
            <div class="orb-ambient" id="orb-ambient"></div>
            <div class="orb-core" id="orb-core"></div>
            <div class="orb-inner-glow" id="orb-inner-glow"></div>
            <div class="orb-center" id="orb-center"></div>
            <svg class="node-canvas" id="node-canvas" viewBox="0 0 280 280"></svg>
          </div>

          <!-- Below-orb content -->
          <div class="w-full flex flex-col gap-3 px-6 pb-6" id="below-orb">

            <!-- Summary line -->
            <p class="text-center text-[13px] font-medium summary-gradient leading-relaxed mt-[-4px]" id="summary-text">
              Your aura blends curiosity, empathy, and drive
            </p>

            <!-- Trait spectrums -->
            <div class="flex flex-col gap-[10px] mt-1" id="trait-spectrums"></div>

          </div>

        </div><!-- end phone-scroll -->

      </div>
    </div>

    <!-- CONTROLS (outside phone) -->
    <div class="flex gap-3 justify-center">
      <button onclick="shuffleProfile()" class="ctrl-btn ctrl-primary">Shuffle Profile</button>
      <button onclick="toggleTheme()" class="ctrl-btn ctrl-secondary" id="theme-btn">Light Mode</button>
    </div>

  </div>

<script>
// =====================================================================
// AURA MASTER v2 — Ship Candidate
// =====================================================================

// -- Color tokens (from TOKENS.md) ------------------------------------
const COLORS = {
  violet:  '#8b5cf6',
  blue:    '#3b82f6',
  emerald: '#10b981',
  pink:    '#d946ef',
  cyan:    '#06b6d4',
  teal:    '#14b8a6',
  amber:   '#f59e0b',
  rose:    '#f43f5e',
};

// -- Trait data --------------------------------------------------------
let traits = {
  openness:  { score: 78, color: COLORS.violet,  lowLabel: 'Practical',  highLabel: 'Curious',    direction: { angle: 315, label: 'Curious' } },
  warmth:    { score: 85, color: COLORS.emerald,  lowLabel: 'Direct',     highLabel: 'Empathetic', direction: { angle: 150, label: 'Empathetic' } },
  energy:    { score: 65, color: COLORS.pink,     lowLabel: 'Reserved',   highLabel: 'Outgoing',   direction: { angle: 45,  label: 'Social' } },
  stability: { score: 42, color: COLORS.blue,     lowLabel: 'Sensitive',  highLabel: 'Steady',     direction: { angle: 210, label: 'Sensitive' } },
  drive:     { score: 71, color: COLORS.cyan,     lowLabel: 'Flexible',   highLabel: 'Organized',  direction: { angle: 270, label: 'Organized' } },
};

let isDark = true;

// -- Helpers -----------------------------------------------------------
function hexToRgb(hex) {
  const r = parseInt(hex.slice(1, 3), 16);
  const g = parseInt(hex.slice(3, 5), 16);
  const b = parseInt(hex.slice(5, 7), 16);
  return { r, g, b };
}

function rgba(hex, alpha) {
  const { r, g, b } = hexToRgb(hex);
  return `rgba(${r}, ${g}, ${b}, ${alpha})`;
}

function topTraits() {
  return Object.entries(traits)
    .sort((a, b) => b[1].score - a[1].score)
    .map(([key, val]) => ({ key, ...val }));
}

// =====================================================================
// BACKGROUND STARS
// =====================================================================

function initStars() {
  const container = document.getElementById('stars-container');
  container.innerHTML = '';

  const starCount = 25;
  for (let i = 0; i < starCount; i++) {
    const star = document.createElement('div');
    star.className = 'star';

    const size = 1 + Math.random() * 1.2;
    const x = 15 + Math.random() * (393 - 30);
    const y = 60 + Math.random() * (852 - 120);

    const animName = `twinkle${1 + Math.floor(Math.random() * 3)}`;
    const duration = 3 + Math.random() * 5;
    const delay = Math.random() * 6;

    const starColor = isDark ? 'rgba(255,255,255,0.35)' : 'rgba(0,0,0,0.08)';

    star.style.cssText = `
      left: ${x}px;
      top: ${y}px;
      width: ${size}px;
      height: ${size}px;
      background: ${starColor};
      animation: ${animName} ${duration}s ease-in-out ${delay}s infinite;
    `;

    container.appendChild(star);
  }
}

// =====================================================================
// ORB RENDERING — DISTINCT COLOR ZONES
// =====================================================================

function renderOrb() {
  const sorted = topTraits();
  const top3 = sorted.slice(0, 3);
  const darkMul = isDark ? 1 : 0.45;

  // -- Ambient halo --
  const amb = document.getElementById('orb-ambient');
  amb.style.background = `radial-gradient(circle,
    ${rgba(top3[0].color, 0.1 * darkMul)} 0%,
    ${rgba(top3[1].color, 0.05 * darkMul)} 30%,
    ${rgba(top3[0].color, 0.02 * darkMul)} 50%,
    transparent 65%
  )`;

  // -- Core glow body --
  const core = document.getElementById('orb-core');
  const coreOp = isDark ? 0.4 : 0.25;
  const coreEdge = isDark ? 0.06 : 0.03;
  core.style.background = `radial-gradient(circle,
    ${rgba(top3[0].color, coreOp * 0.5)} 0%,
    ${rgba(top3[1].color, coreOp * 0.35)} 30%,
    ${rgba(top3[2].color, coreOp * 0.25)} 55%,
    ${rgba(top3[0].color, coreEdge)} 80%,
    transparent 95%
  )`;

  // -- Inner glow blobs: DISTINCT color zones --
  const innerGlow = document.getElementById('orb-inner-glow');
  innerGlow.innerHTML = '';

  // Spread angles further apart for distinct zones
  // Each blob gets its own quadrant/sector of the orb
  const blobAngles = [315, 150, 45, 210, 270]; // matches trait direction angles

  sorted.forEach((t, i) => {
    const blob = document.createElement('div');
    blob.className = 'glow-blob';

    const angle = t.direction.angle * (Math.PI / 180);
    // Push blobs further from center for clear zone separation
    const dist = 70 + (i * 10);
    const centerX = 150; // half of 300px container
    const centerY = 150;
    const cx = centerX + Math.cos(angle) * dist - 85;
    const cy = centerY + Math.sin(angle) * dist - 75;

    // Bigger blobs with higher saturation for distinct zones
    const size = 160 + (t.score / 100) * 40;
    const blobOpacity = isDark
      ? 0.55 + (t.score / 100) * 0.25
      : 0.35 + (t.score / 100) * 0.2;

    blob.style.cssText = `
      left: ${cx}px; top: ${cy}px;
      width: ${size}px; height: ${size * 0.85}px;
      background: ${t.color};
      opacity: ${blobOpacity};
      animation: blobDrift${i % 5} ${12 + i * 2}s ease-in-out infinite;
    `;

    innerGlow.appendChild(blob);
  });

  // -- Center bright point --
  const center = document.getElementById('orb-center');
  if (isDark) {
    center.style.background = `radial-gradient(circle,
      rgba(255, 255, 255, 0.9) 0%,
      rgba(255, 255, 255, 0.5) 25%,
      ${rgba(top3[0].color, 0.35)} 55%,
      ${rgba(top3[1].color, 0.12)} 80%,
      transparent 100%
    )`;
    center.style.boxShadow = `
      0 0 30px rgba(255,255,255,0.35),
      0 0 60px ${rgba(top3[0].color, 0.4)},
      0 0 100px ${rgba(top3[1].color, 0.25)}
    `;
  } else {
    center.style.background = `radial-gradient(circle,
      rgba(255, 255, 255, 1) 0%,
      rgba(255, 255, 255, 0.8) 30%,
      ${rgba(top3[0].color, 0.2)} 60%,
      ${rgba(top3[1].color, 0.08)} 80%,
      transparent 100%
    )`;
    center.style.boxShadow = `
      0 0 25px rgba(255,255,255,0.4),
      0 0 50px ${rgba(top3[0].color, 0.2)},
      0 0 80px ${rgba(top3[1].color, 0.1)}
    `;
  }
}

// =====================================================================
// NEURAL NODES — whisper-thin connections
// =====================================================================

let nodeState = [];
let animFrame = null;

function initNodes() {
  const cx = 140, cy = 140;
  nodeState = [];

  Object.entries(traits).forEach(([key, t]) => {
    const count = Math.max(2, Math.round((t.score / 100) * 3));
    const baseAngle = t.direction.angle;

    for (let i = 0; i < count; i++) {
      const angleOffset = (i - count / 2) * 28 + (Math.random() - 0.5) * 25;
      const angle = (baseAngle + angleOffset) * (Math.PI / 180);
      const dist = 40 + Math.random() * 65;

      const x = cx + Math.cos(angle) * dist;
      const y = cy + Math.sin(angle) * dist;

      const baseR = 1.8 + (t.score / 100) * 2.5;
      const r = baseR + Math.random() * 1;

      nodeState.push({
        trait: key,
        color: t.color,
        x, y,
        baseX: x, baseY: y,
        r,
        phaseX: Math.random() * Math.PI * 2,
        phaseY: Math.random() * Math.PI * 2,
        speedX: 0.25 + Math.random() * 0.35,
        speedY: 0.2 + Math.random() * 0.3,
        ampX: 1.2 + Math.random() * 2,
        ampY: 1 + Math.random() * 2,
      });
    }
  });
}

function renderNodes(time) {
  const svg = document.getElementById('node-canvas');
  const lineOpacity = isDark ? 0.07 : 0.05;

  nodeState.forEach(n => {
    n.x = n.baseX + Math.sin(time * n.speedX + n.phaseX) * n.ampX;
    n.y = n.baseY + Math.cos(time * n.speedY + n.phaseY) * n.ampY;
  });

  let html = '';

  // Whisper-thin connection lines
  for (let i = 0; i < nodeState.length; i++) {
    for (let j = i + 1; j < nodeState.length; j++) {
      const a = nodeState[i];
      const b = nodeState[j];
      const dx = a.x - b.x;
      const dy = a.y - b.y;
      const dist = Math.sqrt(dx * dx + dy * dy);

      if (dist < 65) {
        const opacity = (1 - dist / 65) * lineOpacity;
        const strokeColor = isDark
          ? `rgba(255,255,255,${opacity})`
          : `rgba(0,0,0,${opacity})`;
        html += `<line x1="${a.x}" y1="${a.y}" x2="${b.x}" y2="${b.y}"
          stroke="${strokeColor}" stroke-width="0.5" stroke-linecap="round"/>`;
      }
    }
  }

  // Nodes with soft glow
  nodeState.forEach(n => {
    const glowOp = isDark ? 0.15 : 0.1;
    html += `<circle cx="${n.x}" cy="${n.y}" r="${n.r * 2}" fill="${rgba(n.color, glowOp)}" />`;
    html += `<circle cx="${n.x}" cy="${n.y}" r="${n.r}" fill="${n.color}" opacity="${isDark ? 0.75 : 0.6}" />`;
  });

  svg.innerHTML = html;
}

function animate(timestamp) {
  const time = timestamp * 0.001;
  renderNodes(time);
  animFrame = requestAnimationFrame(animate);
}

// =====================================================================
// ENERGY WAVES — very soft, organic
// =====================================================================

const stage = document.getElementById('orb-stage');
let waveInterval = null;

function spawnWaveSet() {
  const sorted = topTraits();
  const active = sorted.filter(t => t.score > 40);

  active.forEach((t, i) => {
    setTimeout(() => createDirectionalWave(t), i * 700);
  });
}

function createDirectionalWave(t) {
  const wave = document.createElement('div');
  wave.className = 'energy-wave';

  const size = 260;
  wave.style.width = `${size}px`;
  wave.style.height = `${size}px`;

  const angle = t.direction.angle * (Math.PI / 180);
  const endDist = 50 + (t.score / 100) * 40;

  const txStart = 0;
  const tyStart = 0;
  const txEnd = Math.cos(angle) * endDist;
  const tyEnd = Math.sin(angle) * endDist;

  const peakOpacity = isDark
    ? 0.08 + (t.score / 100) * 0.12
    : 0.04 + (t.score / 100) * 0.08;

  const scaleMax = 1.2 + (t.score / 100) * 0.5;
  const duration = 9 + Math.random() * 4;

  wave.style.setProperty('--tx-start', `${txStart}px`);
  wave.style.setProperty('--ty-start', `${tyStart}px`);
  wave.style.setProperty('--tx-end', `${txEnd}px`);
  wave.style.setProperty('--ty-end', `${tyEnd}px`);
  wave.style.setProperty('--wave-peak', peakOpacity);
  wave.style.setProperty('--wave-scale', scaleMax);

  // Softer wave rings — more blur, less sharp
  const thickness = 1.5 + (t.score / 100) * 2;
  const blur = 12 + (t.score / 100) * 14;

  wave.style.boxShadow = `
    inset 0 0 0 ${thickness}px ${rgba(t.color, 0.35)},
    inset 0 0 ${blur * 2}px ${thickness * 2}px ${rgba(t.color, 0.1)},
    0 0 ${blur}px ${thickness}px ${rgba(t.color, 0.06)}
  `;
  wave.style.filter = `blur(${blur / 2}px)`;
  wave.style.animation = `wave-radiate ${duration}s ease-out forwards`;

  stage.appendChild(wave);
  setTimeout(() => wave.remove(), duration * 1000 + 200);
}

function startWaves() {
  spawnWaveSet();
  waveInterval = setInterval(spawnWaveSet, 7000);
}

function stopWaves() {
  if (waveInterval) clearInterval(waveInterval);
  stage.querySelectorAll('.energy-wave').forEach(w => w.remove());
}

// =====================================================================
// TRAIT SPECTRUM BARS — compact
// =====================================================================

function renderSpectrums() {
  const container = document.getElementById('trait-spectrums');
  const sorted = topTraits().slice(0, 5);

  const darkBg = 'rgba(255,255,255,0.05)';
  const lightBg = 'rgba(0,0,0,0.06)';
  const trackBg = isDark ? darkBg : lightBg;

  let html = '';

  sorted.forEach(t => {
    const labelDim = isDark ? 'rgba(255,255,255,0.35)' : 'rgba(0,0,0,0.35)';
    const labelBright = isDark ? 'rgba(255,255,255,0.75)' : 'rgba(0,0,0,0.75)';
    const isHigh = t.score >= 50;
    const dotBorder = isDark ? '#030712' : '#f9fafb';

    html += `
      <div class="flex items-center gap-2.5">
        <span class="text-[10px] w-[58px] text-right font-medium flex-shrink-0 tracking-tight"
              style="color: ${isHigh ? labelDim : labelBright}">
          ${t.lowLabel}
        </span>
        <div class="flex-1 relative">
          <div class="spectrum-bar" style="background: ${trackBg};">
            <div class="spectrum-fill" style="
              width: 100%;
              background: linear-gradient(90deg, ${rgba(t.color, isDark ? 0.1 : 0.06)}, ${rgba(t.color, isDark ? 0.35 : 0.25)});
            "></div>
            <div class="spectrum-dot" style="
              left: ${t.score}%;
              background: ${t.color};
              border-color: ${dotBorder};
              box-shadow: 0 0 6px ${rgba(t.color, 0.5)};
            "></div>
          </div>
        </div>
        <span class="text-[10px] w-[58px] font-medium flex-shrink-0 tracking-tight"
              style="color: ${isHigh ? labelBright : labelDim}">
          ${t.highLabel}
        </span>
      </div>
    `;
  });

  container.innerHTML = html;
}

// =====================================================================
// SUMMARY TEXT
// =====================================================================

function updateSummary() {
  const sorted = topTraits();
  const top3 = sorted.slice(0, 3);
  const labels = top3.map(t => t.score >= 50 ? t.highLabel.toLowerCase() : t.lowLabel.toLowerCase());

  document.getElementById('summary-text').textContent =
    `Your aura blends ${labels[0]}, ${labels[1]}, and ${labels[2]}`;
}

// =====================================================================
// THEME TOGGLE
// =====================================================================

function toggleTheme() {
  isDark = !isDark;
  document.body.className = isDark
    ? 'dark min-h-screen flex flex-col items-center justify-center'
    : 'light min-h-screen flex flex-col items-center justify-center';
  document.getElementById('theme-btn').textContent = isDark ? 'Light Mode' : 'Dark Mode';

  initStars();
  renderAll();
}

// =====================================================================
// SHUFFLE PROFILE
// =====================================================================

function shuffleProfile() {
  const rand = () => {
    const r = Math.random();
    if (r < 0.3) return 15 + Math.random() * 30;
    if (r > 0.7) return 60 + Math.random() * 38;
    return 30 + Math.random() * 40;
  };

  Object.keys(traits).forEach(key => {
    traits[key].score = Math.round(rand());
  });

  stopWaves();
  if (animFrame) cancelAnimationFrame(animFrame);

  initNodes();
  renderAll();
  animFrame = requestAnimationFrame(animate);
  startWaves();
}

// =====================================================================
// MASTER RENDER
// =====================================================================

function renderAll() {
  renderOrb();
  renderSpectrums();
  updateSummary();
}

// =====================================================================
// INITIALIZATION
// =====================================================================

initStars();
initNodes();
renderAll();
animFrame = requestAnimationFrame(animate);
startWaves();

document.addEventListener('visibilitychange', () => {
  if (document.hidden) {
    if (animFrame) cancelAnimationFrame(animFrame);
    stopWaves();
  } else {
    animFrame = requestAnimationFrame(animate);
    startWaves();
  }
});

</script>
</body>
</html>
