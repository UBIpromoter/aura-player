<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Weather System V3 â€” Teaching Edition</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
  body { font-family: 'Inter', sans-serif; }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SKY CANVAS
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

  .sky-canvas {
    position: relative;
    overflow: hidden;
    border-radius: 16px;
  }

  .sky-layer {
    position: absolute;
    inset: 0;
    pointer-events: none;
    transition: background 0.8s ease;
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MODE TABS â€” Stolen from Breath (the key teaching innovation)
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

  .mode-tabs {
    display: flex;
    background: rgba(255,255,255,0.06);
    border-radius: 10px;
    padding: 3px;
    gap: 2px;
  }

  .mode-tab {
    flex: 1;
    padding: 8px 10px;
    border-radius: 8px;
    font-size: 10px;
    font-weight: 600;
    color: rgba(255,255,255,0.4);
    cursor: pointer;
    transition: all 0.2s ease;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    text-align: center;
  }

  .mode-tab:hover {
    color: rgba(255,255,255,0.6);
    background: rgba(255,255,255,0.04);
  }

  .mode-tab.active {
    background: rgba(255,255,255,0.1);
    color: white;
  }

  .mode-tab.active[data-mode="openness"] { background: rgba(96,165,250,0.25); color: #60a5fa; }
  .mode-tab.active[data-mode="warmth"] { background: rgba(251,191,36,0.25); color: #fbbf24; }
  .mode-tab.active[data-mode="energy"] { background: rgba(34,211,238,0.25); color: #22d3ee; }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     TEACHING OVERLAY â€” Appears when isolating a single trait
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

  .teaching-overlay {
    position: absolute;
    inset: 0;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.4s ease;
    z-index: 60;
  }

  .teaching-overlay.visible {
    opacity: 1;
  }

  .teaching-callout {
    position: absolute;
    background: rgba(0, 0, 0, 0.85);
    backdrop-filter: blur(12px);
    border-radius: 10px;
    padding: 10px 14px;
    font-size: 11px;
    line-height: 1.5;
    max-width: 140px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
  }

  .teaching-callout .title {
    font-weight: 700;
    margin-bottom: 4px;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    font-size: 9px;
  }

  .teaching-callout .value {
    font-size: 18px;
    font-weight: 700;
    margin-bottom: 4px;
  }

  .teaching-callout .desc {
    color: rgba(255, 255, 255, 0.7);
  }

  .teaching-callout .pointer-line {
    position: absolute;
    height: 2px;
    background: currentColor;
    opacity: 0.5;
  }

  /* Callout positions */
  .callout-openness {
    top: 20px;
    left: 20px;
    border: 1px solid rgba(96, 165, 250, 0.4);
    color: #60a5fa;
  }

  .callout-warmth {
    top: 10px;
    right: 20px;
    border: 1px solid rgba(251, 191, 36, 0.4);
    color: #fbbf24;
  }

  .callout-energy {
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    border: 1px solid rgba(34, 211, 238, 0.4);
    color: #22d3ee;
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     COMPARISON PANEL â€” Stolen from Constellation
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

  .comparison-panel {
    display: flex;
    gap: 8px;
    margin-top: 8px;
    padding: 10px;
    background: rgba(0, 0, 0, 0.3);
    border-radius: 12px;
    border: 1px solid rgba(255, 255, 255, 0.06);
  }

  .comparison-column {
    flex: 1;
    text-align: center;
  }

  .comparison-label {
    font-size: 9px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: rgba(255, 255, 255, 0.4);
    margin-bottom: 4px;
  }

  .comparison-label.you { color: rgba(96, 165, 250, 0.8); }
  .comparison-label.avg { color: rgba(148, 163, 184, 0.6); }

  .comparison-sky {
    height: 80px;
    border-radius: 10px;
    overflow: hidden;
    position: relative;
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     WEATHER ELEMENTS
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

  .cloud {
    position: absolute;
    border-radius: 50%;
    filter: blur(12px);
    mix-blend-mode: screen;
    animation: cloudDrift ease-in-out infinite;
    pointer-events: none;
  }

  @keyframes cloudDrift {
    0%, 100% { transform: translateX(0) translateY(0) scale(1); }
    33% { transform: translateX(8px) translateY(-4px) scale(1.02); }
    66% { transform: translateX(-5px) translateY(2px) scale(0.98); }
  }

  .light-ray {
    position: absolute;
    background: linear-gradient(to bottom, var(--ray-color) 0%, transparent 100%);
    transform-origin: top center;
    opacity: 0;
    filter: blur(3px);
    animation: rayPulse ease-in-out infinite;
    pointer-events: none;
  }

  @keyframes rayPulse {
    0%, 100% { opacity: 0.25; }
    50% { opacity: 0.55; }
  }

  .mote {
    position: absolute;
    border-radius: 50%;
    pointer-events: none;
    animation: moteFloat ease-in-out infinite;
    box-shadow: 0 0 6px currentColor;
  }

  @keyframes moteFloat {
    0% { transform: translate(0, 0) scale(1); opacity: var(--start-opacity); }
    25% { transform: translate(var(--drift-x), var(--drift-y1)) scale(1.2); opacity: var(--mid-opacity); }
    50% { transform: translate(calc(var(--drift-x) * 0.5), var(--drift-y2)) scale(0.85); opacity: var(--end-opacity); }
    75% { transform: translate(calc(var(--drift-x) * -0.3), var(--drift-y1)) scale(1.15); opacity: var(--mid-opacity); }
    100% { transform: translate(0, 0) scale(1); opacity: var(--start-opacity); }
  }

  .star {
    position: absolute;
    border-radius: 50%;
    background: white;
    animation: starTwinkle ease-in-out infinite;
    pointer-events: none;
  }

  @keyframes starTwinkle {
    0%, 100% { opacity: 0.2; transform: scale(1); }
    50% { opacity: 0.8; transform: scale(1.3); }
  }

  .celestial {
    position: absolute;
    border-radius: 50%;
    filter: blur(20px);
    pointer-events: none;
    transition: all 0.8s ease;
  }

  .celestial-core {
    position: absolute;
    border-radius: 50%;
    filter: blur(2px);
    pointer-events: none;
    transition: all 0.8s ease;
  }

  .horizon-mist {
    position: absolute;
    bottom: 0;
    left: -20%;
    right: -20%;
    height: 70%;
    filter: blur(8px);
    opacity: 0.6;
    pointer-events: none;
    transition: all 0.8s ease;
  }

  .shimmer-layer {
    position: absolute;
    inset: 0;
    background: linear-gradient(
      135deg,
      transparent 0%,
      rgba(255,255,255,0.02) 25%,
      transparent 50%,
      rgba(255,255,255,0.02) 75%,
      transparent 100%
    );
    background-size: 200% 200%;
    animation: shimmerMove 8s ease-in-out infinite;
    pointer-events: none;
  }

  @keyframes shimmerMove {
    0% { background-position: 0% 0%; }
    50% { background-position: 100% 100%; }
    100% { background-position: 0% 0%; }
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     LEGEND â€” Teaching-focused with dimming
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

  .legend-card {
    background: rgba(0, 0, 0, 0.4);
    backdrop-filter: blur(12px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 14px;
    padding: 14px;
  }

  .legend-item {
    display: flex;
    align-items: flex-start;
    gap: 10px;
    padding: 10px 0;
    border-bottom: 1px solid rgba(255, 255, 255, 0.06);
    transition: opacity 0.3s ease, filter 0.3s ease;
  }

  .legend-item:last-child { border-bottom: none; padding-bottom: 0; }
  .legend-item:first-child { padding-top: 0; }

  .legend-item.dimmed {
    opacity: 0.25;
    filter: grayscale(0.6);
  }

  .legend-item.highlighted {
    background: rgba(255, 255, 255, 0.03);
    margin: 0 -8px;
    padding-left: 8px;
    padding-right: 8px;
    border-radius: 8px;
  }

  .legend-icon {
    width: 32px;
    height: 32px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    font-size: 16px;
  }

  .legend-content { flex: 1; min-width: 0; }

  .legend-trait-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2px;
  }

  .legend-trait-name {
    font-size: 12px;
    font-weight: 600;
    color: white;
  }

  .legend-percent {
    font-size: 13px;
    font-weight: 700;
    font-variant-numeric: tabular-nums;
  }

  .legend-state {
    font-size: 10px;
    color: rgba(255, 255, 255, 0.6);
  }

  .trait-bar {
    height: 4px;
    border-radius: 2px;
    background: rgba(255, 255, 255, 0.1);
    margin-top: 6px;
    overflow: hidden;
    position: relative;
  }

  .trait-bar-fill {
    height: 100%;
    border-radius: 2px;
    transition: width 0.5s ease;
  }

  .trait-bar-average {
    position: absolute;
    top: 0;
    bottom: 0;
    width: 2px;
    left: 50%;
    background: rgba(255, 255, 255, 0.4);
    border-radius: 1px;
  }

  .legend-mapping {
    font-size: 9px;
    color: rgba(255, 255, 255, 0.35);
    margin-top: 4px;
    line-height: 1.4;
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     WEATHER NAME â€” Stolen from Constellation
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

  .weather-name {
    text-align: center;
    padding: 2px 0;
  }

  .weather-name-label {
    font-size: 9px;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    color: rgba(255, 255, 255, 0.35);
  }

  .weather-name-value {
    font-size: 13px;
    font-weight: 600;
    color: rgba(255, 255, 255, 0.85);
    margin-top: 2px;
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     POETIC NARRATION
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

  .poetic-narration {
    font-style: italic;
    line-height: 1.6;
    letter-spacing: 0.01em;
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     HOW TO READ â€” Collapsible guide (from Constellation)
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

  .guide-toggle {
    display: flex;
    align-items: center;
    justify-content: space-between;
    width: 100%;
    padding: 8px 12px;
    background: rgba(59, 130, 246, 0.08);
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .guide-toggle:hover {
    background: rgba(59, 130, 246, 0.12);
  }

  .guide-toggle-text {
    font-size: 10px;
    font-weight: 600;
    color: rgba(148, 163, 184, 0.9);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .guide-toggle-arrow {
    font-size: 10px;
    color: rgba(148, 163, 184, 0.6);
    transition: transform 0.3s ease;
  }

  .guide-toggle-arrow.expanded { transform: rotate(180deg); }

  .guide-panel {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease, opacity 0.3s ease, margin-top 0.3s ease;
    opacity: 0;
  }

  .guide-panel.expanded {
    max-height: 300px;
    opacity: 1;
    margin-top: 10px;
  }

  .guide-content {
    background: rgba(0, 0, 0, 0.3);
    border-radius: 10px;
    padding: 12px;
    font-size: 10px;
    line-height: 1.6;
    color: rgba(255, 255, 255, 0.7);
  }

  .guide-content h4 {
    font-size: 10px;
    font-weight: 700;
    color: rgba(96, 165, 250, 0.9);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 8px;
  }

  .guide-row {
    display: flex;
    align-items: flex-start;
    gap: 10px;
    margin-bottom: 8px;
  }

  .guide-row:last-child { margin-bottom: 0; }

  .guide-icon {
    width: 24px;
    height: 24px;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    flex-shrink: 0;
  }

  .guide-icon.openness { background: rgba(96, 165, 250, 0.2); }
  .guide-icon.warmth { background: rgba(251, 191, 36, 0.2); }
  .guide-icon.energy { background: rgba(34, 211, 238, 0.2); }

  .guide-text strong {
    color: white;
    font-weight: 600;
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MISC
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

  .toggle-btn {
    transition: all 0.2s ease;
  }
  .toggle-btn.active {
    background: rgba(59, 130, 246, 0.3) !important;
    border-color: rgba(59, 130, 246, 0.6) !important;
  }
</style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-8 gap-6" style="background: #08080c;">

  <!-- Controls -->
  <div class="flex gap-3 items-center flex-wrap justify-center">
    <button onclick="setTheme('dark')" id="btn-dark" class="px-4 py-2 rounded-xl text-sm font-medium bg-gray-800 text-white border-2 border-blue-500">Dark</button>
    <button onclick="setTheme('light')" id="btn-light" class="px-4 py-2 rounded-xl text-sm font-medium bg-white text-gray-800 border-2 border-gray-300">Light</button>
    <div class="w-px h-6 bg-gray-600"></div>
    <button onclick="randomize()" class="px-4 py-2 rounded-xl text-sm font-medium bg-blue-600 text-white hover:bg-blue-500 transition-colors">Shuffle</button>
    <button onclick="toggleComparison()" id="btn-compare" class="toggle-btn px-4 py-2 rounded-xl text-sm font-medium bg-gray-800 text-white border-2 border-gray-600">Show Average</button>
  </div>

  <!-- Phone frame -->
  <div id="phone" class="w-[375px] rounded-[2.5rem] overflow-hidden shadow-2xl" style="background: #0a0a12; border: 2px solid #151520;">
    <div class="p-5 pt-8 pb-6">

      <!-- Weather Card -->
      <div id="card" class="rounded-2xl overflow-hidden" style="background: rgba(12, 12, 22, 0.85); border: 1px solid rgba(59, 130, 246, 0.2);">

        <!-- Header with Weather Name -->
        <div class="p-4 pb-2">
          <div class="weather-name">
            <div class="weather-name-label">Your Inner Weather</div>
            <div id="weather-name-value" class="weather-name-value">Golden Clarity</div>
          </div>
        </div>

        <!-- MODE TABS â€” The Key Teaching Innovation -->
        <div class="px-4 pb-3">
          <div class="mode-tabs" id="mode-tabs">
            <div class="mode-tab active" data-mode="all" onclick="setViewMode('all')">All</div>
            <div class="mode-tab" data-mode="openness" onclick="setViewMode('openness')">Sky</div>
            <div class="mode-tab" data-mode="warmth" onclick="setViewMode('warmth')">Light</div>
            <div class="mode-tab" data-mode="energy" onclick="setViewMode('energy')">Motion</div>
          </div>
        </div>

        <!-- Weather Visualization -->
        <div class="px-4 py-2">
          <div id="sky" class="sky-canvas w-full h-48 relative rounded-2xl overflow-hidden">
            <!-- Dynamic content injected here -->

            <!-- Teaching Overlay (shown when isolating single trait) -->
            <div id="teaching-overlay" class="teaching-overlay">
              <!-- Dynamically positioned callouts -->
            </div>
          </div>
        </div>

        <!-- Comparison Panel (hidden by default) -->
        <div id="comparison-panel" class="px-4 hidden">
          <div class="comparison-panel">
            <div class="comparison-column">
              <div class="comparison-label you">Your Weather</div>
              <div id="comparison-yours" class="comparison-sky"></div>
            </div>
            <div class="comparison-column">
              <div class="comparison-label avg">Average</div>
              <div id="comparison-avg" class="comparison-sky"></div>
            </div>
          </div>
        </div>

        <!-- Poetic Narration -->
        <div class="px-5 py-3 text-center">
          <p id="poetic-narration" class="poetic-narration text-sm text-gray-300 leading-relaxed"></p>
        </div>

        <!-- Trait Legend -->
        <div id="trait-legend" class="px-4 pb-3">
          <div class="legend-card">
            <div class="legend-item" id="legend-openness">
              <div class="legend-icon bg-blue-500/20">
                <span id="legend-emoji-1">â˜€ï¸</span>
              </div>
              <div class="legend-content">
                <div class="legend-trait-row">
                  <span class="legend-trait-name">Openness</span>
                  <span id="legend-percent-1" class="legend-percent text-blue-400">72%</span>
                </div>
                <div id="legend-state-1" class="legend-state">Clear skies</div>
                <div class="trait-bar">
                  <div class="trait-bar-average"></div>
                  <div id="legend-bar-1" class="trait-bar-fill bg-blue-400" style="width: 72%"></div>
                </div>
                <div class="legend-mapping">Cloudiness = reflective depth, Clarity = outward focus</div>
              </div>
            </div>

            <div class="legend-item" id="legend-warmth">
              <div class="legend-icon bg-amber-500/20">
                <span id="legend-emoji-2">ğŸŒ…</span>
              </div>
              <div class="legend-content">
                <div class="legend-trait-row">
                  <span class="legend-trait-name">Warmth</span>
                  <span id="legend-percent-2" class="legend-percent text-amber-400">78%</span>
                </div>
                <div id="legend-state-2" class="legend-state">Golden light</div>
                <div class="trait-bar">
                  <div class="trait-bar-average"></div>
                  <div id="legend-bar-2" class="trait-bar-fill bg-amber-400" style="width: 78%"></div>
                </div>
                <div class="legend-mapping">Cool = analytical precision, Warm = empathetic connection</div>
              </div>
            </div>

            <div class="legend-item" id="legend-energy">
              <div class="legend-icon bg-cyan-500/20">
                <span id="legend-emoji-3">ğŸƒ</span>
              </div>
              <div class="legend-content">
                <div class="legend-trait-row">
                  <span class="legend-trait-name">Energy</span>
                  <span id="legend-percent-3" class="legend-percent text-cyan-400">65%</span>
                </div>
                <div id="legend-state-3" class="legend-state">Breezy</div>
                <div class="trait-bar">
                  <div class="trait-bar-average"></div>
                  <div id="legend-bar-3" class="trait-bar-fill bg-cyan-400" style="width: 65%"></div>
                </div>
                <div class="legend-mapping">Stillness = grounded presence, Motion = dynamic energy</div>
              </div>
            </div>
          </div>
        </div>

        <!-- How to Read Guide (Collapsible) -->
        <div class="px-4 pb-3">
          <button class="guide-toggle" onclick="toggleGuide()">
            <span class="guide-toggle-text">How to read your weather</span>
            <span id="guide-arrow" class="guide-toggle-arrow">â–¼</span>
          </button>
          <div id="guide-panel" class="guide-panel">
            <div class="guide-content">
              <h4>The Three Elements</h4>
              <div class="guide-row">
                <div class="guide-icon openness">â˜ï¸</div>
                <div class="guide-text">
                  <strong>Sky clarity</strong> = Openness. Clear skies mean you face outward, engaging the world. Clouds suggest rich inner depths.
                </div>
              </div>
              <div class="guide-row">
                <div class="guide-icon warmth">ğŸŒ</div>
                <div class="guide-text">
                  <strong>Light color</strong> = Warmth. Golden tones show empathy-first nature. Cool blues indicate analytical precision.
                </div>
              </div>
              <div class="guide-row">
                <div class="guide-icon energy">âœ¨</div>
                <div class="guide-text">
                  <strong>Particle motion</strong> = Energy. Lively particles mean dynamic activity. Stillness shows grounded presence.
                </div>
              </div>
              <div class="mt-3 pt-3 border-t border-white/10">
                <strong class="text-blue-300">Tip:</strong> Use the tabs above to isolate each element and see exactly what it controls.
              </div>
            </div>
          </div>
        </div>

        <!-- CTA -->
        <div class="px-4 pb-4 pt-1">
          <div id="cta" class="p-3 rounded-xl text-center" style="background: rgba(59, 130, 246, 0.12);">
            <div id="cta-sub" class="text-xs text-gray-400">Based on 10 questions</div>
            <div id="cta-main" class="text-sm font-medium mt-1 text-blue-300">Starter Pack adds clarity with 40 more &#8594;</div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- Desktop hint -->
  <div class="max-w-md text-center text-gray-500 text-xs mt-2">
    <p><strong class="text-gray-400">V3 Features:</strong> Mode tabs isolate single traits â€¢ Comparison view â€¢ Collapsible guide â€¢ Weather naming â€¢ Dimmed non-active traits</p>
  </div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WEATHER V3 â€” Teaching Edition
// Combines Weather's atmosphere with Breath's teaching modes
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let traits = {
  openness: 72,  // Affects cloud coverage (high = clear)
  warmth: 78,    // Affects light temperature
  energy: 65     // Affects particle movement
};

const AVERAGE_TRAITS = {
  openness: 50,
  warmth: 50,
  energy: 50
};

let isDark = true;
let viewMode = 'all';  // 'all', 'openness', 'warmth', 'energy'
let showComparison = false;
let guideExpanded = false;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WEATHER NAME GENERATION â€” Stolen from Constellation
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function generateWeatherName() {
  const o = traits.openness;
  const w = traits.warmth;
  const e = traits.energy;

  // Adjectives based on warmth
  const tempWords = w > 70 ? ['Golden', 'Radiant', 'Amber', 'Sunlit']
    : w > 45 ? ['Balanced', 'Temperate', 'Gentle', 'Soft']
    : ['Crystalline', 'Silver', 'Starlit', 'Moonlit'];

  // Nouns based on openness
  const skyWords = o > 70 ? ['Clarity', 'Horizons', 'Expanse', 'Vista']
    : o > 45 ? ['Weather', 'Skies', 'Atmosphere', 'Presence']
    : ['Depths', 'Mists', 'Mysteries', 'Stillness'];

  // Pick one from each
  const adj = tempWords[Math.floor(Math.random() * tempWords.length)];
  const noun = skyWords[Math.floor(Math.random() * skyWords.length)];

  return `${adj} ${noun}`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COLOR UTILITIES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function lerp(a, b, t) { return a + (b - a) * t; }

function lerpColor(c1, c2, t) {
  const parse = c => {
    if (c.startsWith('#')) {
      return [parseInt(c.slice(1,3),16), parseInt(c.slice(3,5),16), parseInt(c.slice(5,7),16)];
    }
    const m = c.match(/\d+/g);
    return m ? m.map(Number) : [0,0,0];
  };
  const [r1,g1,b1] = parse(c1);
  const [r2,g2,b2] = parse(c2);
  return `rgb(${Math.round(r1+(r2-r1)*t)}, ${Math.round(g1+(g2-g1)*t)}, ${Math.round(b1+(b2-b1)*t)})`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE DESCRIPTORS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function getStateDescriptors(traitsObj = traits) {
  const o = traitsObj.openness;
  const w = traitsObj.warmth;
  const e = traitsObj.energy;

  return {
    openness: {
      percent: o,
      state: o > 70 ? 'Clear skies' : o > 50 ? 'Partly cloudy' : o > 30 ? 'Overcast' : 'Deep clouds',
      emoji: o > 60 ? 'â˜€ï¸' : o > 40 ? 'ğŸŒ¤ï¸' : 'â˜ï¸',
      color: 'text-blue-400',
      barColor: 'bg-blue-400'
    },
    warmth: {
      percent: w,
      state: w > 70 ? 'Golden glow' : w > 50 ? 'Soft warmth' : w > 30 ? 'Cool light' : 'Twilight',
      emoji: w > 60 ? 'ğŸŒ…' : w > 40 ? 'ğŸŒ™' : 'â„ï¸',
      color: w > 50 ? 'text-amber-400' : 'text-indigo-400',
      barColor: w > 50 ? 'bg-amber-400' : 'bg-indigo-400'
    },
    energy: {
      percent: e,
      state: e > 70 ? 'Dancing particles' : e > 50 ? 'Gentle breeze' : e > 30 ? 'Calm air' : 'Still moment',
      emoji: e > 60 ? 'ğŸƒ' : e > 40 ? 'ğŸŒŠ' : 'ğŸª¨',
      color: 'text-cyan-400',
      barColor: 'bg-cyan-400'
    }
  };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NARRATION GENERATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function generateNarration() {
  const o = traits.openness;
  const w = traits.warmth;
  const e = traits.energy;

  // Build narrative based on dominant trait
  const mostDistinct = [
    { name: 'openness', val: o, dist: Math.abs(o - 50) },
    { name: 'warmth', val: w, dist: Math.abs(w - 50) },
    { name: 'energy', val: e, dist: Math.abs(e - 50) }
  ].sort((a, b) => b.dist - a.dist)[0];

  const narratives = {
    openness: {
      high: "You face the world with arms wide open. Your clarity invites others in.",
      low: "Rich inner worlds live behind your clouds. Depth is your quiet gift."
    },
    warmth: {
      high: "Warmth radiates from you naturally. People feel safe in your golden light.",
      low: "Your cool clarity cuts through noise. You see what others miss."
    },
    energy: {
      high: "Life moves through you like a breeze. Your energy lifts the room.",
      low: "Stillness is your superpower. You anchor those around you."
    }
  };

  const direction = mostDistinct.val > 50 ? 'high' : 'low';
  return `"${narratives[mostDistinct.name][direction]}"`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SKY RENDERING â€” Supports isolation mode
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function renderSky(container, traitsObj, options = {}) {
  const { mini = false, isolate = null } = options;

  // When isolating, lock other traits to neutral (50)
  const effectiveTraits = {
    openness: isolate === null || isolate === 'openness' ? traitsObj.openness : 50,
    warmth: isolate === null || isolate === 'warmth' ? traitsObj.warmth : 50,
    energy: isolate === null || isolate === 'energy' ? traitsObj.energy : 50
  };

  const warmth = effectiveTraits.warmth / 100;
  const cloudiness = 1 - (effectiveTraits.openness / 100);
  const energy = effectiveTraits.energy / 100;

  // Color palettes
  const palette = {
    dark: {
      coolSky: ['#05051a', '#0a1428', '#1a2a4a'],
      warmSky: ['#1a0a05', '#2a1508', '#4a2a1a'],
      coolHorizon: '#1a3a6a',
      warmHorizon: '#6a3a1a',
      coolMist: 'rgba(100, 150, 200, 0.3)',
      warmMist: 'rgba(200, 150, 100, 0.3)',
      coolCelestial: 'rgba(180, 200, 255, 0.8)',
      warmCelestial: 'rgba(255, 200, 100, 0.9)',
    },
    light: {
      coolSky: ['#b8d4e8', '#87CEEB', '#6cb4d9'],
      warmSky: ['#ffecd2', '#FFD89E', '#ffb366'],
      coolHorizon: '#a8c8e8',
      warmHorizon: '#ffcc80',
      coolMist: 'rgba(200, 220, 255, 0.4)',
      warmMist: 'rgba(255, 220, 180, 0.4)',
      coolCelestial: 'rgba(255, 255, 255, 0.95)',
      warmCelestial: 'rgba(255, 220, 150, 0.95)',
    }
  };

  const p = isDark ? palette.dark : palette.light;

  // Interpolate colors
  const skyTop = lerpColor(p.coolSky[0], p.warmSky[0], warmth);
  const skyMid = lerpColor(p.coolSky[1], p.warmSky[1], warmth);
  const skyBot = lerpColor(p.coolSky[2], p.warmSky[2], warmth);
  const mistColor = lerpColor(p.coolMist, p.warmMist, warmth);
  const celestialColor = lerpColor(p.coolCelestial, p.warmCelestial, warmth);

  let html = '';

  // Base sky gradient
  html += `<div class="sky-layer" style="background: linear-gradient(180deg, ${skyTop} 0%, ${skyMid} 50%, ${skyBot} 100%);"></div>`;

  // Horizon mist
  html += `<div class="horizon-mist" style="background: linear-gradient(to top, ${mistColor} 0%, transparent 100%);"></div>`;

  // Celestial body
  const celestialSize = mini ? 20 : (isDark ? lerp(30, 50, warmth) : lerp(40, 70, warmth));

  if (warmth > 0.3 || !isDark) {
    const celestialX = mini ? 70 : 75;
    const celestialY = mini ? 15 : 20;

    html += `
      <div class="celestial" style="
        width: ${celestialSize * 2}px;
        height: ${celestialSize * 2}px;
        right: ${celestialX - celestialSize/2}px;
        top: ${celestialY - celestialSize/2}px;
        background: ${celestialColor};
        opacity: ${0.5 + (1 - cloudiness) * 0.4};
        filter: blur(${celestialSize * 0.6}px);
      "></div>
      <div class="celestial-core" style="
        width: ${celestialSize * 0.4}px;
        height: ${celestialSize * 0.4}px;
        right: ${celestialX + celestialSize/2 - (celestialSize * 0.2)}px;
        top: ${celestialY + celestialSize/2 - (celestialSize * 0.2)}px;
        background: ${warmth > 0.5 ? 'rgba(255, 250, 220, 0.9)' : 'rgba(255, 255, 255, 0.9)'};
        opacity: ${0.6 + (1 - cloudiness) * 0.35};
      "></div>
    `;

    // Light rays
    if (!mini && warmth > 0.35 && cloudiness < 0.75) {
      const rayCount = Math.round((1 - cloudiness) * 5) + 2;
      const rayColor = warmth > 0.5 ? 'rgba(255, 220, 150, 0.45)' : 'rgba(220, 240, 255, 0.35)';

      for (let i = 0; i < rayCount; i++) {
        const angle = -25 + (i * 12) + (Math.random() * 8 - 4);
        const width = 25 + Math.random() * 30;
        const delay = Math.random() * 4;
        html += `
          <div class="light-ray" style="
            --ray-color: ${rayColor};
            width: ${width}px;
            height: 160px;
            right: ${75 + celestialSize/2 - width/2}px;
            top: ${20 + celestialSize/2}px;
            transform: rotate(${angle}deg);
            animation-delay: ${delay}s;
            animation-duration: ${5 + Math.random() * 3}s;
            opacity: ${0.2 + (1 - cloudiness) * 0.35};
          "></div>
        `;
      }
    }
  }

  // Stars (cool + clear + dark)
  if (isDark && warmth < 0.5 && cloudiness < 0.5 && !mini) {
    const starCount = Math.round((1 - warmth) * (1 - cloudiness) * 15);
    for (let i = 0; i < starCount; i++) {
      const x = Math.random() * 85 + 5;
      const y = Math.random() * 45 + 5;
      const size = 1 + Math.random() * 2;
      const delay = Math.random() * 4;
      html += `
        <div class="star" style="
          left: ${x}%;
          top: ${y}%;
          width: ${size}px;
          height: ${size}px;
          animation-delay: ${delay}s;
          animation-duration: ${2 + Math.random() * 3}s;
        "></div>
      `;
    }
  }

  // Clouds
  const cloudCount = Math.round(cloudiness * (mini ? 4 : 8));
  for (let i = 0; i < cloudCount; i++) {
    const x = (i * 30 + Math.random() * 25) % 110 - 10;
    const y = 10 + (i % 3) * 20 + Math.random() * 15;
    const w = (mini ? 30 : 60) + Math.random() * (mini ? 30 : 60);
    const h = w * (0.4 + Math.random() * 0.3);
    const opacity = (0.3 + cloudiness * 0.3);
    const delay = i * 0.7;
    const duration = 10 + Math.random() * 8;

    const cloudColor = isDark
      ? (warmth > 0.5 ? `rgba(200, 180, 160, ${opacity})` : `rgba(160, 180, 200, ${opacity})`)
      : (warmth > 0.5 ? `rgba(255, 245, 235, ${opacity * 1.5})` : `rgba(240, 248, 255, ${opacity * 1.5})`);

    html += `
      <div class="cloud" style="
        left: ${x}%;
        top: ${y}%;
        width: ${w}px;
        height: ${h}px;
        background: radial-gradient(ellipse at 50% 60%, ${cloudColor} 0%, transparent 70%);
        animation-delay: ${delay}s;
        animation-duration: ${duration}s;
      "></div>
    `;
  }

  // Floating particles/motes
  const moteCount = Math.round(energy * (mini ? 8 : 18)) + 3;
  for (let i = 0; i < moteCount; i++) {
    const x = Math.random() * 100;
    const y = Math.random() * 100;
    const size = mini ? (1 + Math.random() * 2) : (2 + Math.random() * 4);
    const delay = Math.random() * 5;
    const duration = 5 + Math.random() * 5;

    const moteColor = warmth > 0.5
      ? `rgba(255, ${Math.round(200 + Math.random() * 55)}, ${Math.round(100 + Math.random() * 80)}, 0.85)`
      : `rgba(${Math.round(180 + Math.random() * 40)}, ${Math.round(200 + Math.random() * 40)}, 255, 0.8)`;

    const driftX = (Math.random() * 30 - 15) + 'px';
    const driftY1 = -(10 + Math.random() * 20) + 'px';
    const driftY2 = -(20 + Math.random() * 30) + 'px';

    html += `
      <div class="mote" style="
        left: ${x}%;
        top: ${y}%;
        width: ${size}px;
        height: ${size}px;
        background: ${moteColor};
        color: ${moteColor};
        --drift-x: ${driftX};
        --drift-y1: ${driftY1};
        --drift-y2: ${driftY2};
        --start-opacity: ${0.4 + Math.random() * 0.3};
        --mid-opacity: ${0.6 + Math.random() * 0.35};
        --end-opacity: ${0.3 + Math.random() * 0.3};
        animation-delay: ${delay}s;
        animation-duration: ${duration}s;
        ${energy < 0.25 ? 'animation-play-state: paused; opacity: 0.4;' : ''}
      "></div>
    `;
  }

  // Shimmer
  if (!mini) {
    html += `<div class="shimmer-layer"></div>`;
  }

  container.innerHTML = html;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TEACHING OVERLAY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function renderTeachingOverlay() {
  const overlay = document.getElementById('teaching-overlay');

  if (viewMode === 'all' || showComparison) {
    overlay.classList.remove('visible');
    overlay.innerHTML = '';
    return;
  }

  overlay.classList.add('visible');

  const states = getStateDescriptors();
  const trait = viewMode;
  const state = states[trait];

  const calloutConfig = {
    openness: {
      title: 'SKY CLARITY',
      desc: `Your ${state.percent}% openness creates ${state.state.toLowerCase()}. ${state.percent > 50 ? 'You engage the world directly.' : 'You hold rich inner depths.'}`,
      class: 'callout-openness'
    },
    warmth: {
      title: 'LIGHT COLOR',
      desc: `Your ${state.percent}% warmth creates ${state.state.toLowerCase()}. ${state.percent > 50 ? 'You lead with heart.' : 'You lead with insight.'}`,
      class: 'callout-warmth'
    },
    energy: {
      title: 'PARTICLE MOTION',
      desc: `Your ${state.percent}% energy creates ${state.state.toLowerCase()}. ${state.percent > 50 ? 'You bring dynamic presence.' : 'You bring grounded stillness.'}`,
      class: 'callout-energy'
    }
  };

  const config = calloutConfig[trait];

  overlay.innerHTML = `
    <div class="teaching-callout ${config.class}">
      <div class="title">${config.title}</div>
      <div class="value">${state.percent}%</div>
      <div class="desc">${config.desc}</div>
    </div>
  `;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VIEW MODE MANAGEMENT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function setViewMode(mode) {
  viewMode = mode;

  // Update tab states
  document.querySelectorAll('.mode-tab').forEach(tab => {
    tab.classList.toggle('active', tab.dataset.mode === mode);
  });

  // Update legend highlighting
  const traitNames = ['openness', 'warmth', 'energy'];
  traitNames.forEach(trait => {
    const item = document.getElementById(`legend-${trait}`);
    if (mode === 'all') {
      item.classList.remove('dimmed', 'highlighted');
    } else if (mode === trait) {
      item.classList.remove('dimmed');
      item.classList.add('highlighted');
    } else {
      item.classList.add('dimmed');
      item.classList.remove('highlighted');
    }
  });

  render();
}

function toggleComparison() {
  showComparison = !showComparison;
  const btn = document.getElementById('btn-compare');
  btn.textContent = showComparison ? 'Hide Average' : 'Show Average';
  btn.classList.toggle('active', showComparison);

  const panel = document.getElementById('comparison-panel');
  panel.classList.toggle('hidden', !showComparison);

  render();
}

function toggleGuide() {
  guideExpanded = !guideExpanded;
  const panel = document.getElementById('guide-panel');
  const arrow = document.getElementById('guide-arrow');

  panel.classList.toggle('expanded', guideExpanded);
  arrow.classList.toggle('expanded', guideExpanded);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MAIN RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function render() {
  const sky = document.getElementById('sky');
  const isolate = viewMode === 'all' ? null : viewMode;

  // Render main sky
  renderSky(sky, traits, { isolate });

  // Re-add teaching overlay container after render
  const existingOverlay = document.getElementById('teaching-overlay');
  if (!existingOverlay || !sky.contains(existingOverlay)) {
    const overlay = document.createElement('div');
    overlay.id = 'teaching-overlay';
    overlay.className = 'teaching-overlay';
    sky.appendChild(overlay);
  }

  // Render teaching overlay
  renderTeachingOverlay();

  // Render comparison if active
  if (showComparison) {
    const yoursContainer = document.getElementById('comparison-yours');
    const avgContainer = document.getElementById('comparison-avg');
    renderSky(yoursContainer, traits, { mini: true });
    renderSky(avgContainer, AVERAGE_TRAITS, { mini: true });
  }

  // Update legend
  updateLegend();

  // Update narration
  document.getElementById('poetic-narration').textContent = generateNarration();

  // Update weather name
  document.getElementById('weather-name-value').textContent = generateWeatherName();

  // Apply theme
  applyTheme();
}

function updateLegend() {
  const states = getStateDescriptors();

  // Openness
  document.getElementById('legend-emoji-1').textContent = states.openness.emoji;
  document.getElementById('legend-percent-1').textContent = states.openness.percent + '%';
  document.getElementById('legend-state-1').textContent = states.openness.state;
  document.getElementById('legend-bar-1').style.width = states.openness.percent + '%';

  // Warmth
  document.getElementById('legend-emoji-2').textContent = states.warmth.emoji;
  document.getElementById('legend-percent-2').textContent = states.warmth.percent + '%';
  document.getElementById('legend-percent-2').className = `legend-percent ${states.warmth.color}`;
  document.getElementById('legend-state-2').textContent = states.warmth.state;
  document.getElementById('legend-bar-2').style.width = states.warmth.percent + '%';
  document.getElementById('legend-bar-2').className = `trait-bar-fill ${states.warmth.barColor}`;

  // Energy
  document.getElementById('legend-emoji-3').textContent = states.energy.emoji;
  document.getElementById('legend-percent-3').textContent = states.energy.percent + '%';
  document.getElementById('legend-state-3').textContent = states.energy.state;
  document.getElementById('legend-bar-3').style.width = states.energy.percent + '%';
}

function applyTheme() {
  const phone = document.getElementById('phone');
  const card = document.getElementById('card');
  const narration = document.getElementById('poetic-narration');
  const cta = document.getElementById('cta');
  const ctaSub = document.getElementById('cta-sub');
  const ctaMain = document.getElementById('cta-main');
  const legendCard = document.querySelector('.legend-card');
  const weatherNameLabel = document.querySelector('.weather-name-label');
  const weatherNameValue = document.querySelector('.weather-name-value');

  if (isDark) {
    document.body.style.background = '#08080c';
    phone.style.background = '#0a0a12';
    phone.style.borderColor = '#151520';
    card.style.background = 'rgba(12, 12, 22, 0.85)';
    card.style.borderColor = 'rgba(59, 130, 246, 0.2)';
    narration.className = 'poetic-narration text-sm text-gray-300 leading-relaxed';
    cta.style.background = 'rgba(59, 130, 246, 0.12)';
    ctaSub.className = 'text-xs text-gray-400';
    ctaMain.className = 'text-sm font-medium mt-1 text-blue-300';
    legendCard.style.background = 'rgba(0, 0, 0, 0.4)';
    legendCard.style.borderColor = 'rgba(255, 255, 255, 0.1)';
    weatherNameLabel.style.color = 'rgba(255, 255, 255, 0.35)';
    weatherNameValue.style.color = 'rgba(255, 255, 255, 0.85)';
  } else {
    document.body.style.background = '#f3f4f6';
    phone.style.background = '#ffffff';
    phone.style.borderColor = '#e5e7eb';
    card.style.background = 'rgba(255, 255, 255, 0.95)';
    card.style.borderColor = 'rgba(59, 130, 246, 0.15)';
    narration.className = 'poetic-narration text-sm text-gray-600 leading-relaxed';
    cta.style.background = '#eef2ff';
    ctaSub.className = 'text-xs text-gray-500';
    ctaMain.className = 'text-sm font-semibold mt-1 text-blue-600';
    legendCard.style.background = 'rgba(255, 255, 255, 0.8)';
    legendCard.style.borderColor = 'rgba(0, 0, 0, 0.08)';
    weatherNameLabel.style.color = 'rgba(0, 0, 0, 0.4)';
    weatherNameValue.style.color = 'rgba(0, 0, 0, 0.8)';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONTROLS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function setTheme(mode) {
  isDark = mode === 'dark';
  document.getElementById('btn-dark').className = `px-4 py-2 rounded-xl text-sm font-medium bg-gray-800 text-white border-2 ${isDark ? 'border-blue-500' : 'border-gray-600'}`;
  document.getElementById('btn-light').className = `px-4 py-2 rounded-xl text-sm font-medium bg-white text-gray-800 border-2 ${!isDark ? 'border-blue-500' : 'border-gray-300'}`;
  render();
}

function randomize() {
  const patterns = [
    { openness: 85, warmth: 75, energy: 70 }, // Sunny extrovert
    { openness: 20, warmth: 80, energy: 30 }, // Warm introvert
    { openness: 75, warmth: 25, energy: 60 }, // Cool analyst
    { openness: 30, warmth: 30, energy: 20 }, // Deep thinker
    { openness: 50, warmth: 60, energy: 45 }, // Balanced
    { openness: 60, warmth: 40, energy: 80 }, // Restless mind
  ];

  if (Math.random() > 0.3) {
    const base = patterns[Math.floor(Math.random() * patterns.length)];
    traits.openness = Math.max(10, Math.min(90, base.openness + (Math.random() * 30 - 15)));
    traits.warmth = Math.max(10, Math.min(90, base.warmth + (Math.random() * 30 - 15)));
    traits.energy = Math.max(10, Math.min(90, base.energy + (Math.random() * 30 - 15)));
  } else {
    traits.openness = Math.round(10 + Math.random() * 80);
    traits.warmth = Math.round(10 + Math.random() * 80);
    traits.energy = Math.round(10 + Math.random() * 80);
  }

  render();
}

// Initial render
render();
</script>
</body>
</html>
