<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Aura Design Playground</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    * { box-sizing: border-box; }
    body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }

    /* Animations */
    @keyframes shimmer-pulse {
      0%, 100% { opacity: 0.4; }
      50% { opacity: 0.8; }
    }
    @keyframes fadeSlideIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes sweepFill {
      from { width: 0%; }
      to { width: 100%; }
    }
    @keyframes celebrateGlow {
      0% { transform: scale(0.8); opacity: 0; }
      50% { transform: scale(1.2); opacity: 1; }
      100% { transform: scale(1); opacity: 1; }
    }
    .celebrate-glow { animation: celebrateGlow 0.6s ease-out forwards; }

    /* Shine card effect */
    .shine-card { position: relative; }
    .shine-card::before {
      content: '';
      position: absolute;
      inset: -1px;
      border-radius: inherit;
      background: linear-gradient(180deg, var(--accent-bright, rgba(255,255,255,0.5)) 0%, var(--accent-color, rgba(255,255,255,0.2)) 5%, transparent 15%, transparent 100%);
      -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      padding: 2px;
      pointer-events: none;
      z-index: 20;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    .shine-card:hover::before { opacity: 1; animation: shimmer-pulse 3s ease-in-out infinite; }

    /* Color-specific shines */
    .shine-emerald { --accent-color: rgba(16, 185, 129, 0.25); --accent-bright: rgba(110, 231, 183, 0.55); }
    .shine-rose { --accent-color: rgba(244, 63, 94, 0.25); --accent-bright: rgba(251, 113, 133, 0.55); }
    .shine-violet { --accent-color: rgba(139, 92, 246, 0.25); --accent-bright: rgba(196, 181, 253, 0.55); }
    .shine-blue { --accent-color: rgba(59, 130, 246, 0.3); --accent-bright: rgba(147, 197, 253, 0.6); }
    .shine-amber { --accent-color: rgba(251, 191, 36, 0.2); --accent-bright: rgba(253, 224, 71, 0.45); }
    .shine-teal { --accent-color: rgba(45, 212, 191, 0.2); --accent-bright: rgba(153, 246, 228, 0.5); }
    .shine-indigo { --accent-color: rgba(99, 102, 241, 0.25); --accent-bright: rgba(165, 180, 252, 0.55); }

    /* Glow effects */
    .glow-amber { box-shadow: 0 0 15px rgba(251, 191, 36, 0.12), 0 0 35px rgba(251, 191, 36, 0.08); }
    .glow-violet { box-shadow: 0 0 18px rgba(139, 92, 246, 0.2), 0 0 40px rgba(139, 92, 246, 0.12); }
    .glow-teal { box-shadow: 0 0 18px rgba(45, 212, 191, 0.16), 0 0 40px rgba(45, 212, 191, 0.1); }
    .glow-emerald { box-shadow: 0 0 18px rgba(16, 185, 129, 0.16), 0 0 40px rgba(16, 185, 129, 0.1); }
    .glow-indigo { box-shadow: 0 0 18px rgba(99, 102, 241, 0.2), 0 0 40px rgba(99, 102, 241, 0.12); }

    /* Button feedback */
    .btn-feedback { transition: transform 0.1s ease, filter 0.1s ease; }
    .btn-feedback:hover { filter: brightness(1.15); }
    .btn-feedback:active { transform: scale(0.96); filter: brightness(0.92); }

    /* Question text */
    .question-text {
      font-size: clamp(18px, 5vw, 24px);
      line-height: 1.35;
      text-wrap: balance;
    }

    /* Hide scrollbar */
    .hide-scrollbar::-webkit-scrollbar { display: none; }
    .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

    /* Color picker input */
    input[type="color"] {
      -webkit-appearance: none;
      border: none;
      width: 32px;
      height: 32px;
      cursor: pointer;
      border-radius: 4px;
    }
    input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
    input[type="color"]::-webkit-color-swatch { border: none; border-radius: 4px; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
const { useState, useEffect, useCallback } = React;

// ============================================================
// COLOR PALETTES - Curated themes, easy to switch
// ============================================================
const PALETTES = {
  aura: {
    name: 'Aura (Current)',
    colors: {
      primary: '#8b5cf6',
      secondary: '#3b82f6',
      success: '#10b981',
      danger: '#f43f5e',
      warning: '#f59e0b',
      neutral: '#6b7280',
    },
    categories: {
      prediction: '#fbbf24',
      reasoning: '#8b5cf6',
      judgment: '#14b8a6',
    },
    confidence: {
      yes: ['#a7f3d0', '#6ee7b7', '#34d399', '#10b981'],
      no: ['#fecaca', '#fda4af', '#fb7185', '#f43f5e'],
    },
  },
  ocean: {
    name: 'Ocean',
    colors: {
      primary: '#0ea5e9',
      secondary: '#06b6d4',
      success: '#14b8a6',
      danger: '#f43f5e',
      warning: '#f59e0b',
      neutral: '#64748b',
    },
    categories: {
      prediction: '#06b6d4',
      reasoning: '#0ea5e9',
      judgment: '#14b8a6',
    },
    confidence: {
      yes: ['#99f6e4', '#5eead4', '#2dd4bf', '#14b8a6'],
      no: ['#fecdd3', '#fda4af', '#fb7185', '#f43f5e'],
    },
  },
  sunset: {
    name: 'Sunset',
    colors: {
      primary: '#f97316',
      secondary: '#ef4444',
      success: '#84cc16',
      danger: '#dc2626',
      warning: '#eab308',
      neutral: '#78716c',
    },
    categories: {
      prediction: '#f97316',
      reasoning: '#ef4444',
      judgment: '#eab308',
    },
    confidence: {
      yes: ['#d9f99d', '#bef264', '#a3e635', '#84cc16'],
      no: ['#fecaca', '#fca5a5', '#f87171', '#ef4444'],
    },
  },
  mono: {
    name: 'Mono',
    colors: {
      primary: '#3b82f6',
      secondary: '#6b7280',
      success: '#22c55e',
      danger: '#ef4444',
      warning: '#f59e0b',
      neutral: '#6b7280',
    },
    categories: {
      prediction: '#3b82f6',
      reasoning: '#6b7280',
      judgment: '#3b82f6',
    },
    confidence: {
      yes: ['#bbf7d0', '#86efac', '#4ade80', '#22c55e'],
      no: ['#fecaca', '#fca5a5', '#f87171', '#ef4444'],
    },
  },
  forest: {
    name: 'Forest',
    colors: {
      primary: '#059669',
      secondary: '#0d9488',
      success: '#16a34a',
      danger: '#dc2626',
      warning: '#ca8a04',
      neutral: '#57534e',
    },
    categories: {
      prediction: '#ca8a04',
      reasoning: '#059669',
      judgment: '#0d9488',
    },
    confidence: {
      yes: ['#bbf7d0', '#86efac', '#4ade80', '#22c55e'],
      no: ['#fecaca', '#fca5a5', '#f87171', '#ef4444'],
    },
  },
  neon: {
    name: 'Neon',
    colors: {
      primary: '#a855f7',
      secondary: '#ec4899',
      success: '#22d3ee',
      danger: '#f43f5e',
      warning: '#facc15',
      neutral: '#71717a',
    },
    categories: {
      prediction: '#facc15',
      reasoning: '#a855f7',
      judgment: '#22d3ee',
    },
    confidence: {
      yes: ['#a5f3fc', '#67e8f9', '#22d3ee', '#06b6d4'],
      no: ['#fecdd3', '#fda4af', '#fb7185', '#f43f5e'],
    },
  },
};

// Build full theme from palette
const buildTheme = (palette) => ({
  ...palette,
  assessments: {
    starter: palette.colors.primary,
    personality: palette.colors.primary,
    mind: palette.colors.secondary,
    character: palette.colors.success,
    shadow: palette.colors.neutral,
    relationships: '#d946ef',
    behavior: palette.colors.warning,
    quickstart: palette.colors.danger,
    rose: '#f43f5e',
    indigo: '#6366f1',
    blue: '#3b82f6',
    violet: '#8b5cf6',
    emerald: '#10b981',
  },
  mcColors: [
    { name: 'blue', hex: palette.colors.secondary, shades: generateShades(palette.colors.secondary) },
    { name: 'teal', hex: '#14b8a6', shades: ['#99f6e4', '#5eead4', '#2dd4bf', '#14b8a6'] },
    { name: 'emerald', hex: palette.colors.success, shades: generateShades(palette.colors.success) },
    { name: 'rose', hex: palette.colors.danger, shades: generateShades(palette.colors.danger) },
    { name: 'violet', hex: palette.colors.primary, shades: generateShades(palette.colors.primary) },
  ],
  backgrounds: {
    dark: '#030712',
    darkCard: '#111827',
    light: '#f9fafb',
    lightCard: '#ffffff',
  },
});

// Generate 4 shades from a hex color
const generateShades = (hex) => {
  const lighten = (h, amount) => {
    const num = parseInt(h.slice(1), 16);
    const r = Math.min(255, ((num >> 16) & 0xff) + amount);
    const g = Math.min(255, ((num >> 8) & 0xff) + amount);
    const b = Math.min(255, (num & 0xff) + amount);
    return `#${((r << 16) | (g << 8) | b).toString(16).padStart(6, '0')}`;
  };
  const darken = (h, amount) => lighten(h, -amount);
  return [lighten(hex, 80), lighten(hex, 40), hex, darken(hex, 30)];
};

const DEFAULT_THEME = buildTheme(PALETTES.aura);

// ============================================================
// DATA SCENARIOS - Different user states for testing
// ============================================================
const SCENARIOS = {
  newUser: {
    name: 'New User',
    desc: 'Fresh start, no answers',
    stats: { answered: 0, streak: 0, xp: 0, level: 1 },
    answers: {},
    assessments: {},
    hasSeenTip: false,
  },
  midProgress: {
    name: 'Mid Progress',
    desc: '20+ answers, some assessments',
    stats: { answered: 42, streak: 5, xp: 420, level: 3 },
    answers: { 1: { answer: 0, confidence: 3 }, 2: { answer: 1, confidence: 2 } },
    assessments: { 'quick-profile': { completed: true, score: 75 } },
    hasSeenTip: true,
  },
  powerUser: {
    name: 'Power User',
    desc: '100+ answers, all assessments',
    stats: { answered: 127, streak: 12, xp: 1850, level: 7 },
    answers: { 1: { answer: 0, confidence: 4 }, 2: { answer: 2, confidence: 3 } },
    assessments: {
      'quick-profile': { completed: true, score: 85 },
      'starter-personality': { completed: true, score: 72 },
      'bigfive-E': { completed: true, score: 68 },
    },
    hasSeenTip: true,
  },
  guestNudge: {
    name: 'Guest (Nudge Time)',
    desc: 'Exactly 20 answers, show save modal',
    stats: { answered: 20, streak: 3, xp: 200, level: 2 },
    answers: {},
    assessments: {},
    hasSeenTip: true,
    showSaveModal: true,
  },
};

// ============================================================
// SAMPLE DATA
// ============================================================
const SAMPLE_QUESTIONS = [
  { id: 1, type: 'binary', category: 'prediction', text: 'Will AI surpass human intelligence by 2030?', evidence: [{ type: 'stat', label: 'Expert consensus', value: '45% likely' }] },
  { id: 2, type: 'multiple', category: 'reasoning', text: 'Is a hot dog a sandwich?', options: ['Yes, bread with filling', 'No, its own category', "It's a taco", 'Depends on definition'] },
  { id: 3, type: 'binary', category: 'judgment', text: 'Should social media require age verification?' },
  { id: 4, type: 'multiple', category: 'prediction', text: 'What will be the dominant AI interface by 2030?', options: ['Text chat', 'Voice assistants', 'AR/VR agents', 'Brain-computer interfaces'] },
  { id: 5, type: 'binary', category: 'reasoning', text: 'Is free will an illusion?' },
];

// Onboarding questions - fun, light, personality-revealing
const ONBOARDING_QUESTIONS = [
  { id: 'o1', text: "I'm a morning person", type: 'binary' },
  { id: 'o2', text: "I prefer dogs over cats", type: 'binary' },
  { id: 'o3', text: "I would rather be right than popular", type: 'binary' },
  { id: 'o4', text: "I believe in love at first sight", type: 'binary' },
  { id: 'o5', text: "I think pineapple belongs on pizza", type: 'binary' },
  { id: 'o6', text: "I'd rather explore a new city than relax on a beach", type: 'binary' },
  { id: 'o7', text: "I trust my gut over data", type: 'binary' },
  { id: 'o8', text: "I'd sacrifice sleep for a great conversation", type: 'binary' },
  { id: 'o9', text: "I believe humans are fundamentally good", type: 'binary' },
  { id: 'o10', text: "I'd rather have certainty than possibility", type: 'binary' },
];

const SAMPLE_ASSESSMENTS = [
  { id: 'quick-profile', name: 'Quick Profile', icon: '‚ú®', color: 'rose', items: 10, tier: 0 },
  { id: 'starter-personality', name: 'Personality', icon: 'ü™û', color: 'indigo', items: 9, tier: 1 },
  { id: 'bigfive-E', name: 'Extraversion', icon: 'üé≠', color: 'violet', items: 10, tier: 2 },
  { id: 'adhd', name: 'ADHD Screener', icon: 'üß†', color: 'blue', items: 6, tier: 2 },
  { id: 'shadow-self', name: 'Shadow Self', icon: 'üåë', color: 'slate', items: 15, tier: 3 },
  { id: 'relationships', name: 'Attachment Style', icon: 'üíö', color: 'pink', items: 12, tier: 2 },
];

const SAMPLE_VOTES = {
  binary: [
    { answer: 0, confidence: 4 }, { answer: 0, confidence: 3 }, { answer: 0, confidence: 3 },
    { answer: 0, confidence: 2 }, { answer: 0, confidence: 2 }, { answer: 0, confidence: 2 },
    { answer: 0, confidence: 1 }, { answer: 0, confidence: 1 },
    { answer: 1, confidence: 4 }, { answer: 1, confidence: 4 }, { answer: 1, confidence: 3 },
    { answer: 1, confidence: 3 }, { answer: 1, confidence: 2 }, { answer: 1, confidence: 1 },
  ],
  multiple: [
    { answer: 0, confidence: 3 }, { answer: 0, confidence: 2 }, { answer: 0, confidence: 4 },
    { answer: 1, confidence: 4 }, { answer: 1, confidence: 3 }, { answer: 1, confidence: 3 },
    { answer: 1, confidence: 2 }, { answer: 1, confidence: 2 }, { answer: 1, confidence: 1 },
    { answer: 2, confidence: 3 }, { answer: 2, confidence: 2 },
    { answer: 3, confidence: 4 }, { answer: 3, confidence: 1 },
  ],
};

const SAMPLE_ASSESS_QUESTIONS = [
  { q: "I am the first person to introduce myself in a group", c: 'extraversion' },
  { q: "I finish tasks even when they become repetitive or boring", c: 'conscientiousness' },
  { q: "I replay conversations wondering if I said something wrong", c: 'neuroticism' },
  { q: "I choose new experiences over sticking to familiar routines", c: 'openness' },
  { q: "I apologize first after an argument, even if I'm not wrong", c: 'agreeableness' },
];

const LIKERT_SCALE = [
  { v: 1, l: 'Not like me at all' },
  { v: 2, l: 'A little like me' },
  { v: 3, l: 'Somewhat like me' },
  { v: 4, l: 'Mostly like me' },
  { v: 5, l: 'Very much like me' },
];

const SAMPLE_ANALYTICS = {
  totalAnswered: 127,
  categories: { prediction: 45, reasoning: 52, judgment: 30 },
  assessments: { completed: 3, total: 8 },
  personality: { E: 72, A: 58, C: 65, N: 42, O: 81 },
  streak: { current: 5, best: 12 },
  weeklyActivity: [3, 7, 5, 2, 8, 4, 6],
};

const CATEGORIES = [
  { id: 'prediction', name: 'Predictions', icon: 'üîÆ', color: 'amber', count: 45 },
  { id: 'reasoning', name: 'Reasoning', icon: 'üß†', color: 'violet', count: 52 },
  { id: 'judgment', name: 'Judgment', icon: '‚öñÔ∏è', color: 'teal', count: 30 },
];

// Sample answered history
const SAMPLE_HISTORY = [
  { id: 1, text: 'Will AI surpass human intelligence by 2030?', answer: 0, confidence: 3, category: 'prediction', date: '2h ago' },
  { id: 2, text: 'Is a hot dog a sandwich?', answer: 1, confidence: 2, category: 'reasoning', date: '3h ago' },
  { id: 3, text: 'Should social media require age verification?', answer: 0, confidence: 4, category: 'judgment', date: 'Yesterday' },
  { id: 4, text: 'Is free will an illusion?', answer: 1, confidence: 2, category: 'reasoning', date: 'Yesterday' },
  { id: 5, text: 'Will Bitcoin exceed $150k by 2026?', answer: 0, confidence: 1, category: 'prediction', date: '2 days ago' },
];

// Level titles
const LEVEL_TITLES = [
  'Newcomer', 'Curious', 'Thinker', 'Explorer', 'Seeker',
  'Analyst', 'Sage', 'Oracle', 'Visionary', 'Enlightened'
];

// ============================================================
// DEVICE PRESETS
// ============================================================
const DEVICES = {
  'iphone-se': { name: 'iPhone SE', width: 375, height: 667, scale: 1 },
  'iphone-15': { name: 'iPhone 15', width: 393, height: 852, scale: 1 },
  'iphone-15-max': { name: 'iPhone 15 Pro Max', width: 430, height: 932, scale: 1 },
  'pixel-7': { name: 'Pixel 7', width: 412, height: 915, scale: 1 },
  'ipad-mini': { name: 'iPad Mini', width: 768, height: 1024, scale: 0.6 },
  'desktop': { name: 'Desktop', width: 1280, height: 800, scale: 0.5 },
};

// ============================================================
// HELPER FUNCTIONS
// ============================================================
const TH = (type, darkMode) => {
  const themes = {
    'text-primary': darkMode ? 'text-white' : 'text-gray-900',
    'text-muted': darkMode ? 'text-gray-400' : 'text-gray-500',
    'text-subtle': darkMode ? 'text-gray-500' : 'text-gray-400',
    'bg-primary': darkMode ? 'bg-gray-950' : 'bg-gray-50',
    'bg-card': darkMode ? 'bg-gray-900' : 'bg-white',
    'bg-inverted': darkMode ? 'bg-white' : 'bg-gray-900',
    'border': darkMode ? 'border-gray-800' : 'border-gray-200',
  };
  return themes[type] || '';
};

const hexToRgb = (hex) => {
  const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
  return result ? `${parseInt(result[1], 16)}, ${parseInt(result[2], 16)}, ${parseInt(result[3], 16)}` : '0,0,0';
};

const getStars = (n) => '‚òÖ'.repeat(Math.min(n, 4));

// ============================================================
// UI COMPONENTS
// ============================================================

// Confidence Segments
const ConfidenceSegments = ({ level, color = 'emerald', active = false, theme }) => {
  const colors = {
    emerald: theme.confidence.yes,
    rose: theme.confidence.no,
  };
  const shades = colors[color] || colors.emerald;
  if (!active || level === 0) return null;
  return (
    <div className="absolute bottom-0 left-0 right-0 h-2 flex">
      {[1, 2, 3, 4].map(i => (
        <div key={i} className={`flex-1 transition-all duration-150 ${i === 1 ? 'rounded-bl-xl' : ''} ${i === 4 ? 'rounded-br-xl' : ''}`}
          style={{
            backgroundColor: level >= i ? shades[i - 1] : 'rgba(0,0,0,0.2)',
            borderRight: i < 4 ? '1px solid rgba(0,0,0,0.3)' : 'none'
          }}
        />
      ))}
    </div>
  );
};

// Category Chip
const CategoryChip = ({ category, theme, darkMode }) => {
  const catConfig = {
    prediction: { name: 'Predictions', icon: 'üîÆ' },
    reasoning: { name: 'Reasoning', icon: 'üß†' },
    judgment: { name: 'Judgment', icon: '‚öñÔ∏è' },
  };
  const cat = catConfig[category];
  const color = theme.categories[category];
  if (!cat) return null;
  return (
    <span className="px-2 py-0.5 rounded-full text-sm font-medium"
      style={{ backgroundColor: darkMode ? `${color}20` : `${color}15`, color }}>
      {cat.icon} {cat.name}
    </span>
  );
};

// Question Card
const QuestionCard = ({ question, darkMode, theme, evidenceExpanded, onToggleEvidence }) => {
  const glowMap = { prediction: 'glow-amber', reasoning: 'glow-violet', judgment: 'glow-teal' };
  const cardGlow = darkMode && question.category ? glowMap[question.category] || '' : '';
  const hasEvidence = question.evidence && question.evidence.length > 0;

  return (
    <div className={`space-y-3 ${cardGlow ? `p-4 rounded-2xl ${cardGlow}` : ''}`}>
      <div className="flex justify-center">
        <CategoryChip category={question.category} theme={theme} darkMode={darkMode} />
      </div>
      <h2 className={`question-text text-center font-medium ${TH('text-primary', darkMode)}`}>
        {question.text}
      </h2>
      {hasEvidence && (
        <div className={`rounded-xl overflow-hidden ${darkMode ? 'bg-gradient-to-b from-gray-800/80 to-gray-900/80' : 'bg-white border border-gray-200'}`}>
          <button onClick={onToggleEvidence}
            className={`w-full px-4 py-3 flex items-center justify-between ${darkMode ? 'hover:bg-gray-700/30' : 'hover:bg-gray-50'}`}>
            <span className="flex items-center gap-2">
              <span className={`w-8 h-8 rounded-lg flex items-center justify-center text-base ${darkMode ? 'bg-violet-500/20 text-violet-400' : 'bg-violet-100 text-violet-600'}`}>üìä</span>
              <span className={`text-sm font-medium ${darkMode ? 'text-gray-200' : 'text-gray-800'}`}>
                Evidence <span className={TH('text-subtle', darkMode)}>({question.evidence.length})</span>
              </span>
            </span>
            <span className={`w-6 h-6 rounded-full flex items-center justify-center text-xs ${darkMode ? 'bg-gray-700 text-gray-400' : 'bg-gray-200 text-gray-500'} ${evidenceExpanded ? 'rotate-180' : ''}`}>‚ñº</span>
          </button>
          {evidenceExpanded && (
            <div className="px-4 pb-4 space-y-3">
              {question.evidence.map((item, i) => (
                <div key={i} className={`rounded-lg p-3 ${darkMode ? 'bg-gray-800/60' : 'bg-gray-50'}`}>
                  {item.type === 'stat' ? (
                    <div className="flex items-center justify-between">
                      <span className={`text-sm ${TH('text-muted', darkMode)}`}>{item.label}</span>
                      <span className={`text-sm font-semibold px-2 py-0.5 rounded ${darkMode ? 'bg-emerald-500/20 text-emerald-400' : 'bg-emerald-100 text-emerald-700'}`}>{item.value}</span>
                    </div>
                  ) : (
                    <div className="flex gap-2">
                      <span className={darkMode ? 'text-gray-600' : 'text-gray-300'}>"</span>
                      <span className={`text-sm italic ${TH('text-muted', darkMode)}`}>{item.text}</span>
                    </div>
                  )}
                </div>
              ))}
            </div>
          )}
        </div>
      )}
    </div>
  );
};

// Binary Buttons
const BinaryButtons = ({ darkMode, theme, selectedAnswer, confidence, onSelect }) => {
  const getButtonStyle = (answer) => {
    const isSelected = selectedAnswer === answer;
    const shades = answer === 0 ? theme.confidence.yes : theme.confidence.no;
    const conf = confidence || 2;

    if (isSelected) {
      return {
        background: `linear-gradient(135deg, ${shades[conf - 1]} 0%, ${shades[Math.min(conf, 3)]} 100%)`,
        boxShadow: `0 0 ${conf * 8}px rgba(${hexToRgb(shades[3])}, ${0.2 + conf * 0.15})`,
        color: 'white',
      };
    }
    return {
      background: darkMode ? 'rgb(31,41,55)' : 'rgb(255,255,255)',
      color: darkMode ? 'rgb(209,213,219)' : (answer === 0 ? theme.colors.success : theme.colors.danger),
      border: darkMode ? 'none' : `2px solid ${answer === 0 ? shades[0] : shades[0]}`,
    };
  };

  return (
    <div className="grid grid-cols-2 gap-3">
      {[0, 1].map(answer => (
        <button key={answer} onClick={() => onSelect(answer)}
          className={`relative h-14 rounded-xl font-bold overflow-hidden select-none btn-feedback ${
            selectedAnswer === answer ? (answer === 0 ? 'ring-2 ring-emerald-400 shine-card shine-emerald' : 'ring-2 ring-rose-400 shine-card shine-rose') : ''
          }`}
          style={getButtonStyle(answer)}>
          <ConfidenceSegments level={confidence} color={answer === 0 ? 'emerald' : 'rose'} active={selectedAnswer === answer} theme={theme} />
          <div className="relative z-10 flex items-center justify-center h-full">
            <span className="text-xl font-bold">{answer === 0 ? 'YES' : 'NO'}</span>
          </div>
        </button>
      ))}
    </div>
  );
};

// Multiple Choice Buttons
const MCButtons = ({ options, darkMode, theme, selectedAnswer, confidence, onSelect }) => {
  const getOptionStyle = (index) => {
    const colorSet = theme.mcColors[index % theme.mcColors.length];
    const isSelected = selectedAnswer === index;
    const conf = confidence || 2;

    if (isSelected) {
      return {
        background: `linear-gradient(135deg, ${colorSet.shades[conf - 1]} 0%, ${colorSet.shades[Math.min(conf, 3)]} 100%)`,
        boxShadow: `0 0 ${conf * 6}px rgba(${hexToRgb(colorSet.hex)}, ${0.2 + conf * 0.12})`,
        color: 'white',
        border: `2px solid ${colorSet.hex}`,
      };
    }
    return {
      background: darkMode ? 'rgb(31,41,55)' : 'rgb(255,255,255)',
      color: darkMode ? 'rgb(209,213,219)' : 'rgb(55,65,81)',
      border: darkMode ? '2px solid transparent' : '2px solid rgb(229,231,235)',
    };
  };

  return (
    <div className="space-y-2">
      {options.map((option, index) => (
        <button key={index} onClick={() => onSelect(index)}
          className={`w-full text-left px-4 py-3 rounded-xl font-medium btn-feedback ${selectedAnswer === index ? 'shine-card shine-blue' : ''}`}
          style={getOptionStyle(index)}>
          {option}
        </button>
      ))}
    </div>
  );
};

// NavBar
const NavBar = ({ darkMode, theme, stats }) => (
  <div className={`flex items-center justify-between px-4 py-2 ${darkMode ? 'bg-gray-950/70 border-b border-white/5' : 'bg-white/70 border-b border-gray-200/50'} backdrop-blur-md`}>
    <button className="text-xl btn-feedback">üåÄ</button>
    <div className="flex items-center gap-2">
      <span className={`text-sm ${TH('text-muted', darkMode)}`}>{stats.answered} answered</span>
      {stats.streak > 0 && <span className="text-sm text-orange-400">üî•{stats.streak}</span>}
    </div>
    <div className="flex items-center gap-2">
      <div className="w-7 h-7 rounded-full flex items-center justify-center text-sm"
        style={{ background: 'linear-gradient(135deg, rgba(255,255,255,0.15), rgba(255,255,255,0.05))', boxShadow: '0 0 12px 3px rgba(255,255,255,0.3)', border: '1.5px solid rgba(255,255,255,0.3)' }}>
        <span style={{color: 'rgba(255,255,255,0.9)'}}>üë§</span>
      </div>
      <button className={`text-xl btn-feedback ${TH('text-muted', darkMode)}`}>‚ò∞</button>
    </div>
  </div>
);

// Progress Circle
const ProgressCircle = ({ progress = 0, size = 48, strokeWidth = 3, color, darkMode, icon, text }) => {
  const radius = (size - strokeWidth) / 2;
  const circumference = 2 * Math.PI * radius;
  const gradId = `prog-${Math.random().toString(36).substr(2, 9)}`;

  return (
    <div className="relative flex items-center justify-center" style={{ width: size, height: size }}>
      {progress > 0 && <div className="absolute inset-0 rounded-full blur-md opacity-40" style={{ background: color }} />}
      <svg width={size} height={size} className="absolute">
        <defs>
          <linearGradient id={gradId} x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" stopColor={progress > 0 ? color : '#374151'} />
            <stop offset="100%" stopColor={progress > 0 ? color : '#4b5563'} />
          </linearGradient>
        </defs>
        <circle cx={size/2} cy={size/2} r={radius} fill="none" stroke={darkMode ? '#1f2937' : '#e5e7eb'} strokeWidth={strokeWidth} />
        <circle cx={size/2} cy={size/2} r={radius} fill="none" stroke={`url(#${gradId})`} strokeWidth={strokeWidth} strokeLinecap="round"
          strokeDasharray={circumference} strokeDashoffset={circumference * (1 - progress / 100)}
          transform={`rotate(-90 ${size/2} ${size/2})`} className="transition-all duration-500" />
      </svg>
      {icon && <span className="relative z-10 text-lg">{icon}</span>}
      {text !== undefined && (
        <span className="relative z-10 font-bold text-sm" style={{ color: progress > 0 ? color : (darkMode ? '#6b7280' : '#9ca3af') }}>
          {text}
        </span>
      )}
    </div>
  );
};

// Assessment Card
const AssessmentCard = ({ assessment, darkMode, theme, progress = 0, onClick }) => {
  const colorHex = theme.assessments[assessment.color] || theme.colors.primary;
  return (
    <div onClick={onClick}
      className={`p-4 rounded-xl flex items-center gap-3 btn-feedback cursor-pointer ${darkMode ? 'bg-gray-900 hover:bg-gray-800' : 'bg-white hover:bg-gray-50 border border-gray-200'}`}
      style={{ borderLeft: `3px solid ${colorHex}` }}>
      <ProgressCircle progress={progress} size={44} color={colorHex} darkMode={darkMode} icon={assessment.icon} />
      <div className="flex-1">
        <div className={`font-medium ${TH('text-primary', darkMode)}`}>{assessment.name}</div>
        <div className={`text-sm ${TH('text-muted', darkMode)}`}>{assessment.items} questions</div>
      </div>
      <span className={TH('text-subtle', darkMode)}>‚Üí</span>
    </div>
  );
};

// XP Progress Bar
const XPProgressBar = ({ xp, level, darkMode, theme }) => {
  const xpForLevel = level * 100;
  const xpProgress = (xp % 100);
  const progressPct = (xpProgress / 100) * 100;

  return (
    <div className={`rounded-xl p-4 ${darkMode ? 'bg-gray-900' : 'bg-white'}`}>
      <div className="flex items-center justify-between mb-2">
        <div className="flex items-center gap-2">
          <span className="text-lg font-bold" style={{ color: theme.colors.primary }}>Lvl {level}</span>
          <span className={`text-sm ${TH('text-muted', darkMode)}`}>{LEVEL_TITLES[level - 1] || 'Legend'}</span>
        </div>
        <span className={`text-sm ${TH('text-muted', darkMode)}`}>{xp} / {xpForLevel} XP</span>
      </div>
      <div className={`h-2 rounded-full ${darkMode ? 'bg-gray-800' : 'bg-gray-200'}`}>
        <div className="h-full rounded-full transition-all duration-500"
          style={{ width: `${progressPct}%`, background: `linear-gradient(90deg, ${theme.colors.primary}, ${theme.colors.secondary})` }} />
      </div>
    </div>
  );
};

// Streak Display
const StreakDisplay = ({ current, best, darkMode }) => (
  <div className={`flex items-center gap-4 p-4 rounded-xl ${darkMode ? 'bg-gray-900' : 'bg-white'}`}>
    <div className="flex items-center gap-2">
      <span className="text-3xl">üî•</span>
      <div>
        <div className="text-2xl font-bold text-orange-400">{current}</div>
        <div className={`text-xs ${TH('text-muted', darkMode)}`}>day streak</div>
      </div>
    </div>
    <div className={`h-10 w-px ${darkMode ? 'bg-gray-800' : 'bg-gray-200'}`} />
    <div>
      <div className={`text-sm font-medium ${TH('text-primary', darkMode)}`}>{best} days</div>
      <div className={`text-xs ${TH('text-muted', darkMode)}`}>personal best</div>
    </div>
  </div>
);

// TipBanner - dismissible tips (ported from index.html)
const TipBanner = ({ darkMode, onDismiss, text = "Confident? Tap up to four times" }) => (
  <div onClick={onDismiss}
    className={`rounded-md px-3 py-2 flex items-center justify-between cursor-pointer ${
      darkMode ? 'bg-violet-900/30 border border-violet-500/30' : 'bg-violet-100 border border-violet-300'
    }`}>
    <span className={`text-sm ${darkMode ? 'text-violet-300' : 'text-violet-700'}`}>
      <span className="font-medium">Tip:</span> {text}
    </span>
    <span className={`text-sm ml-2 ${darkMode ? 'text-violet-500' : 'text-violet-400'}`}>‚úï</span>
  </div>
);

// UndoBar - confirmation bar with sweep animation (ported from index.html)
const UndoBar = ({ darkMode, undoDelay = 3, onUndo, answer, confidence, isBinary, options, theme }) => {
  const answerText = isBinary ? (answer === 0 ? 'YES' : 'NO') : options?.[answer] || '';
  const conf = Math.min(confidence, 4);

  let bgGradient;
  if (isBinary) {
    const shades = answer === 0 ? theme.confidence.yes : theme.confidence.no;
    bgGradient = `linear-gradient(135deg, ${shades[conf - 1]} 0%, ${shades[Math.min(conf, 3)]} 100%)`;
  } else {
    const color = theme.mcColors[answer % theme.mcColors.length];
    bgGradient = `linear-gradient(135deg, ${color.shades[conf - 1]} 0%, ${color.shades[Math.min(conf, 3)]} 100%)`;
  }

  return (
    <div onClick={onUndo} className="relative cursor-pointer active:opacity-80 overflow-hidden rounded-xl h-14">
      <div className={`h-full ${darkMode ? 'bg-gray-900/40' : 'bg-white/40'} flex items-center justify-between px-4`}>
        <div className="flex items-center gap-3">
          <div className="px-3 py-1 rounded-lg font-bold text-white" style={{ background: bgGradient }}>
            {isBinary ? answerText : `${String.fromCharCode(65 + answer)}. ${answerText}`}
          </div>
          <span className={`text-sm ${TH('text-muted', darkMode)}`}>{getStars(confidence)}</span>
        </div>
        <span className={`text-sm font-medium ${darkMode ? 'text-violet-400' : 'text-violet-600'}`}>Tap to undo</span>
      </div>
      {/* Sweep animation */}
      <div className="absolute bottom-0 left-0 right-0 h-1 bg-gray-700">
        <div className="h-full bg-violet-500" style={{ animation: `sweepFill ${undoDelay}s linear forwards` }} />
      </div>
    </div>
  );
};

// SaveProgressModal - nudge after 20 responses (ported from index.html)
const SaveProgressModal = ({ darkMode, theme, onCreateAccount, onLater }) => (
  <div className="absolute inset-0 z-50 flex items-center justify-center p-4" style={{backgroundColor: 'rgba(0,0,0,0.7)'}}>
    <div className={`w-full max-w-sm rounded-2xl p-6 ${darkMode ? 'bg-gray-900' : 'bg-white'}`}>
      <div className="text-4xl text-center mb-3">üéâ</div>
      <h2 className={`text-xl font-bold text-center mb-2 ${TH('text-primary', darkMode)}`}>20 responses!</h2>
      <p className={`text-sm text-center mb-6 ${TH('text-muted', darkMode)}`}>
        Save your progress?<br/>Sync across devices anytime.
      </p>
      <div className="space-y-2">
        <button onClick={onCreateAccount} className="w-full py-3 rounded-xl font-medium btn-feedback bg-violet-600 text-white">
          Create Account
        </button>
        <button onClick={onLater} className={`w-full py-3 rounded-xl font-medium btn-feedback ${darkMode ? 'bg-gray-800 text-gray-400' : 'bg-gray-100 text-gray-600'}`}>
          Later
        </button>
      </div>
    </div>
  </div>
);

// NoneOptionModal - for MC questions (ported from index.html)
const NoneOptionModal = ({ darkMode, theme, onClose, onSubmit }) => {
  const [customAnswer, setCustomAnswer] = useState('');
  const canSubmit = customAnswer.trim().length > 0;

  return (
    <div className="absolute inset-0 bg-black/70 flex items-end justify-center z-50 pb-8" onClick={onClose}>
      <div className={`rounded-xl p-4 w-[calc(100%-2rem)] max-w-xs ${darkMode ? 'bg-gray-900' : 'bg-white'}`} onClick={e => e.stopPropagation()}>
        <div className={`text-sm font-medium mb-2 ${TH('text-primary', darkMode)}`}>None of these options fit</div>
        <div className={`text-sm mb-3 ${TH('text-muted', darkMode)}`}>What would you answer instead?</div>
        <textarea value={customAnswer} onChange={(e) => setCustomAnswer(e.target.value)} placeholder="Your answer..."
          className={`w-full px-3 py-2 rounded-lg text-sm mb-3 h-20 resize-none ${darkMode ? 'bg-gray-800 text-white border-gray-700' : 'bg-gray-100 text-gray-900'} border focus:outline-none focus:border-violet-500`}
        />
        <div className="flex gap-2">
          <button onClick={onClose} className={`flex-1 py-2 rounded-lg text-sm btn-feedback ${darkMode ? 'bg-gray-800 text-gray-400' : 'bg-gray-200 text-gray-600'}`}>Cancel</button>
          <button onClick={() => { onSubmit(customAnswer); onClose(); }} disabled={!canSubmit}
            className={`flex-1 py-2 rounded-lg text-sm font-medium btn-feedback ${canSubmit ? 'bg-violet-600 text-white' : darkMode ? 'bg-gray-800 text-gray-600' : 'bg-gray-200 text-gray-400'}`}>Submit</button>
        </div>
      </div>
    </div>
  );
};

// Modal Overlay wrapper
const ModalOverlay = ({ children, darkMode }) => (
  <div className="absolute inset-0 flex items-center justify-center z-40">
    <div className="absolute inset-0 bg-black/60 backdrop-blur-sm" />
    <div className="relative z-50 w-full max-w-xs mx-4">{children}</div>
  </div>
);

// Level Up Modal
const LevelUpModal = ({ darkMode, theme, level = 5, title = 'Insight Seeker' }) => (
  <ModalOverlay darkMode={darkMode}>
    <div className={`rounded-2xl p-6 text-center ${darkMode ? 'bg-gray-900' : 'bg-white'}`} style={{boxShadow: `0 0 60px ${theme.colors.primary}40`}}>
      <div className="text-5xl mb-4 celebrate-glow">üéâ</div>
      <h2 className={`text-2xl font-bold mb-1 ${TH('text-primary', darkMode)}`}>Level Up!</h2>
      <div className="text-4xl font-bold my-3" style={{color: theme.colors.primary}}>{level}</div>
      <p className={`text-lg font-medium mb-4`} style={{color: theme.colors.primary}}>{title}</p>
      <button className="w-full py-3 rounded-xl font-semibold text-white btn-feedback" style={{background: theme.colors.primary}}>
        Continue
      </button>
    </div>
  </ModalOverlay>
);

// Confirm Dialog Modal
const ConfirmModal = ({ darkMode, theme }) => (
  <ModalOverlay darkMode={darkMode}>
    <div className={`rounded-2xl p-5 ${darkMode ? 'bg-gray-900' : 'bg-white'}`}>
      <h3 className={`text-lg font-semibold mb-2 ${TH('text-primary', darkMode)}`}>Clear All Data?</h3>
      <p className={`text-sm mb-5 ${TH('text-muted', darkMode)}`}>This will reset your answers, assessments, and progress. This cannot be undone.</p>
      <div className="flex gap-3">
        <button className={`flex-1 py-2.5 rounded-xl font-medium btn-feedback ${darkMode ? 'bg-gray-800 text-gray-300' : 'bg-gray-200 text-gray-700'}`}>Cancel</button>
        <button className="flex-1 py-2.5 rounded-xl font-medium text-white btn-feedback" style={{background: theme.colors.danger}}>Clear Data</button>
      </div>
    </div>
  </ModalOverlay>
);

// Assessment Complete Modal
const CompleteModal = ({ darkMode, theme, assessmentName = 'Quick Profile', xp = 50 }) => (
  <ModalOverlay darkMode={darkMode}>
    <div className={`rounded-2xl p-6 text-center ${darkMode ? 'bg-gray-900' : 'bg-white'}`} style={{boxShadow: `0 0 60px ${theme.colors.success}30`}}>
      <div className="text-5xl mb-3 celebrate-glow">‚ú®</div>
      <h2 className={`text-xl font-bold mb-1 ${TH('text-primary', darkMode)}`}>Assessment Complete!</h2>
      <p className={`text-sm mb-4 ${TH('text-muted', darkMode)}`}>{assessmentName}</p>
      <div className="flex items-center justify-center gap-2 mb-5">
        <span className="text-2xl font-bold" style={{color: theme.colors.success}}>+{xp} XP</span>
      </div>
      <button className="w-full py-3 rounded-xl font-semibold text-white btn-feedback" style={{background: theme.colors.success}}>
        View Results
      </button>
    </div>
  </ModalOverlay>
);

// Binary Chart
const BinaryChart = ({ votes, userResponse, darkMode, theme }) => {
  const yesColors = theme.confidence.yes;
  const noColors = theme.confidence.no;

  const data = [
    { label: 'Yes', answer: 0, confCounts: [0,0,0,0] },
    { label: 'No', answer: 1, confCounts: [0,0,0,0] },
  ];

  const allVotes = userResponse ? [...votes, userResponse] : votes;
  allVotes.forEach(v => {
    if (v.answer === 0) data[0].confCounts[v.confidence - 1]++;
    else if (v.answer === 1) data[1].confCounts[v.confidence - 1]++;
  });

  data.forEach(d => d.count = d.confCounts.reduce((a, b) => a + b, 0));
  const total = data[0].count + data[1].count;
  const sorted = [...data].sort((a, b) => b.count - a.count);
  const maxCount = Math.max(data[0].count, data[1].count, 1);
  const userConf = userResponse ? userResponse.confidence - 1 : -1;

  return (
    <div className="space-y-3">
      {sorted.map((opt) => {
        const isUserRow = userResponse?.answer === opt.answer;
        const pct = total > 0 ? Math.round((opt.count / total) * 100) : 0;
        const colors = opt.answer === 0 ? yesColors : noColors;
        const barWidth = (opt.count / maxCount) * 100;

        return (
          <div key={opt.answer} className="space-y-1">
            <div className="flex items-center justify-between">
              <span className={`text-sm font-medium ${isUserRow ? 'px-2 py-0.5 rounded-full border' : ''}`}
                    style={{ color: colors[3], borderColor: isUserRow ? colors[3] : 'transparent' }}>
                {opt.label} {isUserRow && '(You)'}
              </span>
              <span className="text-sm font-bold" style={{ color: colors[3] }}>{pct}%</span>
            </div>
            <div className={`h-5 rounded-full overflow-hidden ${darkMode ? 'bg-gray-800' : 'bg-gray-200'}`}>
              <div className="h-full flex" style={{ width: `${barWidth}%` }}>
                {[3, 2, 1, 0].map(confIdx => {
                  const count = opt.confCounts[confIdx];
                  if (count === 0) return null;
                  const segWidth = (count / opt.count) * 100;
                  const isUserSeg = isUserRow && confIdx === userConf;
                  return (
                    <div key={confIdx} className="h-full"
                         style={{ width: `${segWidth}%`, background: colors[confIdx], ...(isUserSeg ? { boxShadow: 'inset 0 0 0 2px white' } : {}) }} />
                  );
                })}
              </div>
            </div>
          </div>
        );
      })}
      <div className={`text-center text-xs ${TH('text-muted', darkMode)}`}>{total} responses</div>
    </div>
  );
};

// Multiple Choice Chart
const MCChart = ({ votes, options, userResponse, darkMode, theme }) => {
  const data = options.map((label, i) => {
    const optVotes = votes.filter(v => v.answer === i);
    const confCounts = [0, 0, 0, 0];
    optVotes.forEach(v => confCounts[v.confidence - 1]++);
    return { label, index: i, count: optVotes.length, confCounts };
  });

  const allVotes = userResponse ? [...votes, userResponse] : votes;
  const total = allVotes.length;
  const sorted = [...data].sort((a, b) => b.count - a.count);
  const maxCount = Math.max(...data.map(d => d.count), 1);
  const userConf = userResponse ? userResponse.confidence - 1 : -1;

  return (
    <div className="space-y-2">
      {sorted.filter(opt => opt.count > 0).map((opt) => {
        const isUserRow = userResponse?.answer === opt.index;
        const pct = total > 0 ? Math.round((opt.count / total) * 100) : 0;
        const barWidth = (opt.count / maxCount) * 100;
        const colors = theme.mcColors[opt.index % theme.mcColors.length];

        return (
          <div key={opt.index} className="space-y-1">
            <div className="flex items-center justify-between gap-2">
              <span className={`text-sm truncate flex-1 ${isUserRow ? 'font-bold' : ''}`} style={{ color: colors.hex }}>
                {opt.label} {isUserRow && '(You)'}
              </span>
              <span className="text-sm font-bold" style={{ color: colors.hex }}>{pct}%</span>
            </div>
            <div className={`h-4 rounded-full overflow-hidden ${darkMode ? 'bg-gray-800' : 'bg-gray-200'}`}>
              <div className="h-full flex" style={{ width: `${barWidth}%` }}>
                {[3, 2, 1, 0].map(confIdx => {
                  const count = opt.confCounts[confIdx];
                  if (count === 0) return null;
                  const segWidth = (count / opt.count) * 100;
                  const isUserSeg = isUserRow && confIdx === userConf;
                  return (
                    <div key={confIdx} className="h-full"
                         style={{ width: `${segWidth}%`, background: colors.shades[confIdx], ...(isUserSeg ? { boxShadow: 'inset 0 0 0 2px white' } : {}) }} />
                  );
                })}
              </div>
            </div>
          </div>
        );
      })}
      <div className={`text-center text-xs ${TH('text-muted', darkMode)}`}>{total} responses</div>
    </div>
  );
};

// ============================================================
// SCREENS
// ============================================================

// Welcome Screen
const WelcomeScreen = ({ darkMode, theme, onStart }) => (
  <div className="flex-1 flex flex-col items-center justify-center p-8" style={{backgroundColor: darkMode ? '#030712' : '#f9fafb'}}>
    <div className="text-6xl mb-6">üåÄ</div>
    <h1 className={`text-3xl font-bold mb-3 ${TH('text-primary', darkMode)}`}>Aura</h1>
    <p className={`text-base mb-12 text-center ${TH('text-muted', darkMode)}`}>Discover yourself, one question at a time</p>
    <div className="w-full max-w-xs space-y-3">
      <button onClick={onStart} className="w-full py-4 px-6 rounded-xl font-semibold text-lg btn-feedback text-white" style={{background: theme.colors.primary}}>
        Let's Go
      </button>
      <button className={`w-full py-3 px-6 rounded-xl font-medium btn-feedback ${darkMode ? 'bg-gray-800 text-gray-300' : 'bg-gray-200 text-gray-700'}`}>
        Sign In
      </button>
    </div>
  </div>
);

// Path Choice Screen (NEW)
const PathChoiceScreen = ({ darkMode, theme, onChoose }) => (
  <div className="flex-1 flex flex-col items-center justify-center p-6" style={{backgroundColor: darkMode ? '#030712' : '#f9fafb'}}>
    <h2 className={`text-xl font-bold mb-2 ${TH('text-primary', darkMode)}`}>How do you want to start?</h2>
    <p className={`text-sm mb-8 text-center ${TH('text-muted', darkMode)}`}>Both paths unlock the full experience</p>

    <div className="w-full max-w-xs space-y-4">
      <button onClick={() => onChoose('reveal')}
        className={`w-full p-5 rounded-2xl text-left btn-feedback ${darkMode ? 'bg-gray-900 hover:bg-gray-800' : 'bg-white hover:bg-gray-50'}`}
        style={{ border: `2px solid ${theme.colors.primary}` }}>
        <div className="flex items-center gap-3 mb-2">
          <span className="text-2xl">üîÆ</span>
          <span className={`font-bold ${TH('text-primary', darkMode)}`}>Reveal Mode</span>
        </div>
        <p className={`text-sm ${TH('text-muted', darkMode)}`}>
          Quick 10-question assessment to discover your personality snapshot
        </p>
      </button>

      <button onClick={() => onChoose('explore')}
        className={`w-full p-5 rounded-2xl text-left btn-feedback ${darkMode ? 'bg-gray-900 hover:bg-gray-800' : 'bg-white hover:bg-gray-50 border border-gray-200'}`}>
        <div className="flex items-center gap-3 mb-2">
          <span className="text-2xl">üß≠</span>
          <span className={`font-bold ${TH('text-primary', darkMode)}`}>Explore Mode</span>
        </div>
        <p className={`text-sm ${TH('text-muted', darkMode)}`}>
          Browse categories and answer questions at your own pace
        </p>
      </button>
    </div>
  </div>
);

// Onboarding Flow Screen (NEW)
const OnboardingFlowScreen = ({ darkMode, theme, step, onAnswer, onComplete }) => {
  const question = ONBOARDING_QUESTIONS[step];
  const progress = ((step + 1) / ONBOARDING_QUESTIONS.length) * 100;

  return (
    <div className={`flex-1 flex flex-col ${darkMode ? 'bg-gray-950' : 'bg-gray-50'}`}>
      {/* Progress */}
      <div className={`px-4 py-3 ${darkMode ? 'border-b border-gray-800' : 'border-b border-gray-200'}`}>
        <div className="flex items-center justify-between mb-2">
          <span className={`text-sm ${TH('text-muted', darkMode)}`}>Getting to know you</span>
          <span className={`text-sm font-medium ${TH('text-primary', darkMode)}`}>{step + 1} / {ONBOARDING_QUESTIONS.length}</span>
        </div>
        <div className={`h-1.5 rounded-full ${darkMode ? 'bg-gray-800' : 'bg-gray-200'}`}>
          <div className="h-full rounded-full transition-all duration-300" style={{ width: `${progress}%`, background: theme.colors.primary }} />
        </div>
      </div>

      {/* Question */}
      <div className="flex-1 flex flex-col justify-center px-6">
        <h2 className={`text-xl font-medium text-center leading-relaxed mb-8 ${TH('text-primary', darkMode)}`}>
          {question.text}
        </h2>

        <div className="grid grid-cols-2 gap-3">
          <button onClick={() => onAnswer(0)}
            className={`h-14 rounded-xl font-bold btn-feedback ${darkMode ? 'bg-gray-800 text-emerald-400 hover:bg-emerald-900/30' : 'bg-emerald-50 text-emerald-600 hover:bg-emerald-100'}`}>
            YES
          </button>
          <button onClick={() => onAnswer(1)}
            className={`h-14 rounded-xl font-bold btn-feedback ${darkMode ? 'bg-gray-800 text-rose-400 hover:bg-rose-900/30' : 'bg-rose-50 text-rose-600 hover:bg-rose-100'}`}>
            NO
          </button>
        </div>
      </div>

      {/* Skip */}
      <div className="p-4">
        <button onClick={onComplete} className={`w-full py-2 text-sm ${TH('text-muted', darkMode)}`}>
          Skip for now ‚Üí
        </button>
      </div>
    </div>
  );
};

// Category Browser Screen (NEW)
const CategoryBrowserScreen = ({ darkMode, theme, onSelectCategory }) => (
  <div className={`flex-1 flex flex-col ${darkMode ? 'bg-gray-950' : 'bg-gray-50'}`}>
    <NavBar darkMode={darkMode} theme={theme} stats={{ answered: 42, streak: 5 }} />

    <div className="flex-1 overflow-auto p-4">
      <h2 className={`text-lg font-semibold mb-4 ${TH('text-primary', darkMode)}`}>Browse by Category</h2>

      <div className="space-y-3">
        {CATEGORIES.map(cat => {
          const colorMap = { amber: '#f59e0b', violet: '#8b5cf6', teal: '#14b8a6' };
          const color = colorMap[cat.color] || theme.colors.primary;

          return (
            <button key={cat.id} onClick={() => onSelectCategory(cat.id)}
              className={`w-full p-4 rounded-xl flex items-center gap-4 btn-feedback ${darkMode ? 'bg-gray-900 hover:bg-gray-800' : 'bg-white hover:bg-gray-50 border border-gray-200'}`}>
              <div className="w-12 h-12 rounded-xl flex items-center justify-center text-2xl"
                style={{ background: `${color}20` }}>
                {cat.icon}
              </div>
              <div className="flex-1 text-left">
                <div className={`font-medium ${TH('text-primary', darkMode)}`}>{cat.name}</div>
                <div className={`text-sm ${TH('text-muted', darkMode)}`}>{cat.count} questions</div>
              </div>
              <span style={{ color }} className="text-sm font-medium">‚Üí</span>
            </button>
          );
        })}
      </div>

      <div className="mt-6">
        <h3 className={`text-sm font-medium mb-3 ${TH('text-muted', darkMode)}`}>Assessments</h3>
        {SAMPLE_ASSESSMENTS.slice(0, 3).map((a, i) => (
          <AssessmentCard key={a.id} assessment={a} darkMode={darkMode} theme={theme} progress={i === 0 ? 100 : i === 1 ? 45 : 0} />
        ))}
      </div>
    </div>
  </div>
);

// Question History Screen (NEW)
const HistoryScreen = ({ darkMode, theme }) => (
  <div className={`flex-1 flex flex-col ${darkMode ? 'bg-gray-950' : 'bg-gray-50'}`}>
    <NavBar darkMode={darkMode} theme={theme} stats={{ answered: 127, streak: 5 }} />

    <div className="flex-1 overflow-auto">
      <div className={`px-4 py-3 ${darkMode ? 'bg-gray-900' : 'bg-white'}`}>
        <h2 className={`text-lg font-semibold ${TH('text-primary', darkMode)}`}>Your Answers</h2>
        <p className={`text-sm ${TH('text-muted', darkMode)}`}>127 questions answered</p>
      </div>

      <div className="p-4 space-y-3">
        {SAMPLE_HISTORY.map(item => {
          const catConfig = { prediction: { icon: 'üîÆ', color: '#f59e0b' }, reasoning: { icon: 'üß†', color: '#8b5cf6' }, judgment: { icon: '‚öñÔ∏è', color: '#14b8a6' } };
          const cat = catConfig[item.category];

          return (
            <div key={item.id} className={`p-4 rounded-xl ${darkMode ? 'bg-gray-900' : 'bg-white border border-gray-200'}`}>
              <div className="flex items-start gap-3">
                <span className="text-lg">{cat.icon}</span>
                <div className="flex-1">
                  <p className={`text-sm font-medium mb-1 ${TH('text-primary', darkMode)}`}>{item.text}</p>
                  <div className="flex items-center gap-2">
                    <span className={`text-xs px-2 py-0.5 rounded-full font-medium ${item.answer === 0 ? 'bg-emerald-500/20 text-emerald-400' : 'bg-rose-500/20 text-rose-400'}`}>
                      {item.answer === 0 ? 'Yes' : 'No'} {getStars(item.confidence)}
                    </span>
                    <span className={`text-xs ${TH('text-subtle', darkMode)}`}>{item.date}</span>
                  </div>
                </div>
              </div>
            </div>
          );
        })}
      </div>
    </div>
  </div>
);

// Full Assessment Flow Screen (NEW)
const AssessmentFlowScreen = ({ darkMode, theme, step, questionIndex, onAnswer, onExit }) => {
  const assessment = SAMPLE_ASSESSMENTS[0]; // Quick Profile
  const colorHex = theme.assessments[assessment.color] || theme.colors.primary;
  const question = SAMPLE_ASSESS_QUESTIONS[questionIndex];
  const total = SAMPLE_ASSESS_QUESTIONS.length;

  const gradients = [
    darkMode ? 'bg-rose-950/30 border-rose-800/40' : 'bg-rose-50 border-rose-200',
    darkMode ? 'bg-rose-950/50 border-rose-700/50' : 'bg-rose-100 border-rose-300',
    darkMode ? 'bg-rose-900/40 border-rose-600/50' : 'bg-rose-200 border-rose-400',
    darkMode ? 'bg-rose-900/60 border-rose-500/60' : 'bg-rose-300 border-rose-500',
    darkMode ? 'bg-rose-800/70 border-rose-400/70' : 'bg-rose-400 border-rose-600',
  ];

  return (
    <div className={`flex-1 flex flex-col ${darkMode ? 'bg-gray-950' : 'bg-gray-50'}`}>
      {/* Nav */}
      <div className={`h-11 flex items-center justify-between px-3 border-b ${darkMode ? 'border-gray-800' : 'border-gray-200'}`}>
        <button onClick={onExit} className={`text-sm font-medium ${TH('text-muted', darkMode)}`}>Save & Exit</button>
        <div className="text-center">
          <div className="text-xs" style={{ color: colorHex }}>{assessment.name}</div>
          <div className={`text-sm font-medium ${TH('text-primary', darkMode)}`}>{questionIndex + 1} / {total}</div>
        </div>
        <button onClick={onExit} className={`text-sm font-medium ${TH('text-muted', darkMode)}`}>Exit</button>
      </div>

      {/* Progress */}
      <div className={`flex h-2 gap-px px-1 py-0.5 ${darkMode ? 'bg-gray-900' : 'bg-gray-100'}`}>
        {Array(total).fill(0).map((_, i) => (
          <div key={i} className={`flex-1 rounded-sm ${i < questionIndex ? `bg-rose-500` : i === questionIndex ? (darkMode ? 'bg-white' : 'bg-gray-900') : (darkMode ? 'bg-gray-800' : 'bg-gray-300')}`} />
        ))}
      </div>

      {/* Question */}
      <div className="flex-1 flex flex-col justify-center px-4 pb-4">
        <div className={`p-5 rounded-2xl ${darkMode ? 'bg-gray-900' : 'bg-white'}`}>
          <h2 className={`text-xl font-medium text-center leading-relaxed ${TH('text-primary', darkMode)}`}>{question.q}</h2>
        </div>
      </div>

      {/* Likert options */}
      <div className="flex-shrink-0 px-4 pb-4 space-y-2">
        {LIKERT_SCALE.map((opt, i) => (
          <button key={opt.v} onClick={() => onAnswer(opt.v)}
            className={`w-full py-3.5 px-4 rounded-xl flex items-center justify-between border btn-feedback ${gradients[i]} ${darkMode ? 'text-gray-200' : 'text-gray-700'}`}>
            <span>{opt.l}</span>
            <span className={`text-sm font-medium ${darkMode ? 'text-rose-400/70' : 'text-rose-600/70'}`}>{opt.v}</span>
          </button>
        ))}
      </div>
    </div>
  );
};

// Settings Screen
const SettingsScreen = ({ darkMode, theme }) => {
  const SettingRow = ({ icon, label, value, toggle }) => (
    <div className={`flex items-center justify-between py-3 px-4 ${darkMode ? 'border-b border-gray-800' : 'border-b border-gray-200'}`}>
      <div className="flex items-center gap-3">
        <span className="text-xl">{icon}</span>
        <span className={TH('text-primary', darkMode)}>{label}</span>
      </div>
      {toggle ? (
        <div className={`w-11 h-6 rounded-full p-1 ${value ? 'bg-violet-600' : (darkMode ? 'bg-gray-700' : 'bg-gray-300')}`}>
          <div className={`w-4 h-4 rounded-full bg-white transition-transform ${value ? 'translate-x-5' : ''}`} />
        </div>
      ) : (
        <span className={TH('text-muted', darkMode)}>{value}</span>
      )}
    </div>
  );
  return (
    <div className={`flex-1 ${darkMode ? 'bg-gray-950' : 'bg-gray-50'}`}>
      <div className={`px-4 py-3 ${darkMode ? 'bg-gray-900' : 'bg-white'}`}>
        <h2 className={`text-lg font-semibold ${TH('text-primary', darkMode)}`}>Settings</h2>
      </div>
      <div className={`mt-2 ${darkMode ? 'bg-gray-900' : 'bg-white'}`}>
        <SettingRow icon="üåô" label="Dark Mode" value={true} toggle />
        <SettingRow icon="üîî" label="Notifications" value={true} toggle />
        <SettingRow icon="‚è±Ô∏è" label="Undo Delay" value="3 seconds" />
        <SettingRow icon="üî•" label="Show Streak" value={true} toggle />
      </div>
      <div className={`mt-4 ${darkMode ? 'bg-gray-900' : 'bg-white'}`}>
        <SettingRow icon="üë§" label="Account" value="‚Üí" />
        <SettingRow icon="üìä" label="Export Data" value="‚Üí" />
        <SettingRow icon="üóëÔ∏è" label="Clear Data" value="‚Üí" />
      </div>
    </div>
  );
};

// Profile Screen
const ProfileScreen = ({ darkMode, theme, scenario }) => {
  const stats = scenario?.stats || { answered: 127, streak: 5, xp: 850, level: 4 };
  const levelTitle = LEVEL_TITLES[stats.level - 1] || 'Legend';

  return (
    <div className={`flex-1 ${darkMode ? 'bg-gray-950' : 'bg-gray-50'} p-4 space-y-4`}>
      {/* Profile header */}
      <div className={`rounded-2xl p-6 text-center ${darkMode ? 'bg-gray-900' : 'bg-white'}`}>
        <div className="w-20 h-20 mx-auto rounded-full flex items-center justify-center text-4xl mb-3"
          style={{background: `linear-gradient(135deg, ${theme.colors.primary}40, ${theme.colors.secondary}40)`}}>
          üë§
        </div>
        <h2 className={`text-xl font-bold ${TH('text-primary', darkMode)}`}>Level {stats.level}</h2>
        <p style={{color: theme.colors.primary}} className="font-medium">{levelTitle}</p>
      </div>

      {/* XP Bar */}
      <XPProgressBar xp={stats.xp} level={stats.level} darkMode={darkMode} theme={theme} />

      {/* Streak */}
      <StreakDisplay current={stats.streak} best={12} darkMode={darkMode} />

      {/* Stats grid */}
      <div className="grid grid-cols-2 gap-3">
        <div className={`rounded-xl p-4 text-center ${darkMode ? 'bg-gray-900' : 'bg-white'}`}>
          <div className="text-2xl font-bold" style={{color: theme.colors.primary}}>{stats.answered}</div>
          <div className={`text-sm ${TH('text-muted', darkMode)}`}>Answered</div>
        </div>
        <div className={`rounded-xl p-4 text-center ${darkMode ? 'bg-gray-900' : 'bg-white'}`}>
          <div className="text-2xl font-bold" style={{color: theme.colors.success}}>3</div>
          <div className={`text-sm ${TH('text-muted', darkMode)}`}>Assessments</div>
        </div>
      </div>
    </div>
  );
};

// Analytics Screen
const AnalyticsScreen = ({ darkMode, theme }) => {
  const data = SAMPLE_ANALYTICS;
  const traits = ['E', 'A', 'C', 'N', 'O'];
  const traitNames = { E: 'Extraversion', A: 'Agreeableness', C: 'Conscientiousness', N: 'Neuroticism', O: 'Openness' };

  return (
    <div className={`flex-1 ${darkMode ? 'bg-gray-950' : 'bg-gray-50'} p-4 overflow-auto`}>
      {/* Stats row */}
      <div className="grid grid-cols-3 gap-2 mb-4">
        <div className={`rounded-xl p-3 text-center ${darkMode ? 'bg-gray-900' : 'bg-white'}`}>
          <div className="text-xl font-bold" style={{ color: theme.colors.primary }}>{data.totalAnswered}</div>
          <div className={`text-xs ${TH('text-muted', darkMode)}`}>Questions</div>
        </div>
        <div className={`rounded-xl p-3 text-center ${darkMode ? 'bg-gray-900' : 'bg-white'}`}>
          <div className="text-xl font-bold text-orange-400">üî• {data.streak.current}</div>
          <div className={`text-xs ${TH('text-muted', darkMode)}`}>Streak</div>
        </div>
        <div className={`rounded-xl p-3 text-center ${darkMode ? 'bg-gray-900' : 'bg-white'}`}>
          <div className="text-xl font-bold" style={{ color: theme.colors.success }}>{data.assessments.completed}/{data.assessments.total}</div>
          <div className={`text-xs ${TH('text-muted', darkMode)}`}>Assessments</div>
        </div>
      </div>

      {/* Category breakdown */}
      <div className={`rounded-xl p-4 mb-4 ${darkMode ? 'bg-gray-900' : 'bg-white'}`}>
        <h3 className={`text-sm font-medium mb-3 ${TH('text-muted', darkMode)}`}>By Category</h3>
        <div className="space-y-2">
          {Object.entries(data.categories).map(([cat, count]) => {
            const total = Object.values(data.categories).reduce((a, b) => a + b, 0);
            const pct = Math.round((count / total) * 100);
            const color = theme.categories[cat];
            return (
              <div key={cat} className="space-y-1">
                <div className="flex justify-between text-sm">
                  <span className="capitalize" style={{ color }}>{cat}</span>
                  <span className={TH('text-primary', darkMode)}>{count}</span>
                </div>
                <div className={`h-2 rounded-full ${darkMode ? 'bg-gray-800' : 'bg-gray-200'}`}>
                  <div className="h-full rounded-full" style={{ width: `${pct}%`, background: color }} />
                </div>
              </div>
            );
          })}
        </div>
      </div>

      {/* Personality snapshot */}
      <div className={`rounded-xl p-4 ${darkMode ? 'bg-gray-900' : 'bg-white'}`}>
        <h3 className={`text-sm font-medium mb-3 ${TH('text-muted', darkMode)}`}>Personality Snapshot</h3>
        <div className="space-y-3">
          {traits.map(t => {
            const score = data.personality[t];
            return (
              <div key={t} className="space-y-1">
                <div className="flex justify-between text-sm">
                  <span className={TH('text-primary', darkMode)}>{traitNames[t]}</span>
                  <span style={{ color: theme.colors.primary }}>{score}%</span>
                </div>
                <div className={`h-2 rounded-full ${darkMode ? 'bg-gray-800' : 'bg-gray-200'}`}>
                  <div className="h-full rounded-full" style={{ width: `${score}%`, background: `linear-gradient(90deg, ${theme.colors.primary}, ${theme.colors.secondary})` }} />
                </div>
              </div>
            );
          })}
        </div>
      </div>
    </div>
  );
};

// Phone Frame
const PhoneFrame = ({ children, darkMode, device }) => {
  const d = DEVICES[device] || DEVICES['iphone-15'];
  return (
    <div className="relative bg-[#1a1a1c] rounded-[55px] p-3 shadow-2xl"
      style={{ filter: 'drop-shadow(0 25px 50px rgba(0,0,0,0.4))', transform: `scale(${d.scale})`, transformOrigin: 'top center' }}>
      {/* Side buttons */}
      <div className="absolute -left-[3px] top-[100px] w-[3px] h-[28px] bg-[#2a2a2c] rounded-l-sm" />
      <div className="absolute -left-[3px] top-[145px] w-[3px] h-[50px] bg-[#2a2a2c] rounded-l-sm" />
      <div className="absolute -left-[3px] top-[205px] w-[3px] h-[50px] bg-[#2a2a2c] rounded-l-sm" />
      <div className="absolute -right-[3px] top-[160px] w-[3px] h-[65px] bg-[#2a2a2c] rounded-r-sm" />

      {/* Screen */}
      <div className={`relative overflow-hidden flex flex-col ${darkMode ? 'bg-gray-950' : 'bg-gray-100'}`}
        style={{ width: d.width, height: d.height, borderRadius: 44 }}>
        {/* Dynamic Island */}
        <div className="absolute top-3 left-1/2 -translate-x-1/2 w-[126px] h-[37px] bg-black rounded-full z-30" />

        {/* Status bar */}
        <div className={`flex-shrink-0 flex items-end justify-between px-8 pb-2 h-[54px] ${TH('text-primary', darkMode)} text-sm font-semibold relative z-20`}>
          <span>9:41</span>
          <div className="flex gap-1.5 items-center">
            <svg className="w-[18px] h-[12px]" viewBox="0 0 18 12" fill="currentColor"><path d="M1 4a1 1 0 011-1h1a1 1 0 011 1v4a1 1 0 01-1 1H2a1 1 0 01-1-1V4zM6 3a1 1 0 011-1h1a1 1 0 011 1v5a1 1 0 01-1 1H7a1 1 0 01-1-1V3zM11 2a1 1 0 011-1h1a1 1 0 011 1v6a1 1 0 01-1 1h-1a1 1 0 01-1-1V2z"/></svg>
            <svg className="w-[17px] h-[11px]" viewBox="0 0 17 11" fill="currentColor"><path d="M8.5 2.5a6 6 0 014.24 1.76.75.75 0 001.06-1.06A7.5 7.5 0 008.5 1a7.5 7.5 0 00-5.3 2.2.75.75 0 001.06 1.06A6 6 0 018.5 2.5z"/><path d="M8.5 5.5a3 3 0 012.12.88.75.75 0 001.06-1.06 4.5 4.5 0 00-6.36 0 .75.75 0 001.06 1.06A3 3 0 018.5 5.5z"/><circle cx="8.5" cy="9" r="1.5"/></svg>
            <div className="flex items-center">
              <div className={`w-[25px] h-[12px] border-[1.5px] ${darkMode ? 'border-white' : 'border-gray-900'} rounded-[3px] flex items-center p-[2px]`}>
                <div className={`w-[17px] h-[7px] ${TH('bg-inverted', darkMode)} rounded-[1px]`} />
              </div>
              <div className={`w-[1.5px] h-[5px] ${TH('bg-inverted', darkMode)} ml-[1px] rounded-r-sm`} />
            </div>
          </div>
        </div>

        {/* Content */}
        <div className="flex-1 flex flex-col overflow-hidden">{children}</div>

        {/* Home indicator */}
        <div className={`absolute bottom-2 left-1/2 -translate-x-1/2 w-[134px] h-[5px] ${TH('bg-inverted', darkMode)} rounded-full opacity-60 z-20`} />
      </div>
    </div>
  );
};

// ============================================================
// PLAYGROUND CONTROLS
// ============================================================

const ScenePicker = ({ selected, onSelect }) => {
  const scenes = [
    { id: 'question-flow', name: 'Question Flow', desc: 'Answer ‚Üí Undo ‚Üí Results' },
    { id: 'assessment-flow', name: 'Assessment Flow', desc: 'Full Likert assessment' },
    { id: 'onboarding', name: 'Onboarding', desc: '10-question intro' },
    { id: 'path-choice', name: 'Path Choice', desc: 'Reveal vs Explore' },
    { id: 'categories', name: 'Category Browser', desc: 'Browse by topic' },
    { id: 'history', name: 'Question History', desc: 'Past answers' },
    { id: 'user-hub', name: 'User Hub', desc: 'Profile + Analytics' },
    { id: 'all-modals', name: 'All Modals', desc: 'Level up, Save, etc.' },
    { id: 'components', name: 'Component Gallery', desc: 'All UI elements' },
  ];

  return (
    <div className="space-y-2">
      {scenes.map(scene => (
        <button key={scene.id} onClick={() => onSelect(scene.id)}
          className={`w-full text-left px-3 py-2 rounded-lg ${selected === scene.id ? 'bg-violet-600 text-white' : 'bg-gray-800 text-gray-300 hover:bg-gray-700'}`}>
          <div className="font-medium text-sm">{scene.name}</div>
          <div className={`text-xs ${selected === scene.id ? 'text-violet-200' : 'text-gray-500'}`}>{scene.desc}</div>
        </button>
      ))}
    </div>
  );
};

const ScenarioPicker = ({ selected, onSelect }) => (
  <div className="space-y-2">
    {Object.entries(SCENARIOS).map(([id, scenario]) => (
      <button key={id} onClick={() => onSelect(id)}
        className={`w-full text-left px-3 py-2 rounded-lg ${selected === id ? 'bg-emerald-600 text-white' : 'bg-gray-800 text-gray-300 hover:bg-gray-700'}`}>
        <div className="font-medium text-sm">{scenario.name}</div>
        <div className={`text-xs ${selected === id ? 'text-emerald-200' : 'text-gray-500'}`}>{scenario.desc}</div>
      </button>
    ))}
  </div>
);

const DevicePicker = ({ selected, onSelect }) => (
  <div className="flex flex-wrap gap-2">
    {Object.entries(DEVICES).map(([id, device]) => (
      <button key={id} onClick={() => onSelect(id)}
        className={`px-3 py-1.5 rounded-lg text-xs ${selected === id ? 'bg-violet-600 text-white' : 'bg-gray-800 text-gray-300 hover:bg-gray-700'}`}>
        {device.name}
      </button>
    ))}
  </div>
);

const PaletteSelector = ({ theme, selectedPalette, onPaletteChange, onThemeChange }) => {
  const [showCustom, setShowCustom] = useState(false);

  const updateColor = (path, value) => {
    const newTheme = JSON.parse(JSON.stringify(theme));
    const parts = path.split('.');
    let obj = newTheme;
    for (let i = 0; i < parts.length - 1; i++) obj = obj[parts[i]];
    obj[parts[parts.length - 1]] = value;
    onThemeChange(newTheme);
  };

  return (
    <div className="space-y-4">
      <div className="grid grid-cols-2 gap-2">
        {Object.entries(PALETTES).map(([id, palette]) => (
          <button key={id} onClick={() => onPaletteChange(id)}
            className={`p-2 rounded-lg text-left transition-all ${selectedPalette === id ? 'bg-violet-600 ring-2 ring-violet-400' : 'bg-gray-800 hover:bg-gray-700'}`}>
            <div className="flex gap-1 mb-1.5">
              <div className="w-4 h-4 rounded-full" style={{ background: palette.colors.primary }} />
              <div className="w-4 h-4 rounded-full" style={{ background: palette.colors.success }} />
              <div className="w-4 h-4 rounded-full" style={{ background: palette.colors.danger }} />
            </div>
            <span className="text-xs text-gray-200 font-medium">{palette.name}</span>
          </button>
        ))}
      </div>

      <button onClick={() => setShowCustom(!showCustom)}
        className="w-full flex items-center justify-between px-3 py-2 bg-gray-800 rounded-lg text-sm text-gray-300 hover:bg-gray-700">
        <span>Custom Colors</span>
        <span className={`transition-transform ${showCustom ? 'rotate-180' : ''}`}>‚ñº</span>
      </button>

      {showCustom && (
        <div className="space-y-3 p-3 bg-gray-800/50 rounded-lg">
          <div className="text-xs text-gray-500 mb-2">Core Colors</div>
          <div className="grid grid-cols-2 gap-2">
            {Object.entries(theme.colors).map(([key, value]) => (
              <div key={key} className="flex items-center gap-2">
                <input type="color" value={value} onChange={(e) => updateColor(`colors.${key}`, e.target.value)} className="w-6 h-6" />
                <span className="text-xs text-gray-400 capitalize">{key}</span>
              </div>
            ))}
          </div>
        </div>
      )}
    </div>
  );
};

// ============================================================
// PREVIEW CONTENT
// ============================================================
const PreviewContent = ({ scene, theme, darkMode, scenario }) => {
  const [selectedAnswer, setSelectedAnswer] = useState(null);
  const [confidence, setConfidence] = useState(2);
  const [evidenceExpanded, setEvidenceExpanded] = useState(false);
  const [step, setStep] = useState(0);
  const [showTip, setShowTip] = useState(!scenario?.hasSeenTip);
  const [showUndo, setShowUndo] = useState(false);
  const [onboardingStep, setOnboardingStep] = useState(0);
  const [assessmentQuestion, setAssessmentQuestion] = useState(0);

  const handleSelect = (answer) => {
    if (selectedAnswer === answer) {
      setConfidence(Math.min(confidence + 1, 4));
    } else {
      setSelectedAnswer(answer);
      setConfidence(1);
    }
    // Show undo bar after selection
    setShowUndo(true);
    setTimeout(() => setShowUndo(false), 3000);
  };

  const stats = scenario?.stats || { answered: 42, streak: 5 };

  // QUESTION FLOW
  if (scene === 'question-flow') {
    const q = step === 0 ? SAMPLE_QUESTIONS[0] : SAMPLE_QUESTIONS[1];
    const isBinary = q.type === 'binary';
    const answered = selectedAnswer !== null;

    return (
      <>
        <NavBar darkMode={darkMode} theme={theme} stats={stats} />
        <div className="flex-1 overflow-auto p-4 space-y-4">
          {showTip && <TipBanner darkMode={darkMode} onDismiss={() => setShowTip(false)} />}

          <QuestionCard question={q} darkMode={darkMode} theme={theme} evidenceExpanded={evidenceExpanded} onToggleEvidence={() => setEvidenceExpanded(!evidenceExpanded)} />

          {showUndo ? (
            <UndoBar darkMode={darkMode} undoDelay={3} onUndo={() => { setSelectedAnswer(null); setShowUndo(false); }}
              answer={selectedAnswer} confidence={confidence} isBinary={isBinary} options={q.options} theme={theme} />
          ) : (
            isBinary ? (
              <BinaryButtons darkMode={darkMode} theme={theme} selectedAnswer={selectedAnswer} confidence={confidence} onSelect={handleSelect} />
            ) : (
              <MCButtons options={q.options} darkMode={darkMode} theme={theme} selectedAnswer={selectedAnswer} confidence={confidence} onSelect={handleSelect} />
            )
          )}

          {answered && !showUndo && (
            <div className={`p-4 rounded-xl ${darkMode ? 'bg-gray-900' : 'bg-white'}`}>
              <h3 className={`text-sm font-medium mb-3 ${TH('text-muted', darkMode)}`}>Community Results</h3>
              {isBinary ? (
                <BinaryChart votes={SAMPLE_VOTES.binary} userResponse={{ answer: selectedAnswer, confidence }} darkMode={darkMode} theme={theme} />
              ) : (
                <MCChart votes={SAMPLE_VOTES.multiple} options={q.options} userResponse={{ answer: selectedAnswer, confidence }} darkMode={darkMode} theme={theme} />
              )}
            </div>
          )}

          <div className="flex justify-center gap-2 pt-2">
            <button onClick={() => { setStep(0); setSelectedAnswer(null); setShowUndo(false); }} className={`px-3 py-1 rounded text-xs ${step === 0 ? 'bg-violet-600 text-white' : 'bg-gray-700 text-gray-400'}`}>Binary</button>
            <button onClick={() => { setStep(1); setSelectedAnswer(null); setShowUndo(false); }} className={`px-3 py-1 rounded text-xs ${step === 1 ? 'bg-violet-600 text-white' : 'bg-gray-700 text-gray-400'}`}>Multiple Choice</button>
          </div>
        </div>
      </>
    );
  }

  // ONBOARDING
  if (scene === 'onboarding') {
    if (step === 0) return <WelcomeScreen darkMode={darkMode} theme={theme} onStart={() => setStep(1)} />;
    if (step === 1) return <PathChoiceScreen darkMode={darkMode} theme={theme} onChoose={() => setStep(2)} />;
    return (
      <OnboardingFlowScreen darkMode={darkMode} theme={theme} step={onboardingStep}
        onAnswer={() => { if (onboardingStep < 9) setOnboardingStep(onboardingStep + 1); else setStep(3); }}
        onComplete={() => setStep(3)} />
    );
  }

  // PATH CHOICE
  if (scene === 'path-choice') {
    return <PathChoiceScreen darkMode={darkMode} theme={theme} onChoose={() => {}} />;
  }

  // CATEGORIES
  if (scene === 'categories') {
    return <CategoryBrowserScreen darkMode={darkMode} theme={theme} onSelectCategory={() => {}} />;
  }

  // HISTORY
  if (scene === 'history') {
    return <HistoryScreen darkMode={darkMode} theme={theme} />;
  }

  // ASSESSMENT FLOW
  if (scene === 'assessment-flow') {
    if (step === 2) {
      return (
        <div className={`flex-1 flex items-center justify-center ${darkMode ? 'bg-gray-950' : 'bg-gray-50'}`}>
          <CompleteModal darkMode={darkMode} theme={theme} />
        </div>
      );
    }
    return (
      <>
        <AssessmentFlowScreen darkMode={darkMode} theme={theme} step={step} questionIndex={assessmentQuestion}
          onAnswer={() => { if (assessmentQuestion < 4) setAssessmentQuestion(assessmentQuestion + 1); else setStep(2); }}
          onExit={() => setStep(0)} />
        <div className={`flex-shrink-0 flex justify-center gap-2 p-3 border-t ${darkMode ? 'border-gray-800 bg-gray-900' : 'border-gray-200 bg-white'}`}>
          {['Q1', 'Q2', 'Q3', 'Q4', 'Q5', 'Done'].map((label, i) => (
            <button key={i} onClick={() => { if (i < 5) { setAssessmentQuestion(i); setStep(1); } else setStep(2); }}
              className={`px-2 py-1 rounded text-xs ${(i < 5 && assessmentQuestion === i) || (i === 5 && step === 2) ? 'bg-violet-600 text-white' : 'bg-gray-700 text-gray-400'}`}>{label}</button>
          ))}
        </div>
      </>
    );
  }

  // USER HUB
  if (scene === 'user-hub') {
    return (
      <>
        <NavBar darkMode={darkMode} theme={theme} stats={stats} />
        <div className="flex-1 overflow-auto">
          {step === 0 && <ProfileScreen darkMode={darkMode} theme={theme} scenario={scenario} />}
          {step === 1 && <AnalyticsScreen darkMode={darkMode} theme={theme} />}
          {step === 2 && <SettingsScreen darkMode={darkMode} theme={theme} />}
          <div className="flex border-t border-gray-800">
            {['Profile', 'Analytics', 'Settings'].map((label, i) => (
              <button key={i} onClick={() => setStep(i)} className={`flex-1 py-3 text-xs font-medium ${step === i ? 'text-violet-400 border-t-2 border-violet-400 -mt-px' : 'text-gray-500'}`}>{label}</button>
            ))}
          </div>
        </div>
      </>
    );
  }

  // ALL MODALS
  if (scene === 'all-modals') {
    return (
      <div className={`flex-1 overflow-auto ${darkMode ? 'bg-gray-950' : 'bg-gray-50'} p-4 space-y-4`}>
        <h3 className={`text-sm font-medium ${TH('text-muted', darkMode)}`}>Level Up Modal</h3>
        <div className={`rounded-2xl p-6 text-center ${darkMode ? 'bg-gray-900' : 'bg-white'}`} style={{boxShadow: `0 0 30px ${theme.colors.primary}30`}}>
          <div className="text-4xl mb-3 celebrate-glow">üéâ</div>
          <h2 className={`text-xl font-bold ${TH('text-primary', darkMode)}`}>Level Up!</h2>
          <div className="text-3xl font-bold my-2" style={{color: theme.colors.primary}}>5</div>
          <p style={{color: theme.colors.primary}}>Insight Seeker</p>
        </div>

        <h3 className={`text-sm font-medium ${TH('text-muted', darkMode)}`}>Save Progress Modal</h3>
        <div className={`rounded-2xl p-5 ${darkMode ? 'bg-gray-900' : 'bg-white'}`}>
          <div className="text-3xl text-center mb-2">üéâ</div>
          <h3 className={`text-lg font-semibold text-center mb-1 ${TH('text-primary', darkMode)}`}>20 responses!</h3>
          <p className={`text-sm text-center mb-4 ${TH('text-muted', darkMode)}`}>Save your progress?</p>
          <div className="space-y-2">
            <button className="w-full py-2.5 rounded-xl font-medium text-white btn-feedback bg-violet-600">Create Account</button>
            <button className={`w-full py-2.5 rounded-xl font-medium btn-feedback ${darkMode ? 'bg-gray-800 text-gray-400' : 'bg-gray-200 text-gray-600'}`}>Later</button>
          </div>
        </div>

        <h3 className={`text-sm font-medium ${TH('text-muted', darkMode)}`}>Confirm Dialog</h3>
        <div className={`rounded-2xl p-5 ${darkMode ? 'bg-gray-900' : 'bg-white'}`}>
          <h3 className={`text-lg font-semibold mb-2 ${TH('text-primary', darkMode)}`}>Clear All Data?</h3>
          <p className={`text-sm mb-4 ${TH('text-muted', darkMode)}`}>This cannot be undone.</p>
          <div className="flex gap-3">
            <button className={`flex-1 py-2 rounded-xl ${darkMode ? 'bg-gray-800 text-gray-300' : 'bg-gray-200 text-gray-700'}`}>Cancel</button>
            <button className="flex-1 py-2 rounded-xl text-white" style={{background: theme.colors.danger}}>Clear</button>
          </div>
        </div>

        <h3 className={`text-sm font-medium ${TH('text-muted', darkMode)}`}>Assessment Complete</h3>
        <div className={`rounded-2xl p-6 text-center ${darkMode ? 'bg-gray-900' : 'bg-white'}`} style={{boxShadow: `0 0 30px ${theme.colors.success}20`}}>
          <div className="text-4xl mb-3">‚ú®</div>
          <h2 className={`text-xl font-bold ${TH('text-primary', darkMode)}`}>Complete!</h2>
          <span className="text-xl font-bold" style={{color: theme.colors.success}}>+50 XP</span>
        </div>

        <h3 className={`text-sm font-medium ${TH('text-muted', darkMode)}`}>None Option Modal</h3>
        <div className={`rounded-xl p-4 ${darkMode ? 'bg-gray-900' : 'bg-white'}`}>
          <div className={`text-sm font-medium mb-2 ${TH('text-primary', darkMode)}`}>None of these options fit</div>
          <div className={`text-sm mb-3 ${TH('text-muted', darkMode)}`}>What would you answer instead?</div>
          <textarea placeholder="Your answer..." className={`w-full px-3 py-2 rounded-lg text-sm mb-3 h-16 resize-none ${darkMode ? 'bg-gray-800 text-white' : 'bg-gray-100 text-gray-900'} border border-gray-700`} />
          <div className="flex gap-2">
            <button className={`flex-1 py-2 rounded-lg text-sm ${darkMode ? 'bg-gray-800 text-gray-400' : 'bg-gray-200 text-gray-600'}`}>Cancel</button>
            <button className="flex-1 py-2 rounded-lg text-sm font-medium bg-violet-600 text-white">Submit</button>
          </div>
        </div>
      </div>
    );
  }

  // COMPONENTS
  if (scene === 'components') {
    return (
      <div className="flex-1 overflow-auto p-4 space-y-4">
        <h3 className={`text-xs font-medium ${TH('text-muted', darkMode)}`}>Tip Banner</h3>
        <TipBanner darkMode={darkMode} onDismiss={() => {}} />

        <h3 className={`text-xs font-medium ${TH('text-muted', darkMode)}`}>Undo Bar</h3>
        <UndoBar darkMode={darkMode} undoDelay={3} onUndo={() => {}} answer={0} confidence={3} isBinary={true} options={[]} theme={theme} />

        <h3 className={`text-xs font-medium ${TH('text-muted', darkMode)}`}>XP Progress</h3>
        <XPProgressBar xp={420} level={3} darkMode={darkMode} theme={theme} />

        <h3 className={`text-xs font-medium ${TH('text-muted', darkMode)}`}>Streak Display</h3>
        <StreakDisplay current={5} best={12} darkMode={darkMode} />

        <h3 className={`text-xs font-medium ${TH('text-muted', darkMode)}`}>Category Chips</h3>
        <div className="flex gap-2 flex-wrap">
          <CategoryChip category="prediction" theme={theme} darkMode={darkMode} />
          <CategoryChip category="reasoning" theme={theme} darkMode={darkMode} />
          <CategoryChip category="judgment" theme={theme} darkMode={darkMode} />
        </div>

        <h3 className={`text-xs font-medium ${TH('text-muted', darkMode)}`}>Binary Buttons</h3>
        <BinaryButtons darkMode={darkMode} theme={theme} selectedAnswer={0} confidence={3} onSelect={() => {}} />

        <h3 className={`text-xs font-medium ${TH('text-muted', darkMode)}`}>Progress Circles</h3>
        <div className="flex gap-3">
          <ProgressCircle progress={75} size={48} color={theme.colors.primary} darkMode={darkMode} text="75" />
          <ProgressCircle progress={45} size={48} color={theme.colors.success} darkMode={darkMode} icon="üéØ" />
          <ProgressCircle progress={100} size={48} color={theme.colors.warning} darkMode={darkMode} text="‚úì" />
        </div>

        <h3 className={`text-xs font-medium ${TH('text-muted', darkMode)}`}>Assessment Card</h3>
        <AssessmentCard assessment={SAMPLE_ASSESSMENTS[1]} darkMode={darkMode} theme={theme} progress={45} />

        <h3 className={`text-xs font-medium ${TH('text-muted', darkMode)}`}>Binary Chart</h3>
        <div className={`p-3 rounded-xl ${darkMode ? 'bg-gray-900' : 'bg-white'}`}>
          <BinaryChart votes={SAMPLE_VOTES.binary} userResponse={{ answer: 0, confidence: 3 }} darkMode={darkMode} theme={theme} />
        </div>
      </div>
    );
  }

  return <div className={`flex-1 flex items-center justify-center ${TH('text-muted', darkMode)}`}>Select a scene</div>;
};

// ============================================================
// MAIN APP
// ============================================================
const App = () => {
  const [selectedPalette, setSelectedPalette] = useState('aura');
  const [theme, setTheme] = useState(DEFAULT_THEME);
  const [darkMode, setDarkMode] = useState(true);
  const [device, setDevice] = useState('iphone-15');
  const [scene, setScene] = useState('question-flow');
  const [scenario, setScenario] = useState('midProgress');
  const [showControls, setShowControls] = useState(true);

  const handlePaletteChange = (paletteId) => {
    setSelectedPalette(paletteId);
    setTheme(buildTheme(PALETTES[paletteId]));
  };

  const exportTheme = () => {
    const json = JSON.stringify(theme, null, 2);
    navigator.clipboard.writeText(json);
    alert('Theme copied to clipboard!');
  };

  return (
    <div className="min-h-screen bg-gray-950 flex">
      {/* Sidebar */}
      {showControls && (
        <div className="w-72 bg-gray-900 border-r border-gray-800 p-4 overflow-auto hide-scrollbar">
          <div className="flex items-center justify-between mb-6">
            <h1 className="text-xl font-bold text-white">üé® Playground</h1>
          </div>

          {/* Dark/Light toggle */}
          <div className="mb-6">
            <label className="flex items-center gap-3 cursor-pointer">
              <span className="text-sm text-gray-400">Light</span>
              <div className={`w-12 h-6 rounded-full p-1 transition-colors ${darkMode ? 'bg-violet-600' : 'bg-gray-600'}`}
                onClick={() => setDarkMode(!darkMode)}>
                <div className={`w-4 h-4 rounded-full bg-white transition-transform ${darkMode ? 'translate-x-6' : ''}`} />
              </div>
              <span className="text-sm text-gray-400">Dark</span>
            </label>
          </div>

          {/* Device */}
          <div className="mb-6">
            <h3 className="text-sm font-semibold text-gray-300 mb-2">Device</h3>
            <DevicePicker selected={device} onSelect={setDevice} />
          </div>

          {/* Scene */}
          <div className="mb-6">
            <h3 className="text-sm font-semibold text-gray-300 mb-2">Scene</h3>
            <ScenePicker selected={scene} onSelect={setScene} />
          </div>

          {/* Scenario */}
          <div className="mb-6">
            <h3 className="text-sm font-semibold text-gray-300 mb-2">User Scenario</h3>
            <ScenarioPicker selected={scenario} onSelect={setScenario} />
          </div>

          {/* Palette */}
          <div className="mb-6">
            <h3 className="text-sm font-semibold text-gray-300 mb-2">Palette</h3>
            <PaletteSelector theme={theme} selectedPalette={selectedPalette} onPaletteChange={handlePaletteChange} onThemeChange={setTheme} />
          </div>

          {/* Actions */}
          <div className="space-y-2">
            <button onClick={exportTheme} className="w-full py-2 px-4 bg-violet-600 text-white rounded-lg text-sm hover:bg-violet-500">
              üìã Copy Theme JSON
            </button>
            <button onClick={() => { setSelectedPalette('aura'); setTheme(DEFAULT_THEME); }}
              className="w-full py-2 px-4 bg-gray-700 text-gray-300 rounded-lg text-sm hover:bg-gray-600">
              ‚Ü©Ô∏è Reset to Default
            </button>
          </div>
        </div>
      )}

      {/* Toggle sidebar */}
      <button onClick={() => setShowControls(!showControls)}
        className="fixed top-4 left-4 z-50 w-10 h-10 bg-gray-800 rounded-lg flex items-center justify-center text-white hover:bg-gray-700"
        style={{ left: showControls ? '19rem' : '1rem' }}>
        {showControls ? '‚Üê' : '‚Üí'}
      </button>

      {/* Preview */}
      <div className="flex-1 flex items-start justify-center p-8 pt-16 overflow-auto bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900">
        <PhoneFrame darkMode={darkMode} device={device}>
          <PreviewContent scene={scene} theme={theme} darkMode={darkMode} scenario={SCENARIOS[scenario]} />
        </PhoneFrame>
      </div>
    </div>
  );
};

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
